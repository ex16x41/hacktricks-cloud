# GCP - AppEngine Privesc

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## App Engine

WiÄ™cej informacji o App Engine znajdziesz tutaj:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

To sÄ… potrzebne uprawnienia do **wdroÅ¼enia aplikacji za pomocÄ… `gcloud` cli**. MoÅ¼e byÄ‡ moÅ¼liwe **unikniÄ™cie** uprawnieÅ„ **`get`** i **`list`**.

PrzykÅ‚ady kodu w Pythonie znajdziesz na [https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)

DomyÅ›lnie nazwa usÅ‚ugi App bÄ™dzie **`default`**, i moÅ¼e byÄ‡ tylko 1 instancja o tej samej nazwie.\
Aby to zmieniÄ‡ i utworzyÄ‡ drugÄ… aplikacjÄ™, w **`app.yaml`**, zmieÅ„ wartoÅ›Ä‡ klucza gÅ‚Ã³wnego na coÅ› w stylu **`service: my-second-app`**
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Daj co najmniej 10-15 minut, jeÅ›li to nie zadziaÅ‚a, wywoÅ‚aj **deploy another of times** i poczekaj kilka minut.

{% hint style="info" %}
**MoÅ¼liwe jest wskazanie konta usÅ‚ugi do uÅ¼ycia**, ale domyÅ›lnie uÅ¼ywane jest domyÅ›lne konto SA App Engine.
{% endhint %}

URL aplikacji wyglÄ…da mniej wiÄ™cej tak: `https://<proj-name>.oa.r.appspot.com/` lub `https://<service_name>-dot-<proj-name>.oa.r.appspot.com`

### Aktualizacja rÃ³wnowaÅ¼nych uprawnieÅ„

MoÅ¼esz mieÄ‡ wystarczajÄ…ce uprawnienia do aktualizacji AppEngine, ale nie do utworzenia nowego. W takim przypadku, oto jak moÅ¼na zaktualizowaÄ‡ bieÅ¼Ä…cy App Engine:
```bash
# Find the code of the App Engine in the buckets
gsutil ls

# Download code
mkdir /tmp/appengine2
cd /tmp/appengine2
## In this case it was found in this custom bucket but you could also use the
## buckets generated when the App Engine is created
gsutil cp gs://appengine-lab-1-gcp-labs-4t04m0i6-3a97003354979ef6/labs_appengine_1_premissions_privesc.zip .
unzip labs_appengine_1_premissions_privesc.zip

## Now modify the code..

## If you don't have an app.yaml, create one like:
cat >> app.yaml <<EOF
runtime: python312

entrypoint: gunicorn -b :\$PORT main:app

env_variables:
A_VARIABLE: "value"
EOF

# Deploy the changes
gcloud app deploy

# Update the SA if you need it (and if you have actas permissions)
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
JeÅ›li **juÅ¼ skompromitowaÅ‚eÅ› AppEngine** i masz uprawnienia **`appengine.applications.update`** oraz **actAs** nad kontem usÅ‚ugi, ktÃ³re chcesz uÅ¼yÄ‡, moÅ¼esz zmodyfikowaÄ‡ konto usÅ‚ugi uÅ¼ywane przez AppEngine za pomocÄ…:
```bash
gcloud app update --service-account=<sa>@$PROJECT_ID.iam.gserviceaccount.com
```
### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

Z tymi uprawnieniami moÅ¼liwe jest **logowanie siÄ™ przez ssh do instancji App Engine** typu **flexible** (nie standard). NiektÃ³re z uprawnieÅ„ **`list`** i **`get`** **mogÄ… nie byÄ‡ naprawdÄ™ potrzebne**.
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

MyÅ›lÄ™, Å¼e to tylko zmienia domyÅ›lne SA, ktÃ³rego Google uÅ¼yje do skonfigurowania aplikacji, wiÄ™c nie sÄ…dzÄ™, aby moÅ¼na byÅ‚o to wykorzystaÄ‡ do kradzieÅ¼y konta serwisowego.

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

Nie jestem pewien, jak uÅ¼ywaÄ‡ tych uprawnieÅ„ ani czy sÄ… one przydatne (zauwaÅ¼, Å¼e gdy zmieniasz kod, tworzona jest nowa wersja, wiÄ™c nie wiem, czy moÅ¼na po prostu zaktualizowaÄ‡ kod lub rolÄ™ IAM jednej z nich, ale przypuszczam, Å¼e powinno byÄ‡ to moÅ¼liwe, moÅ¼e zmieniajÄ…c kod wewnÄ…trz bucketu??).

### DostÄ™p do zapisu w bucketach

Nawet z dostÄ™pem do zapisu w bucketach, gdzie znajduje siÄ™ kod ÅºrÃ³dÅ‚owy, **NIE byÅ‚o moÅ¼liwe wykonanie dowolnego kodu poprzez modyfikacjÄ™ kodu ÅºrÃ³dÅ‚owego i `manifest.json`**.\
MoÅ¼e jeÅ›li monitorujesz bucket i wykryjesz moment, w ktÃ³rym tworzona jest nowa wersja, a kod ÅºrÃ³dÅ‚owy i manifest sÄ… przesyÅ‚ane, moÅ¼liwe jest ich zmiana, aby nowa wersja uÅ¼ywaÅ‚a tych z backdoorem??

WyglÄ…da rÃ³wnieÅ¼ na to, Å¼e warstwy kontenerÃ³w sÄ… przechowywane w bucketach, moÅ¼e zmieniajÄ…c je?

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
