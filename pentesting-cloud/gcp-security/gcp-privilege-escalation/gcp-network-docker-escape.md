# GCP - √âvasion Docker R√©seau

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Formation Expert √âquipe Rouge AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Formation Expert √âquipe Rouge GCP (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## √âtat Initial

Dans les deux rapports o√π cette technique est sp√©cifi√©e, les attaquants ont r√©ussi √† obtenir un acc√®s **root** √† l'int√©rieur d'un conteneur **Docker** g√©r√© par GCP avec acc√®s au r√©seau h√¥te (et les capacit√©s **`CAP_NET_ADMIN`** et **`CAP_NET_RAW`**).

## Explication de l'Attaque

Sur une instance Google Compute Engine, une inspection r√©guli√®re du trafic r√©seau r√©v√®le de nombreuses **requ√™tes HTTP en clair** vers l'**instance de m√©tadonn√©es** √† `169.254.169.254`. L'[**Agent Invit√© Google**](https://github.com/GoogleCloudPlatform/guest-agent), un service open-source, effectue fr√©quemment de telles requ√™tes.

Cet agent est con√ßu pour **surveiller les changements dans les m√©tadonn√©es**. Notamment, les m√©tadonn√©es incluent un **champ pour les cl√©s publiques SSH**. Lorsqu'une nouvelle cl√© publique SSH est ajout√©e aux m√©tadonn√©es, l'agent l'**autorise** automatiquement dans le fichier `.authorized_key`. Il peut √©galement **cr√©er un nouvel utilisateur** et l'ajouter aux **sudoers** si n√©cessaire.

L'agent surveille les changements en envoyant une requ√™te pour **r√©cup√©rer toutes les valeurs de m√©tadonn√©es de mani√®re r√©cursive** (`GET /computeMetadata/v1/?recursive=true`). Cette requ√™te est con√ßue pour inciter le serveur de m√©tadonn√©es √† envoyer une r√©ponse uniquement s'il y a un changement dans les m√©tadonn√©es depuis la derni√®re r√©cup√©ration, identifi√© par un Etag (`wait_for_change=true&last_etag=`). De plus, un param√®tre de **timeout** (`timeout_sec=`) est inclus. Si aucun changement ne se produit dans le d√©lai sp√©cifi√©, le serveur r√©pond avec les **valeurs inchang√©es**.

Ce processus permet au **IMDS** (Instance Metadata Service) de r√©pondre apr√®s **60 secondes** si aucun changement de configuration n'a eu lieu, cr√©ant une **fen√™tre potentielle pour injecter une r√©ponse de configuration falsifi√©e** √† l'agent invit√©.

Un attaquant pourrait exploiter cela en effectuant une **attaque Man-in-the-Middle (MitM)**, en falsifiant la r√©ponse du serveur IMDS et en **ins√©rant une nouvelle cl√© publique**. Cela pourrait permettre un acc√®s SSH non autoris√© √† l'h√¥te.

### Technique d'√âvasion

Bien que le spoofing ARP soit inefficace sur les r√©seaux Google Compute Engine, une [**version modifi√©e de rshijack**](https://github.com/ezequielpereira/rshijack) d√©velopp√©e par [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) peut √™tre utilis√©e pour l'injection de paquets dans la communication pour injecter l'utilisateur SSH.

Cette version de rshijack permet d'entrer les num√©ros ACK et SEQ en tant qu'arguments de ligne de commande, facilitant le spoofing d'une r√©ponse avant la v√©ritable r√©ponse du serveur de m√©tadonn√©es. De plus, un [**petit script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) est utilis√© pour retourner une **charge utile sp√©cialement con√ßue**. Cette charge utile d√©clenche l'Agent Invit√© Google pour **cr√©er un utilisateur `wouter`** avec une cl√© publique sp√©cifi√©e dans le fichier `.authorized_keys`.

Le script utilise le m√™me ETag pour emp√™cher le serveur de m√©tadonn√©es de notifier imm√©diatement l'Agent Invit√© Google de valeurs de m√©tadonn√©es diff√©rentes, retardant ainsi la r√©ponse.

Pour ex√©cuter le spoofing, les √©tapes suivantes sont n√©cessaires :

1. **Surveiller les requ√™tes au serveur de m√©tadonn√©es** en utilisant **tcpdump** :
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Recherchez une ligne similaire √† :
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Envoyez les fausses donn√©es de m√©tadonn√©es avec le bon ETAG √† rshijack :
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Cette √©tape autorise la cl√© publique, permettant une connexion SSH avec la cl√© priv√©e correspondante.

## R√©f√©rences

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
