# GCP - Escape de Docker en la Red

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Estado Inicial

En ambos informes donde se especifica esta t칠cnica, los atacantes lograron obtener acceso **root** dentro de un contenedor **Docker** gestionado por GCP con acceso a la red del host (y las capacidades **`CAP_NET_ADMIN`** y **`CAP_NET_RAW`**).

## Explicaci칩n del Ataque

En una instancia de Google Compute Engine, la inspecci칩n regular del tr치fico de red revela numerosas **solicitudes HTTP en texto plano** al **metadata instance** en `169.254.169.254`. El [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), un servicio de c칩digo abierto, realiza frecuentemente tales solicitudes.

Este agente est치 dise침ado para **monitorear cambios en los metadatos**. Notablemente, los metadatos incluyen un **campo para claves p칰blicas SSH**. Cuando se agrega una nueva clave p칰blica SSH a los metadatos, el agente la **autoriza** autom치ticamente en el archivo `.authorized_key`. Tambi칠n puede **crear un nuevo usuario** y agregarlo a **sudoers** si es necesario.

El agente monitorea cambios enviando una solicitud para **recuperar todos los valores de metadatos de forma recursiva** (`GET /computeMetadata/v1/?recursive=true`). Esta solicitud est치 dise침ada para solicitar al servidor de metadatos que env칤e una respuesta solo si hay alg칰n cambio en los metadatos desde la 칰ltima recuperaci칩n, identificado por un Etag (`wait_for_change=true&last_etag=`). Adem치s, se incluye un par치metro de **timeout** (`timeout_sec=`). Si no ocurre ning칰n cambio dentro del tiempo de espera especificado, el servidor responde con los **valores sin cambios**.

Este proceso permite que el **IMDS** (Instance Metadata Service) responda despu칠s de **60 segundos** si no ha ocurrido ning칰n cambio de configuraci칩n, creando una posible **ventana para inyectar una respuesta de configuraci칩n falsa** al agente invitado.

Un atacante podr칤a explotar esto realizando un **ataque Man-in-the-Middle (MitM)**, suplantando la respuesta del servidor IMDS e **insertando una nueva clave p칰blica**. Esto podr칤a permitir el acceso SSH no autorizado al host.

### T칠cnica de Escape

Mientras que el spoofing ARP es ineficaz en las redes de Google Compute Engine, una [**versi칩n modificada de rshijack**](https://github.com/ezequielpereira/rshijack) desarrollada por [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) puede ser utilizada para la inyecci칩n de paquetes en la comunicaci칩n para inyectar el usuario SSH.

Esta versi칩n de rshijack permite ingresar los n칰meros ACK y SEQ como argumentos de l칤nea de comandos, facilitando la suplantaci칩n de una respuesta antes de la respuesta real del servidor de Metadatos. Adem치s, se utiliza un [**peque침o script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) para devolver una **carga 칰til especialmente dise침ada**. Esta carga 칰til activa al Google Guest Agent para **crear un usuario `wouter`** con una clave p칰blica especificada en el archivo `.authorized_keys`.

El script utiliza el mismo ETag para evitar que el servidor de Metadatos notifique inmediatamente al Google Guest Agent sobre diferentes valores de metadatos, retrasando as칤 la respuesta.

Para ejecutar la suplantaci칩n, son necesarios los siguientes pasos:

1. **Monitorear solicitudes al servidor de Metadatos** usando **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Busca una l칤nea similar a:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Env칤a los datos de metadatos falsos con el ETAG correcto a rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Este paso autoriza la clave p칰blica, habilitando la conexi칩n SSH con la clave privada correspondiente.

## Referencias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
