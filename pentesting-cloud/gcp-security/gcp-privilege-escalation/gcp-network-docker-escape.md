# GCP - ç½‘ç»œ Docker é€ƒé€¸

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹  AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹  GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åˆå§‹çŠ¶æ€

åœ¨æŒ‡å®šäº†è¿™ç§æŠ€æœ¯çš„ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæ”»å‡»è€…æˆåŠŸåœ¨ç”± GCP ç®¡ç†çš„ Docker å®¹å™¨å†…è·å¾—äº† **root** è®¿é—®æƒé™ï¼Œå¹¶å…·æœ‰å¯¹ä¸»æœºç½‘ç»œçš„è®¿é—®æƒé™ï¼ˆä»¥åŠ **`CAP_NET_ADMIN`** å’Œ **`CAP_NET_RAW`** çš„åŠŸèƒ½ï¼‰ã€‚

## æ”»å‡»è§£é‡Š

åœ¨ Google Compute Engine å®ä¾‹ä¸Šï¼Œå®šæœŸæ£€æŸ¥ç½‘ç»œæµé‡ä¼šæ˜¾ç¤ºå¤§é‡å¯¹ `169.254.169.254` ä¸Šçš„ **æ˜æ–‡ HTTP è¯·æ±‚**ï¼Œè¿™æ˜¯å…ƒæ•°æ®å®ä¾‹ã€‚[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) æ˜¯ä¸€ä¸ªå¼€æºæœåŠ¡ï¼Œç»å¸¸å‘å‡ºè¿™æ ·çš„è¯·æ±‚ã€‚

è¯¥ä»£ç†æ—¨åœ¨**ç›‘è§†å…ƒæ•°æ®çš„æ›´æ”¹**ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå…ƒæ•°æ®åŒ…æ‹¬ä¸€ä¸ª **SSH å…¬é’¥å­—æ®µ**ã€‚å½“æ–°çš„å…¬å…± SSH å¯†é’¥æ·»åŠ åˆ°å…ƒæ•°æ®ä¸­æ—¶ï¼Œä»£ç†ä¼šè‡ªåŠ¨åœ¨ `.authorized_key` æ–‡ä»¶ä¸­**æˆæƒ**å®ƒã€‚å¦‚æœéœ€è¦ï¼Œå®ƒè¿˜å¯ä»¥**åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·**å¹¶å°†å…¶æ·»åŠ åˆ° **sudoers**ã€‚

ä»£ç†é€šè¿‡å‘é€è¯·æ±‚æ¥**é€’å½’æ£€ç´¢æ‰€æœ‰å…ƒæ•°æ®å€¼**ï¼ˆ`GET /computeMetadata/v1/?recursive=true`ï¼‰æ¥ç›‘è§†æ›´æ”¹ã€‚æ­¤è¯·æ±‚æ—¨åœ¨ä¿ƒä½¿å…ƒæ•°æ®æœåŠ¡å™¨ä»…åœ¨è‡ªä¸Šæ¬¡æ£€ç´¢ä»¥æ¥å…ƒæ•°æ®å‘ç”Ÿä»»ä½•æ›´æ”¹æ—¶å‘é€å“åº”ï¼Œç”± Etagï¼ˆ`wait_for_change=true&last_etag=`ï¼‰æ ‡è¯†ã€‚æ­¤å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸€ä¸ª **è¶…æ—¶** å‚æ•°ï¼ˆ`timeout_sec=`ï¼‰ã€‚å¦‚æœåœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰å‘ç”Ÿæ›´æ”¹ï¼ŒæœåŠ¡å™¨å°†ä»¥**æœªæ›´æ”¹çš„å€¼**å“åº”ã€‚

è¿™ä¸ªè¿‡ç¨‹å…è®¸ **IMDS**ï¼ˆå®ä¾‹å…ƒæ•°æ®æœåŠ¡ï¼‰åœ¨**60ç§’**åå“åº”ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿé…ç½®æ›´æ”¹ï¼Œå°±ä¼šä¸ºå‘å®¢æˆ·ä»£ç†æ³¨å…¥ä¸€ä¸ª**ä¼ªé€ çš„é…ç½®å“åº”**åˆ›é€ ä¸€ä¸ªæ½œåœ¨çš„çª—å£ã€‚

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæ‰§è¡Œ**ä¸­é—´äººæ”»å‡»ï¼ˆMitM æ”»å‡»ï¼‰**ï¼Œæ¬ºéª— IMDS æœåŠ¡å™¨çš„å“åº”ï¼Œå¹¶**æ’å…¥ä¸€ä¸ªæ–°çš„å…¬é’¥**ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æœªç»æˆæƒçš„ SSH è®¿é—®ä¸»æœºã€‚

### é€ƒé€¸æŠ€æœ¯

è™½ç„¶ ARP æ¬ºéª—åœ¨ Google Compute Engine ç½‘ç»œä¸Šæ— æ•ˆï¼Œä½†ç”± [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) å¼€å‘çš„ [**rshijack çš„ä¿®æ”¹ç‰ˆæœ¬**](https://github.com/ezequielpereira/rshijack) å¯ç”¨äºåœ¨é€šä¿¡ä¸­è¿›è¡Œæ•°æ®åŒ…æ³¨å…¥ä»¥æ³¨å…¥ SSH ç”¨æˆ·ã€‚

è¿™ä¸ªç‰ˆæœ¬çš„ rshijack å…è®¸å°† ACK å’Œ SEQ æ•°å­—ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°è¾“å…¥ï¼Œä»è€Œåœ¨çœŸå®çš„ Metadata æœåŠ¡å™¨å“åº”ä¹‹å‰ä¼ªé€ å“åº”ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ä¸€ä¸ª[**å°å‹ Shell è„šæœ¬**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) æ¥è¿”å›ä¸€ä¸ª**ç‰¹åˆ¶çš„æœ‰æ•ˆè´Ÿè½½**ã€‚è¿™ä¸ªæœ‰æ•ˆè´Ÿè½½è§¦å‘ Google Guest Agent **åˆ›å»ºä¸€ä¸ªåä¸º `wouter` çš„ç”¨æˆ·**ï¼Œå¹¶åœ¨ `.authorized_keys` æ–‡ä»¶ä¸­æŒ‡å®šå…¬é’¥ã€‚

è¯¥è„šæœ¬ä½¿ç”¨ç›¸åŒçš„ ETag æ¥é˜²æ­¢ Metadata æœåŠ¡å™¨ç«‹å³é€šçŸ¥ Google Guest Agent ä¸åŒçš„å…ƒæ•°æ®å€¼ï¼Œä»è€Œå»¶è¿Ÿå“åº”ã€‚

è¦æ‰§è¡Œæ¬ºéª—ï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

1. ä½¿ç”¨ **tcpdump** **ç›‘è§†å¯¹ Metadata æœåŠ¡å™¨çš„è¯·æ±‚**ï¼š
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
å¯»æ‰¾ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„è¡Œï¼š
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. ä½¿ç”¨æ­£ç¡®çš„ETAGå‘rshijackå‘é€è™šå‡å…ƒæ•°æ®æ•°æ®ï¼š
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
è¿™ä¸€æ­¥æˆæƒå…¬é’¥ï¼Œå¯ç”¨ä¸ç›¸åº”ç§é’¥çš„SSHè¿æ¥ã€‚


## å‚è€ƒ

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
