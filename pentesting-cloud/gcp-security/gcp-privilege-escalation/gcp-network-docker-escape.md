# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

Bu teknik belirtilen her iki yazıda, saldırganlar GCP tarafından yönetilen bir **Docker** konteynerinde **root** erişimi elde etmeyi başardılar ve ana makine ağına (ve **`CAP_NET_ADMIN`** ve **`CAP_NET_RAW`** yeteneklerine) erişim sağladılar.

## Attack Explanation

Bir Google Compute Engine örneğinde, ağ trafiğinin düzenli incelenmesi, **metadata instance**'ına `169.254.169.254` adresine sayısız **düz HTTP isteği** gönderildiğini ortaya koymaktadır. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), açık kaynaklı bir hizmet, sık sık bu tür isteklerde bulunur.

Bu ajan, **metadata'daki değişiklikleri izlemek** için tasarlanmıştır. Özellikle, metadata bir **SSH genel anahtarları alanı** içerir. Metadata'ya yeni bir genel SSH anahtarı eklendiğinde, ajan otomatik olarak bunu `.authorized_key` dosyasında **yetkilendirir**. Ayrıca, gerekirse **yeni bir kullanıcı oluşturabilir** ve bunu **sudoers** listesine ekleyebilir.

Ajan, **tüm metadata değerlerini özyinelemeli olarak almak** için bir istek göndererek değişiklikleri izler (`GET /computeMetadata/v1/?recursive=true`). Bu istek, metadata sunucusunun yalnızca metadata'da son alımdan bu yana bir değişiklik varsa yanıt vermesi için tasarlanmıştır ve bu değişiklik bir Etag ile tanımlanır (`wait_for_change=true&last_etag=`). Ayrıca, bir **timeout** parametresi (`timeout_sec=`) de eklenmiştir. Belirtilen zaman aşımı içinde bir değişiklik olmazsa, sunucu **değişmemiş değerlerle** yanıt verir.

Bu süreç, **IMDS** (Instance Metadata Service) yapılandırma değişikliği olmadığında **60 saniye** sonra yanıt vermesine olanak tanır ve bu, misafir ajana sahte bir yapılandırma yanıtı enjekte etmek için potansiyel bir **pencere** oluşturur.

Bir saldırgan, bu durumu **Man-in-the-Middle (MitM) saldırısı** gerçekleştirerek, IMDS sunucusundan gelen yanıtı taklit edip **yeni bir genel anahtar ekleyerek** istismar edebilir. Bu, ana makineye yetkisiz SSH erişimi sağlayabilir.

### Escape Technique

ARP taklidi Google Compute Engine ağlarında etkili olmasa da, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) tarafından geliştirilen [**rshijack'ın değiştirilmiş bir versiyonu**](https://github.com/ezequielpereira/rshijack), SSH kullanıcısını enjekte etmek için iletişimde paket enjeksiyonu yapmak için kullanılabilir.

Bu rshijack versiyonu, ACK ve SEQ numaralarını komut satırı argümanları olarak girmeye olanak tanır ve gerçek Metadata sunucusunun yanıtından önce bir yanıtı taklit etmeyi kolaylaştırır. Ayrıca, [**küçük bir Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) kullanılarak **özel olarak hazırlanmış bir yük** döndürülür. Bu yük, Google Guest Agent'ın `.authorized_keys` dosyasında belirtilen bir genel anahtara sahip `wouter` adlı bir kullanıcı **oluşturmasını** tetikler.

Script, Metadata sunucusunun Google Guest Agent'ı farklı metadata değerleri hakkında hemen bilgilendirmesini önlemek için aynı ETag'i kullanarak yanıtı geciktirir.

Taklit işlemini gerçekleştirmek için aşağıdaki adımlar gereklidir:

1. **Metadata sunucusuna yapılan istekleri izleyin** **tcpdump** kullanarak:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Aşağıdakine benzer bir satır arayın:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Doğru ETAG ile sahte metadata verisini rshijack'e gönderin:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Bu adım, ilgili özel anahtar ile SSH bağlantısını etkinleştiren genel anahtarı yetkilendirir.

## Referanslar

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
