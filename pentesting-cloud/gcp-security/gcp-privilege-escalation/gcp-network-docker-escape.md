# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

рджреЛрдиреЛрдВ рд▓реЗрдЦреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдиреЗ GCP рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд **Docker** рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ **root** рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓рддрд╛ рдкрд╛рдИ, рдЬрд┐рд╕рдореЗрдВ рд╣реЛрд╕реНрдЯ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдкрд╣реБрдВрдЪ (рдФрд░ рдХреНрд╖рдорддрд╛рдПрдВ **`CAP_NET_ADMIN`** рдФрд░ **`CAP_NET_RAW`**) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

## Attack Explanation

Google Compute Engine рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░, рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рдирд┐рдпрдорд┐рдд рдЬрд╛рдВрдЪ **plain HTTP requests** рдХреА рдХрдИ **metadata instance** рдкрд░ `169.254.169.254` рдХреЗ рд▓рд┐рдП рдкреНрд░рдХрдЯ рдХрд░рддреА рд╣реИред [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), рдПрдХ рдУрдкрди-рд╕реЛрд░реНрд╕ рд╕реЗрд╡рд╛, рдЕрдХреНрд╕рд░ рдРрд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд░рддреА рд╣реИред

рдпрд╣ рдПрдЬреЗрдВрдЯ **metadata рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдореЗрдВ **SSH рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдХреЗ рд▓рд┐рдП рдПрдХ рдлрд╝реАрд▓реНрдб** рд╢рд╛рдорд┐рд▓ рд╣реИред рдЬрдм рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдореЗрдВ рдПрдХ рдирдИ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ SSH рдХреБрдВрдЬреА рдЬреЛрдбрд╝реА рдЬрд╛рддреА рд╣реИ, рддреЛ рдПрдЬреЗрдВрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЗрд╕реЗ `.authorized_key` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ **рдЕрдзрд┐рдХреГрдд** рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ, рддреЛ рдпрд╣ **рдПрдХ рдирдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рднреА рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ **sudoers** рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред

рдПрдЬреЗрдВрдЯ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рднреА рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдорд╛рдиреЛрдВ рдХреЛ рдкреБрдирд░рд╛рд╡реГрддреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдиреБрд░реЛрдз рднреЗрдЬрддрд╛ рд╣реИ (`GET /computeMetadata/v1/?recursive=true`)ред рдпрд╣ рдЕрдиреБрд░реЛрдз рдореЗрдЯрд╛рдбреЗрдЯрд╛ рд╕рд░реНрд╡рд░ рдХреЛ рдХреЗрд╡рд▓ рддрдм рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрдм рдкрд┐рдЫрд▓реЗ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдХреЗ рдмрд╛рдж рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдореЗрдВ рдХреЛрдИ рдкрд░рд┐рд╡рд░реНрддрди рд╣реБрдЖ рд╣реЛ, рдЬрд┐рд╕реЗ рдПрдХ Etag рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ (`wait_for_change=true&last_etag=`)ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдПрдХ **timeout** рдкреИрд░рд╛рдореАрдЯрд░ (`timeout_sec=`) рд╢рд╛рдорд┐рд▓ рд╣реИред рдпрджрд┐ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рдордп рд╕реАрдорд╛ рдХреЗ рднреАрддрд░ рдХреЛрдИ рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╕рд░реНрд╡рд░ **рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рдорд╛рдиреЛрдВ** рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИред

рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **IMDS** (Instance Metadata Service) рдХреЛ **60 рд╕реЗрдХрдВрдб** рдХреЗ рдмрд╛рдж рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ рдпрджрд┐ рдХреЛрдИ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ, рдЬрд┐рд╕рд╕реЗ **рдлрд░реНрдЬреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ рдореЗрд╣рдорд╛рди рдПрдЬреЗрдВрдЯ рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд **рдЦрд┐рдбрд╝рдХреА** рдмрдирддреА рд╣реИред

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕ рдкрд░ **Man-in-the-Middle (MitM) attack** рдХрд░рдХреЗ рдЗрд╕рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХрддрд╛ рд╣реИ, IMDS рд╕рд░реНрд╡рд░ рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрдкреВрдл рдХрд░рдХреЗ рдФрд░ **рдПрдХ рдирдИ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА** рдбрд╛рд▓рдХрд░ред рдЗрд╕рд╕реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдЕрдирдзрд┐рдХреГрдд SSH рдПрдХреНрд╕реЗрд╕ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### Escape Technique

рд╣рд╛рд▓рд╛рдВрдХрд┐ ARP рд╕реНрдкреВрдлрд┐рдВрдЧ Google Compute Engine рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдЕрдкреНрд░рднрд╛рд╡реА рд╣реИ, [**rshijack рдХрд╛ рдПрдХ рд╕рдВрд╢реЛрдзрд┐рдд рд╕рдВрд╕реНрдХрд░рдг**](https://github.com/ezequielpereira/rshijack) рдЬреЛ [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдкреИрдХреЗрдЯ рдЗрдВрдЬреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдВрдЪрд╛рд░ рдореЗрдВ SSH рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

rshijack рдХрд╛ рдпрд╣ рд╕рдВрд╕реНрдХрд░рдг ACK рдФрд░ SEQ рдирдВрдмрд░реЛрдВ рдХреЛ рдХрдорд╛рдВрдб-рд▓рд╛рдЗрди рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЗрдирдкреБрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рд╕рд░реНрд╡рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдкрд╣рд▓реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрдкреВрдл рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдПрдХ [**рдЫреЛрдЯреА рд╢реЗрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рддреИрдпрд╛рд░ рдХрд┐рдП рдЧрдП рдкреЗрд▓реЛрдб** рдХреЛ рд▓реМрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдкреЗрд▓реЛрдб Google Guest Agent рдХреЛ **`wouter` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреНрд░рд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ `.authorized_keys` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рд╣реЛрддреА рд╣реИред

рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рд╕рд░реНрд╡рд░ рдХреЛ Google Guest Agent рдХреЛ рд╡рд┐рднрд┐рдиреНрди рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдорд╛рдиреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рддреБрд░рдВрдд рд╕реВрдЪрд┐рдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд╣реА ETag рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рджреЗрд░реА рд╣реЛрддреА рд╣реИред

рд╕реНрдкреВрдлрд┐рдВрдЧ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░рдг рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ:

1. **Metadata рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ** **tcpdump** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
рдПрдХ рдкрдВрдХреНрддрд┐ рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ рдЬреЛ рдЗрд╕ рддрд░рд╣ рдХреА рд╣реЛ:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. рд╕рд╣реА ETAG рдХреЗ рд╕рд╛рде рдирдХрд▓реА рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдбреЗрдЯрд╛ rshijack рдХреЛ рднреЗрдЬреЗрдВ:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
рдпрд╣ рдХрджрдо рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рддрд╛ рд╣реИ, рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде SSH рдХрдиреЗрдХреНрд╢рди рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
