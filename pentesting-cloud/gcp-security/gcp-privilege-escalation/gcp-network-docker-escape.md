# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Αρχική Κατάσταση

Σε και τις δύο αναφορές όπου αυτή η τεχνική αναφέρεται, οι επιτιθέμενοι κατάφεραν να αποκτήσουν **root** πρόσβαση μέσα σε ένα **Docker** κοντέινερ που διαχειρίζεται η GCP με πρόσβαση στο δίκτυο του host (και τις δυνατότητες **`CAP_NET_ADMIN`** και **`CAP_NET_RAW`**).

## Εξήγηση Επίθεσης

Σε μια instance Google Compute Engine, η κανονική επιθεώρηση της δικτυακής κίνησης αποκαλύπτει πολλές **καθαρές HTTP αιτήσεις** προς την **metadata instance** στο `169.254.169.254`. Ο [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), μια υπηρεσία ανοιχτού κώδικα, κάνει συχνά τέτοιες αιτήσεις.

Αυτός ο πράκτορας έχει σχεδιαστεί για να **παρακολουθεί τις αλλαγές στη μεταδεδομένα**. Σημαντικά, τα μεταδεδομένα περιλαμβάνουν ένα **πεδίο για δημόσια κλειδιά SSH**. Όταν προστεθεί ένα νέο δημόσιο κλειδί SSH στα μεταδεδομένα, ο πράκτορας το **εξουσιοδοτεί** αυτόματα στο αρχείο `.authorized_key`. Μπορεί επίσης να **δημιουργήσει έναν νέο χρήστη** και να τον προσθέσει στους **sudoers** αν χρειαστεί.

Ο πράκτορας παρακολουθεί τις αλλαγές στέλνοντας ένα αίτημα για **ανάκτηση όλων των τιμών μεταδεδομένων αναδρομικά** (`GET /computeMetadata/v1/?recursive=true`). Αυτό το αίτημα έχει σχεδιαστεί για να προκαλεί τον διακομιστή μεταδεδομένων να στείλει μια απάντηση μόνο αν υπάρχει κάποια αλλαγή στα μεταδεδομένα από την τελευταία ανάκτηση, που προσδιορίζεται από ένα Etag (`wait_for_change=true&last_etag=`). Επιπλέον, περιλαμβάνεται μια παράμετρος **timeout** (`timeout_sec=`). Αν δεν υπάρξει καμία αλλαγή εντός του καθορισμένου timeout, ο διακομιστής απαντά με τις **αμετάβλητες τιμές**.

Αυτή η διαδικασία επιτρέπει στην **IMDS** (Υπηρεσία Μεταδεδομένων Instance) να απαντήσει μετά από **60 δευτερόλεπτα** αν δεν έχει συμβεί καμία αλλαγή στη διαμόρφωση, δημιουργώντας ένα πιθανό **παράθυρο για την εισαγωγή μιας ψεύτικης απάντησης διαμόρφωσης** στον πράκτορα.

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό εκτελώντας μια **επίθεση Man-in-the-Middle (MitM)**, προσποιούμενος την απάντηση από τον διακομιστή IMDS και **εισάγοντας ένα νέο δημόσιο κλειδί**. Αυτό θα μπορούσε να επιτρέψει μη εξουσιοδοτημένη πρόσβαση SSH στον host.

### Τεχνική Διαφυγής

Ενώ η παραπλάνηση ARP είναι αναποτελεσματική στα δίκτυα Google Compute Engine, μια [**τροποποιημένη έκδοση του rshijack**](https://github.com/ezequielpereira/rshijack) που αναπτύχθηκε από τον [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) μπορεί να χρησιμοποιηθεί για την εισαγωγή πακέτων στην επικοινωνία για να εισαχθεί ο χρήστης SSH.

Αυτή η έκδοση του rshijack επιτρέπει την εισαγωγή των αριθμών ACK και SEQ ως παραμέτρους γραμμής εντολών, διευκολύνοντας την παραπλάνηση μιας απάντησης πριν από την πραγματική απάντηση του διακομιστή Μεταδεδομένων. Επιπλέον, χρησιμοποιείται ένα [**μικρό Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) για να επιστρέψει ένα **ειδικά κατασκευασμένο payload**. Αυτό το payload ενεργοποιεί τον Google Guest Agent να **δημιουργήσει έναν χρήστη `wouter`** με ένα καθορισμένο δημόσιο κλειδί στο αρχείο `.authorized_keys`.

Το script χρησιμοποιεί το ίδιο ETag για να αποτρέψει τον διακομιστή Μεταδεδομένων από το να ειδοποιήσει αμέσως τον Google Guest Agent για διαφορετικές τιμές μεταδεδομένων, καθυστερώντας έτσι την απάντηση.

Για να εκτελεστεί η παραπλάνηση, είναι απαραίτητα τα εξής βήματα:

1. **Παρακολούθηση αιτήσεων προς τον διακομιστή Μεταδεδομένων** χρησιμοποιώντας **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Αναζητήστε μια γραμμή παρόμοια με:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Στείλτε τα ψεύτικα δεδομένα μεταδεδομένων με το σωστό ETAG στο rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Αυτό το βήμα εξουσιοδοτεί το δημόσιο κλειδί, επιτρέποντας τη σύνδεση SSH με το αντίστοιχο ιδιωτικό κλειδί.

## Αναφορές

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
