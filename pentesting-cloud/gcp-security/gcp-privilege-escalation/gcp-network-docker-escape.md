# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

–£ –æ–±–æ—Ö –∑–≤—ñ—Ç–∞—Ö, –¥–µ –∑–∞–∑–Ω–∞—á–µ–Ω–∞ —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∏ –∑–º–æ–≥–ª–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø **root** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **Docker** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∫–µ—Ä–æ–≤–∞–Ω–æ–≥–æ GCP, –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ —Ö–æ—Å—Ç-–º–µ—Ä–µ–∂—ñ (—Ç–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—è–º–∏ **`CAP_NET_ADMIN`** —ñ **`CAP_NET_RAW`**).

## Attack Explanation

–ù–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ Google Compute Engine —Ä–µ–≥—É–ª—è—Ä–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É –≤–∏—è–≤–ª—è—î —á–∏—Å–ª–µ–Ω–Ω—ñ **–∑–≤–∏—á–∞–π–Ω—ñ HTTP –∑–∞–ø–∏—Ç–∏** –¥–æ **–º–µ—Ç–∞–¥–∞–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** –∑–∞ –∞–¥—Ä–µ—Å–æ—é `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —Å–µ—Ä–≤—ñ—Å, —á–∞—Å—Ç–æ —Ä–æ–±–∏—Ç—å —Ç–∞–∫—ñ –∑–∞–ø–∏—Ç–∏.

–¶–µ–π –∞–≥–µ–Ω—Ç –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è **–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∑–º—ñ–Ω —É –º–µ—Ç–∞–¥–∞–Ω–∏—Ö**. –ó–æ–∫—Ä–µ–º–∞, –º–µ—Ç–∞–¥–∞–Ω—ñ –º—ñ—Å—Ç—è—Ç—å **–ø–æ–ª–µ –¥–ª—è –ø—É–±–ª—ñ—á–Ω–∏—Ö –∫–ª—é—á—ñ–≤ SSH**. –ö–æ–ª–∏ –Ω–æ–≤–∏–π –ø—É–±–ª—ñ—á–Ω–∏–π SSH –∫–ª—é—á –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö, –∞–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ **–∞–≤—Ç–æ—Ä–∏–∑—É—î** –π–æ–≥–æ —É —Ñ–∞–π–ª—ñ `.authorized_key`. –í—ñ–Ω —Ç–∞–∫–æ–∂ –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** —ñ –¥–æ–¥–∞—Ç–∏ –π–æ–≥–æ –¥–æ **sudoers**, —è–∫—â–æ —Ü–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ.

–ê–≥–µ–Ω—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å –∑–º—ñ–Ω–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ –∑–∞–ø–∏—Ç –Ω–∞ **–æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—Å—ñ—Ö –∑–Ω–∞—á–µ–Ω—å –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ** (`GET /computeMetadata/v1/?recursive=true`). –¶–µ–π –∑–∞–ø–∏—Ç –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –∑–º—É—Å–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ª–∏—à–µ —É —Ä–∞–∑—ñ –∑–º—ñ–Ω–∏ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –∑ –º–æ–º–µ–Ω—Ç—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è, —â–æ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è Etag (`wait_for_change=true&last_etag=`). –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤–∫–ª—é—á–µ–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä **—Ç–∞–π–º-–∞—É—Ç** (`timeout_sec=`). –Ø–∫—â–æ –∑–º—ñ–Ω–∏ –Ω–µ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º –≤–∫–∞–∑–∞–Ω–æ–≥–æ —Ç–∞–π–º-–∞—É—Ç—É, —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î **–Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏**.

–¶–µ–π –ø—Ä–æ—Ü–µ—Å –¥–æ–∑–≤–æ–ª—è—î **IMDS** (–°–ª—É–∂–±–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä–∞) –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ **60 —Å–µ–∫—É–Ω–¥**, —è–∫—â–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –∑–º—ñ–Ω–∏ –Ω–µ –≤—ñ–¥–±—É–ª–∏—Å—è, —Å—Ç–≤–æ—Ä—é—é—á–∏ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–µ **–≤—ñ–∫–Ω–æ –¥–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è —Ñ–∞–ª—å—à–∏–≤–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ** –¥–æ –≥–æ—Å—Ç—å–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞.

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è —Ü–∏–º, –∑–¥—ñ–π—Å–Ω–∏–≤—à–∏ **–∞—Ç–∞–∫—É "–ª—é–¥–∏–Ω–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω—ñ" (MitM)**, –ø—ñ–¥—Ä–æ–±–ª—è—é—á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ IMDS —ñ **–≤—Å—Ç–∞–≤–ª—è—é—á–∏ –Ω–æ–≤–∏–π –ø—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á**. –¶–µ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø SSH –¥–æ —Ö–æ—Å—Ç–∞.

### Escape Technique

–•–æ—á–∞ ARP –ø—ñ–¥—Ä–æ–±–∫–∞ —î –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—é –≤ –º–µ—Ä–µ–∂–∞—Ö Google Compute Engine, [**–º–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è rshijack**](https://github.com/ezequielpereira/rshijack), —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∞ [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html), –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è —ñ–Ω'—î–∫—Ü—ñ—ó –ø–∞–∫–µ—Ç—ñ–≤ —É —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—ñ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ SSH –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

–¶—è –≤–µ—Ä—Å—ñ—è rshijack –¥–æ–∑–≤–æ–ª—è—î –≤–≤–æ–¥–∏—Ç–∏ –Ω–æ–º–µ—Ä–∏ ACK —ñ SEQ —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞, —â–æ –ø–æ–ª–µ–≥—à—É—î –ø—ñ–¥—Ä–æ–±–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª—å–Ω–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é —Å–µ—Ä–≤–µ—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è [**–Ω–µ–≤–µ–ª–∏–∫–∏–π Shell —Å–∫—Ä–∏–ø—Ç**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh), —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ **—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–π –∫–æ—Ä–∏—Å–Ω–∏–π –≤–∞–Ω—Ç–∞–∂**. –¶–µ–π –≤–∞–Ω—Ç–∞–∂ –≤–∏–∫–ª–∏–∫–∞—î Google Guest Agent –¥–ª—è **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `wouter`** –∑ –≤–∫–∞–∑–∞–Ω–∏–º –ø—É–±–ª—ñ—á–Ω–∏–º –∫–ª—é—á–µ–º —É —Ñ–∞–π–ª—ñ `.authorized_keys`.

–°–∫—Ä–∏–ø—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π –∂–µ ETag, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –Ω–µ–≥–∞–π–Ω–æ–º—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—é —Å–µ—Ä–≤–µ—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö Google Guest Agent –ø—Ä–æ —Ä—ñ–∑–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –∑–∞—Ç—Ä–∏–º—É—é—á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.

–©–æ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—ñ–¥—Ä–æ–±–∫—É, –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ç–∞–∫—ñ –∫—Ä–æ–∫–∏:

1. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
–®—É–∫–∞–π—Ç–µ —Ä—è–¥–æ–∫, –ø–æ–¥—ñ–±–Ω–∏–π –¥–æ:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ –¥–∞–Ω—ñ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º ETAG –¥–æ rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
–¶–µ–π –∫—Ä–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑—É—î –ø—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á, —â–æ –¥–æ–∑–≤–æ–ª—è—î SSH-–∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º –ø—Ä–∏–≤–∞—Ç–Ω–∏–º –∫–ª—é—á–µ–º.

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
