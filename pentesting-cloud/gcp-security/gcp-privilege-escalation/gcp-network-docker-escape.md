# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Estado Inicial

Em ambos os relatos onde esta t√©cnica √© especificada, os atacantes conseguiram obter acesso **root** dentro de um **Docker** container gerenciado pelo GCP com acesso √† rede do host (e as capacidades **`CAP_NET_ADMIN`** e **`CAP_NET_RAW`**).

## Explica√ß√£o do Ataque

Em uma inst√¢ncia do Google Compute Engine, a inspe√ß√£o regular do tr√°fego de rede revela numerosos **pedidos HTTP simples** para a **inst√¢ncia de metadados** em `169.254.169.254`. O [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), um servi√ßo de c√≥digo aberto, frequentemente faz tais pedidos.

Este agente √© projetado para **monitorar mudan√ßas nos metadados**. Notavelmente, os metadados incluem um **campo para chaves p√∫blicas SSH**. Quando uma nova chave p√∫blica SSH √© adicionada aos metadados, o agente automaticamente **autoriza** ela no arquivo `.authorized_key`. Ele tamb√©m pode **criar um novo usu√°rio** e adicion√°-lo aos **sudoers** se necess√°rio.

O agente monitora mudan√ßas enviando um pedido para **recuperar todos os valores de metadados recursivamente** (`GET /computeMetadata/v1/?recursive=true`). Este pedido √© projetado para solicitar ao servidor de metadados que envie uma resposta apenas se houver alguma mudan√ßa nos metadados desde a √∫ltima recupera√ß√£o, identificada por um Etag (`wait_for_change=true&last_etag=`). Al√©m disso, um par√¢metro de **timeout** (`timeout_sec=`) √© inclu√≠do. Se nenhuma mudan√ßa ocorrer dentro do timeout especificado, o servidor responde com os **valores inalterados**.

Esse processo permite que o **IMDS** (Instance Metadata Service) responda ap√≥s **60 segundos** se nenhuma mudan√ßa de configura√ß√£o ocorreu, criando uma potencial **janela para injetar uma resposta de configura√ß√£o falsa** para o agente convidado.

Um atacante poderia explorar isso realizando um **ataque Man-in-the-Middle (MitM)**, falsificando a resposta do servidor IMDS e **inserindo uma nova chave p√∫blica**. Isso poderia permitir acesso SSH n√£o autorizado ao host.

### T√©cnica de Escape

Embora o ARP spoofing seja ineficaz nas redes do Google Compute Engine, uma [**vers√£o modificada do rshijack**](https://github.com/ezequielpereira/rshijack) desenvolvida por [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) pode ser usada para inje√ß√£o de pacotes na comunica√ß√£o para injetar o usu√°rio SSH.

Esta vers√£o do rshijack permite inserir os n√∫meros ACK e SEQ como argumentos de linha de comando, facilitando a falsifica√ß√£o de uma resposta antes da resposta real do servidor de Metadados. Al√©m disso, um [**pequeno script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) √© usado para retornar um **payload especialmente elaborado**. Este payload faz com que o Google Guest Agent **crie um usu√°rio `wouter`** com uma chave p√∫blica especificada no arquivo `.authorized_keys`.

O script usa o mesmo ETag para evitar que o servidor de Metadados notifique imediatamente o Google Guest Agent sobre valores de metadados diferentes, atrasando assim a resposta.

Para executar a falsifica√ß√£o, os seguintes passos s√£o necess√°rios:

1. **Monitorar pedidos ao servidor de Metadados** usando **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Procure uma linha semelhante a:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Envie os dados de metadados falsos com o ETAG correto para rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Este passo autoriza a chave p√∫blica, permitindo a conex√£o SSH com a chave privada correspondente.

## Refer√™ncias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
