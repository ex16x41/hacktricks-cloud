# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

W obu opisach, w ktÃ³rych ta technika jest okreÅ›lona, napastnicy uzyskali dostÄ™p **root** wewnÄ…trz kontenera **Docker** zarzÄ…dzanego przez GCP z dostÄ™pem do sieci hosta (i moÅ¼liwoÅ›ciami **`CAP_NET_ADMIN`** oraz **`CAP_NET_RAW`**).

## Attack Explanation

Na instancji Google Compute Engine regularna inspekcja ruchu sieciowego ujawnia liczne **zwykÅ‚e Å¼Ä…dania HTTP** do **metadanych instancji** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), usÅ‚uga open-source, czÄ™sto wysyÅ‚a takie Å¼Ä…dania.

Ten agent jest zaprojektowany do **monitorowania zmian w metadanych**. W szczegÃ³lnoÅ›ci metadane zawierajÄ… **pole dla kluczy publicznych SSH**. Gdy nowy publiczny klucz SSH jest dodawany do metadanych, agent automatycznie **autoryzuje** go w pliku `.authorized_key`. MoÅ¼e rÃ³wnieÅ¼ **utworzyÄ‡ nowego uÅ¼ytkownika** i dodaÄ‡ go do **sudoers**, jeÅ›li zajdzie taka potrzeba.

Agent monitoruje zmiany, wysyÅ‚ajÄ…c Å¼Ä…danie do **pobrania wszystkich wartoÅ›ci metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To Å¼Ä…danie ma na celu skÅ‚onienie serwera metadanych do wysÅ‚ania odpowiedzi tylko wtedy, gdy nastÄ…piÅ‚a jakakolwiek zmiana w metadanych od ostatniego pobrania, identyfikowana przez Etag (`wait_for_change=true&last_etag=`). Dodatkowo, zawarty jest parametr **timeout** (`timeout_sec=`). JeÅ›li w okreÅ›lonym czasie nie nastÄ…pi zmiana, serwer odpowiada **niezmienionymi wartoÅ›ciami**.

Ten proces pozwala **IMDS** (Instance Metadata Service) odpowiedzieÄ‡ po **60 sekundach**, jeÅ›li nie wystÄ…piÅ‚a zmiana konfiguracji, tworzÄ…c potencjalne **okno do wstrzykniÄ™cia faÅ‚szywej odpowiedzi konfiguracyjnej** do agenta goÅ›cia.

Napastnik mÃ³gÅ‚by to wykorzystaÄ‡, przeprowadzajÄ…c **atak Man-in-the-Middle (MitM)**, faÅ‚szujÄ…c odpowiedÅº z serwera IMDS i **wstawiajÄ…c nowy klucz publiczny**. To mogÅ‚oby umoÅ¼liwiÄ‡ nieautoryzowany dostÄ™p SSH do hosta.

### Escape Technique

Podczas gdy faÅ‚szowanie ARP jest nieskuteczne w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) moÅ¼e byÄ‡ uÅ¼yta do wstrzykiwania pakietÃ³w w komunikacji, aby wstrzyknÄ…Ä‡ uÅ¼ytkownika SSH.

Ta wersja rshijack pozwala na wprowadzenie numerÃ³w ACK i SEQ jako argumentÃ³w wiersza poleceÅ„, co uÅ‚atwia faÅ‚szowanie odpowiedzi przed rzeczywistÄ… odpowiedziÄ… serwera metadanych. Dodatkowo, uÅ¼ywany jest [**maÅ‚y skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh), aby zwrÃ³ciÄ‡ **specjalnie przygotowany Å‚adunek**. Ten Å‚adunek wyzwala Google Guest Agent do **utworzenia uÅ¼ytkownika `wouter`** z okreÅ›lonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt uÅ¼ywa tego samego ETag, aby zapobiec natychmiastowemu powiadomieniu serwera metadanych agenta goÅ›cia Google o rÃ³Å¼nych wartoÅ›ciach metadanych, opÃ³ÅºniajÄ…c tym samym odpowiedÅº.

Aby wykonaÄ‡ faÅ‚szowanie, konieczne sÄ… nastÄ™pujÄ…ce kroki:

1. **Monitoruj Å¼Ä…dania do serwera metadanych** uÅ¼ywajÄ…c **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Szukaj linii podobnej do:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. WyÅ›lij faÅ‚szywe dane metadanych z poprawnym ETAG do rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ten krok autoryzuje klucz publiczny, umoÅ¼liwiajÄ…c poÅ‚Ä…czenie SSH z odpowiadajÄ…cym mu kluczem prywatnym.

## Odniesienia

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
