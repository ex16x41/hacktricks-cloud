# GCP - Bekstvo iz Docker mreÅ¾e

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim StruÄnjak (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim StruÄnjak (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## PoÄetno Stanje

U oba opisa gde je navedena ova tehnika, napadaÄi su uspeli da dobiju **root** pristup unutar **Docker** kontejnera upravljanih od strane GCP-a sa pristupom host mreÅ¾i (i sposobnostima **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## ObjaÅ¡njenje Napada

Na Google Compute Engine instanci, redovna inspekcija mreÅ¾nog saobraÄ‡aja otkriva brojne **obiÄne HTTP zahteve** ka **metadata instanci** na `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), otvorena usluga, Äesto vrÅ¡i takve zahteve.

Ovaj agent je dizajniran da **prati promene u metapodacima**. Posebno, metapodaci ukljuÄuju **polje za SSH javne kljuÄeve**. Kada se novi javni SSH kljuÄ doda u metapodatke, agent automatski ga **autorizuje** u `.authorized_key` fajlu. TakoÄ‘e moÅ¾e **kreirati novog korisnika** i dodati ih u **sudoers** ako je potrebno.

Agent prati promene slanjem zahteva za **dobijanje svih vrednosti metapodataka rekurzivno** (`GET /computeMetadata/v1/?recursive=true`). Ovaj zahtev je dizajniran da natera server metapodataka da poÅ¡alje odgovor samo ako postoji bilo kakva promena u metapodacima od poslednjeg preuzimanja, identifikovana sa Etagom (`wait_for_change=true&last_etag=`). Dodatno, ukljuÄen je i parametar **timeout** (`timeout_sec=`). Ako se ne desi nikakva promena u navedenom vremenu, server odgovara sa **nepromenjenim vrednostima**.

Ovaj proces omoguÄ‡ava **IMDS-u** (Instance Metadata Service) da odgovori nakon **60 sekundi** ako nije doÅ¡lo do promene konfiguracije, stvarajuÄ‡i potencijalni **prozor za ubacivanje laÅ¾nog odgovora konfiguracije** agentu gostiju.

NapadaÄ bi mogao iskoristiti ovo izvoÄ‘enjem **Napada ÄŒovek-u-Sredini (MitM)**, falsifikujuÄ‡i odgovor od servera IMDS i **ubacivanjem novog javnog kljuÄa**. Ovo bi omoguÄ‡ilo neovlaÅ¡Ä‡en pristup SSH-u hostu.

### Tehnika Bekstva

Iako ARP spoofing nije efikasan na Google Compute Engine mreÅ¾ama, [**modifikovana verzija rshijack**](https://github.com/ezequielpereira/rshijack) razvijena od strane [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) moÅ¾e se koristiti za ubacivanje paketa u komunikaciju kako bi se ubacio SSH korisnik.

Ova verzija rshijack omoguÄ‡ava unoÅ¡enje ACK i SEQ brojeva kao argumenata komandne linije, olakÅ¡avajuÄ‡i falsifikovanje odgovora pre stvarnog odgovora servera metapodataka. Dodatno, koristi se [**mali Shell skript**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) za vraÄ‡anje **specijalno oblikovanog payload-a**. Ovaj payload pokreÄ‡e Google Guest Agent da **kreira korisnika `wouter`** sa odreÄ‘enim javnim kljuÄem u `.authorized_keys` fajlu.

Skript koristi isti ETag kako bi spreÄio server metapodataka da odmah obavesti Google Guest Agent o razliÄitim vrednostima metapodataka, Äime se odlaÅ¾e odgovor.

Za izvrÅ¡enje falsifikovanja, potrebni su sledeÄ‡i koraci:

1. **Pratite zahteve ka serveru metapodataka** koristeÄ‡i **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
PotraÅ¾ite liniju sliÄnu:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. PoÅ¡aljite laÅ¾ne metapodatke sa taÄnim ETAG-om rshijack-u:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ovaj korak autorizuje javni kljuÄ, omoguÄ‡avajuÄ‡i SSH konekciju sa odgovarajuÄ‡im privatnim kljuÄem.


## Reference

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
UÄite i veÅ¾bajte hakovanje AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
UÄite i veÅ¾bajte hakovanje GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
