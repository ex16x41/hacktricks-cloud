# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

ì´ ê¸°ìˆ ì´ ëª…ì‹œëœ ë‘ ê°œì˜ ë³´ê³ ì„œì—ì„œ ê³µê²©ìë“¤ì€ GCPì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” **Docker** ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ **root** ì ‘ê·¼ ê¶Œí•œì„ ì–»ëŠ” ë° ì„±ê³µí–ˆìŠµë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œê³¼ **`CAP_NET_ADMIN`** ë° **`CAP_NET_RAW`** ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

## Attack Explanation

Google Compute Engine ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì •ê¸°ì ìœ¼ë¡œ ê²€ì‚¬í•˜ë©´ **ë©”íƒ€ë°ì´í„° ì¸ìŠ¤í„´ìŠ¤**ì¸ `169.254.169.254`ì— ëŒ€í•œ ìˆ˜ë§ì€ **ì¼ë°˜ HTTP ìš”ì²­**ì´ ë“œëŸ¬ë‚©ë‹ˆë‹¤. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)ë¼ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ì„œë¹„ìŠ¤ê°€ ì´ëŸ¬í•œ ìš”ì²­ì„ ìì£¼ ë³´ëƒ…ë‹ˆë‹¤.

ì´ ì—ì´ì „íŠ¸ëŠ” **ë©”íƒ€ë°ì´í„°ì˜ ë³€ê²½ ì‚¬í•­ì„ ëª¨ë‹ˆí„°ë§**í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ ë©”íƒ€ë°ì´í„°ì—ëŠ” **SSH ê³µê°œ í‚¤ë¥¼ ìœ„í•œ í•„ë“œ**ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê³µê°œ SSH í‚¤ê°€ ë©”íƒ€ë°ì´í„°ì— ì¶”ê°€ë˜ë©´, ì—ì´ì „íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì´ë¥¼ `.authorized_key` íŒŒì¼ì— **ìŠ¹ì¸**í•©ë‹ˆë‹¤. í•„ìš”í•  ê²½ìš° **ìƒˆ ì‚¬ìš©ì**ë¥¼ ìƒì„±í•˜ê³  **sudoers**ì— ì¶”ê°€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ì—ì´ì „íŠ¸ëŠ” **ëª¨ë“  ë©”íƒ€ë°ì´í„° ê°’ì„ ì¬ê·€ì ìœ¼ë¡œ ê²€ìƒ‰**í•˜ê¸° ìœ„í•´ ìš”ì²­ì„ ë³´ë‚´ ë³€ê²½ ì‚¬í•­ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤ (`GET /computeMetadata/v1/?recursive=true`). ì´ ìš”ì²­ì€ ë§ˆì§€ë§‰ ê²€ìƒ‰ ì´í›„ ë©”íƒ€ë°ì´í„°ì— ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ê²½ìš°ì—ë§Œ ë©”íƒ€ë°ì´í„° ì„œë²„ê°€ ì‘ë‹µí•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” Etag(`wait_for_change=true&last_etag=`)ë¡œ ì‹ë³„ë©ë‹ˆë‹¤. ë˜í•œ **íƒ€ì„ì•„ì›ƒ** ë§¤ê°œë³€ìˆ˜(`timeout_sec=`)ê°€ í¬í•¨ë©ë‹ˆë‹¤. ì§€ì •ëœ íƒ€ì„ì•„ì›ƒ ë‚´ì— ë³€ê²½ì´ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ ì„œë²„ëŠ” **ë³€ê²½ë˜ì§€ ì•Šì€ ê°’**ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.

ì´ í”„ë¡œì„¸ìŠ¤ëŠ” **IMDS**(Instance Metadata Service)ê°€ êµ¬ì„± ë³€ê²½ì´ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ **60ì´ˆ** í›„ì— ì‘ë‹µí•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬, ê²ŒìŠ¤íŠ¸ ì—ì´ì „íŠ¸ì— ëŒ€í•œ ê°€ì§œ êµ¬ì„± ì‘ë‹µì„ ì£¼ì…í•  ìˆ˜ ìˆëŠ” ì ì¬ì ì¸ **ì°½**ì„ ìƒì„±í•©ë‹ˆë‹¤.

ê³µê²©ìëŠ” ì´ë¥¼ ì´ìš©í•´ **Man-in-the-Middle (MitM) ê³µê²©**ì„ ìˆ˜í–‰í•˜ê³  IMDS ì„œë²„ì˜ ì‘ë‹µì„ ìŠ¤í‘¸í•‘í•˜ì—¬ **ìƒˆ ê³µê°œ í‚¤ë¥¼ ì‚½ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í˜¸ìŠ¤íŠ¸ì— ëŒ€í•œ ë¬´ë‹¨ SSH ì ‘ê·¼ì„ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Escape Technique

ARP ìŠ¤í‘¸í•‘ì€ Google Compute Engine ë„¤íŠ¸ì›Œí¬ì—ì„œ íš¨ê³¼ì ì´ì§€ ì•Šì§€ë§Œ, [**rshijackì˜ ìˆ˜ì •ëœ ë²„ì „**](https://github.com/ezequielpereira/rshijack)ì„ ì‚¬ìš©í•˜ì—¬ íŒ¨í‚· ì£¼ì…ì„ í†µí•´ SSH ì‚¬ìš©ìë¥¼ ì£¼ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë²„ì „ì˜ rshijackì€ ACK ë° SEQ ë²ˆí˜¸ë¥¼ ëª…ë ¹ì¤„ ì¸ìˆ˜ë¡œ ì…ë ¥í•  ìˆ˜ ìˆê²Œ í•˜ì—¬, ì‹¤ì œ ë©”íƒ€ë°ì´í„° ì„œë²„ ì‘ë‹µ ì „ì— ì‘ë‹µì„ ìŠ¤í‘¸í•‘í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ë˜í•œ [**ì‘ì€ Shell ìŠ¤í¬ë¦½íŠ¸**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh)ê°€ ì‚¬ìš©ë˜ì–´ **íŠ¹ë³„íˆ ì œì‘ëœ í˜ì´ë¡œë“œ**ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ í˜ì´ë¡œë“œëŠ” Google Guest Agentê°€ `.authorized_keys` íŒŒì¼ì— ì§€ì •ëœ ê³µê°œ í‚¤ë¡œ `wouter`ë¼ëŠ” ì‚¬ìš©ìë¥¼ **ìƒì„±**í•˜ë„ë¡ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

ìŠ¤í¬ë¦½íŠ¸ëŠ” ê°™ì€ ETagë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íƒ€ë°ì´í„° ì„œë²„ê°€ Google Guest Agentì— ë‹¤ë¥¸ ë©”íƒ€ë°ì´í„° ê°’ì— ëŒ€í•´ ì¦‰ì‹œ ì•Œë¦¬ì§€ ì•Šë„ë¡ í•˜ì—¬ ì‘ë‹µì„ ì§€ì—°ì‹œí‚µë‹ˆë‹¤.

ìŠ¤í‘¸í•‘ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒ ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤:

1. **tcpdump**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íƒ€ë°ì´í„° ì„œë²„ì— ëŒ€í•œ ìš”ì²­ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
ìœ ì‚¬í•œ ì¤„ì„ ì°¾ì•„ë³´ì„¸ìš”:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. ì˜¬ë°”ë¥¸ ETAGì™€ í•¨ê»˜ ê°€ì§œ ë©”íƒ€ë°ì´í„°ë¥¼ rshijackì— ì „ì†¡í•©ë‹ˆë‹¤:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
ì´ ë‹¨ê³„ëŠ” ê³µê°œ í‚¤ë¥¼ ì¸ì¦í•˜ì—¬ í•´ë‹¹ ê°œì¸ í‚¤ë¡œ SSH ì—°ê²°ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

## References

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
