# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

åœ¨è¿™ä¸¤ç¯‡å†™ä½œä¸­ï¼Œæ”»å‡»è€…æˆåŠŸè·å¾—äº†åœ¨ GCP ç®¡ç†çš„ **Docker** å®¹å™¨å†…çš„ **root** è®¿é—®æƒé™ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®ä¸»æœºç½‘ç»œï¼ˆä»¥åŠ **`CAP_NET_ADMIN`** å’Œ **`CAP_NET_RAW`** æƒé™ï¼‰ã€‚

## Attack Explanation

åœ¨ Google Compute Engine å®ä¾‹ä¸Šï¼Œå®šæœŸæ£€æŸ¥ç½‘ç»œæµé‡ä¼šå‘ç°å¤§é‡å¯¹ **å…ƒæ•°æ®å®ä¾‹** `169.254.169.254` çš„ **æ˜æ–‡ HTTP è¯·æ±‚**ã€‚ [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) æ˜¯ä¸€ä¸ªå¼€æºæœåŠ¡ï¼Œé¢‘ç¹å‘å‡ºæ­¤ç±»è¯·æ±‚ã€‚

è¯¥ä»£ç†æ—¨åœ¨ **ç›‘æ§å…ƒæ•°æ®çš„å˜åŒ–**ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå…ƒæ•°æ®ä¸­åŒ…å«ä¸€ä¸ª **SSH å…¬é’¥å­—æ®µ**ã€‚å½“æ–°çš„ SSH å…¬é’¥è¢«æ·»åŠ åˆ°å…ƒæ•°æ®æ—¶ï¼Œä»£ç†ä¼šè‡ªåŠ¨åœ¨ `.authorized_key` æ–‡ä»¶ä¸­ **æˆæƒ** å®ƒã€‚å¦‚æœéœ€è¦ï¼Œå®ƒè¿˜å¯ä»¥ **åˆ›å»ºæ–°ç”¨æˆ·** å¹¶å°†å…¶æ·»åŠ åˆ° **sudoers**ã€‚

è¯¥ä»£ç†é€šè¿‡å‘é€è¯·æ±‚ **é€’å½’æ£€ç´¢æ‰€æœ‰å…ƒæ•°æ®å€¼** (`GET /computeMetadata/v1/?recursive=true`) æ¥ç›‘æ§å˜åŒ–ã€‚æ­¤è¯·æ±‚æ—¨åœ¨æç¤ºå…ƒæ•°æ®æœåŠ¡å™¨ä»…åœ¨è‡ªä¸Šæ¬¡æ£€ç´¢ä»¥æ¥å…ƒæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶å‘é€å“åº”ï¼Œé€šè¿‡ Etag è¿›è¡Œè¯†åˆ«ï¼ˆ`wait_for_change=true&last_etag=`ï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸€ä¸ª **è¶…æ—¶** å‚æ•°ï¼ˆ`timeout_sec=`ï¼‰ã€‚å¦‚æœåœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ŒæœåŠ¡å™¨å°†ä»¥ **æœªæ›´æ”¹çš„å€¼** å“åº”ã€‚

æ­¤è¿‡ç¨‹å…è®¸ **IMDS**ï¼ˆå®ä¾‹å…ƒæ•°æ®æœåŠ¡ï¼‰åœ¨ **60 ç§’** åå“åº”ï¼Œå¦‚æœæ²¡æœ‰é…ç½®æ›´æ”¹å‘ç”Ÿï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ½œåœ¨çš„ **æ³¨å…¥å‡é…ç½®å“åº”** åˆ°æ¥å®¾ä»£ç†çš„çª—å£ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ‰§è¡Œ **ä¸­é—´äººæ”»å‡»ï¼ˆMitMï¼‰** æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä¼ªé€ æ¥è‡ª IMDS æœåŠ¡å™¨çš„å“åº”å¹¶ **æ’å…¥æ–°çš„å…¬é’¥**ã€‚è¿™å¯èƒ½ä½¿æœªç»æˆæƒçš„ SSH è®¿é—®ä¸»æœºæˆä¸ºå¯èƒ½ã€‚

### Escape Technique

è™½ç„¶ ARP æ¬ºéª—åœ¨ Google Compute Engine ç½‘ç»œä¸Šæ— æ•ˆï¼Œä½† [**rshijack çš„ä¿®æ”¹ç‰ˆæœ¬**](https://github.com/ezequielpereira/rshijack) ç”± [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) å¼€å‘ï¼Œå¯ä»¥ç”¨äºåœ¨é€šä¿¡ä¸­è¿›è¡Œæ•°æ®åŒ…æ³¨å…¥ï¼Œä»¥æ³¨å…¥ SSH ç”¨æˆ·ã€‚

æ­¤ç‰ˆæœ¬çš„ rshijack å…è®¸å°† ACK å’Œ SEQ æ•°å­—ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°è¾“å…¥ï¼Œä»è€Œåœ¨çœŸå®çš„å…ƒæ•°æ®æœåŠ¡å™¨å“åº”ä¹‹å‰ä¼ªé€ å“åº”ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ [**å° Shell è„šæœ¬**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) è¿”å› **ç‰¹åˆ¶çš„æœ‰æ•ˆè´Ÿè½½**ã€‚è¯¥æœ‰æ•ˆè´Ÿè½½è§¦å‘ Google Guest Agent **åˆ›å»ºä¸€ä¸ªåä¸º `wouter`** çš„ç”¨æˆ·ï¼Œå¹¶åœ¨ `.authorized_keys` æ–‡ä»¶ä¸­æŒ‡å®šå…¬é’¥ã€‚

è¯¥è„šæœ¬ä½¿ç”¨ç›¸åŒçš„ ETagï¼Œä»¥é˜²æ­¢å…ƒæ•°æ®æœåŠ¡å™¨ç«‹å³é€šçŸ¥ Google Guest Agent ä¸åŒçš„å…ƒæ•°æ®å€¼ï¼Œä»è€Œå»¶è¿Ÿå“åº”ã€‚

è¦æ‰§è¡Œä¼ªé€ ï¼Œå¿…é¡»è¿›è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **ä½¿ç”¨ tcpdump ç›‘æ§å¯¹å…ƒæ•°æ®æœåŠ¡å™¨çš„è¯·æ±‚**ï¼š
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
å¯»æ‰¾ç±»ä¼¼äºï¼š
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. å°†å¸¦æœ‰æ­£ç¡® ETAG çš„å‡å…ƒæ•°æ®å‘é€åˆ° rshijackï¼š
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
æ­¤æ­¥éª¤æˆæƒå…¬é’¥ï¼Œä½¿å¾—å¯ä»¥ä½¿ç”¨ç›¸åº”çš„ç§é’¥è¿›è¡ŒSSHè¿æ¥ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
