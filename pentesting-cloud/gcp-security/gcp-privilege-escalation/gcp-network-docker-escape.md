# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Aanvanklike Toestand

In beide skrywe waar hierdie tegniek gespesifiseer is, het die aanvallers daarin geslaag om **root** toegang binne 'n **Docker** houer wat deur GCP bestuur word, met toegang tot die gasheer netwerk (en die vermo√´ns **`CAP_NET_ADMIN`** en **`CAP_NET_RAW`**).

## Aanval Verduideliking

Op 'n Google Compute Engine instansie, onthul gereelde inspeksie van netwerkverkeer talle **eenvoudige HTTP versoeke** na die **metadata instansie** by `169.254.169.254`. Die [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), 'n oopbron diens, maak gereeld sulke versoeke.

Hierdie agent is ontwerp om **veranderinge in die metadata** te **moniteer**. Opmerklik is dat die metadata 'n **veld vir SSH publieke sleutels** insluit. Wanneer 'n nuwe publieke SSH sleutel by die metadata gevoeg word, **autorisere** die agent dit outomaties in die `.authorized_key` l√™er. Dit kan ook 'n **nuwe gebruiker** skep en hulle indien nodig by **sudoers** voeg.

Die agent monitor veranderinge deur 'n versoek te stuur om **alle metadata waardes rekursief te verkry** (`GET /computeMetadata/v1/?recursive=true`). Hierdie versoek is ontwerp om die metadata bediener te laat reageer slegs as daar enige verandering in die metadata was sedert die laaste verkryging, ge√Ødentifiseer deur 'n Etag (`wait_for_change=true&last_etag=`). Daarbenewens is 'n **timeout** parameter (`timeout_sec=`) ingesluit. As daar geen verandering binne die gespesifiseerde timeout plaasvind nie, reageer die bediener met die **onveranderde waardes**.

Hierdie proses laat die **IMDS** (Instance Metadata Service) toe om na **60 sekondes** te reageer as daar geen konfigurasie verandering plaasgevind het nie, wat 'n potensi√´le **venster vir die inspuiting van 'n valse konfigurasie antwoord** aan die gas agent skep.

'n Aanvaller kan dit benut deur 'n **Man-in-the-Middle (MitM) aanval** uit te voer, die antwoord van die IMDS bediener te vervals en 'n **nuwe publieke sleutel** in te voeg. Dit kan ongeoorloofde SSH toegang tot die gasheer moontlik maak.

### Ontsnapping Tegniek

Terwyl ARP vervalsing ondoeltreffend is op Google Compute Engine netwerke, kan 'n [**gewysigde weergawe van rshijack**](https://github.com/ezequielpereira/rshijack) wat deur [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) ontwikkel is, gebruik word vir pakkie inspuiting in die kommunikasie om die SSH gebruiker in te voeg.

Hierdie weergawe van rshijack laat die invoer van die ACK en SEQ nommers as opdraglyn argumente toe, wat die vervalsing van 'n antwoord voor die werklike Metadata bediener antwoord vergemaklik. Daarbenewens word 'n [**klein Shell skrip**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) gebruik om 'n **spesiaal saamgestelde payload** terug te gee. Hierdie payload laat die Google Guest Agent toe om 'n gebruiker `wouter` te **skep** met 'n gespesifiseerde publieke sleutel in die `.authorized_keys` l√™er.

Die skrip gebruik dieselfde ETag om te voorkom dat die Metadata bediener die Google Guest Agent onmiddellik van verskillende metadata waardes in kennis stel, wat die antwoord vertraag.

Om die vervalsing uit te voer, is die volgende stappe nodig:

1. **Monitor versoeke na die Metadata bediener** met **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Soek vir 'n lyn soortgelyk aan:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Stuur die vals metadata data met die korrekte ETAG na rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Hierdie stap magtig die publieke sleutel, wat SSH-verbinding met die ooreenstemmende private sleutel moontlik maak.

## Verwysings

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
