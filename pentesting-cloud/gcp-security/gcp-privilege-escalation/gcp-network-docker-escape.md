# GCP - Network Docker Escape

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Initial State

W obu opisach, w kt贸rych ta technika jest okrelona, napastnicy zdoali uzyska dostp **root** wewntrz kontenera **Docker** zarzdzanego przez GCP z dostpem do sieci hosta (oraz z uprawnieniami **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## Attack Explanation

Na instancji Google Compute Engine regularna inspekcja ruchu sieciowego ujawnia liczne **zwyke 偶dania HTTP** do **metadanych instancji** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), usuga open-source, czsto wysya takie 偶dania.

Ten agent jest zaprojektowany do **monitorowania zmian w metadanych**. W szczeg贸lnoci metadane zawieraj **pole dla kluczy publicznych SSH**. Gdy nowy klucz publiczny SSH zostanie dodany do metadanych, agent automatycznie **autoryzuje** go w pliku `.authorized_key`. Mo偶e r贸wnie偶 **utworzy nowego u偶ytkownika** i doda go do **sudoers**, jeli zajdzie taka potrzeba.

Agent monitoruje zmiany, wysyajc 偶danie do **pobrania wszystkich wartoci metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To 偶danie ma na celu skonienie serwera metadanych do wysania odpowiedzi tylko wtedy, gdy nastpia jakakolwiek zmiana w metadanych od ostatniego pobrania, identyfikowana przez Etag (`wait_for_change=true&last_etag=`). Dodatkowo, zawarty jest parametr **timeout** (`timeout_sec=`). Jeli w okrelonym czasie nie nastpi zmiana, serwer odpowiada **niezmienionymi wartociami**.

Ten proces pozwala **IMDS** (Instance Metadata Service) odpowiedzie po **60 sekundach**, jeli nie wystpia zmiana konfiguracji, tworzc potencjalne **okno do wstrzyknicia faszywej odpowiedzi konfiguracyjnej** do agenta gocia.

Napastnik m贸gby to wykorzysta, przeprowadzajc **atak Man-in-the-Middle (MitM)**, faszujc odpowied藕 z serwera IMDS i **wstawiajc nowy klucz publiczny**. To mogoby umo偶liwi nieautoryzowany dostp SSH do hosta.

### Escape Technique

Podczas gdy spoofing ARP jest nieskuteczny w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) mo偶e by u偶yta do wstrzykiwania pakiet贸w w komunikacji, aby wstrzykn u偶ytkownika SSH.

Ta wersja rshijack pozwala na wprowadzenie numer贸w ACK i SEQ jako argument贸w wiersza polece, co uatwia faszowanie odpowiedzi przed rzeczywist odpowiedzi serwera metadanych. Dodatkowo, u偶ywany jest [**may skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh), aby zwr贸ci **specjalnie przygotowany adunek**. Ten adunek wyzwala Google Guest Agent do **utworzenia u偶ytkownika `wouter`** z okrelonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt u偶ywa tego samego ETag, aby zapobiec natychmiastowemu powiadomieniu serwera metadanych agenta gocia Google o r贸偶nych wartociach metadanych, op贸藕niajc w ten spos贸b odpowied藕.

Aby wykona faszowanie, konieczne s nastpujce kroki:

1. **Monitoruj 偶dania do serwera metadanych** u偶ywajc **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Szukaj linii podobnej do:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Wylij faszywe dane metadanych z poprawnym ETAG do rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ten krok autoryzuje klucz publiczny, umo偶liwiajc poczenie SSH z odpowiadajcym mu kluczem prywatnym.

## References

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
