# GCP - Ucieczka z Docker Network

{% hint style="success" %}
Dowiedz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Stan PoczÄ…tkowy

W obu opisach, gdzie ta technika jest okreÅ›lona, atakujÄ…cy uzyskali dostÄ™p **root** do kontenera **Docker** zarzÄ…dzanego przez GCP z dostÄ™pem do sieci hosta (oraz uprawnieniami **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## WyjaÅ›nienie Ataku

Na instancji Google Compute Engine regularna inspekcja ruchu sieciowego ujawnia liczne **zwykÅ‚e Å¼Ä…dania HTTP** do **instancji metadanych** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), usÅ‚uga typu open-source, czÄ™sto wysyÅ‚a takie Å¼Ä…dania.

Ten agent jest zaprojektowany do **monitorowania zmian w metadanych**. Warto zauwaÅ¼yÄ‡, Å¼e metadane zawierajÄ… **pole dla kluczy publicznych SSH**. Gdy dodany zostaje nowy klucz publiczny SSH do metadanych, agent automatycznie **autoryzuje** go w pliku `.authorized_key`. MoÅ¼e rÃ³wnieÅ¼ **utworzyÄ‡ nowego uÅ¼ytkownika** i dodaÄ‡ go do **sudoers**, jeÅ›li jest to konieczne.

Agent monitoruje zmiany, wysyÅ‚ajÄ…c Å¼Ä…danie o **pobranie wszystkich wartoÅ›ci metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To Å¼Ä…danie ma na celu skÅ‚onienie serwera metadanych do wysÅ‚ania odpowiedzi tylko w przypadku zmiany w metadanych od ostatniego pobrania, zidentyfikowanej za pomocÄ… Etag (`wait_for_change=true&last_etag=`). Dodatkowo zawiera parametr **timeout** (`timeout_sec=`). JeÅ›li w okreÅ›lonym czasie nie nastÄ…pi Å¼adna zmiana, serwer odpowiada **niezmienionymi wartoÅ›ciami**.

Ten proces pozwala **IMDS** (Instance Metadata Service) odpowiedzieÄ‡ po **60 sekundach**, jeÅ›li nie nastÄ…piÅ‚a Å¼adna zmiana konfiguracji, tworzÄ…c potencjalne **okno do wstrzykniÄ™cia faÅ‚szywej odpowiedzi konfiguracyjnej** do agenta goÅ›cia.

AtakujÄ…cy mÃ³gÅ‚by wykorzystaÄ‡ to, wykonujÄ…c atak **Man-in-the-Middle (MitM)**, podszywajÄ…c siÄ™ pod odpowiedÅº serwera IMDS i **wstawiajÄ…c nowy klucz publiczny**. To mogÅ‚oby umoÅ¼liwiÄ‡ nieautoryzowany dostÄ™p SSH do hosta.

### Technika Ucieczki

Podczas gdy podsÅ‚uchiwanie ARP jest nieskuteczne w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiela**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) moÅ¼e byÄ‡ uÅ¼yta do wstrzykiwania pakietÃ³w w komunikacji w celu wstrzykniÄ™cia uÅ¼ytkownika SSH.

Ta wersja rshijack pozwala na wprowadzenie numerÃ³w ACK i SEQ jako argumentÃ³w wiersza poleceÅ„, uÅ‚atwiajÄ…c podszywanie siÄ™ pod odpowiedÅº przed rzeczywistÄ… odpowiedziÄ… serwera Metadanych. Dodatkowo uÅ¼ywany jest [**maÅ‚y skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) do zwrÃ³cenia **specjalnie spreparowanego Å‚adunku**. Ten Å‚adunek powoduje, Å¼e Google Guest Agent **tworzy uÅ¼ytkownika `wouter`** z okreÅ›lonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt uÅ¼ywa tego samego ETag, aby uniemoÅ¼liwiÄ‡ serwerowi Metadanych natychmiastowe powiadomienie Google Guest Agent o innych wartoÅ›ciach metadanych, opÃ³ÅºniajÄ…c w ten sposÃ³b odpowiedÅº.

Aby przeprowadziÄ‡ podszywanie, konieczne sÄ… nastÄ™pujÄ…ce kroki:

1. **Monitoruj Å¼Ä…dania do serwera Metadanych** za pomocÄ… **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
ZnajdÅº liniÄ™ podobnÄ… do:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. WyÅ›lij faÅ‚szywe dane metadanych z poprawnym ETAG do rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Ten krok autoryzuje klucz publiczny, umoÅ¼liwiajÄ…c poÅ‚Ä…czenie SSH z odpowiadajÄ…cym mu kluczem prywatnym.


## OdnoÅ›niki

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{% hint style="success" %}
Naucz siÄ™ i praktykuj Hacking w AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i praktykuj Hacking w GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
