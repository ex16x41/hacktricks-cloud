# GCP - KMS Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

KMSμ— λ€ν• μ •λ³΄:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

KMSμ—μ„λ” **κ¶ν•**μ΄ μ΅°μ§, ν΄λ” λ° ν”„λ΅μ νΈμ—μ„ **μƒμ†**λ  λΏλ§ μ•„λ‹λΌ **ν‚¤λ§**μ—μ„λ„ μƒμ†λλ‹¤λ” μ μ— μ μν•μ„Έμ”.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

μ΄ κ¶ν•μ„ μ‚¬μ©ν•μ—¬ **ν•΄λ‹Ή κ¶ν•μ΄ μλ” ν‚¤λ΅ μ •λ³΄λ¥Ό λ³µνΈν™”**ν•  μ μμµλ‹λ‹¤.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

μ΄ κ¶ν•μ„ κ°€μ§„ κ³µκ²©μλ” **μμ‹ μ—κ² κ¶ν•μ„ λ¶€μ—¬**ν•μ—¬ ν‚¤λ¥Ό μ‚¬μ©ν•΄ μ •λ³΄λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

μ΄ μ„μ„μ΄ μ‘λ™ν•λ” λ°©μ‹μ— λ€ν• κ°λ…μ  λ¶„μ„μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:

1. **μ„λΉ„μ¤ κ³„μ • A**λ” KMSμ—μ„ νΉμ • ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ§μ ‘μ μΌλ΅ λ³µνΈν™”ν•  μ μλ” κ¶ν•μ„ κ°€μ§€κ³  μμµλ‹λ‹¤.
2. **μ„λΉ„μ¤ κ³„μ • B**λ” `useToDecryptViaDelegation` κ¶ν•μ„ λ¶€μ—¬λ°›μµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ„λΉ„μ¤ κ³„μ • Aλ¥Ό λ€μ‹ ν•μ—¬ KMSμ— λ°μ΄ν„°λ¥Ό λ³µνΈν™” μ”μ²­ν•  μ μμµλ‹λ‹¤.

μ΄ **κ¶ν•μ μ‚¬μ©μ€ λ³µνΈν™” μ”μ²­μ΄ μ΄λ£¨μ–΄μ§ λ• KMS μ„λΉ„μ¤κ°€ κ¶ν•μ„ ν™•μΈν•λ” λ°©μ‹μ— μ•”λ¬µμ μΌλ΅ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤**.

Google Cloud KMS APIλ¥Ό μ‚¬μ©ν•μ—¬ ν‘μ¤€ λ³µνΈν™” μ”μ²­μ„ ν•  λ•(νμ΄μ¬ λλ” λ‹¤λ¥Έ μ–Έμ–΄μ—μ„), μ„λΉ„μ¤λ” **μ”μ²­ν•λ” μ„λΉ„μ¤ κ³„μ •μ΄ ν•„μ”ν• κ¶ν•μ„ κ°€μ§€κ³  μλ”μ§€ ν™•μΈν•©λ‹λ‹¤**. μ”μ²­μ΄ **`useToDecryptViaDelegation`** κ¶ν•μ„ κ°€μ§„ μ„λΉ„μ¤ κ³„μ •μ— μν•΄ μ΄λ£¨μ–΄μ§€λ©΄, KMSλ” μ΄ **κ³„μ •μ΄ ν‚¤λ¥Ό μ†μ ν• μ—”ν‹°ν‹°λ¥Ό λ€μ‹ ν•μ—¬ λ³µνΈν™”λ¥Ό μ”μ²­ν•  μ μλ”μ§€ ν™•μΈν•©λ‹λ‹¤**.

#### μ„μ„ μ„¤μ •ν•κΈ°

1. **μ‚¬μ©μ μ •μ μ—­ν•  μ •μ**: μ‚¬μ©μ μ •μ μ—­ν• μ„ μ •μν•λ” YAML νμΌ(μ: `custom_role.yaml`)μ„ μƒμ„±ν•©λ‹λ‹¤. μ΄ νμΌμ—λ” `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` κ¶ν•μ΄ ν¬ν•¨λμ–΄μ•Ό ν•©λ‹λ‹¤. μ΄ νμΌμ΄ μ–΄λ–»κ² μƒκ²Όλ”μ§€μ— λ€ν• μμ‹λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLIλ¥Ό μ‚¬μ©ν•μ—¬ μ‚¬μ©μ μ •μ μ—­ν•  λ§λ“¤κΈ°**: λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ Google Cloud ν”„λ΅μ νΈμ—μ„ μ‚¬μ©μ μ •μ μ—­ν• μ„ λ§λ“­λ‹λ‹¤:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[YOUR_PROJECT_ID]`λ¥Ό Google Cloud ν”„λ΅μ νΈ IDλ΅ κµμ²΄ν•μ„Έμ”.

3. **μ„λΉ„μ¤ κ³„μ •μ— μ‚¬μ©μ μ •μ μ—­ν•  λ¶€μ—¬**: μ΄ κ¶ν•μ„ μ‚¬μ©ν•  μ„λΉ„μ¤ κ³„μ •μ— μ‚¬μ©μ μ •μ μ—­ν• μ„ ν• λ‹Ήν•©λ‹λ‹¤. λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ„Έμ”:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]`μ™€ `[SERVICE_ACCOUNT_EMAIL]`λ¥Ό κ°κ° ν”„λ΅μ νΈ IDμ™€ μ„λΉ„μ¤ κ³„μ •μ μ΄λ©”μΌλ΅ κµμ²΄ν•μ„Έμ”.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** π’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** π¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
