# GCP - KMS Privesc

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

Inligting oor KMS:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

Let daarop dat in KMS die **toestemming** nie net **ge√´rf** word van Orgs, Folders en Projects nie, maar ook van **Keyrings**.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

Jy kan hierdie toestemming gebruik om **inligting te dekripteer met die sleutel** waaroor jy hierdie toestemming het.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

'n Aanvaller met hierdie toestemming kan **homself toestemmings gee** om die sleutel te gebruik om inligting te ontsleutel.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Hier is 'n konseptuele uiteensetting van hoe hierdie delegasie werk:

1. **Diensrekening A** het direkte toegang om te ontsleutel met 'n spesifieke sleutel in KMS.
2. **Diensrekening B** word die `useToDecryptViaDelegation` toestemming gegee. Dit stel dit in staat om KMS te versoek om data te ontsleutel namens Diensrekening A.

Die gebruik van hierdie **toestemming is implisiet in die manier waarop die KMS-diens toestemmings nagaan** wanneer 'n ontsleuteling versoek word.

Wanneer jy 'n standaard ontsleuteling versoek maak met die Google Cloud KMS API (in Python of 'n ander taal), **kyk die diens of die versoekende diensrekening die nodige toestemmings het**. As die versoek gemaak word deur 'n diensrekening met die **`useToDecryptViaDelegation`** toestemming, verifieer KMS of hierdie **rekening toegelaat word om ontsleuteling te versoek namens die entiteit wat die sleutel besit**.

#### Stel op vir Delegasie

1. **Definieer die Aangepaste Rol**: Skep 'n YAML-l√™er (bv. `custom_role.yaml`) wat die aangepaste rol definieer. Hierdie l√™er moet die `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` toestemming insluit. Hier is 'n voorbeeld van hoe hierdie l√™er mag lyk:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **Skep die Aangepaste Rol met die gcloud CLI**: Gebruik die volgende opdrag om die aangepaste rol in jou Google Cloud projek te skep:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

Vervang `[YOUR_PROJECT_ID]` met jou Google Cloud projek ID.

3. **Gee die Aangepaste Rol aan 'n Diensrekening**: Ken jou aangepaste rol toe aan 'n diensrekening wat hierdie toestemming sal gebruik. Gebruik die volgende opdrag:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
Vervang `[YOUR_PROJECT_ID]` en `[SERVICE_ACCOUNT_EMAIL]` met jou projek ID en die e-pos van die diensrekening, onderskeidelik.

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Kyk na die [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) of die [**telegram group**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
