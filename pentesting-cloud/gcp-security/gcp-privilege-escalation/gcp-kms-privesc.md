# GCP - KMS PrivEsc

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* í•´í‚¹ íŒì„ ê³µìœ í•˜ë ¤ë©´ **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œë¡œ PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
{% endhint %}

## KMS

KMSì— ëŒ€í•œ ì •ë³´:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

KMSì—ì„œ **ê¶Œí•œ**ì´ Orgs, í´ë” ë° í”„ë¡œì íŠ¸ì—ì„œ ìƒì†ë˜ëŠ” ê²ƒë¿ë§Œ ì•„ë‹ˆë¼ **í‚¤ë§**ì—ì„œë„ ìƒì†ëœë‹¤ëŠ” ì ì„ ìœ ì˜í•˜ì„¸ìš”.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ê¶Œí•œì„ ê°€ì§„ í‚¤ë¡œ **ì •ë³´ë¥¼ ë³µí˜¸í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ë³µí˜¸í™”í•˜ëŠ” ë° í•„ìš”í•œ ê¶Œí•œì„ **ìì‹ ì—ê²Œ ë¶€ì—¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

ë‹¤ìŒì€ ì´ ìœ„ì„ì´ ì‘ë™í•˜ëŠ” ë°©ì‹ì— ëŒ€í•œ ê°œë…ì  ë¶„í•´ì…ë‹ˆë‹¤:

1. **ì„œë¹„ìŠ¤ ê³„ì • A**ëŠ” KMSì˜ íŠ¹ì • í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™”í•˜ëŠ” ë° ì§ì ‘ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤.
2. **ì„œë¹„ìŠ¤ ê³„ì • B**ì—ê²Œ `useToDecryptViaDelegation` ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ KMSì—ê²Œ ì„œë¹„ìŠ¤ ê³„ì • A ëŒ€ì‹  ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•˜ë„ë¡ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ **ê¶Œí•œì˜ ì‚¬ìš©ì€ KMS ì„œë¹„ìŠ¤ê°€ ë³µí˜¸í™” ìš”ì²­ì´ ë°œìƒí•  ë•Œ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë°©ì‹ì—ì„œ ì•”ì‹œì **ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

Google Cloud KMS API(íŒŒì´ì¬ ë˜ëŠ” ë‹¤ë¥¸ ì–¸ì–´ì—ì„œ)ë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì¤€ ë³µí˜¸í™” ìš”ì²­ì„ ë§Œë“¤ ë•Œ, ì„œë¹„ìŠ¤ëŠ” **ìš”ì²­í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì´ í•„ìš”í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤. `useToDecryptViaDelegation` ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì´ ìš”ì²­ì„ ë§Œë“¤ë©´, KMSëŠ” **í•´ë‹¹ ê³„ì •ì´ í‚¤ë¥¼ ì†Œìœ í•œ ì—”í„°í‹° ëŒ€ì‹  ë³µí˜¸í™”ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤.

#### ìœ„ì„ ì„¤ì •

1. **ì‚¬ìš©ì ì •ì˜ ì—­í•  ì •ì˜**: ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ì •ì˜í•˜ëŠ” YAML íŒŒì¼(ì˜ˆ: `custom_role.yaml`)ì„ ë§Œë“­ë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` ê¶Œí•œì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒì€ ì´ íŒŒì¼ì´ ì–´ë–»ê²Œ ë³´ì¼ ìˆ˜ ìˆëŠ”ì§€ ì˜ˆì‹œì…ë‹ˆë‹¤:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì—­í•  ë§Œë“¤ê¸°**: ë‹¤ìŒ ëª¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ì—¬ Google Cloud í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ë§Œë“­ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[YOUR_PROJECT_ID]`ì„(ë¥¼) Google Cloud í”„ë¡œì íŠ¸ IDë¡œ ë°”ê¿‰ë‹ˆë‹¤.

3. **ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í•  ë¶€ì—¬**: ì´ ê¶Œí•œì„ ì‚¬ìš©í•  ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ í• ë‹¹í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]` ë° `[SERVICE_ACCOUNT_EMAIL]`ë¥¼ ê°ê° ê·€í•˜ì˜ í”„ë¡œì íŠ¸ ID ë° ì„œë¹„ìŠ¤ ê³„ì • ì´ë©”ì¼ë¡œ ëŒ€ì²´í•˜ì‹­ì‹œì˜¤.

{% hint style="success" %}
AWS í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP í•´í‚¹ í•™ìŠµ ë° ì‹¤ìŠµ: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›</summary>

* [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* í•´í‚¹ íŒì„ ê³µìœ í•˜ë ¤ë©´ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
{% endhint %}
