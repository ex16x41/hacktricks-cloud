# GCP - KMS Privesc

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## KMS

å…³äº KMS çš„ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

è¯·æ³¨æ„ï¼Œåœ¨ KMS ä¸­ï¼Œ**æƒé™**ä¸ä»…ä»ç»„ç»‡ã€æ–‡ä»¶å¤¹å’Œé¡¹ç›®**ç»§æ‰¿**ï¼Œè¿˜ä»**å¯†é’¥ç¯**ç»§æ‰¿ã€‚

### `cloudkms.cryptoKeyVersions.useToDecrypt`

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æƒé™æ¥**ä½¿ç”¨æ‚¨æ‹¥æœ‰æ­¤æƒé™çš„å¯†é’¥è§£å¯†ä¿¡æ¯**ã€‚
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥**æˆäºˆè‡ªå·±æƒé™**ä»¥ä½¿ç”¨å¯†é’¥è§£å¯†ä¿¡æ¯ã€‚
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

è¿™æ˜¯å…³äºæ­¤å§”æ‰˜å¦‚ä½•å·¥ä½œçš„æ¦‚å¿µæ€§åˆ†è§£ï¼š

1. **æœåŠ¡è´¦æˆ· A** ç›´æ¥è®¿é—®ä½¿ç”¨ KMS ä¸­çš„ç‰¹å®šå¯†é’¥è¿›è¡Œè§£å¯†ã€‚
2. **æœåŠ¡è´¦æˆ· B** è¢«æˆäºˆ `useToDecryptViaDelegation` æƒé™ã€‚è¿™ä½¿å…¶èƒ½å¤Ÿä»£è¡¨æœåŠ¡è´¦æˆ· A è¯·æ±‚ KMS è§£å¯†æ•°æ®ã€‚

æ­¤ **æƒé™çš„ä½¿ç”¨åœ¨ KMS æœåŠ¡æ£€æŸ¥æƒé™æ—¶æ˜¯éšå¼çš„**ï¼Œå½“å‘å‡ºè§£å¯†è¯·æ±‚æ—¶ã€‚

å½“æ‚¨ä½¿ç”¨ Google Cloud KMS APIï¼ˆåœ¨ Python æˆ–å…¶ä»–è¯­è¨€ä¸­ï¼‰å‘å‡ºæ ‡å‡†è§£å¯†è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ **æ£€æŸ¥è¯·æ±‚çš„æœåŠ¡è´¦æˆ·æ˜¯å¦å…·æœ‰å¿…è¦çš„æƒé™**ã€‚å¦‚æœè¯·æ±‚æ˜¯ç”±å…·æœ‰ **`useToDecryptViaDelegation`** æƒé™çš„æœåŠ¡è´¦æˆ·å‘å‡ºçš„ï¼ŒKMS ä¼šéªŒè¯è¯¥ **è´¦æˆ·æ˜¯å¦è¢«å…è®¸ä»£è¡¨æ‹¥æœ‰å¯†é’¥çš„å®ä½“è¯·æ±‚è§£å¯†**ã€‚

#### è®¾ç½®å§”æ‰˜

1. **å®šä¹‰è‡ªå®šä¹‰è§’è‰²**ï¼šåˆ›å»ºä¸€ä¸ª YAML æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ`custom_role.yaml`ï¼‰ï¼Œå®šä¹‰è‡ªå®šä¹‰è§’è‰²ã€‚æ­¤æ–‡ä»¶åº”åŒ…æ‹¬ `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` æƒé™ã€‚ä»¥ä¸‹æ˜¯æ­¤æ–‡ä»¶å¯èƒ½çš„ç¤ºä¾‹ï¼š
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **ä½¿ç”¨ gcloud CLI åˆ›å»ºè‡ªå®šä¹‰è§’è‰²**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æ‚¨çš„ Google Cloud é¡¹ç›®ä¸­åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼š

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

å°† `[YOUR_PROJECT_ID]` æ›¿æ¢ä¸ºæ‚¨çš„ Google Cloud é¡¹ç›® IDã€‚

3. **å°†è‡ªå®šä¹‰è§’è‰²æˆäºˆæœåŠ¡è´¦æˆ·**ï¼šå°†æ‚¨çš„è‡ªå®šä¹‰è§’è‰²åˆ†é…ç»™å°†ä½¿ç”¨æ­¤æƒé™çš„æœåŠ¡è´¦æˆ·ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
å°† `[YOUR_PROJECT_ID]` å’Œ `[SERVICE_ACCOUNT_EMAIL]` åˆ†åˆ«æ›¿æ¢ä¸ºæ‚¨çš„é¡¹ç›® ID å’ŒæœåŠ¡å¸æˆ·çš„ç”µå­é‚®ä»¶ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
