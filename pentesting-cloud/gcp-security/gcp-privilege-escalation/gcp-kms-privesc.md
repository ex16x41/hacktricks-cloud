# GCP - KMS Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## KMS

KMSì— ëŒ€í•œ ì •ë³´:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

KMSì—ì„œ **ê¶Œí•œ**ì€ ì¡°ì§, í´ë” ë° í”„ë¡œì íŠ¸ì—ì„œ **ìƒì†**ë  ë¿ë§Œ ì•„ë‹ˆë¼ **í‚¤ë§**ì—ì„œë„ ìƒì†ëœë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ **í•´ë‹¹ ê¶Œí•œì´ ìˆëŠ” í‚¤ë¡œ ì •ë³´ë¥¼ ë³µí˜¸í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

ì´ ê¶Œí•œì„ ê°€ì§„ ê³µê²©ìëŠ” **ìì‹ ì—ê²Œ ê¶Œí•œì„ ë¶€ì—¬**í•˜ì—¬ í‚¤ë¥¼ ì‚¬ìš©í•´ ì •ë³´ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

ì´ ìœ„ì„ì´ ì‘ë™í•˜ëŠ” ë°©ì‹ì— ëŒ€í•œ ê°œë…ì  ë¶„ì„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. **ì„œë¹„ìŠ¤ ê³„ì • A**ëŠ” KMSì—ì„œ íŠ¹ì • í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ì ìœ¼ë¡œ ë³µí˜¸í™”í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
2. **ì„œë¹„ìŠ¤ ê³„ì • B**ëŠ” `useToDecryptViaDelegation` ê¶Œí•œì„ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê³„ì • Aë¥¼ ëŒ€ì‹ í•˜ì—¬ KMSì— ë°ì´í„°ë¥¼ ë³µí˜¸í™” ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ **ê¶Œí•œì˜ ì‚¬ìš©ì€ ë³µí˜¸í™” ìš”ì²­ì´ ì´ë£¨ì–´ì§ˆ ë•Œ KMS ì„œë¹„ìŠ¤ê°€ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë°©ì‹ì— ì•”ë¬µì ìœ¼ë¡œ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤**.

Google Cloud KMS API(íŒŒì´ì¬ ë˜ëŠ” ë‹¤ë¥¸ ì–¸ì–´ ì‚¬ìš©)ë¥¼ í†µí•´ í‘œì¤€ ë³µí˜¸í™” ìš”ì²­ì„ í•  ë•Œ, ì„œë¹„ìŠ¤ëŠ” **ìš”ì²­í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •ì´ í•„ìš”í•œ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤**. ìš”ì²­ì´ **`useToDecryptViaDelegation`** ê¶Œí•œì„ ê°€ì§„ ì„œë¹„ìŠ¤ ê³„ì •ì— ì˜í•´ ì´ë£¨ì–´ì§€ë©´, KMSëŠ” ì´ **ê³„ì •ì´ í‚¤ë¥¼ ì†Œìœ í•œ ì—”í‹°í‹°ë¥¼ ëŒ€ì‹ í•˜ì—¬ ë³µí˜¸í™”ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤**.

#### ìœ„ì„ ì„¤ì •í•˜ê¸°

1. **ì‚¬ìš©ì ì •ì˜ ì—­í•  ì •ì˜**: ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ì •ì˜í•˜ëŠ” YAML íŒŒì¼(ì˜ˆ: `custom_role.yaml`)ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ íŒŒì¼ì—ëŠ” `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` ê¶Œí•œì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ íŒŒì¼ì´ ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ì— ëŒ€í•œ ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ì˜ ì—­í•  ë§Œë“¤ê¸°**: ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ Google Cloud í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ë§Œë“­ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[YOUR_PROJECT_ID]`ë¥¼ Google Cloud í”„ë¡œì íŠ¸ IDë¡œ êµì²´í•˜ì„¸ìš”.

3. **ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í•  ë¶€ì—¬**: ì´ ê¶Œí•œì„ ì‚¬ìš©í•  ì„œë¹„ìŠ¤ ê³„ì •ì— ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ í• ë‹¹í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
`[YOUR_PROJECT_ID]`ì™€ `[SERVICE_ACCOUNT_EMAIL]`ë¥¼ ê°ê° í”„ë¡œì íŠ¸ IDì™€ ì„œë¹„ìŠ¤ ê³„ì •ì˜ ì´ë©”ì¼ë¡œ ë°”ê¾¸ì‹­ì‹œì˜¤.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
