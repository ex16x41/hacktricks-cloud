# GCP - KMSææƒ

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## KMS

å…³äºKMSçš„ä¿¡æ¯ï¼š

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

è¯·æ³¨æ„ï¼Œåœ¨KMSä¸­ï¼Œ**æƒé™**ä¸ä»…æ¥è‡ªäºç»„ç»‡ã€æ–‡ä»¶å¤¹å’Œé¡¹ç›®ï¼Œè¿˜æ¥è‡ªäº**å¯†é’¥ç¯**ã€‚

### `cloudkms.cryptoKeyVersions.useToDecrypt`

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æƒé™æ¥ä½¿ç”¨æ‚¨æ‹¥æœ‰æ­¤æƒé™çš„å¯†é’¥**è§£å¯†ä¿¡æ¯**ã€‚
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

æ‹¥æœ‰è¿™ä¸ªæƒé™çš„æ”»å‡»è€…å¯ä»¥**ç»™è‡ªå·±æˆäºˆæƒé™**ä»¥ä½¿ç”¨å¯†é’¥è§£å¯†ä¿¡æ¯ã€‚
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

ä»¥ä¸‹æ˜¯è¿™ç§å§”æ‰˜å¦‚ä½•å·¥ä½œçš„æ¦‚å¿µæ€§åˆ†è§£ï¼š

1. **æœåŠ¡è´¦å· A** å¯ä»¥ç›´æ¥ä½¿ç”¨ KMS ä¸­çš„ç‰¹å®šå¯†é’¥è¿›è¡Œè§£å¯†ã€‚
2. **æœåŠ¡è´¦å· B** è¢«æˆäºˆ `useToDecryptViaDelegation` æƒé™ã€‚è¿™ä½¿å…¶èƒ½å¤Ÿè¯·æ±‚ KMS ä»£è¡¨æœåŠ¡è´¦å· A è§£å¯†æ•°æ®ã€‚

åœ¨è¿›è¡Œè§£å¯†è¯·æ±‚æ—¶ï¼Œ**KMS æœåŠ¡æ£€æŸ¥æƒé™çš„æ–¹å¼æ˜¯éšå¼çš„**ã€‚

å½“æ‚¨ä½¿ç”¨ Google Cloud KMS APIï¼ˆä½¿ç”¨ Pythonæˆ–å…¶ä»–è¯­è¨€ï¼‰è¿›è¡Œæ ‡å‡†è§£å¯†è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ä¼š**æ£€æŸ¥è¯·æ±‚çš„æœåŠ¡è´¦å·æ˜¯å¦å…·æœ‰å¿…è¦çš„æƒé™**ã€‚å¦‚æœè¯·æ±‚ç”±å…·æœ‰**`useToDecryptViaDelegation`**æƒé™çš„æœåŠ¡è´¦å·å‘å‡ºï¼ŒKMS å°†éªŒè¯æ­¤**è´¦å·æ˜¯å¦è¢«å…è®¸ä»£è¡¨æ‹¥æœ‰å¯†é’¥çš„å®ä½“è¯·æ±‚è§£å¯†**ã€‚

#### è®¾ç½®å§”æ‰˜

1. **å®šä¹‰è‡ªå®šä¹‰è§’è‰²**ï¼šåˆ›å»ºä¸€ä¸ª YAML æ–‡ä»¶ï¼ˆä¾‹å¦‚ `custom_role.yaml`ï¼‰ï¼Œå®šä¹‰è‡ªå®šä¹‰è§’è‰²ã€‚æ­¤æ–‡ä»¶åº”åŒ…æ‹¬ `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` æƒé™ã€‚ä»¥ä¸‹æ˜¯æ­¤æ–‡ä»¶å¯èƒ½çš„ç¤ºä¾‹ï¼š
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **ä½¿ç”¨ gcloud CLI åˆ›å»ºè‡ªå®šä¹‰è§’è‰²**ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æ‚¨çš„ Google Cloud é¡¹ç›®ä¸­åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼š

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

å°†`[YOUR_PROJECT_ID]`æ›¿æ¢ä¸ºæ‚¨çš„Google Cloudé¡¹ç›®IDã€‚

3. **æˆäºˆè‡ªå®šä¹‰è§’è‰²ç»™æœåŠ¡è´¦å·**ï¼šå°†æ‚¨çš„è‡ªå®šä¹‰è§’è‰²åˆ†é…ç»™å°†ä½¿ç”¨æ­¤æƒé™çš„æœåŠ¡è´¦å·ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
æ›¿æ¢`[YOUR_PROJECT_ID]`å’Œ`[SERVICE_ACCOUNT_EMAIL]`ä¸ºæ‚¨çš„é¡¹ç›®IDå’ŒæœåŠ¡è´¦å·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µAWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µGCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
