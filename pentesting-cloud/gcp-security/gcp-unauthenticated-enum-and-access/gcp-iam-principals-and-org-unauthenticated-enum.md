# GCP - IAM, Principals & Org Unauthenticated Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iam & GCP Principals

For more information check:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Czy domena jest u≈ºywana w Workspace?

1. **Sprawd≈∫ rekordy DNS**

Je≈õli ma rekord **`google-site-verification`**, prawdopodobnie u≈ºywa (lub u≈ºywa≈Ça) Workspace:
```
dig txt hacktricks.xyz

[...]
hacktricks.xyz.		3600	IN	TXT	"google-site-verification=2mWyPXMPXEEy6QqWbCfWkxFTcQhyYdwHrOxee1Yeo-0"
hacktricks.xyz.		3600	IN	TXT	"google-site-verification=C19PtLcZ1EGyzUYYJTX1Tp6bOGessxzN9gqE-SVKhRA"
hacktricks.xyz.		300	IN	TXT	"v=spf1 include:usb._netblocks.mimecast.com include:_spf.google.com include:_spf.psm.knowbe4.com include:_spf.salesforce.com include:spf.mandrillapp.com ~all"
```
Je≈õli co≈õ takiego jak **`include:_spf.google.com`** r√≥wnie≈º siƒô pojawia, to to potwierdza (zauwa≈º, ≈ºe je≈õli siƒô nie pojawia, to nie zaprzecza, poniewa≈º domena mo≈ºe byƒá w Workspace bez u≈ºywania gmaila jako dostawcy poczty).

2. **Spr√≥buj skonfigurowaƒá Workspace z tƒÖ domenƒÖ**

InnƒÖ opcjƒÖ jest spr√≥bowaƒá skonfigurowaƒá Workspace u≈ºywajƒÖc tej domeny, je≈õli **zg≈Çasza, ≈ºe domena jest ju≈º u≈ºywana** (jak na obrazku), wiesz, ≈ºe jest ju≈º u≈ºywana!

Aby spr√≥bowaƒá skonfigurowaƒá domenƒô Workspace, odwied≈∫: [https://workspace.google.com/business/signup/welcome](https://workspace.google.com/business/signup/welcome)

<figure><img src="../../../.gitbook/assets/image (330).png" alt=""><figcaption></figcaption></figure>

3. **Spr√≥buj odzyskaƒá has≈Ço do e-maila u≈ºywajƒÖc tej domeny**

Je≈õli znasz jakikolwiek wa≈ºny adres e-mail u≈ºywany w tej domenie (np.: admin@email.com lub info@email.com), mo≈ºesz spr√≥bowaƒá **odzyskaƒá konto** w [https://accounts.google.com/signin/v2/recoveryidentifier](https://accounts.google.com/signin/v2/recoveryidentifier), a je≈õli pr√≥ba nie wy≈õwietli b≈Çƒôdu wskazujƒÖcego, ≈ºe Google nie ma pojƒôcia o tym koncie, to korzysta z Workspace.

### Enumeracja e-maili i kont serwisowych

Mo≈ºliwe jest **enumerowanie wa≈ºnych e-maili domeny Workspace i e-maili SA** poprzez pr√≥by przypisania im uprawnie≈Ñ i sprawdzanie komunikat√≥w o b≈Çƒôdach. W tym celu wystarczy mieƒá uprawnienia do przypisania uprawnie≈Ñ do projektu (kt√≥ry mo≈ºe byƒá tylko w twojej w≈Çasno≈õci).

Zauwa≈º, ≈ºe aby je sprawdziƒá, ale nawet je≈õli istniejƒÖ, nie przyznawaj im uprawnienia, mo≈ºesz u≈ºyƒá typu **`serviceAccount`** gdy to jest **`user`** i **`user`** gdy to jest **`SA`**:

{% code overflow="wrap" %}
```bash
# Try to assign permissions to user 'unvalid-email-34r434f@hacktricks.xyz'
# but indicating it's a service account
gcloud projects add-iam-policy-binding <project-controlled-by-you> \
--member='serviceAccount:unvalid-email-34r434f@hacktricks.xyz' \
--role='roles/viewer'
## Response:
ERROR: (gcloud.projects.add-iam-policy-binding) INVALID_ARGUMENT: User unvalid-email-34r434f@hacktricks.xyz does not exist.

# Now try with a valid email
gcloud projects add-iam-policy-binding <project-controlled-by-you> \
--member='serviceAccount:support@hacktricks.xyz' \
--role='roles/viewer'
# Response:
ERROR: (gcloud.projects.add-iam-policy-binding) INVALID_ARGUMENT: Principal support@hacktricks.xyz is of type "user". The principal should appear as "user:support@hacktricks.xyz". See https://cloud.google.com/iam/help/members/types for additional documentation.
```
{% endcode %}

Szybszym sposobem na enumeracjƒô kont serwisowych w znanych projektach jest po prostu pr√≥ba dostƒôpu do URL: `https://iam.googleapis.com/v1/projects/<project-id>/serviceAccounts/<sa-email>`\
Na przyk≈Çad: `https://iam.googleapis.com/v1/projects/gcp-labs-3uis1xlx/serviceAccounts/appengine-lab-1-tarsget@gcp-labs-3uis1xlx.iam.gserviceaccount.com`

Je≈õli odpowied≈∫ to 403, oznacza to, ≈ºe SA istnieje. Ale je≈õli odpowied≈∫ to 404, oznacza to, ≈ºe nie istnieje:
```json
// Exists
{
"error": {
"code": 403,
"message": "Method doesn't allow unregistered callers (callers without established identity). Please use API Key or other form of API consumer identity to call this API.",
"status": "PERMISSION_DENIED"
}
}

// Doesn't exist
{
"error": {
"code": 404,
"message": "Unknown service account",
"status": "NOT_FOUND"
}
}
```
Zauwa≈º, ≈ºe gdy adres e-mail u≈ºytkownika by≈Ç wa≈ºny, komunikat o b≈Çƒôdzie wskazywa≈Ç, ≈ºe typ nie jest, wiƒôc uda≈Ço nam siƒô odkryƒá, ≈ºe adres e-mail support@hacktricks.xyz istnieje, nie przyznajƒÖc mu ≈ºadnych uprawnie≈Ñ.

Mo≈ºesz zrobiƒá **to samo z Kontami Us≈Çug** u≈ºywajƒÖc typu **`user:`** zamiast **`serviceAccount:`**:

{% code overflow="wrap" %}
```bash
# Non existent
gcloud projects add-iam-policy-binding <project-controlled-by-you> \
--member='serviceAccount:<invalid-sa-name>@<proj-uniq-name>.iam.gserviceaccount.com' \
--role='roles/viewer'
# Response
ERROR: (gcloud.projects.add-iam-policy-binding) INVALID_ARGUMENT: User <invalid-sa-name>@<proj-uniq-name>.iam.gserviceaccount.com does not exist.

# Existent
gcloud projects add-iam-policy-binding <project-controlled-by-you> \
--member='serviceAccount:<sa-name>@<proj-uniq-name>.iam.gserviceaccount.com' \
--role='roles/viewer'
# Response
ERROR: (gcloud.projects.add-iam-policy-binding) INVALID_ARGUMENT: Principal testing@digital-bonfire-410512.iam.gserviceaccount.com is of type "serviceAccount". The principal should appear as "serviceAccount:testing@digital-bonfire-410512.iam.gserviceaccount.com". See https://cloud.google.com/iam/help/members/types for additional documentation.
```
{% endcode %}

{% hint style="success" %}
Ucz siƒô i ƒáwicz Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz siƒô i ƒáwicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd≈∫ [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siƒô trikami hackingowymi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w na githubie.

</details>
{% endhint %}
