# Pentesting CI/CD Methodology

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS signifie **Syst√®me de Contr√¥le de Version**, ces syst√®mes permettent aux d√©veloppeurs de **g√©rer leur code source**. Le plus courant est **git** et vous trouverez g√©n√©ralement des entreprises l'utilisant sur l'une des **plateformes** suivantes :

* Github
* Gitlab
* Bitbucket
* Gitea
* Fournisseurs de cloud (ils offrent leurs propres plateformes VCS)

## CI/CD Pipelines

Les pipelines CI/CD permettent aux d√©veloppeurs d'**automatiser l'ex√©cution du code** √† diverses fins, y compris la construction, les tests et le d√©ploiement d'applications. Ces flux de travail automatis√©s sont **d√©clench√©s par des actions sp√©cifiques**, telles que des envois de code, des demandes de tirage ou des t√¢ches planifi√©es. Ils sont utiles pour rationaliser le processus du d√©veloppement √† la production.

Cependant, ces syst√®mes doivent √™tre **ex√©cut√©s quelque part** et g√©n√©ralement avec des **identifiants privil√©gi√©s pour d√©ployer du code ou acc√©der √† des informations sensibles**.

## VCS Pentesting Methodology

{% hint style="info" %}
M√™me si certaines plateformes VCS permettent de cr√©er des pipelines, dans cette section, nous allons analyser uniquement les attaques potentielles sur le contr√¥le du code source.
{% endhint %}

Les plateformes contenant le code source de votre projet contiennent des informations sensibles et les gens doivent √™tre tr√®s prudents avec les autorisations accord√©es √† l'int√©rieur de cette plateforme. Voici quelques probl√®mes courants sur les plateformes VCS que les attaquants pourraient exploiter :

* **Fuites** : Si votre code contient des fuites dans les commits et que l'attaquant peut acc√©der au d√©p√¥t (parce qu'il est public ou parce qu'il a acc√®s), il pourrait d√©couvrir les fuites.
* **Acc√®s** : Si un attaquant peut **acc√©der √† un compte √† l'int√©rieur de la plateforme VCS**, il pourrait obtenir **plus de visibilit√© et d'autorisations**.
* **Enregistrement** : Certaines plateformes ne permettront qu'aux utilisateurs externes de cr√©er un compte.
* **SSO** : Certaines plateformes ne permettront pas aux utilisateurs de s'inscrire, mais permettront √† quiconque d'acc√©der avec un SSO valide (donc un attaquant pourrait utiliser son compte github pour entrer par exemple).
* **Identifiants** : Nom d'utilisateur + Mot de passe, jetons personnels, cl√©s ssh, jetons Oauth, cookies... il existe plusieurs types de jetons qu'un utilisateur pourrait voler pour acc√©der d'une mani√®re ou d'une autre √† un d√©p√¥t.
* **Webhooks** : Les plateformes VCS permettent de g√©n√©rer des webhooks. S'ils ne sont **pas prot√©g√©s** par des secrets non visibles, un **attaquant pourrait en abuser**.
* Si aucun secret n'est en place, l'attaquant pourrait abuser du webhook de la plateforme tierce.
* Si le secret est dans l'URL, la m√™me chose se produit et l'attaquant a √©galement le secret.
* **Compromission du code :** Si un acteur malveillant a un certain type d'acc√®s **en √©criture** sur les d√©p√¥ts, il pourrait essayer d'**injecter du code malveillant**. Pour r√©ussir, il pourrait avoir besoin de **contourner les protections de branche**. Ces actions peuvent √™tre effectu√©es avec diff√©rents objectifs en t√™te :
* Compromettre la branche principale pour **compromettre la production**.
* Compromettre la branche principale (ou d'autres branches) pour **compromettre les machines des d√©veloppeurs** (car ils ex√©cutent g√©n√©ralement des tests, terraform ou d'autres choses √† l'int√©rieur du d√©p√¥t sur leurs machines).
* **Compromettre le pipeline** (voir la section suivante).

## Pipelines Pentesting Methodology

Le moyen le plus courant de d√©finir un pipeline est d'utiliser un **fichier de configuration CI h√©berg√© dans le d√©p√¥t** que le pipeline construit. Ce fichier d√©crit l'ordre des travaux ex√©cut√©s, les conditions qui affectent le flux et les param√®tres de l'environnement de construction.\
Ces fichiers ont g√©n√©ralement un nom et un format coh√©rents, par exemple ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), et les fichiers YAML des GitHub Actions situ√©s sous .github/workflows. Lorsqu'il est d√©clench√©, le travail du pipeline **t√©l√©charge le code** √† partir de la source s√©lectionn√©e (par exemple, commit / branche), et **ex√©cute les commandes sp√©cifi√©es dans le fichier de configuration CI** contre ce code.

Par cons√©quent, l'objectif ultime de l'attaquant est de **compromettre d'une mani√®re ou d'une autre ces fichiers de configuration** ou les **commandes qu'ils ex√©cutent**.

### PPE - Ex√©cution de Pipeline Empoisonn√©

Le chemin d'Ex√©cution de Pipeline Empoisonn√© (PPE) exploite les autorisations dans un d√©p√¥t SCM pour manipuler un pipeline CI et ex√©cuter des commandes nuisibles. Les utilisateurs ayant les autorisations n√©cessaires peuvent modifier les fichiers de configuration CI ou d'autres fichiers utilis√©s par le travail du pipeline pour inclure des commandes malveillantes. Cela "empoisonne" le pipeline CI, entra√Ænant l'ex√©cution de ces commandes malveillantes.

Pour qu'un acteur malveillant r√©ussisse √† effectuer une attaque PPE, il doit √™tre capable de :

* Avoir un **acc√®s en √©criture √† la plateforme VCS**, car g√©n√©ralement les pipelines sont d√©clench√©s lorsqu'un envoi ou une demande de tirage est effectu√©e. (Consultez la m√©thodologie de pentesting VCS pour un r√©sum√© des moyens d'obtenir un acc√®s).
* Notez que parfois une **PR externe compte comme "acc√®s en √©criture"**.
* M√™me s'il a des autorisations d'√©criture, il doit s'assurer qu'il peut **modifier le fichier de configuration CI ou d'autres fichiers sur lesquels la configuration repose**.
* Pour cela, il pourrait avoir besoin de pouvoir **contourner les protections de branche**.

Il existe 3 variantes de PPE :

* **D-PPE** : Une attaque **D-PPE directe** se produit lorsque l'acteur **modifie le fichier de configuration CI** qui va √™tre ex√©cut√©.
* **I-DDE** : Une attaque **I-DDE indirecte** se produit lorsque l'acteur **modifie** un **fichier** sur lequel le fichier de configuration CI qui va √™tre ex√©cut√© **s'appuie** (comme un fichier make ou une configuration terraform).
* **PPE Public ou 3PE** : Dans certains cas, les pipelines peuvent √™tre **d√©clench√©s par des utilisateurs qui n'ont pas d'acc√®s en √©criture dans le d√©p√¥t** (et qui pourraient m√™me ne pas faire partie de l'organisation) car ils peuvent envoyer une PR.
* **Injection de Commande 3PE** : En g√©n√©ral, les pipelines CI/CD **d√©finiront des variables d'environnement** avec **des informations sur la PR**. Si cette valeur peut √™tre contr√¥l√©e par un attaquant (comme le titre de la PR) et est **utilis√©e** dans un **endroit dangereux** (comme l'ex√©cution de **commandes sh**), un attaquant pourrait **injecter des commandes l√†-dedans**.

### Avantages de l'Exploitation

Connaissant les 3 variantes pour empoisonner un pipeline, voyons ce qu'un attaquant pourrait obtenir apr√®s une exploitation r√©ussie :

* **Secrets** : Comme mentionn√© pr√©c√©demment, les pipelines n√©cessitent des **privil√®ges** pour leurs travaux (r√©cup√©rer le code, le construire, le d√©ployer...) et ces privil√®ges sont g√©n√©ralement **accord√©s dans des secrets**. Ces secrets sont g√©n√©ralement accessibles via **des variables d'environnement ou des fichiers √† l'int√©rieur du syst√®me**. Par cons√©quent, un attaquant essaiera toujours d'exfiltrer autant de secrets que possible.
* Selon la plateforme de pipeline, l'attaquant **pourrait avoir besoin de sp√©cifier les secrets dans la configuration**. Cela signifie que si l'attaquant ne peut pas modifier le pipeline de configuration CI (**I-PPE** par exemple), il pourrait **seulement exfiltrer les secrets que ce pipeline a**.
* **Calcul** : Le code est ex√©cut√© quelque part, selon l'endroit o√π il est ex√©cut√©, un attaquant pourrait √™tre en mesure de pivoter davantage.
* **Sur site** : Si les pipelines sont ex√©cut√©s sur site, un attaquant pourrait se retrouver dans un **r√©seau interne avec acc√®s √† plus de ressources**.
* **Cloud** : L'attaquant pourrait acc√©der √† **d'autres machines dans le cloud** mais pourrait √©galement **exfiltrer** des jetons de r√¥les IAM/comptes de service **pour obtenir un acc√®s suppl√©mentaire √† l'int√©rieur du cloud**.
* **Machine de plateforme** : Parfois, les travaux seront ex√©cut√©s √† l'int√©rieur des **machines de la plateforme des pipelines**, qui se trouvent g√©n√©ralement dans un cloud avec **aucun autre acc√®s**.
* **S√©lectionnez-le :** Parfois, la **plateforme des pipelines aura configur√© plusieurs machines** et si vous pouvez **modifier le fichier de configuration CI**, vous pouvez **indiquer o√π vous souhaitez ex√©cuter le code malveillant**. Dans cette situation, un attaquant ex√©cutera probablement un shell invers√© sur chaque machine possible pour essayer de l'exploiter davantage.
* **Compromettre la production** : Si vous √™tes √† l'int√©rieur du pipeline et que la version finale est construite et d√©ploy√©e √† partir de celui-ci, vous pourriez **compromettre le code qui va finir par s'ex√©cuter en production**.

## Plus d'infos pertinentes

### Outils & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) est un outil open-source pour auditer votre cha√Æne d'approvisionnement logicielle pour la conformit√© en mati√®re de s√©curit√© bas√© sur un nouveau [**benchmark CIS Software Supply Chain**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). L'audit se concentre sur l'ensemble du processus SDLC, o√π il peut r√©v√©ler des risques du temps de code au temps de d√©ploiement.

### Top 10 des Risques de S√©curit√© CI/CD

Consultez cet article int√©ressant sur les 10 principaux risques CI/CD selon Cider : [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratoires

* Sur chaque plateforme que vous pouvez ex√©cuter localement, vous trouverez comment la lancer localement afin que vous puissiez la configurer comme vous le souhaitez pour la tester.
* Laboratoire Gitea + Jenkins : [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Outils Automatiques

* [**Checkov**](https://github.com/bridgecrewio/checkov) : **Checkov** est un outil d'analyse de code statique pour l'infrastructure en tant que code.

## R√©f√©rences

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
