# Pentesting CI/CD Methodology

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS oznaÄava **Sistem za kontrolu verzija**, ovi sistemi omoguÄ‡avaju programerima da **upravljaju svojim izvorni kodom**. NajÄeÅ¡Ä‡i je **git** i obiÄno Ä‡ete naÄ‡i kompanije koje ga koriste na jednoj od sledeÄ‡ih **platformi**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Cloud provajderi (oni nude svoje VCS platforme)

## CI/CD Pipelines

CI/CD pipelines omoguÄ‡avaju programerima da **automatizuju izvrÅ¡avanje koda** u razne svrhe, ukljuÄujuÄ‡i izgradnju, testiranje i implementaciju aplikacija. Ovi automatizovani radni tokovi se **pokreÄ‡u specifiÄnim akcijama**, kao Å¡to su push-ovi koda, pull zahtevi ili zakazani zadaci. Korisni su za pojednostavljenje procesa od razvoja do produkcije.

MeÄ‘utim, ovi sistemi moraju biti **izvrÅ¡eni negde** i obiÄno sa **privilegovanim akreditivima za implementaciju koda ili pristup osetljivim informacijama**.

## VCS Pentesting Methodology

{% hint style="info" %}
ÄŒak i ako neke VCS platforme omoguÄ‡avaju kreiranje pipelines, u ovoj sekciji Ä‡emo analizirati samo potencijalne napade na kontrolu izvornog koda.
{% endhint %}

Platforme koje sadrÅ¾e izvorni kod vaÅ¡eg projekta sadrÅ¾e osetljive informacije i ljudi moraju biti veoma oprezni sa dozvolama dodeljenim unutar ove platforme. Ovo su neki uobiÄajeni problemi na VCS platformama koje napadaÄ moÅ¾e zloupotrebiti:

* **Izdavanje**: Ako vaÅ¡ kod sadrÅ¾i izdavanja u commit-ima i napadaÄ moÅ¾e pristupiti repozitorijumu (jer je javan ili jer ima pristup), mogao bi otkriti izdavanja.
* **Pristup**: Ako napadaÄ moÅ¾e **pristupiti nalogu unutar VCS platforme**, mogao bi dobiti **veÄ‡u vidljivost i dozvole**.
* **Registracija**: Neke platforme Ä‡e samo omoguÄ‡iti spoljnim korisnicima da kreiraju nalog.
* **SSO**: Neke platforme neÄ‡e dozvoliti korisnicima da se registruju, ali Ä‡e omoguÄ‡iti svakome da pristupi sa vaÅ¾eÄ‡im SSO (tako da napadaÄ moÅ¾e koristiti svoj github nalog da uÄ‘e, na primer).
* **Akreditivi**: KorisniÄko ime+Lozinka, liÄni tokeni, ssh kljuÄevi, Oauth tokeni, kolaÄiÄ‡i... postoji nekoliko vrsta tokena koje korisnik moÅ¾e ukrasti da bi na neki naÄin pristupio repozitorijumu.
* **Webhook-ovi**: VCS platforme omoguÄ‡avaju generisanje webhook-ova. Ako nisu **zaÅ¡tiÄ‡eni** nevidljivim tajnama, **napadaÄ bi ih mogao zloupotrebiti**.
* Ako nema tajne, napadaÄ bi mogao zloupotrebiti webhook treÄ‡e strane
* Ako je tajna u URL-u, isto se deÅ¡ava i napadaÄ takoÄ‘e ima tajnu
* **Kompromitovanje koda:** Ako zlonamerna osoba ima neku vrstu **write** pristupa nad repozitorijumima, mogla bi pokuÅ¡ati da **ubaci zlonamerni kod**. Da bi bila uspeÅ¡na, moÅ¾da Ä‡e morati da **obiÄ‘e zaÅ¡tite grana**. Ove akcije se mogu izvesti sa razliÄitim ciljevima na umu:
* Kompromitovati glavnu granu da bi **kompromitovala produkciju**.
* Kompromitovati glavnu (ili druge grane) da bi **kompromitovala maÅ¡ine programera** (jer obiÄno izvrÅ¡avaju testove, terraform ili druge stvari unutar repozitorijuma na svojim maÅ¡inama).
* **Kompromitovati pipeline** (proverite sledeÄ‡u sekciju)

## Pipelines Pentesting Methodology

NajÄeÅ¡Ä‡i naÄin definisanja pipeline-a je koriÅ¡Ä‡enjem **CI konfiguracione datoteke koja se hostuje u repozitorijumu** koji pipeline gradi. Ova datoteka opisuje redosled izvrÅ¡enih poslova, uslove koji utiÄu na tok i postavke okruÅ¾enja za izgradnju.\
Ove datoteke obiÄno imaju dosledno ime i format, na primer â€” Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), i YAML datoteke GitHub Actions smeÅ¡tene pod .github/workflows. Kada se pokrene, posao pipeline-a **preuzima kod** iz odabranog izvora (npr. commit / grana), i **izvrÅ¡ava komande navedene u CI konfiguracionoj datoteci** protiv tog koda.

Stoga je krajnji cilj napadaÄa da na neki naÄin **kompromituje te konfiguracione datoteke** ili **komande koje izvrÅ¡avaju**.

### PPE - IzvrÅ¡enje ZagaÄ‘enog Pipeline-a

Putanja IzvrÅ¡enja ZagaÄ‘enog Pipeline-a (PPE) koristi dozvole u SCM repozitorijumu da manipuliÅ¡e CI pipeline-om i izvrÅ¡ava Å¡tetne komande. Korisnici sa potrebnim dozvolama mogu modifikovati CI konfiguracione datoteke ili druge datoteke koje koristi posao pipeline-a da ukljuÄe zlonamerne komande. Ovo "zagaÄ‘uje" CI pipeline, Å¡to dovodi do izvrÅ¡enja ovih zlonamernih komandi.

Da bi zlonamerna osoba bila uspeÅ¡na u izvoÄ‘enju PPE napada, mora biti u moguÄ‡nosti da:

* Ima **write pristup VCS platformi**, jer se obiÄno pipeline-i pokreÄ‡u kada se izvrÅ¡i push ili pull zahtev. (Proverite metodologiju pentestinga VCS za saÅ¾etak naÄina dobijanja pristupa).
* Imajte na umu da ponekad **spoljni PR raÄuna kao "write pristup"**.
* ÄŒak i ako ima write dozvole, mora biti siguran da moÅ¾e **modifikovati CI konfiguracionu datoteku ili druge datoteke na koje se konfiguracija oslanja**.
* Za to, moÅ¾da Ä‡e morati da bude u moguÄ‡nosti da **obiÄ‘e zaÅ¡tite grana**.

Postoje 3 vrste PPE:

* **D-PPE**: **Direktni PPE** napad se deÅ¡ava kada akter **modifikuje CI konfiguraciju** datoteku koja Ä‡e biti izvrÅ¡ena.
* **I-DDE**: **Indirektni PPE** napad se deÅ¡ava kada akter **modifikuje** **datoteku** na koju se CI konfiguraciona datoteka oslanja (kao Å¡to je make datoteka ili terraform konfiguracija).
* **Javni PPE ili 3PE**: U nekim sluÄajevima, pipeline-i mogu biti **pokrenuti od strane korisnika koji nemaju write pristup u repozitorijumu** (i koji moÅ¾da Äak nisu ni deo organizacije) jer mogu poslati PR.
* **3PE Injekcija Komandi**: ObiÄno, CI/CD pipeline-i Ä‡e **postaviti promenljive okruÅ¾enja** sa **informacijama o PR-u**. Ako tu vrednost moÅ¾e kontrolisati napadaÄ (kao Å¡to je naslov PR-a) i koristi se na **opasnom mestu** (kao Å¡to je izvrÅ¡avanje **sh komandi**), napadaÄ moÅ¾e **ubaciti komande tamo**.

### Prednosti Eksploatacije

Poznavanje 3 vrste za zagaÄ‘enje pipeline-a, hajde da proverimo Å¡ta napadaÄ moÅ¾e dobiti nakon uspeÅ¡ne eksploatacije:

* **Tajne**: Kao Å¡to je ranije pomenuto, pipeline-i zahtevaju **privilegije** za svoje poslove (preuzimanje koda, izgradnja, implementacija...) i te privilegije se obiÄno **dodeljuju u tajnama**. Ove tajne su obiÄno dostupne putem **env promenljivih ili datoteka unutar sistema**. Stoga Ä‡e napadaÄ uvek pokuÅ¡ati da eksfiltrira Å¡to viÅ¡e tajni.
* U zavisnosti od platforme pipeline-a, napadaÄ **moÅ¾e morati da specificira tajne u konfiguraciji**. To znaÄi da ako napadaÄ ne moÅ¾e da modifikuje CI konfiguracioni pipeline (**I-PPE**, na primer), moÅ¾e **samo eksfiltrirati tajne koje taj pipeline ima**.
* **RaÄunanje**: Kod se izvrÅ¡ava negde, u zavisnosti od toga gde se izvrÅ¡ava, napadaÄ bi mogao biti u moguÄ‡nosti da se dalje preusmeri.
* **Na lokaciji**: Ako se pipeline-i izvrÅ¡avaju na lokaciji, napadaÄ bi mogao zavrÅ¡iti u **internoj mreÅ¾i sa pristupom viÅ¡e resursima**.
* **Cloud**: NapadaÄ bi mogao pristupiti **drugim maÅ¡inama u cloudu**, ali takoÄ‘e bi mogao **eksfiltrirati** IAM uloge/service accounts **tokena** iz njega da bi dobio **dalji pristup unutar clouda**.
* **MaÅ¡ine platforme**: Ponekad Ä‡e poslovi biti izvrÅ¡eni unutar **maÅ¡ina platforme pipeline-a**, koje obiÄno su unutar clouda sa **nema viÅ¡e pristupa**.
* **Izaberite to:** Ponekad Ä‡e **platforma pipeline-a imati konfigurisanih nekoliko maÅ¡ina** i ako moÅ¾ete **modifikovati CI konfiguracionu datoteku**, moÅ¾ete **naznaÄiti gde Å¾elite da izvrÅ¡ite zlonamerni kod**. U ovoj situaciji, napadaÄ Ä‡e verovatno pokrenuti reverznu ljusku na svakoj moguÄ‡oj maÅ¡ini da pokuÅ¡a da je dalje eksploatiÅ¡e.
* **Kompromitovanje produkcije**: Ako ste unutar pipeline-a i konaÄna verzija se gradi i implementira iz njega, mogli biste **kompromitovati kod koji Ä‡e zavrÅ¡iti u produkciji**.

## ViÅ¡e relevantnih informacija

### Alati & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) je alat otvorenog koda za reviziju vaÅ¡eg softverskog lanca snabdevanja za usklaÄ‘enost sa bezbednoÅ¡Ä‡u zasnovan na novom [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Revizija se fokusira na ceo SDLC proces, gde moÅ¾e otkriti rizike od vremena koda do vremena implementacije.

### Top 10 CI/CD Bezbednosnih Rizika

Proverite ovaj zanimljiv Älanak o top 10 CI/CD rizicima prema Cider-u: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratorije

* Na svakoj platformi koju moÅ¾ete pokrenuti lokalno naÄ‡i Ä‡ete kako da je pokrenete lokalno tako da je moÅ¾ete konfigurisati kako Å¾elite da je testirate
* Gitea + Jenkins laboratorija: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatski Alati

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** je alat za statiÄku analizu koda za infrastrukturu kao kod.

## Reference

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
