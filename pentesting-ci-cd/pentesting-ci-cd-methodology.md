# Metodolog칤a de Pentesting CI/CD

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS significa **Sistema de Control de Versiones**, estos sistemas permiten a los desarrolladores **gestionar su c칩digo fuente**. El m치s com칰n es **git** y generalmente encontrar치s empresas us치ndolo en una de las siguientes **plataformas**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Proveedores de nube (ofrecen sus propias plataformas VCS)

## Pipelines

Los pipelines permiten a los desarrolladores **automatizar la ejecuci칩n de c칩digo** (para construir, probar, desplegar... prop칩sitos) despu칠s de que ocurren ciertas acciones: Un push, un PR, cron... Son muy 칰tiles para **automatizar todos los pasos desde el desarrollo hasta la producci칩n**.

Sin embargo, estos sistemas necesitan ser **ejecutados en alg칰n lugar** y generalmente con **credenciales privilegiadas para desplegar c칩digo**.

## Metodolog칤a de Pentesting VCS

{% hint style="info" %}
Incluso si algunas plataformas VCS permiten crear pipelines, en esta secci칩n solo vamos a analizar los posibles ataques al control del c칩digo fuente.
{% endhint %}

Las plataformas que contienen el c칩digo fuente de tu proyecto contienen informaci칩n sensible y las personas deben tener mucho cuidado con los permisos otorgados dentro de esta plataforma. Estos son algunos problemas comunes en las plataformas VCS que un atacante podr칤a abusar:

* **Filtraciones**: Si tu c칩digo contiene filtraciones en los commits y el atacante puede acceder al repo (porque es p칰blico o porque tiene acceso), podr칤a descubrir las filtraciones.
* **Acceso**: Si un atacante puede **acceder a una cuenta dentro de la plataforma VCS**, podr칤a obtener **m치s visibilidad y permisos**.
* **Registro**: Algunas plataformas solo permitir치n a los usuarios externos crear una cuenta.
* **SSO**: Algunas plataformas no permitir치n a los usuarios registrarse, pero permitir치n a cualquiera acceder con un SSO v치lido (por lo que un atacante podr칤a usar su cuenta de github para entrar, por ejemplo).
* **Credenciales**: Nombre de usuario + Contrase침a, tokens personales, claves ssh, tokens Oauth, cookies... hay varios tipos de tokens que un usuario podr칤a robar para acceder de alguna manera a un repo.
* **Webhooks**: Las plataformas VCS permiten generar webhooks. Si no est치n **protegidos** con secretos no visibles, un **atacante podr칤a abusar de ellos**.
* Si no hay secreto en su lugar, el atacante podr칤a abusar del webhook de la plataforma de terceros.
* Si el secreto est치 en la URL, lo mismo sucede y el atacante tambi칠n tiene el secreto.
* **Compromiso de c칩digo:** Si un actor malicioso tiene alg칰n tipo de acceso **de escritura** sobre los repos, podr칤a intentar **inyectar c칩digo malicioso**. Para tener 칠xito, podr칤a necesitar **eludir las protecciones de rama**. Estas acciones pueden realizarse con diferentes objetivos en mente:
* Comprometer la rama principal para **comprometer la producci칩n**.
* Comprometer la principal (u otras ramas) para **comprometer las m치quinas de los desarrolladores** (ya que generalmente ejecutan pruebas, terraform u otras cosas dentro del repo en sus m치quinas).
* **Comprometer el pipeline** (ver la siguiente secci칩n).

## Metodolog칤a de Pentesting de Pipelines

La forma m치s com칰n de definir un pipeline es mediante un **archivo de configuraci칩n CI alojado en el repositorio** que construye el pipeline. Este archivo describe el orden de los trabajos ejecutados, las condiciones que afectan el flujo y la configuraci칩n del entorno de construcci칩n.\
Estos archivos suelen tener un nombre y formato consistentes, por ejemplo: Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) y los archivos YAML de GitHub Actions ubicados en .github/workflows. Cuando se activa, el trabajo del pipeline **extrae el c칩digo** de la fuente seleccionada (por ejemplo, commit / rama) y **ejecuta los comandos especificados en el archivo de configuraci칩n CI** contra ese c칩digo.

Por lo tanto, el objetivo final del atacante es de alguna manera **comprometer esos archivos de configuraci칩n** o los **comandos que ejecutan**.

### PPE - Ejecuci칩n de Pipeline Envenenado

El camino de Ejecuci칩n de Pipeline Envenenado (PPE) explota permisos en un repositorio SCM para manipular un pipeline CI y ejecutar comandos da침inos. Los usuarios con los permisos necesarios pueden modificar archivos de configuraci칩n CI u otros archivos utilizados por el trabajo del pipeline para incluir comandos maliciosos. Esto "envenena" el pipeline CI, llevando a la ejecuci칩n de estos comandos maliciosos.

Para que un actor malicioso tenga 칠xito realizando un ataque PPE, necesita poder:

* Tener **acceso de escritura a la plataforma VCS**, ya que generalmente los pipelines se activan cuando se realiza un push o una solicitud de extracci칩n. (Consulta la metodolog칤a de pentesting VCS para un resumen de formas de obtener acceso).
* Ten en cuenta que a veces un **PR externo cuenta como "acceso de escritura"**.
* Incluso si tiene permisos de escritura, necesita asegurarse de que puede **modificar el archivo de configuraci칩n CI u otros archivos de los que depende la configuraci칩n**.
* Para esto, podr칤a necesitar poder **eludir las protecciones de rama**.

Hay 3 sabores de PPE:

* **D-PPE**: Un ataque **Directo PPE** ocurre cuando el actor **modifica el archivo de configuraci칩n CI** que se va a ejecutar.
* **I-DDE**: Un ataque **Indirecto PPE** ocurre cuando el actor **modifica** un **archivo** del que el archivo de configuraci칩n CI que se va a ejecutar **depende** (como un archivo make o una configuraci칩n de terraform).
* **PPE P칰blico o 3PE**: En algunos casos, los pipelines pueden ser **activados por usuarios que no tienen acceso de escritura en el repo** (y que pueden no ser parte de la organizaci칩n) porque pueden enviar un PR.
* **Inyecci칩n de Comandos 3PE**: Generalmente, los pipelines CI/CD **configurar치n variables de entorno** con **informaci칩n sobre el PR**. Si ese valor puede ser controlado por un atacante (como el t칤tulo del PR) y se **usa** en un **lugar peligroso** (como ejecutar **comandos sh**), un atacante podr칤a **inyectar comandos all칤**.

### Beneficios de la Explotaci칩n

Conociendo los 3 sabores para envenenar un pipeline, veamos qu칠 podr칤a obtener un atacante despu칠s de una explotaci칩n exitosa:

* **Secretos**: Como se mencion칩 anteriormente, los pipelines requieren **privilegios** para sus trabajos (recuperar el c칩digo, construirlo, desplegarlo...) y estos privilegios generalmente se **otorgan en secretos**. Estos secretos suelen ser accesibles a trav칠s de **variables de entorno o archivos dentro del sistema**. Por lo tanto, un atacante siempre intentar치 exfiltrar tantos secretos como sea posible.
* Dependiendo de la plataforma del pipeline, el atacante **podr칤a necesitar especificar los secretos en la configuraci칩n**. Esto significa que si el atacante no puede modificar el pipeline de configuraci칩n CI (**I-PPE** por ejemplo), podr칤a **solo exfiltrar los secretos que tiene ese pipeline**.
* **C칩mputo**: El c칩digo se ejecuta en alg칰n lugar, dependiendo de d칩nde se ejecute, un atacante podr칤a ser capaz de pivotar m치s.
* **On-Premises**: Si los pipelines se ejecutan en las instalaciones, un atacante podr칤a terminar en una **red interna con acceso a m치s recursos**.
* **Nube**: El atacante podr칤a acceder a **otras m치quinas en la nube** pero tambi칠n podr칤a **exfiltrar** tokens de cuentas de servicio/roles IAM **de ella para obtener** **m치s acceso dentro de la nube**.
* **M치quina de plataformas**: A veces, los trabajos se ejecutar치n dentro de las **m치quinas de la plataforma de pipelines**, que generalmente est치n dentro de una nube con **sin m치s acceso**.
* **Seleccionarlo:** A veces, la **plataforma de pipelines tendr치 configuradas varias m치quinas** y si puedes **modificar el archivo de configuraci칩n CI** puedes **indicar d칩nde quieres ejecutar el c칩digo malicioso**. En esta situaci칩n, un atacante probablemente ejecutar치 un shell inverso en cada m치quina posible para intentar explotarla m치s.
* **Comprometer producci칩n**: Si est치s dentro del pipeline y la versi칩n final se construye y despliega desde 칠l, podr칤as **comprometer el c칩digo que va a terminar ejecut치ndose en producci칩n**.

## M치s informaci칩n relevante

### Herramientas y Benchmark CIS

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) es una herramienta de c칩digo abierto para auditar tu pila de cadena de suministro de software para cumplimiento de seguridad basado en un nuevo [**benchmark de Seguridad de Cadena de Suministro de Software CIS**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). La auditor칤a se centra en todo el proceso SDLC, donde puede revelar riesgos desde el tiempo de c칩digo hasta el tiempo de despliegue.

### Top 10 Riesgos de Seguridad CI/CD

Consulta este interesante art칤culo sobre los 10 principales riesgos de CI/CD seg칰n Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratorios

* En cada plataforma que puedes ejecutar localmente encontrar치s c칩mo lanzarlo localmente para que puedas configurarlo como desees para probarlo.
* Laboratorio Gitea + Jenkins: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Herramientas Autom치ticas

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** es una herramienta de an치lisis de c칩digo est치tico para infraestructura como c칩digo.

## Referencias

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
