# Pentesting CI/CD Methodologie

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS steht f√ºr **Versionskontrollsystem**, dieses System erm√∂glicht Entwicklern, ihren **Quellcode zu verwalten**. Das gebr√§uchlichste ist **git** und du wirst normalerweise Unternehmen finden, die es auf einer der folgenden **Plattformen** verwenden:

* Github
* Gitlab
* Bitbucket
* Gitea
* Cloud-Anbieter (sie bieten ihre eigenen VCS-Plattformen an)

## CI/CD-Pipelines

CI/CD-Pipelines erm√∂glichen es Entwicklern, die **Ausf√ºhrung von Code** f√ºr verschiedene Zwecke zu **automatisieren**, einschlie√ülich des Erstellens, Testens und Bereitstellens von Anwendungen. Diese automatisierten Workflows werden durch **spezifische Aktionen** ausgel√∂st, wie z.B. Code-Pushes, Pull-Requests oder geplante Aufgaben. Sie sind n√ºtzlich, um den Prozess von der Entwicklung bis zur Produktion zu optimieren.

Diese Systeme m√ºssen jedoch **irgendwo ausgef√ºhrt werden** und normalerweise mit **privilegierten Anmeldeinformationen, um Code bereitzustellen oder auf sensible Informationen zuzugreifen**.

## VCS Pentesting Methodologie

{% hint style="info" %}
Auch wenn einige VCS-Plattformen das Erstellen von Pipelines erlauben, werden wir in diesem Abschnitt nur potenzielle Angriffe auf die Kontrolle des Quellcodes analysieren.
{% endhint %}

Plattformen, die den Quellcode deines Projekts enthalten, enthalten sensible Informationen und die Menschen m√ºssen sehr vorsichtig mit den innerhalb dieser Plattform gew√§hrten Berechtigungen sein. Dies sind einige h√§ufige Probleme auf VCS-Plattformen, die Angreifer ausnutzen k√∂nnten:

* **Leaks**: Wenn dein Code Leaks in den Commits enth√§lt und der Angreifer auf das Repo zugreifen kann (weil es √∂ffentlich ist oder weil er Zugang hat), k√∂nnte er die Leaks entdecken.
* **Zugriff**: Wenn ein Angreifer **auf ein Konto innerhalb der VCS-Plattform zugreifen kann**, k√∂nnte er **mehr Sichtbarkeit und Berechtigungen** erlangen.
* **Registrierung**: Einige Plattformen erlauben externen Benutzern nur, ein Konto zu erstellen.
* **SSO**: Einige Plattformen erlauben es Benutzern nicht, sich zu registrieren, erlauben jedoch jedem, mit einem g√ºltigen SSO zuzugreifen (ein Angreifer k√∂nnte beispielsweise sein GitHub-Konto verwenden, um einzutreten).
* **Anmeldeinformationen**: Benutzername+Pwd, pers√∂nliche Tokens, SSH-Schl√ºssel, Oauth-Tokens, Cookies... es gibt verschiedene Arten von Tokens, die ein Benutzer stehlen k√∂nnte, um auf irgendeine Weise auf ein Repo zuzugreifen.
* **Webhooks**: VCS-Plattformen erlauben das Generieren von Webhooks. Wenn sie **nicht gesch√ºtzt** sind mit nicht sichtbaren Geheimnissen, k√∂nnte ein **Angreifer sie ausnutzen**.
* Wenn kein Geheimnis vorhanden ist, k√∂nnte der Angreifer den Webhook der Drittanbieterplattform ausnutzen.
* Wenn das Geheimnis in der URL ist, passiert dasselbe und der Angreifer hat auch das Geheimnis.
* **Code-Kompromittierung:** Wenn ein b√∂swilliger Akteur eine Art von **Schreibzugriff** auf die Repos hat, k√∂nnte er versuchen, **b√∂sartigen Code einzuschleusen**. Um erfolgreich zu sein, muss er m√∂glicherweise **Branch-Schutzma√ünahmen umgehen**. Diese Aktionen k√∂nnen mit unterschiedlichen Zielen durchgef√ºhrt werden:
* Den Hauptbranch kompromittieren, um **die Produktion zu gef√§hrden**.
* Den Hauptbranch (oder andere Branches) kompromittieren, um **Entwicklermaschinen zu gef√§hrden** (da sie normalerweise Tests, Terraform oder andere Dinge auf ihren Maschinen im Repo ausf√ºhren).
* **Die Pipeline kompromittieren** (siehe n√§chsten Abschnitt).

## Pipelines Pentesting Methodologie

Der gebr√§uchlichste Weg, eine Pipeline zu definieren, besteht darin, eine **CI-Konfigurationsdatei, die im Repository gehostet wird**, zu verwenden, das die Pipeline erstellt. Diese Datei beschreibt die Reihenfolge der ausgef√ºhrten Jobs, Bedingungen, die den Ablauf beeinflussen, und Einstellungen der Build-Umgebung.\
Diese Dateien haben typischerweise einen konsistenten Namen und ein konsistentes Format, zum Beispiel ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) und die GitHub Actions YAML-Dateien, die sich unter .github/workflows befinden. Wenn sie ausgel√∂st werden, **zieht der Pipeline-Job den Code** aus der ausgew√§hlten Quelle (z.B. Commit / Branch) und **f√ºhrt die im CI-Konfigurationsdatei angegebenen Befehle** gegen diesen Code aus.

Daher ist das ultimative Ziel des Angreifers, irgendwie **diese Konfigurationsdateien** oder die **Befehle, die sie ausf√ºhren**, zu **kompromittieren**.

### PPE - Vergiftete Pipeline-Ausf√ºhrung

Der Vergiftete Pipeline-Ausf√ºhrungs (PPE) Pfad nutzt Berechtigungen in einem SCM-Repository aus, um eine CI-Pipeline zu manipulieren und sch√§dliche Befehle auszuf√ºhren. Benutzer mit den erforderlichen Berechtigungen k√∂nnen CI-Konfigurationsdateien oder andere Dateien, die vom Pipeline-Job verwendet werden, √§ndern, um b√∂sartige Befehle einzuschlie√üen. Dies "vergiftet" die CI-Pipeline und f√ºhrt zur Ausf√ºhrung dieser b√∂sartigen Befehle.

Damit ein b√∂swilliger Akteur erfolgreich einen PPE-Angriff durchf√ºhren kann, muss er in der Lage sein:

* **Schreibzugriff auf die VCS-Plattform zu haben**, da Pipelines normalerweise ausgel√∂st werden, wenn ein Push oder ein Pull-Request durchgef√ºhrt wird. (√úberpr√ºfe die VCS-Pentesting-Methodologie f√ºr eine Zusammenfassung der M√∂glichkeiten, Zugriff zu erhalten).
* Beachte, dass manchmal ein **externer PR als "Schreibzugriff" z√§hlt**.
* Selbst wenn er Schreibberechtigungen hat, muss er sicherstellen, dass er die **CI-Konfigurationsdatei oder andere Dateien, auf die die Konfiguration angewiesen ist, √§ndern kann**.
* Dazu muss er m√∂glicherweise in der Lage sein, **Branch-Schutzma√ünahmen zu umgehen**.

Es gibt 3 PPE-Varianten:

* **D-PPE**: Ein **Direkter PPE**-Angriff tritt auf, wenn der Akteur die **CI-Konfigurationsdatei** √§ndert, die ausgef√ºhrt werden soll.
* **I-DDE**: Ein **Indirekter PPE**-Angriff tritt auf, wenn der Akteur eine **Datei** √§ndert, auf die die CI-Konfigurationsdatei, die ausgef√ºhrt werden soll, **angewiesen ist** (wie eine Make-Datei oder eine Terraform-Konfiguration).
* **√ñffentlicher PPE oder 3PE**: In einigen F√§llen k√∂nnen die Pipelines von Benutzern **ausgel√∂st werden, die keinen Schreibzugriff im Repo haben** (und die m√∂glicherweise nicht einmal Teil der Organisation sind), weil sie einen PR senden k√∂nnen.
* **3PE-Befehlsinjektion**: Normalerweise setzen CI/CD-Pipelines **Umgebungsvariablen** mit **Informationen √ºber den PR**. Wenn dieser Wert von einem Angreifer kontrolliert werden kann (wie der Titel des PR) und in einem **gef√§hrlichen Ort** (wie der Ausf√ºhrung von **sh-Befehlen**) **verwendet** wird, k√∂nnte ein Angreifer **Befehle dort injizieren**.

### Ausbeutungsnutzen

Wenn man die 3 Varianten kennt, um eine Pipeline zu vergiften, schauen wir uns an, was ein Angreifer nach einer erfolgreichen Ausbeutung erhalten k√∂nnte:

* **Geheimnisse**: Wie bereits erw√§hnt, erfordern Pipelines **Berechtigungen** f√ºr ihre Jobs (den Code abrufen, ihn erstellen, bereitstellen...) und diese Berechtigungen werden normalerweise in Geheimnissen **gew√§hrt**. Diese Geheimnisse sind normalerweise √ºber **Umgebungsvariablen oder Dateien im System** zug√§nglich. Daher wird ein Angreifer immer versuchen, so viele Geheimnisse wie m√∂glich zu exfiltrieren.
* Abh√§ngig von der Pipeline-Plattform muss der Angreifer m√∂glicherweise die Geheimnisse in der Konfiguration **angeben**. Das bedeutet, dass, wenn der Angreifer die CI-Konfigurationspipeline nicht √§ndern kann (**I-PPE** zum Beispiel), er **nur die Geheimnisse exfiltrieren k√∂nnte, die diese Pipeline hat**.
* **Berechnung**: Der Code wird irgendwo ausgef√ºhrt, abh√§ngig davon, wo er ausgef√ºhrt wird, k√∂nnte ein Angreifer in der Lage sein, weiter zu pivotieren.
* **Vor Ort**: Wenn die Pipelines vor Ort ausgef√ºhrt werden, k√∂nnte ein Angreifer in einem **internen Netzwerk mit Zugang zu mehr Ressourcen** enden.
* **Cloud**: Der Angreifer k√∂nnte auf **andere Maschinen in der Cloud** zugreifen, k√∂nnte aber auch **IAM-Rollen/Dienstkonten-Tokens** von dort **exfiltrieren**, um **weiteren Zugang innerhalb der Cloud** zu erhalten.
* **Plattformmaschine**: Manchmal werden die Jobs innerhalb der **Pipelines-Plattformmaschinen** ausgef√ºhrt, die sich normalerweise in einer Cloud mit **keinem weiteren Zugang** befinden.
* **W√§hle es aus:** Manchmal hat die **Pipelines-Plattform mehrere Maschinen konfiguriert**, und wenn du die **CI-Konfigurationsdatei √§ndern kannst**, kannst du **angeben, wo du den b√∂sartigen Code ausf√ºhren m√∂chtest**. In dieser Situation wird ein Angreifer wahrscheinlich auf jeder m√∂glichen Maschine eine Reverse-Shell ausf√ºhren, um zu versuchen, sie weiter auszunutzen.
* **Produktion kompromittieren**: Wenn du innerhalb der Pipeline bist und die endg√ºltige Version von dort erstellt und bereitgestellt wird, k√∂nntest du **den Code kompromittieren, der letztendlich in der Produktion ausgef√ºhrt wird**.

## Weitere relevante Informationen

### Tools & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) ist ein Open-Source-Tool zur √úberpr√ºfung deines Software-Lieferketten-Stacks auf Sicherheitskonformit√§t basierend auf einem neuen [**CIS Software Supply Chain Benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Die √úberpr√ºfung konzentriert sich auf den gesamten SDLC-Prozess, wo sie Risiken von der Codezeit bis zur Bereitstellungszeit aufdecken kann.

### Top 10 CI/CD Sicherheitsrisiken

√úberpr√ºfe diesen interessanten Artikel √ºber die Top 10 CI/CD-Risiken laut Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

* Auf jeder Plattform, die du lokal ausf√ºhren kannst, findest du, wie du sie lokal starten kannst, damit du sie nach deinen W√ºnschen konfigurieren kannst, um sie zu testen.
* Gitea + Jenkins Lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatische Tools

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** ist ein statisches Code-Analyse-Tool f√ºr Infrastruktur-als-Code.

## Referenzen

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
