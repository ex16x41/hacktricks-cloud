# Pentesting CI/CD Methodology

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS σημαίνει **Σύστημα Ελέγχου Έκδοσης**, αυτό το σύστημα επιτρέπει στους προγραμματιστές να **διαχειρίζονται τον πηγαίο κώδικα** τους. Το πιο κοινό είναι το **git** και συνήθως θα βρείτε εταιρείες να το χρησιμοποιούν σε μία από τις παρακάτω **πλατφόρμες**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Παρόχους Cloud (προσφέρουν τις δικές τους πλατφόρμες VCS)

## Pipelines

Οι Pipelines επιτρέπουν στους προγραμματιστές να **αυτοματοποιούν την εκτέλεση του κώδικα** (για σκοπούς κατασκευής, δοκιμής, ανάπτυξης...) μετά από ορισμένες ενέργειες: Ένα push, ένα PR, cron... Είναι πολύ χρήσιμες για να **αυτοματοποιήσουν όλα τα βήματα από την ανάπτυξη στην παραγωγή**.

Ωστόσο, αυτά τα συστήματα χρειάζονται να **εκτελούνται κάπου** και συνήθως με **προνομιακά διαπιστευτήρια για την ανάπτυξη κώδικα**.

## VCS Pentesting Methodology

{% hint style="info" %}
Ακόμα και αν ορισμένες πλατφόρμες VCS επιτρέπουν τη δημιουργία pipelines, σε αυτή την ενότητα θα αναλύσουμε μόνο τις πιθανές επιθέσεις στον έλεγχο του πηγαίου κώδικα.
{% endhint %}

Οι πλατφόρμες που περιέχουν τον πηγαίο κώδικα του έργου σας περιέχουν ευαίσθητες πληροφορίες και οι άνθρωποι πρέπει να είναι πολύ προσεκτικοί με τις άδειες που χορηγούνται μέσα σε αυτή την πλατφόρμα. Αυτά είναι μερικά κοινά προβλήματα σε πλατφόρμες VCS που θα μπορούσε να εκμεταλλευτεί ένας επιτιθέμενος:

* **Leaks**: Αν ο κώδικάς σας περιέχει leaks στις commits και ο επιτιθέμενος μπορεί να έχει πρόσβαση στο repo (επειδή είναι δημόσιο ή επειδή έχει πρόσβαση), θα μπορούσε να ανακαλύψει τα leaks.
* **Πρόσβαση**: Αν ένας επιτιθέμενος μπορεί να **πρόσβαση σε έναν λογαριασμό μέσα στην πλατφόρμα VCS** θα μπορούσε να αποκτήσει **περισσότερη ορατότητα και άδειες**.
* **Εγγραφή**: Ορισμένες πλατφόρμες θα επιτρέψουν απλώς στους εξωτερικούς χρήστες να δημιουργήσουν έναν λογαριασμό.
* **SSO**: Ορισμένες πλατφόρμες δεν θα επιτρέψουν στους χρήστες να εγγραφούν, αλλά θα επιτρέψουν σε οποιονδήποτε να έχει πρόσβαση με έγκυρο SSO (έτσι ένας επιτιθέμενος θα μπορούσε να χρησιμοποιήσει τον λογαριασμό του github για να εισέλθει για παράδειγμα).
* **Διαπιστευτήρια**: Όνομα χρήστη + Κωδικός, προσωπικοί τόκεν, ssh κλειδιά, Oauth τόκεν, cookies... υπάρχουν διάφοροι τύποι τόκεν που θα μπορούσε να κλέψει ένας χρήστης για να αποκτήσει πρόσβαση με κάποιο τρόπο σε ένα repo.
* **Webhooks**: Οι πλατφόρμες VCS επιτρέπουν τη δημιουργία webhooks. Αν δεν είναι **προστατευμένα** με μη ορατά μυστικά, ένας **επιτιθέμενος θα μπορούσε να τα εκμεταλλευτεί**.
* Αν δεν υπάρχει μυστικό, ο επιτιθέμενος θα μπορούσε να εκμεταλλευτεί το webhook της τρίτης πλατφόρμας
* Αν το μυστικό είναι στη διεύθυνση URL, το ίδιο συμβαίνει και ο επιτιθέμενος έχει επίσης το μυστικό
* **Συμβιβασμός κώδικα:** Αν ένας κακόβουλος παράγοντας έχει κάποιο είδος **πρόσβασης εγγραφής** στους repos, θα μπορούσε να προσπαθήσει να **εισάγει κακόβουλο κώδικα**. Για να είναι επιτυχής, μπορεί να χρειαστεί να **παρακάμψει τις προστασίες κλάδου**. Αυτές οι ενέργειες μπορούν να εκτελούνται με διαφορετικούς στόχους στο μυαλό:
* Συμβιβασμός του κύριου κλάδου για να **συμβιβαστεί η παραγωγή**.
* Συμβιβασμός του κύριου (ή άλλων κλάδων) για να **συμβιβαστούν οι μηχανές των προγραμματιστών** (καθώς συνήθως εκτελούν δοκιμές, terraform ή άλλα πράγματα μέσα στο repo στις μηχανές τους).
* **Συμβιβασμός της pipeline** (ελέγξτε την επόμενη ενότητα)

## Pipelines Pentesting Methodology

Ο πιο κοινός τρόπος για να ορίσετε μια pipeline είναι χρησιμοποιώντας ένα **αρχείο διαμόρφωσης CI που φιλοξενείται στο αποθετήριο** που κατασκευάζει η pipeline. Αυτό το αρχείο περιγράφει τη σειρά εκτέλεσης των εργασιών, τις συνθήκες που επηρεάζουν τη ροή και τις ρυθμίσεις περιβάλλοντος κατασκευής.\
Αυτά τα αρχεία συνήθως έχουν ένα συνεπές όνομα και μορφή, για παράδειγμα — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), και τα YAML αρχεία GitHub Actions που βρίσκονται κάτω από .github/workflows. Όταν ενεργοποιηθεί, η εργασία της pipeline **τραβά τον κώδικα** από την επιλεγμένη πηγή (π.χ. commit / branch), και **εκτελεί τις εντολές που καθορίζονται στο αρχείο διαμόρφωσης CI** σε αυτόν τον κώδικα.

Επομένως, ο τελικός στόχος του επιτιθέμενου είναι με κάποιο τρόπο να **συμβιβάσει αυτά τα αρχεία διαμόρφωσης** ή τις **εντολές που εκτελούν**.

### PPE - Εκτέλεση Μολυσμένης Pipeline

Η διαδρομή Εκτέλεσης Μολυσμένης Pipeline (PPE) εκμεταλλεύεται τις άδειες σε ένα αποθετήριο SCM για να χειριστεί μια CI pipeline και να εκτελέσει επιβλαβείς εντολές. Οι χρήστες με τις απαραίτητες άδειες μπορούν να τροποποιήσουν τα αρχεία διαμόρφωσης CI ή άλλα αρχεία που χρησιμοποιούνται από την εργασία της pipeline για να συμπεριλάβουν κακόβουλες εντολές. Αυτό "μολύνει" την CI pipeline, οδηγώντας στην εκτέλεση αυτών των κακόβουλων εντολών.

Για να είναι επιτυχής ένας κακόβουλος παράγοντας στην εκτέλεση μιας επίθεσης PPE, πρέπει να είναι σε θέση να:

* Έχει **πρόσβαση εγγραφής στην πλατφόρμα VCS**, καθώς συνήθως οι pipelines ενεργοποιούνται όταν γίνεται ένα push ή ένα pull request. (Ελέγξτε τη μεθοδολογία pentesting VCS για μια σύνοψη τρόπων πρόσβασης).
* Σημειώστε ότι μερικές φορές μια **εξωτερική PR μετράει ως "πρόσβαση εγγραφής"**.
* Ακόμα και αν έχει άδειες εγγραφής, πρέπει να είναι σίγουρος ότι μπορεί να **τροποποιήσει το αρχείο διαμόρφωσης CI ή άλλα αρχεία που εξαρτάται η διαμόρφωση**.
* Για αυτό, μπορεί να χρειαστεί να είναι σε θέση να **παρακάμψει τις προστασίες κλάδου**.

Υπάρχουν 3 γεύσεις PPE:

* **D-PPE**: Μια **Άμεση επίθεση PPE** συμβαίνει όταν ο παράγοντας **τροποποιεί το αρχείο διαμόρφωσης CI** που πρόκειται να εκτελεστεί.
* **I-DDE**: Μια **Έμμεση επίθεση PPE** συμβαίνει όταν ο παράγοντας **τροποποιεί** ένα **αρχείο** που το αρχείο διαμόρφωσης CI που πρόκειται να εκτελεστεί **εξαρτάται από** (όπως ένα make file ή μια διαμόρφωση terraform).
* **Δημόσια PPE ή 3PE**: Σε ορισμένες περιπτώσεις, οι pipelines μπορούν να **ενεργοποιηθούν από χρήστες που δεν έχουν πρόσβαση εγγραφής στο repo** (και που μπορεί να μην είναι καν μέρος της οργάνωσης) επειδή μπορούν να στείλουν μια PR.
* **3PE Command Injection**: Συνήθως, οι CI/CD pipelines θα **ορίσουν μεταβλητές περιβάλλοντος** με **πληροφορίες σχετικά με την PR**. Αν αυτή η τιμή μπορεί να ελεγχθεί από έναν επιτιθέμενο (όπως ο τίτλος της PR) και **χρησιμοποιείται** σε μια **επικίνδυνη θέση** (όπως η εκτέλεση **sh εντολών**), ένας επιτιθέμενος μπορεί να **εισάγει εντολές εκεί**.

### Οφέλη Εκμετάλλευσης

Γνωρίζοντας τις 3 γεύσεις για να μολύνει μια pipeline, ας δούμε τι θα μπορούσε να αποκτήσει ένας επιτιθέμενος μετά από μια επιτυχημένη εκμετάλλευση:

* **Μυστικά**: Όπως αναφέρθηκε προηγουμένως, οι pipelines απαιτούν **προνόμια** για τις εργασίες τους (να ανακτούν τον κώδικα, να τον κατασκευάζουν, να τον αναπτύσσουν...) και αυτά τα προνόμια συνήθως **χορηγούνται σε μυστικά**. Αυτά τα μυστικά είναι συνήθως προσβάσιμα μέσω **μεταβλητών env ή αρχείων μέσα στο σύστημα**. Επομένως, ένας επιτιθέμενος θα προσπαθήσει πάντα να εξάγει όσο το δυνατόν περισσότερα μυστικά.
* Ανάλογα με την πλατφόρμα της pipeline, ο επιτιθέμενος **μπορεί να χρειαστεί να καθορίσει τα μυστικά στη διαμόρφωση**. Αυτό σημαίνει ότι αν ο επιτιθέμενος δεν μπορεί να τροποποιήσει την pipeline διαμόρφωσης CI (**I-PPE** για παράδειγμα), θα μπορούσε **μόνο να εξάγει τα μυστικά που έχει αυτή η pipeline**.
* **Υπολογισμός**: Ο κώδικας εκτελείται κάπου, ανάλογα με το πού εκτελείται, ένας επιτιθέμενος μπορεί να είναι σε θέση να προχωρήσει περαιτέρω.
* **On-Premises**: Αν οι pipelines εκτελούνται τοπικά, ένας επιτιθέμενος μπορεί να καταλήξει σε ένα **εσωτερικό δίκτυο με πρόσβαση σε περισσότερους πόρους**.
* **Cloud**: Ο επιτιθέμενος θα μπορούσε να έχει πρόσβαση σε **άλλες μηχανές στο cloud** αλλά θα μπορούσε επίσης να **εξάγει** IAM ρόλους/υπηρεσίες **tokens** από αυτό για να αποκτήσει **περαιτέρω πρόσβαση μέσα στο cloud**.
* **Μηχανές πλατφόρμας**: Μερικές φορές οι εργασίες θα εκτελούνται μέσα στις **μηχανές πλατφόρμας pipelines**, οι οποίες συνήθως βρίσκονται μέσα σε ένα cloud με **κανένα άλλο πρόσβαση**.
* **Επιλέξτε το:** Μερικές φορές η **πλατφόρμα pipelines θα έχει ρυθμίσει πολλές μηχανές** και αν μπορείτε να **τροποποιήσετε το αρχείο διαμόρφωσης CI** μπορείτε να **υποδείξετε πού θέλετε να εκτελέσετε τον κακόβουλο κώδικα**. Σε αυτή την περίπτωση, ένας επιτιθέμενος θα προσπαθήσει πιθανώς να εκτελέσει μια αντίστροφη σύνδεση σε κάθε δυνατή μηχανή για να προσπαθήσει να την εκμεταλλευτεί περαιτέρω.
* **Συμβιβασμός παραγωγής**: Αν είστε μέσα στην pipeline και η τελική έκδοση κατασκευάζεται και αναπτύσσεται από αυτήν, θα μπορούσατε να **συμβιβάσετε τον κώδικα που πρόκειται να τρέξει στην παραγωγή**.

## Περισσότερες σχετικές πληροφορίες

### Εργαλεία & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) είναι ένα εργαλείο ανοιχτού κώδικα για την επιθεώρηση της στοίβας προμήθειας λογισμικού σας για συμμόρφωση ασφαλείας με βάση ένα νέο [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Η επιθεώρηση εστιάζει σε ολόκληρη τη διαδικασία SDLC, όπου μπορεί να αποκαλύψει κινδύνους από τον χρόνο κώδικα έως τον χρόνο ανάπτυξης.

### Top 10 CI/CD Security Risk

Ελέγξτε αυτό το ενδιαφέρον άρθρο σχετικά με τους 10 κορυφαίους κινδύνους CI/CD σύμφωνα με το Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Εργαστήρια

* Σε κάθε πλατφόρμα που μπορείτε να εκτελέσετε τοπικά θα βρείτε πώς να την εκκινήσετε τοπικά ώστε να μπορείτε να την ρυθμίσετε όπως θέλετε για να τη δοκιμάσετε
* Gitea + Jenkins εργαστήριο: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Αυτόματα Εργαλεία

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** είναι ένα εργαλείο στατικής ανάλυσης κώδικα για υποδομή ως κώδικα.

## Αναφορές

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
