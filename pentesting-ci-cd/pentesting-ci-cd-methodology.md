# Pentesting CI/CD Methodology

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してハッキングトリックを共有してください。**

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCSは**バージョン管理システム**の略で、このシステムは開発者が**ソースコードを管理する**ことを可能にします。最も一般的なものは**git**で、企業は通常以下の**プラットフォーム**のいずれかで使用しています：

* Github
* Gitlab
* Bitbucket
* Gitea
* クラウドプロバイダー（独自のVCSプラットフォームを提供）

## CI/CDパイプライン

CI/CDパイプラインは、開発者が**コードの実行を自動化する**ことを可能にし、アプリケーションのビルド、テスト、デプロイなどのさまざまな目的に使用されます。これらの自動化されたワークフローは、コードのプッシュ、プルリクエスト、またはスケジュールされたタスクなどの**特定のアクションによってトリガーされます**。これにより、開発から本番環境へのプロセスが効率化されます。

ただし、これらのシステムは**どこかで実行される必要があり、通常はコードをデプロイしたり、機密情報にアクセスするための**特権資格情報**が必要です。**

## VCSペンテスティング方法論

{% hint style="info" %}
一部のVCSプラットフォームがこのセクションのためにパイプラインを作成することを許可している場合でも、ここではソースコードの制御に対する潜在的な攻撃のみを分析します。
{% endhint %}

プロジェクトのソースコードを含むプラットフォームは機密情報を含んでおり、人々はこのプラットフォーム内で付与された権限に非常に注意する必要があります。攻撃者が悪用できるVCSプラットフォーム全体での一般的な問題は以下の通りです：

* **漏洩**: コードにコミット内の漏洩が含まれており、攻撃者がリポジトリにアクセスできる場合（公開されているか、アクセス権を持っている場合）、漏洩を発見することができます。
* **アクセス**: 攻撃者が**VCSプラットフォーム内のアカウントにアクセスできる場合**、**より多くの可視性と権限を得ることができます**。
* **登録**: 一部のプラットフォームでは、外部ユーザーがアカウントを作成することを許可します。
* **SSO**: 一部のプラットフォームではユーザーの登録を許可しませんが、有効なSSOでアクセスすることは許可します（したがって、攻撃者は例えば自分のGitHubアカウントを使用して入ることができます）。
* **資格情報**: ユーザー名+パスワード、個人トークン、SSHキー、OAuthトークン、クッキー... ユーザーがリポジトリにアクセスするために盗むことができるトークンの種類はさまざまです。
* **Webhook**: VCSプラットフォームはWebhookを生成することを許可します。これらが**見えない秘密で保護されていない場合、**攻撃者がそれを悪用する可能性があります**。
* 秘密が設定されていない場合、攻撃者はサードパーティプラットフォームのWebhookを悪用することができます。
* 秘密がURLに含まれている場合、同様のことが起こり、攻撃者も秘密を持つことになります。
* **コードの妥協:** 悪意のある行為者がリポジトリに対して何らかの**書き込み**アクセスを持っている場合、悪意のあるコードを**注入しようとすることができます**。成功するためには、**ブランチ保護を回避する**必要があるかもしれません。これらの行動は、さまざまな目的を持って実行される可能性があります：
* メインブランチを妥協して**本番環境を妥協する**。
* メイン（または他のブランチ）を妥協して**開発者のマシンを妥協する**（通常、彼らは自分のマシンでテスト、Terraform、または他のことを実行します）。
* **パイプラインを妥協する**（次のセクションを確認）。

## パイプラインペンテスティング方法論

パイプラインを定義する最も一般的な方法は、パイプラインがビルドするリポジトリにホストされた**CI構成ファイル**を使用することです。このファイルは、実行されるジョブの順序、フローに影響を与える条件、およびビルド環境の設定を説明します。\
これらのファイルは通常、一貫した名前と形式を持ち、例えば—Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）、および.github/workflowsの下にあるGitHub Actions YAMLファイルです。トリガーされると、パイプラインジョブは**選択されたソースからコードをプルし**（例：コミット/ブランチ）、**CI構成ファイルに指定されたコマンドをそのコードに対して実行します**。

したがって、攻撃者の最終的な目標は、何らかの方法で**これらの構成ファイル**または**それらが実行するコマンドを妥協する**ことです。

### PPE - 毒されたパイプラインの実行

毒されたパイプラインの実行（PPE）パスは、SCMリポジトリ内の権限を悪用してCIパイプラインを操作し、有害なコマンドを実行します。必要な権限を持つユーザーは、CI構成ファイルやパイプラインジョブで使用される他のファイルを変更して悪意のあるコマンドを含めることができます。これにより、CIパイプラインが「毒され」、これらの悪意のあるコマンドが実行されます。

悪意のある行為者がPPE攻撃を成功させるためには、以下のことができる必要があります：

* **VCSプラットフォームへの書き込みアクセスを持つこと**。通常、パイプラインはプッシュまたはプルリクエストが行われたときにトリガーされます。（アクセスを取得する方法の概要についてはVCSペンテスティング方法論を確認してください）。
* 時には**外部PRが「書き込みアクセス」としてカウントされる**ことに注意してください。
* 書き込み権限があっても、**CI構成ファイルや構成が依存している他のファイルを変更できることを確認する必要があります**。
* これには、**ブランチ保護を回避する**必要があるかもしれません。

PPEには3つのフレーバーがあります：

* **D-PPE**: **直接PPE**攻撃は、行為者が**実行されるCI構成**ファイルを**変更する**ときに発生します。
* **I-DDE**: **間接PPE**攻撃は、行為者が**実行されるCI構成ファイルが依存している**ファイル（MakefileやTerraform構成など）を**変更する**ときに発生します。
* **パブリックPPEまたは3PE**: 場合によっては、パイプラインは**リポジトリに書き込みアクセスを持たないユーザーによってトリガーされることがあります**（そしてそれらは組織の一部でないかもしれません）なぜなら、彼らはPRを送信できるからです。
* **3PEコマンドインジェクション**: 通常、CI/CDパイプラインは**PRに関する情報を持つ環境変数を設定します**。その値が攻撃者によって制御でき（PRのタイトルのように）、**危険な場所で使用される**場合（例えば**shコマンドを実行する**）、攻撃者は**そこにコマンドを注入する**可能性があります。

### 悪用の利点

パイプラインを毒するための3つのフレーバーを知ったので、攻撃者が成功した悪用の後に何を得ることができるかを確認しましょう：

* **秘密**: 前述のように、パイプラインはそのジョブに**特権**を必要とします（コードを取得し、ビルドし、デプロイする...）そしてこれらの特権は通常**秘密に付与されます**。これらの秘密は通常、**環境変数やシステム内のファイルを介してアクセス可能です**。したがって、攻撃者は常にできるだけ多くの秘密を流出させようとします。
* パイプラインプラットフォームによっては、攻撃者が**構成内で秘密を指定する必要があるかもしれません**。これは、攻撃者がCI構成パイプラインを変更できない場合（例えば**I-PPE**）、彼が**そのパイプラインが持つ秘密のみを流出させることができることを意味します**。
* **計算**: コードはどこかで実行され、実行される場所によっては、攻撃者がさらにピボットできるかもしれません。
* **オンプレミス**: パイプラインがオンプレミスで実行される場合、攻撃者は**より多くのリソースにアクセスできる内部ネットワークに到達する可能性があります**。
* **クラウド**: 攻撃者は**クラウド内の他のマシンにアクセスすることができますが、IAMロール/サービスアカウントの**トークンを流出させて**クラウド内でさらにアクセスを得ることもできます**。
* **プラットフォームマシン**: 時には、ジョブは**パイプラインプラットフォームマシン内で実行されます**。これらは通常、**他のアクセスがないクラウド内にあります**。
* **選択する:** 時には、**パイプラインプラットフォームが複数のマシンを構成している**ことがあり、CI構成ファイルを**変更できれば、悪意のあるコードを実行したい場所を指定できます**。この状況では、攻撃者はおそらく各可能なマシンでリバースシェルを実行してさらに悪用しようとします。
* **本番環境を妥協する**: パイプライン内にいて、最終バージョンがそこからビルドされてデプロイされる場合、**本番環境で実行されるコードを妥協することができます**。

## さらに関連する情報

### ツールとCISベンチマーク

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench)は、セキュリティコンプライアンスのためにソフトウェアサプライチェーンスタックを監査するオープンソースツールです。新しい[**CISソフトウェアサプライチェーンベンチマーク**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)に基づいています。監査は、コードのタイミングからデプロイのタイミングまでのリスクを明らかにするSDLCプロセス全体に焦点を当てています。

### トップ10 CI/CDセキュリティリスク

Ciderによるトップ10 CI/CDリスクに関する興味深い記事を確認してください：[**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### ラボ

* 各プラットフォームでローカルに実行できるものについては、ローカルで起動する方法が記載されているので、テストするために好きなように構成できます。
* Gitea + Jenkinsラボ: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### 自動ツール

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov**は、インフラストラクチャコードの静的コード分析ツールです。

## 参考文献

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422)

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してハッキングトリックを共有してください。**

</details>
{% endhint %}
