# Pentesting CI/CD Methodology

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS oznacza **System Kontroli Wersji**, ten system pozwala deweloperom na **zarzÄ…dzanie swoim kodem ÅºrÃ³dÅ‚owym**. Najbardziej powszechny to **git** i zazwyczaj znajdziesz firmy korzystajÄ…ce z niego na jednej z nastÄ™pujÄ…cych **platform**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Dostawcy chmurowi (oferujÄ… wÅ‚asne platformy VCS)

## Pipelines

Pipelines pozwalajÄ… deweloperom na **automatyzacjÄ™ wykonywania kodu** (do celÃ³w budowania, testowania, wdraÅ¼ania...) po wystÄ…pieniu okreÅ›lonych akcji: push, PR, cron... SÄ… bardzo przydatne do **automatyzacji wszystkich krokÃ³w od rozwoju do produkcji**.

Jednak te systemy muszÄ… byÄ‡ **wykonywane gdzieÅ›** i zazwyczaj z **uprawnieniami uprzywilejowanymi do wdraÅ¼ania kodu**.

## VCS Pentesting Methodology

{% hint style="info" %}
Nawet jeÅ›li niektÃ³re platformy VCS pozwalajÄ… na tworzenie pipelines, w tej sekcji bÄ™dziemy analizowaÄ‡ tylko potencjalne ataki na kontrolÄ™ kodu ÅºrÃ³dÅ‚owego.
{% endhint %}

Platformy, ktÃ³re zawierajÄ… kod ÅºrÃ³dÅ‚owy twojego projektu, zawierajÄ… wraÅ¼liwe informacje i ludzie muszÄ… byÄ‡ bardzo ostroÅ¼ni z uprawnieniami przyznawanymi w tej platformie. Oto niektÃ³re powszechne problemy w platformach VCS, ktÃ³re atakujÄ…cy mogÄ… wykorzystaÄ‡:

* **Wycieki**: JeÅ›li twÃ³j kod zawiera wycieki w commitach, a atakujÄ…cy ma dostÄ™p do repozytorium (poniewaÅ¼ jest publiczne lub ma dostÄ™p), moÅ¼e odkryÄ‡ te wycieki.
* **DostÄ™p**: JeÅ›li atakujÄ…cy moÅ¼e **uzyskaÄ‡ dostÄ™p do konta w platformie VCS**, moÅ¼e zyskaÄ‡ **wiÄ™cej widocznoÅ›ci i uprawnieÅ„**.
* **Rejestracja**: NiektÃ³re platformy pozwalajÄ… tylko zewnÄ™trznym uÅ¼ytkownikom na tworzenie konta.
* **SSO**: NiektÃ³re platformy nie pozwalajÄ… uÅ¼ytkownikom na rejestracjÄ™, ale pozwalajÄ… kaÅ¼demu na dostÄ™p z waÅ¼nym SSO (wiÄ™c atakujÄ…cy mÃ³gÅ‚by uÅ¼yÄ‡ swojego konta github, aby wejÅ›Ä‡ na przykÅ‚ad).
* **PoÅ›wiadczenia**: Nazwa uÅ¼ytkownika + hasÅ‚o, tokeny osobiste, klucze ssh, tokeny Oauth, ciasteczka... istnieje kilka rodzajÃ³w tokenÃ³w, ktÃ³re uÅ¼ytkownik mÃ³gÅ‚by ukraÅ›Ä‡, aby uzyskaÄ‡ dostÄ™p do repozytorium w jakiÅ› sposÃ³b.
* **Webhooks**: Platformy VCS pozwalajÄ… na generowanie webhookÃ³w. JeÅ›li nie sÄ… **chronione** niewidocznymi sekretami, **atakujÄ…cy moÅ¼e je wykorzystaÄ‡**.
* JeÅ›li nie ma sekretu, atakujÄ…cy moÅ¼e wykorzystaÄ‡ webhook z platformy trzeciej.
* JeÅ›li sekret jest w URL, dzieje siÄ™ to samo i atakujÄ…cy rÃ³wnieÅ¼ ma sekret.
* **Kompromentacja kodu:** JeÅ›li zÅ‚oÅ›liwy aktor ma jakiÅ› rodzaj **dostÄ™pu do zapisu** w repozytoriach, moÅ¼e sprÃ³bowaÄ‡ **wstrzyknÄ…Ä‡ zÅ‚oÅ›liwy kod**. Aby odnieÅ›Ä‡ sukces, moÅ¼e potrzebowaÄ‡ **obejÅ›Ä‡ zabezpieczenia gaÅ‚Ä™zi**. Te dziaÅ‚ania mogÄ… byÄ‡ wykonywane z rÃ³Å¼nymi celami na myÅ›li:
* Kompromitacja gÅ‚Ã³wnej gaÅ‚Ä™zi w celu **kompromitacji produkcji**.
* Kompromitacja gÅ‚Ã³wnej (lub innych gaÅ‚Ä™zi) w celu **kompromitacji maszyn deweloperÃ³w** (poniewaÅ¼ zazwyczaj wykonujÄ… testy, terraform lub inne rzeczy w repozytorium na swoich maszynach).
* **Kompromitacja pipeline** (sprawdÅº nastÄ™pnÄ… sekcjÄ™)

## Pipelines Pentesting Methodology

Najbardziej powszechny sposÃ³b definiowania pipeline, to uÅ¼ycie **pliku konfiguracyjnego CI hostowanego w repozytorium**, ktÃ³re pipeline buduje. Ten plik opisuje kolejnoÅ›Ä‡ wykonywanych zadaÅ„, warunki wpÅ‚ywajÄ…ce na przepÅ‚yw i ustawienia Å›rodowiska budowy.\
Te pliki zazwyczaj majÄ… spÃ³jnÄ… nazwÄ™ i format, na przykÅ‚ad â€” Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) oraz pliki YAML GitHub Actions znajdujÄ…ce siÄ™ w .github/workflows. Po wyzwoleniu, zadanie pipeline **pobiera kod** z wybranego ÅºrÃ³dÅ‚a (np. commit / gaÅ‚Ä…Åº) i **wykonuje polecenia okreÅ›lone w pliku konfiguracyjnym CI** na tym kodzie.

Dlatego ostatecznym celem atakujÄ…cego jest w jakiÅ› sposÃ³b **kompromitacja tych plikÃ³w konfiguracyjnych** lub **poleceÅ„, ktÃ³re wykonujÄ…**.

### PPE - Wykonanie Zatrutego Pipeline

ÅšcieÅ¼ka Wykonania Zatrutego Pipeline (PPE) wykorzystuje uprawnienia w repozytorium SCM do manipulacji pipeline CI i wykonywania szkodliwych poleceÅ„. UÅ¼ytkownicy z niezbÄ™dnymi uprawnieniami mogÄ… modyfikowaÄ‡ pliki konfiguracyjne CI lub inne pliki uÅ¼ywane przez zadanie pipeline, aby zawieraÅ‚y zÅ‚oÅ›liwe polecenia. To "zatruwa" pipeline CI, prowadzÄ…c do wykonania tych zÅ‚oÅ›liwych poleceÅ„.

Aby zÅ‚oÅ›liwy aktor odniÃ³sÅ‚ sukces w przeprowadzeniu ataku PPE, musi byÄ‡ w stanie:

* MieÄ‡ **dostÄ™p do zapisu w platformie VCS**, poniewaÅ¼ zazwyczaj pipeline sÄ… wyzwalane, gdy wykonany jest push lub pull request. (SprawdÅº metodologiÄ™ pentestingu VCS, aby uzyskaÄ‡ podsumowanie sposobÃ³w uzyskania dostÄ™pu).
* ZauwaÅ¼, Å¼e czasami **zewnÄ™trzny PR liczy siÄ™ jako "dostÄ™p do zapisu"**.
* Nawet jeÅ›li ma uprawnienia do zapisu, musi byÄ‡ pewny, Å¼e moÅ¼e **zmodyfikowaÄ‡ plik konfiguracyjny CI lub inne pliki, na ktÃ³rych opiera siÄ™ konfiguracja**.
* W tym celu moÅ¼e potrzebowaÄ‡ byÄ‡ w stanie **obejÅ›Ä‡ zabezpieczenia gaÅ‚Ä™zi**.

IstniejÄ… 3 smaki PPE:

* **D-PPE**: Atak **BezpoÅ›redni PPE** wystÄ™puje, gdy aktor **modyfikuje plik konfiguracyjny CI**, ktÃ³ry ma byÄ‡ wykonany.
* **I-DDE**: Atak **PoÅ›redni PPE** wystÄ™puje, gdy aktor **modyfikuje** **plik**, na ktÃ³rym opiera siÄ™ plik konfiguracyjny CI, ktÃ³ry ma byÄ‡ wykonany (jak plik make lub konfiguracja terraform).
* **Public PPE lub 3PE**: W niektÃ³rych przypadkach pipeline mogÄ… byÄ‡ **wyzwalane przez uÅ¼ytkownikÃ³w, ktÃ³rzy nie majÄ… dostÄ™pu do zapisu w repozytorium** (i ktÃ³rzy mogÄ… nawet nie byÄ‡ czÄ™Å›ciÄ… organizacji), poniewaÅ¼ mogÄ… wysÅ‚aÄ‡ PR.
* **3PE Wstrzykiwanie PoleceÅ„**: Zazwyczaj pipeline CI/CD **ustawiÄ… zmienne Å›rodowiskowe** z **informacjami o PR**. JeÅ›li ta wartoÅ›Ä‡ moÅ¼e byÄ‡ kontrolowana przez atakujÄ…cego (jak tytuÅ‚ PR) i jest **uÅ¼ywana** w **niebezpiecznym miejscu** (jak wykonywanie **poleceÅ„ sh**), atakujÄ…cy moÅ¼e **wstrzyknÄ…Ä‡ polecenia tam**.

### KorzyÅ›ci z Eksploatacji

ZnajÄ…c 3 smaki, aby zatruÄ‡ pipeline, sprawdÅºmy, co atakujÄ…cy mÃ³gÅ‚by uzyskaÄ‡ po udanej eksploatacji:

* **Sekrety**: Jak wspomniano wczeÅ›niej, pipeline wymagajÄ… **uprawnieÅ„** do swoich zadaÅ„ (pobieranie kodu, budowanie go, wdraÅ¼anie...) i te uprawnienia sÄ… zazwyczaj **przyznawane w sekretach**. Te sekrety sÄ… zazwyczaj dostÄ™pne za poÅ›rednictwem **zmiennych env lub plikÃ³w w systemie**. Dlatego atakujÄ…cy zawsze bÄ™dzie prÃ³bowaÅ‚ wyeksfiltrowaÄ‡ jak najwiÄ™cej sekretÃ³w.
* W zaleÅ¼noÅ›ci od platformy pipeline atakujÄ…cy **moÅ¼e potrzebowaÄ‡ okreÅ›liÄ‡ sekrety w konfiguracji**. Oznacza to, Å¼e jeÅ›li atakujÄ…cy nie moÅ¼e zmodyfikowaÄ‡ pliku konfiguracyjnego CI (**I-PPE** na przykÅ‚ad), moÅ¼e **tylko wyeksfiltrowaÄ‡ sekrety, ktÃ³re ten pipeline ma**.
* **Obliczenia**: Kod jest wykonywany gdzieÅ›, w zaleÅ¼noÅ›ci od tego, gdzie jest wykonywany, atakujÄ…cy moÅ¼e byÄ‡ w stanie dalej pivotowaÄ‡.
* **Na miejscu**: JeÅ›li pipeline sÄ… wykonywane na miejscu, atakujÄ…cy moÅ¼e skoÅ„czyÄ‡ w **wewnÄ™trznej sieci z dostÄ™pem do wiÄ™kszej iloÅ›ci zasobÃ³w**.
* **Chmura**: AtakujÄ…cy mÃ³gÅ‚by uzyskaÄ‡ dostÄ™p do **innych maszyn w chmurze**, ale takÅ¼e mÃ³gÅ‚by **wyeksfiltrowaÄ‡** tokeny **rÃ³l IAM/kont usÅ‚ug** z niej, aby uzyskaÄ‡ **dalszy dostÄ™p w chmurze**.
* **Maszyna platformy**: Czasami zadania bÄ™dÄ… wykonywane wewnÄ…trz **maszyn platformy pipeline**, ktÃ³re zazwyczaj znajdujÄ… siÄ™ w chmurze z **brakiem dalszego dostÄ™pu**.
* **Wybierz to:** Czasami **platforma pipeline bÄ™dzie miaÅ‚a skonfigurowane kilka maszyn** i jeÅ›li moÅ¼esz **zmodyfikowaÄ‡ plik konfiguracyjny CI**, moÅ¼esz **wskazaÄ‡, gdzie chcesz uruchomiÄ‡ zÅ‚oÅ›liwy kod**. W tej sytuacji atakujÄ…cy prawdopodobnie uruchomi powrotnÄ… powÅ‚okÄ™ na kaÅ¼dej moÅ¼liwej maszynie, aby sprÃ³bowaÄ‡ jÄ… dalej wykorzystaÄ‡.
* **Kompromitacja produkcji**: JeÅ›li jesteÅ› wewnÄ…trz pipeline i ostateczna wersja jest budowana i wdraÅ¼ana z niego, moÅ¼esz **kompromitowaÄ‡ kod, ktÃ³ry ma byÄ‡ uruchamiany w produkcji**.

## WiÄ™cej istotnych informacji

### NarzÄ™dzia & Benchmark CIS

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) to narzÄ™dzie open-source do audytowania twojego stosu Å‚aÅ„cucha dostaw oprogramowania pod kÄ…tem zgodnoÅ›ci z bezpieczeÅ„stwem, oparte na nowym [**benchmarku CIS Software Supply Chain**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Audyt koncentruje siÄ™ na caÅ‚ym procesie SDLC, gdzie moÅ¼e ujawniÄ‡ ryzyka od czasu kodowania do czasu wdroÅ¼enia.

### Top 10 ryzyk bezpieczeÅ„stwa CI/CD

SprawdÅº ten interesujÄ…cy artykuÅ‚ o 10 najwiÄ™kszych ryzykach CI/CD wedÅ‚ug Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratoria

* Na kaÅ¼dej platformie, ktÃ³rÄ… moÅ¼esz uruchomiÄ‡ lokalnie, znajdziesz, jak uruchomiÄ‡ jÄ… lokalnie, aby skonfigurowaÄ‡ jÄ… wedÅ‚ug wÅ‚asnych potrzeb do testowania.
* Laboratorium Gitea + Jenkins: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### NarzÄ™dzia automatyczne

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** to narzÄ™dzie do analizy statycznej kodu dla infrastruktury jako kodu.

## Referencje

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
