# Pentesting CI/CD Metodologie

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS staan vir **Version Control System**, hierdie stelsels laat ontwikkelaars toe om **hulle bronkode te bestuur**. Die mees algemene een is **git** en jy sal gewoonlik maatskappye vind wat dit gebruik in een van die volgende **platforms**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Wolkverskaffers (hulle bied hul eie VCS-platforms aan)

## Pype

Pype laat ontwikkelaars toe om die **uitvoering van kode te outomatiseer** (vir bou, toets, ontplooi... doeleindes) nadat sekere aksies plaasvind: 'n push, 'n PR, cron... Hulle is baie nuttig om **alle stappe van ontwikkeling tot produksie te outomatiseer**.

Egter, hierdie stelsels moet **ergens uitgevoer word** en gewoonlik met **bevoorregte akrediteer om kode te ontplooi**.

## VCS Pentesting Metodologie

{% hint style="info" %}
Alhoewel sommige VCS-platforms toelaat om pype te skep, gaan ons in hierdie afdeling slegs potensi√´le aanvalle op die beheer van die bronkode analiseer.
{% endhint %}

Platforms wat die bronkode van jou projek bevat, bevat sensitiewe inligting en mense moet baie versigtig wees met die toestemmings wat binne hierdie platform toegestaan word. Dit is 'n paar algemene probleme oor VCS-platforms wat 'n aanvaller kan misbruik:

* **Lekke**: As jou kode lekke in die verbintenisse bevat en die aanvaller toegang tot die repo kan kry (omdat dit publiek is of omdat hy toegang het), kan hy die lekke ontdek.
* **Toegang**: As 'n aanvaller **toegang tot 'n rekening binne die VCS-platform** kan kry, kan hy **meer sigbaarheid en toestemmings** verkry.
* **Registrasie**: Sommige platforms sal net eksterne gebruikers toelaat om 'n rekening te skep.
* **SSO**: Sommige platforms sal nie gebruikers toelaat om te registreer nie, maar sal enigeen toelaat om toegang te verkry met 'n geldige SSO (so 'n aanvaller kan sy github-rekening gebruik om in te gaan byvoorbeeld).
* **Akrediteer**: Gebruikersnaam+Pwd, persoonlike tokens, ssh sleutels, Oauth tokens, koekies... daar is verskeie tipes tokens wat 'n gebruiker kan steel om op een of ander manier toegang tot 'n repo te verkry.
* **Webhooks**: VCS-platforms laat toe om webhooks te genereer. As hulle **nie beskerm** is met nie-sigtbare geheime nie, kan 'n **aanvaller dit misbruik**.
* As daar geen geheim is nie, kan die aanvaller die webhook van die derdeparty-platform misbruik.
* As die geheim in die URL is, gebeur dieselfde en die aanvaller het ook die geheim.
* **Kode kompromie:** As 'n kwaadwillige akteur 'n soort **skryf** toegang oor die repos het, kan hy probeer om **kwaadwillige kode in te spuit**. Om suksesvol te wees, mag hy moet **tak beskermings omseil**. Hierdie aksies kan met verskillende doelwitte in gedagte uitgevoer word:
* Kompromitteer die hooftak om **produksie te kompromitteer**.
* Kompromitteer die hoof (of ander takke) om **ontwikkelaars se masjiene te kompromitteer** (aangesien hulle gewoonlik toets, terraform of ander dinge binne die repo op hul masjiene uitvoer).
* **Kompromitteer die pyplyn** (kyk na die volgende afdeling)

## Pype Pentesting Metodologie

Die mees algemene manier om 'n pyplyn te definieer, is deur 'n **CI-konfigurasie l√™er wat in die repo gehospt is** wat die pyplyn bou. Hierdie l√™er beskryf die volgorde van uitgevoerde werksgeleenthede, toestande wat die vloei be√Ønvloed, en bouomgewinginstellings.\
Hierdie l√™ers het tipies 'n konsekwente naam en formaat, byvoorbeeld ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), en die GitHub Actions YAML-l√™ers wat onder .github/workflows gele√´ is. Wanneer geaktiveer, **trek die pyplyn werksgeleentheid die kode** van die geselekteerde bron (bv. verbintenis / tak), en **voer die opdragte wat in die CI-konfigurasie l√™er gespesifiseer is** teen daardie kode uit.

Daarom is die uiteindelike doel van die aanvaller om op een of ander manier **daardie konfigurasie l√™ers** of die **opdragte wat hulle uitvoer** te **kompromitteer**.

### PPE - Gevulde Pyplyn Uitvoering

Die Gevulde Pyplyn Uitvoering (PPE) pad benut toestemmings in 'n SCM-repo om 'n CI-pyplyn te manipuleer en skadelike opdragte uit te voer. Gebruikers met die nodige toestemmings kan CI-konfigurasie l√™ers of ander l√™ers wat deur die pyplyn werksgeleentheid gebruik word, wysig om kwaadwillige opdragte in te sluit. Dit "vergiftig" die CI-pyplyn, wat lei tot die uitvoering van hierdie kwaadwillige opdragte.

Vir 'n kwaadwillige akteur om suksesvol 'n PPE-aanval uit te voer, moet hy in staat wees om:

* **Skryf toegang tot die VCS-platform** te h√™, aangesien pype gewoonlik geaktiveer word wanneer 'n push of 'n pull aanvraag uitgevoer word. (Kyk na die VCS pentesting metodologie vir 'n opsomming van maniere om toegang te verkry).
* Let daarop dat soms 'n **eksterne PR as "skryf toegang" tel**.
* Selfs al het hy skryf toestemmings, moet hy seker wees dat hy die **CI konfigurasie l√™er of ander l√™ers waarop die konfigurasie staatmaak** kan **wysig**.
* Hiervoor mag hy moet in staat wees om **tak beskermings om te seil**.

Daar is 3 PPE geure:

* **D-PPE**: 'n **Direkte PPE** aanval vind plaas wanneer die akteur die **CI konfigurasie** l√™er wat gaan uitgevoer word, **wysig**.
* **I-DDE**: 'n **Indirekte PPE** aanval vind plaas wanneer die akteur 'n **l√™er** wat die CI konfigurasie l√™er waarop dit gaan uitgevoer word, **wysig** (soos 'n make-l√™er of 'n terraform konfigurasie).
* **Publieke PPE of 3PE**: In sommige gevalle kan die pype **geaktiveer word deur gebruikers wat nie skryf toegang in die repo het nie** (en wat dalk nie eens deel van die org is nie) omdat hulle 'n PR kan stuur.
* **3PE Opdrag Inspuiting**: Gewoonlik sal CI/CD pype **omgewing veranderlikes** met **inligting oor die PR** stel. As daardie waarde deur 'n aanvaller beheer kan word (soos die titel van die PR) en **gebruik** word in 'n **gevaarlike plek** (soos die uitvoering van **sh opdragte**), kan 'n aanvaller **opdragte daar in spuit**.

### Exploitatie Voordele

Om die 3 geure te ken om 'n pyplyn te vergiftig, laat ons kyk wat 'n aanvaller na 'n suksesvolle eksploitatie kan verkry:

* **Geheime**: Soos voorheen genoem, vereis pype **bevoorregte** vir hul werksgeleenthede (om die kode te verkry, dit te bou, dit te ontplooi...) en hierdie bevoorregte word gewoonlik **in geheime toegestaan**. Hierdie geheime is gewoonlik toeganklik via **omgewing veranderlikes of l√™ers binne die stelsel**. Daarom sal 'n aanvaller altyd probeer om soveel geheime as moontlik te eksfiltreer.
* Afhangende van die pyplyn platform mag die aanvaller **die geheime in die konfigurasie moet spesifiseer**. Dit beteken dat as die aanvaller nie die CI konfigurasie pyplyn kan wysig nie (**I-PPE** byvoorbeeld), kan hy **slegs die geheime wat daardie pyplyn het, eksfiltreer**.
* **Berekening**: Die kode word iewers uitgevoer, afhangende van waar dit uitgevoer word, mag 'n aanvaller in staat wees om verder te pivot.
* **On-premises**: As die pype op die perseel uitgevoer word, mag 'n aanvaller eindig in 'n **interne netwerk met toegang tot meer hulpbronne**.
* **Wolk**: Die aanvaller kan toegang verkry tot **ander masjiene in die wolk** maar kan ook **eksfiltreer** IAM rolle/dienste rekeninge **tokens** daarvan om **verder toegang binne die wolk** te verkry.
* **Platforms masjien**: Soms sal die werksgeleenthede binne die **pype platform masjiene** uitgevoer word, wat gewoonlik binne 'n wolk met **geen verdere toegang** is.
* **Kies dit:** Soms sal die **pype platform verskeie masjiene geconfigureer h√™** en as jy die **CI konfigurasie l√™er kan wysig**, kan jy **aan dui waar jy die kwaadwillige kode wil uitvoer**. In hierdie situasie sal 'n aanvaller waarskynlik 'n omgekeerde skulp op elke moontlike masjien uitvoer om te probeer om dit verder te exploiteer.
* **Kompromitteer produksie**: As jy binne die pyplyn is en die finale weergawe daaruit gebou en ontplooi word, kan jy **die kode wat in produksie gaan eindig, kompromitteer**.

## Meer relevante inligting

### Gereedskap & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) is 'n oopbron gereedskap vir die oudit van jou sagteware voorsieningsketting stap vir sekuriteits nakoming gebaseer op 'n nuwe [**CIS Sagteware Voorsieningsketting benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Die oudit fokus op die hele SDLC-proses, waar dit risiko's van kode tyd in ontplooi tyd kan onthul.

### Top 10 CI/CD Sekuriteitsrisiko

Kyk na hierdie interessante artikel oor die top 10 CI/CD risiko's volgens Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratoriums

* Op elke platform wat jy lokaal kan uitvoer, sal jy vind hoe om dit lokaal te begin sodat jy dit kan konfigureer soos jy wil om dit te toets.
* Gitea + Jenkins laboratorium: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Outomatiese Gereedskap

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** is 'n statiese kode analise gereedskap vir infrastruktuur-as-kode.

## Verwysings

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
