# Pentesting CI/CD Methodolojisi

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS, **Versiyon Kontrol Sistemi** anlamına gelir, bu sistemler geliştiricilerin **kaynak kodlarını yönetmelerine** olanak tanır. En yaygın olanı **git**'tir ve genellikle şirketlerin aşağıdaki **platformlardan** birinde kullandığını göreceksiniz:

* Github
* Gitlab
* Bitbucket
* Gitea
* Bulut sağlayıcıları (kendi VCS platformlarını sunarlar)

## Pipeline'lar

Pipeline'lar, geliştiricilerin belirli eylemler gerçekleştiğinde (bir push, bir PR, cron...) kodun **çalıştırılmasını otomatikleştirmelerine** olanak tanır: Bu, geliştirmeden üretime kadar tüm adımları otomatikleştirmek için son derece faydalıdır.

Ancak, bu sistemlerin **bir yerde çalıştırılması** gerekir ve genellikle **kod dağıtmak için ayrıcalıklı kimlik bilgileri** ile çalıştırılır.

## VCS Pentesting Metodolojisi

{% hint style="info" %}
Bazı VCS platformları bu bölüm için pipeline oluşturulmasına izin verse de, yalnızca kaynak kodunun kontrolüne yönelik potansiyel saldırıları analiz edeceğiz.
{% endhint %}

Projenizin kaynak kodunu içeren platformlar hassas bilgiler içerir ve insanlar bu platformda verilen izinlerle çok dikkatli olmalıdır. Saldırganların istismar edebileceği bazı yaygın sorunlar şunlardır:

* **Sızıntılar**: Kodunuzda commitlerde sızıntılar varsa ve saldırgan repo'ya erişebiliyorsa (çünkü kamuya açıktır veya erişimi vardır), sızıntıları keşfedebilir.
* **Erişim**: Eğer bir saldırgan **VCS platformunda bir hesaba erişebiliyorsa**, **daha fazla görünürlük ve izin** kazanabilir.
* **Kayıt**: Bazı platformlar yalnızca dış kullanıcıların hesap oluşturmasına izin verir.
* **SSO**: Bazı platformlar kullanıcıların kayıt olmasına izin vermez, ancak geçerli bir SSO ile erişim sağlar (bu nedenle bir saldırgan örneğin github hesabını kullanarak girebilir).
* **Kimlik Bilgileri**: Kullanıcı adı+Şifre, kişisel tokenlar, ssh anahtarları, Oauth tokenları, çerezler... bir kullanıcının bir repo'ya erişmek için çalabileceği çeşitli token türleri vardır.
* **Webhook'lar**: VCS platformları webhook'lar oluşturulmasına izin verir. Eğer **görünmeyen gizli anahtarlarla korunmuyorlarsa**, bir **saldırgan bunları istismar edebilir**.
* Eğer gizli bir anahtar yoksa, saldırgan üçüncü taraf platformun webhook'unu istismar edebilir.
* Eğer gizli anahtar URL'de ise, aynı şey olur ve saldırgan da gizli anahtara sahip olur.
* **Kodun tehlikeye atılması:** Eğer kötü niyetli bir aktör repo'lar üzerinde bir tür **yazma** erişimine sahipse, **kötü niyetli kod enjekte etmeye** çalışabilir. Başarılı olmak için **dal korumalarını aşması** gerekebilir. Bu eylemler farklı hedeflerle gerçekleştirilebilir:
* Ana dalı tehlikeye atmak, **üretimi tehlikeye atmak**.
* Ana dalı (veya diğer dalları) tehlikeye atmak, **geliştirici makinelerini tehlikeye atmak** (çünkü genellikle test, terraform veya diğer şeyleri makinelerinde repo içinde çalıştırırlar).
* **Pipeline'ı tehlikeye atmak** (bir sonraki bölüme bakın)

## Pipeline'lar Pentesting Metodolojisi

Bir pipeline'ı tanımlamanın en yaygın yolu, pipeline'ın inşa edildiği **repo'da barındırılan bir CI yapılandırma dosyası** kullanmaktır. Bu dosya, yürütülen işlerin sırasını, akışı etkileyen koşulları ve yapı ortamı ayarlarını tanımlar.\
Bu dosyalar genellikle tutarlı bir isim ve formata sahiptir, örneğin — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) ve .github/workflows altında bulunan GitHub Actions YAML dosyaları. Tetiklendiğinde, pipeline işi **seçilen kaynaktan kodu çeker** (örneğin commit / dal) ve **CI yapılandırma dosyasında belirtilen komutları** o kod üzerinde çalıştırır.

Bu nedenle, saldırganın nihai hedefi, bir şekilde **bu yapılandırma dosyalarını** veya **çalıştırdıkları komutları tehlikeye atmaktır**.

### PPE - Zehirli Pipeline Yürütmesi

Zehirli Pipeline Yürütmesi (PPE) yolu, bir SCM deposundaki izinleri istismar ederek bir CI pipeline'ını manipüle eder ve zararlı komutlar çalıştırır. Gerekli izinlere sahip kullanıcılar, CI yapılandırma dosyalarını veya pipeline işi tarafından kullanılan diğer dosyaları kötü niyetli komutlar eklemek için değiştirebilir. Bu, CI pipeline'ını "zehirler" ve bu kötü niyetli komutların yürütülmesine yol açar.

Kötü niyetli bir aktörün PPE saldırısını başarılı bir şekilde gerçekleştirebilmesi için:

* **VCS platformuna yazma erişimine sahip olması** gerekir, çünkü genellikle pipeline'lar bir push veya pull request gerçekleştirildiğinde tetiklenir. (Erişim elde etme yollarının özeti için VCS pentesting metodolojisine bakın).
* Bazen bir **dış PR'nın "yazma erişimi" olarak sayıldığını** unutmayın.
* Yazma izinlerine sahip olsa bile, **CI yapılandırma dosyasını veya yapılandırmanın dayandığı diğer dosyaları değiştirebileceğinden emin olması** gerekir.
* Bunun için **dal korumalarını aşabilmesi** gerekebilir.

Üç PPE çeşidi vardır:

* **D-PPE**: **Doğrudan PPE** saldırısı, aktörün **yürütülecek CI yapılandırma** dosyasını değiştirdiği durumdur.
* **I-DDE**: **Dolaylı PPE** saldırısı, aktörün **yürütülecek CI yapılandırma dosyasının** dayandığı bir **dosyayı** değiştirdiği durumdur (örneğin bir make dosyası veya terraform yapılandırması).
* **Halka Açık PPE veya 3PE**: Bazı durumlarda, pipeline'lar **repo'da yazma erişimi olmayan kullanıcılar tarafından tetiklenebilir** (ve bu kullanıcılar belki de organizasyonun bir parçası bile olmayabilir) çünkü PR gönderebilirler.
* **3PE Komut Enjeksiyonu**: Genellikle, CI/CD pipeline'ları **PR hakkında bilgi içeren ortam değişkenleri** ayarlayacaktır. Eğer bu değer bir saldırgan tarafından kontrol edilebiliyorsa (örneğin PR'nın başlığı gibi) ve **tehlikeli bir yerde** (örneğin **sh komutları** çalıştırmak gibi) kullanılıyorsa, bir saldırgan **orada komut enjekte edebilir**.

### İstismar Faydaları

Bir pipeline'ı zehirlemenin üç çeşidini bilmek, başarılı bir istismar sonrasında bir saldırganın elde edebileceği şeyleri kontrol etmemizi sağlar:

* **Gizli Bilgiler**: Daha önce belirtildiği gibi, pipeline'lar işlerini yürütmek için **ayrıcalıklara** ihtiyaç duyar (kodu almak, inşa etmek, dağıtmak...) ve bu ayrıcalıklar genellikle **gizli bilgilerle** verilir. Bu gizli bilgiler genellikle **ortam değişkenleri veya sistem içindeki dosyalar** aracılığıyla erişilebilir. Bu nedenle, bir saldırgan her zaman mümkün olduğunca çok gizli bilgi sızdırmaya çalışacaktır.
* Saldırgan, pipeline platformuna bağlı olarak **gizli bilgileri yapılandırmada belirtmek zorunda kalabilir**. Bu, eğer saldırgan CI yapılandırma pipeline'ını değiştiremiyorsa (**I-PPE** örneğin), yalnızca o pipeline'ın sahip olduğu gizli bilgileri sızdırabileceği anlamına gelir.
* **Hesaplama**: Kod bir yerde çalıştırılır, nerede çalıştırıldığına bağlı olarak bir saldırgan daha ileriye geçebilir.
* **Yerel**: Eğer pipeline'lar yerel olarak çalıştırılıyorsa, bir saldırgan **daha fazla kaynağa erişimi olan bir iç ağa** girebilir.
* **Bulut**: Saldırgan **buluttaki diğer makinelere** erişebilir ama aynı zamanda **IAM rolleri/hizmet hesapları** **tokenlarını** sızdırarak **bulut içinde daha fazla erişim** elde edebilir.
* **Platform makineleri**: Bazen işler **pipeline platform makineleri** içinde çalıştırılır, bu makineler genellikle **daha fazla erişim** olmadan bir bulut içindedir.
* **Seçin:** Bazen **pipeline platformu birkaç makineyi yapılandırmış olacaktır** ve eğer **CI yapılandırma dosyasını değiştirebilirseniz**, kötü niyetli kodu çalıştırmak istediğiniz yeri **belirtebilirsiniz**. Bu durumda, bir saldırgan muhtemelen her olası makinede bir ters shell çalıştırarak daha fazla istismar etmeye çalışacaktır.
* **Üretimi tehlikeye atmak**: Eğer pipeline içindeyseniz ve nihai versiyon buradan inşa edilip dağıtılıyorsa, **üretimde çalışacak kodu tehlikeye atabilirsiniz**.

## Daha Fazla İlgili Bilgi

### Araçlar & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench), yeni bir [**CIS Yazılım Tedarik Zinciri benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf) temelinde güvenlik uyumluluğu için yazılım tedarik zinciri yığınınızı denetlemek için açık kaynak bir araçtır. Denetim, kod zamanından dağıtım zamanına kadar riskleri ortaya çıkarabileceği tüm SDLC sürecine odaklanır.

### En İyi 10 CI/CD Güvenlik Riski

Cider'a göre en iyi 10 CI/CD riskine dair bu ilginç makaleyi kontrol edin: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratuvarlar

* Yerel olarak çalıştırabileceğiniz her platformda, test etmek için istediğiniz gibi yapılandırabileceğiniz şekilde yerel olarak nasıl başlatılacağını bulacaksınız.
* Gitea + Jenkins laboratuvarı: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Otomatik Araçlar

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov**, altyapı olarak kod için statik kod analizi aracıdır.

## Referanslar

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
