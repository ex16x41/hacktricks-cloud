# Pentesting CI/CD Methodology

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS significa **Sistema de Controle de Vers√£o**, esses sistemas permitem que os desenvolvedores **gerenciem seu c√≥digo-fonte**. O mais comum √© o **git** e voc√™ geralmente encontrar√° empresas usando-o em uma das seguintes **plataformas**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Provedores de nuvem (eles oferecem suas pr√≥prias plataformas VCS)

## Pipelines

Pipelines permitem que os desenvolvedores **automatizem a execu√ß√£o de c√≥digo** (para constru√ß√£o, teste, implanta√ß√£o... prop√≥sitos) ap√≥s certas a√ß√µes ocorrerem: Um push, um PR, cron... Eles s√£o extremamente √∫teis para **automatizar todas as etapas do desenvolvimento √† produ√ß√£o**.

No entanto, esses sistemas precisam ser **executados em algum lugar** e geralmente com **credenciais privilegiadas para implantar c√≥digo**.

## VCS Pentesting Methodology

{% hint style="info" %}
Mesmo que algumas plataformas VCS permitam criar pipelines, nesta se√ß√£o vamos analisar apenas ataques potenciais ao controle do c√≥digo-fonte.
{% endhint %}

Plataformas que cont√™m o c√≥digo-fonte do seu projeto cont√™m informa√ß√µes sens√≠veis e as pessoas precisam ter muito cuidado com as permiss√µes concedidas dentro dessa plataforma. Estes s√£o alguns problemas comuns em plataformas VCS que um atacante poderia explorar:

* **Leaks**: Se seu c√≥digo cont√©m leaks nos commits e o atacante pode acessar o reposit√≥rio (porque √© p√∫blico ou porque ele tem acesso), ele poderia descobrir os leaks.
* **Acesso**: Se um atacante pode **acessar uma conta dentro da plataforma VCS**, ele poderia ganhar **mais visibilidade e permiss√µes**.
* **Registro**: Algumas plataformas permitir√£o apenas que usu√°rios externos criem uma conta.
* **SSO**: Algumas plataformas n√£o permitir√£o que os usu√°rios se registrem, mas permitir√£o que qualquer um acesse com um SSO v√°lido (ent√£o um atacante poderia usar sua conta do github para entrar, por exemplo).
* **Credenciais**: Nome de usu√°rio + Senha, tokens pessoais, chaves ssh, tokens Oauth, cookies... existem v√°rios tipos de tokens que um usu√°rio poderia roubar para acessar de alguma forma um reposit√≥rio.
* **Webhooks**: Plataformas VCS permitem gerar webhooks. Se eles **n√£o estiverem protegidos** com segredos n√£o vis√≠veis, um **atacante poderia abusar deles**.
* Se nenhum segredo estiver em vigor, o atacante poderia abusar do webhook da plataforma de terceiros.
* Se o segredo estiver na URL, o mesmo acontece e o atacante tamb√©m ter√° o segredo.
* **Comprometimento de c√≥digo:** Se um ator malicioso tiver algum tipo de acesso **de escrita** sobre os reposit√≥rios, ele poderia tentar **injetar c√≥digo malicioso**. Para ter sucesso, ele pode precisar **contornar as prote√ß√µes de branch**. Essas a√ß√µes podem ser realizadas com diferentes objetivos em mente:
* Comprometer a branch principal para **comprometer a produ√ß√£o**.
* Comprometer a principal (ou outras branches) para **comprometer as m√°quinas dos desenvolvedores** (j√° que eles geralmente executam testes, terraform ou outras coisas dentro do reposit√≥rio em suas m√°quinas).
* **Comprometer o pipeline** (ver pr√≥xima se√ß√£o)

## Pipelines Pentesting Methodology

A maneira mais comum de definir um pipeline √© usando um **arquivo de configura√ß√£o CI hospedado no reposit√≥rio** que o pipeline constr√≥i. Este arquivo descreve a ordem dos trabalhos executados, condi√ß√µes que afetam o fluxo e configura√ß√µes do ambiente de constru√ß√£o.\
Esses arquivos geralmente t√™m um nome e formato consistentes, por exemplo ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) e os arquivos YAML do GitHub Actions localizados em .github/workflows. Quando acionado, o trabalho do pipeline **puxa o c√≥digo** da fonte selecionada (por exemplo, commit / branch) e **executa os comandos especificados no arquivo de configura√ß√£o CI** contra esse c√≥digo.

Portanto, o objetivo final do atacante √© de alguma forma **comprometer esses arquivos de configura√ß√£o** ou os **comandos que eles executam**.

### PPE - Execu√ß√£o de Pipeline Envenenado

O caminho de Execu√ß√£o de Pipeline Envenenado (PPE) explora permiss√µes em um reposit√≥rio SCM para manipular um pipeline CI e executar comandos prejudiciais. Usu√°rios com as permiss√µes necess√°rias podem modificar arquivos de configura√ß√£o CI ou outros arquivos usados pelo trabalho do pipeline para incluir comandos maliciosos. Isso "envenena" o pipeline CI, levando √† execu√ß√£o desses comandos maliciosos.

Para que um ator malicioso tenha sucesso ao realizar um ataque PPE, ele precisa ser capaz de:

* Ter **acesso de escrita √† plataforma VCS**, j√° que geralmente os pipelines s√£o acionados quando um push ou um pull request √© realizado. (Ver a metodologia de pentesting VCS para um resumo das maneiras de obter acesso).
* Note que √†s vezes um **PR externo conta como "acesso de escrita"**.
* Mesmo que ele tenha permiss√µes de escrita, ele precisa ter certeza de que pode **modificar o arquivo de configura√ß√£o CI ou outros arquivos dos quais a configura√ß√£o depende**.
* Para isso, ele pode precisar ser capaz de **contornar as prote√ß√µes de branch**.

Existem 3 sabores de PPE:

* **D-PPE**: Um ataque **Direto PPE** ocorre quando o ator **modifica o arquivo de configura√ß√£o CI** que ser√° executado.
* **I-DDE**: Um ataque **Indireto PPE** ocorre quando o ator **modifica** um **arquivo** do qual o arquivo de configura√ß√£o CI que ser√° executado **depende** (como um arquivo make ou uma configura√ß√£o terraform).
* **PPE P√∫blico ou 3PE**: Em alguns casos, os pipelines podem ser **acionados por usu√°rios que n√£o t√™m acesso de escrita no reposit√≥rio** (e que podem nem mesmo fazer parte da organiza√ß√£o) porque podem enviar um PR.
* **Inje√ß√£o de Comando 3PE**: Geralmente, pipelines CI/CD **definir√£o vari√°veis de ambiente** com **informa√ß√µes sobre o PR**. Se esse valor puder ser controlado por um atacante (como o t√≠tulo do PR) e for **usado** em um **lugar perigoso** (como executar **comandos sh**), um atacante pode **injetar comandos ali**.

### Benef√≠cios da Explora√ß√£o

Conhecendo os 3 sabores para envenenar um pipeline, vamos verificar o que um atacante poderia obter ap√≥s uma explora√ß√£o bem-sucedida:

* **Segredos**: Como mencionado anteriormente, os pipelines requerem **privil√©gios** para seus trabalhos (recuperar o c√≥digo, constru√≠-lo, implant√°-lo...) e esses privil√©gios geralmente s√£o **concedidos em segredos**. Esses segredos geralmente s√£o acess√≠veis via **vari√°veis de ambiente ou arquivos dentro do sistema**. Portanto, um atacante sempre tentar√° exfiltrar o m√°ximo de segredos poss√≠vel.
* Dependendo da plataforma do pipeline, o atacante **pode precisar especificar os segredos na configura√ß√£o**. Isso significa que se o atacante n√£o puder modificar o pipeline de configura√ß√£o CI (**I-PPE**, por exemplo), ele poderia **apenas exfiltrar os segredos que esse pipeline possui**.
* **Computa√ß√£o**: O c√≥digo √© executado em algum lugar, dependendo de onde √© executado, um atacante pode ser capaz de pivotar mais.
* **On-Premises**: Se os pipelines s√£o executados localmente, um atacante pode acabar em uma **rede interna com acesso a mais recursos**.
* **Nuvem**: O atacante poderia acessar **outras m√°quinas na nuvem**, mas tamb√©m poderia **exfiltrar** tokens de **contas de servi√ßo/roles IAM** para obter **mais acesso dentro da nuvem**.
* **M√°quina da plataforma**: √Äs vezes, os trabalhos ser√£o executados dentro das **m√°quinas da plataforma de pipelines**, que geralmente est√£o dentro de uma nuvem com **nenhum acesso adicional**.
* **Selecione-o:** √Äs vezes, a **plataforma de pipelines ter√° v√°rias m√°quinas configuradas** e se voc√™ puder **modificar o arquivo de configura√ß√£o CI**, poder√° **indicar onde deseja executar o c√≥digo malicioso**. Nessa situa√ß√£o, um atacante provavelmente executar√° um shell reverso em cada m√°quina poss√≠vel para tentar explor√°-la mais.
* **Comprometer a produ√ß√£o**: Se voc√™ estiver dentro do pipeline e a vers√£o final for constru√≠da e implantada a partir dele, voc√™ poderia **comprometer o c√≥digo que acabar√° sendo executado em produ√ß√£o**.

## Mais informa√ß√µes relevantes

### Ferramentas & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) √© uma ferramenta de c√≥digo aberto para auditar sua pilha de cadeia de suprimentos de software para conformidade de seguran√ßa com base em um novo [**benchmark de Seguran√ßa da Cadeia de Suprimentos de Software CIS**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). A auditoria foca em todo o processo SDLC, onde pode revelar riscos desde o tempo de c√≥digo at√© o tempo de implanta√ß√£o.

### Top 10 Riscos de Seguran√ßa CI/CD

Confira este artigo interessante sobre os 10 principais riscos de CI/CD de acordo com a Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

* Em cada plataforma que voc√™ pode executar localmente, voc√™ encontrar√° como lan√ß√°-la localmente para que possa configur√°-la como quiser para test√°-la.
* Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Ferramentas Autom√°ticas

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo.

## Refer√™ncias

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
