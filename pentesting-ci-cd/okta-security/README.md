# Okta-Sicherheit

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

[Okta, Inc.](https://www.okta.com/) ist im Bereich Identit√§ts- und Zugriffsmanagement f√ºr seine cloudbasierten Softwarel√∂sungen anerkannt. Diese L√∂sungen sind darauf ausgelegt, die Benutzerauthentifizierung √ºber verschiedene moderne Anwendungen zu optimieren und zu sichern. Sie richten sich nicht nur an Unternehmen, die ihre sensiblen Daten sch√ºtzen m√∂chten, sondern auch an Entwickler, die daran interessiert sind, Identit√§tskontrollen in Anwendungen, Webdiensten und Ger√§ten zu integrieren.

Das Flaggschiff-Angebot von Okta ist die **Okta Identity Cloud**. Diese Plattform umfasst eine Suite von Produkten, darunter, aber nicht beschr√§nkt auf:

* **Single Sign-On (SSO)**: Vereinfacht den Benutzerzugang, indem es eine Reihe von Anmeldeinformationen f√ºr mehrere Anwendungen erm√∂glicht.
* **Multi-Faktor-Authentifizierung (MFA)**: Erh√∂ht die Sicherheit, indem mehrere Verifizierungsformen erforderlich sind.
* **Lifecycle Management**: Automatisiert die Erstellung, Aktualisierung und Deaktivierung von Benutzerkonten.
* **Universal Directory**: Erm√∂glicht die zentrale Verwaltung von Benutzern, Gruppen und Ger√§ten.
* **API-Zugriffsmanagement**: Sichert und verwaltet den Zugriff auf APIs.

Diese Dienste zielen darauf ab, den Datenschutz zu st√§rken und den Benutzerzugang zu optimieren, wodurch sowohl Sicherheit als auch Benutzerfreundlichkeit verbessert werden. Die Vielseitigkeit von Okta's L√∂sungen macht sie zu einer beliebten Wahl in verschiedenen Branchen, die gro√üen Unternehmen, kleinen Firmen und einzelnen Entwicklern zugutekommt. Stand der letzten Aktualisierung im September 2021 wird Okta als bedeutendes Unternehmen im Bereich Identit√§ts- und Zugriffsmanagement (IAM) anerkannt.

{% hint style="danger" %}
Das Hauptziel von Okta ist es, den Zugriff auf verschiedene Benutzer und Gruppen auf externe Anwendungen zu konfigurieren. Wenn es Ihnen gelingt, **Administratorrechte in einer Okta-Umgebung zu kompromittieren**, werden Sie h√∂chstwahrscheinlich in der Lage sein, **alle anderen Plattformen, die das Unternehmen verwendet, zu kompromittieren**.
{% endhint %}

{% hint style="success" %}
Um eine Sicherheits√ºberpr√ºfung einer Okta-Umgebung durchzuf√ºhren, sollten Sie um **Administrator-Lesezugriff** bitten.
{% endhint %}

### Zusammenfassung

Es gibt **Benutzer** (die in **Okta gespeichert**, von konfigurierten **Identit√§tsanbietern** angemeldet oder √ºber **Active Directory** oder LDAP authentifiziert werden k√∂nnen).\
Diese Benutzer k√∂nnen in **Gruppen** sein.\
Es gibt auch **Authentifizierer**: verschiedene Optionen zur Authentifizierung wie Passwort und mehrere 2FA wie WebAuthn, E-Mail, Telefon, Okta Verify (sie k√∂nnten aktiviert oder deaktiviert sein)...

Dann gibt es **Anwendungen**, die mit Okta synchronisiert sind. Jede Anwendung hat eine **Zuordnung zu Okta**, um Informationen (wie E-Mail-Adressen, Vornamen...) auszutauschen. Dar√ºber hinaus muss jede Anwendung in einer **Authentifizierungsrichtlinie** enthalten sein, die die **ben√∂tigten Authentifizierer** angibt, damit ein Benutzer auf die Anwendung **zugreifen** kann.

{% hint style="danger" %}
Die m√§chtigste Rolle ist **Super Administrator**.

Wenn ein Angreifer Okta mit Administratorzugang kompromittiert, werden alle **Apps, die Okta vertrauen**, h√∂chstwahrscheinlich **kompromittiert**.
{% endhint %}

## Angriffe

### Lokalisierung des Okta-Portals

In der Regel befindet sich das Portal eines Unternehmens unter **companyname.okta.com**. Wenn nicht, versuchen Sie einfache **Variationen** von **companyname.** Wenn Sie es nicht finden k√∂nnen, ist es auch m√∂glich, dass die Organisation einen **CNAME**-Eintrag wie **`okta.companyname.com`** hat, der auf das **Okta-Portal** verweist.

### Anmeldung in Okta √ºber Kerberos

Wenn **`companyname.kerberos.okta.com`** aktiv ist, wird **Kerberos f√ºr den Okta-Zugriff verwendet**, was typischerweise die **MFA** f√ºr **Windows**-Benutzer umgeht. Um Kerberos-authentifizierte Okta-Benutzer in AD zu finden, f√ºhren Sie **`getST.py`** mit **angemessenen Parametern** aus. Nach Erhalt eines **AD-Benutzertickets** **injizieren** Sie es in einen kontrollierten Host mit Tools wie Rubeus oder Mimikatz und stellen sicher, dass **`clientname.kerberos.okta.com` in der Internetoptionen "Intranet"-Zone** ist. Der Zugriff auf eine bestimmte URL sollte eine JSON "OK"-Antwort zur√ºckgeben, die die Akzeptanz des Kerberos-Tickets anzeigt und den Zugriff auf das Okta-Dashboard gew√§hrt.

Die Kompromittierung des **Okta-Dienstkontos mit dem Delegations-SPN erm√∂glicht einen Silver Ticket-Angriff.** Allerdings erfordert Okta's Verwendung von **AES** zur Ticketverschl√ºsselung den Besitz des AES-Schl√ºssels oder des Klartextpassworts. Verwenden Sie **`ticketer.py`, um ein Ticket f√ºr den betroffenen Benutzer zu generieren** und es √ºber den Browser zu √ºbermitteln, um sich bei Okta zu authentifizieren.

**√úberpr√ºfen Sie den Angriff in** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking Okta AD-Agent

Diese Technik beinhaltet **den Zugriff auf den Okta AD-Agent auf einem Server**, der **Benutzer synchronisiert und die Authentifizierung verwaltet**. Durch die Untersuchung und Entschl√ºsselung von Konfigurationen in **`OktaAgentService.exe.config`**, insbesondere des AgentTokens mit **DPAPI**, kann ein Angreifer potenziell **Authentifizierungsdaten abfangen und manipulieren**. Dies erm√∂glicht nicht nur **√úberwachung** und **Erfassung von Benutzeranmeldeinformationen** im Klartext w√§hrend des Okta-Authentifizierungsprozesses, sondern auch **Reaktionen auf Authentifizierungsversuche**, wodurch unbefugter Zugriff erm√∂glicht oder eine universelle Authentifizierung √ºber Okta bereitgestellt wird (√§hnlich einem 'Skeleton Key').

**√úberpr√ºfen Sie den Angriff in** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking AD als Administrator

Diese Technik beinhaltet das Hijacking eines Okta AD-Agenten, indem zuerst ein OAuth-Code erlangt und dann ein API-Token angefordert wird. Das Token ist mit einer AD-Dom√§ne verkn√ºpft, und ein **Connector wird benannt, um einen gef√§lschten AD-Agenten zu erstellen**. Die Initialisierung erm√∂glicht es dem Agenten, **Authentifizierungsversuche zu verarbeiten**, wobei Anmeldeinformationen √ºber die Okta-API erfasst werden. Automatisierungstools sind verf√ºgbar, um diesen Prozess zu optimieren und eine nahtlose Methode zum Abfangen und Verarbeiten von Authentifizierungsdaten innerhalb der Okta-Umgebung anzubieten.

**√úberpr√ºfen Sie den Angriff in** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Fake SAML-Anbieter

**√úberpr√ºfen Sie den Angriff in** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Die Technik beinhaltet **die Bereitstellung eines gef√§lschten SAML-Anbieters**. Durch die Integration eines externen Identit√§tsanbieters (IdP) innerhalb des Okta-Rahmens mit einem privilegierten Konto k√∂nnen Angreifer **den IdP kontrollieren und jede Authentifizierungsanfrage nach Belieben genehmigen**. Der Prozess umfasst die Einrichtung eines SAML 2.0 IdP in Okta, die Manipulation der IdP Single Sign-On-URL zur Umleitung √ºber die lokale Hosts-Datei, die Erstellung eines selbstsignierten Zertifikats und die Konfiguration der Okta-Einstellungen, um mit dem Benutzernamen oder der E-Mail √ºbereinzustimmen. Das erfolgreiche Ausf√ºhren dieser Schritte erm√∂glicht die Authentifizierung als jeder Okta-Benutzer, wodurch die Notwendigkeit individueller Benutzeranmeldeinformationen umgangen wird, was die Zugriffskontrolle erheblich erh√∂ht und m√∂glicherweise unbemerkt bleibt.

### Phishing des Okta-Portals mit Evilgnix

In [**diesem Blogbeitrag**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) wird erkl√§rt, wie man eine Phishing-Kampagne gegen ein Okta-Portal vorbereitet.

### Kollege-Impersonation-Angriff

Die **Attribute, die jeder Benutzer haben und √§ndern kann** (wie E-Mail oder Vorname) k√∂nnen in Okta konfiguriert werden. Wenn eine **Anwendung** ein **Attribut**, das der Benutzer **√§ndern kann**, als ID **vertraut**, wird er in der Lage sein, **andere Benutzer auf dieser Plattform zu impersonieren**.

Daher, wenn die App das Feld **`userName`** vertraut, werden Sie es wahrscheinlich nicht √§ndern k√∂nnen (weil Sie dieses Feld normalerweise nicht √§ndern k√∂nnen), aber wenn es beispielsweise **`primaryEmail`** vertraut, k√∂nnten Sie in der Lage sein, es auf die E-Mail-Adresse eines Kollegen zu **√§ndern** und ihn zu impersonieren (Sie m√ºssen Zugriff auf die E-Mail haben und die √Ñnderung akzeptieren).

Beachten Sie, dass diese Impersonation davon abh√§ngt, wie jede Anwendung konfiguriert wurde. Nur die, die dem Feld, das Sie ge√§ndert haben, vertrauen und Aktualisierungen akzeptieren, werden kompromittiert.\
Daher sollte die App dieses Feld aktiviert haben, wenn es existiert:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Ich habe auch andere Apps gesehen, die anf√§llig waren, aber dieses Feld nicht in den Okta-Einstellungen hatten (am Ende sind verschiedene Apps unterschiedlich konfiguriert).

Der beste Weg herauszufinden, ob Sie jemanden in jeder App impersonieren k√∂nnten, w√§re, es auszuprobieren!

## Umgehung von Verhaltens√ºberwachungsrichtlinien <a href="#id-9fde" id="id-9fde"></a>

Verhaltens√ºberwachungsrichtlinien in Okta k√∂nnten unbekannt sein, bis sie aufgetreten sind, aber **die Umgehung** kann erreicht werden, indem **Okta-Anwendungen direkt angegriffen** werden, um das Haupt-Okta-Dashboard zu vermeiden. Mit einem **Okta-Zugriffstoken** wiederholen Sie das Token an der **anwendungsspezifischen Okta-URL** anstelle der Hauptanmeldeseite.

Wichtige Empfehlungen umfassen:

* **Vermeiden Sie die Verwendung** beliebter Anonymisierungsproxies und VPN-Dienste beim Wiederholen erfasster Zugriffstoken.
* Stellen Sie sicher, dass **konsistente Benutzer-Agent-Strings** zwischen dem Client und den wiederholten Zugriffstoken bestehen.
* **Vermeiden Sie das Wiederholen** von Tokens von verschiedenen Benutzern von derselben IP-Adresse.
* Seien Sie vorsichtig, wenn Sie Tokens gegen das Okta-Dashboard wiederholen.
* Wenn Sie die IP-Adressen des Opferunternehmens kennen, **beschr√§nken Sie den Verkehr** auf diese IPs oder deren Bereich und blockieren Sie allen anderen Verkehr.

## Okta-H√§rtung

Okta hat viele m√∂gliche Konfigurationen. Auf dieser Seite finden Sie, wie Sie sie √ºberpr√ºfen k√∂nnen, damit sie so sicher wie m√∂glich sind:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referenzen

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Lernen & √ºben Sie AWS-Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP-Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
