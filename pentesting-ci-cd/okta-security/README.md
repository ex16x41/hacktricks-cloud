# Okta Güvenliği

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Temel Bilgiler

[Okta, Inc.](https://www.okta.com/) kimlik ve erişim yönetimi sektöründe bulut tabanlı yazılım çözümleri ile tanınmaktadır. Bu çözümler, çeşitli modern uygulamalar arasında kullanıcı kimlik doğrulamasını kolaylaştırmak ve güvence altına almak için tasarlanmıştır. Hassas verilerini korumak isteyen şirketlere ve uygulamalara, web hizmetlerine ve cihazlara kimlik kontrolleri entegre etmekle ilgilenen geliştiricilere hitap etmektedir.

Okta'nın amiral gemisi ürünü **Okta Identity Cloud**'dır. Bu platform, aşağıdakiler de dahil olmak üzere bir dizi ürünü kapsamaktadır:

* **Tek Oturum Açma (SSO)**: Birden fazla uygulama için tek bir oturum açma kimlik bilgisi seti ile kullanıcı erişimini basitleştirir.
* **Çok Faktörlü Kimlik Doğrulama (MFA)**: Birden fazla doğrulama biçimi gerektirerek güvenliği artırır.
* **Yaşam Döngüsü Yönetimi**: Kullanıcı hesaplarının oluşturulması, güncellenmesi ve devre dışı bırakılması süreçlerini otomatikleştirir.
* **Evrensel Dizin**: Kullanıcıların, grupların ve cihazların merkezi yönetimini sağlar.
* **API Erişim Yönetimi**: API'lere erişimi güvence altına alır ve yönetir.

Bu hizmetler, veri korumasını güçlendirmeyi ve kullanıcı erişimini kolaylaştırmayı amaçlamaktadır, böylece hem güvenliği hem de rahatlığı artırmaktadır. Okta'nın çözümlerinin çok yönlülüğü, onları çeşitli endüstrilerde popüler bir seçim haline getirmekte, büyük işletmelere, küçük şirketlere ve bireysel geliştiricilere fayda sağlamaktadır. Eylül 2021'deki son güncelleme itibarıyla, Okta Kimlik ve Erişim Yönetimi (IAM) alanında önde gelen bir varlık olarak kabul edilmektedir.

{% hint style="danger" %}
Okta'nın ana hedefi, farklı kullanıcılar ve gruplar için dış uygulamalara erişimi yapılandırmaktır. Eğer bir **Okta** ortamında yönetici ayrıcalıklarını **ele geçirirseniz**, şirketin kullandığı diğer tüm platformları **ele geçirme** olasılığınız oldukça yüksektir.
{% endhint %}

{% hint style="success" %}
Bir Okta ortamının güvenlik incelemesini gerçekleştirmek için **yönetici yalnızca okuma erişimi** talep etmelisiniz.
{% endhint %}

### Özet

**Kullanıcılar** vardır (bunlar **Okta'da saklanabilir,** yapılandırılmış **Kimlik Sağlayıcılarından** oturum açabilir veya **Active Directory** veya LDAP aracılığıyla kimlik doğrulaması yapılabilir).\
Bu kullanıcılar **gruplar** içinde olabilir.\
Ayrıca **kimlik doğrulayıcılar** vardır: şifre gibi kimlik doğrulama için farklı seçenekler ve WebAuthn, e-posta, telefon, okta doğrulama gibi çeşitli 2FA (bunlar etkinleştirilebilir veya devre dışı bırakılabilir)...

Daha sonra, Okta ile senkronize edilmiş **uygulamalar** vardır. Her uygulama, bilgi paylaşmak için Okta ile bazı **eşleştirmelere** sahip olacaktır (örneğin e-posta adresleri, adlar...). Ayrıca, her uygulama bir **Kimlik Doğrulama Politikası** içinde olmalıdır; bu, bir kullanıcının uygulamaya **erişmesi** için gereken **kimlik doğrulayıcıları** belirtir.

{% hint style="danger" %}
En güçlü rol **Süper Yönetici**dir.

Eğer bir saldırgan Okta'yı Yönetici erişimi ile ele geçirirse, **Okta'ya güvenen tüm uygulamalar** büyük olasılıkla **ele geçirilmiş** olacaktır.
{% endhint %}

## Saldırılar

### Okta Portalını Bulma

Genellikle bir şirketin portalı **companyname.okta.com** adresinde bulunur. Eğer değilse, **companyname.** için basit **varyasyonlar** deneyin. Bulamazsanız, organizasyonun **Okta portalına** işaret eden **CNAME** kaydı olabileceği de mümkündür, örneğin **`okta.companyname.com`**.

### Kerberos ile Okta'ya Giriş

Eğer **`companyname.kerberos.okta.com`** aktifse, **Kerberos Okta erişimi için kullanılır**, genellikle **Windows** kullanıcıları için **MFA**'yı atlayarak. AD'de Kerberos ile kimlik doğrulaması yapılmış Okta kullanıcılarını bulmak için **`getST.py`** komutunu **uygun parametrelerle** çalıştırın. Bir **AD kullanıcı bileti** elde ettikten sonra, bunu kontrol edilen bir ana bilgisayara Rubeus veya Mimikatz gibi araçlar kullanarak **enjekte** edin, **`clientname.kerberos.okta.com`'un Internet Seçenekleri "İntranet" alanında** olduğundan emin olun. Belirli bir URL'ye erişmek, Kerberos biletinin kabul edildiğini gösteren bir JSON "OK" yanıtı döndürmeli ve Okta kontrol paneline erişim sağlamalıdır.

**Okta hizmet hesabını delegasyon SPN ile ele geçirmek, bir Silver Ticket saldırısını mümkün kılar.** Ancak, Okta'nın bilet şifrelemesi için **AES** kullanması, AES anahtarına veya düz metin şifresine sahip olmayı gerektirir. **`ticketer.py`** kullanarak kurban kullanıcı için bir bilet oluşturun ve bunu Okta ile kimlik doğrulamak için tarayıcı aracılığıyla iletin.

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta AD Ajanını Ele Geçirme

Bu teknik, **kullanıcıları senkronize eden ve kimlik doğrulamasını yöneten** bir sunucudaki Okta AD Ajanına **erişim sağlamayı** içerir. **`OktaAgentService.exe.config`** dosyasındaki yapılandırmaları inceleyerek ve şifrelerini çözerek, özellikle **DPAPI** kullanarak AgentToken'ı ele geçiren bir saldırgan, **kimlik doğrulama verilerini** potansiyel olarak **yakalamak ve manipüle etmek** için bu bilgileri kullanabilir. Bu, yalnızca Okta kimlik doğrulama sürecinde kullanıcı kimlik bilgilerini düz metin olarak **izleme** ve **yakalama** sağlamakla kalmaz, aynı zamanda kimlik doğrulama girişimlerine **yanıt verme** yeteneği de sağlar; böylece yetkisiz erişim sağlanabilir veya Okta aracılığıyla evrensel kimlik doğrulama sağlanabilir (bir 'skeleton key' gibi).

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Yönetici Olarak AD'yi Ele Geçirme

Bu teknik, önce bir OAuth Kodu elde ederek bir Okta AD Ajanını ele geçirmeyi içerir, ardından bir API token'ı talep edilir. Token, bir AD alanı ile ilişkilidir ve **sahte bir AD ajanı oluşturmak için bir bağlantı adı verilir**. Başlatma, ajanın **kimlik doğrulama girişimlerini işlemesine** olanak tanır ve Okta API'si aracılığıyla kimlik bilgilerini yakalar. Bu süreci kolaylaştırmak için otomasyon araçları mevcuttur ve Okta ortamında kimlik doğrulama verilerini yakalamak ve işlemek için sorunsuz bir yöntem sunar.

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Sahte SAML Sağlayıcısı

**Saldırıyı kontrol edin** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Bu teknik, **sahte bir SAML sağlayıcısı dağıtmayı** içerir. Okta'nın çerçevesine ayrı bir Kimlik Sağlayıcısı (IdP) entegre ederek, saldırganlar **IdP'yi kontrol edebilir ve istedikleri zaman herhangi bir kimlik doğrulama talebini onaylayabilir**. Süreç, Okta'da bir SAML 2.0 IdP kurmayı, yerel ana bilgisayar dosyası aracılığıyla yönlendirme için IdP Tek Oturum Açma URL'sini manipüle etmeyi, kendinden imzalı bir sertifika oluşturmayı ve Okta ayarlarını kullanıcı adı veya e-posta ile eşleşecek şekilde yapılandırmayı içerir. Bu adımları başarıyla uygulamak, herhangi bir Okta kullanıcısı olarak kimlik doğrulama sağlamaya olanak tanır; bu, bireysel kullanıcı kimlik bilgilerine ihtiyaç duymadan erişim kontrolünü önemli ölçüde artırır.

### Evilgnix ile Okta Portalını Phishing

[**bu blog yazısında**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) bir Okta portalına karşı bir phishing kampanyası hazırlamanın nasıl yapılacağı açıklanmaktadır.

### Meslektaş Taklit Saldırısı

Her kullanıcının sahip olabileceği ve değiştirebileceği **özellikler** (örneğin e-posta veya ad) Okta'da yapılandırılabilir. Eğer bir **uygulama**, kullanıcının **değiştirebileceği** bir **özelliği** ID olarak **güveniyorsa**, o platformda **diğer kullanıcıları taklit etme** yeteneğine sahip olacaktır.

Bu nedenle, uygulama **`userName`** alanına güveniyorsa, muhtemelen bunu değiştiremeyeceksiniz (çünkü genellikle bu alanı değiştiremezsiniz), ancak örneğin **`primaryEmail`** alanına güveniyorsa, bunu **bir meslektaşın e-posta adresine** değiştirme yeteneğine sahip olabilirsiniz ve onu taklit edebilirsiniz (e-postaya erişiminiz olmalı ve değişikliği kabul etmelisiniz).

Bu taklit etme, her uygulamanın nasıl yapılandırıldığına bağlıdır. Sadece değiştirdiğiniz alana güvenen ve güncellemeleri kabul edenler tehlikeye girecektir.\
Bu nedenle, uygulamanın bu alanı etkinleştirmiş olması gerekir, eğer varsa:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Ayrıca, o alana sahip olmayan ancak savunmasız olan diğer uygulamaları da gördüm (sonuçta farklı uygulamalar farklı şekilde yapılandırılmıştır).

Her uygulamada birini taklit edip edemeyeceğinizi öğrenmenin en iyi yolu, bunu denemektir!

## Davranışsal tespit politikalarını atlatma <a href="#id-9fde" id="id-9fde"></a>

Okta'daki davranışsal tespit politikaları, karşılaşılana kadar bilinmeyebilir, ancak bunları **doğrudan Okta uygulamalarını hedef alarak** atlatmak mümkündür; böylece ana Okta kontrol panelinden kaçınılır. Bir **Okta erişim token'ı** ile, token'ı ana giriş sayfası yerine **uygulama özel Okta URL'sinde** yeniden oynatın.

Anahtar öneriler şunlardır:

* **Popüler anonimleştirici proxy'leri ve VPN hizmetlerini** kullanmaktan kaçının, yakalanan erişim token'larını yeniden oynatırken.
* İstemci ile yeniden oynatılan erişim token'ları arasında **tutarlı kullanıcı ajanı dizgeleri** olduğundan emin olun.
* **Aynı IP adresinden** farklı kullanıcılardan token'ları yeniden oynatmaktan kaçının.
* Okta kontrol paneline karşı token'ları yeniden oynatırken dikkatli olun.
* Kurban şirketin IP adreslerini biliyorsanız, **trafikleri** bu IP'lere veya aralıklarına kısıtlayın, diğer tüm trafiği engelleyin.

## Okta Güçlendirme

Okta'nın birçok olası yapılandırması vardır, bu sayfada bunları mümkün olduğunca güvenli hale getirmek için nasıl gözden geçireceğinizi bulacaksınız:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referanslar

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
AWS Hacking öğrenin ve pratik yapın:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking öğrenin ve pratik yapın: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
