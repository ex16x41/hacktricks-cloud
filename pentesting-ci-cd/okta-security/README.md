# Okta Security

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}

## 基本情報

[Okta, Inc.](https://www.okta.com/)は、クラウドベースのソフトウェアソリューションでアイデンティティおよびアクセス管理分野で認識されています。これらのソリューションは、さまざまな現代アプリケーションにおけるユーザー認証を簡素化し、安全にすることを目的としています。これらは、機密データを保護しようとする企業だけでなく、アプリケーション、ウェブサービス、デバイスにアイデンティティコントロールを統合したい開発者にも対応しています。

Oktaの主力製品は**Okta Identity Cloud**です。このプラットフォームは、以下を含む製品群を網羅していますが、これに限定されません：

* **シングルサインオン（SSO）**：複数のアプリケーションで1セットのログイン資格情報を使用してユーザーアクセスを簡素化します。
* **多要素認証（MFA）**：複数の確認手段を要求することでセキュリティを強化します。
* **ライフサイクル管理**：ユーザーアカウントの作成、更新、無効化プロセスを自動化します。
* **ユニバーサルディレクトリ**：ユーザー、グループ、デバイスの集中管理を可能にします。
* **APIアクセス管理**：APIへのアクセスを保護し、管理します。

これらのサービスは、データ保護を強化し、ユーザーアクセスを簡素化することを目的としており、セキュリティと利便性の両方を向上させます。Oktaのソリューションの多様性は、さまざまな業界で人気の選択肢となっており、大企業、小企業、個々の開発者にとっても有益です。2021年9月の最新情報では、Oktaはアイデンティティおよびアクセス管理（IAM）分野で著名な存在として認識されています。

{% hint style="danger" %}
Oktaの主な目標は、外部アプリケーションへの異なるユーザーおよびグループへのアクセスを構成することです。もしあなたが**Okta環境で管理者権限を侵害することができれば、会社が使用している他のすべてのプラットフォームを侵害することができる可能性が非常に高いです**。
{% endhint %}

{% hint style="success" %}
Okta環境のセキュリティレビューを実施するには、**管理者の読み取り専用アクセス**を要求する必要があります。
{% endhint %}

### 概要

**ユーザー**（これは**Oktaに保存される**、構成された**アイデンティティプロバイダー**からログインする、または**Active Directory**またはLDAPを介して認証されることができます）。\
これらのユーザーは**グループ**内に存在することがあります。\
また、**認証者**もあります：パスワードやWebAuthn、メール、電話、Okta Verifyなどのさまざまな2FAの認証オプション（有効または無効にできる）...

次に、Oktaと同期された**アプリケーション**があります。各アプリケーションは、情報（メールアドレス、名前など）を共有するためにOktaとの**マッピング**を持っています。さらに、各アプリケーションは**認証ポリシー**内に存在し、ユーザーがアプリケーションに**アクセス**するために必要な**認証者**を示します。

{% hint style="danger" %}
最も強力な役割は**スーパ管理者**です。

攻撃者が管理者アクセスでOktaを侵害した場合、すべての**Oktaを信頼するアプリ**は非常に高い確率で**侵害される**でしょう。
{% endhint %}

## 攻撃

### Oktaポータルの特定

通常、企業のポータルは**companyname.okta.com**にあります。そうでない場合は、**companyname.**の単純な**バリエーション**を試してください。見つからない場合、組織が**CNAME**レコードを持っている可能性もあります。例えば、**`okta.companyname.com`**が**Oktaポータル**を指している場合です。

### Kerberos経由でのOktaへのログイン

もし**`companyname.kerberos.okta.com`**がアクティブであれば、**KerberosがOktaアクセスに使用されており**、通常は**Windows**ユーザーのために**MFA**をバイパスします。AD内でKerberos認証されたOktaユーザーを見つけるには、**`getST.py`**を**適切なパラメータ**で実行します。**ADユーザーチケット**を取得したら、RubeusやMimikatzなどのツールを使用して制御されたホストに**注入**し、**`clientname.kerberos.okta.com`がインターネットオプションの「イントラネット」ゾーンにあることを確認します**。特定のURLにアクセスすると、JSONの「OK」レスポンスが返され、Kerberosチケットの受け入れが示され、Oktaダッシュボードへのアクセスが許可されます。

**Oktaサービスアカウントを委任SPNで侵害することで、シルバーチケット攻撃が可能になります。**ただし、Oktaのチケット暗号化に**AES**を使用しているため、AESキーまたは平文パスワードを持っている必要があります。**`ticketer.py`を使用して被害者ユーザーのチケットを生成し、ブラウザを介してOktaに認証するために配信します。**

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### Okta ADエージェントのハイジャック

この技術は、**ユーザーを同期し、認証を処理するサーバー上のOkta ADエージェントにアクセスする**ことを含みます。**`OktaAgentService.exe.config`**内の設定を調査し、特に**DPAPI**を使用してAgentTokenを復号化することで、攻撃者は認証データを**傍受および操作**する可能性があります。これにより、Okta認証プロセス中にユーザー資格情報を平文で**監視**および**キャプチャ**するだけでなく、認証試行に**応答**することができ、不正アクセスを可能にしたり、Oktaを介してユニバーサル認証を提供したりすることができます（「スケルトンキー」のように）。

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### 管理者としてのADのハイジャック

この技術は、最初にOAuthコードを取得し、その後APIトークンを要求することによってOkta ADエージェントをハイジャックすることを含みます。トークンはADドメインに関連付けられ、**偽のADエージェントを確立するためにコネクタが名前付けされます**。初期化により、エージェントは**認証試行を処理し**、Okta APIを介して資格情報をキャプチャします。このプロセスを簡素化するための自動化ツールが利用可能で、Okta環境内での認証データの傍受と処理をシームレスに行う方法を提供します。

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

### Oktaの偽SAMLプロバイダー

**攻撃の詳細は** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**で確認してください。**

この技術は、**偽のSAMLプロバイダーを展開する**ことを含みます。特権アカウントを使用してOktaのフレームワーク内に外部アイデンティティプロバイダー（IdP）を統合することで、攻撃者は**IdPを制御し、任意の認証要求を承認することができます**。このプロセスには、Okta内にSAML 2.0 IdPを設定し、ローカルホストファイルを介してリダイレクトするためにIdPシングルサインオンURLを操作し、自己署名証明書を生成し、Okta設定をユーザー名またはメールアドレスに一致させることが含まれます。これらのステップを成功裏に実行することで、個々のユーザー資格情報を必要とせずに任意のOktaユーザーとして認証することが可能になり、アクセス制御を大幅に強化することができます。

### Evilgnixを使用したOktaポータルのフィッシング

[**このブログ記事**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)では、Oktaポータルに対するフィッシングキャンペーンの準備方法が説明されています。

### 同僚のなりすまし攻撃

**各ユーザーが持ち、変更できる属性**（メールや名前など）はOktaで設定できます。もし**アプリケーション**が、ユーザーが**変更できる属性**をIDとして**信頼している**場合、そのユーザーは**そのプラットフォーム内で他のユーザーをなりすますことができます**。

したがって、アプリが**`userName`**フィールドを信頼している場合、通常はそのフィールドを変更できないため（通常はそのフィールドを変更できない）、例えば**`primaryEmail`**を信頼している場合、同僚のメールアドレスに**変更することができるかもしれません**（メールにアクセスし、変更を承認する必要があります）。

このなりすましは、各アプリケーションがどのように設定されているかに依存することに注意してください。変更したフィールドを信頼し、更新を受け入れるアプリケーションのみが侵害されます。\
したがって、アプリはこのフィールドが存在する場合に有効にする必要があります：

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

他のアプリケーションが脆弱であったが、Okta設定にそのフィールドがなかったのを見たこともあります（最終的に異なるアプリは異なる設定がされています）。

各アプリで誰かをなりすますことができるかどうかを確認する最良の方法は、試してみることです！

## 行動検出ポリシーの回避 <a href="#id-9fde" id="id-9fde"></a>

Oktaの行動検出ポリシーは遭遇するまで不明な場合がありますが、**それらを回避する**ことは**Oktaアプリケーションに直接ターゲットを絞る**ことで達成できます。メインのOktaダッシュボードを避け、**Oktaアクセストークン**を使用して、メインのログインページではなく**アプリケーション固有のOkta URL**でトークンを再生します。

主な推奨事項は以下の通りです：

* キャプチャしたアクセストークンを再生する際に、一般的な匿名プロキシやVPNサービスの使用を**避けてください**。
* クライアントと再生されたアクセストークンの間で**一貫したユーザーエージェント文字列**を確保してください。
* 同じIPアドレスから異なるユーザーのトークンを**再生しないでください**。
* Oktaダッシュボードに対してトークンを再生する際は注意してください。
* 被害者企業のIPアドレスを知っている場合は、**そのIPまたはその範囲にトラフィックを制限し、他のすべてのトラフィックをブロックしてください**。

## Oktaの強化

Oktaには多くの可能な設定があり、このページではそれらをできるだけ安全にするためのレビュー方法を見つけることができます：

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## 参考文献

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}
