# Okta Security

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Basic Information

[Okta, Inc.](https://www.okta.com/) √© reconhecida no setor de gerenciamento de identidade e acesso por suas solu√ß√µes de software baseadas em nuvem. Essas solu√ß√µes s√£o projetadas para simplificar e proteger a autentica√ß√£o de usu√°rios em v√°rias aplica√ß√µes modernas. Elas atendem n√£o apenas a empresas que buscam proteger seus dados sens√≠veis, mas tamb√©m a desenvolvedores interessados em integrar controles de identidade em aplica√ß√µes, servi√ßos web e dispositivos.

A oferta principal da Okta √© a **Okta Identity Cloud**. Esta plataforma abrange um conjunto de produtos, incluindo, mas n√£o se limitando a:

* **Single Sign-On (SSO)**: Simplifica o acesso do usu√°rio permitindo um conjunto de credenciais de login em v√°rias aplica√ß√µes.
* **Multi-Factor Authentication (MFA)**: Aumenta a seguran√ßa exigindo m√∫ltiplas formas de verifica√ß√£o.
* **Lifecycle Management**: Automatiza a cria√ß√£o, atualiza√ß√£o e desativa√ß√£o de contas de usu√°rio.
* **Universal Directory**: Permite o gerenciamento centralizado de usu√°rios, grupos e dispositivos.
* **API Access Management**: Protege e gerencia o acesso a APIs.

Esses servi√ßos visam coletivamente fortalecer a prote√ß√£o de dados e simplificar o acesso do usu√°rio, melhorando tanto a seguran√ßa quanto a conveni√™ncia. A versatilidade das solu√ß√µes da Okta as torna uma escolha popular em v√°rias ind√∫strias, beneficiando grandes empresas, pequenas empresas e desenvolvedores individuais. At√© a √∫ltima atualiza√ß√£o em setembro de 2021, a Okta √© reconhecida como uma entidade proeminente na √°rea de Gerenciamento de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso a diferentes usu√°rios e grupos para aplica√ß√µes externas. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, voc√™ provavelmente ser√° capaz de **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar **acesso somente leitura de administrador**.
{% endhint %}

### Summary

Existem **usu√°rios** (que podem ser **armazenados na Okta,** logados a partir de **Provedores de Identidade** configurados ou autenticados via **Active Directory** ou LDAP).\
Esses usu√°rios podem estar dentro de **grupos**.\
Existem tamb√©m **autenticadores**: diferentes op√ß√µes para autenticar como senha e v√°rios 2FA como WebAuthn, email, telefone, okta verify (podem estar habilitados ou desabilitados)...

Ent√£o, existem **aplica√ß√µes** sincronizadas com a Okta. Cada aplica√ß√£o ter√° algum **mapeamento com a Okta** para compartilhar informa√ß√µes (como endere√ßos de email, primeiros nomes...). Al√©m disso, cada aplica√ß√£o deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para um usu√°rio **acessar** a aplica√ß√£o.

{% hint style="danger" %}
O papel mais poderoso √© **Super Administrador**.

Se um atacante comprometer a Okta com acesso de Administrador, todos os **apps que confiam na Okta** provavelmente estar√£o **comprometidos**.
{% endhint %}

## Attacks

### Locating Okta Portal

Geralmente, o portal de uma empresa estar√° localizado em **companyname.okta.com**. Se n√£o, tente varia√ß√µes simples de **companyname.** Se voc√™ n√£o conseguir encontr√°-lo, tamb√©m √© poss√≠vel que a organiza√ß√£o tenha um registro **CNAME** como **`okta.companyname.com`** apontando para o **portal Okta**.

### Login in Okta via Kerberos

Se **`companyname.kerberos.okta.com`** estiver ativo, **Kerberos √© usado para acesso √† Okta**, geralmente contornando **MFA** para usu√°rios **Windows**. Para encontrar usu√°rios Okta autenticados por Kerberos no AD, execute **`getST.py`** com **par√¢metros apropriados**. Ap√≥s obter um **ticket de usu√°rio AD**, **injete**-o em um host controlado usando ferramentas como Rubeus ou Mimikatz, garantindo que **`clientname.kerberos.okta.com` esteja na zona "Intranet" das Op√ß√µes de Internet**. Acessar uma URL espec√≠fica deve retornar uma resposta JSON "OK", indicando a aceita√ß√£o do ticket Kerberos e concedendo acesso ao painel da Okta.

Comprometer a **conta de servi√ßo Okta com o SPN de delega√ß√£o permite um ataque de Silver Ticket.** No entanto, o uso de **AES** pela Okta para criptografia de tickets requer a posse da chave AES ou senha em texto claro. Use **`ticketer.py` para gerar um ticket para o usu√°rio v√≠tima** e entreg√°-lo via navegador para autenticar com a Okta.

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking Okta AD Agent

Esta t√©cnica envolve **acessar o Okta AD Agent em um servidor**, que **sincroniza usu√°rios e lida com autentica√ß√£o**. Ao examinar e descriptografar configura√ß√µes em **`OktaAgentService.exe.config`**, notavelmente o AgentToken usando **DPAPI**, um atacante pode potencialmente **interceptar e manipular dados de autentica√ß√£o**. Isso permite n√£o apenas **monitorar** e **capturar credenciais de usu√°rio** em texto claro durante o processo de autentica√ß√£o da Okta, mas tamb√©m **responder a tentativas de autentica√ß√£o**, permitindo assim acesso n√£o autorizado ou fornecendo autentica√ß√£o universal atrav√©s da Okta (semelhante a uma 'chave mestra').

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Hijacking AD As an Admin

Esta t√©cnica envolve sequestrar um Okta AD Agent obtendo primeiro um C√≥digo OAuth, em seguida, solicitando um token de API. O token est√° associado a um dom√≠nio AD, e um **conector √© nomeado para estabelecer um agente AD falso**. A inicializa√ß√£o permite que o agente **processe tentativas de autentica√ß√£o**, capturando credenciais via API da Okta. Ferramentas de automa√ß√£o est√£o dispon√≠veis para agilizar esse processo, oferecendo um m√©todo cont√≠nuo para interceptar e lidar com dados de autentica√ß√£o dentro do ambiente Okta.

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Okta Fake SAML Provider

**Verifique o ataque em** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

A t√©cnica envolve **implantar um provedor SAML falso**. Ao integrar um Provedor de Identidade (IdP) externo dentro da estrutura da Okta usando uma conta privilegiada, os atacantes podem **controlar o IdP, aprovando qualquer solicita√ß√£o de autentica√ß√£o √† vontade**. O processo envolve configurar um IdP SAML 2.0 na Okta, manipulando a URL de Single Sign-On do IdP para redirecionamento via arquivo de hosts local, gerando um certificado autoassinado e configurando as configura√ß√µes da Okta para corresponder ao nome de usu√°rio ou email. Executar com sucesso essas etapas permite a autentica√ß√£o como qualquer usu√°rio da Okta, contornando a necessidade de credenciais individuais de usu√°rio, elevando significativamente o controle de acesso de maneira potencialmente n√£o percebida.

### Phishing Okta Portal with Evilgnix

Em [**este post do blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) √© explicado como preparar uma campanha de phishing contra um portal Okta.

### Colleague Impersonation Attack

Os **atributos que cada usu√°rio pode ter e modificar** (como email ou primeiro nome) podem ser configurados na Okta. Se uma **aplica√ß√£o** estiver **confiando** como ID um **atributo** que o usu√°rio pode **modificar**, ele poder√° **impersonar outros usu√°rios nessa plataforma**.

Portanto, se o app estiver confiando no campo **`userName`**, voc√™ provavelmente n√£o conseguir√° mud√°-lo (porque geralmente n√£o √© poss√≠vel mudar esse campo), mas se estiver confiando, por exemplo, em **`primaryEmail`**, voc√™ pode ser capaz de **mud√°-lo para o endere√ßo de email de um colega** e imperson√°-lo (voc√™ precisar√° ter acesso ao email e aceitar a mudan√ßa).

Note que essa impersona√ß√£o depende de como cada aplica√ß√£o foi configurada. Apenas aquelas que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidas.\
Portanto, o app deve ter esse campo habilitado se existir:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Eu tamb√©m vi outros apps que eram vulner√°veis, mas n√£o tinham esse campo nas configura√ß√µes da Okta (no final, diferentes apps s√£o configurados de maneira diferente).

A melhor maneira de descobrir se voc√™ poderia impersonar algu√©m em cada app seria tentar!

## Evading behavioural detection policies <a href="#id-9fde" id="id-9fde"></a>

As pol√≠ticas de detec√ß√£o comportamental na Okta podem ser desconhecidas at√© serem encontradas, mas **contorn√°-las** pode ser alcan√ßado **direcionando-se diretamente para as aplica√ß√µes Okta**, evitando o painel principal da Okta. Com um **token de acesso Okta**, reproduza o token na **URL espec√≠fica da aplica√ß√£o Okta** em vez da p√°gina de login principal.

As principais recomenda√ß√µes incluem:

* **Evite usar** proxies de anonimiza√ß√£o populares e servi√ßos de VPN ao reproduzir tokens de acesso capturados.
* Garanta **strings de agente de usu√°rio consistentes** entre o cliente e os tokens de acesso reproduzidos.
* **Evite reproduzir** tokens de diferentes usu√°rios do mesmo endere√ßo IP.
* Tenha cautela ao reproduzir tokens contra o painel da Okta.
* Se souber os endere√ßos IP da empresa v√≠tima, **restrinja o tr√°fego** para esses IPs ou seu intervalo, bloqueando todo o outro tr√°fego.

## Okta Hardening

A Okta tem muitas configura√ß√µes poss√≠veis, nesta p√°gina voc√™ encontrar√° como revis√°-las para que sejam o mais seguras poss√≠vel:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## References

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
