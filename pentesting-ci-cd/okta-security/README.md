# Okta Security

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[Okta, Inc.](https://www.okta.com/) je prepoznata u sektoru upravljanja identitetom i pristupom po svojim re코enjima zasnovanim na oblaku. Ova re코enja su dizajnirana da pojednostave i osiguraju autentifikaciju korisnika kroz razli캜ite moderne aplikacije. Ona su namenjena ne samo kompanijama koje 쬰le da za코tite svoje osetljive podatke, ve캖 i programerima zainteresovanim za integraciju kontrola identiteta u aplikacije, veb usluge i ure캠aje.

Glavna ponuda Okta je **Okta Identity Cloud**. Ova platforma obuhvata paket proizvoda, uklju캜uju캖i, ali ne ograni캜avaju캖i se na:

* **Jedinstvena prijava (SSO)**: Pojednostavljuje pristup korisnika omogu캖avaju캖i jedan set prijavnih podataka za vi코e aplikacija.
* **Vi코efaktorska autentifikacija (MFA)**: Pove캖ava bezbednost zahtevaju캖i vi코e oblika verifikacije.
* **Upravljanje 쬴votnim ciklusom**: Automatizuje procese kreiranja, a쬿riranja i deaktivacije korisni캜kih naloga.
* **Univerzalni direktorijum**: Omogu캖ava centralizovano upravljanje korisnicima, grupama i ure캠ajima.
* **Upravljanje pristupom API-ju**: Osigurava i upravlja pristupom API-ima.

Ove usluge zajedni캜ki imaju za cilj ja캜anje za코tite podataka i pojednostavljenje pristupa korisnicima, pobolj코avaju캖i i bezbednost i pogodnost. Svestranost Okta-ovih re코enja 캜ini ih popularnim izborom u razli캜itim industrijama, korisnim za velike preduze캖a, male kompanije i pojedina캜ne programere. Na poslednjem a쬿riranju u septembru 2021. godine, Okta je priznata kao istaknuta entitet u oblasti upravljanja identitetom i pristupom (IAM).

{% hint style="danger" %}
Glavni cilj Okta je da konfiguri코e pristup razli캜itim korisnicima i grupama za spoljne aplikacije. Ako uspete da **kompromitujete administratorske privilegije u Okta** okru쬰nju, verovatno 캖ete mo캖i da **kompromitujete sve druge platforme koje kompanija koristi**.
{% endhint %}

{% hint style="success" %}
Da biste izvr코ili bezbednosni pregled Okta okru쬰nja, trebali biste zatra쬴ti **administratorski pristup samo za 캜itanje**.
{% endhint %}

### Sa쬰tak

Postoje **korisnici** (koji mogu biti **sme코teni u Okta,** prijavljeni iz konfigurisanih **provajdera identiteta** ili autentifikovani putem **Active Directory** ili LDAP).\
Ovi korisnici mogu biti unutar **grupa**.\
Postoje i **autentifikatori**: razli캜ite opcije za autentifikaciju kao 코to su lozinka, i nekoliko 2FA kao 코to su WebAuthn, email, telefon, okta verify (mogu biti omogu캖eni ili onemogu캖eni)...

Zatim, postoje **aplikacije** sinhronizovane sa Okta. Svaka aplikacija 캖e imati neku **mapu sa Okta** za deljenje informacija (kao 코to su email adrese, imena...). 맚avi코e, svaka aplikacija mora biti unutar **Politike autentifikacije**, koja ozna캜ava **potrebne autentifikatore** za korisnika da **pristupi** aplikaciji.

{% hint style="danger" %}
Najmo캖nija uloga je **Super Administrator**.

Ako napada캜 kompromituje Okta sa administratorskim pristupom, sve **aplikacije koje veruju Okta** 캖e verovatno biti **kompromitovane**.
{% endhint %}

## Napadi

### Lociranje Okta portala

Obi캜no 캖e portal kompanije biti lociran na **companyname.okta.com**. Ako nije, poku코ajte jednostavne **varijacije** **companyname.** Ako ne mo쬰te da ga prona캠ete, tako캠e je mogu캖e da organizacija ima **CNAME** zapis kao **`okta.companyname.com`** koji upu캖uje na **Okta portal**.

### Prijava u Okta putem Kerberosa

Ako je **`companyname.kerberos.okta.com`** aktivan, **Kerberos se koristi za pristup Okta**, obi캜no zaobilaze캖i **MFA** za **Windows** korisnike. Da biste prona코li Kerberos-autentifikovane Okta korisnike u AD, pokrenite **`getST.py`** sa **odgovaraju캖im parametrima**. Nakon dobijanja **AD korisni캜kog tiketa**, **ubacite** ga u kontrolisani host koriste캖i alate kao 코to su Rubeus ili Mimikatz, osiguravaju캖i da je **`clientname.kerberos.okta.com` u "Intranet" zoni Internet opcija**. Pristup odre캠enom URL-u trebao bi da vrati JSON "OK" odgovor, 코to ukazuje na prihvatanje Kerberos tiketa, i omogu캖ava pristup Okta kontrolnoj tabli.

Kompromitovanje **Okta servisnog naloga sa delegacijom SPN omogu캖ava Silver Ticket napad.** Me캠utim, kori코캖enje **AES** za enkripciju tiketa zahteva posedovanje AES klju캜a ili lozinke u obi캜nom tekstu. Koristite **`ticketer.py` da generi코ete tiket za rtvovanog korisnika** i dostavite ga putem pretra쬴va캜a za autentifikaciju sa Okta.

**Proverite napad u** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Otimanje Okta AD agenta

Ova tehnika uklju캜uje **pristupanje Okta AD agentu na serveru**, koji **sinhronizuje korisnike i upravlja autentifikacijom**. Istra쬴vanjem i dekripcijom konfiguracija u **`OktaAgentService.exe.config`**, posebno AgentToken koriste캖i **DPAPI**, napada캜 mo쬰 potencijalno **presresti i manipulisati podacima o autentifikaciji**. Ovo omogu캖ava ne samo **pra캖enje** i **hvatanje korisni캜kih kredencijala** u obi캜nom tekstu tokom Okta procesa autentifikacije, ve캖 i **odgovaranje na poku코aje autentifikacije**, 캜ime se omogu캖ava neovla코캖en pristup ili pru쬬nje univerzalne autentifikacije putem Okta (sli캜no 'skeleton key').

**Proverite napad u** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Otimanje AD kao administrator

Ova tehnika uklju캜uje otimanje Okta AD agenta prvo dobijanjem OAuth koda, a zatim zahtevom za API token. Token je povezan sa AD domenom, a **konektor je imenovan da uspostavi la쬹i AD agent**. Inicijalizacija omogu캖ava agentu da **obra캠uje poku코aje autentifikacije**, hvataju캖i kredencijale putem Okta API-ja. Alati za automatizaciju su dostupni za pojednostavljenje ovog procesa, nude캖i besprekornu metodu za presretanje i rukovanje podacima o autentifikaciji unutar Okta okru쬰nja.

**Proverite napad u** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### La쬹i Okta SAML provajder

**Proverite napad u** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Tehnika uklju캜uje **implementaciju la쬹og SAML provajdera**. Integracijom spoljnog provajdera identiteta (IdP) unutar Okta okvira koriste캖i privilegovani nalog, napada캜i mogu **kontrolisati IdP, odobravaju캖i bilo koji zahtev za autentifikaciju po 쬰lji**. Proces podrazumeva postavljanje SAML 2.0 IdP u Okta, manipulaciju IdP URL-om za jedinstvenu prijavu radi preusmeravanja putem lokalnog hosts fajla, generisanje samopotpisanog sertifikata i konfiguraciju Okta postavki da se podudaraju sa korisni캜kim imenom ili email-om. Uspe코no izvr코avanje ovih koraka omogu캖ava autentifikaciju kao bilo koji Okta korisnik, zaobilaze캖i potrebu za pojedina캜nim korisni캜kim kredencijalima, zna캜ajno pove캖avaju캖i kontrolu pristupa na potencijalno neprimetan na캜in.

### Phishing Okta portala sa Evilgnix

U [**ovom blog postu**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) obja코njeno je kako pripremiti phishing kampanju protiv Okta portala.

### Napad imitacije kolege

**atributi koje svaki korisnik mo쬰 imati i modifikovati** (kao 코to su email ili ime) mogu se konfigurisati u Okta. Ako je **aplikacija** **pouzdana** kao ID **atribut** koji korisnik mo쬰 **modifikovati**, mo캖i 캖e da **imitira druge korisnike na toj platformi**.

Stoga, ako aplikacija veruje polju **`userName`**, verovatno ne캖ete mo캖i da ga promenite (jer obi캜no ne mo쬰te promeniti to polje), ali ako veruje na primer **`primaryEmail`** mo쬯a 캖ete mo캖i da **promenite na email adresu kolege** i imitirati je (treba캖e vam pristup email-u i da prihvatite promenu).

Napomena da ova imitacija zavisi od toga kako je svaka aplikacija konfigurisana. Samo one koje veruju polju koje ste modifikovali i prihvataju a쬿riranja 캖e biti kompromitovane.\
Stoga, aplikacija treba da ima ovo polje omogu캖eno ako postoji:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Tako캠e sam video druge aplikacije koje su bile ranjive, ali nisu imale to polje u Okta postavkama (na kraju, razli캜ite aplikacije su konfigurisane razli캜ito).

Najbolji na캜in da saznate da li mo쬰te imitirati nekoga na svakoj aplikaciji bio bi da probate!

## Izbegavanje politika detekcije pona코anja <a href="#id-9fde" id="id-9fde"></a>

Politike detekcije pona코anja u Okta mogu biti nepoznate dok se ne susretnete s njima, ali **zaobila쬰nje** njih mo쬰 se posti캖i **usmeravanjem direktno na Okta aplikacije**, izbegavaju캖i glavnu Okta kontrolnu tablu. Sa **Okta pristupnim tokenom**, ponovo reprodukujte token na **URL-u specifi캜nom za aplikaciju Okta** umesto na glavnoj stranici za prijavu.

Klju캜ne preporuke uklju캜uju:

* **Izbegavajte kori코캖enje** popularnih anonimnih proksija i VPN usluga prilikom ponovnog reprodukovanja uhva캖enih pristupnih tokena.
* Osigurajte **dosledne korisni캜ke agente** izme캠u klijenta i ponovo reprodukovanih pristupnih tokena.
* **Izbegavajte ponovnu reprodukciju** tokena od razli캜itih korisnika sa iste IP adrese.
* Budite oprezni prilikom ponovne reprodukcije tokena protiv Okta kontrolne table.
* Ako znate IP adrese rtvovane kompanije, **ograni캜ite saobra캖aj** na te IP adrese ili njihov opseg, blokiraju캖i sav ostali saobra캖aj.

## Okta ja캜anje

Okta ima mnogo mogu캖ih konfiguracija, na ovoj stranici 캖ete prona캖i kako da ih pregledate kako bi bile 코to sigurnije:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Reference

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
