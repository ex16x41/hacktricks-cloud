# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci贸n B谩sica

[Okta, Inc.](https://www.okta.com/) es reconocida en el sector de gesti贸n de identidades y accesos por sus soluciones de software basadas en la nube. Estas soluciones est谩n dise帽adas para simplificar y asegurar la autenticaci贸n de usuarios en diversas aplicaciones modernas. Atienden no solo a empresas que buscan proteger sus datos sensibles, sino tambi茅n a desarrolladores interesados en integrar controles de identidad en aplicaciones, servicios web y dispositivos.

La oferta principal de Okta es la **Okta Identity Cloud**. Esta plataforma incluye una suite de productos, entre los que se encuentran:

* **Single Sign-On (SSO)**: Simplifica el acceso de los usuarios permitiendo un conjunto de credenciales de inicio de sesi贸n para m煤ltiples aplicaciones.
* **Multi-Factor Authentication (MFA)**: Mejora la seguridad al requerir m煤ltiples formas de verificaci贸n.
* **Lifecycle Management**: Automatiza los procesos de creaci贸n, actualizaci贸n y desactivaci贸n de cuentas de usuario.
* **Universal Directory**: Permite la gesti贸n centralizada de usuarios, grupos y dispositivos.
* **API Access Management**: Asegura y gestiona el acceso a APIs.

Estos servicios en conjunto buscan fortalecer la protecci贸n de datos y simplificar el acceso de los usuarios, mejorando tanto la seguridad como la conveniencia. La versatilidad de las soluciones de Okta las hace una opci贸n popular en diversas industrias, siendo beneficiosas para grandes empresas, peque帽as compa帽铆as y desarrolladores individuales por igual. Hasta la 煤ltima actualizaci贸n en septiembre de 2021, Okta es reconocida como una entidad prominente en el 谩mbito de la Gesti贸n de Identidades y Accesos (IAM).

{% hint style="danger" %}
El objetivo principal de Okta es configurar el acceso a diferentes usuarios y grupos a aplicaciones externas. Si logras **comprometer privilegios de administrador en un entorno de Okta**, es muy probable que puedas **comprometer todas las dem谩s plataformas que la empresa est谩 utilizando**.
{% endhint %}

{% hint style="success" %}
Para realizar una revisi贸n de seguridad de un entorno de Okta, deber铆as solicitar **acceso de solo lectura de administrador**.
{% endhint %}

### Resumen

Hay **usuarios** (que pueden estar **almacenados en Okta**, registrados desde **Identity Providers** configurados o autenticados v铆a **Active Directory** o LDAP).\
Estos usuarios pueden estar dentro de **grupos**.\
Tambi茅n hay **autenticadores**: diferentes opciones para autenticar como contrase帽a, y varios 2FA como WebAuthn, email, tel茅fono, okta verify (pueden estar habilitados o deshabilitados)...

Luego, hay **aplicaciones** sincronizadas con Okta. Cada aplicaci贸n tendr谩 alg煤n **mapeo con Okta** para compartir informaci贸n (como direcciones de correo electr贸nico, nombres...). Adem谩s, cada aplicaci贸n debe estar dentro de una **Pol铆tica de Autenticaci贸n**, que indica los **autenticadores necesarios** para que un usuario **acceda** a la aplicaci贸n.

{% hint style="danger" %}
El rol m谩s poderoso es **Super Administrator**.

Si un atacante compromete Okta con acceso de Administrador, todas las **apps que conf铆an en Okta** ser谩n muy probablemente **comprometidas**.
{% endhint %}

## Ataques

### Localizando el Portal de Okta

Usualmente el portal de una empresa estar谩 ubicado en **companyname.okta.com**. Si no, intenta variaciones simples de **companyname.** Si no puedes encontrarlo, tambi茅n es posible que la organizaci贸n tenga un registro **CNAME** como **`okta.companyname.com`** apuntando al **portal de Okta**.

### Iniciar sesi贸n en Okta v铆a Kerberos

Si **`companyname.kerberos.okta.com`** est谩 activo, **Kerberos se usa para el acceso a Okta**, t铆picamente omitiendo **MFA** para usuarios de **Windows**. Para encontrar usuarios de Okta autenticados por Kerberos en AD, ejecuta **`getST.py`** con **par谩metros apropiados**. Al obtener un **ticket de usuario de AD**, **iny茅ctalo** en un host controlado usando herramientas como Rubeus o Mimikatz, asegurando que **`clientname.kerberos.okta.com` est茅 en la zona "Intranet" de las Opciones de Internet**. Acceder a una URL espec铆fica deber铆a devolver una respuesta JSON "OK", indicando la aceptaci贸n del ticket Kerberos y otorgando acceso al panel de Okta.

Comprometer la **cuenta de servicio de Okta con el SPN de delegaci贸n permite un ataque de Silver Ticket.** Sin embargo, el uso de **AES** por parte de Okta para la encriptaci贸n de tickets requiere poseer la clave AES o la contrase帽a en texto plano. Usa **`ticketer.py` para generar un ticket para el usuario v铆ctima** y entr茅galo a trav茅s del navegador para autenticar con Okta.

**Revisa el ataque en** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Secuestrando el Agente de AD de Okta

Esta t茅cnica implica **acceder al Agente de AD de Okta en un servidor**, que **sincroniza usuarios y maneja la autenticaci贸n**. Al examinar y descifrar configuraciones en **`OktaAgentService.exe.config`**, notablemente el AgentToken usando **DPAPI**, un atacante puede potencialmente **interceptar y manipular datos de autenticaci贸n**. Esto permite no solo **monitorear** y **capturar credenciales de usuario** en texto plano durante el proceso de autenticaci贸n de Okta, sino tambi茅n **responder a intentos de autenticaci贸n**, permitiendo as铆 acceso no autorizado o proporcionando autenticaci贸n universal a trav茅s de Okta (similar a una 'llave maestra').

**Revisa el ataque en** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Secuestrando AD como Administrador

Esta t茅cnica implica secuestrar un Agente de AD de Okta primero obteniendo un C贸digo OAuth, luego solicitando un token de API. El token est谩 asociado con un dominio de AD, y se nombra un **conector para establecer un agente de AD falso**. La inicializaci贸n permite que el agente **procese intentos de autenticaci贸n**, capturando credenciales a trav茅s de la API de Okta. Hay herramientas de automatizaci贸n disponibles para agilizar este proceso, ofreciendo un m茅todo fluido para interceptar y manejar datos de autenticaci贸n dentro del entorno de Okta.

**Revisa el ataque en** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Proveedor SAML Falso de Okta

**Revisa el ataque en** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

La t茅cnica implica **desplegar un proveedor SAML falso**. Al integrar un Proveedor de Identidad (IdP) externo dentro del marco de Okta usando una cuenta privilegiada, los atacantes pueden **controlar el IdP, aprobando cualquier solicitud de autenticaci贸n a voluntad**. El proceso implica configurar un IdP SAML 2.0 en Okta, manipulando la URL de Single Sign-On del IdP para redirecci贸n a trav茅s del archivo de hosts local, generando un certificado autofirmado y configurando los ajustes de Okta para coincidir con el nombre de usuario o correo electr贸nico. Ejecutar estos pasos con 茅xito permite la autenticaci贸n como cualquier usuario de Okta, eludiendo la necesidad de credenciales de usuario individuales, elevando significativamente el control de acceso de manera potencialmente inadvertida.

### Phishing del Portal de Okta con Evilgnix

En [**esta publicaci贸n de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) se explica c贸mo preparar una campa帽a de phishing contra un portal de Okta.

### Ataque de Suplantaci贸n de Colegas

Los **atributos que cada usuario puede tener y modificar** (como correo electr贸nico o nombre) pueden configurarse en Okta. Si una **aplicaci贸n** est谩 **confiando** como ID en un **atributo** que el usuario puede **modificar**, podr谩 **suplantar a otros usuarios en esa plataforma**.

Por lo tanto, si la app conf铆a en el campo **`userName`**, probablemente no podr谩s cambiarlo (porque usualmente no puedes cambiar ese campo), pero si conf铆a, por ejemplo, en **`primaryEmail`** podr铆as **cambiarlo a la direcci贸n de correo de un colega** y suplantarlo (necesitar谩s tener acceso al correo y aceptar el cambio).

Ten en cuenta que esta suplantaci贸n depende de c贸mo se configur贸 cada aplicaci贸n. Solo las que conf铆an en el campo que modificaste y aceptan actualizaciones ser谩n comprometidas.\
Por lo tanto, la app deber铆a tener este campo habilitado si existe:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Tambi茅n he visto otras apps que eran vulnerables pero no ten铆an ese campo en la configuraci贸n de Okta (al final, diferentes apps se configuran de manera diferente).

La mejor manera de averiguar si podr铆as suplantar a alguien en cada app ser铆a intentarlo.

## Evadiendo pol铆ticas de detecci贸n de comportamiento <a href="#id-9fde" id="id-9fde"></a>

Las pol铆ticas de detecci贸n de comportamiento en Okta pueden ser desconocidas hasta que se encuentren, pero **evitarlas** se puede lograr **dirigi茅ndose directamente a las aplicaciones de Okta**, evitando el panel principal de Okta. Con un **token de acceso de Okta**, reproduce el token en la **URL espec铆fica de la aplicaci贸n de Okta** en lugar de la p谩gina principal de inicio de sesi贸n.

Recomendaciones clave incluyen:

* **Evitar usar** proxies de anonimizaci贸n populares y servicios VPN al reproducir tokens de acceso capturados.
* Asegurar **consistencia en las cadenas de agente de usuario** entre el cliente y los tokens de acceso reproducidos.
* **Abstenerse de reproducir** tokens de diferentes usuarios desde la misma direcci贸n IP.
* Tener precauci贸n al reproducir tokens contra el panel de Okta.
* Si conoces las direcciones IP de la empresa v铆ctima, **restringe el tr谩fico** a esas IPs o su rango, bloqueando todo otro tr谩fico.

## Endurecimiento de Okta

Okta tiene muchas configuraciones posibles, en esta p谩gina encontrar谩s c贸mo revisarlas para que sean lo m谩s seguras posible:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referencias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
