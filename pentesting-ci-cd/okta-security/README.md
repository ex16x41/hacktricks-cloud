# Okta Security

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

[Okta, Inc.](https://www.okta.com/) jest uznawana w sektorze zarzdzania to偶samoci i dostpem za swoje oparte na chmurze rozwizania programowe. Rozwizania te maj na celu uproszczenie i zabezpieczenie uwierzytelniania u偶ytkownik贸w w r贸偶nych nowoczesnych aplikacjach. S skierowane nie tylko do firm d偶cych do ochrony swoich wra偶liwych danych, ale tak偶e do programist贸w zainteresowanych integracj kontroli to偶samoci w aplikacjach, usugach internetowych i urzdzeniach.

Flagowym produktem Okta jest **Okta Identity Cloud**. Ta platforma obejmuje zestaw produkt贸w, w tym, ale nie tylko:

* **Single Sign-On (SSO)**: Uproszcza dostp u偶ytkownik贸w, pozwalajc na u偶ycie jednego zestawu danych logowania w wielu aplikacjach.
* **Multi-Factor Authentication (MFA)**: Zwiksza bezpieczestwo, wymagajc wielu form weryfikacji.
* **Zarzdzanie cyklem 偶ycia**: Automatyzuje procesy tworzenia, aktualizacji i dezaktywacji kont u偶ytkownik贸w.
* **Universal Directory**: Umo偶liwia centralne zarzdzanie u偶ytkownikami, grupami i urzdzeniami.
* **Zarzdzanie dostpem do API**: Zabezpiecza i zarzdza dostpem do API.

Usugi te maj na celu wzmocnienie ochrony danych i uproszczenie dostpu u偶ytkownik贸w, zwikszajc zar贸wno bezpieczestwo, jak i wygod. Wszechstronno rozwiza Okta sprawia, 偶e s one popularnym wyborem w r贸偶nych bran偶ach, korzystnym zar贸wno dla du偶ych przedsibiorstw, maych firm, jak i indywidualnych programist贸w. Na ostatni aktualizacj we wrzeniu 2021 roku, Okta jest uznawana za znaczc jednostk w obszarze zarzdzania to偶samoci i dostpem (IAM).

{% hint style="danger" %}
G贸wnym celem Okta jest skonfigurowanie dostpu do r贸偶nych u偶ytkownik贸w i grup do zewntrznych aplikacji. Jeli uda ci si **skompromentowa uprawnienia administratora w rodowisku Okta**, prawdopodobnie bdziesz w stanie **skompromentowa wszystkie inne platformy, z kt贸rych korzysta firma**.
{% endhint %}

{% hint style="success" %}
Aby przeprowadzi przegld bezpieczestwa rodowiska Okta, powiniene poprosi o **dostp tylko do odczytu dla administratora**.
{% endhint %}

### Podsumowanie

S **u偶ytkownicy** (kt贸rzy mog by **przechowywani w Okta,** logowani z skonfigurowanych **Dostawc贸w To偶samoci** lub uwierzytelniani za pomoc **Active Directory** lub LDAP).\
Ci u偶ytkownicy mog by w **grupach**.\
S tak偶e **uwierzytelnienia**: r贸偶ne opcje uwierzytelniania, takie jak haso oraz kilka 2FA, jak WebAuthn, e-mail, telefon, okta verify (mog by wczone lub wyczone)...

Nastpnie s **aplikacje** zsynchronizowane z Okta. Ka偶da aplikacja bdzie miaa jakie **mapowanie z Okta** do dzielenia si informacjami (takimi jak adresy e-mail, imiona...). Ponadto ka偶da aplikacja musi by w **Polityce Uwierzytelniania**, kt贸ra wskazuje **potrzebne uwierzytelnienia** dla u偶ytkownika, aby **uzyska dostp** do aplikacji.

{% hint style="danger" %}
Najpot偶niejsz rol jest **Super Administrator**.

Jeli atakujcy skompromituje Okta z dostpem administratora, wszystkie **aplikacje ufajce Okta** bd prawdopodobnie **skompromentowane**.
{% endhint %}

## Ataki

### Lokalizacja portalu Okta

Zazwyczaj portal firmy bdzie znajdowa si pod adresem **companyname.okta.com**. Jeli nie, spr贸buj prostych **wariant贸w** **companyname.** Jeli nie mo偶esz go znale藕, mo偶liwe, 偶e organizacja ma rekord **CNAME** jak **`okta.companyname.com`** wskazujcy na **portal Okta**.

### Logowanie do Okta za pomoc Kerberos

Jeli **`companyname.kerberos.okta.com`** jest aktywne, **Kerberos jest u偶ywany do dostpu do Okta**, zazwyczaj omijajc **MFA** dla u偶ytkownik贸w **Windows**. Aby znale藕 u偶ytkownik贸w Okta uwierzytelnionych za pomoc Kerberos w AD, uruchom **`getST.py`** z **odpowiednimi parametrami**. Po uzyskaniu **biletu u偶ytkownika AD**, **wstrzyknij** go do kontrolowanego hosta za pomoc narzdzi takich jak Rubeus lub Mimikatz, upewniajc si, 偶e **`clientname.kerberos.okta.com` jest w strefie "Intranet" w Opcjach Internetowych**. Uzyskanie dostpu do konkretnego URL powinno zwr贸ci odpowied藕 JSON "OK", co wskazuje na akceptacj biletu Kerberos i przyznanie dostpu do pulpitu nawigacyjnego Okta.

Skompromitowanie **konta usugi Okta z delegacj SPN umo偶liwia atak Silver Ticket.** Jednak u偶ycie przez Okta **AES** do szyfrowania bilet贸w wymaga posiadania klucza AES lub hasa w postaci jawnej. U偶yj **`ticketer.py`, aby wygenerowa bilet dla u偶ytkownika ofiary** i dostarczy go przez przegldark do uwierzytelnienia w Okta.

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejcie agenta AD Okta

Technika ta polega na **dostpie do agenta AD Okta na serwerze**, kt贸ry **synchronizuje u偶ytkownik贸w i obsuguje uwierzytelnianie**. Poprzez badanie i deszyfrowanie konfiguracji w **`OktaAgentService.exe.config`**, szczeg贸lnie tokenu agenta przy u偶yciu **DPAPI**, atakujcy mo偶e potencjalnie **przechwyci i manipulowa danymi uwierzytelniajcymi**. Umo偶liwia to nie tylko **monitorowanie** i **przechwytywanie danych uwierzytelniajcych u偶ytkownik贸w** w postaci jawnej podczas procesu uwierzytelniania Okta, ale tak偶e **reagowanie na pr贸by uwierzytelnienia**, co umo偶liwia nieautoryzowany dostp lub zapewnia uniwersalne uwierzytelnienie przez Okta (podobnie jak 'klucz uniwersalny').

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejcie AD jako administrator

Technika ta polega na przejciu agenta AD Okta poprzez najpierw uzyskanie kodu OAuth, a nastpnie 偶danie tokenu API. Token jest powizany z domen AD, a **konektor jest nazwany, aby ustanowi faszywego agenta AD**. Inicjalizacja pozwala agentowi na **przetwarzanie pr贸b uwierzytelnienia**, przechwytujc dane uwierzytelniajce za pomoc API Okta. Narzdzia automatyzacyjne s dostpne, aby uproci ten proces, oferujc pynny spos贸b na przechwytywanie i obsug danych uwierzytelniajcych w rodowisku Okta.

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Faszywy dostawca SAML Okta

**Sprawd藕 atak w** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Technika ta polega na **wdro偶eniu faszywego dostawcy SAML**. Poprzez integracj zewntrznego Dostawcy To偶samoci (IdP) w ramach Okta przy u偶yciu uprzywilejowanego konta, atakujcy mog **kontrolowa IdP, zatwierdzajc dowolne 偶danie uwierzytelnienia wedug uznania**. Proces ten obejmuje skonfigurowanie IdP SAML 2.0 w Okta, manipulacj URL SSO IdP w celu przekierowania przez lokalny plik hosts, wygenerowanie certyfikatu samopodpisanego oraz skonfigurowanie ustawie Okta, aby pasoway do nazwy u偶ytkownika lub adresu e-mail. Pomylne wykonanie tych krok贸w pozwala na uwierzytelnienie jako dowolny u偶ytkownik Okta, omijajc potrzeb indywidualnych danych logowania u偶ytkownik贸w, co znacznie podnosi kontrol dostpu w spos贸b, kt贸ry mo偶e pozosta niezauwa偶ony.

### Atak phishingowy na portal Okta z u偶yciem Evilgnix

W [**tym wpisie na blogu**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) wyjaniono, jak przygotowa kampani phishingow przeciwko portalowi Okta.

### Atak podszywania si pod koleg

**Atrybuty, kt贸re ka偶dy u偶ytkownik mo偶e mie i modyfikowa** (jak e-mail czy imi) mog by skonfigurowane w Okta. Jeli **aplikacja** ufa jako ID atrybutowi, kt贸ry u偶ytkownik mo偶e **modyfikowa**, bdzie m贸g **podszywa si pod innych u偶ytkownik贸w na tej platformie**.

Dlatego, jeli aplikacja ufa polu **`userName`**, prawdopodobnie nie bdziesz m贸g go zmieni (poniewa偶 zazwyczaj nie mo偶na zmienia tego pola), ale jeli ufa na przykad **`primaryEmail`**, mo偶esz by w stanie **zmieni go na adres e-mail kolegi** i si pod niego podszy (bdziesz musia mie dostp do e-maila i zaakceptowa zmian).

Zauwa偶, 偶e to podszywanie si zale偶y od tego, jak ka偶da aplikacja zostaa skonfigurowana. Tylko te, kt贸re ufaj polu, kt贸re zmodyfikowae i akceptuj aktualizacje, bd skompromitowane.\
Dlatego aplikacja powinna mie to pole wczone, jeli istnieje:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Widziaem tak偶e inne aplikacje, kt贸re byy podatne, ale nie miay tego pola w ustawieniach Okta (na kocu r贸偶ne aplikacje s konfigurowane inaczej).

Najlepszym sposobem, aby dowiedzie si, czy mo偶esz si podszy pod kogokolwiek w ka偶dej aplikacji, byoby spr贸bowa!

## Omijanie polityk wykrywania behawioralnego <a href="#id-9fde" id="id-9fde"></a>

Polityki wykrywania behawioralnego w Okta mog by nieznane do momentu ich napotkania, ale **omijanie** ich mo偶na osign poprzez **bezporednie celowanie w aplikacje Okta**, unikajc g贸wnego pulpitu nawigacyjnego Okta. Z **tokenem dostpu Okta**, odtw贸rz token na **specyficznym URL aplikacji Okta** zamiast na g贸wnej stronie logowania.

Kluczowe zalecenia obejmuj:

* **Unikaj u偶ywania** popularnych proxy anonimizujcych i usug VPN podczas odtwarzania przechwyconych token贸w dostpu.
* Upewnij si, 偶e **cig user-agent** jest sp贸jny midzy klientem a odtwarzanymi tokenami dostpu.
* **Powstrzymaj si od odtwarzania** token贸w od r贸偶nych u偶ytkownik贸w z tego samego adresu IP.
* Zachowaj ostro偶no podczas odtwarzania token贸w przeciwko pulpitowi nawigacyjnemu Okta.
* Jeli znasz adresy IP firmy ofiary, **ogranicz ruch** do tych adres贸w IP lub ich zakresu, blokujc cay inny ruch.

## Wzmacnianie Okta

Okta ma wiele mo偶liwych konfiguracji, na tej stronie znajdziesz, jak je przeglda, aby byy jak najbardziej bezpieczne:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Odniesienia

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
