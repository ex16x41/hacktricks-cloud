# Okta Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe Informacje

[Okta, Inc.](https://www.okta.com/) jest uznawana w sektorze zarzdzania to偶samoci i dostpem za swoje rozwizania oparte na chmurze. Te rozwizania s zaprojektowane, aby uproci i zabezpieczy uwierzytelnianie u偶ytkownik贸w w r贸偶nych nowoczesnych aplikacjach. Su偶 one nie tylko firmom, kt贸re chc chroni swoje wra偶liwe dane, ale tak偶e deweloperom zainteresowanym integracj kontroli to偶samoci w aplikacjach, usugach internetowych i urzdzeniach.

Flagowym produktem Okta jest **Okta Identity Cloud**. Ta platforma obejmuje zestaw produkt贸w, w tym midzy innymi:

* **Single Sign-On (SSO)**: Uatwia dostp u偶ytkownik贸w, pozwalajc na jedno zestawienie danych logowania do wielu aplikacji.
* **Multi-Factor Authentication (MFA)**: Zwiksza bezpieczestwo, wymagajc wielu form weryfikacji.
* **Lifecycle Management**: Automatyzuje procesy tworzenia, aktualizacji i dezaktywacji kont u偶ytkownik贸w.
* **Universal Directory**: Umo偶liwia centralne zarzdzanie u偶ytkownikami, grupami i urzdzeniami.
* **API Access Management**: Zabezpiecza i zarzdza dostpem do API.

Te usugi maj na celu wzmocnienie ochrony danych i uproszczenie dostpu u偶ytkownik贸w, zwikszajc zar贸wno bezpieczestwo, jak i wygod. Wszechstronno rozwiza Okta sprawia, 偶e s one popularnym wyborem w r贸偶nych bran偶ach, korzystnym dla du偶ych przedsibiorstw, maych firm i indywidualnych deweloper贸w. Na dzie ostatniej aktualizacji we wrzeniu 2021 roku, Okta jest uznawana za znaczcy podmiot w dziedzinie zarzdzania to偶samoci i dostpem (IAM).

{% hint style="danger" %}
G贸wnym celem Okta jest skonfigurowanie dostpu dla r贸偶nych u偶ytkownik贸w i grup do zewntrznych aplikacji. Jeli uda Ci si **przej uprawnienia administratora w rodowisku Okta**, prawdopodobnie bdziesz w stanie **przej wszystkie inne platformy, z kt贸rych korzysta firma**.
{% endhint %}

{% hint style="success" %}
Aby przeprowadzi przegld bezpieczestwa rodowiska Okta, powiniene poprosi o **dostp administratora tylko do odczytu**.
{% endhint %}

### Podsumowanie

Istniej **u偶ytkownicy** (kt贸rzy mog by **przechowywani w Okta**, logowani z skonfigurowanych **Identity Providers** lub uwierzytelniani przez **Active Directory** lub LDAP).\
Ci u偶ytkownicy mog by w **grupach**.\
Istniej r贸wnie偶 **uwierzytelniacze**: r贸偶ne opcje uwierzytelniania, takie jak haso, oraz kilka 2FA, takich jak WebAuthn, email, telefon, okta verify (mog by wczone lub wyczone)...

Nastpnie s **aplikacje** zsynchronizowane z Okta. Ka偶da aplikacja bdzie miaa pewne **mapowanie z Okta** do udostpniania informacji (takich jak adresy email, imiona...). Ponadto ka偶da aplikacja musi by w **Polityce Uwierzytelniania**, kt贸ra wskazuje **potrzebne uwierzytelniacze** dla u偶ytkownika, aby **uzyska dostp** do aplikacji.

{% hint style="danger" %}
Najpot偶niejsz rol jest **Super Administrator**.

Jeli atakujcy przejmie Okta z dostpem administratora, wszystkie **aplikacje ufajce Okta** bd prawdopodobnie **przejte**.
{% endhint %}

## Ataki

### Lokalizowanie Portalu Okta

Zazwyczaj portal firmy bdzie znajdowa si na **companyname.okta.com**. Jeli nie, spr贸buj prostych **wariacji** **companyname.** Jeli nie mo偶esz go znale藕, mo偶liwe jest r贸wnie偶, 偶e organizacja ma rekord **CNAME** jak **`okta.companyname.com`** wskazujcy na **portal Okta**.

### Logowanie do Okta przez Kerberos

Jeli **`companyname.kerberos.okta.com`** jest aktywne, **Kerberos jest u偶ywany do dostpu do Okta**, zazwyczaj omijajc **MFA** dla u偶ytkownik贸w **Windows**. Aby znale藕 u偶ytkownik贸w Okta uwierzytelnianych przez Kerberos w AD, uruchom **`getST.py`** z **odpowiednimi parametrami**. Po uzyskaniu **biletu u偶ytkownika AD**, **wstrzyknij** go do kontrolowanego hosta za pomoc narzdzi takich jak Rubeus lub Mimikatz, upewniajc si, 偶e **`clientname.kerberos.okta.com` jest w strefie "Intranet" w Opcjach Internetowych**. Dostp do okrelonego URL powinien zwr贸ci odpowied藕 JSON "OK", wskazujc na akceptacj biletu Kerberos i przyznanie dostpu do pulpitu Okta.

Przejcie **konta usugi Okta z delegacj SPN umo偶liwia atak Silver Ticket.** Jednak偶e, u偶ycie przez Okta **AES** do szyfrowania bilet贸w wymaga posiadania klucza AES lub hasa w postaci jawnej. U偶yj **`ticketer.py` do wygenerowania biletu dla u偶ytkownika ofiary** i dostarcz go przez przegldark, aby uwierzytelni si w Okta.

**Sprawd藕 atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejcie Okta AD Agent

Ta technika polega na **dostpie do Okta AD Agent na serwerze**, kt贸ry **synchronizuje u偶ytkownik贸w i obsuguje uwierzytelnianie**. Poprzez analiz i odszyfrowanie konfiguracji w **`OktaAgentService.exe.config`**, zwaszcza AgentToken za pomoc **DPAPI**, atakujcy mo偶e potencjalnie **przechwyci i manipulowa danymi uwierzytelniajcymi**. To pozwala nie tylko na **monitorowanie** i **przechwytywanie danych uwierzytelniajcych u偶ytkownik贸w** w postaci jawnej podczas procesu uwierzytelniania Okta, ale tak偶e na **odpowiadanie na pr贸by uwierzytelniania**, umo偶liwiajc nieautoryzowany dostp lub zapewniajc uniwersalne uwierzytelnianie przez Okta (podobnie jak 'klucz szkieletowy').

**Sprawd藕 atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Przejcie AD jako Administrator

Ta technika polega na przejciu Okta AD Agent poprzez najpierw uzyskanie kodu OAuth, a nastpnie 偶danie tokena API. Token jest powizany z domen AD, a **konektor jest nazwany, aby ustanowi faszywy agent AD**. Inicjalizacja pozwala agentowi na **przetwarzanie pr贸b uwierzytelniania**, przechwytywanie danych uwierzytelniajcych za pomoc API Okta. Dostpne s narzdzia automatyzujce ten proces, oferujc pynny spos贸b przechwytywania i obsugi danych uwierzytelniajcych w rodowisku Okta.

**Sprawd藕 atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

### Faszywy Dostawca SAML Okta

**Sprawd藕 atak na** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**.**

Technika polega na **wdro偶eniu faszywego dostawcy SAML**. Poprzez integracj zewntrznego dostawcy to偶samoci (IdP) w ramach Okta za pomoc uprzywilejowanego konta, atakujcy mog **kontrolowa IdP, zatwierdzajc dowolne 偶danie uwierzytelnienia wedug wasnego uznania**. Proces obejmuje skonfigurowanie IdP SAML 2.0 w Okta, manipulowanie URL IdP Single Sign-On do przekierowania przez lokalny plik hosts, generowanie samopodpisanego certyfikatu i konfigurowanie ustawie Okta, aby dopasowa si do nazwy u偶ytkownika lub adresu email. Pomylne wykonanie tych krok贸w pozwala na uwierzytelnienie jako dowolny u偶ytkownik Okta, omijajc potrzeb posiadania indywidualnych danych uwierzytelniajcych u偶ytkownik贸w, znacznie podnoszc kontrol dostpu w spos贸b potencjalnie niezauwa偶ony.

### Phishing Portalu Okta z Evilgnix

W [**tym wpisie na blogu**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) jest wyjanione, jak przygotowa kampani phishingow przeciwko portalowi Okta.

### Atak na Podszywanie si pod Koleg

**Atrybuty, kt贸re ka偶dy u偶ytkownik mo偶e mie i modyfikowa** (takie jak email lub imi) mog by skonfigurowane w Okta. Jeli **aplikacja** **ufa** jako ID **atrybutowi**, kt贸ry u偶ytkownik mo偶e **zmodyfikowa**, bdzie on w stanie **podszy si pod innych u偶ytkownik贸w na tej platformie**.

Dlatego, jeli aplikacja ufa polu **`userName`**, prawdopodobnie nie bdziesz w stanie go zmieni (poniewa偶 zazwyczaj nie mo偶na zmieni tego pola), ale jeli ufa na przykad **`primaryEmail`**, mo偶esz by w stanie **zmieni go na adres email kolegi** i si pod niego podszy (bdziesz musia mie dostp do emaila i zaakceptowa zmian).

Nale偶y zauwa偶y, 偶e to podszywanie si zale偶y od tego, jak ka偶da aplikacja zostaa skonfigurowana. Tylko te, kt贸re ufaj polu, kt贸re zmodyfikowae i akceptuj aktualizacje, bd skompromitowane.\
Dlatego aplikacja powinna mie to pole wczone, jeli istnieje:

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

Widziaem r贸wnie偶 inne aplikacje, kt贸re byy podatne, ale nie miay tego pola w ustawieniach Okta (na kocu r贸偶ne aplikacje s konfigurowane r贸偶nie).

Najlepszym sposobem, aby dowiedzie si, czy mo偶esz podszy si pod kogo w ka偶dej aplikacji, byoby to wypr贸bowa!

## Omijanie polityk wykrywania behawioralnego <a href="#id-9fde" id="id-9fde"></a>

Polityki wykrywania behawioralnego w Okta mog by nieznane, dop贸ki nie zostan napotkane, ale **omijanie** ich mo偶na osign poprzez **celowanie bezporednio w aplikacje Okta**, unikajc g贸wnego pulpitu Okta. Majc **token dostpu Okta**, odtw贸rz token na **specyficznym dla aplikacji URL Okta** zamiast na g贸wnej stronie logowania.

Kluczowe zalecenia obejmuj:

* **Unikaj u偶ywania** popularnych serwer贸w proxy i usug VPN podczas odtwarzania przechwyconych token贸w dostpu.
* Upewnij si, 偶e **cigi user-agent** s sp贸jne midzy klientem a odtwarzanymi tokenami dostpu.
* **Powstrzymaj si od odtwarzania** token贸w r贸偶nych u偶ytkownik贸w z tego samego adresu IP.
* Zachowaj ostro偶no podczas odtwarzania token贸w na pulpicie Okta.
* Jeli znasz adresy IP firmy ofiary, **ogranicz ruch** do tych adres贸w IP lub ich zakresu, blokujc cay inny ruch.

## Okta Hardening

Okta ma wiele mo偶liwych konfiguracji, na tej stronie znajdziesz, jak je przeglda, aby byy jak najbardziej bezpieczne:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Odnoniki

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
