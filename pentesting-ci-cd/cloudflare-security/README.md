# Cloudflare Security

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

En una cuenta de Cloudflare hay algunas **configuraciones y servicios generales** que se pueden configurar. En esta p谩gina vamos a **analizar las configuraciones relacionadas con la seguridad de cada secci贸n:**

<figure><img src="../../.gitbook/assets/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

Revisa cada uno con:

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

### Domain Registration

* [ ] En **`Transfer Domains`** verifica que no sea posible transferir ning煤n dominio.

Revisa cada uno con:

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

## Analytics

_No pude encontrar nada para revisar en una configuraci贸n de seguridad._

## Pages

En cada p谩gina de Cloudflare:

* [ ] Verifica **informaci贸n sensible** en el **`Build log`**.
* [ ] Verifica **informaci贸n sensible** en el **repositorio de Github** asignado a las p谩ginas.
* [ ] Verifica un posible compromiso del repositorio de github a trav茅s de **workflow command injection** o compromiso de `pull_request_target`. M谩s informaci贸n en la [**p谩gina de Seguridad de Github**](../github-security/).
* [ ] Verifica **funciones vulnerables** en el directorio `/fuctions` (si existe), verifica los **redireccionamientos** en el archivo `_redirects` (si existe) y **encabezados mal configurados** en el archivo `_headers` (si existe).
* [ ] Verifica **vulnerabilidades** en la **p谩gina web** a trav茅s de **blackbox** o **whitebox** si puedes **acceder al c贸digo**.
* [ ] En los detalles de cada p谩gina `/<page_id>/pages/view/blocklist/settings/functions`. Verifica **informaci贸n sensible** en las **`Environment variables`**.
* [ ] En la p谩gina de detalles, verifica tambi茅n el **comando de construcci贸n** y el **directorio ra铆z** para **posibles inyecciones** que comprometan la p谩gina.

## **Workers**

En cada worker de Cloudflare verifica:

* [ ] Los disparadores: 驴Qu茅 hace que el worker se dispare? 驴Puede un **usuario enviar datos** que ser谩n **usados** por el worker?
* [ ] En las **`Settings`**, verifica **`Variables`** que contengan **informaci贸n sensible**.
* [ ] Verifica el **c贸digo del worker** y busca **vulnerabilidades** (especialmente en lugares donde el usuario puede gestionar la entrada).
* Verifica SSRFs que devuelvan la p谩gina indicada que puedes controlar.
* Verifica XSSs ejecutando JS dentro de una imagen svg.
* Es posible que el worker interact煤e con otros servicios internos. Por ejemplo, un worker puede interactuar con un bucket R2 almacenando informaci贸n obtenida de la entrada. En ese caso, ser铆a necesario verificar qu茅 capacidades tiene el worker sobre el bucket R2 y c贸mo podr铆a ser abusado desde la entrada del usuario.

{% hint style="warning" %}
Ten en cuenta que por defecto un **Worker tiene una URL** como `<worker-name>.<account>.workers.dev`. El usuario puede configurarlo en un **subdominio** pero siempre puedes acceder a 茅l con esa **URL original** si la conoces.
{% endhint %}

## R2

En cada bucket R2 verifica:

* [ ] Configura la **CORS Policy**.

## Stream

TODO

## Images

TODO

## Security Center

* [ ] Si es posible, ejecuta un **`Security Insights`** **scan** y un **`Infrastructure`** **scan**, ya que **resaltar谩n** informaci贸n interesante en t茅rminos de **seguridad**.
* [ ] Solo **verifica esta informaci贸n** para configuraciones de seguridad incorrectas e informaci贸n interesante.

## Turnstile

TODO

## **Zero Trust**

{% content-ref url="cloudflare-zero-trust-network.md" %}
[cloudflare-zero-trust-network.md](cloudflare-zero-trust-network.md)
{% endcontent-ref %}

## Bulk Redirects

{% hint style="info" %}
A diferencia de [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/), [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) son esencialmente est谩ticos: no **soportan operaciones de reemplazo de cadenas** ni expresiones regulares. Sin embargo, puedes configurar par谩metros de redirecci贸n de URL que afecten su comportamiento de coincidencia de URL y su comportamiento en tiempo de ejecuci贸n.
{% endhint %}

* [ ] Verifica que las **expresiones** y **requisitos** para redirecciones **tengan sentido**.
* [ ] Verifica tambi茅n **endpoints sensibles ocultos** que contengan informaci贸n interesante.

## Notifications

* [ ] Verifica las **notificaciones.** Estas notificaciones son recomendadas para seguridad:
* `Usage Based Billing`
* `HTTP DDoS Attack Alert`
* `Layer 3/4 DDoS Attack Alert`
* `Advanced HTTP DDoS Attack Alert`
* `Advanced Layer 3/4 DDoS Attack Alert`
* `Flow-based Monitoring: Volumetric Attack`
* `Route Leak Detection Alert`
* `Access mTLS Certificate Expiration Alert`
* `SSL for SaaS Custom Hostnames Alert`
* `Universal SSL Alert`
* `Script Monitor New Code Change Detection Alert`
* `Script Monitor New Domain Alert`
* `Script Monitor New Malicious Domain Alert`
* `Script Monitor New Malicious Script Alert`
* `Script Monitor New Malicious URL Alert`
* `Script Monitor New Scripts Alert`
* `Script Monitor New Script Exceeds Max URL Length Alert`
* `Advanced Security Events Alert`
* `Security Events Alert`
* [ ] Verifica todos los **destinos**, ya que podr铆a haber **informaci贸n sensible** (autenticaci贸n b谩sica http) en las urls de webhook. Aseg煤rate tambi茅n de que las urls de webhook usen **HTTPS**.
* [ ] Como verificaci贸n adicional, podr铆as intentar **suplantar una notificaci贸n de cloudflare** a un tercero, tal vez puedas de alguna manera **inyectar algo peligroso**.

## Manage Account

* [ ] Es posible ver los **煤ltimos 4 d铆gitos de la tarjeta de cr茅dito**, el **tiempo de expiraci贸n** y la **direcci贸n de facturaci贸n** en **`Billing` -> `Payment info`**.
* [ ] Es posible ver el **tipo de plan** usado en la cuenta en **`Billing` -> `Subscriptions`**.
* [ ] En **`Members`** es posible ver todos los miembros de la cuenta y su **rol**. Ten en cuenta que si el tipo de plan no es Enterprise, solo existen 2 roles: Administrador y Super Administrador. Pero si el **plan usado es Enterprise**, [**m谩s roles**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) pueden ser usados para seguir el principio de menor privilegio.
* Por lo tanto, siempre que sea posible se **recomienda** usar el **plan Enterprise**.
* [ ] En Members es posible verificar qu茅 **miembros** tienen **2FA habilitado**. **Cada** usuario deber铆a tenerlo habilitado.

{% hint style="info" %}
Ten en cuenta que afortunadamente el rol **`Administrator`** no da permisos para gestionar membres铆as (**no puede escalar privilegios ni invitar** a nuevos miembros).
{% endhint %}

## DDoS Investigation

[Revisa esta parte](cloudflare-domains.md#cloudflare-ddos-protection).

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
