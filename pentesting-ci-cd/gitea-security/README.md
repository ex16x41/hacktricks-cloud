# Gitea Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## What is Gitea

**Gitea** es una **soluci칩n de alojamiento de c칩digo ligera gestionada por la comunidad y autoalojada** escrita en Go.

![](<../../.gitbook/assets/image (160).png>)

### Basic Information

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Lab

Para ejecutar una instancia de Gitea localmente, solo puedes ejecutar un contenedor de docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Con칠ctese al puerto 3000 para acceder a la p치gina web.

Tambi칠n podr칤a ejecutarlo con kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumeraci칩n No Autenticada

* Repos p칰blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usuarios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizaciones registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Ten en cuenta que por **defecto Gitea permite que nuevos usuarios se registren**. Esto no dar치 un acceso especialmente interesante a los nuevos usuarios sobre otros repos de organizaciones/usuarios, pero un **usuario autenticado** podr칤a **visualizar m치s repos u organizaciones**.

## Explotaci칩n Interna

Para este escenario vamos a suponer que has obtenido alg칰n acceso a una cuenta de github.

### Con Credenciales de Usuario/Cookie Web

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci칩n (o robaste una cookie de sesi칩n) puedes **simplemente iniciar sesi칩n** y verificar qu칠 **permisos tienes** sobre qu칠 **repos,** en **qu칠 equipos** est치s, **listar otros usuarios**, y **c칩mo est치n protegidos los repos.**

Ten en cuenta que **se puede usar 2FA** as칤 que solo podr치s acceder a esta informaci칩n si tambi칠n puedes **pasar esa verificaci칩n**.

{% hint style="info" %}
Ten en cuenta que si **logras robar la cookie `i_like_gitea`** (actualmente configurada con SameSite: Lax) puedes **suplantar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

### Con Clave SSH de Usuario

Gitea permite a **los usuarios** establecer **claves SSH** que se utilizar치n como **m칠todo de autenticaci칩n para desplegar c칩digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de gitea para enumerar el entorno. Sin embargo, puedes **enumerar configuraciones locales** para obtener informaci칩n sobre los repos y el usuario al que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de gitea, puedes acceder a las **claves p칰blicas que ha establecido** en su cuenta en _https://github.com/\<gitea\_username>.keys_, podr칤as verificar esto para confirmar que la clave privada que encontraste puede ser utilizada.

**Las claves SSH** tambi칠n se pueden establecer en los repositorios como **claves de despliegue**. Cualquiera con acceso a esta clave podr치 **lanzar proyectos desde un repositorio**. Usualmente, en un servidor con diferentes claves de despliegue, el archivo local **`~/.ssh/config`** te dar치 informaci칩n sobre a qu칠 clave est치 relacionada.

#### Claves GPG

Como se explic칩 [**aqu칤**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md), a veces es necesario firmar los commits o podr칤as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para una introducci칩n sobre [**Tokens de Usuario consulta la informaci칩n b치sica**](basic-gitea-information.md#personal-access-tokens).

Un token de usuario puede ser utilizado **en lugar de una contrase침a** para **autenticarse** contra el servidor de Gitea [**a trav칠s de la API**](https://try.gitea.io/api/swagger#/). tendr치 **acceso completo** sobre el usuario.

### Con Aplicaci칩n Oauth

Para una introducci칩n sobre [**Aplicaciones Oauth de Gitea consulta la informaci칩n b치sica**](./#with-oauth-application).

Un atacante podr칤a crear una **Aplicaci칩n Oauth maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que probablemente la acepten como parte de una campa침a de phishing.

Como se explic칩 en la informaci칩n b치sica, la aplicaci칩n tendr치 **acceso total sobre la cuenta del usuario**.

### Bypass de Protecci칩n de Ramas

En Github tenemos **github actions** que por defecto obtienen un **token con acceso de escritura** sobre el repositorio que puede ser utilizado para **eludir las protecciones de ramas**. En este caso eso **no existe**, por lo que los bypass son m치s limitados. Pero veamos qu칠 se puede hacer:

* **Habilitar Push**: Si alguien con acceso de escritura puede hacer push a la rama, simplemente haz push a ella.
* **Whitelist Restricted Push**: De la misma manera, si eres parte de esta lista haz push a la rama.
* **Habilitar Merge Whitelist**: Si hay una lista blanca de merges, necesitas estar dentro de ella.
* **Requerir aprobaciones es mayor que 0**: Entonces... necesitas comprometer a otro usuario.
* **Restringir aprobaciones a los que est치n en la lista blanca**: Si solo los usuarios en la lista blanca pueden aprobar... necesitas comprometer a otro usuario que est칠 dentro de esa lista.
* **Desestimar aprobaciones obsoletas**: Si las aprobaciones no se eliminan con nuevos commits, podr칤as secuestrar un PR ya aprobado para inyectar tu c칩digo y fusionar el PR.

Ten en cuenta que **si eres un administrador de org/repositorio** puedes eludir las protecciones.

### Enumerar Webhooks

**Webhooks** son capaces de **enviar informaci칩n espec칤fica de gitea a algunos lugares**. Podr칤as ser capaz de **explotar esa comunicaci칩n**.\
Sin embargo, generalmente se establece un **secreto** que no puedes **recuperar** en el **webhook** que **previene** que usuarios externos que conocen la URL del webhook pero no el secreto **exploten ese webhook**.\
Pero en algunas ocasiones, las personas en lugar de establecer el **secreto** en su lugar, lo **establecen en la URL** como un par치metro, por lo que **verificar las URLs** podr칤a permitirte **encontrar secretos** y otros lugares que podr칤as explotar m치s adelante.

Los webhooks pueden ser establecidos a **nivel de repositorio y de organizaci칩n**.

## Post Explotaci칩n

### Dentro del servidor

Si de alguna manera lograste entrar en el servidor donde se est치 ejecutando gitea, deber칤as buscar el archivo de configuraci칩n de gitea. Por defecto se encuentra en `/data/gitea/conf/app.ini`

En este archivo puedes encontrar **claves** y **contrase침as**.

En la ruta de gitea (por defecto: /data/gitea) tambi칠n puedes encontrar informaci칩n interesante como:

* La base de datos **sqlite**: Si gitea no est치 utilizando una base de datos externa, utilizar치 una base de datos sqlite.
* Las **sesiones** dentro de la carpeta de sesiones: Ejecutando `cat sessions/*/*/*` puedes ver los nombres de usuario de los usuarios conectados (gitea tambi칠n podr칤a guardar las sesiones dentro de la base de datos).
* La **clave privada jwt** dentro de la carpeta jwt.
* M치s **informaci칩n sensible** podr칤a encontrarse en esta carpeta.

Si est치s dentro del servidor tambi칠n puedes **usar el binario `gitea`** para acceder/modificar informaci칩n:

* `gitea dump` volcar치 gitea y generar치 un archivo .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generar치 un token del tipo indicado (persistencia).
* `gitea admin user change-password --username admin --password newpassword` Cambia la contrase침a.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crea un nuevo usuario administrador y obtiene un token de acceso.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
