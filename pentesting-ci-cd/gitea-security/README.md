# Sicurezza di Gitea

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository github.

</details>
{% endhint %}

## Cos'√® Gitea

**Gitea** √® una soluzione di **hosting di codice leggero gestita dalla comunit√† e auto-ospitata** scritta in Go.

![](<../../.gitbook/assets/image (160).png>)

### Informazioni di base

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratorio

Per eseguire un'istanza di Gitea localmente, puoi semplicemente eseguire un container docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Connettiti alla porta 3000 per accedere alla pagina web.

Puoi anche eseguirlo con kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumerazione non autenticata

* Repo pubblici: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Utenti registrati: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizzazioni registrate: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Nota che per **default Gitea consente a nuovi utenti di registrarsi**. Questo non dar√† accesso particolarmente interessante ai nuovi utenti su altri repo di organizzazioni/utenti, ma un **utente autenticato** potrebbe essere in grado di **visualizzare pi√π repo o organizzazioni**.

## Sfruttamento Interno

Per questo scenario supponiamo che tu abbia ottenuto un certo accesso a un account github.

### Con Credenziali Utente/Cookie Web

Se in qualche modo hai gi√† le credenziali per un utente all'interno di un'organizzazione (o hai rubato un cookie di sessione) puoi **semplicemente accedere** e controllare quali **permessi hai** su quali **repo,** in **quali team** sei, **elencare altri utenti**, e **come sono protetti i repo.**

Nota che **2FA potrebbe essere utilizzato** quindi potrai accedere a queste informazioni solo se riesci anche a **superare quel controllo**.

{% hint style="info" %}
Nota che se riesci a **rubare il cookie `i_like_gitea`** (attualmente configurato con SameSite: Lax) puoi **impersonare completamente l'utente** senza bisogno di credenziali o 2FA.
{% endhint %}

### Con Chiave SSH Utente

Gitea consente agli **utenti** di impostare **chiavi SSH** che verranno utilizzate come **metodo di autenticazione per distribuire codice** per loro conto (non viene applicata 2FA).

Con questa chiave puoi effettuare **modifiche nei repository dove l'utente ha alcuni privilegi**, tuttavia non puoi usarla per accedere all'api di gitea per enumerare l'ambiente. Tuttavia, puoi **enumerare le impostazioni locali** per ottenere informazioni sui repo e sugli utenti a cui hai accesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se l'utente ha configurato il proprio nome utente come il suo nome utente gitea, puoi accedere alle **chiavi pubbliche che ha impostato** nel suo account in _https://github.com/\<gitea\_username>.keys_, puoi controllare questo per confermare che la chiave privata che hai trovato pu√≤ essere utilizzata.

**Le chiavi SSH** possono anche essere impostate nei repository come **chiavi di distribuzione**. Chiunque abbia accesso a questa chiave sar√† in grado di **lanciare progetti da un repository**. Di solito, in un server con diverse chiavi di distribuzione, il file locale **`~/.ssh/config`** ti dar√† informazioni su quale chiave √® correlata.

#### Chiavi GPG

Come spiegato [**qui**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md), a volte √® necessario firmare i commit o potresti essere scoperto.

Controlla localmente se l'utente corrente ha qualche chiave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token Utente

Per un'introduzione sui [**Token Utente controlla le informazioni di base**](basic-gitea-information.md#personal-access-tokens).

Un token utente pu√≤ essere utilizzato **invece di una password** per **autenticarsi** contro il server Gitea [**via API**](https://try.gitea.io/api/swagger#/). avr√† **accesso completo** sull'utente.

### Con Applicazione Oauth

Per un'introduzione sulle [**Applicazioni Oauth di Gitea controlla le informazioni di base**](./#with-oauth-application).

Un attaccante potrebbe creare un'**Applicazione Oauth malevola** per accedere a dati/azioni privilegiati degli utenti che probabilmente li accettano come parte di una campagna di phishing.

Come spiegato nelle informazioni di base, l'applicazione avr√† **accesso completo all'account utente**.

### Bypass della Protezione dei Branch

In Github abbiamo le **github actions** che per impostazione predefinita ottengono un **token con accesso in scrittura** sul repo che pu√≤ essere utilizzato per **bypassare le protezioni dei branch**. In questo caso che **non esiste**, quindi i bypass sono pi√π limitati. Ma diamo un'occhiata a cosa pu√≤ essere fatto:

* **Abilita Push**: Se chiunque con accesso in scrittura pu√≤ pushare sul branch, basta pushare su di esso.
* **Whitelist Push Ristretto**: Allo stesso modo, se fai parte di questo elenco push sul branch.
* **Abilita Whitelist Merge**: Se c'√® una whitelist di merge, devi essere all'interno di essa.
* **Richiedi approvazioni maggiori di 0**: Allora... devi compromettere un altro utente.
* **Restrigi approvazioni a utenti in whitelist**: Se solo gli utenti in whitelist possono approvare... devi compromettere un altro utente che √® all'interno di quell'elenco.
* **Annulla approvazioni scadute**: Se le approvazioni non vengono rimosse con nuovi commit, potresti dirottare una PR gi√† approvata per iniettare il tuo codice e unire la PR.

Nota che **se sei un admin di org/repo** puoi bypassare le protezioni.

### Enumerare Webhook

I **Webhook** sono in grado di **inviare informazioni specifiche di gitea in alcuni luoghi**. Potresti essere in grado di **sfruttare quella comunicazione**.\
Tuttavia, di solito un **segreto** che non puoi **recuperare** √® impostato nel **webhook** che **prevenir√†** gli utenti esterni che conoscono l'URL del webhook ma non il segreto di **sfruttare quel webhook**.\
Ma in alcune occasioni, le persone invece di impostare il **segreto** al suo posto, lo **impostano nell'URL** come parametro, quindi **controllare gli URL** potrebbe permetterti di **trovare segreti** e altri luoghi che potresti sfruttare ulteriormente.

I webhook possono essere impostati a **livello di repo e di org**.

## Post Sfruttamento

### All'interno del server

Se in qualche modo sei riuscito a entrare nel server dove gira gitea, dovresti cercare il file di configurazione di gitea. Per impostazione predefinita si trova in `/data/gitea/conf/app.ini`

In questo file puoi trovare **chiavi** e **password**.

Nel percorso gitea (per impostazione predefinita: /data/gitea) puoi trovare anche informazioni interessanti come:

* Il DB **sqlite**: Se gitea non utilizza un db esterno utilizzer√† un db sqlite.
* Le **sessioni** all'interno della cartella delle sessioni: Eseguendo `cat sessions/*/*/*` puoi vedere i nomi utente degli utenti connessi (gitea potrebbe anche salvare le sessioni all'interno del DB).
* La **chiave privata jwt** all'interno della cartella jwt.
* Maggiore **informazioni sensibili** potrebbero essere trovate in questa cartella.

Se sei all'interno del server puoi anche **utilizzare il binario `gitea`** per accedere/modificare informazioni:

* `gitea dump` eseguir√† il dump di gitea e generer√† un file .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generer√† un token del tipo indicato (persistenza).
* `gitea admin user change-password --username admin --password newpassword` Cambia la password.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crea un nuovo utente admin e ottieni un token di accesso.

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
