# Gitea Security

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>
{% endhint %}

## Giteaとは

**Gitea**は**自己ホスト型のコミュニティ管理の軽量コードホスティング**ソリューションで、Goで書かれています。

![](<../../.gitbook/assets/image (160).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

Giteaインスタンスをローカルで実行するには、Dockerコンテナを実行するだけです：
```bash
docker run -p 3000:3000 gitea/gitea
```
ポート3000に接続してウェブページにアクセスします。

Kubernetesで実行することもできます：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 認証されていない列挙

* 公開リポジトリ: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 登録ユーザー: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 登録組織: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

**デフォルトではGiteaは新しいユーザーの登録を許可します**。これにより、新しいユーザーは他の組織やユーザーのリポジトリに対して特に興味深いアクセスを得ることはありませんが、**ログインしたユーザー**は**より多くのリポジトリや組織を視覚化できる**かもしれません。

## 内部悪用

このシナリオでは、あなたがgithubアカウントへのアクセスを取得したと仮定します。

### ユーザー資格情報/ウェブクッキーを使用して

もしあなたが組織内のユーザーの資格情報を何らかの方法で持っている場合（またはセッションクッキーを盗んだ場合）、**ただログイン**して、**どのリポジトリに対してどのような権限を持っているか**、**どのチームに所属しているか**、**他のユーザーのリスト**、および**リポジトリがどのように保護されているか**を確認できます。

**2FAが使用される可能性がある**ため、そのチェックを**通過できる**場合にのみ、この情報にアクセスできることに注意してください。

{% hint style="info" %}
もしあなたが**`i_like_gitea`クッキーを盗むことに成功した場合**（現在SameSite: Laxで設定されています）、資格情報や2FAを必要とせずに**ユーザーを完全に偽装**することができます。
{% endhint %}

### ユーザーSSHキーを使用して

Giteaは**ユーザー**が**SSHキー**を設定することを許可しており、これが**コードをデプロイするための認証方法**として使用されます（2FAは適用されません）。

このキーを使用して、**ユーザーがいくつかの権限を持つリポジトリで変更を行う**ことができますが、gitea APIにアクセスして環境を列挙するためには使用できません。ただし、**ローカル設定を列挙**して、アクセスできるリポジトリやユーザーに関する情報を取得できます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のgiteaユーザー名としてユーザー名を設定している場合、_https://github.com/\<gitea\_username>.keys_ で彼のアカウントに設定された**公開鍵**にアクセスできます。これを確認して、見つけた秘密鍵が使用できるかどうかを確認できます。

**SSH鍵**はリポジトリに**デプロイ鍵**としても設定できます。この鍵にアクセスできる人は、**リポジトリからプロジェクトを起動**できるようになります。通常、異なるデプロイ鍵を持つサーバーでは、ローカルファイル**`~/.ssh/config`**が関連する鍵に関する情報を提供します。

#### GPG鍵

[**こちら**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md)で説明されているように、コミットに署名する必要がある場合や、発見される可能性があります。

現在のユーザーが鍵を持っているかどうかをローカルで確認してください:
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用して

[**ユーザートークンについての基本情報を確認する**](basic-gitea-information.md#personal-access-tokens)の紹介。

ユーザートークンは、Giteaサーバーに**API経由で認証**するために**パスワードの代わりに使用**できます。ユーザーに対して**完全なアクセス権**を持ちます。

### Oauthアプリケーションを使用して

[**Gitea Oauthアプリケーションについての基本情報を確認する**](./#with-oauth-application)の紹介。

攻撃者は、フィッシングキャンペーンの一環として、ユーザーが受け入れる可能性のある**悪意のあるOauthアプリケーション**を作成して、特権データやアクションにアクセスするかもしれません。

基本情報で説明されているように、アプリケーションは**ユーザーアカウントに対して完全なアクセス権**を持ちます。

### ブランチ保護のバイパス

Githubには、デフォルトでリポジトリに対して**書き込みアクセスを持つトークン**を取得する**github actions**があります。これを使用して**ブランチ保護をバイパス**できます。この場合、**それは存在しない**ため、バイパスはより制限されます。しかし、何ができるか見てみましょう：

* **プッシュを有効にする**: 書き込みアクセスを持つ誰かがブランチにプッシュできる場合、単にプッシュします。
* **制限されたプッシュをホワイトリストに追加**: 同様に、このリストの一部であればブランチにプッシュします。
* **マージホワイトリストを有効にする**: マージホワイトリストがある場合、その中にいる必要があります。
* **承認が0より大きいことを要求**: それなら...別のユーザーを妥協する必要があります。
* **承認をホワイトリストに制限**: ホワイトリストに登録されたユーザーのみが承認できる場合...そのリストにいる別のユーザーを妥協する必要があります。
* **古い承認を無効にする**: 新しいコミットで承認が削除されない場合、すでに承認されたPRをハイジャックしてコードを挿入し、PRをマージできます。

**あなたがorg/repoの管理者である場合**、保護をバイパスできます。

### ウェブフックの列挙

**ウェブフック**は、**特定のgitea情報をいくつかの場所に送信**することができます。その通信を**悪用する**ことができるかもしれません。\
しかし、通常、**秘密**は**ウェブフック**に設定されており、URLを知っている外部ユーザーがその秘密を知らない場合、**そのウェブフックを悪用することを防ぎます**。\
しかし、時には、人々が**秘密**をその場所に設定する代わりに、**URLにパラメータとして設定する**ことがあります。そのため、**URLを確認することで**、**秘密を見つける**ことや、さらに悪用できる他の場所を見つけることができるかもしれません。

ウェブフックは**リポジトリと組織レベル**で設定できます。

## ポストエクスプロイテーション

### サーバー内

もし何らかの方法でgiteaが実行されているサーバーに入ることができたら、giteaの設定ファイルを探すべきです。デフォルトでは、`/data/gitea/conf/app.ini`にあります。

このファイルには**キー**や**パスワード**が含まれています。

giteaのパス（デフォルト：/data/gitea）には、次のような興味深い情報も見つかります：

* **sqlite** DB: giteaが外部DBを使用していない場合、sqlite DBを使用します。
* **セッション**フォルダー内の**セッション**: `cat sessions/*/*/*`を実行すると、ログインしているユーザーのユーザー名を見ることができます（giteaはセッションをDB内に保存することもあります）。
* **jwtプライベートキー**がjwtフォルダー内にあります。
* このフォルダー内には、さらに**機密情報**が見つかる可能性があります。

サーバー内にいる場合、**`gitea`バイナリを使用して情報にアクセス/変更**することもできます：

* `gitea dump`はgiteaをダンプし、.zipファイルを生成します。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`は指定されたタイプのトークンを生成します（永続性）。
* `gitea admin user change-password --username admin --password newpassword` パスワードを変更します。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理ユーザーを作成し、アクセストークンを取得します。

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。**

</details>
{% endhint %}
