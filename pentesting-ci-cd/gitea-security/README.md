# Gitea Security

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## Co to jest Gitea

**Gitea** to **samodzielnie hostowane, zarzÄ…dzane przez spoÅ‚ecznoÅ›Ä‡ lekkie rozwiÄ…zanie do hostowania kodu** napisane w Go.

![](<../../.gitbook/assets/image (160).png>)

### Podstawowe Informacje

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Lab

Aby uruchomiÄ‡ instancjÄ™ Gitea lokalnie, moÅ¼esz po prostu uruchomiÄ‡ kontener docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
PoÅ‚Ä…cz siÄ™ z portem 3000, aby uzyskaÄ‡ dostÄ™p do strony internetowej.

MoÅ¼esz rÃ³wnieÅ¼ uruchomiÄ‡ to za pomocÄ… kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Niezautoryzowana Enumeracja

* Publiczne repozytoria: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Zarejestrowani uÅ¼ytkownicy: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Zarejestrowane Organizacje: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e **domyÅ›lnie Gitea pozwala na rejestracjÄ™ nowych uÅ¼ytkownikÃ³w**. Nie daje to specjalnie interesujÄ…cego dostÄ™pu nowym uÅ¼ytkownikom do repozytoriÃ³w innych organizacji/uÅ¼ytkownikÃ³w, ale **zalogowany uÅ¼ytkownik** moÅ¼e byÄ‡ w stanie **wizualizowaÄ‡ wiÄ™cej repozytoriÃ³w lub organizacji**.

## WewnÄ™trzna Eksploatacja

W tym scenariuszu zakÅ‚adamy, Å¼e uzyskaÅ‚eÅ› jakiÅ› dostÄ™p do konta github.

### Z PoÅ›wiadczeniami UÅ¼ytkownika/Web Cookie

JeÅ›li w jakiÅ› sposÃ³b masz juÅ¼ poÅ›wiadczenia uÅ¼ytkownika w organizacji (lub ukradÅ‚eÅ› cookie sesji), moÅ¼esz **po prostu siÄ™ zalogowaÄ‡** i sprawdziÄ‡, jakie **uprawnienia masz** do jakich **repozytoriÃ³w**, w **jakich zespoÅ‚ach** jesteÅ›, **listÄ™ innych uÅ¼ytkownikÃ³w** oraz **jak sÄ… chronione repozytoria**.

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e **moÅ¼e byÄ‡ uÅ¼ywane 2FA**, wiÄ™c bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do tych informacji tylko, jeÅ›li rÃ³wnieÅ¼ **przejdziesz tÄ™ kontrolÄ™**.

{% hint style="info" %}
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e jeÅ›li **uda ci siÄ™ ukraÅ›Ä‡ cookie `i_like_gitea`** (obecnie skonfigurowane z SameSite: Lax), moÅ¼esz **caÅ‚kowicie podszyÄ‡ siÄ™ pod uÅ¼ytkownika** bez potrzeby posiadania poÅ›wiadczeÅ„ lub 2FA.
{% endhint %}

### Z Kluczem SSH UÅ¼ytkownika

Gitea pozwala **uÅ¼ytkownikom** ustawiaÄ‡ **klucze SSH**, ktÃ³re bÄ™dÄ… uÅ¼ywane jako **metoda uwierzytelniania do wdraÅ¼ania kodu** w ich imieniu (nie stosuje siÄ™ 2FA).

Z tym kluczem moÅ¼esz dokonywaÄ‡ **zmian w repozytoriach, w ktÃ³rych uÅ¼ytkownik ma pewne uprawnienia**, jednak nie moÅ¼esz go uÅ¼ywaÄ‡ do uzyskiwania dostÄ™pu do api gitea w celu enumeracji Å›rodowiska. MoÅ¼esz jednak **enumerowaÄ‡ lokalne ustawienia**, aby uzyskaÄ‡ informacje o repozytoriach i uÅ¼ytkowniku, do ktÃ³rych masz dostÄ™p:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
JeÅ›li uÅ¼ytkownik skonfigurowaÅ‚ swojÄ… nazwÄ™ uÅ¼ytkownika jako swojÄ… nazwÄ™ uÅ¼ytkownika gitea, moÅ¼esz uzyskaÄ‡ dostÄ™p do **kluczy publicznych, ktÃ³re ustawiÅ‚** na swoim koncie pod adresem _https://github.com/\<gitea\_username>.keys_, moÅ¼esz to sprawdziÄ‡, aby potwierdziÄ‡, Å¼e znaleziony klucz prywatny moÅ¼e byÄ‡ uÅ¼ywany.

**Klucze SSH** mogÄ… byÄ‡ rÃ³wnieÅ¼ ustawione w repozytoriach jako **klucze wdroÅ¼eniowe**. KaÅ¼dy, kto ma dostÄ™p do tego klucza, bÄ™dzie mÃ³gÅ‚ **uruchamiaÄ‡ projekty z repozytorium**. Zazwyczaj na serwerze z rÃ³Å¼nymi kluczami wdroÅ¼eniowymi lokalny plik **`~/.ssh/config`** dostarczy informacji o powiÄ…zanych kluczach.

#### Klucze GPG

Jak wyjaÅ›niono [**tutaj**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md), czasami trzeba podpisaÄ‡ commity, inaczej moÅ¼esz zostaÄ‡ wykryty.

SprawdÅº lokalnie, czy bieÅ¼Ä…cy uÅ¼ytkownik ma jakiekolwiek klucze za pomocÄ…:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Z Tokenem UÅ¼ytkownika

Wprowadzenie do [**TokenÃ³w UÅ¼ytkownika znajdziesz w podstawowych informacjach**](basic-gitea-information.md#personal-access-tokens).

Token uÅ¼ytkownika moÅ¼e byÄ‡ uÅ¼yty **zamiast hasÅ‚a** do **uwierzytelnienia** na serwerze Gitea [**przez API**](https://try.gitea.io/api/swagger#/). BÄ™dzie miaÅ‚ **peÅ‚ny dostÄ™p** do uÅ¼ytkownika.

### Z AplikacjÄ… Oauth

Wprowadzenie do [**Aplikacji Oauth Gitea znajdziesz w podstawowych informacjach**](./#with-oauth-application).

AtakujÄ…cy moÅ¼e stworzyÄ‡ **zÅ‚oÅ›liwÄ… aplikacjÄ™ Oauth**, aby uzyskaÄ‡ dostÄ™p do uprzywilejowanych danych/dziaÅ‚aÅ„ uÅ¼ytkownikÃ³w, ktÃ³rzy je zaakceptujÄ…, prawdopodobnie w ramach kampanii phishingowej.

Jak wyjaÅ›niono w podstawowych informacjach, aplikacja bÄ™dzie miaÅ‚a **peÅ‚ny dostÄ™p do konta uÅ¼ytkownika**.

### OminiÄ™cie Ochrony GaÅ‚Ä™zi

W Github mamy **github actions**, ktÃ³re domyÅ›lnie otrzymujÄ… **token z dostÄ™pem do zapisu** do repozytorium, co moÅ¼e byÄ‡ uÅ¼yte do **ominiÄ™cia ochrony gaÅ‚Ä™zi**. W tym przypadku to **nie istnieje**, wiÄ™c obejÅ›cia sÄ… bardziej ograniczone. Ale spÃ³jrzmy, co moÅ¼na zrobiÄ‡:

* **WÅ‚Ä…cz Push**: JeÅ›li ktoÅ› z dostÄ™pem do zapisu moÅ¼e pushowaÄ‡ do gaÅ‚Ä™zi, po prostu pushuj do niej.
* **BiaÅ‚a lista ograniczonych pushÃ³w**: W ten sam sposÃ³b, jeÅ›li jesteÅ› na tej liÅ›cie, pushuj do gaÅ‚Ä™zi.
* **WÅ‚Ä…cz biaÅ‚Ä… listÄ™ merge**: JeÅ›li istnieje biaÅ‚a lista merge, musisz byÄ‡ na niej.
* **Wymagaj zatwierdzeÅ„ wiÄ™kszych niÅ¼ 0**: Wtedy... musisz skompromitowaÄ‡ innego uÅ¼ytkownika.
* **Ogranicz zatwierdzenia do biaÅ‚ej listy**: JeÅ›li tylko uÅ¼ytkownicy z biaÅ‚ej listy mogÄ… zatwierdzaÄ‡... musisz skompromitowaÄ‡ innego uÅ¼ytkownika z tej listy.
* **OdrzuÄ‡ nieaktualne zatwierdzenia**: JeÅ›li zatwierdzenia nie sÄ… usuwane przy nowych commitach, moÅ¼esz przejÄ…Ä‡ juÅ¼ zatwierdzony PR, aby wstrzyknÄ…Ä‡ swÃ³j kod i scaliÄ‡ PR.

ZauwaÅ¼, Å¼e **jeÅ›li jesteÅ› administratorem org/repo**, moÅ¼esz ominÄ…Ä‡ ochrony.

### Enumeracja WebhookÃ³w

**Webhooki** mogÄ… **wysyÅ‚aÄ‡ specyficzne informacje gitea do niektÃ³rych miejsc**. MoÅ¼esz byÄ‡ w stanie **wykorzystaÄ‡ tÄ™ komunikacjÄ™**.\
Jednak zazwyczaj ustawiany jest **sekret**, ktÃ³rego **nie moÅ¼na odzyskaÄ‡**, w **webhooku**, co **zapobiega** zewnÄ™trznym uÅ¼ytkownikom, ktÃ³rzy znajÄ… URL webhooka, ale nie sekret, przed **wykorzystaniem tego webhooka**.\
Ale czasami ludzie zamiast ustawiaÄ‡ **sekret** w odpowiednim miejscu, **ustawiajÄ… go w URL** jako parametr, wiÄ™c **sprawdzanie URL** moÅ¼e pozwoliÄ‡ na **znalezienie sekretÃ³w** i innych miejsc, ktÃ³re moÅ¼na dalej wykorzystaÄ‡.

Webhooki mogÄ… byÄ‡ ustawione na **poziomie repo i org**.

## Post Exploitation

### WewnÄ…trz serwera

JeÅ›li w jakiÅ› sposÃ³b udaÅ‚o Ci siÄ™ dostaÄ‡ do serwera, na ktÃ³rym dziaÅ‚a gitea, powinieneÅ› poszukaÄ‡ pliku konfiguracyjnego gitea. DomyÅ›lnie znajduje siÄ™ on w `/data/gitea/conf/app.ini`

W tym pliku moÅ¼na znaleÅºÄ‡ **klucze** i **hasÅ‚a**.

W Å›cieÅ¼ce gitea (domyÅ›lnie: /data/gitea) moÅ¼na znaleÅºÄ‡ rÃ³wnieÅ¼ interesujÄ…ce informacje, takie jak:

* **sqlite** DB: JeÅ›li gitea nie uÅ¼ywa zewnÄ™trznej bazy danych, bÄ™dzie uÅ¼ywaÄ‡ bazy sqlite.
* **sesje** w folderze sesji: Uruchomienie `cat sessions/*/*/*` pozwala zobaczyÄ‡ nazwy uÅ¼ytkownikÃ³w zalogowanych uÅ¼ytkownikÃ³w (gitea moÅ¼e rÃ³wnieÅ¼ zapisywaÄ‡ sesje w bazie danych).
* **prywatny klucz jwt** w folderze jwt.
* WiÄ™cej **wraÅ¼liwych informacji** moÅ¼na znaleÅºÄ‡ w tym folderze.

JeÅ›li jesteÅ› wewnÄ…trz serwera, moÅ¼esz rÃ³wnieÅ¼ **uÅ¼yÄ‡ binarki `gitea`** do dostÄ™pu/modyfikacji informacji:

* `gitea dump` zrzuci gitea i wygeneruje plik .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` wygeneruje token wskazanego typu (trwaÅ‚oÅ›Ä‡).
* `gitea admin user change-password --username admin --password newpassword` Zmieni hasÅ‚o.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Utworzy nowego uÅ¼ytkownika admina i uzyska token dostÄ™pu.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
