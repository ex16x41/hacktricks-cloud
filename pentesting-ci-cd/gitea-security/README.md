# S√©curit√© de Gitea

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Qu'est-ce que Gitea

**Gitea** est une solution **d'h√©bergement de code l√©ger g√©r√©e par la communaut√© et auto-h√©berg√©e** √©crite en Go.

![](<../../.gitbook/assets/image (160).png>)

### Informations de base

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratoire

Pour ex√©cuter une instance Gitea localement, vous pouvez simplement ex√©cuter un conteneur docker :
```bash
docker run -p 3000:3000 gitea/gitea
```
Connectez-vous au port 3000 pour acc√©der √† la page web.

Vous pouvez √©galement l'ex√©cuter avec kubernetes :
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## √ânum√©ration non authentifi√©e

* Repos publics : [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Utilisateurs enregistr√©s : [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organisations enregistr√©es : [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Notez qu'en **default Gitea permet aux nouveaux utilisateurs de s'inscrire**. Cela ne donnera pas un acc√®s particuli√®rement int√©ressant aux nouveaux utilisateurs sur les repos d'autres organisations/utilisateurs, mais un **utilisateur connect√©** pourrait √™tre en mesure de **visualiser plus de repos ou d'organisations**.

## Exploitation interne

Pour ce sc√©nario, nous allons supposer que vous avez obtenu un acc√®s √† un compte github.

### Avec les identifiants de l'utilisateur / Cookie Web

Si vous avez d'une mani√®re ou d'une autre d√©j√† des identifiants pour un utilisateur au sein d'une organisation (ou si vous avez vol√© un cookie de session), vous pouvez **simplement vous connecter** et v√©rifier quels **permissions vous avez** sur quels **repos,** dans **quelles √©quipes** vous √™tes, **lister d'autres utilisateurs**, et **comment les repos sont prot√©g√©s.**

Notez que **2FA peut √™tre utilis√©** donc vous ne pourrez acc√©der √† ces informations que si vous pouvez √©galement **passer cette v√©rification**.

{% hint style="info" %}
Notez que si vous **r√©ussissez √† voler le cookie `i_like_gitea`** (actuellement configur√© avec SameSite: Lax), vous pouvez **compl√®tement usurper l'identit√© de l'utilisateur** sans avoir besoin d'identifiants ou de 2FA.
{% endhint %}

### Avec la cl√© SSH de l'utilisateur

Gitea permet aux **utilisateurs** de d√©finir des **cl√©s SSH** qui seront utilis√©es comme **m√©thode d'authentification pour d√©ployer du code** en leur nom (aucune 2FA n'est appliqu√©e).

Avec cette cl√©, vous pouvez effectuer des **modifications dans les d√©p√¥ts o√π l'utilisateur a des privil√®ges**, cependant vous ne pouvez pas l'utiliser pour acc√©der √† l'API gitea pour √©num√©rer l'environnement. Cependant, vous pouvez **√©num√©rer les param√®tres locaux** pour obtenir des informations sur les repos et l'utilisateur auquel vous avez acc√®s :
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si l'utilisateur a configur√© son nom d'utilisateur comme son nom d'utilisateur gitea, vous pouvez acc√©der aux **cl√©s publiques qu'il a d√©finies** dans son compte √† _https://github.com/\<gitea\_username>.keys_, vous pourriez v√©rifier cela pour confirmer que la cl√© priv√©e que vous avez trouv√©e peut √™tre utilis√©e.

Les **cl√©s SSH** peuvent √©galement √™tre d√©finies dans les d√©p√¥ts comme **cl√©s de d√©ploiement**. Quiconque ayant acc√®s √† cette cl√© pourra **lancer des projets √† partir d'un d√©p√¥t**. En g√©n√©ral, sur un serveur avec diff√©rentes cl√©s de d√©ploiement, le fichier local **`~/.ssh/config`** vous donnera des informations sur la cl√© √† laquelle il est li√©.

#### Cl√©s GPG

Comme expliqu√© [**ici**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md), il est parfois n√©cessaire de signer les commits sinon vous pourriez √™tre d√©couvert.

V√©rifiez localement si l'utilisateur actuel a une cl√© avec :
```shell
gpg --list-secret-keys --keyid-format=long
```
### Avec le jeton utilisateur

Pour une introduction sur [**les jetons utilisateur, consultez les informations de base**](basic-gitea-information.md#personal-access-tokens).

Un jeton utilisateur peut √™tre utilis√© **au lieu d'un mot de passe** pour **s'authentifier** contre le serveur Gitea [**via l'API**](https://try.gitea.io/api/swagger#/). Il aura **un acc√®s complet** sur l'utilisateur.

### Avec l'application Oauth

Pour une introduction sur [**les applications Oauth de Gitea, consultez les informations de base**](./#with-oauth-application).

Un attaquant pourrait cr√©er une **application Oauth malveillante** pour acc√©der aux donn√©es/actions privil√©gi√©es des utilisateurs qui les acceptent probablement dans le cadre d'une campagne de phishing.

Comme expliqu√© dans les informations de base, l'application aura **un acc√®s complet au compte utilisateur**.

### Contournement de la protection des branches

Dans Github, nous avons **github actions** qui, par d√©faut, obtiennent un **jeton avec un acc√®s en √©criture** sur le d√©p√¥t qui peut √™tre utilis√© pour **contourner les protections de branche**. Dans ce cas, cela **n'existe pas**, donc les contournements sont plus limit√©s. Mais examinons ce qui peut √™tre fait :

* **Activer le push** : Si quelqu'un avec un acc√®s en √©criture peut pousser vers la branche, il suffit de le faire.
* **Liste blanche des push restreints** : De la m√™me mani√®re, si vous faites partie de cette liste, poussez vers la branche.
* **Activer la liste blanche de fusion** : S'il y a une liste blanche de fusion, vous devez en faire partie.
* **Exiger que les approbations soient sup√©rieures √† 0** : Alors... vous devez compromettre un autre utilisateur.
* **Restreindre les approbations aux utilisateurs sur liste blanche** : Si seuls les utilisateurs sur liste blanche peuvent approuver... vous devez compromettre un autre utilisateur qui est dans cette liste.
* **Rejeter les approbations obsol√®tes** : Si les approbations ne sont pas supprim√©es avec de nouveaux commits, vous pourriez d√©tourner une PR d√©j√† approuv√©e pour injecter votre code et fusionner la PR.

Notez que **si vous √™tes un admin d'org/repo**, vous pouvez contourner les protections.

### √ânum√©rer les Webhooks

Les **Webhooks** sont capables d'**envoyer des informations sp√©cifiques de gitea √† certains endroits**. Vous pourriez √™tre en mesure de **exploiter cette communication**.\
Cependant, g√©n√©ralement, un **secret** que vous ne pouvez **pas r√©cup√©rer** est d√©fini dans le **webhook** qui **emp√™chera** les utilisateurs externes qui connaissent l'URL du webhook mais pas le secret d'**exploiter ce webhook**.\
Mais dans certaines occasions, les gens au lieu de d√©finir le **secret** √† sa place, le **mettent dans l'URL** comme param√®tre, donc **v√©rifier les URL** pourrait vous permettre de **trouver des secrets** et d'autres endroits que vous pourriez exploiter davantage.

Les webhooks peuvent √™tre d√©finis au **niveau du d√©p√¥t et au niveau de l'org**.

## Post-exploitation

### √Ä l'int√©rieur du serveur

Si d'une mani√®re ou d'une autre vous parvenez √† entrer dans le serveur o√π gitea fonctionne, vous devriez chercher le fichier de configuration de gitea. Par d√©faut, il est situ√© dans `/data/gitea/conf/app.ini`

Dans ce fichier, vous pouvez trouver des **cl√©s** et des **mots de passe**.

Dans le chemin gitea (par d√©faut : /data/gitea), vous pouvez √©galement trouver des informations int√©ressantes comme :

* La base de donn√©es **sqlite** : Si gitea n'utilise pas une base de donn√©es externe, il utilisera une base de donn√©es sqlite.
* Les **sessions** dans le dossier des sessions : En ex√©cutant `cat sessions/*/*/*`, vous pouvez voir les noms d'utilisateur des utilisateurs connect√©s (gitea pourrait √©galement enregistrer les sessions dans la base de donn√©es).
* La **cl√© priv√©e jwt** dans le dossier jwt.
* Plus d'**informations sensibles** pourraient √™tre trouv√©es dans ce dossier.

Si vous √™tes √† l'int√©rieur du serveur, vous pouvez √©galement **utiliser le binaire `gitea`** pour acc√©der/modifier des informations :

* `gitea dump` va dumper gitea et g√©n√©rer un fichier .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` va g√©n√©rer un jeton du type indiqu√© (persistance).
* `gitea admin user change-password --username admin --password newpassword` Changer le mot de passe.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Cr√©er un nouvel utilisateur admin et obtenir un jeton d'acc√®s.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
