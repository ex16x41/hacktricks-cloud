# Github Security

{% hint style="success" %}
Naucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

## Co to jest Github

(Z [td](https://kinsta.com/knowledgebase/what-is-github/)) Na wysokim poziomie, **GitHub to strona internetowa i usuga w chmurze, kt贸ra pomaga deweloperom przechowywa i zarzdza swoim kodem, a tak偶e ledzi i kontrolowa zmiany w swoim kodzie**.

### Podstawowe Informacje

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Zewntrzny Rekonesans

Repozytoria Github mog by skonfigurowane jako publiczne, prywatne i wewntrzne.

* **Prywatne** oznacza, 偶e **tylko** osoby z **organizacji** bd miay do nich dostp
* **Wewntrzne** oznacza, 偶e **tylko** osoby z **przedsibiorstwa** (przedsibiorstwo mo偶e mie kilka organizacji) bd miay do niego dostp
* **Publiczne** oznacza, 偶e **cay internet** bdzie mia do niego dostp.

W przypadku, gdy znasz **u偶ytkownika, repozytorium lub organizacj, kt贸r chcesz zaatakowa**, mo偶esz u偶y **github dorks** do znalezienia wra偶liwych informacji lub wyszukiwania **wyciek贸w wra偶liwych informacji** **w ka偶dym repozytorium**.

### Github Dorks

Github pozwala na **wyszukiwanie czego, okrelajc jako zakres u偶ytkownika, repozytorium lub organizacj**. Dlatego, majc list cig贸w, kt贸re pojawi si blisko wra偶liwych informacji, mo偶esz atwo **wyszuka potencjalne wra偶liwe informacje w swoim celu**.

Narzdzia (ka偶de narzdzie zawiera swoj list dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

Prosz, zauwa偶, 偶e github dorks s r贸wnie偶 przeznaczone do wyszukiwania wyciek贸w za pomoc opcji wyszukiwania github. Ta sekcja jest powicona narzdziom, kt贸re bd **pobiera ka偶de repozytorium i wyszukiwa w nim wra偶liwe informacje** (nawet sprawdzajc pewn gboko commit贸w).

Narzdzia (ka偶de narzdzie zawiera swoj list regex贸w):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Kiedy szukasz wyciek贸w w repozytorium i uruchamiasz co w stylu `git log -p`, nie zapomnij, 偶e mog istnie **inne gazie z innymi commitami** zawierajcymi sekrety!
{% endhint %}

### Zewntrzne Forki

Mo偶liwe jest **kompromitowanie repozytori贸w, nadu偶ywajc pull request贸w**. Aby dowiedzie si, czy repozytorium jest podatne, g贸wnie musisz przeczyta konfiguracje yaml Github Actions. [**Wicej informacji na ten temat poni偶ej**](./#execution-from-a-external-fork).

## Utwardzanie Organizacji

### Uprawnienia Czonk贸w

Istniej pewne **domylne uprawnienia**, kt贸re mog by przypisane do **czonk贸w** organizacji. Mo偶na nimi zarzdza ze strony `https://github.com/organizations/<org_name>/settings/member_privileges` lub z [**Organizations API**](https://docs.github.com/en/rest/orgs/orgs).

* **Podstawowe uprawnienia**: Czonkowie bd mieli uprawnienia None/Read/write/Admin nad repozytoriami organizacji. Zalecane jest **None** lub **Read**.
* **Forkowanie repozytori贸w**: Jeli nie jest to konieczne, lepiej **nie pozwala** czonkom na forkowanie repozytori贸w organizacji.
* **Tworzenie stron**: Jeli nie jest to konieczne, lepiej **nie pozwala** czonkom na publikowanie stron z repozytori贸w organizacji. Jeli jest to konieczne, mo偶na pozwoli na tworzenie stron publicznych lub prywatnych.
* **呕dania dostpu do integracji**: Z wczon t opcj zewntrzni wsp贸pracownicy bd mogli 偶da dostpu dla aplikacji GitHub lub OAuth do tej organizacji i jej zasob贸w. Zwykle jest to potrzebne, ale jeli nie, lepiej to wyczy.
* _Nie znalazem tych informacji w odpowiedzi API, podziel si, jeli znajdziesz_
* **Zmiana widocznoci repozytorium**: Jeli wczone, **czonkowie** z **uprawnieniami administratora** dla **repozytorium** bd mogli **zmienia jego widoczno**. Jeli wyczone, tylko waciciele organizacji mog zmienia widoczno repozytori贸w. Jeli **nie** chcesz, aby ludzie robili rzeczy **publiczne**, upewnij si, 偶e to jest **wyczone**.
* _Nie znalazem tych informacji w odpowiedzi API, podziel si, jeli znajdziesz_
* **Usuwanie i przenoszenie repozytori贸w**: Jeli wczone, czonkowie z **uprawnieniami administratora** dla repozytorium bd mogli **usuwa** lub **przenosi** publiczne i prywatne **repozytoria.**
* _Nie znalazem tych informacji w odpowiedzi API, podziel si, jeli znajdziesz_
* **Pozw贸l czonkom tworzy zespoy**: Jeli wczone, ka偶dy **czonek** organizacji bdzie m贸g **tworzy** nowe **zespoy**. Jeli wyczone, tylko waciciele organizacji mog tworzy nowe zespoy. Lepiej mie to wyczone.
* _Nie znalazem tych informacji w odpowiedzi API, podziel si, jeli znajdziesz_
* **Wicej rzeczy mo偶na skonfigurowa** na tej stronie, ale poprzednie s najbardziej zwizane z bezpieczestwem.

### Ustawienia Akcji

Kilka ustawie zwizanych z bezpieczestwem mo偶na skonfigurowa dla akcji ze strony `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Zauwa偶, 偶e wszystkie te konfiguracje mo偶na r贸wnie偶 ustawi na ka偶dym repozytorium niezale偶nie
{% endhint %}

* **Polityki akcji Github**: Pozwala wskaza, kt贸re repozytoria mog uruchamia workflowy i kt贸re workflowy powinny by dozwolone. Zaleca si **okrelenie, kt贸re repozytoria** powinny by dozwolone i nie pozwala na uruchamianie wszystkich akcji.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Workflowy pull request贸w z fork贸w zewntrznych wsp贸pracownik贸w**: Zaleca si **wymaganie zatwierdzenia dla wszystkich** zewntrznych wsp贸pracownik贸w.
* _Nie znalazem API z tymi informacjami, podziel si, jeli znajdziesz_
* **Uruchamianie workflow贸w z pull request贸w fork贸w**: Zdecydowanie **odradza si uruchamianie workflow贸w z pull request贸w**, poniewa偶 tw贸rcy forka bd mieli mo偶liwo u偶ywania token贸w z uprawnieniami do odczytu w repozytorium 藕r贸dowym.
* _Nie znalazem API z tymi informacjami, podziel si, jeli znajdziesz_
* **Uprawnienia workflow贸w**: Zdecydowanie zaleca si **dawanie tylko uprawnie do odczytu repozytorium**. Odradza si dawanie uprawnie do zapisu i tworzenia/zatwierdzania pull request贸w, aby unikn nadu偶ywania GITHUB\_TOKEN przyznawanego uruchamianym workflowom.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integracje

_Daj zna, jeli znasz punkt kocowy API, aby uzyska te informacje!_

* **Polityka dostpu aplikacji zewntrznych**: Zaleca si ograniczenie dostpu do ka偶dej aplikacji i pozwolenie tylko na te potrzebne (po ich przegldzie).
* **Zainstalowane aplikacje GitHub**: Zaleca si pozwolenie tylko na te potrzebne (po ich przegldzie).

## Rekonesans i Ataki wykorzystujce powiadczenia

W tym scenariuszu zakadamy, 偶e uzyskae dostp do konta github.

### Z Powiadczeniami U偶ytkownika

Jeli w jaki spos贸b masz ju偶 powiadczenia u偶ytkownika w organizacji, mo偶esz **po prostu si zalogowa** i sprawdzi, jakie **role w przedsibiorstwie i organizacji masz**, jeli jeste zwykym czonkiem, sprawd藕, jakie **uprawnienia maj zwykli czonkowie**, w jakich **grupach** jeste, jakie **uprawnienia masz** nad jakimi **repozytoriami** i **jak s chronione repozytoria.**

Zauwa偶, 偶e **mo偶e by u偶ywane 2FA**, wic bdziesz m贸g uzyska dostp do tych informacji tylko wtedy, gdy r贸wnie偶 **przejdziesz t kontrol**.

{% hint style="info" %}
Zauwa偶, 偶e jeli **uda ci si ukra ciasteczko `user_session`** (obecnie skonfigurowane z SameSite: Lax), mo偶esz **cakowicie podszy si pod u偶ytkownika** bez potrzeby powiadcze lub 2FA.
{% endhint %}

Sprawd藕 sekcj poni偶ej o [**obejciach ochrony gazi**](./#branch-protection-bypass), jeli jest to przydatne.

### Z Kluczem SSH U偶ytkownika

Github pozwala **u偶ytkownikom** ustawia **klucze SSH**, kt贸re bd u偶ywane jako **metoda uwierzytelniania do wdra偶ania kodu** w ich imieniu (nie stosuje si 2FA).

Z tym kluczem mo偶esz dokonywa **zmian w repozytoriach, w kt贸rych u偶ytkownik ma pewne uprawnienia**, jednak nie mo偶esz go u偶ywa do dostpu do API githuba w celu enumeracji rodowiska. Mo偶esz jednak **enumerowa lokalne ustawienia**, aby uzyska informacje o repozytoriach i u偶ytkowniku, do kt贸rych masz dostp:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Jeli u偶ytkownik skonfigurowa swoj nazw u偶ytkownika jako swoj nazw u偶ytkownika github, mo偶esz uzyska dostp do **kluczy publicznych, kt贸re ustawi** na swoim koncie pod adresem _https://github.com/\<github\_username>.keys_, mo偶esz to sprawdzi, aby potwierdzi, 偶e znaleziony klucz prywatny mo偶e by u偶ywany.

**Klucze SSH** mog by r贸wnie偶 ustawione w repozytoriach jako **klucze wdro偶eniowe**. Ka偶dy, kto ma dostp do tego klucza, bdzie m贸g **uruchamia projekty z repozytorium**. Zwykle na serwerze z r贸偶nymi kluczami wdro偶eniowymi lokalny plik **`~/.ssh/config`** dostarczy informacji o powizanych kluczach.

#### Klucze GPG

Jak wyjaniono [**tutaj**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md), czasami trzeba podpisa commity, inaczej mo偶esz zosta wykryty.

Sprawd藕 lokalnie, czy bie偶cy u偶ytkownik ma jakiekolwiek klucze za pomoc:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Z Tokenem U偶ytkownika

Wprowadzenie do [**Token贸w U偶ytkownika znajdziesz w podstawowych informacjach**](basic-github-information.md#personal-access-tokens).

Token u偶ytkownika mo偶e by u偶ywany **zamiast hasa** do Git przez HTTPS lub do [**uwierzytelniania do API przez Basic Authentication**](https://docs.github.com/v3/auth/#basic-authentication). W zale偶noci od przypisanych uprawnie, mo偶esz wykonywa r贸偶ne dziaania.

Token u偶ytkownika wyglda tak: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Z Aplikacj Oauth

Wprowadzenie do [**Aplikacji Oauth na Github znajdziesz w podstawowych informacjach**](basic-github-information.md#oauth-applications).

Atakujcy mo偶e stworzy **zoliw aplikacj Oauth**, aby uzyska dostp do uprzywilejowanych danych/dziaa u偶ytkownik贸w, kt贸rzy je zaakceptuj, prawdopodobnie w ramach kampanii phishingowej.

Oto [zakresy, kt贸re mo偶e 偶da aplikacja Oauth](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Zawsze nale偶y sprawdzi 偶dane zakresy przed ich zaakceptowaniem.

Ponadto, jak wyjaniono w podstawowych informacjach, **organizacje mog przyznawa/odmawia dostpu aplikacjom trzecim** do informacji/repozytori贸w/dziaa zwizanych z organizacj.

### Z Aplikacj Github

Wprowadzenie do [**Aplikacji Github znajdziesz w podstawowych informacjach**](basic-github-information.md#github-applications).

Atakujcy mo偶e stworzy **zoliw aplikacj Github**, aby uzyska dostp do uprzywilejowanych danych/dziaa u偶ytkownik贸w, kt贸rzy je zaakceptuj, prawdopodobnie w ramach kampanii phishingowej.

Ponadto, jak wyjaniono w podstawowych informacjach, **organizacje mog przyznawa/odmawia dostpu aplikacjom trzecim** do informacji/repozytori贸w/dziaa zwizanych z organizacj.

## Kompromitacja i Nadu偶ycie Github Action

Istnieje kilka technik kompromitacji i nadu偶ycia Github Action, sprawd藕 je tutaj:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Omijanie Ochrony Gazi

* **Wymagaj liczby zatwierdze**: Jeli skompromitowae kilka kont, mo偶esz zaakceptowa swoje PR-y z innych kont. Jeli masz tylko konto, z kt贸rego utworzye PR, nie mo偶esz zaakceptowa wasnego PR. Jednak偶e, jeli masz dostp do rodowiska **Github Action** w repozytorium, u偶ywajc **GITHUB\_TOKEN** mo偶esz **zatwierdzi sw贸j PR** i uzyska w ten spos贸b 1 zatwierdzenie.
* _Uwaga: dla tego i dla ograniczenia Code Owners, zazwyczaj u偶ytkownik nie bdzie m贸g zatwierdzi swoich wasnych PR-贸w, ale jeli mo偶e, mo偶e to wykorzysta do zaakceptowania swoich PR-贸w._
* **Odrzucaj zatwierdzenia, gdy nowe commity s wprowadzane**: Jeli to nie jest ustawione, mo偶esz przesa legalny kod, poczeka, a偶 kto go zatwierdzi, a nastpnie wprowadzi zoliwy kod i scali go z chronion gazi.
* **Wymagaj przegld贸w od Code Owners**: Jeli to jest aktywowane i jeste Code Owner, mo偶esz sprawi, 偶e **Github Action utworzy tw贸j PR, a nastpnie sam go zatwierdzisz**.
* Gdy plik **CODEOWNER jest 藕le skonfigurowany**, Github nie zgasza bdu, ale go nie u偶ywa. Dlatego, jeli jest 藕le skonfigurowany, **ochrona Code Owners nie jest stosowana.**
* **Zezwalaj okrelonym aktorom na omijanie wymaga pull request**: Jeli jeste jednym z tych aktor贸w, mo偶esz omin ochron pull request.
* **Uwzgldnij administrator贸w**: Jeli to nie jest ustawione, a jeste administratorem repozytorium, mo偶esz omin te ochrony gazi.
* **PR Hijacking**: Mo偶esz **zmodyfikowa PR kogo innego**, dodajc zoliwy kod, zatwierdzajc wynikowy PR samodzielnie i scalajc wszystko.
* **Usuwanie ochrony gazi**: Jeli jeste **administratorem repozytorium, mo偶esz wyczy ochrony**, scali sw贸j PR i ponownie ustawi ochrony.
* **Omijanie ochrony push**: Jeli repozytorium **zezwala tylko okrelonym u偶ytkownikom** na wysyanie push (scalanie kodu) w gaziach (ochrona gazi mo偶e chroni wszystkie gazie, okrelajc symbol wieloznaczny `*`).
* Jeli masz **dostp do zapisu w repozytorium, ale nie mo偶esz wysya kodu** z powodu ochrony gazi, nadal mo偶esz **utworzy now ga藕** i w niej utworzy **github action, kt贸re jest uruchamiane, gdy kod jest wysyany**. Poniewa偶 **ochrona gazi nie chroni gazi, dop贸ki nie zostanie utworzona**, to pierwsze wysanie kodu do gazi **uruchomi github action**.

## Omijanie Ochrony rodowisk

Wprowadzenie do [**Github Environment znajdziesz w podstawowych informacjach**](basic-github-information.md#git-environments).

Jeli rodowisko mo偶e by **dostpne ze wszystkich gazi**, jest **niechronione** i mo偶esz atwo uzyska dostp do sekret贸w w rodowisku. Zauwa偶, 偶e mo偶esz znale藕 repozytoria, gdzie **wszystkie gazie s chronione** (przez okrelenie ich nazw lub u偶ycie `*`), w takim przypadku **znajd藕 ga藕, do kt贸rej mo偶esz wysa kod** i mo偶esz **wyeksfiltrowa** sekrety, tworzc nowe github action (lub modyfikujc istniejce).

Zauwa偶, 偶e mo偶esz znale藕 przypadek brzegowy, gdzie **wszystkie gazie s chronione** (przez symbol wieloznaczny `*`), jest okrelone **kto mo偶e wysya kod do gazi** (_mo偶esz to okreli w ochronie gazi_) i **tw贸j u偶ytkownik nie jest dozwolony**. Nadal mo偶esz uruchomi niestandardowe github action, poniewa偶 mo偶esz utworzy ga藕 i u偶y wyzwalacza push na niej. **Ochrona gazi pozwala na push do nowej gazi, wic github action zostanie uruchomione**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Zauwa偶, 偶e **po utworzeniu** gazi **ochrona gazi bdzie miaa zastosowanie do nowej gazi** i nie bdziesz m贸g jej modyfikowa, ale do tego czasu ju偶 zrzucisz sekrety.

## Trwao

* Wygeneruj **token u偶ytkownika**
* Skradnij **github tokens** z **secrets**
* **Usunicie** wynik贸w **workflow** i **gazi**
* Daj **wicej uprawnie caej organizacji**
* Utw贸rz **webhooks** do eksfiltracji informacji
* Zapro **zewntrznych wsp贸pracownik贸w**
* **Usu** **webhooks** u偶ywane przez **SIEM**
* Utw贸rz/zmodyfikuj **Github Action** z **backdoorem**
* Znajd藕 **podatne Github Action na wstrzyknicie komend** poprzez modyfikacj wartoci **secret**

### Faszywe Commity - Backdoor przez commity repozytorium

W Github mo偶liwe jest **utworzenie PR do repozytorium z forka**. Nawet jeli PR **nie zostanie zaakceptowany**, zostanie utworzony **commit** id wewntrz oryginalnego repozytorium dla wersji kodu z forka. W zwizku z tym, atakujcy **mo偶e przypi do u偶ycia konkretny commit z pozornie legalnego repozytorium, kt贸ry nie zosta utworzony przez waciciela repozytorium**.

Jak [**tutaj**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Wicej informacji znajdziesz na [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

{% hint style="success" %}
Ucz si i wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz si i wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* Sprawd藕 [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hakerskimi, przesyajc PR-y do repozytori贸w** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>
{% endhint %}
