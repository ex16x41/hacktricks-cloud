# Gh Actions - Context Script Injections

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本信息

要运行 GitHub Action 管道，系统中必须发生特定的触发器（事件）。这些触发器中的一些可以由 GitHub 上的任何用户发起，使他们能够控制管道将使用的某些参数。这些参数被称为 [**上下文**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context)。如果这些值在管道中用于命令执行而没有对用户控制的输入进行适当的清理，可能会导致 **任意代码执行**。

例如，想象一个在创建拉取请求时触发的 GitHub Action。该操作包含一个 Bash 命令，使用分支名称并通过 `echo` 命令记录它。在这种情况下，创建拉取请求的用户可以控制分支名称，并可以构造一个恶意的分支名称以逃避 `echo` 命令的上下文。这种操控可能导致通过 Bash 注入进行 **任意代码执行**。

以下是用户可以控制的上下文列表。如果管道不安全地使用它们，GitHub 上的任何用户都可能利用此漏洞在管道中运行代码。此列表来源于 [**Raven**](https://github.com/CycodeLabs/raven)，一个开源的 GitHub Actions 漏洞扫描器：

* `github.event.issue.title`
* `github.event.issue.body`
* `github.event.pull_request.title`
* `github.event.pull_request.body`
* `github.event.comment.body`
* `github.event.review.body`
* `github.event.review_comment.body`
* `github.event.pages.*.page_name`
* `github.event.commits.*.message`
* `github.event.head_commit.message`
* `github.event.head_commit.author.email`
* `github.event.head_commit.author.name`
* `github.event.commits.*.author.email`
* `github.event.commits.*.author.name`
* `github.event.pull_request.head.ref`
* `github.event.pull_request.head.label`
* `github.event.pull_request.head.repo.default_branch`
* `github.head_ref`


### 脚本注入攻击示例 <a href="#example-of-a-script-injection-attack" id="example-of-a-script-injection-attack"></a>

脚本注入攻击可以直接发生在工作流的内联脚本中。在以下示例中，一个操作使用 **表达式来测试拉取请求标题的有效性**，但也增加了脚本注入的风险：
```yaml
- name: Check PR title
run: |
title="${{ github.event.pull_request.title }}"
if [[ $title =~ ^octocat ]]; then
echo "PR title starts with 'octocat'"
exit 0
else
echo "PR title did not start with 'octocat'"
exit 1
fi
```
在运行 shell 脚本之前，`${{ }}` 内的表达式会被 **评估**，然后用结果值替换，这可能使其 **容易受到 shell 命令注入**。

为了将命令注入到此工作流中，攻击者可以创建一个标题为 **`a"; ls $GITHUB_WORKSPACE"`** 的拉取请求。

在这个例子中，**`"`** 字符用于中断 `title=`**`"${{ github.event.pull_request.title }}"`** 语句，从而允许在运行器上执行 `ls` 命令。

### Github Actions 扫描工具
- [Raven](https://github.com/CycodeLabs/raven) - [发布博客](https://cycode.com/blog/introducing-raven/)
- [Gato](https://github.com/praetorian-inc/gato)
- [Gato-X](https://github.com/AdnaneKhan/Gato-X)
- [PurplePanda](https://github.com/carlospolop/PurplePanda)

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术：<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **在** **Twitter** 🐦 **上关注我们** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
