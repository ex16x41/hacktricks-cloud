# 基本的なGithub情報

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **参加する** 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に、または**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

## 基本構造

大規模な**企業**の基本的なGithub環境構造は、**エンタープライズ**を所有し、そのエンタープライズが**いくつかの組織**を所有し、それぞれが**いくつかのリポジトリ**と**いくつかのチーム**を含むことです。小規模な企業は、**1つの組織のみを所有し、エンタープライズを持たない**場合があります。

ユーザーの観点から見ると、**ユーザー**は**異なるエンタープライズや組織のメンバー**であることができます。その中で、ユーザーは**異なるエンタープライズ、組織、リポジトリの役割**を持つことがあります。

さらに、ユーザーは**異なるチームの一部**であり、異なるエンタープライズ、組織、またはリポジトリの役割を持つことがあります。

最後に、**リポジトリには特別な保護メカニズム**がある場合があります。

## 権限

### エンタープライズの役割

* **エンタープライズオーナー**：この役割を持つ人々は、**管理者を管理し、エンタープライズ内の組織を管理し、エンタープライズ設定を管理し、組織全体にポリシーを強制する**ことができます。ただし、彼らは**組織の設定やコンテンツにアクセスすることはできません**。組織のオーナーに任命されるか、組織所有のリポジトリへの直接アクセスが与えられない限り。
* **エンタープライズメンバー**：あなたのエンタープライズが所有する組織のメンバーは、**自動的にエンタープライズのメンバー**でもあります。

### 組織の役割

組織内でユーザーは異なる役割を持つことができます：

* **組織オーナー**：組織オーナーは、**組織に対して完全な管理アクセス**を持っています。この役割は制限されるべきですが、組織内で2人以上の人に制限する必要があります。
* **組織メンバー**：**デフォルト**の非管理者役割は**組織メンバー**です。デフォルトで、組織メンバーは**いくつかの権限を持っています**。
* **請求管理者**：請求管理者は、**組織の請求設定を管理できるユーザー**です。たとえば、支払い情報など。
* **セキュリティマネージャー**：これは、組織オーナーが組織内の任意のチームに割り当てることができる役割です。適用されると、チームのすべてのメンバーに**組織全体のセキュリティアラートと設定を管理する権限、および組織内のすべてのリポジトリに対する読み取り権限**が与えられます。
* 組織にセキュリティチームがある場合、セキュリティマネージャーの役割を使用して、チームのメンバーに組織に必要な最小限のアクセスを与えることができます。
* **Githubアプリ管理者**：組織が所有するGitHubアプリを**管理するために追加のユーザーを許可する**ために、オーナーはGitHubアプリ管理者の権限を付与できます。
* **外部コラボレーター**：外部コラボレーターは、**1つ以上の組織リポジトリにアクセスできるが、組織の明示的なメンバーではない**人です。

これらの役割の権限をこの表で**比較できます**：[https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles](https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles)

### メンバーの権限

_https://github.com/organizations/\<org\_name>/settings/member\_privileges_ で、**組織の一部であることによってユーザーが持つ権限**を確認できます。

ここで設定された内容は、組織のメンバーの次の権限を示します：

* 組織のすべてのリポジトリに対して管理者、ライター、リーダー、または権限なしであること。
* メンバーがプライベート、内部、またはパブリックリポジトリを作成できるかどうか。
* リポジトリのフォークが可能かどうか。
* 外部コラボレーターを招待できるかどうか。
* 公開またはプライベートサイトを公開できるかどうか。
* 管理者がリポジトリに対して持つ権限。
* メンバーが新しいチームを作成できるかどうか。

### リポジトリの役割

デフォルトでリポジトリの役割が作成されます：

* **読み取り**：あなたのプロジェクトを表示または議論したい**非コード貢献者**に推奨されます。
* **トリアージ**：**書き込みアクセスなしで問題やプルリクエストを積極的に管理する必要がある貢献者**に推奨されます。
* **書き込み**：あなたのプロジェクトに**積極的にプッシュする貢献者**に推奨されます。
* **メンテナンス**：**機密または破壊的なアクションにアクセスせずにリポジトリを管理する必要があるプロジェクトマネージャー**に推奨されます。
* **管理者**：**プロジェクトに完全にアクセスする必要がある人**に推奨されます。これには、セキュリティの管理やリポジトリの削除などの機密および破壊的なアクションが含まれます。

各役割の権限をこの表で**比較できます**：[https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role)

また、_https://github.com/organizations/\<org\_name>/settings/roles_ で**独自の役割を作成する**こともできます。

### チーム

_https://github.com/orgs/\<org\_name>/teams_ で、**組織内に作成されたチームのリストを表示できます**。他のチームの子チームを見るには、各親チームにアクセスする必要があります。

### ユーザー

組織のユーザーは、_https://github.com/orgs/\<org\_name>/people_ で**リスト表示**できます。

各ユーザーの情報には、**ユーザーが所属するチーム**と、**ユーザーがアクセスできるリポジトリ**が表示されます。

## Github認証

Githubは、アカウントに認証し、あなたの代わりにアクションを実行するためのさまざまな方法を提供しています。

### ウェブアクセス

**github.com**にアクセスすると、**ユーザー名とパスワード**（および**2FAが必要な場合もあります**）を使用してログインできます。

### **SSHキー**

1つまたは複数の公開鍵でアカウントを構成でき、関連する**秘密鍵があなたの代わりにアクションを実行できるようにします**。[https://github.com/settings/keys](https://github.com/settings/keys)

#### **GPGキー**

これらのキーを使用してユーザーを偽装することはできませんが、使用しない場合、**署名なしでコミットを送信することで発見される可能性があります**。詳細については、[ここで警戒モードについて学んでください](https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits#about-vigilant-mode)。

### **個人アクセストークン**

アプリケーションに**アカウントへのアクセスを与える**ために個人アクセストークンを生成できます。個人アクセストークンを作成する際、**ユーザー**は**トークン**が持つ**権限**を**指定する**必要があります。[https://github.com/settings/tokens](https://github.com/settings/tokens)

### Oauthアプリケーション

Oauthアプリケーションは、**あなたのGithub情報の一部にアクセスするための権限を要求したり、あなたを偽装していくつかのアクションを実行したりする**ことがあります。この機能の一般的な例は、いくつかのプラットフォームで見られる**Githubでログインするボタン**です。

* [https://github.com/settings/developers](https://github.com/settings/developers)で独自の**Oauthアプリケーションを作成**できます。
* [https://github.com/settings/applications](https://github.com/settings/applications)で、**あなたのアカウントにアクセスできるすべてのOauthアプリケーション**を確認できます。
* [https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)で、**Oauthアプリが要求できるスコープ**を確認できます。
* _https://github.com/organizations/\<org\_name>/settings/oauth\_application\_policy_ で、**組織内のアプリケーションのサードパーティアクセス**を確認できます。

いくつかの**セキュリティ推奨事項**：

* **OAuthアプリ**は、常に**GitHub全体で認証されたGitHubユーザーとして行動する**べきです（たとえば、ユーザー通知を提供する場合）し、指定されたスコープへのアクセスのみを持つべきです。
* OAuthアプリは、認証されたユーザーのために「GitHubでログイン」を有効にすることで、アイデンティティプロバイダーとして使用できます。
* **単一のリポジトリ**でアプリケーションを動作させたい場合は、**OAuthアプリを構築しないでください**。`repo` OAuthスコープを使用すると、OAuthアプリは**認証されたユーザーのすべてのリポジトリに対して行動できます**。
* **チームや会社のためのアプリケーションとして機能するためにOAuthアプリを構築しないでください**。OAuthアプリは**単一のユーザー**として認証されるため、1人が会社のためにOAuthアプリを作成し、その後会社を離れると、他の誰もそれにアクセスできなくなります。
* **詳細は**[こちら](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-oauth-apps)で。

### Githubアプリケーション

Githubアプリケーションは、**あなたのGithub情報にアクセスしたり、あなたを偽装して特定のリソースに対して特定のアクションを実行したりするための権限を要求することがあります**。Githubアプリでは、アプリがアクセスできるリポジトリを指定する必要があります。

* GitHubアプリをインストールするには、**組織のオーナーまたはリポジトリの管理者権限を持っている必要があります**。
* GitHubアプリは**個人アカウントまたは組織に接続する必要があります**。
* [https://github.com/settings/apps](https://github.com/settings/apps)で独自のGithubアプリケーションを作成できます。
* [https://github.com/settings/apps/authorizations](https://github.com/settings/apps/authorizations)で、**あなたのアカウントにアクセスできるすべてのGithubアプリケーション**を確認できます。
* これらは**GithubアプリケーションのAPIエンドポイント**です：[https://docs.github.com/en/rest/overview/endpoints-available-for-github-app](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)。アプリの権限に応じて、いくつかのエンドポイントにアクセスできるようになります。
* _https://github.com/organizations/\<org\_name>/settings/installations_ で、**組織内にインストールされたアプリ**を確認できます。

いくつかのセキュリティ推奨事項：

* GitHubアプリは、**ユーザーとは独立してアクションを実行するべきです**（アプリが[ユーザーからサーバーへの](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps#user-to-server-requests)トークンを使用している場合を除く）。ユーザーからサーバーへのアクセス・トークンをより安全に保つために、8時間後に期限切れになるアクセストークンと、新しいアクセストークンと交換できるリフレッシュトークンを使用できます。詳細については、「[ユーザーからサーバーへのアクセス・トークンの更新](https://docs.github.com/en/apps/building-github-apps/refreshing-user-to-server-access-tokens)」を参照してください。
* GitHubアプリが**特定のリポジトリ**と統合されていることを確認してください。
* GitHubアプリは**個人アカウントまたは組織に接続する必要があります**。
* GitHubアプリがユーザーができるすべてのことを知って行動することを期待しないでください。
* **「GitHubでログイン」サービスが必要なだけの場合は、GitHubアプリを使用しないでください**。ただし、GitHubアプリは、ユーザーをログインさせるために[ユーザー識別フロー](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps)を使用して、ユーザーをログインさせることができます。
* GitHubユーザーとしてのみ行動し、そのユーザーができるすべてのことを行いたい場合は、GitHubアプリを構築しないでください。
* GitHub Actionsを使用してアプリを使用し、ワークフローファイルを変更したい場合は、`workflow`スコープを含むOAuthトークンを使用してユーザーの代わりに認証する必要があります。ユーザーは、ワークフローファイルを含むリポジトリに対して管理者または書き込み権限を持っている必要があります。詳細については、「[OAuthアプリのスコープの理解](https://docs.github.com/en/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/#available-scopes)」を参照してください。
* **詳細は**[こちら](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps)で。

### Github Actions

これは**Githubで認証する方法ではありません**が、**悪意のある**Github Actionが**Githubに不正アクセスする**可能性があり、**与えられた権限**に応じて、いくつかの**異なる攻撃**が行われる可能性があります。詳細については以下を参照してください。

## Gitアクション

Gitアクションは、**イベントが発生したときにコードの実行を自動化する**ことを可能にします。通常、実行されるコードは**リポジトリのコードに関連している**（おそらくDockerコンテナをビルドするか、PRに秘密が含まれていないかを確認するなど）。

### 設定

_https://github.com/organizations/\<org\_name>/settings/actions_ で、**組織のGithubアクションの設定を確認できます**。

Githubアクションの使用を完全に禁止することも、**すべてのGithubアクションを許可する**ことも、特定のアクションのみを許可することも可能です。

また、**Github Actionを実行するために承認が必要な人**や、Github Actionが実行されるときの**GITHUB\_TOKENの権限**を設定することもできます。

### Git Secrets

Github Actionは通常、Githubやサードパーティアプリケーションと対話するために何らかの秘密を必要とします。**それらをリポジトリに平文で置かないようにするために、Githubはそれらを**Secrets**として配置することを許可します**。

これらの秘密は、**リポジトリまたは組織全体のために設定できます**。その後、**Actionが秘密にアクセスできるようにするために、次のように宣言する必要があります**：
```yaml
steps:
- name: Hello world action
with: # Set the secret as an input
super_secret: ${{ secrets.SuperSecret }}
env: # Or as an environment variable
super_secret: ${{ secrets.SuperSecret }}
```
#### Bashを使用した例 <a href="#example-using-bash" id="example-using-bash"></a>
```yaml
steps:
- shell: bash
env:
SUPER_SECRET: ${{ secrets.SuperSecret }}
run: |
example-command "$SUPER_SECRET"
```
{% hint style="warning" %}
Secrets **は、それらが宣言されている Github Actions からのみアクセス可能です**。

リポジトリまたは組織で設定されると、**github のユーザーは再度アクセスできなくなります**。彼らはただ **それらを変更することができる**だけです。
{% endhint %}

したがって、**github secrets を盗む唯一の方法は、Github Action を実行しているマシンにアクセスできることです**（そのシナリオでは、Action に対して宣言された秘密にのみアクセスできます）。

### Git Environments

Github は **環境** を作成することを許可しており、そこで **secrets** を保存できます。次に、環境内の秘密に対して github action にアクセスを与えることができます。
```yaml
jobs:
deployment:
runs-on: ubuntu-latest
environment: env_name
```
You can configure an environment to be **アクセス** by **すべてのブランチ** (default), **保護された** branches only or **指定** which branches can access it.\
It can also set a **必要なレビューの数** before **アクションを実行** using an **環境** or **待機** some **時間** before allowing deployments to proceed.

### Git Action Runner

A Github Action can be **github環境内で実行** or can be executed in a **サードパーティのインフラ** configured by the user.

Several organizations will allow to run Github Actions in a **サードパーティのインフラ** as it use to be **安価**.

You can **自己ホストされたランナーのリスト** of an organization in _https://github.com/organizations/\<org\_name>/settings/actions/runners_

The way to find which **Github Actions are being executed in non-github infrastructure** is to search for `runs-on: self-hosted` in the Github Action configuration yaml.

It's **異なる組織の自己ホストされたボックス内でのGithub Actionの実行は不可能** because **ランナーのために一意のトークンが生成される** when configuring it to know where the runner belongs.

If the custom **Github Runner is configured in a machine inside AWS or GCP** for example, the Action **メタデータエンドポイントにアクセスできる** and **サービスアカウントのトークンを盗むことができる** the machine is running with.

### Git Action Compromise

If all actions (or a malicious action) are allowed a user could use a **Github action** that is **悪意のある** and will **侵害** the **コンテナ** where it's being executed.

{% hint style="danger" %}
A **悪意のあるGithub Action** run could be **悪用** by the attacker to:

* **すべての秘密を盗む** the Action has access to
* **横移動** if the Action is executed inside a **サードパーティのインフラ** where the SA token used to run the machine can be accessed (probably via the metadata service)
* **トークンを悪用** used by the **ワークフロー** to **リポジトリのコードを盗む** where the Action is executed or **さらにはそれを変更する**.
{% endhint %}

## Branch Protections

Branch protections are designed to **リポジトリの完全な制御をユーザーに与えない**. The goal is to **いくつかの保護方法を設けてから、特定のブランチ内でコードを書くことができるようにする**.

The **リポジトリのブランチ保護** can be found in _https://github.com/\<orgname>/\<reponame>/settings/branches_

{% hint style="info" %}
It's **組織レベルでのブランチ保護を設定することは不可能**. So all of them must be declared on each repo.
{% endhint %}

Different protections can be applied to a branch (like to master):

* You can **マージ前にPRを要求** (so you cannot directly merge code over the branch). If this is select different other protections can be in place:
* **承認の数を要求**. It's very common to require 1 or 2 more people to approve your PR so a single user isn't capable of merge code directly.
* **新しいコミットがプッシュされたときに承認を取り消す**. If not, a user may approve legit code and then the user could add malicious code and merge it.
* **コードオーナーからのレビューを要求**. At least 1 code owner of the repo needs to approve the PR (so "random" users cannot approve it)
* **プルリクエストレビューを取り消すことができる人を制限**. You can specify people or teams allowed to dismiss pull request reviews.
* **指定されたアクターがプルリクエスト要件をバイパスできるようにする**. These users will be able to bypass previous restrictions.
* **マージ前にステータスチェックが通過することを要求**. Some checks needs to pass before being able to merge the commit (like a github action checking there isn't any cleartext secret).
* **マージ前に会話の解決を要求**. All comments on the code needs to be resolved before the PR can be merged.
* **署名されたコミットを要求**. The commits need to be signed.
* **線形履歴を要求**. Prevent merge commits from being pushed to matching branches.
* **管理者を含める**. If this isn't set, admins can bypass the restrictions.
* **一致するブランチにプッシュできる人を制限**. Restrict who can send a PR.

{% hint style="info" %}
As you can see, even if you managed to obtain some credentials of a user, **リポジトリは保護されているため、例えばmasterにコードをプッシュすることを避けることができる**.
{% endhint %}

## References

* [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization)
* [https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)[https://docs.github.com/en/enterprise-server](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)
* [https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github](https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github)
* [https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards)
* [https://docs.github.com/en/actions/security-guides/encrypted-secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
