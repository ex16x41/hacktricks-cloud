# Ansible Tower / AWX / Automation controller Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Ansible Tower** ou sua vers√£o de c√≥digo aberto [**AWX**](https://github.com/ansible/awx) tamb√©m √© conhecido como **interface de usu√°rio, painel e API REST do Ansible**. Com **controle de acesso baseado em fun√ß√µes**, agendamento de tarefas e gerenciamento gr√°fico de invent√°rio, voc√™ pode gerenciar sua infraestrutura Ansible a partir de uma interface moderna. A API REST do Tower e a interface de linha de comando facilitam a integra√ß√£o com ferramentas e fluxos de trabalho atuais.

**Automation Controller √© uma vers√£o mais nova** do Ansible Tower com mais capacidades.

### Differences

De acordo com [**isso**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), as principais diferen√ßas entre Ansible Tower e AWX s√£o o suporte recebido e o Ansible Tower possui recursos adicionais, como controle de acesso baseado em fun√ß√µes, suporte para APIs personalizadas e fluxos de trabalho definidos pelo usu√°rio.

### Tech Stack

* **Web Interface**: Esta √© a interface gr√°fica onde os usu√°rios podem gerenciar invent√°rios, credenciais, modelos e tarefas. √â projetada para ser intuitiva e fornece visualiza√ß√µes para ajudar a entender o estado e os resultados de suas tarefas de automa√ß√£o.
* **REST API**: Tudo o que voc√™ pode fazer na interface da web, voc√™ tamb√©m pode fazer via API REST. Isso significa que voc√™ pode integrar AWX/Tower com outros sistemas ou scriptar a√ß√µes que normalmente voc√™ realizaria na interface.
* **Database**: AWX/Tower usa um banco de dados (tipicamente PostgreSQL) para armazenar sua configura√ß√£o, resultados de tarefas e outros dados operacionais necess√°rios.
* **RabbitMQ**: Este √© o sistema de mensagens usado pelo AWX/Tower para se comunicar entre os diferentes componentes, especialmente entre o servi√ßo web e os executores de tarefas.
* **Redis**: Redis serve como um cache e um backend para a fila de tarefas.

### Logical Components

* **Inventories**: Um invent√°rio √© uma **cole√ß√£o de hosts (ou n√≥s)** contra os quais **tarefas** (playbooks do Ansible) podem ser **executadas**. AWX/Tower permite que voc√™ defina e agrupe seus invent√°rios e tamb√©m suporta invent√°rios din√¢micos que podem **buscar listas de hosts de outros sistemas** como AWS, Azure, etc.
* **Projects**: Um projeto √© essencialmente uma **cole√ß√£o de playbooks do Ansible** provenientes de um **sistema de controle de vers√£o** (como Git) para puxar os playbooks mais recentes quando necess√°rio.
* **Templates**: Modelos de tarefas definem **como um determinado playbook ser√° executado**, especificando o **invent√°rio**, **credenciais** e outros **par√¢metros** para a tarefa.
* **Credentials**: AWX/Tower fornece uma maneira segura de **gerenciar e armazenar segredos, como chaves SSH, senhas e tokens de API**. Essas credenciais podem ser associadas a modelos de tarefas para que os playbooks tenham o acesso necess√°rio quando forem executados.
* **Task Engine**: √â aqui que a m√°gica acontece. O mecanismo de tarefas √© constru√≠do sobre o Ansible e √© respons√°vel por **executar os playbooks**. As tarefas s√£o despachadas para o mecanismo de tarefas, que ent√£o executa os playbooks do Ansible contra o invent√°rio designado usando as credenciais especificadas.
* **Schedulers and Callbacks**: Esses s√£o recursos avan√ßados no AWX/Tower que permitem que **tarefas sejam agendadas** para serem executadas em hor√°rios espec√≠ficos ou acionadas por eventos externos.
* **Notifications**: AWX/Tower pode enviar notifica√ß√µes com base no sucesso ou falha das tarefas. Ele suporta v√°rios meios de notifica√ß√µes, como e-mails, mensagens do Slack, webhooks, etc.
* **Ansible Playbooks**: Os playbooks do Ansible s√£o ferramentas de configura√ß√£o, implanta√ß√£o e orquestra√ß√£o. Eles descrevem o estado desejado dos sistemas de uma maneira automatizada e repet√≠vel. Escritos em YAML, os playbooks usam a linguagem de automa√ß√£o declarativa do Ansible para descrever configura√ß√µes, tarefas e etapas que precisam ser executadas.

### Job Execution Flow

1. **User Interaction**: Um usu√°rio pode interagir com AWX/Tower atrav√©s da **Web Interface** ou da **REST API**. Essas fornecem acesso front-end a todas as funcionalidades oferecidas pelo AWX/Tower.
2. **Job Initiation**:
* O usu√°rio, via a Web Interface ou API, inicia uma tarefa com base em um **Modelo de Tarefa**.
* O Modelo de Tarefa inclui refer√™ncias ao **Invent√°rio**, **Projeto** (contendo o playbook) e **Credenciais**.
* Ap√≥s a inicia√ß√£o da tarefa, uma solicita√ß√£o √© enviada ao backend do AWX/Tower para colocar a tarefa na fila para execu√ß√£o.
3. **Job Queuing**:
* **RabbitMQ** gerencia a comunica√ß√£o entre o componente web e os executores de tarefas. Uma vez que uma tarefa √© iniciada, uma mensagem √© despachada para o mecanismo de tarefas usando RabbitMQ.
* **Redis** atua como o backend para a fila de tarefas, gerenciando tarefas enfileiradas aguardando execu√ß√£o.
4. **Job Execution**:
* O **Task Engine** pega a tarefa enfileirada. Ele recupera as informa√ß√µes necess√°rias do **Banco de Dados** sobre o playbook associado √† tarefa, invent√°rio e credenciais.
* Usando o playbook do Ansible recuperado do **Projeto** associado, o Task Engine executa o playbook contra os n√≥s do **Invent√°rio** especificado usando as **Credenciais** fornecidas.
* √Ä medida que o playbook √© executado, sua sa√≠da de execu√ß√£o (logs, fatos, etc.) √© capturada e armazenada no **Banco de Dados**.
5. **Job Results**:
* Uma vez que o playbook termina de ser executado, os resultados (sucesso, falha, logs) s√£o salvos no **Banco de Dados**.
* Os usu√°rios podem ent√£o visualizar os resultados atrav√©s da Web Interface ou consult√°-los via API REST.
* Com base nos resultados das tarefas, **Notifica√ß√µes** podem ser enviadas para informar os usu√°rios ou sistemas externos sobre o status da tarefa. As notifica√ß√µes podem ser e-mails, mensagens do Slack, webhooks, etc.
6. **External Systems Integration**:
* **Inventories** podem ser dinamicamente obtidos de sistemas externos, permitindo que o AWX/Tower puxe hosts de fontes como AWS, Azure, VMware e mais.
* **Projects** (playbooks) podem ser buscados de sistemas de controle de vers√£o, garantindo o uso de playbooks atualizados durante a execu√ß√£o da tarefa.
* **Schedulers and Callbacks** podem ser usados para integrar com outros sistemas ou ferramentas, fazendo com que o AWX/Tower reaja a gatilhos externos ou execute tarefas em hor√°rios predeterminados.

### AWX lab creation for testing

[**Seguindo a documenta√ß√£o**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md) √© poss√≠vel usar docker-compose para executar AWX:

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### Fun√ß√µes suportadas

A fun√ß√£o mais privilegiada √© chamada de **Administrador do Sistema**. Qualquer pessoa com essa fun√ß√£o pode **modificar qualquer coisa**.

De uma revis√£o de **seguran√ßa de caixa branca**, voc√™ precisaria da **fun√ß√£o de Auditor do Sistema**, que permite **visualizar todos os dados do sistema**, mas n√£o pode fazer altera√ß√µes. Outra op√ß√£o seria obter a **fun√ß√£o de Auditor da Organiza√ß√£o**, mas seria melhor obter a outra.

<details>

<summary>Expanda isso para obter uma descri√ß√£o detalhada das fun√ß√µes dispon√≠veis</summary>

1. **Administrador do Sistema**:
* Esta √© a fun√ß√£o de superusu√°rio com permiss√µes para acessar e modificar qualquer recurso no sistema.
* Eles podem gerenciar todas as organiza√ß√µes, equipes, projetos, invent√°rios, modelos de trabalho, etc.
2. **Auditor do Sistema**:
* Usu√°rios com essa fun√ß√£o podem visualizar todos os dados do sistema, mas n√£o podem fazer altera√ß√µes.
* Esta fun√ß√£o √© projetada para conformidade e supervis√£o.
3. **Fun√ß√µes da Organiza√ß√£o**:
* **Admin**: Controle total sobre os recursos da organiza√ß√£o.
* **Auditor**: Acesso somente para visualiza√ß√£o aos recursos da organiza√ß√£o.
* **Membro**: Membro b√°sico em uma organiza√ß√£o sem permiss√µes espec√≠ficas.
* **Executar**: Pode executar modelos de trabalho dentro da organiza√ß√£o.
* **Ler**: Pode visualizar os recursos da organiza√ß√£o.
4. **Fun√ß√µes do Projeto**:
* **Admin**: Pode gerenciar e modificar o projeto.
* **Usar**: Pode usar o projeto em um modelo de trabalho.
* **Atualizar**: Pode atualizar o projeto usando SCM (controle de vers√£o).
5. **Fun√ß√µes do Invent√°rio**:
* **Admin**: Pode gerenciar e modificar o invent√°rio.
* **Ad Hoc**: Pode executar comandos ad hoc no invent√°rio.
* **Atualizar**: Pode atualizar a fonte do invent√°rio.
* **Usar**: Pode usar o invent√°rio em um modelo de trabalho.
* **Ler**: Acesso somente para visualiza√ß√£o.
6. **Fun√ß√µes do Modelo de Trabalho**:
* **Admin**: Pode gerenciar e modificar o modelo de trabalho.
* **Executar**: Pode executar o trabalho.
* **Ler**: Acesso somente para visualiza√ß√£o.
7. **Fun√ß√µes de Credenciais**:
* **Admin**: Pode gerenciar e modificar as credenciais.
* **Usar**: Pode usar as credenciais em modelos de trabalho ou outros recursos relevantes.
* **Ler**: Acesso somente para visualiza√ß√£o.
8. **Fun√ß√µes da Equipe**:
* **Membro**: Parte da equipe, mas sem permiss√µes espec√≠ficas.
* **Admin**: Pode gerenciar os membros da equipe e os recursos associados.
9. **Fun√ß√µes do Fluxo de Trabalho**:
* **Admin**: Pode gerenciar e modificar o fluxo de trabalho.
* **Executar**: Pode executar o fluxo de trabalho.
* **Ler**: Acesso somente para visualiza√ß√£o.

</details>

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
