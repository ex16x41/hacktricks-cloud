# Ansible Tower / AWX / Seguridad del controlador de automatizaci칩n

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Informaci칩n B치sica

**Ansible Tower** o su versi칩n de c칩digo abierto [**AWX**](https://github.com/ansible/awx) tambi칠n se conoce como **la interfaz de usuario, el panel de control y la API REST de Ansible**. Con **control de acceso basado en roles**, programaci칩n de trabajos y gesti칩n gr치fica de inventarios, puedes gestionar tu infraestructura de Ansible desde una interfaz moderna. La API REST de Tower y la interfaz de l칤nea de comandos facilitan su integraci칩n en herramientas y flujos de trabajo actuales.

**El Controlador de Automatizaci칩n es una versi칩n m치s nueva** de Ansible Tower con m치s capacidades.

### Diferencias

Seg칰n [**esto**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), las principales diferencias entre Ansible Tower y AWX son el soporte recibido y que Ansible Tower tiene caracter칤sticas adicionales como control de acceso basado en roles, soporte para APIs personalizadas y flujos de trabajo definidos por el usuario.

### Stack Tecnol칩gico

* **Interfaz Web**: Esta es la interfaz gr치fica donde los usuarios pueden gestionar inventarios, credenciales, plantillas y trabajos. Est치 dise침ada para ser intuitiva y proporciona visualizaciones para ayudar a entender el estado y los resultados de tus trabajos de automatizaci칩n.
* **API REST**: Todo lo que puedes hacer en la interfaz web, tambi칠n puedes hacerlo a trav칠s de la API REST. Esto significa que puedes integrar AWX/Tower con otros sistemas o script acciones que normalmente realizar칤as en la interfaz.
* **Base de Datos**: AWX/Tower utiliza una base de datos (t칤picamente PostgreSQL) para almacenar su configuraci칩n, resultados de trabajos y otros datos operativos necesarios.
* **RabbitMQ**: Este es el sistema de mensajer칤a utilizado por AWX/Tower para comunicarse entre los diferentes componentes, especialmente entre el servicio web y los ejecutores de tareas.
* **Redis**: Redis sirve como cach칠 y backend para la cola de tareas.

### Componentes L칩gicos

* **Inventarios**: Un inventario es una **colecci칩n de hosts (o nodos)** contra los cuales se pueden **ejecutar trabajos** (playbooks de Ansible). AWX/Tower te permite definir y agrupar tus inventarios y tambi칠n soporta inventarios din치micos que pueden **obtener listas de hosts de otros sistemas** como AWS, Azure, etc.
* **Proyectos**: Un proyecto es esencialmente una **colecci칩n de playbooks de Ansible** provenientes de un **sistema de control de versiones** (como Git) para obtener los 칰ltimos playbooks cuando sea necesario.
* **Plantillas**: Las plantillas de trabajo definen **c칩mo se ejecutar치 un playbook en particular**, especificando el **inventario**, **credenciales** y otros **par치metros** para el trabajo.
* **Credenciales**: AWX/Tower proporciona una forma segura de **gestionar y almacenar secretos, como claves SSH, contrase침as y tokens de API**. Estas credenciales pueden asociarse con plantillas de trabajo para que los playbooks tengan el acceso necesario cuando se ejecuten.
* **Motor de Tareas**: Aqu칤 es donde ocurre la magia. El motor de tareas est치 construido sobre Ansible y es responsable de **ejecutar los playbooks**. Los trabajos se env칤an al motor de tareas, que luego ejecuta los playbooks de Ansible contra el inventario designado utilizando las credenciales especificadas.
* **Programadores y Callbacks**: Estas son caracter칤sticas avanzadas en AWX/Tower que permiten **programar trabajos** para que se ejecuten en momentos espec칤ficos o sean activados por eventos externos.
* **Notificaciones**: AWX/Tower puede enviar notificaciones basadas en el 칠xito o fracaso de los trabajos. Soporta varios medios de notificaci칩n como correos electr칩nicos, mensajes de Slack, webhooks, etc.
* **Playbooks de Ansible**: Los playbooks de Ansible son herramientas de configuraci칩n, implementaci칩n y orquestaci칩n. Describen el estado deseado de los sistemas de manera automatizada y repetible. Escritos en YAML, los playbooks utilizan el lenguaje de automatizaci칩n declarativa de Ansible para describir configuraciones, tareas y pasos que deben ejecutarse.

### Flujo de Ejecuci칩n de Trabajos

1. **Interacci칩n del Usuario**: Un usuario puede interactuar con AWX/Tower ya sea a trav칠s de la **Interfaz Web** o la **API REST**. Estas proporcionan acceso frontal a todas las funcionalidades ofrecidas por AWX/Tower.
2. **Inicio del Trabajo**:
* El usuario, a trav칠s de la Interfaz Web o API, inicia un trabajo basado en una **Plantilla de Trabajo**.
* La Plantilla de Trabajo incluye referencias al **Inventario**, **Proyecto** (que contiene el playbook) y **Credenciales**.
* Al iniciar el trabajo, se env칤a una solicitud al backend de AWX/Tower para poner en cola el trabajo para su ejecuci칩n.
3. **Cola de Trabajos**:
* **RabbitMQ** maneja la mensajer칤a entre el componente web y los ejecutores de tareas. Una vez que se inicia un trabajo, se env칤a un mensaje al motor de tareas utilizando RabbitMQ.
* **Redis** act칰a como el backend para la cola de tareas, gestionando los trabajos en cola que esperan ejecuci칩n.
4. **Ejecuci칩n del Trabajo**:
* El **Motor de Tareas** recoge el trabajo en cola. Recupera la informaci칩n necesaria de la **Base de Datos** sobre el playbook asociado al trabajo, inventario y credenciales.
* Usando el playbook de Ansible recuperado del **Proyecto** asociado, el Motor de Tareas ejecuta el playbook contra los nodos del **Inventario** especificado utilizando las **Credenciales** proporcionadas.
* A medida que se ejecuta el playbook, su salida de ejecuci칩n (registros, hechos, etc.) se captura y almacena en la **Base de Datos**.
5. **Resultados del Trabajo**:
* Una vez que el playbook termina de ejecutarse, los resultados (칠xito, fracaso, registros) se guardan en la **Base de Datos**.
* Los usuarios pueden ver los resultados a trav칠s de la Interfaz Web o consultarlos a trav칠s de la API REST.
* Seg칰n los resultados del trabajo, se pueden enviar **Notificaciones** para informar a los usuarios o sistemas externos sobre el estado del trabajo. Las notificaciones pueden ser correos electr칩nicos, mensajes de Slack, webhooks, etc.
6. **Integraci칩n con Sistemas Externos**:
* **Inventarios** pueden ser obtenidos din치micamente de sistemas externos, permitiendo que AWX/Tower obtenga hosts de fuentes como AWS, Azure, VMware y m치s.
* **Proyectos** (playbooks) pueden ser obtenidos de sistemas de control de versiones, asegurando el uso de playbooks actualizados durante la ejecuci칩n del trabajo.
* **Programadores y Callbacks** pueden ser utilizados para integrarse con otros sistemas o herramientas, haciendo que AWX/Tower reaccione a disparadores externos o ejecute trabajos en momentos predeterminados.

### Creaci칩n de laboratorio AWX para pruebas

[**Siguiendo la documentaci칩n**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md) es posible usar docker-compose para ejecutar AWX:

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### Roles soportados

El rol m치s privilegiado se llama **Administrador del Sistema**. Cualquiera con este rol puede **modificar cualquier cosa**.

Desde una revisi칩n de **seguridad de caja blanca**, necesitar칤as el **rol de Auditor del Sistema**, que permite **ver todos los datos del sistema** pero no puede hacer ning칰n cambio. Otra opci칩n ser칤a obtener el **rol de Auditor de la Organizaci칩n**, pero ser칤a mejor obtener el otro.

<details>

<summary>Expande esto para obtener una descripci칩n detallada de los roles disponibles</summary>

1. **Administrador del Sistema**:
* Este es el rol de superusuario con permisos para acceder y modificar cualquier recurso en el sistema.
* Pueden gestionar todas las organizaciones, equipos, proyectos, inventarios, plantillas de trabajo, etc.
2. **Auditor del Sistema**:
* Los usuarios con este rol pueden ver todos los datos del sistema pero no pueden hacer ning칰n cambio.
* Este rol est치 dise침ado para cumplimiento y supervisi칩n.
3. **Roles de Organizaci칩n**:
* **Admin**: Control total sobre los recursos de la organizaci칩n.
* **Auditor**: Acceso solo de lectura a los recursos de la organizaci칩n.
* **Miembro**: Membres칤a b치sica en una organizaci칩n sin permisos espec칤ficos.
* **Ejecutar**: Puede ejecutar plantillas de trabajo dentro de la organizaci칩n.
* **Leer**: Puede ver los recursos de la organizaci칩n.
4. **Roles de Proyecto**:
* **Admin**: Puede gestionar y modificar el proyecto.
* **Usar**: Puede usar el proyecto en una plantilla de trabajo.
* **Actualizar**: Puede actualizar el proyecto usando SCM (control de versiones).
5. **Roles de Inventario**:
* **Admin**: Puede gestionar y modificar el inventario.
* **Ad Hoc**: Puede ejecutar comandos ad hoc en el inventario.
* **Actualizar**: Puede actualizar la fuente del inventario.
* **Usar**: Puede usar el inventario en una plantilla de trabajo.
* **Leer**: Acceso solo de lectura.
6. **Roles de Plantilla de Trabajo**:
* **Admin**: Puede gestionar y modificar la plantilla de trabajo.
* **Ejecutar**: Puede ejecutar el trabajo.
* **Leer**: Acceso solo de lectura.
7. **Roles de Credenciales**:
* **Admin**: Puede gestionar y modificar las credenciales.
* **Usar**: Puede usar las credenciales en plantillas de trabajo u otros recursos relevantes.
* **Leer**: Acceso solo de lectura.
8. **Roles de Equipo**:
* **Miembro**: Parte del equipo pero sin permisos espec칤ficos.
* **Admin**: Puede gestionar a los miembros del equipo y los recursos asociados.
9. **Roles de Flujo de Trabajo**:
* **Admin**: Puede gestionar y modificar el flujo de trabajo.
* **Ejecutar**: Puede ejecutar el flujo de trabajo.
* **Leer**: Acceso solo de lectura.

</details>

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/image (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
